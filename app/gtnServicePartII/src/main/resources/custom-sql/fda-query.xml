<?xml version="1.0"?>
<custom-sql>
    <sql id="forecastConfigDate">
            <![CDATA[
          SELECT from_date,to_date FROM forecast_config WHERE Business_process_type='Accounting Closure' 
            ]]>
    </sql>
    
    <sql id="getAcRsModelSid">
            <![CDATA[
   SELECT DISTINCT
  HT.HELPER_TABLE_SID,
  HT.DESCRIPTION,
  RSC.RS_MODEL_SID
FROM UDCS UD
JOIN RS_CONTRACT RSC
  ON UD.MASTER_SID = RSC.RS_CONTRACT_SID
  AND UD.MASTER_TYPE = 'RS_CONTRACT'
JOIN CONTRACT_MASTER CN
  ON RSC.CONTRACT_MASTER_SID = CN.CONTRACT_MASTER_SID
  AND CN.CONTRACT_TYPE = '?MTID'
JOIN RS_DETAILS RD
  ON RD.RS_MODEL_SID = RSC.RS_MODEL_SID
JOIN HELPER_TABLE HT
  ON UD.UDC2 = HT.HELPER_TABLE_SID
  AND HT.HELPER_TABLE_SID = '?ACC_TYPE_ID'
  AND CN.contract_master_sid = '?CMID'
  AND RD.ITEM_MASTER_SID = '?IMID'
      ]]>
    </sql>
    
 
    <sql id="updateCalcFlag">
            <![CDATA[
        update  AC_FD_ADJUSTMENT_SELECTION set CALCULATION_FLAG=1 where ACC_CLOSURE_MASTER_SID= '?AC_MASTER_SID'
      ]]>
    </sql>
    
    <sql id="setAdjustmentImpact">
            <![CDATA[ 
    
 DECLARE @START DATETIME = Dateadd(YEAR, Datediff(YEAR, 0, Getdate()) - 10, 0)
DECLARE @END DATETIME = Dateadd(QUARTER, 4, Dateadd(YEAR, Datediff(YEAR, 0, Getdate()), -1))
DECLARE @ACC_CLOSURE_MASTER_SID INT= '?AC_MASTER_SID'
DECLARE @ACCRUAL_PERIOD INT=(SELECT RIGHT(ACCRUAL_PERIOD, 4)
  FROM   ACC_CLOSURE_MASTER
  WHERE  ACC_CLOSURE_MASTER_SID = @ACC_CLOSURE_MASTER_SID)
DECLARE @TEMP_JOIN AS TABLE
  (
     CCP_DETAILS_SID     INT,
     CONTRACT_MASTER_SID INT,
     ITEM_MASTER_SID     INT,
     COMPANY_MASTER_SID  INT,
     RS_MODEL_SID        INT,
     RS_ID               VARCHAR(50)
  )

INSERT INTO @TEMP_JOIN
            (CCP_DETAILS_SID,
             CONTRACT_MASTER_SID,
             ITEM_MASTER_SID,
             COMPANY_MASTER_SID,
             RS_MODEL_SID,
             RS_ID)
SELECT B.CCP_DETAILS_SID,
       CCP.CONTRACT_MASTER_SID,
       CCP.ITEM_MASTER_SID,
       CCP.COMPANY_MASTER_SID,
       B.RS_MODEL_SID,
       RM.RS_ID
FROM   AC_FD_ADJUSTMENT_SELECTION A
JOIN   ACC_CLOSURE_DETAILS B ON A.ACC_CLOSURE_MASTER_SID = B.ACC_CLOSURE_MASTER_SID
JOIN   RS_MODEL RM ON RM.RS_MODEL_SID = B.RS_MODEL_SID
JOIN   CCP_DETAILS CCP ON CCP.CCP_DETAILS_SID = B.CCP_DETAILS_SID
WHERE  A.ACC_CLOSURE_MASTER_SID = @ACC_CLOSURE_MASTER_SID

DECLARE @ACTUALS_CCP UDT_CCP_DETAILS

INSERT INTO @ACTUALS_CCP
            (CONTRACT_MASTER_SID,
             COMPANY_MASTER_SID,
             ITEM_MASTER_SID,
             DISCOUNT_ID)
SELECT CONTRACT_MASTER_SID,
       COMPANY_MASTER_SID,
       ITEM_MASTER_SID,
       RS_ID
FROM   @TEMP_JOIN

SELECT     A.YEAR,
           ISNULL(Sum(ACTUALS), 0)                            AS ACTUALS,
           ISNULL(Sum(ACCRUALS), 0)                           AS ACCRUALS,
           ISNULL(Sum(ACCRUALS), 0) - ISNULL(Sum(ACTUALS), 0) AS REMAINING_ESTIMATE,
           ISNULL(Sum(C.TOTAL_ADJUSTMENT_DOLLAR), 0)          AS PROJECTED_REMAINING_ESTIMATE
FROM       @TEMP_JOIN T
CROSS JOIN (SELECT YEAR
            FROM   PERIOD
            WHERE  YEAR <= Year(Getdate())
                   AND YEAR >= Year(Getdate()) - 10
            GROUP  BY YEAR) A
LEFT JOIN  (SELECT Year(ACCRUAL_ACTUAL_START_DATE) AS YEAR,
                   Sum(AM.Amount)                  AS ACTUALS,
                   AM.CONTRACT_MASTER_SID,
                   AM.COMPANY_MASTER_SID,
                   AM.ITEM_MASTER_SID,
                   AM.PROVISION_ID
            FROM   ACTUALS_MASTER AM
            JOIN   @TEMP_JOIN T ON AM.CONTRACT_MASTER_SID = T.CONTRACT_MASTER_SID
                               AND AM.COMPANY_MASTER_SID = T.COMPANY_MASTER_SID
                               AND AM.ITEM_MASTER_SID = T.ITEM_MASTER_SID
                               AND AM.PROVISION_ID = T.RS_ID
            GROUP  BY Year(ACCRUAL_ACTUAL_START_DATE),
                      AM.CONTRACT_MASTER_SID,
                      AM.COMPANY_MASTER_SID,
                      AM.ITEM_MASTER_SID,
                      AM.PROVISION_ID)B ON A.YEAR = B.YEAR
                                       AND T.CONTRACT_MASTER_SID = B.CONTRACT_MASTER_SID
                                       AND T.COMPANY_MASTER_SID = B.COMPANY_MASTER_SID
                                       AND T.ITEM_MASTER_SID = B.ITEM_MASTER_SID
                                       AND T.RS_ID = B.PROVISION_ID
LEFT JOIN  (SELECT    A.YEAR,
                      A.ACCRUALS,
                      TOTAL_ADJUSTMENT_DOLLAR= CASE
                                                 WHEN A.YEAR = @ACCRUAL_PERIOD THEN ISNULL(FDS.TOTAL_ADJUSTMENT_DOLLAR, 0)
                                                                                    + ISNULL(ACCRUALS, 0)
                                                 ELSE 0
                                               END,
                      A.CONTRACT_MASTER_SID,
                      A.COMPANY_MASTER_SID,
                      A.ITEM_MASTER_SID,
                      A.DISCOUNT_ID
            FROM      (SELECT ACR.YEAR,
                              ISNULL(Sum(ACR.ACCRUAL_AMOUNT), 0) AS ACCRUALS,
                              ACR.CONTRACT_MASTER_SID,
                              ACR.COMPANY_MASTER_SID,
                              ACR.ITEM_MASTER_SID,
                              ACR.DISCOUNT_ID
                       FROM   UDF_ACCRUAL_DETAILS (@ACTUALS_CCP, @START, @END) ACR
                       JOIN   @TEMP_JOIN T ON ACR.CONTRACT_MASTER_SID = T.CONTRACT_MASTER_SID
                                          AND ACR.COMPANY_MASTER_SID = T.COMPANY_MASTER_SID
                                          AND ACR.ITEM_MASTER_SID = T.ITEM_MASTER_SID
                                          AND ACR.DISCOUNT_ID = T.RS_ID
                       GROUP  BY ACR.YEAR,
                                 ACR.CONTRACT_MASTER_SID,
                                 ACR.COMPANY_MASTER_SID,
                                 ACR.ITEM_MASTER_SID,
                                 ACR.DISCOUNT_ID)A
            LEFT JOIN (SELECT RIGHT(ACCRUAL_PERIOD, 4)                  AS YEAR,
                              ISNULL(Sum(B.TOTAL_ADJUSTMENT_DOLLAR), 0) AS TOTAL_ADJUSTMENT_DOLLAR,
                              T.CONTRACT_MASTER_SID,
                              T.COMPANY_MASTER_SID,
                              T.ITEM_MASTER_SID,
                              T.RS_ID
                       FROM   ACC_CLOSURE_DETAILS A
                       JOIN   AC_FIXED_DOLLAR_DETAILS B ON A.ACC_CLOSURE_DETAILS_SID = B.ACC_CLOSURE_DETAILS_SID
                       JOIN   ACC_CLOSURE_MASTER ACM ON A.ACC_CLOSURE_MASTER_SID = ACM.ACC_CLOSURE_MASTER_SID
                       JOIN   @TEMP_JOIN T ON A.CCP_DETAILS_SID = T.CCP_DETAILS_SID
                                          AND A.RS_MODEL_SID = T.RS_MODEL_SID
                       WHERE  A.ACC_CLOSURE_MASTER_SID = @ACC_CLOSURE_MASTER_SID
                       GROUP  BY RIGHT(ACCRUAL_PERIOD, 4),
                                 T.CONTRACT_MASTER_SID,
                                 T.COMPANY_MASTER_SID,
                                 T.ITEM_MASTER_SID,
                                 T.RS_ID) FDS ON FDS.CONTRACT_MASTER_SID = A.CONTRACT_MASTER_SID
                                             AND FDS.COMPANY_MASTER_SID = A.COMPANY_MASTER_SID
                                             AND FDS.ITEM_MASTER_SID = A.ITEM_MASTER_SID
                                             AND FDS.RS_ID = A.DISCOUNT_ID
                                             AND FDS.YEAR = A.YEAR)C ON C.YEAR = A.YEAR
                                                                    AND T.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID
                                                                    AND T.COMPANY_MASTER_SID = C.COMPANY_MASTER_SID
                                                                    AND T.ITEM_MASTER_SID = C.ITEM_MASTER_SID
                                                                    AND T.RS_ID = C.DISCOUNT_ID
GROUP      BY A.YEAR 

   ]]>
    </sql>
    
    <sql id="getDateFromAcFdAdjustmentSelection">
            <![CDATA[ 
           select 
                CASE WHEN 
                ACB.START_DATE>GETDATE()
                THEN 
                'TRUE'
                ELSE
                'FALSE'
                END 
                START_DATE
                 from AC_FD_ADJUSTMENT_SELECTION ACB
                WHERE ACB.ACC_CLOSURE_MASTER_SID='?AC_MASTER_SID'
            
             ]]>
    </sql>
    
    <sql id="deleteAcFdAdjustmentSelection">
            <![CDATA[ 
    delete from AC_FD_ADJUSTMENT_SELECTION where ACC_CLOSURE_MASTER_SID = '?AC_MASTER_SID'
       ]]>
    </sql>
    
     <sql id="selectLevel0Query">
            <![CDATA[ 
   SELECT CM.COMPANY_NAME,CM.COMPANY_MASTER_SID,CCP.CCP_DETAILS_SID, 
                        (select  c.DESCRIPTION  as value  from WORKFLOW_MASTER a inner join ACC_CLOSURE_MASTER b 
                        on a.PROJECTION_MASTER_SID=b.ACC_CLOSURE_MASTER_SID and a.WORKFLOW_ID like '%FD%' inner join HELPER_TABLE c on c.HELPER_TABLE_SID=a.WORKFLOW_STATUS_ID
                        and c.LIST_NAME='workflowstatus' and c.DESCRIPTION<>'Cancelled' and b.CONTRACT_MASTER_SID='?CMID'   and b.ITEM_MASTER_SID= '?IMID' )
                        FROM CONTRACT_MASTER CN 
                         JOIN CCP_DETAILS CCP ON CCP.CONTRACT_MASTER_SID = CN.CONTRACT_MASTER_SID
                         JOIN COMPANY_MASTER CM ON CCP.COMPANY_MASTER_SID = CM.COMPANY_MASTER_SID
                         WHERE CN.CONTRACT_MASTER_SID = '?CMID'
                         AND CCP.ITEM_MASTER_SID = '?IMID'
                         GROUP BY CM.COMPANY_NAME,CM.COMPANY_MASTER_SID,CCP.CCP_DETAILS_SID
                         ORDER BY CM.COMPANY_NAME,CM.COMPANY_MASTER_SID 
       ]]>
    </sql>
    
      <sql id="selectLevel1Query">
            <![CDATA[ 
    SELECT CM.COMPANY_NAME,CM.COMPANY_MASTER_SID,CCP.CCP_DETAILS_SID, 
                        (select  c.DESCRIPTION  as value  from WORKFLOW_MASTER a inner join ACC_CLOSURE_MASTER b 
                        on a.PROJECTION_MASTER_SID=b.ACC_CLOSURE_MASTER_SID and a.WORKFLOW_ID like '%FD%' inner join HELPER_TABLE c on c.HELPER_TABLE_SID=a.WORKFLOW_STATUS_ID
                        and c.LIST_NAME='workflowstatus' and c.DESCRIPTION<>'Cancelled' and b.CONTRACT_MASTER_SID= '?CMID'   and b.ITEM_MASTER_SID= '?IMID' ) 
                        FROM CONTRACT_MASTER CN 
                         JOIN CCP_DETAILS CCP ON CCP.CONTRACT_MASTER_SID = CN.CONTRACT_MASTER_SID
                         JOIN COMPANY_MASTER CM ON CCP.COMPANY_MASTER_SID = CM.COMPANY_MASTER_SID
                         WHERE CN.CONTRACT_MASTER_SID = '?CMID'
                         AND CCP.ITEM_MASTER_SID = '?IMID'  and CCP.CCP_DETAILS_SID in(
                        select distinct  a.CCP_DETAILS_SID  from ACC_CLOSURE_DETAILS a inner join ACC_CLOSURE_MASTER b
                        on a.ACC_CLOSURE_MASTER_SID=b.ACC_CLOSURE_MASTER_SID and b.SAVE_FLAG=1 inner join  AC_FD_ADJUSTMENT_SELECTION c
                        on c.ACC_CLOSURE_MASTER_SID=b.ACC_CLOSURE_MASTER_SID and c.CALCULATION_FLAG=1
                        where a.ACC_CLOSURE_MASTER_SID= '?AC_MASTER_SID'
                        )
                         GROUP BY CM.COMPANY_NAME,CM.COMPANY_MASTER_SID,CCP.CCP_DETAILS_SID
                         ORDER BY CM.COMPANY_NAME,CM.COMPANY_MASTER_SID 
    
      ]]>
    </sql>
    
      <sql id="selectLevel2Query">
            <![CDATA[ 
   SELECT  CN.CONTRACT_NAME,CN.CONTRACT_MASTER_SID,CCP.CCP_DETAILS_SID ,
                    (select   c.DESCRIPTION  as value  from WORKFLOW_MASTER a inner join ACC_CLOSURE_MASTER b 
                    on a.PROJECTION_MASTER_SID=b.ACC_CLOSURE_MASTER_SID and a.WORKFLOW_ID like '%FD%' inner join HELPER_TABLE c on c.HELPER_TABLE_SID=a.WORKFLOW_STATUS_ID
                    and c.LIST_NAME='workflowstatus' and c.DESCRIPTION<>'Cancelled' and b.CONTRACT_MASTER_SID= '?CMID' and b.ITEM_MASTER_SID= '?IMID' ) 
                    FROM CONTRACT_MASTER CN 
                    JOIN CCP_DETAILS CCP ON CCP.CONTRACT_MASTER_SID = CN.CONTRACT_MASTER_SID
                     WHERE CN.CONTRACT_MASTER_SID = '?CMID'
                     AND CCP.ITEM_MASTER_SID =  '?IMID'
                     AND CCP.CCP_DETAILS_SID= '?CCPID' GROUP BY CN.CONTRACT_NAME,CN.CONTRACT_MASTER_SID,CCP.CCP_DETAILS_SID
                     ORDER BY CN.CONTRACT_NAME,CN.CONTRACT_MASTER_SID 
       ]]>
    </sql>
    
      <sql id="selectLevel3Query">
            <![CDATA[ 
   SELECT  HT.DESCRIPTION,HT.HELPER_TABLE_SID,CCP.CCP_DETAILS_SID,
                    (select  c.DESCRIPTION  as value  from WORKFLOW_MASTER a inner join ACC_CLOSURE_MASTER b 
                    on a.PROJECTION_MASTER_SID=b.ACC_CLOSURE_MASTER_SID and a.WORKFLOW_ID like '%FD%' inner join HELPER_TABLE c on c.HELPER_TABLE_SID=a.WORKFLOW_STATUS_ID
                    and c.LIST_NAME='workflowstatus' and c.DESCRIPTION<>'Cancelled' and b.CONTRACT_MASTER_SID= '?CMID' and b.ITEM_MASTER_SID= '?IMID' ) 
                     FROM ITEM_MASTER IM 
                    JOIN CCP_DETAILS CCP ON CCP.ITEM_MASTER_SID = IM.ITEM_MASTER_SID
                    JOIN HELPER_TABLE HT ON IM.THERAPEUTIC_CLASS = HT.HELPER_TABLE_SID
                     WHERE CCP.CONTRACT_MASTER_SID = '?CMID'
                     AND IM.ITEM_MASTER_SID = '?IMID'
                     AND CCP.CCP_DETAILS_SID= '?CCPID' GROUP BY HT.DESCRIPTION,HT.HELPER_TABLE_SID,CCP.CCP_DETAILS_SID
                     ORDER BY HT.DESCRIPTION,HT.HELPER_TABLE_SID
       ]]>
    </sql>
    
    <sql id="selectLevel4Query">
            <![CDATA[ 
   SELECT  BM.BRAND_NAME,BM.BRAND_MASTER_SID,CCP.CCP_DETAILS_SID, 
                    (select   c.DESCRIPTION  as value  from WORKFLOW_MASTER a inner join ACC_CLOSURE_MASTER b 
                    on a.PROJECTION_MASTER_SID=b.ACC_CLOSURE_MASTER_SID and a.WORKFLOW_ID like '%FD%' inner join HELPER_TABLE c on c.HELPER_TABLE_SID=a.WORKFLOW_STATUS_ID
                    and c.LIST_NAME='workflowstatus' and c.DESCRIPTION<>'Cancelled' and b.CONTRACT_MASTER_SID= '?CMID' and b.ITEM_MASTER_SID= '?IMID' ) 
                    FROM ITEM_MASTER IM 
                     JOIN CCP_DETAILS CCP ON CCP.ITEM_MASTER_SID = IM.ITEM_MASTER_SID
                    JOIN BRAND_MASTER BM ON IM.BRAND_MASTER_SID = BM.BRAND_MASTER_SID
                     WHERE CCP.CONTRACT_MASTER_SID = '?CMID'
                     AND IM.ITEM_MASTER_SID = '?IMID'
                     AND CCP.CCP_DETAILS_SID= '?CCPID' GROUP BY BM.BRAND_NAME,BM.BRAND_MASTER_SID,CCP.CCP_DETAILS_SID
                     ORDER BY BM.BRAND_NAME,BM.BRAND_MASTER_SID
       ]]>
    </sql>
    
     <sql id="selectLevel5Query">
            <![CDATA[ 
   SELECT  IM.ITEM_ID,IM.ITEM_MASTER_SID,CCP.CCP_DETAILS_SID,
                    (select  c.DESCRIPTION  as value  from WORKFLOW_MASTER a inner join ACC_CLOSURE_MASTER b 
                    on a.PROJECTION_MASTER_SID=b.ACC_CLOSURE_MASTER_SID and a.WORKFLOW_ID like '%FD%' inner join HELPER_TABLE c on c.HELPER_TABLE_SID=a.WORKFLOW_STATUS_ID
                    and c.LIST_NAME='workflowstatus' and c.DESCRIPTION<>'Cancelled' and b.CONTRACT_MASTER_SID= '?CMID' and b.ITEM_MASTER_SID= '?IMID' ) 
                    FROM ITEM_MASTER IM 
                     JOIN CCP_DETAILS CCP ON CCP.ITEM_MASTER_SID = IM.ITEM_MASTER_SID
                     WHERE CCP.CONTRACT_MASTER_SID = '?CMID'
                     AND IM.ITEM_MASTER_SID = '?IMID'
                     AND CCP.CCP_DETAILS_SID= '?CCPID' GROUP BY IM.ITEM_ID,IM.ITEM_MASTER_SID,CCP.CCP_DETAILS_SID
                     ORDER BY IM.ITEM_ID,IM.ITEM_MASTER_SID 
       ]]>
    </sql>
    
     <sql id="resultsLevel1Query">
            <![CDATA[ 
   SELECT CM.COMPANY_NAME,CM.COMPANY_MASTER_SID,CCP.CCP_DETAILS_SID 
                         FROM CONTRACT_MASTER CN 
                         JOIN CCP_DETAILS CCP ON CCP.CONTRACT_MASTER_SID = CN.CONTRACT_MASTER_SID
                         JOIN COMPANY_MASTER CM ON CCP.COMPANY_MASTER_SID = CM.COMPANY_MASTER_SID
                         WHERE CN.CONTRACT_MASTER_SID =  '?CMID'
                         AND CCP.ITEM_MASTER_SID = '?IMID' and CCP.CCP_DETAILS_SID in( ?CCPID )
                         GROUP BY CM.COMPANY_NAME,CM.COMPANY_MASTER_SID,CCP.CCP_DETAILS_SID
                         ORDER BY CM.COMPANY_NAME,CM.COMPANY_MASTER_SID
       ]]>
    </sql>
    
    <sql id="resultsLevel2Query">
            <![CDATA[ 
   SELECT  CN.CONTRACT_NAME,CN.CONTRACT_MASTER_SID,CCP.CCP_DETAILS_SID
                         FROM CONTRACT_MASTER CN 
                         JOIN CCP_DETAILS CCP ON CCP.CONTRACT_MASTER_SID = CN.CONTRACT_MASTER_SID
                         WHERE CN.CONTRACT_MASTER_SID =  '?CMID'
                         AND CCP.ITEM_MASTER_SID = '?IMID'
                         AND CCP.CCP_DETAILS_SID= '?CCPID'
                         GROUP BY CN.CONTRACT_NAME,CN.CONTRACT_MASTER_SID,CCP.CCP_DETAILS_SID
                         ORDER BY CN.CONTRACT_NAME,CN.CONTRACT_MASTER_SID
       ]]>
    </sql>
    
     <sql id="resultsLevel3Query">
            <![CDATA[ 
   SELECT  HT.DESCRIPTION,HT.HELPER_TABLE_SID,CCP.CCP_DETAILS_SID FROM ITEM_MASTER IM 
                        JOIN CCP_DETAILS CCP ON CCP.ITEM_MASTER_SID = IM.ITEM_MASTER_SID
                        JOIN HELPER_TABLE HT ON IM.THERAPEUTIC_CLASS = HT.HELPER_TABLE_SID
                         WHERE CCP.CONTRACT_MASTER_SID = '?CMID'
                         AND IM.ITEM_MASTER_SID = '?IMID'
                         AND CCP.CCP_DETAILS_SID = '?CCPID'
                         GROUP BY HT.DESCRIPTION,HT.HELPER_TABLE_SID,CCP.CCP_DETAILS_SID order by HT.DESCRIPTION,HT.HELPER_TABLE_SID,CCP.CCP_DETAILS_SID
       ]]>
    </sql>
    
     <sql id="resultsLevel4Query">
            <![CDATA[ 
   SELECT  BM.BRAND_NAME,BM.BRAND_MASTER_SID,CCP.CCP_DETAILS_SID FROM ITEM_MASTER IM 
                         JOIN CCP_DETAILS CCP ON CCP.ITEM_MASTER_SID = IM.ITEM_MASTER_SID
                        JOIN BRAND_MASTER BM ON IM.BRAND_MASTER_SID = BM.BRAND_MASTER_SID
                         WHERE CCP.CONTRACT_MASTER_SID = '?CMID'
                         AND IM.ITEM_MASTER_SID =  '?IMID'
                         AND CCP.CCP_DETAILS_SID = '?CCPID'
                         GROUP BY BM.BRAND_NAME,BM.BRAND_MASTER_SID,CCP.CCP_DETAILS_SID order by BM.BRAND_NAME,BM.BRAND_MASTER_SID,CCP.CCP_DETAILS_SID
       ]]>
    </sql>
    
     <sql id="resultsLevel5Query">
            <![CDATA[ 
  SELECT  IM.ITEM_ID,IM.ITEM_MASTER_SID,CCP.CCP_DETAILS_SID FROM ITEM_MASTER IM 
                         JOIN CCP_DETAILS CCP ON CCP.ITEM_MASTER_SID = IM.ITEM_MASTER_SID
                         WHERE CCP.CONTRACT_MASTER_SID = '?CMID'
                         AND IM.ITEM_MASTER_SID = '?IMID'
                         AND CCP.CCP_DETAILS_SID = '?CCPID'
                         GROUP BY IM.ITEM_ID,IM.ITEM_MASTER_SID,CCP.CCP_DETAILS_SID order by IM.ITEM_ID,IM.ITEM_MASTER_SID,CCP.CCP_DETAILS_SID
       ]]>
    </sql>
    
     <sql id="calculateLevel1Query">
            <![CDATA[ 
   SELECT COM.COMPANY_NAME,
                               ISNULL(Sum(acfd.ACCRUAL_PERIOD_SALES), 0) as ACCRUAL_PERIOD_SALES,  
                               ISNULL(Sum(acfd.ACCRUAL_PERIOD_ACCRUALS), 0) as ACCRUAL_PERIOD_ACCRUALS,
                               ISNULL(Sum(acfd.AUTO_ACCRUALS), 0) as AUTO_ACCRUALS,
                               ISNULL(Sum(acfd.MANUAL_ADJUSTMENTS), 0) as MANUAL_ADJUSTMENTS,
                               ISNULL(Sum(acfd.PAYMENT_TRUE_UP), 0) as PAYMENT_TRUE_UP,
                               ISNULL(Sum(acfd.ACCRUAL_OTHERS), 0) as ACCRUAL_OTHERS,
                               ISNULL(Sum(acfd.PROJECTED_DISCOUNT), 0) as PROJECTED_DISCOUNT,
                               ISNULL(Sum(acfd.PER_ACCRUAL_TO_PROJECTION), 0) as PER_ACCRUAL_TO_PROJECTION,
                               ISNULL(Sum(acfd.PER_ACTUALS_TO_PROJECTION), 0) as PER_ACTUALS_TO_PROJECTION,
                               ISNULL(Sum(acfd.ACCRUAL_PERIOD_ACTUALS), 0) as ACCRUAL_PERIOD_ACTUALS,
                               ISNULL(Sum(acfd.VARIANCE), 0) as VARIANCE,
                               ISNULL(Sum(acfd.SUGGESTED_ADJ), 0) as SUGGESTED_ADJ,
                               ISNULL(Sum(acfd.PERCENTAGE_RELEASE), 0) as PERCENTAGE_RELEASE,
                               ISNULL(Sum(acfd.MANUAL_AMOUNT), 0) as MANUAL_AMOUNT,
                               ISNULL(Sum(acfd.TOTAL_ADJUSTMENT_DOLLAR), 0) as TOTAL_ADJUSTMENT_DOLLAR,
                               ISNULL(Sum(acfd.TOTAL_ADJUSTMENT_PER_DAY), 0) as TOTAL_ADJUSTMENT_PER_DAY,
                               Max(acfd.REASON_CODE) as REASON_CODE,
                               Max(acfd.NOTES) as NOTES,acd.CCP_DETAILS_SID 
                        FROM   ACC_CLOSURE_DETAILS acd
                        JOIN   CCP_DETAILS CCP ON acd.CCP_DETAILS_SID = CCP.CCP_DETAILS_SID
                        JOIN   AC_FIXED_DOLLAR_DETAILS acfd ON acfd.ACC_CLOSURE_DETAILS_SID = acd.ACC_CLOSURE_DETAILS_SID
                        JOIN   ITEM_MASTER IM ON IM.ITEM_MASTER_SID = CCP.ITEM_MASTER_SID
                        JOIN   BRAND_MASTER BM ON IM.BRAND_MASTER_SID = BM.BRAND_MASTER_SID
                        JOIN   CONTRACT_MASTER CM ON CM.CONTRACT_MASTER_SID = CCP.CONTRACT_MASTER_SID
                        JOIN   COMPANY_MASTER COM ON COM.COMPANY_MASTER_SID = CCP.COMPANY_MASTER_SID
                        WHERE  acd.ACC_CLOSURE_MASTER_SID = '?AC_MASTER_SID'
                               AND CCP.CONTRACT_MASTER_SID = '?CMID'
                               AND IM.ITEM_MASTER_SID ='?IMID'
                        GROUP  BY COM.COMPANY_NAME,acd.CCP_DETAILS_SID order by COM.COMPANY_NAME,acd.CCP_DETAILS_SID
       ]]>
    </sql>
    
     <sql id="calculateLevel2Query">
            <![CDATA[ 
    SELECT CM.CONTRACT_NAME,
                              ISNULL(Sum(acfd.ACCRUAL_PERIOD_SALES), 0) as ACCRUAL_PERIOD_SALES,
                              ISNULL(Sum(acfd.ACCRUAL_PERIOD_ACCRUALS), 0) as ACCRUAL_PERIOD_ACCRUALS,
                              ISNULL(Sum(acfd.AUTO_ACCRUALS), 0) as AUTO_ACCRUALS,
                              ISNULL(Sum(acfd.MANUAL_ADJUSTMENTS), 0) as MANUAL_ADJUSTMENTS,
                              ISNULL(Sum(acfd.PAYMENT_TRUE_UP), 0) as PAYMENT_TRUE_UP,
                              ISNULL(Sum(acfd.ACCRUAL_OTHERS), 0) as ACCRUAL_OTHERS,
                              ISNULL(Sum(acfd.PROJECTED_DISCOUNT), 0) as PROJECTED_DISCOUNT,
                              ISNULL(Sum(acfd.PER_ACCRUAL_TO_PROJECTION), 0) as PER_ACCRUAL_TO_PROJECTION ,
                              ISNULL(Sum(acfd.PER_ACTUALS_TO_PROJECTION), 0) as PER_ACTUALS_TO_PROJECTION,
                              ISNULL(Sum(acfd.ACCRUAL_PERIOD_ACTUALS), 0) as ACCRUAL_PERIOD_ACTUALS,
                              ISNULL(Sum(acfd.VARIANCE), 0) as VARIANCE,
                              ISNULL(Sum(acfd.SUGGESTED_ADJ), 0) as SUGGESTED_ADJ,
                              ISNULL(Sum(acfd.PERCENTAGE_RELEASE), 0) as PERCENTAGE_RELEASE,
                              ISNULL(Sum(acfd.MANUAL_AMOUNT), 0) as MANUAL_AMOUNT,
                              ISNULL(Sum(acfd.TOTAL_ADJUSTMENT_DOLLAR), 0) as TOTAL_ADJUSTMENT_DOLLAR,
                              ISNULL(Sum(acfd.TOTAL_ADJUSTMENT_PER_DAY), 0) as TOTAL_ADJUSTMENT_PER_DAY,
                              Max(acfd.REASON_CODE) as REASON_CODE,
                              Max(acfd.NOTES) as NOTES,acd.CCP_DETAILS_SID 
                       FROM   ACC_CLOSURE_DETAILS acd
                       JOIN   CCP_DETAILS CCP ON acd.CCP_DETAILS_SID = CCP.CCP_DETAILS_SID
                       JOIN   AC_FIXED_DOLLAR_DETAILS acfd ON acfd.ACC_CLOSURE_DETAILS_SID = acd.ACC_CLOSURE_DETAILS_SID
                       JOIN   ITEM_MASTER IM ON IM.ITEM_MASTER_SID = CCP.ITEM_MASTER_SID
                       JOIN   BRAND_MASTER BM ON IM.BRAND_MASTER_SID = BM.BRAND_MASTER_SID
                       JOIN   CONTRACT_MASTER CM ON CM.CONTRACT_MASTER_SID = CCP.CONTRACT_MASTER_SID
                       JOIN   COMPANY_MASTER COM ON COM.COMPANY_MASTER_SID = CCP.COMPANY_MASTER_SID
                       WHERE  acd.ACC_CLOSURE_MASTER_SID = '?AC_MASTER_SID'
                              AND CCP.CONTRACT_MASTER_SID = '?CMID'
                              AND IM.ITEM_MASTER_SID = '?IMID'
                        AND CCP.CCP_DETAILS_SID = '?CCPID'
                       GROUP  BY CM.CONTRACT_NAME,acd.CCP_DETAILS_SID order by CM.CONTRACT_NAME,acd.CCP_DETAILS_SID
      ]]>
    </sql>
    
       <sql id="calculateLevel3Query">
            <![CDATA[ 
    SELECT H.DESCRIPTION AS THERAPEUTIC_CLASS,
                               ISNULL(Sum(acfd.ACCRUAL_PERIOD_SALES), 0) as ACCRUAL_PERIOD_SALES,
                               ISNULL(Sum(acfd.ACCRUAL_PERIOD_ACCRUALS), 0) as ACCRUAL_PERIOD_ACCRUALS,
                               ISNULL(Sum(acfd.AUTO_ACCRUALS), 0) as AUTO_ACCRUALS,
                               ISNULL(Sum(acfd.MANUAL_ADJUSTMENTS), 0) as MANUAL_ADJUSTMENTS,
                               ISNULL(Sum(acfd.PAYMENT_TRUE_UP), 0) as PAYMENT_TRUE_UP,
                               ISNULL(Sum(acfd.ACCRUAL_OTHERS), 0) as ACCRUAL_OTHERS,
                               ISNULL(Sum(acfd.PROJECTED_DISCOUNT), 0) as PROJECTED_DISCOUNT,
                               ISNULL(Sum(acfd.PER_ACCRUAL_TO_PROJECTION), 0) as PER_ACCRUAL_TO_PROJECTION,
                               ISNULL(Sum(acfd.PER_ACTUALS_TO_PROJECTION), 0) as PER_ACTUALS_TO_PROJECTION,
                               ISNULL(Sum(acfd.ACCRUAL_PERIOD_ACTUALS), 0) as ACCRUAL_PERIOD_ACTUALS,
                               ISNULL(Sum(acfd.VARIANCE), 0) as VARIANCE,
                               ISNULL(Sum(acfd.SUGGESTED_ADJ), 0) as SUGGESTED_ADJ,
                               ISNULL(Sum(acfd.PERCENTAGE_RELEASE), 0) as PERCENTAGE_RELEASE,
                               ISNULL(Sum(acfd.MANUAL_AMOUNT), 0) as MANUAL_AMOUNT,
                               ISNULL(Sum(acfd.TOTAL_ADJUSTMENT_DOLLAR), 0) as TOTAL_ADJUSTMENT_DOLLAR,
                               ISNULL(Sum(acfd.TOTAL_ADJUSTMENT_PER_DAY), 0) as TOTAL_ADJUSTMENT_PER_DAY,
                               Max(acfd.REASON_CODE) as REASON_CODE,
                               Max(acfd.NOTES) as NOTES,acd.CCP_DETAILS_SID
                        FROM   ACC_CLOSURE_DETAILS acd
                        JOIN   CCP_DETAILS CCP ON acd.CCP_DETAILS_SID = CCP.CCP_DETAILS_SID
                        JOIN   AC_FIXED_DOLLAR_DETAILS acfd ON acfd.ACC_CLOSURE_DETAILS_SID = acd.ACC_CLOSURE_DETAILS_SID
                        JOIN   ITEM_MASTER IM ON IM.ITEM_MASTER_SID = CCP.ITEM_MASTER_SID
                        JOIN   BRAND_MASTER BM ON IM.BRAND_MASTER_SID = BM.BRAND_MASTER_SID
                        JOIN   CONTRACT_MASTER CM ON CM.CONTRACT_MASTER_SID = CCP.CONTRACT_MASTER_SID
                        JOIN   COMPANY_MASTER COM ON COM.COMPANY_MASTER_SID = CCP.COMPANY_MASTER_SID
                        JOIN HELPER_TABLE H ON H.HELPER_TABLE_SID=IM.THERAPEUTIC_CLASS
                        WHERE  acd.ACC_CLOSURE_MASTER_SID = '?AC_MASTER_SID'
                               AND CCP.CONTRACT_MASTER_SID = '?CMID'
                               AND IM.ITEM_MASTER_SID = '?IMID'
                         AND CCP.CCP_DETAILS_SID =  '?CCPID'
                          GROUP  BY H.DESCRIPTION,acd.CCP_DETAILS_SID order by H.DESCRIPTION,acd.CCP_DETAILS_SID
      ]]>
    </sql>
       
    <sql id="calculateLevel4Query">
            <![CDATA[ 
   SELECT BM.BRAND_NAME,
                               ISNULL(Sum(acfd.ACCRUAL_PERIOD_SALES), 0) as ACCRUAL_PERIOD_SALES,
                               ISNULL(Sum(acfd.ACCRUAL_PERIOD_ACCRUALS), 0) as ACCRUAL_PERIOD_ACCRUALS,
                               ISNULL(Sum(acfd.AUTO_ACCRUALS), 0) as AUTO_ACCRUALS,
                               ISNULL(Sum(acfd.MANUAL_ADJUSTMENTS), 0) as MANUAL_ADJUSTMENTS,
                               ISNULL(Sum(acfd.PAYMENT_TRUE_UP), 0) as PAYMENT_TRUE_UP,
                               ISNULL(Sum(acfd.ACCRUAL_OTHERS), 0) as ACCRUAL_OTHERS,
                               ISNULL(Sum(acfd.PROJECTED_DISCOUNT), 0) as PROJECTED_DISCOUNT,
                               ISNULL(Sum(acfd.PER_ACCRUAL_TO_PROJECTION), 0) as PER_ACCRUAL_TO_PROJECTION,
                               ISNULL(Sum(acfd.PER_ACTUALS_TO_PROJECTION), 0) as PER_ACTUALS_TO_PROJECTION,
                               ISNULL(Sum(acfd.ACCRUAL_PERIOD_ACTUALS), 0) as ACCRUAL_PERIOD_ACTUALS,
                               ISNULL(Sum(acfd.VARIANCE), 0) as VARIANCE,
                               ISNULL(Sum(acfd.SUGGESTED_ADJ), 0) as SUGGESTED_ADJ,
                               ISNULL(Sum(acfd.PERCENTAGE_RELEASE), 0) as PERCENTAGE_RELEASE,
                               ISNULL(Sum(acfd.MANUAL_AMOUNT), 0) as MANUAL_AMOUNT,
                               ISNULL(Sum(acfd.TOTAL_ADJUSTMENT_DOLLAR), 0) as TOTAL_ADJUSTMENT_DOLLAR,
                               ISNULL(Sum(acfd.TOTAL_ADJUSTMENT_PER_DAY), 0) as TOTAL_ADJUSTMENT_PER_DAY,
                               Max(acfd.REASON_CODE) as REASON_CODE,
                               Max(acfd.NOTES) as NOTES,acd.CCP_DETAILS_SID
                        FROM   ACC_CLOSURE_DETAILS acd
                        JOIN   CCP_DETAILS CCP ON acd.CCP_DETAILS_SID = CCP.CCP_DETAILS_SID
                        JOIN   AC_FIXED_DOLLAR_DETAILS acfd ON acfd.ACC_CLOSURE_DETAILS_SID = acd.ACC_CLOSURE_DETAILS_SID
                        JOIN   ITEM_MASTER IM ON IM.ITEM_MASTER_SID = CCP.ITEM_MASTER_SID
                        JOIN   BRAND_MASTER BM ON IM.BRAND_MASTER_SID = BM.BRAND_MASTER_SID
                        JOIN   CONTRACT_MASTER CM ON CM.CONTRACT_MASTER_SID = CCP.CONTRACT_MASTER_SID
                        JOIN   COMPANY_MASTER COM ON COM.COMPANY_MASTER_SID = CCP.COMPANY_MASTER_SID
                        WHERE  acd.ACC_CLOSURE_MASTER_SID = '?AC_MASTER_SID'
                               AND CCP.CONTRACT_MASTER_SID = '?CMID'
                               AND IM.ITEM_MASTER_SID = '?IMID'
                        AND CCP.CCP_DETAILS_SID = '?CCPID'
                        GROUP  BY BM.BRAND_NAME,acd.CCP_DETAILS_SID order by BM.BRAND_NAME,acd.CCP_DETAILS_SID
      ]]>
    </sql>
      
    <sql id="calculateLevel5Query">
            <![CDATA[ 
   SELECT IM.ITEM_NAME,
                              ISNULL(Sum(acfd.ACCRUAL_PERIOD_SALES), 0) as ACCRUAL_PERIOD_SALES,
                              ISNULL(Sum(acfd.ACCRUAL_PERIOD_ACCRUALS), 0) as ACCRUAL_PERIOD_ACCRUALS,
                              ISNULL(Sum(acfd.AUTO_ACCRUALS), 0) as AUTO_ACCRUALS,
                              ISNULL(Sum(acfd.MANUAL_ADJUSTMENTS), 0) as MANUAL_ADJUSTMENTS,
                              ISNULL(Sum(acfd.PAYMENT_TRUE_UP), 0) as PAYMENT_TRUE_UP,
                              ISNULL(Sum(acfd.ACCRUAL_OTHERS), 0) as ACCRUAL_OTHERS,
                              ISNULL(Sum(acfd.PROJECTED_DISCOUNT), 0) as PROJECTED_DISCOUNT,
                              ISNULL(Sum(acfd.PER_ACCRUAL_TO_PROJECTION), 0) as PER_ACCRUAL_TO_PROJECTION,
                              ISNULL(Sum(acfd.PER_ACTUALS_TO_PROJECTION), 0) as PER_ACTUALS_TO_PROJECTION,
                              ISNULL(Sum(acfd.ACCRUAL_PERIOD_ACTUALS), 0) as ACCRUAL_PERIOD_ACTUALS,
                              ISNULL(Sum(acfd.VARIANCE), 0) as VARIANCE,
                              ISNULL(Sum(acfd.SUGGESTED_ADJ), 0) as SUGGESTED_ADJ,
                              ISNULL(Sum(acfd.PERCENTAGE_RELEASE), 0) as PERCENTAGE_RELEASE,
                              ISNULL(Sum(acfd.MANUAL_AMOUNT), 0) as MANUAL_AMOUNT,
                              ISNULL(Sum(acfd.TOTAL_ADJUSTMENT_DOLLAR), 0) as TOTAL_ADJUSTMENT_DOLLAR,
                              ISNULL(Sum(acfd.TOTAL_ADJUSTMENT_PER_DAY), 0) as TOTAL_ADJUSTMENT_PER_DAY,
                              Max(acfd.REASON_CODE) as REASON_CODE,
                              Max(acfd.NOTES) as NOTES,acd.CCP_DETAILS_SID
                       FROM   ACC_CLOSURE_DETAILS acd
                       JOIN   CCP_DETAILS CCP ON acd.CCP_DETAILS_SID = CCP.CCP_DETAILS_SID
                       JOIN   AC_FIXED_DOLLAR_DETAILS acfd ON acfd.ACC_CLOSURE_DETAILS_SID = acd.ACC_CLOSURE_DETAILS_SID
                       JOIN   ITEM_MASTER IM ON IM.ITEM_MASTER_SID = CCP.ITEM_MASTER_SID
                       JOIN   BRAND_MASTER BM ON IM.BRAND_MASTER_SID = BM.BRAND_MASTER_SID
                       JOIN   CONTRACT_MASTER CM ON CM.CONTRACT_MASTER_SID = CCP.CONTRACT_MASTER_SID
                       JOIN   COMPANY_MASTER COM ON COM.COMPANY_MASTER_SID = CCP.COMPANY_MASTER_SID
                       WHERE  acd.ACC_CLOSURE_MASTER_SID = '?AC_MASTER_SID'
                              AND CCP.CONTRACT_MASTER_SID = '?CMID'
                              AND IM.ITEM_MASTER_SID = '?IMID'
                        AND CCP.CCP_DETAILS_SID = '?CCPID'
                        GROUP  BY IM.ITEM_NAME,acd.CCP_DETAILS_SID order by IM.ITEM_NAME,acd.CCP_DETAILS_SID
      ]]>
    </sql>
    
</custom-sql>
