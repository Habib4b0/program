<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<custom-sql>
    
    <sql id="availableContractsCount">
        <![CDATA[
        SELECT Count(1) as result_count FROM (SELECT DISTINCT CM.CONTRACT_MASTER_SID, CM.CONTRACT_NO,CM.CONTRACT_NAME,H.HELPER_TABLE_SID CONTRACT_TYPE,
        CFP.CFP_NAME,IFP.IFP_NAME,COM.COMPANY_NO,COM.COMPANY_NAME,CON_HOL.COMPANY_NAME AS CONTRACT_HOLDER,IM.ITEM_NO,IM.ITEM_NAME,PS.PS_NAME,CFPM.CFP_NO,IFPM.IFP_NO,
        PSM.PS_NO,RS.RS_NO,RS.RS_NAME FROM CONTRACT_MASTER CM 
        JOIN HELPER_TABLE H ON CM.CONTRACT_TYPE = H.HELPER_TABLE_SID JOIN CFP_CONTRACT CFP ON 
        CFP.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID 
        JOIN CFP_MODEL CFPM ON CFPM.CFP_MODEL_SID = CFP.CFP_MODEL_SID JOIN CFP_CONTRACT_DETAILS CFPD 
        ON CFPD.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID 
        JOIN IFP_CONTRACT IFP ON IFP.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID AND 
        IFP.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID 
        JOIN IFP_MODEL IFPM ON IFPM.IFP_MODEL_SID = IFP.IFP_MODEL_SID JOIN IFP_CONTRACT_DETAILS IFPD
        ON IFPD.IFP_CONTRACT_SID = IFP.IFP_CONTRACT_SID 
        JOIN PS_CONTRACT PS ON PS.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID AND PS.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID
        AND PS.IFP_CONTRACT_SID = IFP.IFP_CONTRACT_SID 
        JOIN PS_MODEL PSM ON PSM.PS_MODEL_SID = PS.PS_MODEL_SID JOIN PS_CONTRACT_DETAILS PSD ON PSD.PS_CONTRACT_SID = PS.PS_CONTRACT_SID
        AND PSD.ITEM_MASTER_SID = IFPD.ITEM_MASTER_SID 
        JOIN RS_CONTRACT RS ON RS.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID AND RS.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID
        AND RS.IFP_CONTRACT_SID = IFP.IFP_CONTRACT_SID AND RS.PS_CONTRACT_SID = PS.PS_CONTRACT_SID 
        JOIN RS_CONTRACT_DETAILS RSD ON RSD.RS_CONTRACT_SID = RS.RS_CONTRACT_SID
        AND RSD.ITEM_MASTER_SID = PSD.ITEM_MASTER_SID JOIN COMPANY_MASTER COM ON COM.COMPANY_MASTER_SID = CFPD.COMPANY_MASTER_SID 
        JOIN ITEM_MASTER IM ON IM.ITEM_MASTER_SID = IFPD.ITEM_MASTER_SID
        LEFT JOIN COMPANY_MASTER CON_HOL ON CM.CONT_HOLD_COMPANY_MASTER_SID = CON_HOL.COMPANY_MASTER_SID  AND CON_HOL.INBOUND_STATUS <> 'D'
        WHERE  IM.INBOUND_STATUS <> 'D'
        AND CM.INBOUND_STATUS <> 'D'
        AND CFP.INBOUND_STATUS <> 'D'
        AND CFPD.INBOUND_STATUS <> 'D'
        AND IFPD.INBOUND_STATUS <> 'D'
        AND PS.INBOUND_STATUS <> 'D'
        AND PSD.INBOUND_STATUS <> 'D'
        AND RS.INBOUND_STATUS <> 'D'
        AND RSD.INBOUND_STATUS <> 'D'
        AND COM.INBOUND_STATUS <> 'D'
        AND CFPM.INBOUND_STATUS <> 'D'
        AND IFPM.INBOUND_STATUS <> 'D'
        AND PSM.INBOUND_STATUS <> 'D'
        AND CM.CONTRACT_NO LIKE '?'
        AND CM.CONTRACT_NAME LIKE '?'
        AND CFPM.CFP_NO LIKE '?'
        AND CFP.CFP_NAME LIKE '?'
        AND IFPM.IFP_NO LIKE '?'
        AND IFP.IFP_NAME LIKE '?'
        AND COM.COMPANY_NO LIKE '?'
        AND COM.COMPANY_NAME LIKE '?'
        AND IM.ITEM_NO LIKE '?'
        AND IM.ITEM_NAME LIKE '?'
        ]]>
    </sql>
    
    <sql id="availableContracts">
        <![CDATA[
               SELECT DISTINCT CM.CONTRACT_MASTER_SID,
               CM.CONTRACT_NO,
               CM.CONTRACT_NAME,
               H.HELPER_TABLE_SID CONTRACT_TYPE,
               CFP.CFP_NAME,
               IFP.IFP_NAME,
               COM.COMPANY_NO,
               COM.COMPANY_NAME,
               CON_HOL.COMPANY_NAME AS CONTRACT_HOLDER,
               IM.ITEM_NO,
               IM.ITEM_NAME,
               PS.PS_NAME,
               CFPM.CFP_NO,
               IFPM.IFP_NO,
               PSM.PS_NO,
               RS.RS_NO,
               RS.RS_NAME
               FROM   CONTRACT_MASTER CM
               JOIN HELPER_TABLE H
               ON CM.CONTRACT_TYPE = H.HELPER_TABLE_SID
               JOIN CFP_CONTRACT CFP
               ON CFP.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID
               JOIN CFP_MODEL CFPM
               ON CFPM.CFP_MODEL_SID = CFP.CFP_MODEL_SID
               JOIN CFP_CONTRACT_DETAILS CFPD
               ON CFPD.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID
               JOIN IFP_CONTRACT IFP
               ON IFP.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID
               AND IFP.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID
               JOIN IFP_MODEL IFPM
               ON IFPM.IFP_MODEL_SID = IFP.IFP_MODEL_SID
               JOIN IFP_CONTRACT_DETAILS IFPD
               ON IFPD.IFP_CONTRACT_SID = IFP.IFP_CONTRACT_SID
               JOIN PS_CONTRACT PS
               ON PS.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID
               AND PS.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID
               AND PS.IFP_CONTRACT_SID = IFP.IFP_CONTRACT_SID
               JOIN PS_MODEL PSM
               ON PSM.PS_MODEL_SID = PS.PS_MODEL_SID
               JOIN PS_CONTRACT_DETAILS PSD
               ON PSD.PS_CONTRACT_SID = PS.PS_CONTRACT_SID
               AND PSD.ITEM_MASTER_SID = IFPD.ITEM_MASTER_SID
               JOIN RS_CONTRACT RS
               ON RS.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID
               AND RS.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID
               AND RS.IFP_CONTRACT_SID = IFP.IFP_CONTRACT_SID
               AND RS.PS_CONTRACT_SID = PS.PS_CONTRACT_SID
               JOIN RS_CONTRACT_DETAILS RSD
               ON RSD.RS_CONTRACT_SID = RS.RS_CONTRACT_SID
               AND RSD.ITEM_MASTER_SID = PSD.ITEM_MASTER_SID
               JOIN COMPANY_MASTER COM
               ON COM.COMPANY_MASTER_SID = CFPD.COMPANY_MASTER_SID
               JOIN ITEM_MASTER IM
               ON IM.ITEM_MASTER_SID = IFPD.ITEM_MASTER_SID
               LEFT JOIN COMPANY_MASTER CON_HOL
               ON CM.CONT_HOLD_COMPANY_MASTER_SID = CON_HOL.COMPANY_MASTER_SID
               AND CON_HOL.INBOUND_STATUS <> 'D'
               WHERE  IM.INBOUND_STATUS <> 'D'
               AND CM.INBOUND_STATUS <> 'D'
               AND CFP.INBOUND_STATUS <> 'D'
               AND CFPD.INBOUND_STATUS <> 'D'
               AND IFPD.INBOUND_STATUS <> 'D'
               AND PS.INBOUND_STATUS <> 'D'
               AND PSD.INBOUND_STATUS <> 'D'
               AND RS.INBOUND_STATUS <> 'D'
               AND RSD.INBOUND_STATUS <> 'D'
               AND COM.INBOUND_STATUS <> 'D'
               AND CFPM.INBOUND_STATUS <> 'D'
               AND IFPM.INBOUND_STATUS <> 'D'
               AND PSM.INBOUND_STATUS <> 'D'
               AND CM.CONTRACT_NO LIKE '?'
               AND CM.CONTRACT_NAME LIKE '?'
               AND CFPM.CFP_NO LIKE '?'
               AND CFP.CFP_NAME LIKE '?'
               AND IFPM.IFP_NO LIKE '?'
               AND IFP.IFP_NAME LIKE '?'
               AND COM.COMPANY_NO LIKE '?'
               AND COM.COMPANY_NAME LIKE '?'
               AND IM.ITEM_NO LIKE '?'
               AND IM.ITEM_NAME LIKE '?'  
               ]]>
    </sql>
    
    <sql id="availableCustomersCount">
        <![CDATA[
        ;WITH RECORD_COUNT
     AS (SELECT DISTINCT CM.CONTRACT_MASTER_SID,
                         CM.CONTRACT_NO,
                         CM.CONTRACT_NAME,
                         H.HELPER_TABLE_SID   CONTRACT_TYPE,
                         CFP.CFP_NAME,
                         IFP.IFP_NAME,
                         COM.COMPANY_NO,
                         COM.COMPANY_NAME,
                         CON_HOL.COMPANY_NAME AS CONTRACT_HOLDER,
                         IM.ITEM_NO,
                         IM.ITEM_NAME,
                         PS.PS_NAME,
                         CFPM.CFP_NO,
                         IFPM.IFP_NO,
                         PSM.PS_NO,
                         RS.RS_NO,
                         RS.RS_NAME,
                         CFPD.CFP_CONTRACT_DETAILS_SID
         FROM   CONTRACT_MASTER CM
                JOIN HELPER_TABLE H
                  ON CM.CONTRACT_TYPE = H.HELPER_TABLE_SID
                JOIN CFP_CONTRACT CFP
                  ON CFP.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID
                JOIN CFP_MODEL CFPM
                  ON CFPM.CFP_MODEL_SID = CFP.CFP_MODEL_SID
                JOIN CFP_CONTRACT_DETAILS CFPD
                  ON CFPD.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID
                JOIN IFP_CONTRACT IFP
                  ON IFP.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID
                     AND IFP.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID
                JOIN IFP_MODEL IFPM
                  ON IFPM.IFP_MODEL_SID = IFP.IFP_MODEL_SID
                JOIN IFP_CONTRACT_DETAILS IFPD
                  ON IFPD.IFP_CONTRACT_SID = IFP.IFP_CONTRACT_SID
                JOIN PS_CONTRACT PS
                  ON PS.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID
                     AND PS.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID
                     AND PS.IFP_CONTRACT_SID = IFP.IFP_CONTRACT_SID
                JOIN PS_MODEL PSM
                  ON PSM.PS_MODEL_SID = PS.PS_MODEL_SID
                JOIN PS_CONTRACT_DETAILS PSD
                  ON PSD.PS_CONTRACT_SID = PS.PS_CONTRACT_SID
                     AND PSD.ITEM_MASTER_SID = IFPD.ITEM_MASTER_SID
                JOIN RS_CONTRACT RS
                  ON RS.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID
                     AND RS.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID
                     AND RS.IFP_CONTRACT_SID = IFP.IFP_CONTRACT_SID
                     AND RS.PS_CONTRACT_SID = PS.PS_CONTRACT_SID
                JOIN RS_CONTRACT_DETAILS RSD
                  ON RSD.RS_CONTRACT_SID = RS.RS_CONTRACT_SID
                     AND RSD.ITEM_MASTER_SID = PSD.ITEM_MASTER_SID
                JOIN COMPANY_MASTER COM
                  ON COM.COMPANY_MASTER_SID = CFPD.COMPANY_MASTER_SID
                JOIN ITEM_MASTER IM
                  ON IM.ITEM_MASTER_SID = IFPD.ITEM_MASTER_SID
                LEFT JOIN COMPANY_MASTER CON_HOL
                       ON CM.CONT_HOLD_COMPANY_MASTER_SID = CON_HOL.COMPANY_MASTER_SID
                          AND CON_HOL.COMPANY_NAME LIKE '%'
                          AND CON_HOL.INBOUND_STATUS <> 'D'
         WHERE  IM.INBOUND_STATUS <> 'D'
                AND CM.INBOUND_STATUS <> 'D'
                AND CFP.INBOUND_STATUS <> 'D'
                AND CFPD.INBOUND_STATUS <> 'D'
                AND IFPD.INBOUND_STATUS <> 'D'
                AND PS.INBOUND_STATUS <> 'D'
                AND PSD.INBOUND_STATUS <> 'D'
                AND RS.INBOUND_STATUS <> 'D'
                AND RSD.INBOUND_STATUS <> 'D'
                AND COM.INBOUND_STATUS <> 'D'
                AND CFPM.INBOUND_STATUS <> 'D'
                AND IFPM.INBOUND_STATUS <> 'D'
                AND PSM.INBOUND_STATUS <> 'D'
                AND CM.CONTRACT_NO LIKE '%'
                AND CM.CONTRACT_NAME LIKE '%'
                AND CFPM.CFP_NO LIKE '%'
                AND CFP.CFP_NAME LIKE '%'
                AND IFPM.IFP_NO LIKE '%'
                AND IFP.IFP_NAME LIKE '%'
                AND COM.COMPANY_NO LIKE '%'
                AND COM.COMPANY_NAME LIKE '%'
                AND IM.ITEM_NO LIKE '%'
                AND IM.ITEM_NAME LIKE '%')
SELECT Count(1)
FROM   (SELECT CUSTOMER_NAME,
               CUSTOMER_NO,
               CONTRACT_NO,
               CONTRACT_NAME,
               CFP_NO,
               CFP_NAME,
               CONTRACT_MASTER_SID,
               CFP_CONTRACT_DETAILS_SID 
        FROM   (SELECT Row_number()
                         OVER (
                           PARTITION BY COMPANY_NAME, COMPANY_NO, CONTRACT_NO, CONTRACT_NAME, CFP_NO, CFP_NAME, CONTRACT_MASTER_SID, CFP_CONTRACT_DETAILS_SID
                           ORDER BY CONTRACT_NO) RN,
                       COMPANY_NAME              AS CUSTOMER_NAME,
                       COMPANY_NO                AS CUSTOMER_NO,
                       CONTRACT_NO,
                       CONTRACT_NAME,
                       CFP_NO,
                       CFP_NAME,
                       CONTRACT_MASTER_SID,
                       CFP_CONTRACT_DETAILS_SID
                FROM   RECORD_COUNT
                WHERE  CONTRACT_MASTER_SID = '?' ?Filter )A
        WHERE  RN = 1)R 
        ]]>
    </sql>
    
    <sql id="availableCustomers">
        <![CDATA[
        ;WITH DISPLAY
     AS (SELECT DISTINCT CM.CONTRACT_MASTER_SID,
                         CM.CONTRACT_NO,
                         CM.CONTRACT_NAME,
                         H.HELPER_TABLE_SID   CONTRACT_TYPE,
                         CFP.CFP_NAME,
                         IFP.IFP_NAME,
                         COM.COMPANY_NO,
                         COM.COMPANY_NAME,
                         CON_HOL.COMPANY_NAME AS CONTRACT_HOLDER,
                         IM.ITEM_NO,
                         IM.ITEM_NAME,
                         PS.PS_NAME,
                         CFPM.CFP_NO,
                         IFPM.IFP_NO,
                         PSM.PS_NO,
                         RS.RS_NO,
                         RS.RS_NAME,
                         CFPD.CFP_CONTRACT_DETAILS_SID
         FROM   CONTRACT_MASTER CM
                JOIN HELPER_TABLE H
                  ON CM.CONTRACT_TYPE = H.HELPER_TABLE_SID
                JOIN CFP_CONTRACT CFP
                  ON CFP.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID
                JOIN CFP_MODEL CFPM
                  ON CFPM.CFP_MODEL_SID = CFP.CFP_MODEL_SID
                JOIN CFP_CONTRACT_DETAILS CFPD
                  ON CFPD.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID
                JOIN IFP_CONTRACT IFP
                  ON IFP.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID
                     AND IFP.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID
                JOIN IFP_MODEL IFPM
                  ON IFPM.IFP_MODEL_SID = IFP.IFP_MODEL_SID
                JOIN IFP_CONTRACT_DETAILS IFPD
                  ON IFPD.IFP_CONTRACT_SID = IFP.IFP_CONTRACT_SID
                JOIN PS_CONTRACT PS
                  ON PS.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID
                     AND PS.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID
                     AND PS.IFP_CONTRACT_SID = IFP.IFP_CONTRACT_SID
                JOIN PS_MODEL PSM
                  ON PSM.PS_MODEL_SID = PS.PS_MODEL_SID
                JOIN PS_CONTRACT_DETAILS PSD
                  ON PSD.PS_CONTRACT_SID = PS.PS_CONTRACT_SID
                     AND PSD.ITEM_MASTER_SID = IFPD.ITEM_MASTER_SID
                JOIN RS_CONTRACT RS
                  ON RS.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID
                     AND RS.CFP_CONTRACT_SID = CFP.CFP_CONTRACT_SID
                     AND RS.IFP_CONTRACT_SID = IFP.IFP_CONTRACT_SID
                     AND RS.PS_CONTRACT_SID = PS.PS_CONTRACT_SID
                JOIN RS_CONTRACT_DETAILS RSD
                  ON RSD.RS_CONTRACT_SID = RS.RS_CONTRACT_SID
                     AND RSD.ITEM_MASTER_SID = PSD.ITEM_MASTER_SID
                JOIN COMPANY_MASTER COM
                  ON COM.COMPANY_MASTER_SID = CFPD.COMPANY_MASTER_SID
                JOIN ITEM_MASTER IM
                  ON IM.ITEM_MASTER_SID = IFPD.ITEM_MASTER_SID
                LEFT JOIN COMPANY_MASTER CON_HOL
                       ON CM.CONT_HOLD_COMPANY_MASTER_SID = CON_HOL.COMPANY_MASTER_SID
                          AND CON_HOL.COMPANY_NAME LIKE '%'
                          AND CON_HOL.INBOUND_STATUS <> 'D'
         WHERE  IM.INBOUND_STATUS <> 'D'
                AND CM.INBOUND_STATUS <> 'D'
                AND CFP.INBOUND_STATUS <> 'D'
                AND CFPD.INBOUND_STATUS <> 'D'
                AND IFPD.INBOUND_STATUS <> 'D'
                AND PS.INBOUND_STATUS <> 'D'
                AND PSD.INBOUND_STATUS <> 'D'
                AND RS.INBOUND_STATUS <> 'D'
                AND RSD.INBOUND_STATUS <> 'D'
                AND COM.INBOUND_STATUS <> 'D'
                AND CFPM.INBOUND_STATUS <> 'D'
                AND IFPM.INBOUND_STATUS <> 'D'
                AND PSM.INBOUND_STATUS <> 'D'
                AND CM.CONTRACT_NO LIKE '%'
                AND CM.CONTRACT_NAME LIKE '%'
                AND CFPM.CFP_NO LIKE '%'
                AND CFP.CFP_NAME LIKE '%'
                AND IFPM.IFP_NO LIKE '%'
                AND IFP.IFP_NAME LIKE '%'
                AND COM.COMPANY_NO LIKE '%'
                AND COM.COMPANY_NAME LIKE '%'
                AND IM.ITEM_NO LIKE '%'
                AND IM.ITEM_NAME LIKE '%')
SELECT CUSTOMER_NAME,
       CUSTOMER_NO,
       CONTRACT_NO,
       CONTRACT_NAME,
       CFP_NO,
       CFP_NAME, 
       CONTRACT_MASTER_SID,
       CFP_CONTRACT_DETAILS_SID
FROM   (SELECT ROW_NUMBER()
                 OVER (
                   PARTITION BY COMPANY_NAME, COMPANY_NO, CONTRACT_NO, CONTRACT_NAME, CFP_NO, CFP_NAME, CONTRACT_MASTER_SID, CFP_CONTRACT_DETAILS_SID
                   ORDER BY CONTRACT_NO) RN,
               COMPANY_NAME              AS CUSTOMER_NAME,
               COMPANY_NO                AS CUSTOMER_NO,
               CONTRACT_NO,
               CONTRACT_NAME,
               CFP_NO,
               CFP_NAME,
               CONTRACT_MASTER_SID,
               CFP_CONTRACT_DETAILS_SID
        FROM   DISPLAY
        WHERE  CONTRACT_MASTER_SID = '?' ?Filter )A
WHERE  RN = 1
        ]]>
    </sql>
     <sql id="tempDeductionSaveContract">
        <![CDATA[

MERGE DEDUCTION_DETAILS AS TARGET
USING (SELECT DEDUCTION_DETAILS_SID,
              NET_SALES_FORMULA_MASTER_SID,
              CONTRACT_MASTER_SID,
              CDR_MODEL_SID,
              "INDICATOR",
              INBOUND_STATUS,
              CHECK_RECORD,
              CREATED_DATE,
              CREATED_BY,
              MODIFIED_BY,
              MODIFIED_DATE,
              DEDUCTION_TYPE,
              DEDUCTION_SUB_TYPE,
              DEDUCTION_CATEGORY,
              RS_CONTRACT_SID
       FROM   IMTD_DEDUCTION_DETAILS
       WHERE  USERS_SID =  '?UID'
              AND SESSION_ID = '?SID'
              
             
      ) AS SOURCE
ON ( TARGET.DEDUCTION_DETAILS_SID = SOURCE.DEDUCTION_DETAILS_SID
     AND TARGET.NET_SALES_FORMULA_MASTER_SID = SOURCE.NET_SALES_FORMULA_MASTER_SID )
WHEN MATCHED THEN
  UPDATE SET TARGET.NET_SALES_FORMULA_MASTER_SID = SOURCE.NET_SALES_FORMULA_MASTER_SID,
             TARGET.CONTRACT_MASTER_SID = SOURCE.CONTRACT_MASTER_SID,
             TARGET.CDR_MODEL_SID = SOURCE.CDR_MODEL_SID,
             TARGET."INDICATOR" = SOURCE."INDICATOR",
             TARGET.INBOUND_STATUS = SOURCE.INBOUND_STATUS,
             TARGET.CREATED_DATE = SOURCE.CREATED_DATE,
             TARGET.CREATED_BY = SOURCE.CREATED_BY,
             TARGET.MODIFIED_BY = SOURCE.MODIFIED_BY,
             TARGET.MODIFIED_DATE = CURRENT_TIMESTAMP,
             TARGET.RECORD_LOCK_STATUS = 'false',
             TARGET.DEDUCTION_TYPE = SOURCE.DEDUCTION_TYPE,
             TARGET.DEDUCTION_SUB_TYPE = SOURCE.DEDUCTION_SUB_TYPE,
             TARGET.DEDUCTION_CATEGORY = SOURCE.DEDUCTION_CATEGORY,
             TARGET.RS_CONTRACT_SID = SOURCE.RS_CONTRACT_SID
WHEN NOT MATCHED BY TARGET THEN
  INSERT ( NET_SALES_FORMULA_MASTER_SID,
           CONTRACT_MASTER_SID,
           CDR_MODEL_SID,
           "INDICATOR",
           INBOUND_STATUS,
           CREATED_DATE,
           CREATED_BY,
           MODIFIED_BY,
           MODIFIED_DATE,
           DEDUCTION_TYPE,
           DEDUCTION_SUB_TYPE,
           DEDUCTION_CATEGORY,
           RS_CONTRACT_SID )
  VALUES ('?NSFID',
          SOURCE.CONTRACT_MASTER_SID,
          SOURCE.CDR_MODEL_SID,
          SOURCE."INDICATOR",
          SOURCE.INBOUND_STATUS,
          SOURCE.CREATED_DATE,
          SOURCE.CREATED_BY,
          SOURCE.MODIFIED_BY,
          SOURCE.MODIFIED_DATE,
          SOURCE.DEDUCTION_TYPE,
          SOURCE.DEDUCTION_SUB_TYPE,
          SOURCE.DEDUCTION_CATEGORY,
          SOURCE.RS_CONTRACT_SID);
        
        
          ]]>
    </sql>
    <sql id="tempDeductionSave">
        <![CDATA[

MERGE DEDUCTION_DETAILS AS TARGET
USING (SELECT DEDUCTION_DETAILS_SID,
              NET_SALES_FORMULA_MASTER_SID,
              CONTRACT_MASTER_SID,
              CDR_MODEL_SID,
              "INDICATOR",
              INBOUND_STATUS,
              CHECK_RECORD,
              CREATED_DATE,
              CREATED_BY,
              MODIFIED_BY,
              MODIFIED_DATE,
              DEDUCTION_TYPE,
              DEDUCTION_SUB_TYPE,
              DEDUCTION_CATEGORY,
              RS_CONTRACT_SID
       FROM   IMTD_DEDUCTION_DETAILS
       WHERE  USERS_SID =  '?UID'
              AND SESSION_ID = '?SID'
             
              
      ) AS SOURCE
ON ( TARGET.DEDUCTION_DETAILS_SID = SOURCE.DEDUCTION_DETAILS_SID
     AND TARGET.NET_SALES_FORMULA_MASTER_SID = SOURCE.NET_SALES_FORMULA_MASTER_SID )
WHEN MATCHED THEN
  UPDATE SET TARGET.NET_SALES_FORMULA_MASTER_SID = SOURCE.NET_SALES_FORMULA_MASTER_SID,
             TARGET.CONTRACT_MASTER_SID = SOURCE.CONTRACT_MASTER_SID,
             TARGET.CDR_MODEL_SID = SOURCE.CDR_MODEL_SID,
             TARGET."INDICATOR" = SOURCE."INDICATOR",
             TARGET.INBOUND_STATUS = SOURCE.INBOUND_STATUS,
             TARGET.CREATED_DATE = SOURCE.CREATED_DATE,
             TARGET.CREATED_BY = SOURCE.CREATED_BY,
             TARGET.MODIFIED_BY = SOURCE.MODIFIED_BY,
             TARGET.MODIFIED_DATE = CURRENT_TIMESTAMP,
             TARGET.RECORD_LOCK_STATUS = 'false',
             TARGET.DEDUCTION_TYPE = SOURCE.DEDUCTION_TYPE,
             TARGET.DEDUCTION_SUB_TYPE = SOURCE.DEDUCTION_SUB_TYPE,
             TARGET.DEDUCTION_CATEGORY = SOURCE.DEDUCTION_CATEGORY,
             TARGET.RS_CONTRACT_SID = SOURCE.RS_CONTRACT_SID
WHEN NOT MATCHED BY TARGET THEN
  INSERT ( NET_SALES_FORMULA_MASTER_SID,          
           CDR_MODEL_SID,
           "INDICATOR",
           INBOUND_STATUS,
           CREATED_DATE,
           CREATED_BY,
           MODIFIED_BY,
           MODIFIED_DATE,
           DEDUCTION_TYPE,
           DEDUCTION_SUB_TYPE,
           DEDUCTION_CATEGORY)
  VALUES ('?NSFID',         
          SOURCE.CDR_MODEL_SID,
          SOURCE."INDICATOR",
          SOURCE.INBOUND_STATUS,
          SOURCE.CREATED_DATE,
          SOURCE.CREATED_BY,
          SOURCE.MODIFIED_BY,
          SOURCE.MODIFIED_DATE,
          SOURCE.DEDUCTION_TYPE,
          SOURCE.DEDUCTION_SUB_TYPE,
          SOURCE.DEDUCTION_CATEGORY
          );
        
        
          ]]>
    </sql>
    <sql id="tempDeductionInsert">
        <![CDATA[
 
INSERT into IMTD_DEDUCTION_DETAILS(DEDUCTION_DETAILS_SID,NET_SALES_FORMULA_MASTER_SID,
DEDUCTION_TYPE,DEDUCTION_SUB_TYPE,DEDUCTION_CATEGORY,CDR_MODEL_SID,"INDICATOR",CHECK_RECORD,INBOUND_STATUS,USERS_SID,SESSION_ID,IMTD_CREATED_DATE,"OPERATION",
CREATED_BY,CREATED_DATE,MODIFIED_BY,MODIFIED_DATE)
select DD.DEDUCTION_DETAILS_SID,DD.NET_SALES_FORMULA_MASTER_SID,DD.DEDUCTION_TYPE,DD.DEDUCTION_SUB_TYPE,DD.DEDUCTION_CATEGORY,DD.CDR_MODEL_SID,DD."INDICATOR",0 as CHECK_RECORD,DD.INBOUND_STATUS,'?UID' as USERS_SID,
'?SID' as SESSION_ID, CURRENT_TIMESTAMP as IMTD_CREATED_DATE,'U',DD.CREATED_BY,DD.CREATED_DATE,DD.MODIFIED_BY,DD.MODIFIED_DATE 
from DEDUCTION_DETAILS DD 
where DD.NET_SALES_FORMULA_MASTER_SID='?NSFID' AND DD.INBOUND_STATUS <> 'D' ;
        
        ]]>
    </sql>
    <sql id="tempDeductionInsertContract">
        <![CDATA[

INSERT into IMTD_DEDUCTION_DETAILS(DEDUCTION_DETAILS_SID,NET_SALES_FORMULA_MASTER_SID,CONTRACT_MASTER_SID,CONTRACT_NO,CONTRACT_NAME,DEDUCTION_NO,DEDUCTION_NAME,
DEDUCTION_TYPE,DEDUCTION_SUB_TYPE,DEDUCTION_CATEGORY,CDR_MODEL_SID,"INDICATOR",CHECK_RECORD,INBOUND_STATUS,USERS_SID,SESSION_ID,IMTD_CREATED_DATE,"OPERATION",
CREATED_BY,CREATED_DATE,MODIFIED_BY,MODIFIED_DATE,RS_CONTRACT_SID)
select DD.DEDUCTION_DETAILS_SID,DD.NET_SALES_FORMULA_MASTER_SID,DD.CONTRACT_MASTER_SID,CM.CONTRACT_NO,CM.CONTRACT_NAME,RSC.RS_NO,RSC.RS_NAME,DD.DEDUCTION_TYPE,DD.DEDUCTION_SUB_TYPE,DD.DEDUCTION_CATEGORY,DD.CDR_MODEL_SID,DD."INDICATOR",0 as CHECK_RECORD,DD.INBOUND_STATUS,'?UID' as USERS_SID,
'?SID' as SESSION_ID, CURRENT_TIMESTAMP as IMTD_CREATED_DATE,'U',DD.CREATED_BY,DD.CREATED_DATE,DD.MODIFIED_BY,DD.MODIFIED_DATE,DD.RS_CONTRACT_SID
from DEDUCTION_DETAILS DD
JOIN CONTRACT_MASTER CM on CM.CONTRACT_MASTER_SID=DD.CONTRACT_MASTER_SID
JOIN RS_CONTRACT RSC
               ON RSC.RS_CONTRACT_SID = DD.RS_CONTRACT_SID
where DD.NET_SALES_FORMULA_MASTER_SID='?NSFID' AND DD.INBOUND_STATUS <> 'D' ;

        
        ]]>
    </sql>
      <sql id="tempSaveSB">
        <![CDATA[
       
  MERGE SALES_BASIS_DETAILS AS Target
USING (SELECT SALES_BASIS_DETAILS_SID,NET_SALES_FORMULA_MASTER_SID,
              CONTRACT_MASTER_SID,
              CFP_CONTRACT_DETAILS_SID,
              CDR_MODEL_SID,
              INBOUND_STATUS,
              CHECK_RECORD,
              CREATED_DATE,
              CREATED_BY,
              MODIFIED_BY,
              MODIFIED_DATE
       FROM   IMTD_SALES_BASIS_DETAILS
       WHERE  USERS_SID = '?UID'
              AND SESSION_ID = '?SID'
              
			 
            ) AS Source
ON ( Target.SALES_BASIS_DETAILS_SID = SOURCE.SALES_BASIS_DETAILS_SID and Target.NET_SALES_FORMULA_MASTER_SID = Source.NET_SALES_FORMULA_MASTER_SID )
WHEN MATCHED THEN
  UPDATE SET TARGET.CONTRACT_MASTER_SID = SOURCE.CONTRACT_MASTER_SID,
             TARGET.CFP_CONTRACT_DETAILS_SID = SOURCE.CFP_CONTRACT_DETAILS_SID,
             TARGET.CDR_MODEL_SID = SOURCE.CDR_MODEL_SID,
             TARGET.INBOUND_STATUS = SOURCE.INBOUND_STATUS,
             TARGET.RECORD_LOCK_STATUS = 'false',
             TARGET.MODIFIED_BY = SOURCE.MODIFIED_BY,
             TARGET.MODIFIED_DATE = CURRENT_TIMESTAMP
WHEN NOT MATCHED BY Target THEN
  INSERT (NET_SALES_FORMULA_MASTER_SID,
          CONTRACT_MASTER_SID,
          CFP_CONTRACT_DETAILS_SID,
          CDR_MODEL_SID,
          INBOUND_STATUS,
          CREATED_DATE,
          CREATED_BY,
          MODIFIED_BY,
          MODIFIED_DATE )
  VALUES ('?NSFID',
          SOURCE.CONTRACT_MASTER_SID,
          SOURCE.CFP_CONTRACT_DETAILS_SID,
          SOURCE.CDR_MODEL_SID,
          SOURCE.INBOUND_STATUS,
          SOURCE.CREATED_DATE,
          SOURCE.CREATED_BY,
          SOURCE.MODIFIED_BY,
          SOURCE.MODIFIED_DATE);

        
          ]]>
    </sql>
   
    <sql id="tempSbInsert">
        <![CDATA[
        
        
INSERT into IMTD_SALES_BASIS_DETAILS(SALES_BASIS_DETAILS_SID,NET_SALES_FORMULA_MASTER_SID,CONTRACT_MASTER_SID,CONTRACT_NO,CONTRACT_NAME,CFP_CONTRACT_DETAILS_SID,CFP_NO,
CFP_NAME,CUSTOMER_NO,CUSTOMER_NAME,CDR_MODEL_SID,CHECK_RECORD,INBOUND_STATUS,SESSION_ID,IMTD_CREATED_DATE,USERS_SID,"OPERATION",CREATED_BY,CREATED_DATE,MODIFIED_BY,MODIFIED_DATE)
select SBD.SALES_BASIS_DETAILS_SID,SBD.NET_SALES_FORMULA_MASTER_SID,SBD.CONTRACT_MASTER_SID,
CM.CONTRACT_NO,CM.CONTRACT_NAME,SBD.CFP_CONTRACT_DETAILS_SID,CFP.CFP_NO,CFP.CFP_NAME,COMP.COMPANY_NO,
COMP.COMPANY_NAME,SBD.CDR_MODEL_SID,0 as CHECK_RECORD,SBD.INBOUND_STATUS,'?SID' as SESSION_ID, CURRENT_TIMESTAMP as IMTD_CREATEDDATE,'?UID' as USERS_SID,'U',
SBD.CREATED_BY,SBD.CREATED_DATE,SBD.MODIFIED_BY,SBD.MODIFIED_DATE from SALES_BASIS_DETAILS SBD 
JOIN CONTRACT_MASTER CM on CM.CONTRACT_MASTER_SID=SBD.CONTRACT_MASTER_SID
JOIN CFP_CONTRACT_DETAILS CFPCD on CFPCD.CFP_CONTRACT_DETAILS_SID=SBD.CFP_CONTRACT_DETAILS_SID
JOIN CFP_CONTRACT CFPC on CFPC.CFP_CONTRACT_SID=CFPCD.CFP_CONTRACT_SID
JOIN CFP_MODEL CFP on CFP.CFP_MODEL_SID=CFPC.CFP_MODEL_SID 
JOIN COMPANY_MASTER COMP on COMP.COMPANY_MASTER_SID=CFPCD.COMPANY_MASTER_SID
where SBD.NET_SALES_FORMULA_MASTER_SID='?NSFID' AND SBD.INBOUND_STATUS <> 'D' ;
    
        ]]>
    </sql>
    
    <sql id="copyTempSbInsert">
        <![CDATA[
        INSERT into IMTD_SALES_BASIS_DETAILS(SALES_BASIS_DETAILS_SID,NET_SALES_FORMULA_MASTER_SID,CONTRACT_MASTER_SID,CONTRACT_NO,CONTRACT_NAME,CFP_CONTRACT_DETAILS_SID,CFP_NO,
 CFP_NAME,CUSTOMER_NO,CUSTOMER_NAME,CDR_MODEL_SID,CHECK_RECORD,INBOUND_STATUS,SESSION_ID,IMTD_CREATED_DATE,USERS_SID,"OPERATION",CREATED_BY,CREATED_DATE,MODIFIED_BY,MODIFIED_DATE)
 select 0,0,SBD.CONTRACT_MASTER_SID,
 CM.CONTRACT_NO,CM.CONTRACT_NAME,SBD.CFP_CONTRACT_DETAILS_SID,CFP.CFP_NO,CFP.CFP_NAME,COMP.COMPANY_NO,
 COMP.COMPANY_NAME,SBD.CDR_MODEL_SID,0 as CHECK_RECORD,SBD.INBOUND_STATUS,'?SID' as SESSION_ID, CURRENT_TIMESTAMP as IMTD_CREATEDDATE,'?UID' as USERS_SID,'A',
SBD.CREATED_BY,SBD.CREATED_DATE,SBD.MODIFIED_BY,SBD.MODIFIED_DATE from SALES_BASIS_DETAILS SBD 
JOIN CONTRACT_MASTER CM on CM.CONTRACT_MASTER_SID=SBD.CONTRACT_MASTER_SID
JOIN CFP_CONTRACT_DETAILS CFPCD on CFPCD.CFP_CONTRACT_DETAILS_SID=SBD.CFP_CONTRACT_DETAILS_SID
JOIN CFP_CONTRACT CFPC on CFPC.CFP_CONTRACT_SID=CFPCD.CFP_CONTRACT_SID
JOIN CFP_MODEL CFP on CFP.CFP_MODEL_SID=CFPC.CFP_MODEL_SID 
JOIN COMPANY_MASTER COMP on COMP.COMPANY_MASTER_SID=CFPCD.COMPANY_MASTER_SID
where SBD.NET_SALES_FORMULA_MASTER_SID='?NSFID' AND SBD.INBOUND_STATUS <> 'D' ;
        ]]>
    </sql>
    
     <sql id="copyTempDeductionInsert">
        <![CDATA[
        
INSERT into IMTD_DEDUCTION_DETAILS(DEDUCTION_DETAILS_SID,NET_SALES_FORMULA_MASTER_SID,
DEDUCTION_TYPE,DEDUCTION_SUB_TYPE,DEDUCTION_CATEGORY,CDR_MODEL_SID,"INDICATOR",CHECK_RECORD,INBOUND_STATUS,USERS_SID,SESSION_ID,IMTD_CREATED_DATE,"OPERATION",
CREATED_BY,CREATED_DATE,MODIFIED_BY,MODIFIED_DATE)
select 0,0,DD.DEDUCTION_TYPE,DD.DEDUCTION_SUB_TYPE,DD.DEDUCTION_CATEGORY,DD.CDR_MODEL_SID,DD."INDICATOR",0 as CHECK_RECORD,DD.INBOUND_STATUS,'?UID' as USERS_SID,
'?SID' as SESSION_ID, CURRENT_TIMESTAMP as IMTD_CREATED_DATE,'A',DD.CREATED_BY,DD.CREATED_DATE,DD.MODIFIED_BY,DD.MODIFIED_DATE
from DEDUCTION_DETAILS DD 
where DD.NET_SALES_FORMULA_MASTER_SID='?NSFID' AND DD.INBOUND_STATUS <> 'D' ;
        
        ]]>
    </sql>
    
     <sql id="copyTempDeductionContractInsert">
        <![CDATA[
        
        INSERT into IMTD_DEDUCTION_DETAILS(DEDUCTION_DETAILS_SID,NET_SALES_FORMULA_MASTER_SID,CONTRACT_MASTER_SID,CONTRACT_NO,CONTRACT_NAME,DEDUCTION_NO,DEDUCTION_NAME,
DEDUCTION_TYPE,DEDUCTION_SUB_TYPE,DEDUCTION_CATEGORY,CDR_MODEL_SID,"INDICATOR",CHECK_RECORD,INBOUND_STATUS,USERS_SID,SESSION_ID,IMTD_CREATED_DATE,"OPERATION",
CREATED_BY,CREATED_DATE,MODIFIED_BY,MODIFIED_DATE,RS_CONTRACT_SID)
select 0,0,DD.CONTRACT_MASTER_SID,CM.CONTRACT_NO,CM.CONTRACT_NAME,RSC.RS_NO,RSC.RS_NAME,DD.DEDUCTION_TYPE,DD.DEDUCTION_SUB_TYPE,DD.DEDUCTION_CATEGORY,DD.CDR_MODEL_SID,DD."INDICATOR",0 as CHECK_RECORD,DD.INBOUND_STATUS,'?UID' as USERS_SID,
'?SID' as SESSION_ID, CURRENT_TIMESTAMP as IMTD_CREATED_DATE,'A',DD.CREATED_BY,DD.CREATED_DATE,DD.MODIFIED_BY,DD.MODIFIED_DATE,DD.RS_CONTRACT_SID
from DEDUCTION_DETAILS DD
JOIN CONTRACT_MASTER CM on CM.CONTRACT_MASTER_SID=DD.CONTRACT_MASTER_SID 
JOIN RS_CONTRACT RSC
               ON RSC.RS_CONTRACT_SID = DD.RS_CONTRACT_SID
where DD.NET_SALES_FORMULA_MASTER_SID='?NSFID' AND DD.INBOUND_STATUS <> 'D' ;

        ]]>
    </sql>
    
    <sql id="net-sales-ppa-validation">
        <![CDATA[
        if exists (SELECT 1 FROM NET_SALES_FORMULA_MASTER N JOIN HELPER_TABLE HT ON  N.NET_SALES_FORMULA_TYPE=HT.HELPER_TABLE_SID
WHERE DESCRIPTION='CONTRACT DEDUCTION'  AND N.CONTRACT_SELECTION like  '%EXISTING CONTRACT%' and
n.NET_SALES_FORMULA_MASTER_SID=?
)
select 1 else
select 0

        ]]>
    </sql>
</custom-sql>
