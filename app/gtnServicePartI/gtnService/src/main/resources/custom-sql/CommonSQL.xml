<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<custom-sql>
    <sql id="getUser-Group">
        <![CDATA[
       SELECT DISTINCT stnm.USER_GROUP
FROM   ST_NM_PPA_PROJECTION_MASTER stnm
       JOIN PROJECTION_DETAILS pd
         ON stnm.PROJECTION_DETAILS_SID = pd.PROJECTION_DETAILS_SID
       JOIN PROJECTION_CUST_HIERARCHY pch
         ON pch.PROJECTION_MASTER_SID = pd.PROJECTION_MASTER_SID
       JOIN RELATIONSHIP_LEVEL_DEFINITION rld
         ON rld.RELATIONSHIP_LEVEL_SID = pch.RELATIONSHIP_LEVEL_SID
WHERE  rld.LEVEL_NAME = 'Trading Partner'
       AND pd.PROJECTION_MASTER_SID = ?;
		]]>
         
        
    </sql>
    <sql id="PMPY-UPDATE-SALES">
        <![CDATA[
     DECLARE @QUARTER                INT=?,
        @YEAR                   INT=?,
        @SESSION_ID             INT=?,
        @USER_ID                INT=?,
        
        @UPDATE_VALUE           FLOAT=?

UPDATE a
SET    a.PROJECTION_SALES = ( ( b.MONTHLY_WAC * 100 ) / b.QUARTERLY_WAC ) * ( @UPDATE_VALUE / 100 )
FROM   ST_NM_SALES_PROJECTION a
       JOIN (SELECT DISTINCT SLP.PROJECTION_DETAILS_SID,
                             Sum(SLP.PROJECTION_SALES)
                               OVER (
                                 PARTITION BY SLP.PROJECTION_DETAILS_SID, P.YEAR, P.QUARTER)          AS PROJECTION_SALES_QTR_WISE,
                             Sum(FM.DOLLARS)
                               OVER (
                                 PARTITION BY P.YEAR, P.QUARTER)                                      AS QUARTERLY_WAC,
                             Sum(FM.DOLLARS)
                               OVER (
                                 PARTITION BY SLP.PROJECTION_DETAILS_SID, P.YEAR, P.QUARTER, P.MONTH) AS MONTHLY_WAC,
                             p.year,
                             p.quarter,
                             p.MONTH,
                             p.PERIOD_SID
             FROM   ST_NM_SALES_PROJECTION SLP
                    JOIN PROJECTION_DETAILS PD
                      ON SLP.PROJECTION_DETAILS_SID = PD.PROJECTION_DETAILS_SID
                    JOIN CCP_DETAILS CCP
                      ON CCP.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
                    JOIN PERIOD P
                      ON SLP.PERIOD_SID = P.PERIOD_SID
                    CROSS APPLY (SELECT DOLLARS,
                                        P.PERIOD_SID
                                 FROM   FORECASTING_MASTER FM
                                        JOIN(SELECT FORECAST_NAME,
                                                    [VERSION]
                                             FROM   FILE_MANAGEMENT
                                             WHERE  FROM_PERIOD <= Getdate()
                                                    AND TO_PERIOD IS NULL)FT
                                          ON FM.FORECAST_NAME = FT.FORECAST_NAME
                                        JOIN PERIOD P
                                          ON P.YEAR = FM.FORECAST_YEAR
                                             AND P.MONTH = FORECAST_MONTH
                                             AND P.PERIOD_SID = SLP.PERIOD_SID
                                        JOIN ITEM_MASTER IM
                                          ON FM.NDC = IM.ITEM_ID
                                             AND IM.ITEM_MASTER_SID = CCP.ITEM_MASTER_SID
                                 WHERE  FM.FORECAST_VER IN ( FT.VERSION, Floor(FT.VERSION) ))FM
             WHERE  SLP.PROJECTION_DETAILS_SID IN ( ? )
                    AND USER_ID = @USER_ID
                    AND SESSION_ID = @SESSION_ID
                    AND P.QUARTER = @QUARTER
                    AND P.YEAR = @YEAR)b
         ON a.PROJECTION_DETAILS_SID = b.PROJECTION_DETAILS_SID
            AND a.PERIOD_SID = b.PERIOD_SID
            AND a.USER_ID = @USER_ID
            AND a.SESSION_ID = @SESSION_ID ;



		]]>
         
        
    </sql>
    
    <sql id="PMPY-UPDATE-UNITS">
        <![CDATA[
     DECLARE @QUARTER                INT=?,
        @YEAR                   INT=?,
        @SESSION_ID             INT=?,
        @USER_ID                INT=?,
        @UPDATE_VALUE           FLOAT=?


UPDATE a
SET    a.PROJECTION_UNITS = ( ( b.MONTHLY_WAC * 100 ) / b.QUARTERLY_WAC ) * ( @UPDATE_VALUE / 100 )
FROM   ST_NM_SALES_PROJECTION a
       JOIN (SELECT DISTINCT SLP.PROJECTION_DETAILS_SID,
                             Sum(SLP.PROJECTION_UNITS)
                               OVER (
                                 PARTITION BY SLP.PROJECTION_DETAILS_SID, P.YEAR, P.QUARTER)          AS PROJECTION_SALES_QTR_WISE,
                             Sum(FM.UNITS)
                               OVER (
                                 PARTITION BY P.YEAR, P.QUARTER)                                      AS QUARTERLY_WAC,
                             Sum(FM.UNITS)
                               OVER (
                                 PARTITION BY SLP.PROJECTION_DETAILS_SID, P.YEAR, P.QUARTER, P.MONTH) AS MONTHLY_WAC,
                             p.year,
                             p.quarter,
                             p.MONTH,
                             p.PERIOD_SID
             FROM   ST_NM_SALES_PROJECTION SLP
                    JOIN PROJECTION_DETAILS PD
                      ON SLP.PROJECTION_DETAILS_SID = PD.PROJECTION_DETAILS_SID
                    JOIN CCP_DETAILS CCP
                      ON CCP.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
                    JOIN PERIOD P
                      ON SLP.PERIOD_SID = P.PERIOD_SID
                    CROSS APPLY (SELECT UNITS,
                                        P.PERIOD_SID
                                 FROM   FORECASTING_MASTER FM
                                        JOIN(SELECT FORECAST_NAME,
                                                    [VERSION]
                                             FROM   FILE_MANAGEMENT
                                             WHERE  FROM_PERIOD <= Getdate()
                                                    AND TO_PERIOD IS NULL)FT
                                          ON FM.FORECAST_NAME = FT.FORECAST_NAME
                                        JOIN PERIOD P
                                          ON P.YEAR = FM.FORECAST_YEAR
                                             AND P.MONTH = FORECAST_MONTH
                                             AND P.PERIOD_SID = SLP.PERIOD_SID
                                        JOIN ITEM_MASTER IM
                                          ON FM.NDC = IM.ITEM_ID
                                             AND IM.ITEM_MASTER_SID = CCP.ITEM_MASTER_SID
                                 WHERE  FM.FORECAST_VER IN ( FT.VERSION, Floor(FT.VERSION) ))FM
             WHERE  SLP.PROJECTION_DETAILS_SID IN ( ? )
                    AND USER_ID = @USER_ID
                    AND SESSION_ID = @SESSION_ID
                    AND P.QUARTER = @QUARTER
                    AND P.YEAR = @YEAR)b
         ON a.PROJECTION_DETAILS_SID = b.PROJECTION_DETAILS_SID
            AND a.PERIOD_SID = b.PERIOD_SID
            AND a.USER_ID = @USER_ID
            AND a.SESSION_ID = @SESSION_ID; 


		]]>
         
        
    </sql>
    
    <sql id="PMPY-Load CH">
        <![CDATA[
     SELECT DISTINCT CM.COMPANY_MASTER_SID,
                CM.COMPANY_NAME
FROM   COMPANY_MASTER CM
       JOIN CONTRACT_MASTER CONM
         ON CM.COMPANY_MASTER_SID = CONM.CONT_HOLD_COMPANY_MASTER_SID
    
		]]>
         
        
    </sql>
    
    
    <sql id="PMPY-Load TP with CH">
        <![CDATA[
 SELECT DISTINCT  COMM.COMPANY_NO, COMM.COMPANY_NAME,COMM.COMPANY_MASTER_SID
FROM   CONTRACT_MASTER CONM
       JOIN CFP_CONTRACT_DETAILS CFP
         ON CONM.CONTRACT_MASTER_SID = CFP.CFP_CONTRACT_SID
            AND CONM.CONT_HOLD_COMPANY_MASTER_SID = ?
       JOIN COMPANY_MASTER COMM
         ON CFP.COMPANY_MASTER_SID = COMM.COMPANY_MASTER_SID
		 and COMM.COMPANY_NAME like '?'
		 and COMPANY_NO like '?'
       JOIN HELPER_TABLE HT
         ON COMM.COMPANY_TYPE != HT.HELPER_TABLE_SID
            AND HT.DESCRIPTION NOT IN ( 'manufacturer', 'BUNIT', 'Business Unit' )


		]]>
         
        
    </sql>
    <sql id="PMPY-Load TP without CH">
        <![CDATA[
 SELECT DISTINCT  COMM.COMPANY_NO, COMM.COMPANY_NAME,COMM.COMPANY_MASTER_SID
FROM   CONTRACT_MASTER CONM
       JOIN CFP_CONTRACT_DETAILS CFP
         ON CONM.CONTRACT_MASTER_SID = CFP.CFP_CONTRACT_SID
        
       JOIN COMPANY_MASTER COMM
         ON CFP.COMPANY_MASTER_SID = COMM.COMPANY_MASTER_SID
		 and COMM.COMPANY_NAME like '?'
		 and COMPANY_NO like '?'
       JOIN HELPER_TABLE HT
         ON COMM.COMPANY_TYPE != HT.HELPER_TABLE_SID
            AND HT.DESCRIPTION NOT IN ( 'manufacturer', 'BUNIT', 'Business Unit' )


		]]>
         
        
    </sql>
    <sql id="Check GTS Sales Values">
        <![CDATA[
 DECLARE @QUARTER      INT=?,
        @YEAR         INT=?,
        @SESSION_ID   INT=?,
        @USER_ID      INT=?,
        @UPDATE_VALUE FLOAT=?

SELECT DISTINCT Isnull(Sum(FM.DOLLARS)
                         OVER (
                           PARTITION BY P.YEAR, P.QUARTER), 0) AS QUARTERLY_WAC
FROM   ST_NM_SALES_PROJECTION SLP
       JOIN PROJECTION_DETAILS PD
         ON SLP.PROJECTION_DETAILS_SID = PD.PROJECTION_DETAILS_SID
       JOIN CCP_DETAILS CCP
         ON CCP.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
       JOIN PERIOD P
         ON SLP.PERIOD_SID = P.PERIOD_SID
       CROSS APPLY (SELECT DOLLARS,
                           P.PERIOD_SID
                    FROM   FORECASTING_MASTER FM
                           JOIN(SELECT FORECAST_NAME,
                                       [VERSION]
                                FROM   FILE_MANAGEMENT
                                WHERE  FROM_PERIOD <= Getdate()
                                       AND TO_PERIOD IS NULL)FT
                             ON FM.FORECAST_NAME = FT.FORECAST_NAME
                           JOIN PERIOD P
                             ON P.YEAR = FM.FORECAST_YEAR
                                AND P.MONTH = FORECAST_MONTH
                                AND P.PERIOD_SID = SLP.PERIOD_SID
                           JOIN ITEM_MASTER IM
                             ON FM.NDC = IM.ITEM_ID
                                AND IM.ITEM_MASTER_SID = CCP.ITEM_MASTER_SID
                    WHERE  FM.FORECAST_VER IN ( FT.VERSION, Floor(FT.VERSION) ))FM
WHERE  SLP.PROJECTION_DETAILS_SID IN ( ? )
       AND USER_ID = @USER_ID
       AND SESSION_ID = @SESSION_ID
       AND P.QUARTER = @QUARTER
       AND P.YEAR = @YEAR 



		]]>
         
        
    </sql>
    
    <sql id="Check GTS UNT Values">
        <![CDATA[
 DECLARE @QUARTER      INT=?,
        @YEAR         INT=?,
        @SESSION_ID   INT=?,
        @USER_ID      INT=?,
        @UPDATE_VALUE FLOAT=?

SELECT DISTINCT Isnull(Sum(FM.UNITS)
                         OVER (
                           PARTITION BY P.YEAR, P.QUARTER), 0) AS QUARTERLY_WAC
FROM   ST_NM_SALES_PROJECTION SLP
       JOIN PROJECTION_DETAILS PD
         ON SLP.PROJECTION_DETAILS_SID = PD.PROJECTION_DETAILS_SID
       JOIN CCP_DETAILS CCP
         ON CCP.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
       JOIN PERIOD P
         ON SLP.PERIOD_SID = P.PERIOD_SID
       CROSS APPLY (SELECT UNITS,
                           P.PERIOD_SID
                    FROM   FORECASTING_MASTER FM
                           JOIN(SELECT FORECAST_NAME,
                                       [VERSION]
                                FROM   FILE_MANAGEMENT
                                WHERE  FROM_PERIOD <= Getdate()
                                       AND TO_PERIOD IS NULL)FT
                             ON FM.FORECAST_NAME = FT.FORECAST_NAME
                           JOIN PERIOD P
                             ON P.YEAR = FM.FORECAST_YEAR
                                AND P.MONTH = FORECAST_MONTH
                                AND P.PERIOD_SID = SLP.PERIOD_SID
                           JOIN ITEM_MASTER IM
                             ON FM.NDC = IM.ITEM_ID
                                AND IM.ITEM_MASTER_SID = CCP.ITEM_MASTER_SID
                    WHERE  FM.FORECAST_VER IN ( FT.VERSION, Floor(FT.VERSION) ))FM
WHERE  SLP.PROJECTION_DETAILS_SID IN ( ? )
       AND USER_ID = @USER_ID
       AND SESSION_ID = @SESSION_ID
       AND P.QUARTER = @QUARTER
       AND P.YEAR = @YEAR 



		]]>
         
        
    </sql>
    
    <sql id="Get NDC Values">
        <![CDATA[
 SELECT distinct item.ITEM_NAME
FROM   PROJECTION_DETAILS PD
       JOIN CCP_DETAILS CCP
         ON PD.CCP_DETAILS_SID = CCP.CCP_DETAILS_SID
		 and PD.PROJECTION_DETAILS_SID in(?)
       JOIN ITEM_MASTER item
         ON CCP.ITEM_MASTER_SID = item.ITEM_MASTER_SID 
 


		]]>
         
        
    </sql>
    
    <sql id="PMPY-Load TP with CH Count">
        <![CDATA[
 SELECT  COUNT ( DISTINCT COMM.COMPANY_MASTER_SID )
FROM   CONTRACT_MASTER CONM
       JOIN CFP_CONTRACT_DETAILS CFP
         ON CONM.CONTRACT_MASTER_SID = CFP.CFP_CONTRACT_SID
            AND CONM.CONT_HOLD_COMPANY_MASTER_SID = ?
       JOIN COMPANY_MASTER COMM
         ON CFP.COMPANY_MASTER_SID = COMM.COMPANY_MASTER_SID
		 and COMM.COMPANY_NAME like '?'
		 and COMPANY_NO like '?'
       JOIN HELPER_TABLE HT
         ON COMM.COMPANY_TYPE != HT.HELPER_TABLE_SID
            AND HT.DESCRIPTION NOT IN ( 'manufacturer', 'BUNIT', 'Business Unit' )

		]]>
        
    </sql>
    <sql id="PMPY-Load TP without CH Count">
        <![CDATA[
 SELECT  COUNT ( DISTINCT COMM.COMPANY_MASTER_SID )
FROM   CONTRACT_MASTER CONM
       JOIN CFP_CONTRACT_DETAILS CFP
         ON CONM.CONTRACT_MASTER_SID = CFP.CFP_CONTRACT_SID
        
       JOIN COMPANY_MASTER COMM
         ON CFP.COMPANY_MASTER_SID = COMM.COMPANY_MASTER_SID
		 and COMM.COMPANY_NAME like '?'
		 and COMPANY_NO like '?'
       JOIN HELPER_TABLE HT
         ON COMM.COMPANY_TYPE != HT.HELPER_TABLE_SID
            AND HT.DESCRIPTION NOT IN ( 'manufacturer', 'BUNIT', 'Business Unit' )


		]]>
         
    </sql>
    
    <sql id="existingCAlendar">
        <![CDATA[
        SELECT SLA_CALENDAR_MASTER_SID,CALENDAR_NAME FROM dbo.SLA_CALENDAR_MASTER SCM
        WHERE SCM.CALENDAR_NAME LIKE '?' AND SCM.INBOUND_STATUS LIKE 'A'
        ]]>
    </sql>

</custom-sql>