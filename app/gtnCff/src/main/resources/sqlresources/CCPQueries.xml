<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->

<sql> 
    <entity id="selected-hierarchy-no">
        <query>
            <![CDATA[
                IF Object_id('TEMPDB..#SELECTED_HIERARCHY_NO') IS NOT NULL
                DROP TABLE #SELECTED_HIERARCHY_NO
                CREATE TABLE #SELECTED_HIERARCHY_NO (HIERARCHY_NO varchar(50),CCP_DETAILS_SID INT,INSTR INT)

                INSERT INTO #SELECTED_HIERARCHY_NO
                (HIERARCHY_NO,
                CCP_DETAILS_SID,INSTR)
                SELECT HIERARCHY_NO,CH.CCP_DETAILS_SID,INSTR
                FROM   (VALUES 	[?HIERARCHY_NO_VALUES])A(HIERARCHY_NO,INSTR)                
                [?SELECTED_HIERARCHY_JOIN]
            ]]>
        </query>
    </entity>
    
    <entity id="custom-view-count-query">
        <query>
            <![CDATA[    
                SELECT
                    COUNT(DISTINCT SHN.HIERARCHY_NO)
                FROM
                    #SELECTED_HIERARCHY_NO SHN;        
            ]]>
        </query>
    </entity>	
    
    <entity id="custom-view-hiearchy-no-query">
        <query>
            <![CDATA[    
                 SELECT 
                   HIERARCHY_NO 
                 FROM 
                   #SELECTED_HIERARCHY_NO
                 GROUP BY HIERARCHY_NO ORDER BY MIN([INSTR]) ASC
                 OFFSET [?START] ROWS FETCH NEXT [?END] ROWS ONLY;        
            ]]>
        </query>
    </entity>	
    
    <entity id="hiearchy-no-count-query">
        <query>
            <![CDATA[    
                IF Object_id('TEMPDB..#SELECTED_HIERARCHY_NO') IS NOT NULL
                DROP TABLE #SELECTED_HIERARCHY_NO
                CREATE TABLE #SELECTED_HIERARCHY_NO (HIERARCHY_NO varchar(50),INSTR INT,CCP_DETAILS_SID INT,RELATIONSHIP_LEVEL_VALUES VARCHAR(50))

                INSERT INTO #SELECTED_HIERARCHY_NO 
                (HIERARCHY_NO,INSTR,
                CCP_DETAILS_SID,RELATIONSHIP_LEVEL_VALUES)
                SELECT A.HIERARCHY_NO,INSTR,CH.CCP_DETAILS_SID,RELATIONSHIP_LEVEL_VALUES
                FROM   (VALUES [?HIERARCHY_NO_VALUES])A(HIERARCHY_NO,INSTR)
                JOIN ST_CCP_HIERARCHY CH ON CH.[?HIERARCHY_COLUMN] LIKE A.HIERARCHY_NO+'%'
                [?TAB_BASED_JOIN]

            ]]>
        </query>
    </entity>
    
    <entity id="hiearchy-no-query">
        <query>
            <![CDATA[    
                IF Object_id('TEMPDB..#SELECTED_HIERARCHY_NO') IS NOT NULL
                DROP TABLE #SELECTED_HIERARCHY_NO
                CREATE TABLE #SELECTED_HIERARCHY_NO (HIERARCHY_NO varchar(50),INSTR INT,CCP_DETAILS_SID INT,RELATIONSHIP_LEVEL_VALUES VARCHAR(50))

                INSERT INTO #SELECTED_HIERARCHY_NO 
                (HIERARCHY_NO,INSTR,
                CCP_DETAILS_SID,RELATIONSHIP_LEVEL_VALUES)
                SELECT A.HIERARCHY_NO,INSTR,CH.CCP_DETAILS_SID,RELATIONSHIP_LEVEL_VALUES
                FROM   (VALUES [?HIERARCHY_NO_VALUES])A(HIERARCHY_NO,INSTR)
                JOIN ST_CCP_HIERARCHY CH ON CH.[?HIERARCHY_COLUMN] LIKE A.HIERARCHY_NO+'%'
                [?TAB_BASED_JOIN]

            ]]>
        </query>
    </entity>	
     <entity id="Drop.DynamicTempTables">
        <query> 
            <![CDATA[
     DECLARE @SQL        VARCHAR(MAX)='',
        @USER    INT=@USER_ID,
        @SESSION VARCHAR(100)='@SESSION_ID'

SET @SQL = (SELECT Concat('DROP TABLE ', Quotename(Upper(NAME)), '; ')
            FROM   SYS.TABLES
            WHERE  NAME LIKE Concat('ST_%', @USER, '_', @SESSION, '_', Replace(CONVERT(VARCHAR(50), Getdate(), 2), '.', ''))
            FOR XML PATH (''))
--select @sql
EXEC( @SQL ) 
   ]]>
        </query> 
    </entity>
    
    <entity id="selected-hierarchy-no-for-custom">
        <query>
            <![CDATA[
                IF Object_id('TEMPDB..#SELECTED_HIERARCHY_NO') IS NOT NULL
                DROP TABLE #SELECTED_HIERARCHY_NO
                CREATE TABLE #SELECTED_HIERARCHY_NO (HIERARCHY_NO varchar(50),CCP_DETAILS_SID INT,INSTR INT,RELATIONSHIP_LEVEL_VALUES VARCHAR(50))

                INSERT INTO #SELECTED_HIERARCHY_NO
                (HIERARCHY_NO,
                CCP_DETAILS_SID,INSTR,RELATIONSHIP_LEVEL_VALUES)
                SELECT DISTINCT A.HIERARCHY_NO,CH.CCP_DETAILS_SID,INSTR,RELATIONSHIP_LEVEL_VALUES
                FROM   (VALUES 	[?HIERARCHY_NO_VALUES])A(HIERARCHY_NO,INSTR)                
                [?SELECTED_HIERARCHY_JOIN]
            ]]>
        </query>
    </entity>
    
    <entity id="PARENT-VALIDATE">
        <query>
            <![CDATA[
            
                  IF Object_id('TEMPDB..#PARENT_VALIDATE') IS NOT NULL DROP
	TABLE
		#PARENT_VALIDATE CREATE
			TABLE
				#PARENT_VALIDATE(
					RS_CONTRACT_SID INT,
					PARENT_HIERARCHY VARCHAR(MAX)
				) INSERT
					into
						#PARENT_VALIDATE(
							RS_CONTRACT_SID,
							PARENT_HIERARCHY
						) SELECT
							DISTINCT mas.RS_CONTRACT_SID,
							RLD.PARENT_HIERARCHY_NO
						FROM
							ST_CCP_DEDUCTION_HIERARCHY MAS
						JOIN RELATIONSHIP_LEVEL_DEFINITION RLD ON
							LEVEL_NO = 10
							AND relationship_builder_sid = @RELVALUE
							AND RLD.RELATIONSHIP_LEVEL_VALUES = MAS.RS_CONTRACT_SID
 
 
            ]]>
        </query>
    </entity> 
    <entity id="custom-view-condition-query">
        <query>
            <![CDATA[    
SELECT  convert(VARCHAR(8000),HIERARCHY_NO) HIERARCHY_NO  FROM (SELECT DISTINCT HIERARCHY_NO = STUFF((
			SELECT DISTINCT ', ' + HIERARCHY_NO
			FROM #SELECTED_HIERARCHY_NO B
			WHERE B.RELATIONSHIP_LEVEL_VALUES = A.RELATIONSHIP_LEVEL_VALUES
			FOR XML PATH('')
			), 1, 2, ''),INSTR
FROM #SELECTED_HIERARCHY_NO A
@RELJOIN )S
ORDER BY INSTR
                OFFSET [?START] ROWS FETCH NEXT [?END] ROWS ONLY;  
            ]]>
        </query>
        </entity>
        
         <entity id="get-ccp-query">
        <query>
            <![CDATA[  
            IF OBJECT_ID('TEMPDB..#SELECTED_HIERARCHY_NO_TEMP') IS NOT NULL
                 DROP TABLE #SELECTED_HIERARCHY_NO_TEMP  
      SELECT CCP_DETAILS_SID,CONVERT(VARCHAR(8000),HIERARCHY_NO) HIERARCHY_NO  INTO #SELECTED_HIERARCHY_NO_TEMP  FROM (SELECT CCP_DETAILS_SID,HIERARCHY_NO = STUFF((
			SELECT DISTINCT ', ' + HIERARCHY_NO
			FROM #SELECTED_HIERARCHY_NO B
			WHERE B.RELATIONSHIP_LEVEL_VALUES = A.RELATIONSHIP_LEVEL_VALUES
			FOR XML PATH('')
			), 1, 2, '')
FROM #SELECTED_HIERARCHY_NO A
@RELJOIN )S
            ]]>
        </query>
    </entity>
    
                <entity id="custom-view-count-condition-query">
        <query>
            <![CDATA[  
              SELECT COUNT(DISTINCT HIERARCHY_NO)   FROM (SELECT HIERARCHY_NO = STUFF((
			SELECT DISTINCT ', ' + HIERARCHY_NO
			FROM #SELECTED_HIERARCHY_NO B
			WHERE B.RELATIONSHIP_LEVEL_VALUES = A.RELATIONSHIP_LEVEL_VALUES
			FOR XML PATH('')
			), 1, 2, '')
FROM #SELECTED_HIERARCHY_NO A
@RELJOIN )S
            ]]>
        </query>
    </entity>		
</sql>
