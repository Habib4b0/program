IF EXISTS (SELECT 'X' 
           FROM   INFORMATION_SCHEMA.ROUTINES 
           WHERE  ROUTINE_NAME = 'PRC_CFF_RESULTS' 
                  AND ROUTINE_SCHEMA = 'DBO') 
  BEGIN 
      DROP PROCEDURE [DBO].[PRC_CFF_RESULTS] 
  END 

GO 

CREATE PROCEDURE [dbo].[PRC_CFF_RESULTS] (@CFF_MASTER_SID VARCHAR(100),
                                          @HIERARCHY_NO NVARCHAR(MAX),
		                                  @FREQUENCY VARCHAR(20),
		                                  @FROM_PERIOD_SID INT,
		                                  @END_PERIOD_SID INT,
                                          @USER_ID INT,
                                          @SESSION_ID VARCHAR(50),
		                                  @INDICATOR              CHAR(1),
		                                  @CUSTOM_VIEW_MASTER_SID INT=NULL,
		                                  @SALES_INCLUSION BIT,
		                                  @DEDUCTION_INCLUSION BIT  ) 


AS 
BEGIN 
SET NOCOUNT ON 

BEGIN TRY 		
		
DECLARE @CFF_PRODUCT           VARCHAR(200) = Concat ('ST_CFF_PRODUCT_LEVEL_FILES_DATA_', @USER_ID, '_', @SESSION_ID, '_', Replace(CONVERT(VARCHAR(50), Getdate(), 2), '.', '')),----Product Level data
        @CFF_COMP_PROD         VARCHAR(200) = Concat ('ST_CFF_COMP_PRD_LEVEL_FILES_DATA_', @USER_ID, '_', @SESSION_ID, '_', Replace(CONVERT(VARCHAR(50), Getdate(), 2), '.', '')),  ---- Comp+Prod data
		@CCP_HIERARCHY         VARCHAR(200) = Concat ('ST_CCP_HIERARCHY_', @USER_ID, '_', @SESSION_ID, '_', Replace(CONVERT(VARCHAR(50), Getdate(), 2), '.', '')), ---- ccp deatils information
		@CUSTOMER_CFF_SALES VARCHAR(200) = Concat('ST_CUSTOMER_CFF_SALES_', @USER_ID, '_', @SESSION_ID, '_', Replace(CONVERT(VARCHAR(50), Getdate(), 2), '.', '')),
		@PRODUCT_CFF_SALES VARCHAR(200) = Concat('ST_PRODUCT_CFF_SALES_', @USER_ID, '_', @SESSION_ID, '_', Replace(CONVERT(VARCHAR(50), Getdate(), 2), '.', '')),
		@CUSTOM_CFF_SALES VARCHAR(200) = Concat('ST_CUSTOM_CFF_SALES_', @USER_ID, '_', @SESSION_ID, '_', Replace(CONVERT(VARCHAR(50), Getdate(), 2), '.', '')),
		@CUSTOMER_CFF_DISCOUNT VARCHAR(200) = Concat('ST_CUSTOMER_CFF_DISCOUNT_', @USER_ID, '_', @SESSION_ID, '_', Replace(CONVERT(VARCHAR(50), Getdate(), 2), '.', '')),
		@PRODUCT_CFF_DISCOUNT VARCHAR(200) = Concat('ST_PRODUCT_CFF_DISCOUNT_', @USER_ID, '_', @SESSION_ID, '_', Replace(CONVERT(VARCHAR(50), Getdate(), 2), '.', '')),
		@CUSTOM_CFF_DISCOUNT VARCHAR(200) = Concat('ST_CUSTOM_CFF_DISCOUNT_', @USER_ID, '_', @SESSION_ID, '_', Replace(CONVERT(VARCHAR(50), Getdate(), 2), '.', '')),
		@CUSTOM_CCP_SALES VARCHAR(200) = CONCAT ('CUSTOM_CCP_SALES_',@CUSTOM_VIEW_MASTER_SID),
		@sales_table            VARCHAR(MAX),
        @discount_table         VARCHAR(200),
		@ROW_ID Nvarchar(max)='',
		@ROW_OP INT
		
 DECLARE @ACTUAL_START_DATE DATETIME = CAST(YEAR(GETDATE()) - 3 AS VARCHAR(4)) + '-01-01',
         @PROJ_END_PERIOD_DATE DATETIME	

SELECT TOP 1 @PROJ_END_PERIOD_DATE = DATEADD(DD, 1, EOMONTH(TO_DATE, - 1))
FROM FORECAST_CONFIG FA
LEFT JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID = FA.BUSINESS_PROCESS_TYPE
WHERE [DESCRIPTION] = 'CONSOLIDATED FINANCIAL FORECAST'
ORDER BY VERSION_NO DESC

 set @FROM_PERIOD_SID  = (
		SELECT PERIOD_SID
		FROM PERIOD
		WHERE PERIOD_DATE = @ACTUAL_START_DATE
		)
		
set @END_PERIOD_SID  = (
		SELECT PERIOD_SID
		FROM PERIOD
		WHERE PERIOD_DATE = @PROJ_END_PERIOD_DATE
		)		
declare @END_SALES_SID int = (
		SELECT PERIOD_SID
		FROM PERIOD
		WHERE PERIOD_DATE = DATEADD(MM, - 3, DATEADD(QQ, DATEDIFF(QQ, 0, GETDATE()), 0))
		)				 
-----------------PERIOD CONVERISON--------------------
IF Object_id('TEMPDB.DBO.#PERIOD', 'U') IS NOT NULL
	DROP TABLE #PERIOD;

SELECT PERIOD_SID,
	YEAR,
	CASE 
		WHEN LEFT(@FREQUENCY, 1) = 'M'
			THEN MONTH
		WHEN LEFT(@FREQUENCY, 1) = 'Q'
			THEN QUARTER
		WHEN LEFT(@FREQUENCY, 1) = 'S'
			THEN SEMI_ANNUAL
		ELSE 1
		END AS PERIOD
INTO #PERIOD
FROM PERIOD
WHERE PERIOD_SID BETWEEN @FROM_PERIOD_SID
		AND @END_PERIOD_SID

DECLARE @SP INT
	,@SP_PROJ_SID INT
	,@TEMP_PROJ_SID VARCHAR(500)
	,@FIRST_PROJ_SID INT

 IF OBJECT_ID('TEMPDB..#CFF_PROJECTION_MASTER') IS NOT NULL 
            DROP TABLE #CFF_PROJECTION_MASTER 


	CREATE TABLE #CFF_PROJECTION_MASTER (
		ID INT IDENTITY(1, 1),
		CFF_MASTER_SID INT
		)

SET @TEMP_PROJ_SID = REPLACE(@CFF_MASTER_SID + ',', ',,', ',')

WHILE PATINDEX('%,%', @TEMP_PROJ_SID) <> 0
BEGIN
	SELECT @SP = PATINDEX('%,%', @TEMP_PROJ_SID)

	SELECT @SP_PROJ_SID = LEFT(@TEMP_PROJ_SID, @SP - 1)

	SELECT @TEMP_PROJ_SID = STUFF(@TEMP_PROJ_SID, 1, @SP, '')

	INSERT INTO #CFF_PROJECTION_MASTER (CFF_MASTER_SID)
	SELECT @SP_PROJ_SID
END

SELECT @FIRST_PROJ_SID = PM.CFF_MASTER_SID
FROM #CFF_PROJECTION_MASTER PM
WHERE ID = 1


--------------------TAKING TABLES BASED ON VIEW STARTS HERE
 IF @indicator = 'c'
            BEGIN
                SET @sales_table=@CUSTOMER_CFF_SALES
                SET @discount_table=@CUSTOMER_CFF_DISCOUNT
            END
          ELSE IF @indicator = 'P'
            BEGIN
                SET @sales_table=@PRODUCT_CFF_SALES
                SET @discount_table=@PRODUCT_CFF_DISCOUNT
            END
          ELSE IF @indicator NOT IN ( 'c', 'p' )
            BEGIN
                SET @sales_table=@CUSTOM_CFF_SALES
                SET @discount_table=@CUSTOM_CFF_DISCOUNT
            END


  IF Object_id('TEMPDB..#CUSTOMER_DETAILS_TEMP') IS NOT NULL 
            DROP TABLE #CUSTOMER_DETAILS_TEMP
CREATE TABLE #CUSTOMER_DETAILS_TEMP
( 
COMPANY_MASTER_SID  INT,
ITEM_MASTER_SID     INT,
HIERARCHY_NO        VARCHAR(8000),ROW_ID int
)


 DECLARE @SQL_C NVARCHAR(MAX)

IF @indicator IN ( 'c', 'p' )
            BEGIN
			if nullif(@HIERARCHY_NO,'') is not null
			begin
SET @SQL_C = CONCAT('INSERT INTO #CUSTOMER_DETAILS_TEMP (
	COMPANY_MASTER_SID
	,ITEM_MASTER_SID
	 ,HIERARCHY_NO
	)
SELECT DISTINCT 
	 COMPANY_MASTER_SID
	,ITEM_MASTER_SID,
	''',@HIERARCHY_NO, ''' 
FROM ', @CCP_HIERARCHY, ' CH
JOIN CCP_DETAILS CD ON CH.CCP_DETAILS_SID = CD.CCP_DETAILS_SID
 WHERE ', CASE @indicator
                                         WHEN 'C' THEN 'ch.CUST_HIERARCHY_NO'
                                         WHEN 'P' THEN 'ch.PROD_HIERARCHY_NO'
                                       END, ' like ''',@HIERARCHY_NO, ''' +''%''')
									   end
									   else 
begin
SET @SQL_C = CONCAT('INSERT INTO #CUSTOMER_DETAILS_TEMP (
	COMPANY_MASTER_SID
	,ITEM_MASTER_SID
	 ,HIERARCHY_NO
	)
SELECT DISTINCT 
	 COMPANY_MASTER_SID
	,ITEM_MASTER_SID,
	',CASE @indicator
                                         WHEN 'C' THEN 'substring(ch.CUST_HIERARCHY_NO,1,charindex(''-'',ch.CUST_HIERARCHY_NO,1)-1)'
                                         WHEN 'P' THEN 'substring(ch.PROD_HIERARCHY_NO,1,charindex(''-'',ch.PROD_HIERARCHY_NO,1)-1) '
                                       END, ' 
FROM ', @CCP_HIERARCHY, ' CH
JOIN CCP_DETAILS CD ON CH.CCP_DETAILS_SID = CD.CCP_DETAILS_SID')
									   end
									  
		EXEC Sp_executesql @SQL_C

	END




 IF @indicator NOT IN ( 'c', 'p' )
            BEGIN
                SET @SQL_C = Concat('INSERT INTO #CUSTOMER_DETAILS_TEMP (
	COMPANY_MASTER_SID
	,ITEM_MASTER_SID,
     HIERARCHY_NO,row_id
	)
SELECT DISTINCT 
	 COMPANY_MASTER_SID
	,ITEM_MASTER_SID
	 ,c.HIERARCHY_NO
	,rowid 
FROM ',@CUSTOM_CCP_SALES,' C
                  join ', @CCP_HIERARCHY, ' ch
                     on  ch.CCP_DETAILS_SID = c.CCP_DETAILS_SID
JOIN CCP_DETAILS CD ON CH.CCP_DETAILS_SID = CD.CCP_DETAILS_SID

',case when nullif(@HIERARCHY_NO,'') is not null then concat('		WHERE HIERARCHY_NO  = ''',@HIERARCHY_NO, '''')
else ' WHERE LEVEL_NO=1' end
,'
AND  C.CUST_VIEW_MASTER_SID= ', @CUSTOM_VIEW_MASTER_SID, '  
 ')
          
                EXEC Sp_executesql @SQL_C

                 
            END

 
 
-----------------Taking file Values including Prior CFF'S

DECLARE @SQL_PRO NVARCHAR(MAX)
IF OBJECT_ID('TEMPDB..#PRODUCT_FILE_DATA') IS NOT NULL
DROP TABLE #PRODUCT_FILE_DATA
CREATE TABLE #PRODUCT_FILE_DATA
(
CFF_MASTER_SID INT,
HIERARCHY_NO VARCHAR(8000),
ROW_ID INT,
YEAR INT,
PERIOD SMALLINT,
EX_FACTORY_SALES NUMERIC(22,6),
DEMAND_SALES NUMERIC(22,6),
ADJUSTED_DEMAND  NUMERIC(22,6),
IW_MASTER NUMERIC(22,6),
INDICATOR BIT
)

SET @SQL_PRO=CONCAT('
INSERT INTO #PRODUCT_FILE_DATA (CFF_MASTER_SID,HIERARCHY_NO,ROW_ID,YEAR,PERIOD,EX_FACTORY_SALES,DEMAND_SALES,
ADJUSTED_DEMAND,IW_MASTER,INDICATOR)
SELECT      
            CF.CFF_MASTER_SID
			,PRO.HIERARCHY_NO
			,PRO.ROW_ID
            ,YEAR
			,PERIOD
			,SUM(EX_FACTORY_SALES_ACTUALS) AS EX_FACTORY_SALES
			,SUM(DEMAND_SALES_ACTUALS) AS DEMAND_SALES
			,SUM(ADJUSTED_DEMAND_ACTUALS) AS ADJUSTED_DEMAND
			,SUM(IW_MASTER_ACTUALS) AS IW_MASTER
			,0 AS INDICATOR
		FROM  #CFF_PROJECTION_MASTER CFM 
	    CROSS JOIN (SELECT DISTINCT ITEM_MASTER_SID,HIERARCHY_NO,ROW_ID FROM #CUSTOMER_DETAILS_TEMP) PRO
		CROSS JOIN #PERIOD P 
		LEFT JOIN ', @CFF_PRODUCT ,' CF ON CF.CFF_MASTER_SID=CFM.CFF_MASTER_SID 
		AND P.PERIOD_SID = CF.PERIOD_SID AND CF.ITEM_MASTER_SID=PRO.ITEM_MASTER_SID
		where CFm.CFF_MASTER_SID = ', @FIRST_PROJ_SID ,' and p.period_sid < ',@END_SALES_SID,'
		GROUP BY YEAR
			,PERIOD
			,cf.CFF_MASTER_SID
			,PRO.HIERARCHY_NO
			,PRO.ROW_ID
  UNION ALL

  SELECT    CF.CFF_MASTER_SID
            ,PRO.HIERARCHY_NO
			,PRO.ROW_ID
            ,YEAR
			,PERIOD
			,SUM(EX_FACTORY_SALES_PROJ) AS EX_FACTORY_SALES
			,SUM(DEMAND_SALES_PROJ) AS DEMAND_SALES
			,SUM(ADJUSTED_DEMAND_PROJ) AS ADJUSTED_DEMAND
			,SUM(IW_MASTER_PROJ) AS IW_MASTER
			, 1 AS INDICATOR
		FROM #CFF_PROJECTION_MASTER CFM 
	    CROSS JOIN (SELECT DISTINCT ITEM_MASTER_SID,HIERARCHY_NO,ROW_ID FROM #CUSTOMER_DETAILS_TEMP) PRO
		CROSS JOIN #PERIOD P 
		LEFT JOIN ', @CFF_PRODUCT ,' CF ON CF.CFF_MASTER_SID=CFM.CFF_MASTER_SID AND P.PERIOD_SID = CF.PERIOD_SID 
		AND CF.ITEM_MASTER_SID=PRO.ITEM_MASTER_SID
		GROUP BY YEAR
			,PERIOD
			,CF.CFF_MASTER_SID
			,PRO.HIERARCHY_NO
			,PRO.ROW_ID')
			--select @SQL_PRO
			EXEC Sp_executesql @SQL_PRO
			--select @SQL_PRO
 
			

DECLARE @SQL_COMP NVARCHAR(MAX)

IF OBJECT_ID('TEMPDB..#COMP_PRODUCT_FILE_DATA') IS NOT NULL
DROP TABLE #COMP_PRODUCT_FILE_DATA
CREATE TABLE #COMP_PRODUCT_FILE_DATA
(
CFF_MASTER_SID INT,
HIERARCHY_NO VARCHAR(8000),
ROW_ID INT,
YEAR INT,
PERIOD SMALLINT,
CUST_EX_FACTORY_SALES NUMERIC(22,6),
IW_DETAILS NUMERIC(22,6),
INDICATOR BIT
)
SET @SQL_COMP= CONCAT('
INSERT INTO #COMP_PRODUCT_FILE_DATA (CFF_MASTER_SID,HIERARCHY_NO,ROW_ID,YEAR,PERIOD,CUST_EX_FACTORY_SALES,
IW_DETAILS,INDICATOR)
SELECT      CF.CFF_MASTER_SID
            ,COMP.HIERARCHY_NO
			,COMP.ROW_ID
            ,YEAR
			,PERIOD
			,SUM(CUST_EX_FACTORY_SALES_ACTUALS) AS CUST_EX_FACTORY_SALES
			,SUM(IW_DETAILS_ACTUALS) AS IW_DETAILS
			,0 AS INDICATOR
		FROM ', @CFF_COMP_PROD ,' CF
		INNER JOIN #PERIOD P ON P.PERIOD_SID = CF.PERIOD_SID
		INNER JOIN #CFF_PROJECTION_MASTER CFM ON CF.CFF_MASTER_SID=CFM.CFF_MASTER_SID 
		INNER JOIN #CUSTOMER_DETAILS_TEMP COMP ON CF.COMPANY_MASTER_SID=COMP.COMPANY_MASTER_SID
		AND CF.ITEM_MASTER_SID=COMP.ITEM_MASTER_SID
		where CFm.CFF_MASTER_SID = ', @FIRST_PROJ_SID ,' and p.period_sid<',@END_SALES_SID,'
		GROUP BY YEAR
			,PERIOD
			,CF.CFF_MASTER_SID
			,COMP.HIERARCHY_NO
			,COMP.ROW_ID
UNION ALL
SELECT      CF.CFF_MASTER_SID
            ,COMP.HIERARCHY_NO
			,COMP.ROW_ID
            ,YEAR
			,PERIOD
			,SUM(CUST_EX_FACTORY_SALES_PROJ) AS CUST_EX_FACTORY_SALES
			,SUM(IW_DETAILS_PROJ) AS IW_DETAILS
			, 1 AS INDICATOR
		FROM ', @CFF_COMP_PROD ,' CF
		INNER JOIN #PERIOD P ON P.PERIOD_SID = CF.PERIOD_SID
		INNER JOIN #CFF_PROJECTION_MASTER CFM ON CF.CFF_MASTER_SID=CFM.CFF_MASTER_SID
		INNER JOIN #CUSTOMER_DETAILS_TEMP COMP ON CF.COMPANY_MASTER_SID=COMP.COMPANY_MASTER_SID
		AND CF.ITEM_MASTER_SID=COMP.ITEM_MASTER_SID
		GROUP BY YEAR
			,PERIOD
			,CF.CFF_MASTER_SID
			,COMP.HIERARCHY_NO
			,COMP.ROW_ID')


			EXEC Sp_executesql @SQL_COMP




IF @INDICATOR IN ('C','P')
BEGIN

DECLARE @SQL_OUT NVARCHAR(MAX)
--product_cff_discount
SET @SQL_OUT=CONCAT('
	SELECT 
	     S.CFF_MASTER_SID
		,ISNULL(SUM(PFD.EX_FACTORY_SALES), 0) AS EX_FACTORY_SALES
		,S.YEAR
		,S.PERIOD
		,ISNULL(SUM(S.SALES),0) AS CONTRACT_SALES
		,ISNULL(SUM(S.UNITS),0) AS CONTRACT_UNITS
		,ISNULL(SUM(ND.DISCOUNT),0) + ISNULL(SUM(MD.DISCOUNT), 0) + ISNULL(SUM(SPD.DISCOUNT), 0) AS TOTAL_DISCOUNT
		,ISNULL((SUM(ND.DISCOUNT) + ISNULL(SUM(MD.DISCOUNT), 0) + ISNULL(SUM(SPD.DISCOUNT), 0)) / NULLIF(SUM(S.SALES), 0), 0) * 100 AS TOTAL_DISCOUNT_PERCENTAGE
		,(ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.EX_FACTORY_SALES), 0), 0)) * 100 AS EX_FACTORY_SALES_PERCENT
		,ISNULL(0, 0) AS PPA_DISCOUNT
		,ISNULL(0 / NULLIF(SUM(S.SALES), 0), 0) * 100 AS PPA_DISCOUNT_PERCENTAGE
		,ISNULL(0 / NULLIF(SUM(S.SALES), 0), 0) * 100 AS PPA_DISCOUNT_PROJECTED_PERCENTAGE
	    ,ISNULL(SUM(MD.DISCOUNT), 0) AS MANDATED_DISCOUNT
		,ISNULL(SUM(SPD.DISCOUNT), 0) AS SUPPLEMENTAL_DISCOUNT
        ,COALESCE(ISNULL(SUM(MD.DISCOUNT),0) / NULLIF(SUM(S.SALES), 0), 0) * 100 AS MANDATED_DISCOUNT_PERCENTAGE
		,COALESCE(ISNULL(SUM(SPD.DISCOUNT), 0) / NULLIF(SUM(S.SALES), 0), 0) * 100 AS SUPPLEMENTAL_DISCOUNT_PERCENTAGE
		,ISNULL(SUM(S.SALES) - (SUM(ND.DISCOUNT) + SUM(MD.DISCOUNT) + SUM(SPD.DISCOUNT)), 0) AS NET_SALES
		,ISNULL(SUM(PFD.DEMAND_SALES), 0) AS DEMAND_SALES
		,ISNULL(SUM(PFD.IW_MASTER), 0) AS INVENTORY_WITHDRAWAL
		,(ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.DEMAND_SALES), 0), 0)) * 100 AS DEMAND_SALES_PERCENT
		,(ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.IW_MASTER), 0), 0)) * 100 AS INVENTORY_WITHDRAWAL_SALES_PERCENT
		,(ISNULL(SUM(ND.DISCOUNT) / NULLIF(SUM(S.UNITS), 0), 0)) AS TOTAL_DISCOUNT_RPU
		,(ISNULL(0 / NULLIF(SUM(S.UNITS), 0), 0)) AS TOTAL_PPA_RPU
		,ISNULL((SUM(ND.DISCOUNT) +  ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)) / NULLIF(SUM(S.UNITS), 0), 0) AS TOTAL_RPU
		,ISNULL(SUM(S.COGS_VALUE), 0) AS COGS_VALUE
		,ISNULL(((SUM(S.SALES) - (ISNULL(SUM(ND.DISCOUNT),0) +  ISNULL(SUM(SPD.DISCOUNT),0) + ISNULL(SUM(MD.DISCOUNT),0))) - (ISNULL(SUM(S.COGS_VALUE), 0))), 0) AS NET_PROFIT
		,ISNULL(SUM(PFD.ADJUSTED_DEMAND), 0) AS ADJUSTED_DEMAND
		,ISNULL(SUM(CPFD.CUST_EX_FACTORY_SALES), 0) AS CUST_EX_FACTORY_SALES
		,ISNULL(SUM(CPFD.IW_DETAILS), 0) AS IW_DETAILS
		,ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.ADJUSTED_DEMAND), 0), 0) * 100 AS ADJUSTED_DEMAND_PERCENTAGE
		,ISNULL(SUM(S.SALES) / NULLIF(SUM(CPFD.CUST_EX_FACTORY_SALES), 0), 0) * 100 AS CUST_EX_FACTORY_SALES_PERCENTAGE
		,ISNULL(SUM(S.SALES) / NULLIF(SUM(CPFD.IW_DETAILS), 0), 0) * 100 AS IW_DETAILS_PERCENTAGE
		,coalesce(((ISNULL(SUM(S.SALES) - (ISNULL(SUM(ND.DISCOUNT),0)  + ISNULL(SUM(SPD.DISCOUNT),0) + ISNULL(SUM(MD.DISCOUNT),0)), 0)) / NULLIF(SUM(pfd.EX_FACTORY_SALES), 0)) * 100, 0) AS NET_SALES_OF_EX_FACTORY
		,isnull(((SUM(ND.DISCOUNT)  + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)) / NULLIF(SUM(pfd.EX_FACTORY_SALES), 0)) * 100, 0) AS DISCOUNT_OF_EX_FACTORY
        ,ISNULL(SUM(PFD.EX_FACTORY_SALES), 0) - ISNULL((SUM(ND.DISCOUNT) + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)), 0) AS NET_EXFACTORY_SALES
		,ISNULL(((ISNULL(SUM(PFD.EX_FACTORY_SALES), 0) - ISNULL((SUM(ND.SALES)  + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)), 0)) / NULLIF(SUM(PFD.EX_FACTORY_SALES), 0)), 0) * 100 AS NET_EXFACTORY_SALES_PERCENT
		,ISNULL(SUM(ND.ACCRUALS),0) TOTAL_DISCOUNT_ACCRUAL
		, 0 AS INDICATOR
	FROM (select  ''',@HIERARCHY_NO,''' HIERARCHY_NO,A.PERIOD,A.YEAR,sum(A.SALES) SALES ,sum(A.UNITS) UNITS,
	A.CFF_MASTER_SID,SUM(A.COGS_VALUE) COGS_VALUE from ', @sales_table ,' A
	JOIN #PERIOD P ON P.PERIOD=A.PERIOD AND P.YEAR=A.YEAR
	where a.HIERARCHY_NO like ''',@HIERARCHY_NO,'''+''%''
	AND A.INDICATOR=0
	AND (SALES_INCLUSION = @SALES_INCLUSION  OR @SALES_INCLUSION IS NULL) AND A.FILTER_CCP = 1
	group by A.PERIOD,A.YEAR,A.CFF_MASTER_SID
	) S
	INNER JOIN #CFF_PROJECTION_MASTER CFM ON S.CFF_MASTER_SID=CFM.CFF_MASTER_SID AND S.CFF_MASTER_SID = ', @FIRST_PROJ_SID ,'
	LEFT JOIN #PRODUCT_FILE_DATA PFD 
	ON PFD.PERIOD = S.PERIOD AND S.YEAR = PFD.YEAR AND S.CFF_MASTER_SID = PFD.CFF_MASTER_SID 
	AND S.HIERARCHY_NO = PFD.HIERARCHY_NO  AND PFD.INDICATOR=0
	LEFT JOIN #COMP_PRODUCT_FILE_DATA CPFD 
	ON CPFD.PERIOD = S.PERIOD AND S.YEAR = CPFD.YEAR AND S.CFF_MASTER_SID = CPFD.CFF_MASTER_SID 
	AND S.HIERARCHY_NO = CPFD.HIERARCHY_NO AND CPFD.INDICATOR=0
	LEFT JOIN (SELECT ''',@HIERARCHY_NO,''' HIERARCHY_NO,ND.PERIOD,ND.YEAR,SUM(ND.SALES) SALES,SUM(ND.UNITS) AS UNITS,
	ND.CFF_MASTER_SID,SUM(ND.ACCRUALS) AS ACCRUALS,SUM(ND.DISCOUNT) AS DISCOUNT  FROM  ' , @discount_table ,' ND
	WHERE ND.HIERARCHY_NO like ''',@HIERARCHY_NO,'''+''%'' AND ND.INDICATOR=0 AND ND.DISCOUNT_TYPE=0
	 AND (ND.DEDUCTION_INCLUSION = @DEDUCTION_INCLUSION  OR @DEDUCTION_INCLUSION IS NULL) AND ND.FILTER_CCP = 1
	 GROUP BY ND.PERIOD,ND.YEAR,ND.CFF_MASTER_SID ) ND
	ON ND.PERIOD = S.PERIOD AND S.YEAR = ND.YEAR AND S.CFF_MASTER_SID = ND.CFF_MASTER_SID AND S.HIERARCHY_NO=ND.HIERARCHY_NO 
	LEFT JOIN (SELECT ''',@HIERARCHY_NO,''' HIERARCHY_NO,MD.PERIOD,MD.YEAR,SUM(MD.SALES) SALES,SUM(MD.UNITS) AS UNITS,
	MD.CFF_MASTER_SID,SUM(MD.ACCRUALS) AS ACCRUALS,SUM(MD.DISCOUNT) AS DISCOUNT FROM  ' , @discount_table ,' MD
	WHERE MD.HIERARCHY_NO like ''',@HIERARCHY_NO,'''+''%'' AND MD.INDICATOR=0 AND MD.DISCOUNT_TYPE=1
	 AND (MD.DEDUCTION_INCLUSION = @DEDUCTION_INCLUSION  OR @DEDUCTION_INCLUSION IS NULL) AND MD.FILTER_CCP = 1
	 GROUP BY MD.PERIOD,MD.YEAR,MD.CFF_MASTER_SID ) MD
	ON MD.PERIOD = S.PERIOD AND S.YEAR = MD.YEAR AND S.CFF_MASTER_SID = MD.CFF_MASTER_SID AND S.HIERARCHY_NO = MD.HIERARCHY_NO 
	LEFT JOIN (SELECT ''',@HIERARCHY_NO,''' HIERARCHY_NO,SPD.PERIOD,SPD.YEAR,SUM(SPD.SALES) SALES,SUM(SPD.UNITS) AS UNITS,
	SPD.CFF_MASTER_SID,SUM(SPD.ACCRUALS) AS ACCRUALS,SUM(SPD.DISCOUNT) AS DISCOUNT FROM  ' , @discount_table ,' SPD
	WHERE SPD.HIERARCHY_NO like ''',@HIERARCHY_NO,'''+''%'' AND SPD.INDICATOR=0 AND SPD.DISCOUNT_TYPE=2
	 AND (SPD.DEDUCTION_INCLUSION = @DEDUCTION_INCLUSION  OR @DEDUCTION_INCLUSION IS NULL) AND SPD.FILTER_CCP = 1
	 GROUP BY SPD.PERIOD,SPD.YEAR,SPD.CFF_MASTER_SID ) SPD
	ON SPD.PERIOD = S.PERIOD AND S.YEAR = SPD.YEAR AND S.CFF_MASTER_SID = SPD.CFF_MASTER_SID AND S.HIERARCHY_NO = SPD.HIERARCHY_NO
	GROUP BY S.CFF_MASTER_SID,
	         S.YEAR,
			 S.PERIOD

	UNION ALL
	
	SELECT 
	     S.CFF_MASTER_SID
		,ISNULL(SUM(PFD.EX_FACTORY_SALES), 0) AS EX_FACTORY_SALES
		,S.YEAR
		,S.PERIOD
		,ISNULL(SUM(S.SALES),0) AS CONTRACT_SALES
		,ISNULL(SUM(S.UNITS),0) AS CONTRACT_UNITS
		,ISNULL(SUM(ND.DISCOUNT),0) + ISNULL(SUM(MD.DISCOUNT), 0) + ISNULL(SUM(SPD.DISCOUNT), 0) AS TOTAL_DISCOUNT
		,ISNULL((SUM(ND.DISCOUNT) + ISNULL(SUM(MD.DISCOUNT), 0) + ISNULL(SUM(SPD.DISCOUNT), 0)) / NULLIF(SUM(S.SALES), 0), 0) * 100 AS TOTAL_DISCOUNT_PERCENTAGE
		,(ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.EX_FACTORY_SALES), 0), 0)) * 100 AS EX_FACTORY_SALES_PERCENT
		,ISNULL(0, 0) AS PPA_DISCOUNT
		,ISNULL(0 / NULLIF(SUM(S.SALES), 0), 0) * 100 AS PPA_DISCOUNT_PERCENTAGE
		,ISNULL(0 / NULLIF(SUM(S.SALES), 0), 0) * 100 AS PPA_DISCOUNT_PROJECTED_PERCENTAGE
	    ,ISNULL(SUM(MD.DISCOUNT), 0) AS MANDATED_DISCOUNT
		,ISNULL(SUM(SPD.DISCOUNT), 0) AS SUPPLEMENTAL_DISCOUNT
		,COALESCE(ISNULL(SUM(MD.DISCOUNT),0) / NULLIF(SUM(S.SALES), 0), 0) * 100 AS MANDATED_DISCOUNT_PERCENTAGE
		,COALESCE(ISNULL(SUM(SPD.DISCOUNT), 0) / NULLIF(SUM(S.SALES), 0), 0) * 100 AS SUPPLEMENTAL_DISCOUNT_PERCENTAGE
		,ISNULL(SUM(S.SALES) - (SUM(ND.DISCOUNT) + SUM(MD.DISCOUNT) + SUM(SPD.DISCOUNT)), 0) AS NET_SALES
		,ISNULL(SUM(PFD.DEMAND_SALES), 0) AS DEMAND_SALES
		,ISNULL(SUM(PFD.IW_MASTER), 0) AS INVENTORY_WITHDRAWAL
		,(ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.DEMAND_SALES), 0), 0)) * 100 AS DEMAND_SALES_PERCENT
		,(ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.IW_MASTER), 0), 0)) * 100 AS INVENTORY_WITHDRAWAL_SALES_PERCENT
		,(ISNULL(SUM(ND.DISCOUNT) / NULLIF(SUM(S.UNITS), 0), 0)) AS TOTAL_DISCOUNT_RPU
		,(ISNULL(0 / NULLIF(SUM(S.UNITS), 0), 0)) AS TOTAL_PPA_RPU
		,ISNULL((SUM(ND.DISCOUNT) +  ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)) / NULLIF(SUM(S.UNITS), 0), 0) AS TOTAL_RPU
		,ISNULL(SUM(S.COGS_VALUE), 0) AS COGS_VALUE
		,ISNULL(((SUM(S.SALES) - (ISNULL(SUM(ND.DISCOUNT),0) +  ISNULL(SUM(SPD.DISCOUNT),0) + ISNULL(SUM(MD.DISCOUNT),0))) - (ISNULL(SUM(S.COGS_VALUE), 0))), 0) AS NET_PROFIT
	    ,ISNULL(SUM(PFD.ADJUSTED_DEMAND), 0) AS ADJUSTED_DEMAND
		,ISNULL(SUM(CPFD.CUST_EX_FACTORY_SALES), 0) AS CUST_EX_FACTORY_SALES
		,ISNULL(SUM(CPFD.IW_DETAILS), 0) AS IW_DETAILS
		,ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.ADJUSTED_DEMAND), 0), 0) * 100 AS ADJUSTED_DEMAND_PERCENTAGE
		,ISNULL(SUM(S.SALES) / NULLIF(SUM(CPFD.CUST_EX_FACTORY_SALES), 0), 0) * 100 AS CUST_EX_FACTORY_SALES_PERCENTAGE
		,ISNULL(SUM(S.SALES) / NULLIF(SUM(CPFD.IW_DETAILS), 0), 0) * 100 AS IW_DETAILS_PERCENTAGE
		,coalesce(((ISNULL(SUM(S.SALES) - (ISNULL(SUM(ND.DISCOUNT),0)  + ISNULL(SUM(SPD.DISCOUNT),0) + ISNULL(SUM(MD.DISCOUNT),0)), 0)) / NULLIF(SUM(pfd.EX_FACTORY_SALES), 0)) * 100, 0) AS NET_SALES_OF_EX_FACTORY
		,isnull(((SUM(ND.DISCOUNT)  + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)) / NULLIF(SUM(pfd.EX_FACTORY_SALES), 0)) * 100, 0) AS DISCOUNT_OF_EX_FACTORY
		,ISNULL(SUM(PFD.EX_FACTORY_SALES), 0) - ISNULL((SUM(ND.DISCOUNT) + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)), 0) AS NET_EXFACTORY_SALES
		,ISNULL(((ISNULL(SUM(PFD.EX_FACTORY_SALES), 0) - ISNULL((SUM(ND.SALES)  + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)), 0)) / NULLIF(SUM(PFD.EX_FACTORY_SALES), 0)), 0) * 100 AS NET_EXFACTORY_SALES_PERCENT
		,ISNULL(SUM(ND.ACCRUALS),0) TOTAL_DISCOUNT_ACCRUAL
		, 1 AS INDICATOR
	FROM (select  ''',@HIERARCHY_NO,''' HIERARCHY_NO,A.PERIOD,A.YEAR,sum(A.SALES) SALES ,sum(A.UNITS) UNITS,
	A.CFF_MASTER_SID,SUM(A.COGS_VALUE) COGS_VALUE from ', @sales_table ,' A
	JOIN #PERIOD P ON P.PERIOD=A.PERIOD AND P.YEAR=A.YEAR
	where a.HIERARCHY_NO like ''',@HIERARCHY_NO,'''+''%''
	AND A.INDICATOR=1
	AND (SALES_INCLUSION = @SALES_INCLUSION  OR @SALES_INCLUSION IS NULL) AND A.FILTER_CCP = 1
	group by A.PERIOD,A.YEAR,A.CFF_MASTER_SID
	) S
	INNER JOIN #CFF_PROJECTION_MASTER CFM ON S.CFF_MASTER_SID=CFM.CFF_MASTER_SID 
	LEFT JOIN #PRODUCT_FILE_DATA PFD 
	ON PFD.PERIOD = S.PERIOD AND S.YEAR = PFD.YEAR AND S.CFF_MASTER_SID = PFD.CFF_MASTER_SID 
	AND S.HIERARCHY_NO = PFD.HIERARCHY_NO  AND PFD.INDICATOR=1
	LEFT JOIN #COMP_PRODUCT_FILE_DATA CPFD 
	ON CPFD.PERIOD = S.PERIOD AND S.YEAR = CPFD.YEAR AND S.CFF_MASTER_SID = CPFD.CFF_MASTER_SID 
	AND S.HIERARCHY_NO = CPFD.HIERARCHY_NO AND CPFD.INDICATOR=1
	LEFT JOIN (SELECT ''',@HIERARCHY_NO,''' HIERARCHY_NO,ND.PERIOD,ND.YEAR,SUM(ND.SALES) SALES,SUM(ND.UNITS) AS UNITS,
	ND.CFF_MASTER_SID,SUM(ND.ACCRUALS) AS ACCRUALS,SUM(ND.DISCOUNT) AS DISCOUNT FROM  ' , @discount_table ,' ND
	WHERE ND.HIERARCHY_NO like ''',@HIERARCHY_NO,'''+''%'' AND ND.INDICATOR=1 AND ND.DISCOUNT_TYPE=0
	 AND (ND.DEDUCTION_INCLUSION = @DEDUCTION_INCLUSION  OR @DEDUCTION_INCLUSION IS NULL) AND ND.FILTER_CCP = 1
	 GROUP BY ND.PERIOD,ND.YEAR,ND.CFF_MASTER_SID ) ND
	ON ND.PERIOD = S.PERIOD AND S.YEAR = ND.YEAR AND S.CFF_MASTER_SID = ND.CFF_MASTER_SID AND S.HIERARCHY_NO=ND.HIERARCHY_NO 
	LEFT JOIN (SELECT ''',@HIERARCHY_NO,''' HIERARCHY_NO,MD.PERIOD,MD.YEAR,SUM(MD.SALES) SALES,SUM(MD.UNITS) AS UNITS,
	MD.CFF_MASTER_SID,SUM(MD.ACCRUALS) AS ACCRUALS,SUM(MD.DISCOUNT) AS DISCOUNT FROM  ' , @discount_table ,' MD
	WHERE MD.HIERARCHY_NO like ''',@HIERARCHY_NO,'''+''%'' AND MD.INDICATOR=1 AND MD.DISCOUNT_TYPE=1
	 AND (MD.DEDUCTION_INCLUSION = @DEDUCTION_INCLUSION  OR @DEDUCTION_INCLUSION IS NULL) AND MD.FILTER_CCP = 1
	 GROUP BY MD.PERIOD,MD.YEAR,MD.CFF_MASTER_SID ) MD
	ON MD.PERIOD = S.PERIOD AND S.YEAR = MD.YEAR AND S.CFF_MASTER_SID = MD.CFF_MASTER_SID AND S.HIERARCHY_NO = MD.HIERARCHY_NO 
	LEFT JOIN (SELECT ''',@HIERARCHY_NO,''' HIERARCHY_NO,SPD.PERIOD,SPD.YEAR,SUM(SPD.SALES) SALES,SUM(SPD.UNITS) AS UNITS,
	SPD.CFF_MASTER_SID,SUM(SPD.ACCRUALS) AS ACCRUALS,SUM(SPD.DISCOUNT) AS DISCOUNT FROM  ' , @discount_table ,' SPD
	WHERE SPD.HIERARCHY_NO like ''',@HIERARCHY_NO,'''+''%'' AND SPD.INDICATOR=1 AND SPD.DISCOUNT_TYPE=2
	 AND (SPD.DEDUCTION_INCLUSION = @DEDUCTION_INCLUSION  OR @DEDUCTION_INCLUSION IS NULL) AND SPD.FILTER_CCP = 1
	 GROUP BY SPD.PERIOD,SPD.YEAR,SPD.CFF_MASTER_SID ) SPD
	ON SPD.PERIOD = S.PERIOD AND S.YEAR = SPD.YEAR AND S.CFF_MASTER_SID = SPD.CFF_MASTER_SID AND S.HIERARCHY_NO = SPD.HIERARCHY_NO
	GROUP BY S.CFF_MASTER_SID,
	         S.YEAR,
			 S.PERIOD
')



	EXEC Sp_executesql @SQL_OUT,
	N'@SALES_INCLUSION BIT,@DEDUCTION_INCLUSION BIT',
	@SALES_INCLUSION=@SALES_INCLUSION,
	@DEDUCTION_INCLUSION=@DEDUCTION_INCLUSION
	END

	
ELSE
BEGIN

DECLARE @SQL_ROW NVARCHAR(MAX)
SET @SQL_ROW = CONCAT(' SET @ROW_OP = (SELECT DISTINCT ROWID FROM ',@CUSTOM_CCP_SALES,' C WHERE
                      C.HIERARCHY_NO  = ''',@HIERARCHY_NO, '''  AND  C.CUST_VIEW_MASTER_SID= ', @CUSTOM_VIEW_MASTER_SID, ')')

				
					  --EXEC  Sp_executesql @SQL_ROW,N'@ROW_OP int out',@ROW_ID out


DECLARE @SQL_OUT_C NVARCHAR(MAX)
--product_cff_discount
SET @SQL_OUT_C	 =CONCAT(' SELECT PFD.CFF_MASTER_SID
	,ISNULL(SUM(PFD.EX_FACTORY_SALES), 0) AS EX_FACTORY_SALES
	,PFD.YEAR
	,PFD.PERIOD
	,ISNULL(SUM(S.SALES), 0) AS CONTRACT_SALES
	,ISNULL(SUM(S.UNITS), 0) AS CONTRACT_UNITS
	,ISNULL(SUM(ND.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0) + ISNULL(SUM(SPD.DISCOUNT), 0) AS TOTAL_DISCOUNT
	,ISNULL((SUM(ND.DISCOUNT) + ISNULL(SUM(MD.DISCOUNT), 0) + ISNULL(SUM(SPD.DISCOUNT), 0)) / NULLIF(SUM(S.SALES), 0), 0) * 100 AS TOTAL_DISCOUNT_PERCENTAGE
	,(ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.EX_FACTORY_SALES), 0), 0)) * 100 AS EX_FACTORY_SALES_PERCENT
	,ISNULL(0, 0) AS PPA_DISCOUNT
	,ISNULL(0 / NULLIF(SUM(S.SALES), 0), 0) * 100 AS PPA_DISCOUNT_PERCENTAGE
	,ISNULL(0 / NULLIF(SUM(S.SALES), 0), 0) * 100 AS PPA_DISCOUNT_PROJECTED_PERCENTAGE
	,ISNULL(SUM(MD.DISCOUNT), 0) AS MANDATED_DISCOUNT
	,ISNULL(SUM(SPD.DISCOUNT), 0) AS SUPPLEMENTAL_DISCOUNT
	,COALESCE(ISNULL(SUM(MD.DISCOUNT), 0) / NULLIF(SUM(S.SALES), 0), 0) * 100 AS MANDATED_DISCOUNT_PERCENTAGE
	,COALESCE(ISNULL(SUM(SPD.DISCOUNT), 0) / NULLIF(SUM(S.SALES), 0), 0) * 100 AS SUPPLEMENTAL_DISCOUNT_PERCENTAGE
	,ISNULL(SUM(S.SALES) - (SUM(ND.DISCOUNT) + SUM(MD.DISCOUNT) + SUM(SPD.DISCOUNT)), 0) AS NET_SALES
	,ISNULL(SUM(PFD.DEMAND_SALES), 0) AS DEMAND_SALES
	,ISNULL(SUM(PFD.IW_MASTER), 0) AS INVENTORY_WITHDRAWAL
	,(ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.DEMAND_SALES), 0), 0)) * 100 AS DEMAND_SALES_PERCENT
	,(ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.IW_MASTER), 0), 0)) * 100 AS INVENTORY_WITHDRAWAL_SALES_PERCENT
	,(ISNULL(SUM(ND.DISCOUNT) / NULLIF(SUM(S.UNITS), 0), 0)) AS TOTAL_DISCOUNT_RPU
	,(ISNULL(0 / NULLIF(SUM(S.UNITS), 0), 0)) AS TOTAL_PPA_RPU
	,ISNULL((SUM(ND.DISCOUNT) + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)) / NULLIF(SUM(S.UNITS), 0), 0) AS TOTAL_RPU
	,ISNULL(SUM(S.COGS_VALUE), 0) AS COGS_VALUE
	,ISNULL(((SUM(S.SALES) - (ISNULL(SUM(ND.DISCOUNT), 0) + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0))) - (ISNULL(SUM(S.COGS_VALUE), 0))), 0) AS NET_PROFIT
	,ISNULL(SUM(PFD.ADJUSTED_DEMAND), 0) AS ADJUSTED_DEMAND
	,ISNULL(SUM(CPFD.CUST_EX_FACTORY_SALES), 0) AS CUST_EX_FACTORY_SALES
	,ISNULL(SUM(CPFD.IW_DETAILS), 0) AS IW_DETAILS
	,ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.ADJUSTED_DEMAND), 0), 0) * 100 AS ADJUSTED_DEMAND_PERCENTAGE
	,ISNULL(SUM(S.SALES) / NULLIF(SUM(CPFD.CUST_EX_FACTORY_SALES), 0), 0) * 100 AS CUST_EX_FACTORY_SALES_PERCENTAGE
	,ISNULL(SUM(S.SALES) / NULLIF(SUM(CPFD.IW_DETAILS), 0), 0) * 100 AS IW_DETAILS_PERCENTAGE
	,coalesce(((ISNULL(SUM(S.SALES) - (ISNULL(SUM(ND.DISCOUNT), 0) + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)), 0)) / NULLIF(SUM(pfd.EX_FACTORY_SALES), 0)) * 100, 0) AS NET_SALES_OF_EX_FACTORY
	,isnull(((SUM(ND.DISCOUNT) + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)) / NULLIF(SUM(pfd.EX_FACTORY_SALES), 0)) * 100, 0) AS DISCOUNT_OF_EX_FACTORY
	,ISNULL(SUM(PFD.EX_FACTORY_SALES), 0) - ISNULL((SUM(ND.DISCOUNT) + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)), 0) AS NET_EXFACTORY_SALES
	,ISNULL(((ISNULL(SUM(PFD.EX_FACTORY_SALES), 0) - ISNULL((SUM(ND.SALES) + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)), 0)) / NULLIF(SUM(PFD.EX_FACTORY_SALES), 0)), 0) * 100 AS NET_EXFACTORY_SALES_PERCENT
	,ISNULL(SUM(ND.ACCRUALS), 0) TOTAL_DISCOUNT_ACCRUAL
	,0 AS INDICATOR
FROM #PRODUCT_FILE_DATA PFD 
INNER JOIN #CFF_PROJECTION_MASTER CFM ON PFD.CFF_MASTER_SID = CFM.CFF_MASTER_SID
	AND PFD.CFF_MASTER_SID = ',@FIRST_PROJ_SID ,'
	AND PFD.INDICATOR = 0

LEFT JOIN ', @sales_table ,' S ON PFD.PERIOD = S.PERIOD
	AND S.YEAR = PFD.YEAR
	AND S.CFF_MASTER_SID = PFD.CFF_MASTER_SID
	AND S.HIERARCHY_NO = PFD.ROW_ID
	AND S.INDICATOR = 0
	AND S.FILTER_CCP = 1
LEFT JOIN #COMP_PRODUCT_FILE_DATA CPFD ON CPFD.PERIOD = PFD.PERIOD
	AND PFD.YEAR = CPFD.YEAR
	AND PFD.CFF_MASTER_SID = CPFD.CFF_MASTER_SID
	AND PFD.ROW_ID = CPFD.ROW_ID
	AND CPFD.INDICATOR = 0
LEFT JOIN  ' , @discount_table ,'  ND ON ND.PERIOD = PFD.PERIOD
	AND PFD.YEAR = ND.YEAR
	AND PFD.CFF_MASTER_SID = ND.CFF_MASTER_SID
	AND PFD.ROW_ID = ND.HIERARCHY_NO
	AND ND.INDICATOR = 0
	AND ND.DISCOUNT_TYPE = 0
	AND ND.FILTER_CCP = 1
LEFT JOIN  ' , @discount_table ,'  MD ON MD.PERIOD = PFD.PERIOD
	AND PFD.YEAR = MD.YEAR
	AND PFD.CFF_MASTER_SID = MD.CFF_MASTER_SID
	AND PFD.ROW_ID = MD.HIERARCHY_NO
	AND MD.INDICATOR = 0
	AND MD.DISCOUNT_TYPE = 1
	AND MD.FILTER_CCP = 1
LEFT JOIN  ' , @discount_table ,'  SPD ON SPD.PERIOD = PFD.PERIOD
	AND PFD.YEAR = SPD.YEAR
	AND PFD.CFF_MASTER_SID = SPD.CFF_MASTER_SID
	AND PFD.ROW_ID = SPD.HIERARCHY_NO
	AND SPD.INDICATOR = 0
	AND SPD.DISCOUNT_TYPE = 2
	AND SPD.FILTER_CCP = 1
WHERE EXISTS (
		SELECT 1
		FROM #CUSTOMER_DETAILS_TEMP cdt
		WHERE PFD.ROW_ID = cdt.ROW_ID
		)
GROUP BY PFD.CFF_MASTER_SID
	,PFD.YEAR
	,PFD.PERIOD

UNION ALL

SELECT pfd.CFF_MASTER_SID
	,ISNULL(SUM(PFD.EX_FACTORY_SALES), 0) AS EX_FACTORY_SALES
	,pfd.YEAR
	,pfd.PERIOD
	,ISNULL(SUM(S.SALES), 0) AS CONTRACT_SALES
	,ISNULL(SUM(S.UNITS), 0) AS CONTRACT_UNITS
	,ISNULL(SUM(ND.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0) + ISNULL(SUM(SPD.DISCOUNT), 0) AS TOTAL_DISCOUNT
	,ISNULL((SUM(ND.DISCOUNT) + ISNULL(SUM(MD.DISCOUNT), 0) + ISNULL(SUM(SPD.DISCOUNT), 0)) / NULLIF(SUM(S.SALES), 0), 0) * 100 AS TOTAL_DISCOUNT_PERCENTAGE
	,(ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.EX_FACTORY_SALES), 0), 0)) * 100 AS EX_FACTORY_SALES_PERCENT
	,ISNULL(0, 0) AS PPA_DISCOUNT
	,ISNULL(0 / NULLIF(SUM(S.SALES), 0), 0) * 100 AS PPA_DISCOUNT_PERCENTAGE
	,ISNULL(0 / NULLIF(SUM(S.SALES), 0), 0) * 100 AS PPA_DISCOUNT_PROJECTED_PERCENTAGE
	,ISNULL(SUM(MD.DISCOUNT), 0) AS MANDATED_DISCOUNT
	,ISNULL(SUM(SPD.DISCOUNT), 0) AS SUPPLEMENTAL_DISCOUNT
	,COALESCE(ISNULL(SUM(MD.DISCOUNT), 0) / NULLIF(SUM(S.SALES), 0), 0) * 100 AS MANDATED_DISCOUNT_PERCENTAGE
	,COALESCE(ISNULL(SUM(SPD.DISCOUNT), 0) / NULLIF(SUM(S.SALES), 0), 0) * 100 AS SUPPLEMENTAL_DISCOUNT_PERCENTAGE
	,ISNULL(SUM(S.SALES) - (SUM(ND.DISCOUNT) + SUM(MD.DISCOUNT) + SUM(SPD.DISCOUNT)), 0) AS NET_SALES
	,ISNULL(SUM(PFD.DEMAND_SALES), 0) AS DEMAND_SALES
	,ISNULL(SUM(PFD.IW_MASTER), 0) AS INVENTORY_WITHDRAWAL
	,(ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.DEMAND_SALES), 0), 0)) * 100 AS DEMAND_SALES_PERCENT
	,(ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.IW_MASTER), 0), 0)) * 100 AS INVENTORY_WITHDRAWAL_SALES_PERCENT
	,(ISNULL(SUM(ND.DISCOUNT) / NULLIF(SUM(S.UNITS), 0), 0)) AS TOTAL_DISCOUNT_RPU
	,(ISNULL(0 / NULLIF(SUM(S.UNITS), 0), 0)) AS TOTAL_PPA_RPU
	,ISNULL((SUM(ND.DISCOUNT) + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)) / NULLIF(SUM(S.UNITS), 0), 0) AS TOTAL_RPU
	,ISNULL(SUM(S.COGS_VALUE), 0) AS COGS_VALUE
	,ISNULL(((SUM(S.SALES) - (ISNULL(SUM(ND.DISCOUNT), 0) + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0))) - (ISNULL(SUM(S.COGS_VALUE), 0))), 0) AS NET_PROFIT
	,ISNULL(SUM(PFD.ADJUSTED_DEMAND), 0) AS ADJUSTED_DEMAND
	,ISNULL(SUM(CPFD.CUST_EX_FACTORY_SALES), 0) AS CUST_EX_FACTORY_SALES
	,ISNULL(SUM(CPFD.IW_DETAILS), 0) AS IW_DETAILS
	,ISNULL(SUM(S.SALES) / NULLIF(SUM(PFD.ADJUSTED_DEMAND), 0), 0) * 100 AS ADJUSTED_DEMAND_PERCENTAGE
	,ISNULL(SUM(S.SALES) / NULLIF(SUM(CPFD.CUST_EX_FACTORY_SALES), 0), 0) * 100 AS CUST_EX_FACTORY_SALES_PERCENTAGE
	,ISNULL(SUM(S.SALES) / NULLIF(SUM(CPFD.IW_DETAILS), 0), 0) * 100 AS IW_DETAILS_PERCENTAGE
	,coalesce(((ISNULL(SUM(S.SALES) - (ISNULL(SUM(ND.DISCOUNT), 0) + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)), 0)) / NULLIF(SUM(pfd.EX_FACTORY_SALES), 0)) * 100, 0) AS NET_SALES_OF_EX_FACTORY
	,isnull(((SUM(ND.DISCOUNT) + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)) / NULLIF(SUM(pfd.EX_FACTORY_SALES), 0)) * 100, 0) AS DISCOUNT_OF_EX_FACTORY
	,ISNULL(SUM(PFD.EX_FACTORY_SALES), 0) - ISNULL((SUM(ND.DISCOUNT) + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)), 0) AS NET_EXFACTORY_SALES
	,ISNULL(((ISNULL(SUM(PFD.EX_FACTORY_SALES), 0) - ISNULL((SUM(ND.SALES) + ISNULL(SUM(SPD.DISCOUNT), 0) + ISNULL(SUM(MD.DISCOUNT), 0)), 0)) / NULLIF(SUM(PFD.EX_FACTORY_SALES), 0)), 0) * 100 AS NET_EXFACTORY_SALES_PERCENT
	,ISNULL(SUM(ND.ACCRUALS), 0) TOTAL_DISCOUNT_ACCRUAL
	,1 AS INDICATOR
FROM #PRODUCT_FILE_DATA PFD 
INNER JOIN #CFF_PROJECTION_MASTER CFM ON PFD.CFF_MASTER_SID = CFM.CFF_MASTER_SID
	AND PFD.INDICATOR = 1
LEFT JOIN ', @sales_table ,' S ON PFD.PERIOD = S.PERIOD
	AND S.YEAR = PFD.YEAR
	AND S.CFF_MASTER_SID = PFD.CFF_MASTER_SID
	AND S.HIERARCHY_NO = PFD.ROW_ID
	AND S.INDICATOR = 1
	AND S.FILTER_CCP = 1
LEFT JOIN #COMP_PRODUCT_FILE_DATA CPFD ON CPFD.PERIOD = PFD.PERIOD
	AND PFD.YEAR = CPFD.YEAR
	AND PFD.CFF_MASTER_SID = CPFD.CFF_MASTER_SID
	AND PFD.ROW_ID = CPFD.ROW_ID
	AND CPFD.INDICATOR = 1
LEFT JOIN  ' , @discount_table ,'  ND ON ND.PERIOD = PFD.PERIOD
	AND PFD.YEAR = ND.YEAR
	AND PFD.CFF_MASTER_SID = ND.CFF_MASTER_SID
	AND PFD.ROW_ID = ND.HIERARCHY_NO
	AND ND.INDICATOR = 1
	AND ND.DISCOUNT_TYPE = 0
	AND ND.FILTER_CCP = 1
LEFT JOIN  ' , @discount_table ,'  MD ON MD.PERIOD = PFD.PERIOD
	AND PFD.YEAR = MD.YEAR
	AND PFD.CFF_MASTER_SID = MD.CFF_MASTER_SID
	AND PFD.ROW_ID = MD.HIERARCHY_NO
	AND MD.INDICATOR = 1
	AND MD.DISCOUNT_TYPE = 1
	AND MD.FILTER_CCP = 1
LEFT JOIN  ' , @discount_table ,'  SPD ON SPD.PERIOD = PFD.PERIOD
	AND PFD.YEAR = SPD.YEAR
	AND PFD.CFF_MASTER_SID = SPD.CFF_MASTER_SID
	AND PFD.ROW_ID = SPD.HIERARCHY_NO
	AND SPD.INDICATOR = 1
	AND SPD.DISCOUNT_TYPE = 2
	AND SPD.FILTER_CCP = 1
WHERE EXISTS (
		SELECT 1
		FROM #CUSTOMER_DETAILS_TEMP cdt
		WHERE PFD.ROW_ID = cdt.ROW_ID
		)
GROUP BY PFD.CFF_MASTER_SID
	,PFD.YEAR
	,PFD.PERIOd
	')

  		EXEC Sp_executesql @SQL_OUT_C,
	N'@SALES_INCLUSION BIT,@DEDUCTION_INCLUSION BIT',
	@SALES_INCLUSION=@SALES_INCLUSION,
	@DEDUCTION_INCLUSION=@DEDUCTION_INCLUSION

END

 END TRY 

      BEGIN CATCH 
          DECLARE @ERRORMESSAGE NVARCHAR(4000); 
          DECLARE @ERRORSEVERITY INT; 
          DECLARE @ERRORSTATE INT; 
          DECLARE @ERRORNUMBER INT; 
          DECLARE @ERRORPROCEDURE VARCHAR(200); 
          DECLARE @ERRORLINE INT; 

          EXEC USPERRORCOLLECTOR 

          SELECT @ERRORMESSAGE = ERROR_MESSAGE(), 
                 @ERRORSEVERITY = ERROR_SEVERITY(), 
                 @ERRORSTATE = ERROR_STATE(), 
                 @ERRORPROCEDURE = ERROR_PROCEDURE(), 
                 @ERRORLINE = ERROR_LINE(), 
                 @ERRORNUMBER = ERROR_NUMBER() 

          RAISERROR ( @ERRORMESSAGE,-- MESSAGE TEXT. 
                      @ERRORSEVERITY,-- SEVERITY. 
                      @ERRORSTATE,-- STATE. 
                      @ERRORPROCEDURE,-- PROCEDURE_NAME. 
                      @ERRORNUMBER,-- ERRORNUMBER 
                      @ERRORLINE -- ERRORLINE 
          ) 
      END CATCH 
  END --END OF PROCEDURE 
  GO