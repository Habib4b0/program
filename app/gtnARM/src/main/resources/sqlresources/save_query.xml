<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<sql>
    <entity id="SELECT_RATE_MASTER_DETAILS">
        <query> 
            <![CDATA[
        IF EXISTS (SELECT 1 FROM ARM_ADJ_RATE_CONFIG_MASTER WHERE GL_COMPANY_MASTER_SID = [$GL_COMPANY_MASTER_SID] and BU_COMPANY_MASTER_SID = [$BU_COMPANY_MASTER_SID] 
                AND ADJUSTMENT_TYPE = '[$ADJUSTMENT_TYPE]')
            BEGIN 
                SELECT MASTER.ARM_ADJ_RATE_CONFIG_MASTER_SID,DETAILS.ARM_ADJ_RATE_CONFIG_DETAIL_SID,DETAILS."MONTH",DETAILS.DATE_TYPE,DETAILS.PRICE,
                DETAILS.INVENTORY_CUSTOMER,DETAILS.RESERVE_DATE,DETAILS.RATE_BASIS,DETAILS.RATE_FREQUENCY,DETAILS.RATE_PERIOD,DETAILS.INVENTORY_DETAILS,DETAILS.EXCLUSION_VIEW_MASTER,ARM.VIEW_NAME,ADJUSTED_PRICE,BASE_LINE_PRICE
                FROM ARM_ADJ_RATE_CONFIG_MASTER MASTER 
                JOIN ARM_ADJ_RATE_CONFIG_DETAIL DETAILS ON DETAILS.ARM_ADJ_RATE_CONFIG_MASTER_SID=MASTER.ARM_ADJ_RATE_CONFIG_MASTER_SID
                Left JOIN ARM_VIEW_MASTER ARM ON ARM.ARM_VIEW_MASTER_SID=DETAILS.EXCLUSION_VIEW_MASTER  
                WHERE MASTER.GL_COMPANY_MASTER_SID= [$GL_COMPANY_MASTER_SID] AND MASTER.BU_COMPANY_MASTER_SID = [$BU_COMPANY_MASTER_SID] 
                AND MASTER.ADJUSTMENT_TYPE = '[$ADJUSTMENT_TYPE]'
            END
        ELSE 
            BEGIN 
                SELECT 1
            END
            ]]>
        </query>
    </entity>
    <entity id="SAVE_MASTER_DETAILS">
        <query> 
            <![CDATA[
                        declare @trew int
          INSERT INTO ARM_ADJ_RATE_CONFIG_MASTER (GL_COMPANY_MASTER_SID,BU_COMPANY_MASTER_SID,ADJUSTMENT_TYPE) values 
          ([$(GL_COMPANY_MASTER_SID],[$BU_COMPANY_MASTER_SID],'[$ADJUSTMENT_TYPE]')
          select @trew=scope_identity()
          Insert into ARM_ADJ_RATE_CONFIG_DETAIL (ARM_ADJ_RATE_CONFIG_MASTER_SID,"MONTH",DATE_TYPE,PRICE,INVENTORY_CUSTOMER,RESERVE_DATE,RATE_BASIS,RATE_FREQUENCY,
            RATE_PERIOD,INVENTORY_DETAILS,EXCLUSION_VIEW_MASTER,ADJUSTED_PRICE,BASE_LINE_PRICE)
          values 
            ]]>
        </query>
    </entity>
    <entity id="DELETE_MASTER_DETAILS">
        <query> 
            <![CDATA[
            DELETE FROM ARM_ADJ_RATE_CONFIG_MASTER WHERE GL_COMPANY_MASTER_SID = ? AND  BU_COMPANY_MASTER_SID = ? AND ADJUSTMENT_TYPE ='?';
            ]]>
        </query>
    </entity>
   
    <entity id="SAVE_MASTER_DETAILS_SUB_QUERY">
        <query> 
            <![CDATA[
            (@trew,[$MONTH],[$DATE_TYPE],[$PRICE],[$INVENTORY_CUSTOMER],[$RESERVE_DATE],[$RATE_BASIS],[$RATE_FREQUENCY],[$RATE_PERIOD],[$INVENTORY_DETAILS],[$EXCLUSION_VIEW_MASTER],[$ADJUSTED_PRICE],[$BASELINE_PRICE])
            ]]>
        </query>
    </entity>
    <entity id="UPDATE_MASTER_DETAILS_QUERY">
        <query> 
            <![CDATA[
           ;with cte as(
            SELECT *
            FROM   ( values [$UPDATE_RATE_DETAILS_SUB_QUERY] ) 
             UPDATE_SESSION_TABLE(ARM_ADJ_RATE_CONFIG_DETAIL_SID, "MONTH", DATE_TYPE,PRICE,INVENTORY_CUSTOMER,RESERVE_DATE, RATE_BASIS, RATE_FREQUENCY, RATE_PERIOD,INVENTORY_DETAILS,EXCLUSION_VIEW_MASTER,ADJUSTED_PRICE,BASE_LINE_PRICE)
          )
          UPDATE  RD SET RD.DATE_TYPE = UST.DATE_TYPE,RD.PRICE = UST.PRICE,RD.INVENTORY_CUSTOMER = UST.INVENTORY_CUSTOMER,RD.RESERVE_DATE = UST.RESERVE_DATE,
          RD.RATE_BASIS = UST.RATE_BASIS,RD.RATE_FREQUENCY = UST.RATE_FREQUENCY,RD.RATE_PERIOD = UST.RATE_PERIOD,RD.INVENTORY_DETAILS=UST.INVENTORY_DETAILS,RD.EXCLUSION_VIEW_MASTER=UST.EXCLUSION_VIEW_MASTER,
           rd.BASE_LINE_PRICE=ust.BASE_LINE_PRICE,rd.ADJUSTED_PRICE=UST.ADJUSTED_PRICE
          FROM ARM_ADJ_RATE_CONFIG_DETAIL RD JOIN cte UST ON RD.ARM_ADJ_RATE_CONFIG_DETAIL_SID=UST.ARM_ADJ_RATE_CONFIG_DETAIL_SID
            ]]>
        </query>
    </entity>
    <entity id="UPDATE_RATE_DETAILS_SUB_QUERY">
        <query> 
            <![CDATA[
            ([$ARM_ADJ_RATE_CONFIG_DETAIL_SID],[$MONTH],[$DATE_TYPE],'[$PRICE]',[$INVENTORY_CUSTOMER],[$RESERVE_DATE],[$RATE_BASIS],[$RATE_FREQUENCY],
[$RATE_PERIOD],[$INVENTORY_DETAILS],[$EXCLUSION_VIEW_MASTER],'[$ADJUSTED_PRICE]','[$BASE_LINE_PRICE]')
            ]]>
        </query>
    </entity>
  
    <entity id="ADJUSTMENT_SELECTION_SAVE">
        <query> 
            <![CDATA[
            INSERT INTO ARM_PROJ_SELECTION (PROJECTION_MASTER_SID,SCREEN_NAME,FIELD_NAME,FIELD_VALUES) 
            VALUES 
            ]]>
        </query>
    </entity>
    <entity id="ADJUSTMENT_SELECTION_SAVE_SUB_QUERY">
        <query> 
            <![CDATA[
           ([$PROJECTION_MASTER_SID],[$SCREEN_NAME],[$FIELD_NAME],[$FIELD_VALUES]) 
            ]]>
        </query>
    </entity>
  
    <entity id="UPDATE_PROJECTION_MASTER_APPROVE_FLAG">
        <query> 
            <![CDATA[
            UPDATE  PROJECTION_MASTER SET IS_APPROVED = '?', MODIFIED_DATE =GETDATE(),MODIFIED_BY=? WHERE PROJECTION_MASTER_SID =?
            ]]>    
        </query>
    </entity>
    
    <entity id="Drop.DynamicTempTables">
        <query> 
            <![CDATA[
     DECLARE @SQL        VARCHAR(MAX)='',
        @USER    INT=@USER_ID,
        @SESSION VARCHAR(100)='@SESSION_ID'

SET @SQL = (SELECT Concat('DROP TABLE ', Quotename(Upper(NAME)), '; ')
            FROM   SYS.TABLES
            WHERE  NAME LIKE Concat('ST_%', @USER, '_', @SESSION, '_', Replace(CONVERT(VARCHAR(50), Getdate(), 2), '.', ''))
            FOR XML PATH (''))
--select @sql
EXEC( @SQL ) 
   ]]>
        </query> 
    </entity>
    
</sql>