<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<sql>
         <entity id="CommercialDelete">
        <query> 
            <![CDATA[
               DECLARE @PROJECTION_NM AS TABLE
(
   ID  INT IDENTITY (1, 1),
   PROJECTION_MASTER_SID  INT,
   PROJECTION_DETAILS_SID INT
                      )
  INSERT INTO @PROJECTION_NM
              (PROJECTION_MASTER_SID,
               PROJECTION_DETAILS_SID)
  SELECT A.PROJECTION_MASTER_SID,
         B.PROJECTION_DETAILS_SID
  FROM   PROJECTION_MASTER A
  JOIN  PROJECTION_DETAILS  B ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
  WHERE  SAVE_FLAG = 'FALSE'
         AND FORECASTING_TYPE = 'NON MANDATED'
         AND CREATED_DATE < GETDATE() - 2

		 

		 TRUNCATE TABLE ST_NM_SALES_PROJECTION				
		 TRUNCATE TABLE ST_NM_ACTUAL_SALES					
		 TRUNCATE TABLE ST_NM_SALES_PROJECTION_MASTER		
		 TRUNCATE TABLE ST_NM_DISCOUNT_PROJECTION			
		 TRUNCATE TABLE ST_NM_ACTUAL_DISCOUNT				
		 TRUNCATE TABLE ST_NM_DISCOUNT_PROJ_MASTER			
		 TRUNCATE TABLE ST_NM_PPA_PROJECTION				
		 TRUNCATE TABLE ST_NM_ACTUAL_PPA					
		 TRUNCATE TABLE ST_NM_PPA_PROJECTION_MASTER			
		 TRUNCATE TABLE ST_NM_ASSUMPTIONS					
		 TRUNCATE TABLE ST_ALTERNATE_HIST_ALLOCATION		
		 TRUNCATE TABLE ST_DISC_ALTERNATE_HIST_ALLOCATION	
		 DELETE T FROM NM_ACTUAL_DISCOUNT T JOIN @PROJECTION_NM A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		 DELETE T FROM NM_ACTUAL_PPA T JOIN @PROJECTION_NM A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		 DELETE T FROM NM_ACTUAL_SALES T JOIN @PROJECTION_NM A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		 DELETE T FROM NM_ASSUMPTIONS T JOIN @PROJECTION_NM A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		 DELETE T FROM NM_DISCOUNT_PROJ_MASTER T JOIN @PROJECTION_NM A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		 DELETE T FROM NM_DISCOUNT_PROJECTION T JOIN @PROJECTION_NM A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		 DELETE T FROM NM_PPA_PROJECTION T JOIN @PROJECTION_NM A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		 DELETE T FROM NM_PPA_PROJECTION_MASTER T JOIN @PROJECTION_NM A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID;
		 DELETE T FROM NM_SALES_PROJECTION T JOIN @PROJECTION_NM A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		 DELETE T FROM NM_SALES_PROJECTION_MASTER  T JOIN @PROJECTION_NM A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID;  
		 DELETE CRB FROM CUSTOM_RELATIONSHIP_BUILDER CRB JOIN CUSTOM_VIEW_DETAILS CVD ON CVD.CUSTOM_VIEW_DETAILS_SID=CRB.CUSTOM_VIEW_DETAILS_SID AND CVD.CUSTOM_VIEW_MASTER_SID IN(SELECT CUSTOM_VIEW_MASTER_SID FROM CUSTOM_VIEW_MASTER CVM JOIN @PROJECTION_NM B ON B.PROJECTION_MASTER_SID = CVM.PROJECTION_MASTER_SID);
                 DELETE CCM FROM DBO.CUSTOM_CCP_MAP CCM JOIN CUSTOM_VIEW_DETAILS CVD ON CVD.CUSTOM_VIEW_DETAILS_SID=CCM.CUSTOM_VIEW_DETAILS_SID AND CVD.CUSTOM_VIEW_MASTER_SID IN(SELECT CUSTOM_VIEW_MASTER_SID FROM CUSTOM_VIEW_MASTER CVM JOIN @PROJECTION_NM B ON B.PROJECTION_MASTER_SID = CVM.PROJECTION_MASTER_SID);
		 DELETE CVD FROM DBO.CUSTOM_VIEW_DETAILS CVD WHERE CVD.CUSTOM_VIEW_MASTER_SID IN(SELECT CUSTOM_VIEW_MASTER_SID FROM   CUSTOM_VIEW_MASTER CVM JOIN @PROJECTION_NM B ON B.PROJECTION_MASTER_SID= CVM.PROJECTION_MASTER_SID);  
		 DELETE A FROM NM_PROJECTION_SELECTION A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_NM)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		 DELETE A FROM CUSTOM_VIEW_MASTER A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_NM)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		 DELETE A FROM PROJECTION_DETAILS A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_NM)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		 DELETE A FROM PROJECTION_CUST_HIERARCHY A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_NM)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		 DELETE A FROM PROJECTION_PROD_HIERARCHY A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_NM)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID;
           ]]>
        </query> 
    </entity>
    
     <entity id="GovernmentDelete">
        <query> 
            <![CDATA[
            DECLARE @PROJECTION_MAN AS TABLE
 (
    ID  INT IDENTITY (1, 1),
    PROJECTION_MASTER_SID  INT,
    PROJECTION_DETAILS_SID INT
                       )
   INSERT INTO @PROJECTION_MAN
               (PROJECTION_MASTER_SID,
                PROJECTION_DETAILS_SID)
   SELECT A.PROJECTION_MASTER_SID,
          B.PROJECTION_DETAILS_SID
   FROM   PROJECTION_MASTER A
   JOIN  PROJECTION_DETAILS  B ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
   WHERE  SAVE_FLAG = 'FALSE'
          AND FORECASTING_TYPE = 'MANDATED'
          AND CREATED_DATE < GETDATE() - 2

			TRUNCATE TABLE  ST_M_SALES_PROJECTION			
			TRUNCATE TABLE  ST_M_ACTUAL_SALES				
			TRUNCATE TABLE  ST_M_SALES_PROJECTION_MASTER	
			TRUNCATE TABLE  ST_M_SUPPLEMENTAL_DISC_ACTUALS	
			TRUNCATE TABLE  ST_M_SUPPLEMENTAL_DISC_MASTER	
			TRUNCATE TABLE  ST_M_SUPPLEMENTAL_DISC_PROJ		
		    TRUNCATE TABLE  ST_M_ASSUMPTIONS				
		    DELETE T FROM  M_ACTUAL_DISCOUNT T JOIN @PROJECTION_MAN A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		    DELETE T FROM M_ACTUAL_SALES T JOIN @PROJECTION_MAN A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		    DELETE T FROM M_ASSUMPTIONS T JOIN @PROJECTION_MAN A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		    DELETE T FROM M_DISCOUNT_PROJECTION T JOIN @PROJECTION_MAN A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		    DELETE T FROM M_PARITY_LOOKUP T join PROJECTION_DETAILS p ON P.CCP_DETAILS_SID=T.CCP_DETAILS_SID JOIN @PROJECTION_MAN A ON A.PROJECTION_DETAILS_SID = P.PROJECTION_DETAILS_SID; 
		    DELETE T FROM M_SALES_PROJECTION T JOIN @PROJECTION_MAN A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		    DELETE T FROM M_SALES_PROJECTION_MASTER T JOIN @PROJECTION_MAN A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		    DELETE T FROM M_SUPPLEMENTAL_DISC_ACTUALS T JOIN @PROJECTION_MAN A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		    DELETE T FROM M_SUPPLEMENTAL_DISC_MASTER T JOIN @PROJECTION_MAN A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID; 
		    DELETE T FROM M_SUPPLEMENTAL_DISC_PROJ    T JOIN @PROJECTION_MAN A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID;  
		    DELETE CVD FROM DBO.CUSTOM_VIEW_DETAILS CVD WHERE CVD.CUSTOM_VIEW_MASTER_SID IN(SELECT CUSTOM_VIEW_MASTER_SID FROM   CUSTOM_VIEW_MASTER CVM JOIN @PROJECTION_MAN B ON B.PROJECTION_MASTER_SID = CVM.PROJECTION_MASTER_SID);  
		    DELETE A FROM M_PROJECTION_SELECTION A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_MAN)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		    DELETE A FROM CUSTOM_VIEW_MASTER A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_MAN)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		    DELETE A FROM PROJECTION_DETAILS A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_MAN)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		    DELETE A FROM PROJECTION_CUST_HIERARCHY A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_MAN)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		    DELETE A FROM PROJECTION_PROD_HIERARCHY A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_MAN)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID;

             ]]>
        </query> 
    </entity>
    
    <entity id="ReturnsDelete">
        <query> 
            <![CDATA[
            DECLARE @PROJECTION_RET AS TABLE
 (
    ID  INT IDENTITY (1, 1),
    PROJECTION_MASTER_SID  INT,
    RETURNS_DETAILS_SID INT
                       )
   INSERT INTO @PROJECTION_RET
               (PROJECTION_MASTER_SID,
                RETURNS_DETAILS_SID)
   SELECT A.PROJECTION_MASTER_SID,
          B.RETURNS_DETAILS_SID
   FROM   PROJECTION_MASTER A
   JOIN  RETURNS_DETAILS  B ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
   WHERE  SAVE_FLAG = 'FALSE'
          AND FORECASTING_TYPE = 'RETURNS'
          AND CREATED_DATE < GETDATE() - 2
		  
		  TRUNCATE TABLE  ST_RETURNS_PROJ_MASTER 
		  TRUNCATE TABLE  ST_RETURNS_PROJ_DETAILS 
		  TRUNCATE TABLE  ST_RETURNS_ACTUALS
		  DELETE T FROM RETURNS_PROJ_MASTER T JOIN @PROJECTION_RET A ON A.RETURNS_DETAILS_SID = T.RETURNS_DETAILS_SID; 
		  DELETE T FROM RETURNS_ACTUALS T JOIN @PROJECTION_RET A ON A.RETURNS_DETAILS_SID = T.RETURNS_DETAILS_SID;
		  DELETE T FROM RETURNS_PROJ_DETAILS T JOIN @PROJECTION_RET A ON A.RETURNS_DETAILS_SID= T.RETURNS_DETAILS_SID;  
		  DELETE A FROM RETURNS_PROJECTION_SELECTION A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_RET)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		  DELETE A FROM RETURNS_DETAILS A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_RET)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		  DELETE A FROM RETURNS_MAP A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_RET)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		  DELETE A FROM PROJECTION_PROD_HIERARCHY A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_RET)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID;
		  
             ]]>
        </query> 
    </entity>
    
    
    <entity id="ARPandOutboundDelete">
        <query> 
            <![CDATA[
            DECLARE @PROJECTION_ARP AS TABLE
 (
    ID  INT IDENTITY (1, 1),
    PROJECTION_MASTER_SID  INT,
    ACCRUAL_PROJ_DETAILS_SID INT
                       )
   INSERT INTO @PROJECTION_ARP
               (PROJECTION_MASTER_SID,
                ACCRUAL_PROJ_DETAILS_SID)
   SELECT A.PROJECTION_MASTER_SID,
          B.ACCRUAL_PROJ_DETAILS_SID
   FROM   PROJECTION_MASTER A
   JOIN  ACCRUAL_PROJ_DETAILS  B ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
   WHERE  SAVE_FLAG = 'FALSE'
          AND FORECASTING_TYPE = 'ACCRUALRATEPROJECTION'
          AND CREATED_DATE < GETDATE() - 2
		 

		TRUNCATE TABLE  ST_ACCRUAL_RATE_ACTUALS
		TRUNCATE TABLE  ST_ACCRUAL_RATE_DETAILS
		TRUNCATE TABLE ST_ACCRUAL_DETAILS_ACTUALS 
		TRUNCATE TABLE ST_ACCRUAL_DETAILS_INFO    
		TRUNCATE TABLE ST_ACCRUAL_SALES_ACTUALS   
		TRUNCATE TABLE ST_ACCRUAL_SALES_DETAILS   
		TRUNCATE TABLE ST_EXCLUSION_DETAILS 
		TRUNCATE TABLE ST_CFF_OUTBOUND_MASTER 
		TRUNCATE TABLE ST_ARP_OUTBOUND       
		DELETE T FROM ACCRUAL_RATE_ACTUALS T JOIN @PROJECTION_ARP A ON A.ACCRUAL_PROJ_DETAILS_SID = T.ACCRUAL_PROJ_DETAILS_SID; 
		DELETE T FROM ACCRUAL_RATE_DETAILS T JOIN @PROJECTION_ARP A ON A.ACCRUAL_PROJ_DETAILS_SID = T.ACCRUAL_PROJ_DETAILS_SID;   
		DELETE A FROM ACCRUAL_PROJ_SELECTION A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_ARP)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		DELETE A FROM ACCRUAL_PROJ_DETAILS A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_ARP)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		DELETE A FROM ACCRUAL_SALES_ACTUALS A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_ARP)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		DELETE A FROM ACCRUAL_SALES_DETAILS A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_ARP)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		DELETE A FROM EXCLUSION_DETAILS A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_ARP)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		DELETE A FROM ACCRUAL_DETAILS_ACTUALS A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_ARP)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		DELETE A FROM ACCRUAL_DETAILS_INFO A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_ARP)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		DELETE A FROM PROJECTION_DETAILS A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_ARP)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		DELETE A FROM PROJECTION_CUST_HIERARCHY A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_ARP)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
		DELETE A FROM PROJECTION_PROD_HIERARCHY A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_ARP)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID;
             ]]>
        </query> 
    </entity>  
    
    <entity id="ForecastTempTableDrop">
        <query> 
            <![CDATA[
              DECLARE @SQL VARCHAR(MAX)=''

SET @SQL = (SELECT Concat('DROP TABLE ', Quotename(Upper(NAME)), '; ')    
            FROM   SYS.TABLES
            WHERE  NAME LIKE 'ST_%[0-9]'
                   AND Try_convert(DATE, RIGHT(NAME, Charindex('_', Reverse(NAME)) - 1)) <= Dateadd(DD, -1, Cast(Getdate() AS DATE))
            FOR XML PATH (''))
EXEC( @SQL ) 

         ]]>
        </query> 
    </entity>         
    <entity id="ForecastUnsavedProjectionDelete">
        <query> 
            <![CDATA[
               DECLARE @PROJECTION_NM AS TABLE
                    (
   ID  INT IDENTITY (1, 1),
   PROJECTION_MASTER_SID  INT,
   PROJECTION_DETAILS_SID INT
                      )
  INSERT INTO @PROJECTION_NM
              (PROJECTION_MASTER_SID,
               PROJECTION_DETAILS_SID)
  SELECT A.PROJECTION_MASTER_SID,
         B.PROJECTION_DETAILS_SID
  FROM   PROJECTION_MASTER A
  JOIN  PROJECTION_DETAILS  B ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
  WHERE  SAVE_FLAG = 'FALSE'
         AND FORECASTING_TYPE IN ( 'NON MANDATED' , 'RETURNS' , 'MANDATED', 'ACCRUALRATEPROJECTION')
         AND CREATED_DATE < GETDATE() - 2
         AND NOT EXISTS (SELECT 1 FROM FORECASTING_VIEW_MASTER FVM WHERE FVM.PROJECTION_ID = A.PROJECTION_MASTER_SID)
		 

DELETE CCM FROM DBO.CUSTOM_CCP_MAP CCM JOIN CUSTOM_VIEW_DETAILS CVD ON CVD.CUSTOM_VIEW_DETAILS_SID=CCM.CUSTOM_VIEW_DETAILS_SID AND CVD.CUSTOM_VIEW_MASTER_SID IN(SELECT CUSTOM_VIEW_MASTER_SID FROM CUSTOM_VIEW_MASTER CVM JOIN @PROJECTION_NM B ON B.PROJECTION_MASTER_SID = CVM.PROJECTION_MASTER_SID);
DELETE CVD FROM DBO.CUSTOM_VIEW_DETAILS CVD WHERE CVD.CUSTOM_VIEW_MASTER_SID IN(SELECT CUSTOM_VIEW_MASTER_SID FROM   CUSTOM_VIEW_MASTER CVM JOIN @PROJECTION_NM B ON B.PROJECTION_MASTER_SID= CVM.PROJECTION_MASTER_SID);   
DELETE A FROM CUSTOM_VIEW_MASTER A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_NM)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
DELETE A FROM PROJECTION_DETAILS A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_NM)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
DELETE A FROM PROJECTION_CUST_HIERARCHY A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_NM)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID; 
DELETE A FROM PROJECTION_PROD_HIERARCHY A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION_NM)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID;
         ]]>
        </query> 
    </entity>         
</sql>