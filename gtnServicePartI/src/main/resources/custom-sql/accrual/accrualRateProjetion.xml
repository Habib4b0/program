<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<custom-sql>
  
    <sql          
        id="AccrualMainSave">

<![CDATA[ 

MERGE    ACCRUAL_SALES_ACTUALS	 AS TARGET
		USING ( 
		SELECT PROJECTION_MASTER_SID,
ITEM_MASTER_SID,
PERIOD_SID,
TOTAL_UNITS,
EXCLUDED_UNITS,
NET_UNITS,
PRICE,
SALES,
EXCLUDED_DOLLARS,
DEMAND,
ADJUSTED_DEMAND
		FROM dbo.ST_ACCRUAL_SALES_ACTUALS
		WHERE USER_ID=@USER_ID AND SESSION_ID=@SESSION_ID
		) AS SOURCE 
		ON (TARGET.PROJECTION_MASTER_SID=SOURCE.PROJECTION_MASTER_SID
                    AND TARGET.ITEM_MASTER_SID = SOURCE.ITEM_MASTER_SID 
                    AND TARGET.PERIOD_SID = SOURCE.PERIOD_SID)
		WHEN MATCHED 
		THEN 
		UPDATE SET 
TARGET.ITEM_MASTER_SID=SOURCE.ITEM_MASTER_SID,
TARGET.PERIOD_SID=SOURCE.PERIOD_SID,
TARGET.TOTAL_UNITS=SOURCE.TOTAL_UNITS,
TARGET.EXCLUDED_UNITS=SOURCE.EXCLUDED_UNITS,
TARGET.NET_UNITS=SOURCE.NET_UNITS,
TARGET.PRICE=SOURCE.PRICE,
TARGET.SALES=SOURCE.SALES,
TARGET.EXCLUDED_DOLLARS = SOURCE.EXCLUDED_DOLLARS,
TARGET.DEMAND=SOURCE.DEMAND,
TARGET.ADJUSTED_DEMAND=SOURCE.ADJUSTED_DEMAND

		WHEN NOT MATCHED BY TARGET
		THEN 
		INSERT VALUES(SOURCE.PROJECTION_MASTER_SID,
SOURCE.ITEM_MASTER_SID,
SOURCE.PERIOD_SID,
SOURCE.TOTAL_UNITS,
SOURCE.EXCLUDED_UNITS,
SOURCE.NET_UNITS,
SOURCE.PRICE,
SOURCE.SALES,
SOURCE.EXCLUDED_DOLLARS,
SOURCE.DEMAND,
SOURCE.ADJUSTED_DEMAND);;


MERGE    ACCRUAL_SALES_DETAILS	 AS TARGET
		USING ( 
		SELECT PROJECTION_MASTER_SID,
ITEM_MASTER_SID,
PERIOD_SID,
TOTAL_UNITS,
EXCLUDED_UNITS,
NET_UNITS,
PRICE,
SALES,
EXCLUDED_DOLLARS,
DEMAND,
ADJUSTED_DEMAND
		FROM dbo.ST_ACCRUAL_SALES_DETAILS
		WHERE USER_ID=@USER_ID AND SESSION_ID=@SESSION_ID
		) AS SOURCE 
		ON (TARGET.PROJECTION_MASTER_SID=SOURCE.PROJECTION_MASTER_SID
                    AND TARGET.ITEM_MASTER_SID = SOURCE.ITEM_MASTER_SID 
                    AND TARGET.PERIOD_SID = SOURCE.PERIOD_SID)
		WHEN MATCHED 
		THEN 
		UPDATE SET 
TARGET.ITEM_MASTER_SID=SOURCE.ITEM_MASTER_SID,
TARGET.PERIOD_SID=SOURCE.PERIOD_SID,
TARGET.TOTAL_UNITS=SOURCE.TOTAL_UNITS,
TARGET.EXCLUDED_UNITS=SOURCE.EXCLUDED_UNITS,
TARGET.NET_UNITS=SOURCE.NET_UNITS,
TARGET.PRICE=SOURCE.PRICE,
TARGET.SALES=SOURCE.SALES,
TARGET.EXCLUDED_DOLLARS = SOURCE.EXCLUDED_DOLLARS,
TARGET.DEMAND=SOURCE.DEMAND,
TARGET.ADJUSTED_DEMAND=SOURCE.ADJUSTED_DEMAND

		WHEN NOT MATCHED BY TARGET
		THEN 
		INSERT VALUES(SOURCE.PROJECTION_MASTER_SID,
SOURCE.ITEM_MASTER_SID,
SOURCE.PERIOD_SID,
SOURCE.TOTAL_UNITS,
SOURCE.EXCLUDED_UNITS,
SOURCE.NET_UNITS,
SOURCE.PRICE,
SOURCE.SALES,
SOURCE.EXCLUDED_DOLLARS,
SOURCE.DEMAND,
SOURCE.ADJUSTED_DEMAND);;

    

MERGE    ACCRUAL_RATE_ACTUALS	 AS TARGET
		USING ( 
		SELECT ACCRUAL_PROJ_DETAILS_SID,PERIOD_SID,ACCRUAL_RATE,ACCRUAL_AMOUNT,PAYMENTS,DETAILS_ACCRUAL_RATE,DETAILS_ACCRUAL_AMOUNT,EFFECTIVE_ACCRUAL_RATE

		FROM dbo.ST_ACCRUAL_RATE_ACTUALS
		WHERE USER_ID=@USER_ID AND SESSION_ID=@SESSION_ID
		) AS SOURCE 
		ON (TARGET.ACCRUAL_PROJ_DETAILS_SID=SOURCE.ACCRUAL_PROJ_DETAILS_SID
                AND TARGET.PERIOD_SID = SOURCE.PERIOD_SID)
		WHEN MATCHED 
		THEN 
		UPDATE SET 
TARGET.PERIOD_SID=SOURCE.PERIOD_SID,
TARGET.ACCRUAL_RATE=SOURCE.ACCRUAL_RATE,
TARGET.ACCRUAL_AMOUNT=SOURCE.ACCRUAL_AMOUNT,
TARGET.PAYMENTS=SOURCE.PAYMENTS,
TARGET.DETAILS_ACCRUAL_RATE=SOURCE.DETAILS_ACCRUAL_RATE,
TARGET.DETAILS_ACCRUAL_AMOUNT=SOURCE.DETAILS_ACCRUAL_AMOUNT,
TARGET.EFFECTIVE_ACCRUAL_RATE=SOURCE.EFFECTIVE_ACCRUAL_RATE


WHEN NOT MATCHED BY TARGET
		THEN 
		INSERT VALUES(SOURCE.ACCRUAL_PROJ_DETAILS_SID,
SOURCE.PERIOD_SID,
SOURCE.ACCRUAL_RATE,
SOURCE.ACCRUAL_AMOUNT,
SOURCE.PAYMENTS,
SOURCE.DETAILS_ACCRUAL_RATE,
SOURCE.DETAILS_ACCRUAL_AMOUNT,
SOURCE.EFFECTIVE_ACCRUAL_RATE);;


MERGE    ACCRUAL_RATE_DETAILS	 AS TARGET
		USING ( 
		SELECT ACCRUAL_PROJ_DETAILS_SID,PERIOD_SID,ACCRUAL_RATE,ACCRUAL_AMOUNT,PAYMENTS,DETAILS_ACCRUAL_RATE,DETAILS_ACCRUAL_AMOUNT,EFFECTIVE_ACCRUAL_RATE
                        
		FROM dbo.ST_ACCRUAL_RATE_DETAILS
		WHERE USER_ID=@USER_ID AND SESSION_ID=@SESSION_ID
		) AS SOURCE 
		ON (TARGET.ACCRUAL_PROJ_DETAILS_SID=SOURCE.ACCRUAL_PROJ_DETAILS_SID
                AND TARGET.PERIOD_SID = SOURCE.PERIOD_SID)
		WHEN MATCHED 
		THEN 
		UPDATE SET 
TARGET.PERIOD_SID=SOURCE.PERIOD_SID,
TARGET.ACCRUAL_RATE=SOURCE.ACCRUAL_RATE,
TARGET.ACCRUAL_AMOUNT=SOURCE.ACCRUAL_AMOUNT,
TARGET.PAYMENTS=SOURCE.PAYMENTS,
TARGET.DETAILS_ACCRUAL_RATE=SOURCE.DETAILS_ACCRUAL_RATE,
TARGET.DETAILS_ACCRUAL_AMOUNT=SOURCE.DETAILS_ACCRUAL_AMOUNT,
TARGET.EFFECTIVE_ACCRUAL_RATE=SOURCE.EFFECTIVE_ACCRUAL_RATE


WHEN NOT MATCHED BY TARGET
		THEN 
		INSERT VALUES(SOURCE.ACCRUAL_PROJ_DETAILS_SID,
SOURCE.PERIOD_SID,
SOURCE.ACCRUAL_RATE,
SOURCE.ACCRUAL_AMOUNT,
SOURCE.PAYMENTS,
SOURCE.DETAILS_ACCRUAL_RATE,
SOURCE.DETAILS_ACCRUAL_AMOUNT,
SOURCE.EFFECTIVE_ACCRUAL_RATE);;
       

MERGE    EXCLUSION_DETAILS	 AS TARGET
		USING ( 
		SELECT PROJECTION_MASTER_SID,COMPANY_MASTER_SID
		FROM dbo.ST_EXCLUSION_DETAILS
		WHERE USER_ID=@USER_ID AND SESSION_ID=@SESSION_ID
		) AS SOURCE 
		ON (TARGET.PROJECTION_MASTER_SID=SOURCE.PROJECTION_MASTER_SID
                AND TARGET.COMPANY_MASTER_SID = SOURCE.COMPANY_MASTER_SID)
		
		WHEN MATCHED 
		
		THEN 
		UPDATE SET 
TARGET.COMPANY_MASTER_SID=SOURCE.COMPANY_MASTER_SID
WHEN NOT MATCHED BY TARGET
		THEN 
		INSERT VALUES(SOURCE.PROJECTION_MASTER_SID,
SOURCE.COMPANY_MASTER_SID);;
       


       MERGE    ACCRUAL_DETAILS_ACTUALS	 AS TARGET
		USING ( 
		SELECT PROJECTION_MASTER_SID,
                ITEM_MASTER_SID,
                PERIOD_SID,
                COMPANY_MASTER_SID,
                GROSS_TRADE_SALES,
                INVENTORY_WITHDRAWALS,
                ELIGIBLE_GROSS_TRADE_SALES,
                PERIOD_BASIS_PRICE_CHANGE,
                GTS_ACCRUAL_BASIS
		FROM dbo.ST_ACCRUAL_DETAILS_ACTUALS
		WHERE USER_ID=@USER_ID AND SESSION_ID=@SESSION_ID
		) AS SOURCE 
		ON (TARGET.PROJECTION_MASTER_SID=SOURCE.PROJECTION_MASTER_SID
                    AND TARGET.ITEM_MASTER_SID = SOURCE.ITEM_MASTER_SID
                    AND TARGET.COMPANY_MASTER_SID = SOURCE.COMPANY_MASTER_SID
                    AND TARGET.PERIOD_SID = SOURCE.PERIOD_SID)
		WHEN MATCHED 
		THEN 
		UPDATE SET 
TARGET.ITEM_MASTER_SID=SOURCE.ITEM_MASTER_SID,
TARGET.PERIOD_SID=SOURCE.PERIOD_SID,
TARGET.COMPANY_MASTER_SID=SOURCE.COMPANY_MASTER_SID,
TARGET.GROSS_TRADE_SALES=SOURCE.GROSS_TRADE_SALES,
TARGET.INVENTORY_WITHDRAWALS=SOURCE.INVENTORY_WITHDRAWALS,
TARGET.ELIGIBLE_GROSS_TRADE_SALES=SOURCE.ELIGIBLE_GROSS_TRADE_SALES,
TARGET.PERIOD_BASIS_PRICE_CHANGE=SOURCE.PERIOD_BASIS_PRICE_CHANGE,
TARGET.GTS_ACCRUAL_BASIS=SOURCE.GTS_ACCRUAL_BASIS

		WHEN NOT MATCHED BY TARGET
		THEN 
		INSERT VALUES(SOURCE.PROJECTION_MASTER_SID,
SOURCE.ITEM_MASTER_SID,
SOURCE.PERIOD_SID,
SOURCE.COMPANY_MASTER_SID,
SOURCE.GROSS_TRADE_SALES,
SOURCE.INVENTORY_WITHDRAWALS,
SOURCE.ELIGIBLE_GROSS_TRADE_SALES,
SOURCE.PERIOD_BASIS_PRICE_CHANGE,
SOURCE.GTS_ACCRUAL_BASIS);;



MERGE    ACCRUAL_DETAILS_INFO	 AS TARGET
		USING ( 
		SELECT  PROJECTION_MASTER_SID,
                        ITEM_MASTER_SID,
                        PERIOD_SID,
                        COMPANY_MASTER_SID,
                        GROSS_TRADE_SALES,
                        INVENTORY_WITHDRAWALS,
                        ELIGIBLE_GROSS_TRADE_SALES,
                        PERIOD_BASIS_PRICE_CHANGE,
                        GTS_ACCRUAL_BASIS
		FROM dbo.ST_ACCRUAL_DETAILS_INFO
		WHERE USER_ID=@USER_ID AND SESSION_ID=@SESSION_ID
		) AS SOURCE 
		ON (TARGET.PROJECTION_MASTER_SID=SOURCE.PROJECTION_MASTER_SID
                    AND TARGET.ITEM_MASTER_SID = SOURCE.ITEM_MASTER_SID
                    AND TARGET.COMPANY_MASTER_SID = SOURCE.COMPANY_MASTER_SID
                    AND TARGET.PERIOD_SID = SOURCE.PERIOD_SID)
		WHEN MATCHED 
		THEN 
		UPDATE SET 
TARGET.ITEM_MASTER_SID=SOURCE.ITEM_MASTER_SID,
TARGET.PERIOD_SID=SOURCE.PERIOD_SID,
TARGET.COMPANY_MASTER_SID=SOURCE.COMPANY_MASTER_SID,
TARGET.GROSS_TRADE_SALES=SOURCE.GROSS_TRADE_SALES,
TARGET.INVENTORY_WITHDRAWALS=SOURCE.INVENTORY_WITHDRAWALS,
TARGET.ELIGIBLE_GROSS_TRADE_SALES=SOURCE.ELIGIBLE_GROSS_TRADE_SALES,
TARGET.PERIOD_BASIS_PRICE_CHANGE=SOURCE.PERIOD_BASIS_PRICE_CHANGE,
TARGET.GTS_ACCRUAL_BASIS=SOURCE.GTS_ACCRUAL_BASIS

		WHEN NOT MATCHED BY TARGET
		THEN 
		INSERT VALUES(SOURCE.PROJECTION_MASTER_SID,
SOURCE.ITEM_MASTER_SID,
SOURCE.PERIOD_SID,
SOURCE.COMPANY_MASTER_SID,
SOURCE.GROSS_TRADE_SALES,
SOURCE.INVENTORY_WITHDRAWALS,
SOURCE.ELIGIBLE_GROSS_TRADE_SALES,
SOURCE.PERIOD_BASIS_PRICE_CHANGE,
SOURCE.GTS_ACCRUAL_BASIS);;
       ]]>

    </sql>   
   
</custom-sql>
