<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->

<sql>
    <entity id="PAAdjustmentDetailReserveCountQuery">        
        <query>
            <![CDATA[
                DECLARE @FROM_PERIOD DATE, 
                        @GL_COMP     INT,
                        @PROJECTION_MASTER_SID INT = @PROJECTIONMASTER

                SELECT @FROM_PERIOD = FROM_DATE, 
                       @GL_COMP = COMPANY_MASTER_SID 
                FROM   PROJECTION_MASTER 
                WHERE  PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 

                IF OBJECT_ID('TEMPDB..#TEMP_PROJ_RES') IS NOT NULL 
                DROP TABLE #TEMP_PROJ_RES 

               CREATE TABLE #TEMP_PROJ_RES
                 ( 
                    BRAND_MASTER_SID    INT, 
                        BRAND_ID VARCHAR(50),
                        PERIOD_DATE DATETIME,
                    RS_CATEGORY         INT, 
                    RS_TYPE             INT, 
                    REBATE_PROGRAM_TYPE INT, 
                    ACCRUAL_AMOUNT      NUMERIC(22, 6), 
                    ACCRUAL_RATE        NUMERIC(22, 6) ,
                    PROJECTION_MASTER_SID INT,
                    WORKFLOW_MASTER_SID    INT NULL,
                    WORKFLOW_DESCRIPTION VARCHAR(500),
                    WORKFLOW_STATUS_ID INT,
                    WORKFLOW_ID VARCHAR(50)
                 ) 

               INSERT INTO #TEMP_PROJ_RES 
                           (BRAND_MASTER_SID, 
                                        BRAND_ID,
                                        PERIOD_DATE,
                            RS_CATEGORY, 
                            RS_TYPE, 
                            REBATE_PROGRAM_TYPE, 
                            ACCRUAL_AMOUNT, 
                            ACCRUAL_RATE,
                                        PROJECTION_MASTER_SID,
                                           WORKFLOW_ID,
                                             WORKFLOW_DESCRIPTION,
						  WORKFLOW_STATUS_ID) 
               SELECT IM.BRAND_MASTER_SID, 
                      BM.BRAND_ID,
                      P.PERIOD_DATE,
                      RS_CATEGORY, 
                      RS_TYPE, 
                      REBATE_PROGRAM_TYPE, 
                      SUM(ISNULL(B.[OVERRIDE], B.VARIANCE)) AS ACCRUAL_AMOUNT, 
                      SUM(B.RATE)                           AS ACCRUAL_RATE,
                          A.PROJECTION_MASTER_SID,
                             WORKFLOW_ID,
						  WORKFLOW_DESCRPTION,
						  WORKFLOW_STATUS_ID
               FROM   ARM_ADJUSTMENT_DETAILS A 
                      LEFT JOIN ARM_PIPELINE_RATE B 
                             ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID 
                                         LEFT JOIN PERIOD P ON P.PERIOD_SID=B.PERIOD_SID
                                        LEFT JOIN WORKFLOW_MASTER WM 
                             ON WM.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID 
                      JOIN CCP_DETAILS C 
                        ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID 
                      JOIN ITEM_MASTER IM 
                        ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID 
               JOIN BRAND_MASTER BM 
                      ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID ---------------------------------------------- Added for RS_CONTRACT
                      JOIN RS_CONTRACT R
                                     ON R.RS_MODEL_SID = A.RS_MODEL_SID
                                                         AND R.CONTRACT_MASTER_SID=C.CONTRACT_MASTER_SID
                      JOIN ARM_DEDUCTION_SELECTION ADS ON ADS.RS_CONTRACT_SID=R.RS_CONTRACT_SID
                            AND ADS.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID                                   
                            JOIN ARM_DEDUCTION_SELECTION ADS ON ADS.PROJECTION_MASTER_SID=A.PROJECTION_MASTER_SID AND ADS.RS_CONTRACT_SID=R.RS_CONTRACT_SID                               
               WHERE  A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 
               GROUP BY IM.BRAND_MASTER_SID, 
                        BM.BRAND_ID,
                        P.PERIOD_DATE,
                        RS_CATEGORY, 
                        RS_TYPE, 
                        REBATE_PROGRAM_TYPE ,
                        WORKFLOW_MASTER_SID,
                        A.PROJECTION_MASTER_SID,
                       WORKFLOW_ID,
                       WORKFLOW_DESCRPTION,
                       WORKFLOW_STATUS_ID
                ;WITH CTE 
                     AS (SELECT B.GL_IMPACT_DATE AS ACCOUNTING_DATE, 
                        BU.COMPANY_ID    AS BU_COMPANY_ID, 
                        BU.COMPANY_NO    AS BU_COMPANY_NO,
                        B.BU_COMPANY_MASTER_SID, 
                        A.BRAND_ID, 
                        A.PERIOD_DATE AS REDEMPTION_PERIOD,
                        GL.COMPANY_ID    AS GL_COMPANY_ID, 
                        GL.COMPANY_NO   AS GL_COMPANY_NO,
                        ARM_ADJ_RES_CONFIG_MASTER_SID, 
                        A.ACCRUAL_AMOUNT, 
                        PM.PROJECTION_DESCRIPTION,
                        A.WORKFLOW_ID ,
                        A.WORKFLOW_DESCRIPTION,
                        A.WORKFLOW_STATUS_ID,
                        PERIOD_DATE AS REDEMPTION_DATE
                 FROM   #TEMP_PROJ_RES A 
                        JOIN ARM_ADJUSTMENT_MASTER B 
                          ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
                        JOIN PROJECTION_MASTER PM 
                          ON PM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID 
                        JOIN COMPANY_MASTER BU 
                          ON BU.COMPANY_MASTER_SID = B.BU_COMPANY_MASTER_SID 
                        JOIN COMPANY_MASTER GL 
                          ON GL.COMPANY_MASTER_SID = PM.COMPANY_MASTER_SID 
                        JOIN ARM_ADJ_RES_CONFIG_MASTER AAM 
                          ON AAM.RS_CATEGORY = A.RS_CATEGORY 
                             AND AAM.RS_TYPE = A.RS_TYPE 
                             AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE 
                             AND PM.COMPANY_MASTER_SID = AAM.GL_COMPANY_MASTER_SID 
                             AND B.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID 
                             AND AAM.CONFIGURATION_TYPE = 0) 
                 @SELECT ;
            ]]>  
        </query>
        
    </entity>


    <entity id="PAAdjustmentDetailGTNCountQuery">
     
        <query>
            <![CDATA[
                 DECLARE @FROM_PERIOD DATE, 
                            @GL_COMP     INT,
                            @PROJECTION_MASTER_SID INT = @PROJECTIONMASTER

                    SELECT @FROM_PERIOD = FROM_DATE, 
                           @GL_COMP = COMPANY_MASTER_SID 
                    FROM   PROJECTION_MASTER 
                    WHERE  PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 


                    DECLARE @TEMP_PROJ_GTN AS TABLE 
                      ( 
                         ARM_ADJUSTMENT_DETAILS_SID INT, 
                         CCP_DETAILS_SID            INT, 
                         RS_MODEL_SID               INT, 
                         ACCRUAL_AMOUNT             NUMERIC(22, 6),
                         ACCRUAL_RATE               NUMERIC(22, 6)
                      ) 

                    INSERT INTO @TEMP_PROJ_GTN 
                                (ARM_ADJUSTMENT_DETAILS_SID, 
                                 CCP_DETAILS_SID, 
                                 RS_MODEL_SID, 
                                 ACCRUAL_AMOUNT,
                                             ACCRUAL_RATE) 
                    SELECT A.ARM_ADJUSTMENT_DETAILS_SID, 
                           A.CCP_DETAILS_SID, 
                           A.RS_MODEL_SID, 
                           SUM(ISNULL(B.[OVERRIDE],B.VARIANCE)) AS ACCRUAL_AMOUNT,
                               SUM(B.RATE) AS RATE
                    FROM   ARM_ADJUSTMENT_DETAILS A 
                           JOIN ARM_PIPELINE_RATE B 
                             ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID 
                    WHERE  PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
                    GROUP  BY A.ARM_ADJUSTMENT_DETAILS_SID, 
                              A.CCP_DETAILS_SID, 
                              A.RS_MODEL_SID 

                    IF OBJECT_ID('TEMPDB..#TEMP_GTN') IS NOT NULL 
                            DROP TABLE #TEMP_GTN 

                    CREATE TABLE #TEMP_GTN 
                      ( 
                         ARM_ADJUSTMENT_DETAILS INT, 
                         CONTRACT_MASTER_SID    INT, 
                         CONTRACT_ID            VARCHAR(50), 
                         CONTRACT_NO            VARCHAR(50), 
                         [CONTRACT_NAME]        VARCHAR(100), 
                         COMPANY_MASTER_SID     INT, 
                         COMPANY_ID             VARCHAR(50), 
                         COMPANY_NO             VARCHAR(50), 
                         COMPANY_NAME           VARCHAR(100), 
                         ITEM_MASTER_SID        INT, 
                         ITEM_ID                VARCHAR(50), 
                         ITEM_NO                VARCHAR(50), 
                         ITEM_NAME              VARCHAR(100), 
                         BRAND_MASTER_SID       INT, 
                         BRAND_ID               VARCHAR(50),
                           BRAND_NAME VARCHAR(100), 
                         RS_MODEL_SID           INT, 
                         RS_CATEGORY            VARCHAR(50), 
                         RS_TYPE                VARCHAR(50), 
                         REBATE_PROGRAM_TYPE    VARCHAR(50), 
                            DEDUCTION_INCLUSION     INT,
                         RS_ID                  VARCHAR(50), 
                         RS_NAME                VARCHAR(100), 
                         RS_NO                  VARCHAR(50), 
                            RS_UDC_1 INT, 
                         RS_UDC_2 INT, 
                         RS_UDC_3 INT, 
                         RS_UDC_4 INT, 
                         RS_UDC_5 INT, 
                         RS_UDC_6 INT,
                         PROJECTION_MASTER_SID  INT, 
                         WORKFLOW_MASTER_SID    INT NULL,
                         WORKFLOW_DESCRIPTION VARCHAR(500),
			WORKFLOW_STATUS_ID INT,
                       WORKFLOW_ID VARCHAR(50),
                         CREATED_DATE       DATETIME
                      ) 

                    INSERT INTO #TEMP_GTN 
                                (ARM_ADJUSTMENT_DETAILS, 
                                 CONTRACT_MASTER_SID, 
                                          CONTRACT_ID,
                                         CONTRACT_NO,
                                         [CONTRACT_NAME],
                                 COMPANY_MASTER_SID, 
                                          COMPANY_ID,
                                         COMPANY_NO,
                                         COMPANY_NAME,
                                 ITEM_MASTER_SID, 
                                          ITEM_ID,
                                         ITEM_NO,
                                         ITEM_NAME,
                                 BRAND_MASTER_SID, 
                                 BRAND_ID,
                                         BRAND_NAME,
                                 RS_MODEL_SID, 
                                 RS_CATEGORY, 
                                 RS_TYPE, 
                                 REBATE_PROGRAM_TYPE, 
                                 DEDUCTION_INCLUSION,
                                 RS_ID, 
                                          RS_NO,
                                 RS_NAME,
                                 RS_UDC_1,
                                         RS_UDC_2,
                                         RS_UDC_3,
                                         RS_UDC_4,
                                         RS_UDC_5,
                                         RS_UDC_6,
                                         PROJECTION_MASTER_SID,
                                 WORKFLOW_MASTER_SID,
                                 WORKFLOW_ID,WORKFLOW_DESCRIPTION,WORKFLOW_STATUS_ID,
                                 CREATED_DATE) 
                    SELECT     A.ARM_ADJUSTMENT_DETAILS_SID, 
                           C.CONTRACT_MASTER_SID,
                           CON.CONTRACT_ID,
                           CON.CONTRACT_NO,
                           CON.[CONTRACT_NAME], 
                           C.COMPANY_MASTER_SID,
                           CM.COMPANY_ID,
                           CM.COMPANY_NO,
                           CM.COMPANY_NAME,
                           C.ITEM_MASTER_SID,
                           IM.ITEM_ID,
                           IM.ITEM_NO,
                           IM.ITEM_NAME,
                           BM.BRAND_MASTER_SID, 
                           BM.BRAND_ID,
                           BM.BRAND_NAME,
                           A.RS_MODEL_SID, 
                           RS_CATEGORY, 
                           RS_TYPE, 
                               R.REBATE_PROGRAM_TYPE, 
                               R.DEDUCTION_INCLUSION,
                           R.RS_ID,
                           R.RS_NO,
                           R.RS_NAME,
                           U.UDC1 AS RS_UDC_1,
                           U.UDC2 AS RS_UDC_2,
                           U.UDC3 AS RS_UDC_3,
                           U.UDC4 AS RS_UDC_4,
                           U.UDC5 AS RS_UDC_5,
                           U.UDC6 AS RS_UDC_6,
                           A.PROJECTION_MASTER_SID,
                                 WM.WORKFLOW_MASTER_SID,WM.WORKFLOW_ID,WM.WORKFLOW_DESCRPTION,WM.WORKFLOW_STATUS_ID,
                               WM.CREATED_DATE
                    FROM   ARM_ADJUSTMENT_DETAILS A
                            JOIN CCP_DETAILS C
                              ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID
                            JOIN ITEM_MASTER IM
                              ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
                               JOIN COMPANY_MASTER CM
                                 ON CM.COMPANY_MASTER_SID=C.COMPANY_MASTER_SID
                               JOIN CONTRACT_MASTER CON ON CON.CONTRACT_MASTER_SID=C.CONTRACT_MASTER_SID
                               JOIN BRAND_MASTER BM
                              ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
                            JOIN RS_CONTRACT R
                               ON R.RS_MODEL_SID = A.RS_MODEL_SID
                               AND R.CONTRACT_MASTER_SID=C.CONTRACT_MASTER_SID
                            JOIN ARM_DEDUCTION_SELECTION ADS ON ADS.RS_CONTRACT_SID=R.RS_CONTRACT_SID
                                AND ADS.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
                               LEFT JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID=A.PROJECTION_MASTER_SID
                              LEFT  JOIN UDCS U ON U.MASTER_SID=R.RS_CONTRACT_SID AND U.MASTER_TYPE='RS_CONTRACT'
                     WHERE  A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 

                    SELECT  @SELECT
                    FROM   #TEMP_GTN A 
                    JOIN ARM_ADJUSTMENT_MASTER AM ON A.PROJECTION_MASTER_SID=AM.PROJECTION_MASTER_SID
                    LEFT JOIN @TEMP_PROJ_GTN TP ON TP.ARM_ADJUSTMENT_DETAILS_SID=A.ARM_ADJUSTMENT_DETAILS
                           JOIN ARM_ADJ_RES_CONFIG_MASTER AAM 
                             ON AAM.RS_CATEGORY = A.RS_CATEGORY 
                                AND AAM.RS_TYPE = A.RS_TYPE 
                                AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE 
                                AND AAM.GL_COMPANY_MASTER_SID = @GLCOMP
                                AND AM.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID 
                                         AND AAM.CONFIGURATION_TYPE=1
                           JOIN ARM_ADJ_RES_CONFIG_DETAIL AAD 
                             ON AAD.ARM_ADJ_RES_CONFIG_MASTER_SID = AAM.ARM_ADJ_RES_CONFIG_MASTER_SID 
                                     JOIN COMPANY_MASTER GL ON GL.COMPANY_MASTER_SID=@GLCOMP
                                  JOIN COMPANY_MASTER BU ON BU.COMPANY_MASTER_SID=AM.BU_COMPANY_MASTER_SID
                                     WHERE 
--TP.ACCRUAL_AMOUNT >0.01 AND 
AAD.ADJUSTMENT_TYPE = @ADJUSTMENT_TYPE AND AAD.ACCOUNT_CATEGORY IN (@CATEGORY) AND AAD.ACCOUNT_TYPE IN (@TYPE) AND AAD.ACCOUNT IN (@ACCOUNT)
                                  
                                  @PAGINATION
            ]]>  
        </query>
        
    </entity>
    

    <entity id="getReserveAccountPipeline">
        <query>
            <![CDATA[
                    SELECT DISTINCT ACCOUNT_CATEGORY,ACCOUNT_TYPE,ACCOUNT
                FROM ARM_ADJ_RES_CONFIG_DETAIL AD 
                JOIN ARM_ADJ_RES_CONFIG_MASTER AM ON AM.ARM_ADJ_RES_CONFIG_MASTER_SID = AD.ARM_ADJ_RES_CONFIG_MASTER_SID AND AM.CONFIGURATION_TYPE= ? AND AD.ADJUSTMENT_TYPE= ?
                JOIN RS_CONTRACT RS ON RS.RS_TYPE = AM.RS_TYPE AND RS.RS_CATEGORY = AM.RS_CATEGORY AND RS.REBATE_PROGRAM_TYPE = AM.REBATE_PROGRAM_TYPE
                JOIN ARM_DEDUCTION_SELECTION ADS 
	        ON ADS.RS_CONTRACT_SID=RS.RS_CONTRACT_SID AND ADS.PROJECTION_MASTER_SID= ?
                JOIN ARM_ADJUSTMENT_DETAILS AAD ON AAD.RS_MODEL_SID = RS.RS_MODEL_SID AND AAD.PROJECTION_MASTER_SID = ?
                AND GL_COMPANY_MASTER_SID = ? AND BU_COMPANY_MASTER_SID = ? ;
                ]]>
        </query>    
    </entity>
    <entity id="getloadworflowData">
        <query>
            <![CDATA[
            
            DECLARE @adjustmentType int

            SELECT @adjustmentType=TRANSACTION_TYPE FROM dbo.ARM_ADJUSTMENT_MASTER WHERE  PROJECTION_MASTER_SID = ?;
            
                    SELECT DISTINCT ACCOUNT_CATEGORY,ACCOUNT_TYPE,ACCOUNT,AD.ADJUSTMENT_TYPE
                FROM ARM_ADJ_RES_CONFIG_DETAIL AD 
                JOIN ARM_ADJ_RES_CONFIG_MASTER AM ON AM.ARM_ADJ_RES_CONFIG_MASTER_SID = AD.ARM_ADJ_RES_CONFIG_MASTER_SID AND AM.CONFIGURATION_TYPE= ? AND AD.ADJUSTMENT_TYPE= @adjustmentType
                JOIN RS_CONTRACT RS ON RS.RS_TYPE = AM.RS_TYPE AND RS.RS_CATEGORY = AM.RS_CATEGORY AND RS.REBATE_PROGRAM_TYPE = AM.REBATE_PROGRAM_TYPE
                JOIN ARM_DEDUCTION_SELECTION ADS 
	        ON ADS.RS_CONTRACT_SID=RS.RS_CONTRACT_SID AND ADS.PROJECTION_MASTER_SID= ?
                JOIN ARM_ADJUSTMENT_DETAILS AAD ON AAD.RS_MODEL_SID = RS.RS_MODEL_SID AND AAD.PROJECTION_MASTER_SID = ?
                AND GL_COMPANY_MASTER_SID = ? AND BU_COMPANY_MASTER_SID = ? ;
                ]]>
        </query>    
    </entity>
    <entity id="getloadworflowViewData">
        <query>
            <![CDATA[
            
                SELECT
                    DISTINCT ACCOUNT_CATEGORY,
                    ACCOUNT_TYPE,
                    ACCOUNT,
                    ACM.CONFIGURATION_TYPE
                FROM
                    ARM_ADJ_RES_CCP AR
                JOIN ARM_ADJUSTMENT_DETAILS AD ON
                        AD.ARM_ADJUSTMENT_DETAILS_SID = AR.ARM_ADJUSTMENT_DETAILS_SID
                JOIN ARM_ADJ_RES_CONFIG_MASTER ACM ON
                        AR.ARM_ADJ_RES_CONFIG_MASTER_SID = ACM.ARM_ADJ_RES_CONFIG_MASTER_SID
                WHERE
                        AD.PROJECTION_MASTER_SID = ?
                        AND ACM.CONFIGURATION_TYPE  = ?; 
                ]]>
        </query>    
    </entity>
    <entity id="getloadworkflowAdjustmentType">
        <query>
            <![CDATA[
            
            SELECT TRANSACTION_TYPE from ARM_ADJUSTMENT_MASTER WHERE PROJECTION_MASTER_SID = ?;
            
                ]]>
        </query>    
    </entity>
    <entity id="getReserveAccountSummary">
        <query>
            <![CDATA[
                SELECT DISTINCT ACCOUNT_CATEGORY,ACCOUNT_TYPE,ACCOUNT,ACCOUNT_DESC
                FROM ARM_ADJ_RES_CCP  AD 
                JOIN ARM_ADJ_RES_CONFIG_MASTER AM ON AM.ARM_ADJ_RES_CONFIG_MASTER_SID = AD.ARM_ADJ_RES_CONFIG_MASTER_SID AND AM.CONFIGURATION_TYPE= ? AND AD.ADJUSTMENT_TYPE IN ( ? )
                JOIN RS_CONTRACT RS ON RS.RS_TYPE = AM.RS_TYPE AND RS.RS_CATEGORY = AM.RS_CATEGORY AND RS.REBATE_PROGRAM_TYPE = AM.REBATE_PROGRAM_TYPE
                JOIN ARM_DEDUCTION_SELECTION ADS ON ADS.RS_CONTRACT_SID=RS.RS_CONTRACT_SID AND ADS.PROJECTION_MASTER_SID= ?
                JOIN ARM_ADJUSTMENT_DETAILS AAD ON AAD.RS_MODEL_SID = RS.RS_MODEL_SID AND AAD.PROJECTION_MASTER_SID = ?
                AND GL_COMPANY_MASTER_SID = ? AND BU_COMPANY_MASTER_SID = ? 
                Order BY ACCOUNT_DESC Desc;
                ]]>
        </query>    
    </entity>
    
    <entity id="ASAdjustmentDetailGTNCountQuery">
        <query>
            <![CDATA[
                DECLARE @PROJECTION_MASTER_SID INT = @PROJECTIONMASTER, 
                        @STATUS                VARCHAR(50)='@WORKFLOWSTATUS',
                        @FROM_DATE             DATETIME='@FROMDATE', 
                        @TO_DATE               DATETIME='@TODATE' ,
                        @CONFIGURATION_TYPE    INT = @CONFIGURATIONTYPE
                        
            IF OBJECT_ID('TEMPDB..#TEMP_PERIOD') IS NOT NULL
              DROP TABLE #TEMP_PERIOD

            CREATE TABLE #TEMP_PERIOD
              (
                 PERIOD_SID  INT PRIMARY KEY,
                 PERIOD_DATE DATETIME
              )

            INSERT INTO #TEMP_PERIOD
                        (PERIOD_SID,
                         PERIOD_DATE)
            SELECT PERIOD_SID,
                   PERIOD_DATE
            FROM   PERIOD
            WHERE  PERIOD_DATE BETWEEN @FROM_DATE AND @TO_DATE
            IF OBJECT_ID('TEMPDB..#TEMP_STATUS') IS NOT NULL
                             DROP TABLE #TEMP_STATUS
                            CREATE TABLE #TEMP_STATUS (
                                    [STATUS] VARCHAR(500)
                                    ,PRIMARY KEY ([STATUS])
                                    )

                            INSERT INTO #TEMP_STATUS ([STATUS])
                            SELECT CONVERT(VARCHAR(500), TOKEN)
                            FROM UDF_SPLITSTRING(@STATUS, ',')

            IF OBJECT_ID('TEMPDB..#TEMP_CCPD') IS NOT NULL
              DROP TABLE #TEMP_CCPD

            CREATE TABLE #TEMP_CCPD
              (
                 PROJECTION_MASTER_SID      INT,
                 ARM_ADJUSTMENT_DETAILS_SID INT,
                 CCP_DETAILS_SID            INT,
                              RS_MODEL_SID               INT,
                              COMPANY_MASTER_SID INT,
                              ITEM_MASTER_SID INT,
                              PRIMARY KEY (CCP_DETAILS_SID,RS_MODEL_SID)
              )

            INSERT INTO #TEMP_CCPD
                        (PROJECTION_MASTER_SID,
                         ARM_ADJUSTMENT_DETAILS_SID,
                                      A.CCP_DETAILS_SID,
                         RS_MODEL_SID)
            SELECT PROJECTION_MASTER_SID,
                   ARM_ADJUSTMENT_DETAILS_SID,
                                C.CCP_DETAILS_SID,
                   RS_MODEL_SID
                         FROM   ARM_ADJUSTMENT_DETAILS A JOIN CCP_DETAILS C ON C.CCP_DETAILS_SID=A.CCP_DETAILS_SID
                         JOIN ITEM_MASTER IM ON IM.ITEM_MASTER_SID=C.ITEM_MASTER_SID
                         JOIN COMPANY_MASTER COM ON COM.COMPANY_MASTER_SID=C.COMPANY_MASTER_SID
                         WHERE A.PROJECTION_MASTER_SID=@PROJECTION_MASTER_SID  

            IF OBJECT_ID('TEMPDB..#TEMP_ARM_APPRVD_PROJ') IS NOT NULL
              DROP TABLE #TEMP_ARM_APPRVD_PROJ

            CREATE TABLE #TEMP_ARM_APPRVD_PROJ
              (
                 ARM_ADJUSTMENT_DETAILS_SID        INT,
                 APPRVD_PROJECTION_MASTER_SID      INT,
                 APPRVD_ARM_ADJUSTMENT_DETAILS_SID INT,
                 CCP_DETAILS_SID                   INT,
                 RS_MODEL_SID                      INT,
                 ADJUSTMENT_TYPE                   VARCHAR(50),
                 ---PERIOD_SID                        INT,
                 WORKFLOW_CREATED_DATE             DATETIME,
                 WORKFLOW_ID                       VARCHAR(50),
                 WORKFLOW_STATUS                   INT,
                 WORKFLOW_NAME                     VARCHAR(500),
                 APPRVD_ARM_ADJUSTMENT_CONFIG_SID  INT,
                 APPRVD_TRANSACTION_NAME           VARCHAR(50),
                 APPRVD_METHODOLOGY                VARCHAR(50),
                 PRIMARY KEY ( APPRVD_ARM_ADJUSTMENT_DETAILS_SID, CCP_DETAILS_SID, RS_MODEL_SID )
              )

            INSERT INTO #TEMP_ARM_APPRVD_PROJ
                        (ARM_ADJUSTMENT_DETAILS_SID,
                         APPRVD_PROJECTION_MASTER_SID,
                         APPRVD_ARM_ADJUSTMENT_DETAILS_SID,
                         CCP_DETAILS_SID,
                         RS_MODEL_SID,
                         ADJUSTMENT_TYPE,
                         ---PERIOD_SID,
                         WORKFLOW_CREATED_DATE,
                         WORKFLOW_ID,
                         WORKFLOW_STATUS,
                         WORKFLOW_NAME,
                         APPRVD_ARM_ADJUSTMENT_CONFIG_SID,
                         APPRVD_TRANSACTION_NAME,
                         APPRVD_METHODOLOGY)
            SELECT CURRENT_SID,
                   PROJECTION_MASTER_SID,
                   APPRVED_SID,
                   CCP_DETAILS_SID,
                   RS_MODEL_SID,
                   ADJUSTMENT_TYPE,
                   ---PERIOD_SID,
                   CREATED_DATE AS WORKFLOW_CREATED_DATE,
                   WORKFLOW_ID,
                   WORKFLOW_STATUS,
                   WORKFLOW_NAME,
                   ARM_ADJUSTMENT_CONFIG_SID,
                   TRANSACTION_NAME,
                   METHODOLOGY
            FROM   (SELECT C.ARM_ADJUSTMENT_DETAILS_SID AS CURRENT_SID,
                           B.ARM_ADJUSTMENT_DETAILS_SID AS APPRVED_SID,
                           B.CCP_DETAILS_SID,
                           B.RS_MODEL_SID,
                           B.PROJECTION_MASTER_SID,
                           PM.FORECASTING_TYPE          AS ADJUSTMENT_TYPE,
                           ---P.PERIOD_SID,
                           A.CREATED_DATE,
                           A.WORKFLOW_ID,
                           A.WORKFLOW_STATUS_ID         AS WORKFLOW_STATUS,
                           PM.PROJECTION_DESCRIPTION    AS WORKFLOW_NAME,
                           ARM_ADJUSTMENT_CONFIG_SID,
                           TRANSACTION_NAME,
                           HT.DESCRIPTION               AS METHODOLOGY
                    FROM   WORKFLOW_MASTER A
                           JOIN ARM_ADJUSTMENT_DETAILS B
                             ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
                           JOIN ARM_ADJUSTMENT_MASTER AM
                             ON AM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
                           JOIN ARM_ADJUSTMENT_CONFIG AC
                             ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID
                           JOIN HELPER_TABLE HT
                             ON HT.HELPER_TABLE_SID = AC.METHODOLGY
                           JOIN PROJECTION_MASTER PM
                             ON PM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
                                AND PM.FROM_DATE >= @FROM_DATE
                                AND PM.TO_DATE <= @TO_DATE
                           JOIN #TEMP_CCPD C
                             ON C.CCP_DETAILS_SID = B.CCP_DETAILS_SID
                                AND C.RS_MODEL_SID = B.RS_MODEL_SID
                           ---CROSS JOIN #TEMP_PERIOD P
                            WHERE WORKFLOW_ID LIKE 'ARM%'
                                 AND WORKFLOW_STATUS_ID IN (SELECT
                                 HELPER_TABLE_SID
                                 FROM HELPER_TABLE H1
                                 INNER JOIN #TEMP_STATUS TS
                                 ON H1.DESCRIPTION = TS.[STATUS])) A

            IF OBJECT_ID('TEMPDB..#TEMP_STATUS_AMOUNT') IS NOT NULL
              DROP TABLE #TEMP_STATUS_AMOUNT

            CREATE TABLE #TEMP_STATUS_AMOUNT
              (
                 PROJECTION_MASTER_SID            INT,
                 ARM_ADJUSTMENT_DETAILS_SID       INT,
                 CCP_DETAILS_SID                  INT,
                 RS_MODEL_SID                     INT,
                 ADJUSTMENT_TYPE                  VARCHAR(50),
                 PERIOD_SID                       INT,
                 WORKFLOW_CREATED_DATE            DATETIME,
                 WORKFLOW_ID                      VARCHAR(50),
                 WORKFLOW_STATUS                  INT,
                 WORKFLOW_NAME                    VARCHAR(500),
                 AMOUNT NUMERIC(22,6),
                              RATE NUMERIC(22,6),
                 PIPELINE_ACCRUAL_RATE            NUMERIC(22, 6),
                 PIPELINE_INVENTORY_RATE          NUMERIC(22, 6),
                 DEMAND_ACCRUAL_RATE              NUMERIC(22, 6),
                 DEMAND_REFORECAST_RATE           NUMERIC(22, 6),
                 DEMAND_PAYMENT_RECON_RATE        NUMERIC(22, 6),
                 APPRVD_ARM_ADJUSTMENT_CONFIG_SID INT,
                 APPRVD_TRANSACTION_NAME          VARCHAR(50),
                 APPRVD_METHODOLOGY               VARCHAR(50)
              )

            INSERT INTO #TEMP_STATUS_AMOUNT
                        (PROJECTION_MASTER_SID,
                         ARM_ADJUSTMENT_DETAILS_SID,
                         CCP_DETAILS_SID,
                         RS_MODEL_SID,
                         ADJUSTMENT_TYPE,
                         PERIOD_SID,
                         WORKFLOW_CREATED_DATE,
                         WORKFLOW_ID,
                         WORKFLOW_STATUS,
                         WORKFLOW_NAME,
                         AMOUNT,
                         RATE,
                         APPRVD_ARM_ADJUSTMENT_CONFIG_SID,
                         APPRVD_TRANSACTION_NAME,
                         APPRVD_METHODOLOGY)
            SELECT A.APPRVD_PROJECTION_MASTER_SID,
                   A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID,
                   A.CCP_DETAILS_SID,
                   A.RS_MODEL_SID,
                   A.ADJUSTMENT_TYPE,
                   CASE
                   WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 1' THEN B.PERIOD_SID
                   WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 2' THEN D.PERIOD_SID
                   WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 3' THEN C.PERIOD_SID
                   WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 4' THEN E.PERIOD_SID
                   WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 5' THEN F.PERIOD_SID
                   WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 6' THEN AIA.PERIOD_SID
                   ELSE ADF.PERIOD_SID END AS PERIOD_SID,
                   A.WORKFLOW_CREATED_DATE,
                   A.WORKFLOW_ID,
                   A.WORKFLOW_STATUS,
                   A.WORKFLOW_NAME,
                    CASE
          WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 1' THEN SUM(ISNULL(B.OVERRIDE, B.VARIANCE))
          WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 2' THEN SUM(ISNULL(D.OVERRIDE, D.VARIANCE))
          WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 3' THEN SUM(ISNULL(C.OVERRIDE, C.VARIANCE))
          WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 4' THEN SUM(ISNULL(E.OVERRIDE, E.VARIANCE))
          WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 5' THEN SUM(ISNULL(F.OVERRIDE, F.VARIANCE))
          WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 6' THEN SUM(ISNULL(AIA.OVERRIDE, AIA.VARIANCE))
          ELSE SUM(ISNULL(ADF.OVERRIDE, ADF.VARIANCE)) END AS AMOUNT,
                 CASE
          WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 1' THEN SUM(ISNULL(B.RATE, 0))
          WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 2' THEN SUM(ISNULL(D.PROJECTED_RATE, 0))
          WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 3' THEN SUM(ISNULL(C.RATE, 0))
          WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 4' THEN SUM(ISNULL(E.PROJECTED_RATE, 0))
          WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 5' THEN SUM(ISNULL(F.PROJECTED_RATE, 0))
          WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 6' THEN NULL
          ELSE  SUM(ISNULL(ADF.RATE, 0)) END AS RATE,
                   APPRVD_ARM_ADJUSTMENT_CONFIG_SID,
                   APPRVD_TRANSACTION_NAME,
                   APPRVD_METHODOLOGY
             FROM   #TEMP_ARM_APPRVD_PROJ A
              JOIN #TEMP_CCPD TC ON TC.CCP_DETAILS_SID=A.CCP_DETAILS_SID AND A.RS_MODEL_SID=TC.RS_MODEL_SID
                   LEFT JOIN ARM_PIPELINE_RATE B
                          ON A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
                             ---AND A.PERIOD_SID = B.PERIOD_SID
                   LEFT JOIN ARM_INVENTORY_RATE C
                          ON C.ARM_ADJUSTMENT_DETAILS_SID = A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID
                             ---AND C.PERIOD_SID = A.PERIOD_SID
                   LEFT JOIN ARM_DEMAND_ADJ_SUMMARY D
                          ON D.ARM_ADJUSTMENT_DETAILS_SID = A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID
                             ---AND D.PERIOD_SID = A.PERIOD_SID
                   LEFT JOIN ARM_DEMAND_RECON_SUMMARY E
                          ON E.ARM_ADJUSTMENT_DETAILS_SID = A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID
                             ---AND E.PERIOD_SID = A.PERIOD_SID
                   LEFT JOIN ARM_DEMAND_RF_TRUE_UP_SUMMARY F
                          ON F.ARM_ADJUSTMENT_DETAILS_SID = A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID
                             ---AND F.PERIOD_SID = A.PERIOD_SID
                   LEFT JOIN ARM_INFLATION_INVENTORY_ADJ AIA
               ON AIA.ARM_ADJUSTMENT_DETAILS_SID = A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID
                  ---AND AIA.PERIOD_SID = A.PERIOD_SID
                  LEFT JOIN ARM_INFLATION_INVENTORY AII 
                      ON AII.PROJECTION_MASTER_SID=A.APPRVD_PROJECTION_MASTER_SID 
                            AND AII.COMPANY_MASTER_SID=TC.COMPANY_MASTER_SID
        LEFT JOIN ARM_DISTRIBUTION_FEES_RATE ADF
               ON ADF.ARM_ADJUSTMENT_DETAILS_SID = A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID
                  ---AND ADF.PERIOD_SID = A.PERIOD_SID
            GROUP  BY A.APPRVD_PROJECTION_MASTER_SID,
                               A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID,
                      A.CCP_DETAILS_SID,
                      A.RS_MODEL_SID,
                      A.ADJUSTMENT_TYPE,
                      CASE
                      WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 1' THEN B.PERIOD_SID
                      WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 2' THEN D.PERIOD_SID
                      WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 3' THEN C.PERIOD_SID
                      WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 4' THEN E.PERIOD_SID
                      WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 5' THEN F.PERIOD_SID
                      WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 6' THEN AIA.PERIOD_SID
                      ELSE ADF.PERIOD_SID END,
                      A.WORKFLOW_CREATED_DATE,
                      A.WORKFLOW_ID,
                      A.WORKFLOW_STATUS,
                      A.WORKFLOW_NAME,
                      APPRVD_ARM_ADJUSTMENT_CONFIG_SID,
                      APPRVD_TRANSACTION_NAME,
                      APPRVD_METHODOLOGY

            IF OBJECT_ID('TEMPDB..#TEMP_GTN') IS NOT NULL
              DROP TABLE #TEMP_GTN

            CREATE TABLE #TEMP_GTN
              (
                 ARM_ADJUSTMENT_DETAILS           INT,
                 PERIOD_SID                       INT,
                 CONTRACT_MASTER_SID              INT,
                 CONTRACT_ID                      VARCHAR(50),
                 CONTRACT_NO                      VARCHAR(50),
                 [CONTRACT_NAME]                  VARCHAR(100),
                 COMPANY_MASTER_SID               INT,
                 COMPANY_ID                       VARCHAR(50),
                 COMPANY_NO                       VARCHAR(50),
                 COMPANY_NAME                     VARCHAR(100),
                 ITEM_MASTER_SID                  INT,
                 ITEM_ID                          VARCHAR(50),
                 ITEM_NO                          VARCHAR(50),
                 ITEM_NAME                        VARCHAR(100),
                 BRAND_MASTER_SID                 INT,
                 BRAND_ID                         VARCHAR(50),
                 BRAND_NAME                       VARCHAR(100),
                 RS_MODEL_SID                     INT,
                 RS_CATEGORY                      VARCHAR(50),
                 RS_TYPE                          VARCHAR(50),
                 REBATE_PROGRAM_TYPE              VARCHAR(50),
                 DEDUCTION_INCLUSION              VARCHAR(50),
                 RS_ID                            VARCHAR(50),
                 RS_NAME                          VARCHAR(100),
                 RS_NO                            VARCHAR(50),
                 RS_UDC_1                         INT,
                 RS_UDC_2                         INT,
                 RS_UDC_3                         INT,
                 RS_UDC_4                         INT,
                 RS_UDC_5                         INT,
                 RS_UDC_6                         INT,
                 PROJECTION_MASTER_SID            INT,
                 WORKFLOW_CREATED_DATE            DATETIME,
                 WORKFLOW_ID                      VARCHAR(50),
                 WORKFLOW_STATUS                  INT,
                 WORKFLOW_NAME                    VARCHAR(500),
                 APPRVD_ARM_ADJUSTMENT_CONFIG_SID INT,
                 APPRVD_TRANSACTION_NAME          VARCHAR(50),
                 APPRVD_METHODOLOGY               VARCHAR(50)
              )

            INSERT INTO #TEMP_GTN
                        (ARM_ADJUSTMENT_DETAILS,
                         PERIOD_SID,
                         CONTRACT_MASTER_SID,
                         CONTRACT_ID,
                         CONTRACT_NO,
                         [CONTRACT_NAME],
                         COMPANY_MASTER_SID,
                         COMPANY_ID,
                         COMPANY_NO,
                         COMPANY_NAME,
                         ITEM_MASTER_SID,
                         ITEM_ID,
                         ITEM_NO,
                         ITEM_NAME,
                         BRAND_MASTER_SID,
                         BRAND_ID,
                         BRAND_NAME,
                         RS_MODEL_SID,
                         RS_CATEGORY,
                         RS_TYPE,
                         REBATE_PROGRAM_TYPE,
                                              DEDUCTION_INCLUSION,
                         RS_ID,
                         RS_NO,
                         RS_NAME,
                         RS_UDC_1,
                         RS_UDC_2,
                         RS_UDC_3,
                         RS_UDC_4,
                         RS_UDC_5,
                         RS_UDC_6,
                         PROJECTION_MASTER_SID,
                         WORKFLOW_CREATED_DATE,
                         WORKFLOW_ID,
                         WORKFLOW_STATUS,
                         WORKFLOW_NAME,
                         APPRVD_ARM_ADJUSTMENT_CONFIG_SID,
                         APPRVD_TRANSACTION_NAME,
                         APPRVD_METHODOLOGY)
            SELECT A.ARM_ADJUSTMENT_DETAILS_SID,
                   A.PERIOD_SID,
                   C.CONTRACT_MASTER_SID,
                   CON.CONTRACT_ID,
                   CON.CONTRACT_NO,
                   CON.[CONTRACT_NAME],
                   C.COMPANY_MASTER_SID,
                   CM.COMPANY_ID,
                   CM.COMPANY_NO,
                   CM.COMPANY_NAME,
                   C.ITEM_MASTER_SID,
                   IM.ITEM_ID,
                   IM.ITEM_NO,
                   IM.ITEM_NAME,
                   BM.BRAND_MASTER_SID,
                   BM.BRAND_ID,
                   BM.BRAND_NAME,
                   A.RS_MODEL_SID,
                   RS_CATEGORY,
                   RS_TYPE,
                   REBATE_PROGRAM_TYPE,
                                HT.DESCRIPTION,
                   R.RS_ID,
                   R.RS_NO,
                   R.RS_NAME,
                   U.UDC1 AS RS_UDC_1,
                   U.UDC2 AS RS_UDC_2,
                   U.UDC3 AS RS_UDC_3,
                   U.UDC4 AS RS_UDC_4,
                   U.UDC5 AS RS_UDC_5,
                   U.UDC6 AS RS_UDC_6,
                   A.PROJECTION_MASTER_SID,
                   A.WORKFLOW_CREATED_DATE,
                   A.WORKFLOW_ID,
                   A.WORKFLOW_STATUS,
                   A.WORKFLOW_NAME,
                   A.APPRVD_ARM_ADJUSTMENT_CONFIG_SID,
                   A.APPRVD_TRANSACTION_NAME,
                   A.APPRVD_METHODOLOGY
            FROM   #TEMP_STATUS_AMOUNT A
                   JOIN CCP_DETAILS C
                     ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID
                   JOIN ITEM_MASTER IM
                     ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
                   JOIN COMPANY_MASTER CM
                     ON CM.COMPANY_MASTER_SID = C.COMPANY_MASTER_SID
                   JOIN CONTRACT_MASTER CON
                     ON CON.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID
                   JOIN BRAND_MASTER BM
                     ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
                   JOIN RS_CONTRACT R
                     ON R.RS_MODEL_SID = A.RS_MODEL_SID
                        AND R.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID
                   JOIN ARM_DEDUCTION_SELECTION ADS
                     ON ADS.RS_CONTRACT_SID = R.RS_CONTRACT_SID
                        AND ADS.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID
                               JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=R.DEDUCTION_INCLUSION
                   LEFT JOIN UDCS U
                     ON U.MASTER_SID = R.RS_CONTRACT_SID
                        AND U.MASTER_TYPE = 'RS_CONTRACT'
        
                @SELECT 
                @PAGINATION 
                ]]>
        </query>    
    </entity>
    
    <entity id="ASAdjustmentDetailGTNLoadDataQuery">
        <query>
            <![CDATA[

                SELECT  TP.APPRVD_TRANSACTION_NAME AS ADJUSTMENT_TYPE,
                          RTYPE.DESCRIPTION                             AS DEDUCTION_TYPE,
                          MONTH(GL_IMPACT_DATE)                 AS GL_MONTH,
                          YEAR(GL_IMPACT_DATE)                  AS GL_YEAR,
                          
                          GL.COMPANY_ID+' - '+ CASE WHEN (AAD.DIVISION='' OR AAd.DIVISION IS NULL) THEN +AAD.COST_CENTER+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2 
                                                                ELSE AAD.DIVISION+' - '+AAD.COST_CENTER+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
                          END AS GL_STRING,
                          GL.COMPANY_ID                         AS GL_COMPANY_ID,
                          AAD.DIVISION                          AS DIVISON,
                          BU.COMPANY_ID                         AS BUSINESS_UNIT_ID,
                          AAD.COST_CENTER                       AS COST_CENTER,
                          AAD.ACCOUNT                           AS ACCOUNT,
                          A.BRAND_ID                            AS BRAND_ID,
                          AAD.PROJECT                           AS PROJECT,
                          AAD.FUTURE_1                          AS FUTURE_1,
                          AAD.FUTURE_2                          AS FUTURE_2,
                          A.ITEM_NO                             AS ITEM_NO,
                          TP.AMOUNT				AS DEDUCTION_AMOUNT,
                          GL.COMPANY_NO                         AS GL_COMPANY_NO,
                          GL.COMPANY_NAME                       AS GL_COMPANY_NAME,
                          BU.COMPANY_NO                         AS BUSINESS_UNIT_NO,
                          BU.COMPANY_NAME                       AS BUSINESS_UNIT_NAME,
                          GL_IMPACT_DATE                        AS GLDATE,
                          A.WORKFLOW_CREATED_DATE               AS CREATED_DATE,
                          REDEMPTION_DATE=CASE WHEN AAC.REDEMPTION_PERIOD=1 THEN  P.PERIOD_DATE ELSE NULL END,
                          A.CONTRACT_ID                         AS CONTRACT_ID,
                          A.CONTRACT_NO                         AS CONTRACT_NO,
                          A.CONTRACT_NAME                       AS CONTRACT_NAME,
                          A.COMPANY_ID                          AS COMPANY_ID,
                          A.COMPANY_NO                          AS COMPANY_NO,
                          A.COMPANY_NAME                        AS COMPANY_NAME,
                          A.ITEM_ID                             AS ITEM_ID,
                          A.ITEM_NAME                           AS ITEM_NAME,
                          A.BRAND_NAME                          AS BRAND_NAME,
                          A.RS_ID                               AS DEDUCTION_ID,
                          A.RS_NO                               AS DEDUCTION_NO,
                          A.RS_NAME                             AS DEDUCTION_NAME,
                          A.RS_CATEGORY                         AS DEDUCTION_CATEGORY,
                          A.REBATE_PROGRAM_TYPE                 AS DEDUCTION_PROGRAM,
                          A.DEDUCTION_INCLUSION                 AS DEDUCTION_INCLUSION,
                          A.RS_UDC_1                            AS DEDUCTION_UDC_1,
                          A.RS_UDC_2                            AS DEDUCTION_UDC_2,
                          A.RS_UDC_3                            AS DEDUCTION_UDC_3,
                          A.RS_UDC_4                            AS DEDUCTION_UDC_4,
                          A.RS_UDC_5                            AS DEDUCTION_UDC_5,
                          A.RS_UDC_6                            AS DEDUCTION_UDC_6,
                          TP.RATE				AS DEDUCTION_RATE,
                          UDC1.DESCRIPTION                             AS UDC_1,
                          AAD.UDC_2                             AS UDC_2,
                          AAD.UDC_3                             AS UDC_3,
                          AAD.UDC_4                             AS UDC_4,
                          AAD.UDC_5                             AS UDC_5,
                          AAD.UDC_6                             AS UDC_6,
                          AAD.ACCOUNT_TYPE                      AS ACCOUNT_TYPE,
                          AAD.ACCOUNT_CATEGORY                  AS ACCOUNT_CATEGORY,
                          AAD.ADJUSTMENT_LEVEL                  AS ADJUSTMENT_LEVEL,
                          AAD.ACCOUNT_DESC 			AS ACCOUNT_DESCRIPTION,
			  AAD.ACCOUNT_INDICATOR 		AS ACCOUNT_INDICATOR,
                          P.PERIOD_DATE                         AS CALCULATION_PERIOD,
                          A.WORKFLOW_ID				AS WORKFLOW_ID,
                          A.WORKFLOW_NAME			AS WORKFLOW_NAME,
                          A.WORKFLOW_STATUS    			AS WORKFLOW_STATUS

                  FROM   #TEMP_GTN A
                         JOIN ARM_ADJUSTMENT_MASTER AM
                           ON A.PROJECTION_MASTER_SID = AM.PROJECTION_MASTER_SID
                            JOIN ARM_ADJUSTMENT_CONFIG AAC ON AAC.ARM_ADJUSTMENT_CONFIG_SID=AM.TRANSACTION_TYPE
                         JOIN #TEMP_STATUS_AMOUNT TP
                           ON TP.ARM_ADJUSTMENT_DETAILS_SID = A.ARM_ADJUSTMENT_DETAILS
                              AND TP.PERIOD_SID = A.PERIOD_SID
                          AND A.WORKFLOW_ID = TP.WORKFLOW_ID
                         JOIN #TEMP_PERIOD P
                           ON P.PERIOD_SID = TP.PERIOD_SID
                         JOIN ARM_ADJ_RES_CONFIG_MASTER AAM
                           ON AAM.RS_CATEGORY = A.RS_CATEGORY
                              AND AAM.RS_TYPE = A.RS_TYPE
                              AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE
                             AND AAM.GL_COMPANY_MASTER_SID = @GLCOMP 
                              AND AM.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID
                             AND AM.CONFIGURATION_TYPE = @CONFIGURATIONTYPE
                         JOIN ARM_ADJ_RES_CCP AAD
                           ON AAD.ARM_ADJ_RES_CONFIG_MASTER_SID = AAM.ARM_ADJ_RES_CONFIG_MASTER_SID
                         JOIN COMPANY_MASTER GL
                          ON GL.COMPANY_MASTER_SID = @GLCOMP 
                         JOIN COMPANY_MASTER BU
                           ON BU.COMPANY_MASTER_SID = AM.BU_COMPANY_MASTER_SID
			AND A.ARM_ADJUSTMENT_DETAILS = AAD.ARM_ADJUSTMENT_DETAILS_SID
                        LEFT JOIN HELPER_TABLE UDC1		
                  ON UDC1.HELPER_TABLE_SID = AAD.UDC_1		
                  LEFT JOIN HELPER_TABLE RTYPE ON RTYPE.HELPER_TABLE_SID=A.RS_TYPE
                 WHERE  AAD.ACCOUNT_CATEGORY IN ( @CATEGORY ) AND AAD.ACCOUNT_TYPE IN ( @TYPE ) AND AAD.ACCOUNT IN ( @ACCOUNT ) AND AAD.ACCOUNT_DESC IN ( @ACCDESC ) 
                 AND AAD.ADJUSTMENT_LEVEL = @ADJUSTMENT_LEVEL
                 AND TP.APPRVD_TRANSACTION_NAME in (@ADJUSTMENT_TYPE)

                ]]>
        </query>    
    </entity>
    
   
    

    <entity id="ASAdjustmentDetailReserveCountQuery">        
        <query>
            <![CDATA[
                 DECLARE @PROJECTION_MASTER_SID INT = @PROJECTIONMASTER,
                        @STATUS                VARCHAR(50)='@WORKFLOWSTATUS',
                        @FROM_DATE             DATETIME='@FROMDATE', 
                        @TO_DATE               DATETIME='@TODATE' ,
                        @CONFIGURATION_TYPE    INT = @CONFIGURATIONTYPE
                        IF OBJECT_ID('TEMPDB..#TEMP_PERIOD') IS NOT NULL
                            DROP TABLE #TEMP_PERIOD

                          CREATE TABLE #TEMP_PERIOD
                            (
                               PERIOD_SID  INT PRIMARY KEY,
                               PERIOD_DATE DATETIME
                            )

                          INSERT INTO #TEMP_PERIOD
                                      (PERIOD_SID,
                                       PERIOD_DATE)
                          SELECT PERIOD_SID,
                                 PERIOD_DATE
                          FROM   PERIOD
                          WHERE  PERIOD_DATE BETWEEN @FROM_DATE AND @TO_DATE

                           IF OBJECT_ID('TEMPDB..#TEMP_STATUS') IS NOT NULL
                             DROP TABLE #TEMP_STATUS
                            CREATE TABLE #TEMP_STATUS (
                                    [STATUS] VARCHAR(500)
                                    ,PRIMARY KEY ([STATUS])
                                    )

                            INSERT INTO #TEMP_STATUS ([STATUS])
                            SELECT CONVERT(VARCHAR(500), TOKEN)
                            FROM UDF_SPLITSTRING(@STATUS, ',')

                          IF OBJECT_ID('TEMPDB..#TEMP_CCPD') IS NOT NULL
                            DROP TABLE #TEMP_CCPD

                          CREATE TABLE #TEMP_CCPD
                            (
                               PROJECTION_MASTER_SID      INT,
                               ARM_ADJUSTMENT_DETAILS_SID INT,
                               CCP_DETAILS_SID            INT,
                              RS_MODEL_SID               INT,
                              COMPANY_MASTER_SID INT,
                              ITEM_MASTER_SID INT,
                              PRIMARY KEY (CCP_DETAILS_SID,RS_MODEL_SID)
                            )

                          INSERT INTO #TEMP_CCPD
                                      (PROJECTION_MASTER_SID,
                                       ARM_ADJUSTMENT_DETAILS_SID,
                                      A.CCP_DETAILS_SID,
                                       RS_MODEL_SID)
                          SELECT PROJECTION_MASTER_SID,
                                 ARM_ADJUSTMENT_DETAILS_SID,
                                C.CCP_DETAILS_SID,
                                 RS_MODEL_SID
                         FROM   ARM_ADJUSTMENT_DETAILS A JOIN CCP_DETAILS C ON C.CCP_DETAILS_SID=A.CCP_DETAILS_SID
                         JOIN ITEM_MASTER IM ON IM.ITEM_MASTER_SID=C.ITEM_MASTER_SID
                         JOIN COMPANY_MASTER COM ON COM.COMPANY_MASTER_SID=C.COMPANY_MASTER_SID
						 WHERE A.PROJECTION_MASTER_SID=@PROJECTION_MASTER_SID  

                          IF OBJECT_ID('TEMPDB..#TEMP_ARM_APPRVD_PROJ') IS NOT NULL
                            DROP TABLE #TEMP_ARM_APPRVD_PROJ

                          CREATE TABLE #TEMP_ARM_APPRVD_PROJ
                            (
                               ARM_ADJUSTMENT_DETAILS_SID        INT,
                               APPRVD_PROJECTION_MASTER_SID      INT,
                               APPRVD_ARM_ADJUSTMENT_DETAILS_SID INT,
                               CCP_DETAILS_SID                   INT,
                               RS_MODEL_SID                      INT,
                               ADJUSTMENT_TYPE                   VARCHAR(50),
                               ---PERIOD_SID                        INT,
                               WORKFLOW_CREATED_DATE             DATETIME,
                               WORKFLOW_ID                       VARCHAR(50),
                               WORKFLOW_STATUS                   INT,
                               WORKFLOW_NAME                     VARCHAR(500),
                               APPRVD_ARM_ADJUSTMENT_CONFIG_SID  INT,
                               APPRVD_TRANSACTION_NAME           VARCHAR(50),
                               APPRVD_METHODOLOGY                VARCHAR(50),
                               PRIMARY KEY ( APPRVD_ARM_ADJUSTMENT_DETAILS_SID, CCP_DETAILS_SID, RS_MODEL_SID )
                            )

                          INSERT INTO #TEMP_ARM_APPRVD_PROJ
                                      (ARM_ADJUSTMENT_DETAILS_SID,
                                       APPRVD_PROJECTION_MASTER_SID,
                                       APPRVD_ARM_ADJUSTMENT_DETAILS_SID,
                                       CCP_DETAILS_SID,
                                       RS_MODEL_SID,
                                       ADJUSTMENT_TYPE,
                                       ---PERIOD_SID,
                                       WORKFLOW_CREATED_DATE,
                                       WORKFLOW_ID,
                                       WORKFLOW_STATUS,
                                       WORKFLOW_NAME,
                                       APPRVD_ARM_ADJUSTMENT_CONFIG_SID,
                                       APPRVD_TRANSACTION_NAME,
                                       APPRVD_METHODOLOGY)
                          SELECT CURRENT_SID,
                                 PROJECTION_MASTER_SID,
                                 APPRVED_SID,
                                 CCP_DETAILS_SID,
                                 RS_MODEL_SID,
                                 ADJUSTMENT_TYPE,
                                 ---PERIOD_SID,
                                 CREATED_DATE AS WORKFLOW_CREATED_DATE,
                                 WORKFLOW_ID,
                                 WORKFLOW_STATUS,
                                 WORKFLOW_NAME,
                                 ARM_ADJUSTMENT_CONFIG_SID,
                                 TRANSACTION_NAME,
                                 METHODOLOGY
                          FROM   (SELECT C.ARM_ADJUSTMENT_DETAILS_SID AS CURRENT_SID,
                                         B.ARM_ADJUSTMENT_DETAILS_SID AS APPRVED_SID,
                                         B.CCP_DETAILS_SID,
                                         B.RS_MODEL_SID,
                                         B.PROJECTION_MASTER_SID,
                                         PM.FORECASTING_TYPE          AS ADJUSTMENT_TYPE,
                                         ---P.PERIOD_SID,
                                         A.CREATED_DATE,
                                         A.WORKFLOW_ID,
                                         A.WORKFLOW_STATUS_ID         AS WORKFLOW_STATUS,
                                         NULL                         AS WORKFLOW_NAME,
                                         ARM_ADJUSTMENT_CONFIG_SID,
                                         TRANSACTION_NAME,
                                         HT.DESCRIPTION               AS METHODOLOGY
                                  FROM   WORKFLOW_MASTER A
                                         JOIN ARM_ADJUSTMENT_DETAILS B
                                           ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
                                         JOIN ARM_ADJUSTMENT_MASTER AM
                                           ON AM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
                                         JOIN ARM_ADJUSTMENT_CONFIG AC
                                           ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID
                                         JOIN HELPER_TABLE HT
                                           ON HT.HELPER_TABLE_SID = AC.METHODOLGY
                                         JOIN PROJECTION_MASTER PM
                                           ON PM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
                                              AND PM.FROM_DATE >= @FROM_DATE
                                              AND PM.TO_DATE <= @TO_DATE
                                         JOIN #TEMP_CCPD C
                                           ON C.CCP_DETAILS_SID = B.CCP_DETAILS_SID
                                              AND C.RS_MODEL_SID = B.RS_MODEL_SID
                                         ---CROSS JOIN #TEMP_PERIOD P
                                         WHERE WORKFLOW_ID LIKE 'ARM%'
                                        AND WORKFLOW_STATUS_ID IN (SELECT
                                        HELPER_TABLE_SID
                                        FROM HELPER_TABLE H1
                                        INNER JOIN #TEMP_STATUS TS
                                        ON H1.DESCRIPTION = TS.[STATUS])) A
	
                          IF OBJECT_ID('TEMPDB..#TEMP_STATUS_AMOUNT') IS NOT NULL
                            DROP TABLE #TEMP_STATUS_AMOUNT

                          CREATE TABLE #TEMP_STATUS_AMOUNT
                            (
                               PROJECTION_MASTER_SID            INT,
                               ARM_ADJUSTMENT_DETAILS_SID       INT,
                               CCP_DETAILS_SID                  INT,
                               RS_MODEL_SID                     INT,
                               ADJUSTMENT_TYPE                  VARCHAR(50),
                               PERIOD_SID                       INT,
                               WORKFLOW_CREATED_DATE            DATETIME,
                               WORKFLOW_ID                      VARCHAR(50),
                               WORKFLOW_STATUS                  INT,
                               WORKFLOW_NAME                    VARCHAR(500),
                              AMOUNT NUMERIC(22,6),
                               RATE NUMERIC(22,6),
                               APPRVD_ARM_ADJUSTMENT_CONFIG_SID INT,
                               APPRVD_TRANSACTION_NAME          VARCHAR(50),
                               APPRVD_METHODOLOGY               VARCHAR(50)
                            )

                          INSERT INTO #TEMP_STATUS_AMOUNT
                                      (PROJECTION_MASTER_SID,
                                       ARM_ADJUSTMENT_DETAILS_SID,
                                       CCP_DETAILS_SID,
                                       RS_MODEL_SID,
                                       ADJUSTMENT_TYPE,
                                       PERIOD_SID,
                                       WORKFLOW_CREATED_DATE,
                                       WORKFLOW_ID,
                                       WORKFLOW_STATUS,
                                       WORKFLOW_NAME,
                                       AMOUNT,
                                       RATE,
                                       APPRVD_ARM_ADJUSTMENT_CONFIG_SID,
                                       APPRVD_TRANSACTION_NAME,
                                       APPRVD_METHODOLOGY)
                          SELECT A.APPRVD_PROJECTION_MASTER_SID,
                                 A.ARM_ADJUSTMENT_DETAILS_SID,
                                 A.CCP_DETAILS_SID,
                                 A.RS_MODEL_SID,
                                 A.ADJUSTMENT_TYPE,
                                 CASE
                                 WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 1' THEN B.PERIOD_SID
                                 WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 2' THEN D.PERIOD_SID
                                 WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 3' THEN C.PERIOD_SID
                                 WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 4' THEN E.PERIOD_SID
                                 WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 5' THEN F.PERIOD_SID
                                 WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 6' THEN AIA.PERIOD_SID
                                 ELSE ADF.PERIOD_SID END AS PERIOD_SID,
                                 A.WORKFLOW_CREATED_DATE,
                                 A.WORKFLOW_ID,
                                 A.WORKFLOW_STATUS,
                                 A.WORKFLOW_NAME,
                                  CASE
                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 1' THEN SUM(ISNULL(B.OVERRIDE, B.VARIANCE))
                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 2' THEN SUM(ISNULL(D.OVERRIDE, D.VARIANCE))
                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 3' THEN SUM(ISNULL(C.OVERRIDE, C.VARIANCE))
                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 4' THEN SUM(ISNULL(E.OVERRIDE, E.VARIANCE))
                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 5' THEN SUM(ISNULL(F.OVERRIDE, F.VARIANCE))
                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 6' THEN SUM(ISNULL(AIA.OVERRIDE, AIA.VARIANCE))
                    ELSE SUM(ISNULL(ADF.OVERRIDE, ADF.VARIANCE)) END AS AMOUNT,
                           CASE
                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 1' THEN SUM(ISNULL(B.RATE, 0))
                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 2' THEN SUM(ISNULL(D.PROJECTED_RATE, 0))
                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 3' THEN SUM(ISNULL(C.RATE, 0))
                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 4' THEN SUM(ISNULL(E.PROJECTED_RATE, 0))
                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 5' THEN SUM(ISNULL(F.PROJECTED_RATE, 0))
                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 6' THEN NULL
                    ELSE  SUM(ISNULL(ADF.RATE, 0)) END AS RATE,
                                 APPRVD_ARM_ADJUSTMENT_CONFIG_SID,
                                 APPRVD_TRANSACTION_NAME,
                                 APPRVD_METHODOLOGY
                           FROM   #TEMP_ARM_APPRVD_PROJ A
                           JOIN #TEMP_CCPD TC ON TC.CCP_DETAILS_SID=A.CCP_DETAILS_SID AND A.RS_MODEL_SID=TC.RS_MODEL_SID
                                 LEFT JOIN ARM_PIPELINE_RATE B
                                        ON A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
                                          --- AND A.PERIOD_SID = B.PERIOD_SID
                                 LEFT JOIN ARM_INVENTORY_RATE C
                                        ON C.ARM_ADJUSTMENT_DETAILS_SID = A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID
                                          --- AND C.PERIOD_SID = A.PERIOD_SID
                                 LEFT JOIN ARM_DEMAND_ADJ_SUMMARY D
                                        ON D.ARM_ADJUSTMENT_DETAILS_SID = A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID
                                          --- AND D.PERIOD_SID = A.PERIOD_SID
                                 LEFT JOIN ARM_DEMAND_RECON_SUMMARY E
                                        ON E.ARM_ADJUSTMENT_DETAILS_SID = A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID
                                          --- AND E.PERIOD_SID = A.PERIOD_SID
                                 LEFT JOIN ARM_DEMAND_RF_TRUE_UP_SUMMARY F
                                        ON F.ARM_ADJUSTMENT_DETAILS_SID = A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID
                                          --- AND F.PERIOD_SID = A.PERIOD_SID
                                 LEFT JOIN ARM_INFLATION_INVENTORY_ADJ AIA
                         ON AIA.ARM_ADJUSTMENT_DETAILS_SID = A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID
                            --- AND AIA.PERIOD_SID = A.PERIOD_SID
                  LEFT JOIN ARM_INFLATION_INVENTORY AII 
                      ON AII.PROJECTION_MASTER_SID=A.APPRVD_PROJECTION_MASTER_SID 
                            AND AII.COMPANY_MASTER_SID=TC.COMPANY_MASTER_SID
                  LEFT JOIN ARM_DISTRIBUTION_FEES_RATE ADF
                         ON ADF.ARM_ADJUSTMENT_DETAILS_SID = A.APPRVD_ARM_ADJUSTMENT_DETAILS_SID
                            --- AND ADF.PERIOD_SID = A.PERIOD_SID
                          GROUP  BY A.APPRVD_PROJECTION_MASTER_SID,
                                             A.ARM_ADJUSTMENT_DETAILS_SID,
                                    A.CCP_DETAILS_SID,
                                    A.RS_MODEL_SID,
                                    A.ADJUSTMENT_TYPE,
                                    CASE
                                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 1' THEN B.PERIOD_SID
                                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 2' THEN D.PERIOD_SID
                                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 3' THEN C.PERIOD_SID
                                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 4' THEN E.PERIOD_SID
                                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 5' THEN F.PERIOD_SID
                                    WHEN A.APPRVD_METHODOLOGY = 'TRANSACTION 6' THEN AIA.PERIOD_SID
                                    ELSE ADF.PERIOD_SID END,
                                    A.WORKFLOW_CREATED_DATE,
                                    A.WORKFLOW_ID,
                                    A.WORKFLOW_STATUS,
                                    A.WORKFLOW_NAME,
                                    APPRVD_ARM_ADJUSTMENT_CONFIG_SID,
                                    APPRVD_TRANSACTION_NAME,
                                    APPRVD_METHODOLOGY

								  
IF OBJECT_ID('TEMPDB..#ARM_ADJ_RES_CCP') IS NOT NULL
	DROP TABLE #ARM_ADJ_RES_CCP

SELECT DISTINCT ARM_ADJ_RES_CONFIG_MASTER_SID
	,A.ADJUSTMENT_TYPE
	,A.ACCOUNT_CATEGORY
	,A.ACCOUNT_TYPE
	,A.ACCOUNT
	,A.ADJUSTMENT_LEVEL
	,A.CREDIT
	,A.DEBIT
	,WM.WORKFLOW_ID
        ,ACCOUNT_DESC
        ,ACCOUNT_INDICATOR
        ,COST_CENTER
        ,PROJECT
        ,FUTURE_1
        ,FUTURE_2
        ,UDC_1
        ,UDC_2
        ,UDC_3
        ,UDC_4
        ,UDC_5
        ,UDC_6
        ,BALANCE_TYPE
        ,[DATABASE]
        ,DATA_ACCESS_SET
        ,CHART_OF_ACCOUNTS
        ,LEDGER
        ,CATEGORY
        ,SOURCE
        ,CURRENCY
        ,JOURNAL_NAME
        ,JOURNAL_DESCRIPTION
        ,REVERSE_JOURNAL
        ,REVERSAL_PERIOD_DATE
        ,LINE_DESCRIPTION 
        ,DIVISION
INTO #ARM_ADJ_RES_CCP
FROM ARM_ADJUSTMENT_MASTER AM
JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID
JOIN ARM_ADJUSTMENT_DETAILS B ON AM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
INNER JOIN ARM_ADJ_RES_CCP A ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
	AND AM.TRANSACTION_TYPE = A.ADJUSTMENT_TYPE
	INNER JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
 WHERE AM.PROJECTION_MASTER_SID IN(
 SELECT DISTINCT APPRVD_PROJECTION_MASTER_SID FROM #TEMP_ARM_APPRVD_PROJ)

            IF OBJECT_ID('TEMPDB..#TEMP_PROJ_RES') IS NOT NULL
              DROP TABLE #TEMP_PROJ_RES

            CREATE TABLE #TEMP_PROJ_RES
              (
                 BRAND_MASTER_SID            INT,
                 BRAND_ID                    VARCHAR(50),
                 PERIOD_DATE                 DATETIME,
                 RS_CATEGORY                 INT,
                 RS_TYPE                     INT,
                 REBATE_PROGRAM_TYPE         INT,
                 AMOUNT NUMERIC(22,6),
                     RATE NUMERIC(22,6),
                 PROJECTION_MASTER_SID       INT,
                 WORKFLOW_ID                 VARCHAR(50),
                 WORKFLOW_STATUS             INT,
                 WORKFLOW_NAME               VARCHAR(500),
                 ADJUSTMENT_TYPE             VARCHAR(50),
                   APPRVD_ARM_ADJUSTMENT_CONFIG_SID  INT,
                 APPRVD_TRANSACTION_NAME           VARCHAR(50),
                 APPRVD_METHODOLOGY                VARCHAR(50)
              )

            INSERT INTO #TEMP_PROJ_RES
                        (BRAND_MASTER_SID,
                         BRAND_ID,
                         PERIOD_DATE,
                         RS_CATEGORY,
                         RS_TYPE,
                         REBATE_PROGRAM_TYPE,
                         ADJUSTMENT_TYPE,
                         AMOUNT,
                                     RATE,
                         PROJECTION_MASTER_SID,
                         WORKFLOW_ID,
                         WORKFLOW_STATUS,
                         WORKFLOW_NAME,
                                 APPRVD_ARM_ADJUSTMENT_CONFIG_SID,
                                  APPRVD_TRANSACTION_NAME,
                                  APPRVD_METHODOLOGY)
            SELECT IM.BRAND_MASTER_SID,
                   BM.BRAND_ID,
                   MAX(CASE WHEN AC.REDEMPTION_PERIOD=1 THEN P.PERIOD_DATE ELSE NULL END),
                   RS_CATEGORY,
                   RS_TYPE,
                   REBATE_PROGRAM_TYPE,
                   A.ADJUSTMENT_TYPE,
                   SUM(AMOUNT),
                           SUM(RATE),
                   A.PROJECTION_MASTER_SID,
                   A.WORKFLOW_ID,
                   A.WORKFLOW_STATUS,
                   A.WORKFLOW_NAME,
                   A.APPRVD_ARM_ADJUSTMENT_CONFIG_SID,
                      A.APPRVD_TRANSACTION_NAME,
                      A.APPRVD_METHODOLOGY
            FROM   #TEMP_STATUS_AMOUNT A
                   JOIN #TEMP_ARM_APPRVD_PROJ TA ON A.CCP_DETAILS_SID=TA.CCP_DETAILS_SID AND A.RS_MODEL_SID=TA.RS_MODEL_SID
                   AND   A.PROJECTION_MASTER_SID=TA.APPRVD_PROJECTION_MASTER_SID
                   JOIN CCP_DETAILS C
                     ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID
                   JOIN ITEM_MASTER IM
                     ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
                   JOIN BRAND_MASTER BM
                     ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
                   JOIN RS_CONTRACT R
                     ON R.RS_MODEL_SID = A.RS_MODEL_SID
                        AND R.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID
                   JOIN ARM_DEDUCTION_SELECTION ADS
                     ON ADS.RS_CONTRACT_SID = R.RS_CONTRACT_SID
                        AND ADS.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID
                   JOIN #TEMP_PERIOD P
                     ON P.PERIOD_SID = A.PERIOD_SID
                   JOIN ARM_ADJUSTMENT_CONFIG AC on A.APPRVD_ARM_ADJUSTMENT_CONFIG_SID=AC.ARM_ADJUSTMENT_CONFIG_SID
            GROUP  BY IM.BRAND_MASTER_SID,
                      BM.BRAND_ID,
                      P.PERIOD_DATE,
                      RS_CATEGORY,
                      RS_TYPE,
                      REBATE_PROGRAM_TYPE,
                      A.PROJECTION_MASTER_SID,
                      A.ADJUSTMENT_TYPE,
                      A.WORKFLOW_ID,
                      A.WORKFLOW_STATUS,
                      A.WORKFLOW_NAME,
                            A.APPRVD_ARM_ADJUSTMENT_CONFIG_SID,
                            A.APPRVD_TRANSACTION_NAME,
                            A.APPRVD_METHODOLOGY;

            ;WITH CTE
                 AS (SELECT B.GL_IMPACT_DATE AS ACCOUNTING_DATE,
                            BU.COMPANY_ID    AS BU_COMPANY_ID,
                            BU.COMPANY_NO    AS BU_COMPANY_NO,
                            B.BU_COMPANY_MASTER_SID,
                            A.BRAND_ID,
                            A.PERIOD_DATE    AS REDEMPTION_PERIOD,
                            GL.COMPANY_ID    AS GL_COMPANY_ID,
                            GL.COMPANY_NO    AS GL_COMPANY_NO,
                            ARM_ADJ_RES_CONFIG_MASTER_SID,
                            AMOUNT,
                                            RATE,
                            PM.PROJECTION_DESCRIPTION,
                            A.WORKFLOW_ID,
                            A.WORKFLOW_STATUS,
                            PM.PROJECTION_DESCRIPTION AS WORKFLOW_NAME,
                            PERIOD_DATE      AS REDEMPTION_DATE,
                            A.ADJUSTMENT_TYPE,
                            A.APPRVD_ARM_ADJUSTMENT_CONFIG_SID AS ARM_ADJUSTMENT_CONFIG_SID ,
                            A.APPRVD_TRANSACTION_NAME AS TRANSACTION_NAME,
                            A.APPRVD_METHODOLOGY AS METHODOLOGY,
                            AAC.REDEMPTION_PERIOD AS REDEMPTION_PERIOD_CHECK
                     FROM   #TEMP_PROJ_RES A
                            JOIN ARM_ADJUSTMENT_MASTER B
                              ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
                               AND B.CONFIGURATION_TYPE = @CONFIGURATION_TYPE
                               JOIN ARM_ADJUSTMENT_CONFIG AAC ON AAC.ARM_ADJUSTMENT_CONFIG_SID=B.TRANSACTION_TYPE
                            JOIN PROJECTION_MASTER PM
                              ON PM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
                            JOIN COMPANY_MASTER BU
                              ON BU.COMPANY_MASTER_SID = B.BU_COMPANY_MASTER_SID
                            JOIN COMPANY_MASTER GL
                              ON GL.COMPANY_MASTER_SID = PM.COMPANY_MASTER_SID
                            JOIN ARM_ADJ_RES_CONFIG_MASTER AAM
                              ON AAM.RS_CATEGORY = A.RS_CATEGORY
                                 AND AAM.RS_TYPE = A.RS_TYPE
                                 AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE
                                 AND PM.COMPANY_MASTER_SID = AAM.GL_COMPANY_MASTER_SID
                                 AND B.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID
                                 AND AAM.CONFIGURATION_TYPE = 0)
                @SELECT ;
            ]]>  
        </query>
    </entity>
    
    <entity id="ASAdjustmentDetailReserveLoadDataQuery">        
        <query>
            <![CDATA[
            SELECT

                A.TRANSACTION_NAME       AS ADJUSTMENT_TYPE,
		AAD.BALANCE_TYPE         AS BALANCE_TYPE,
                AAD."DATABASE"           AS "DATABASE",
                AAD.DATA_ACCESS_SET      AS DATA_ACCESS_SET,
                AAD.CHART_OF_ACCOUNTS    AS CHARTS_OF_ACCOUNTS,
                AAD.LEDGER               AS LEDGER,
                AAD.CATEGORY             AS CATEGORY,
                AAD."SOURCE"             AS [SOURCE],
                AAD.CURRENCY             AS CURRENCY,
                A.ACCOUNTING_DATE        AS ACCOUNTING_DATE,
                BATCH_NAME = CASE
                                WHEN A.WORKFLOW_ID IS NULL THEN ''
                                ELSE CONVERT(VARCHAR(100), A.TRANSACTION_NAME)
                                     + ' - ' + ISNULL(A.WORKFLOW_ID, ' ') + ' - '
                                     + AAD.JOURNAL_DESCRIPTION
                              END,

                AAD.JOURNAL_NAME         AS JOURNAL_NAME,
                AAD.JOURNAL_DESCRIPTION  AS JOURNAL_DESCRIPTION,
                AAD.REVERSE_JOURNAL      AS REVERSE_JOURNAL,
                AAD.REVERSAL_PERIOD_DATE AS REVERSAL_PERIOD_DATE,

                A.GL_COMPANY_ID          AS COMPANY,
                AAD.DIVISION             AS DIVISION,
                A.BU_COMPANY_ID          AS BUSINESS_UNIT,

                AAD.COST_CENTER          AS COST_CENTER,
                AAD.ACCOUNT              AS ACCOUNT,
                A.BRAND_ID               AS BRAND_ID,
                AAD.PROJECT              AS PROJECT,

                AAD.FUTURE_1             AS FUTURE_1,
                AAD.FUTURE_2             AS FUTURE_2,
                DEBIT = CASE
                       WHEN A.AMOUNT < 0
                       AND        AAD.DEBIT = 1 THEN ABS(A.AMOUNT)
                       WHEN A.AMOUNT > 0
                       AND        AAD.DEBIT = 0 THEN ABS(A.AMOUNT)
                END ,
                CREDIT = CASE
                       WHEN A.AMOUNT < 0
                       AND        AAD.CREDIT = 1 THEN ABS(A.AMOUNT)
                       WHEN A.AMOUNT > 0
                       AND        AAD.CREDIT = 0 THEN A.AMOUNT
                END,

                AAD.LINE_DESCRIPTION     AS LINE_DESCRIPTION,
                UDC1.DESCRIPTION                AS UDC_1,
                AAD.UDC_2                AS UDC_2,
                AAD.UDC_3                AS UDC_3,
                AAD.UDC_4                AS UDC_4,
                AAD.UDC_5                AS UDC_5,
                AAD.UDC_6                AS UDC_6,
                AAD.ACCOUNT_CATEGORY     AS ACCOUNT_CATEGORY,

                HT.DESCRIPTION         AS ACCOUNT_TYPE,
		AAD.ADJUSTMENT_LEVEL     AS ADJUSTMENT_LEVEL,
		AAD.ACCOUNT_INDICATOR    AS ACCOUNT_INDICATOR,
		AAD.ACCOUNT_DESC         AS ACCOUNT_DESCRIPTION,
                REDEMPTION_DATE=CASE WHEN A.REDEMPTION_PERIOD_CHECK=1 THEN  A.REDEMPTION_DATE ELSE NULL END,
                A.REDEMPTION_DATE        AS CALCULATION_PERIOD,
		A.WORKFLOW_ID            AS WORKFLOW_ID,
                WORKFLOW_NAME            AS WORKFLOW_NAME,
                WORKFLOW_STATUS          AS WORKFLOW_STATUS


         FROM   CTE A
                JOIN #ARM_ADJ_RES_CCP AAD
                  ON AAD.ARM_ADJ_RES_CONFIG_MASTER_SID = A.ARM_ADJ_RES_CONFIG_MASTER_SID
                  AND AAD.ADJUSTMENT_TYPE=A.ARM_ADJUSTMENT_CONFIG_SID

        AND        A.WORKFLOW_ID=AAD.WORKFLOW_ID
                JOIN HELPER_TABLE HT
                  ON HT.HELPER_TABLE_SID = AAD.ACCOUNT_TYPE
                  LEFT JOIN HELPER_TABLE UDC1		
                  ON UDC1.HELPER_TABLE_SID = AAD.UDC_1
        WHERE  AAD.ADJUSTMENT_LEVEL = @ADJUSTMENTLEVELBRAND AND AAD.ADJUSTMENT_TYPE in (@ADJUSTMENT_TYPE)
                        AND AAD.ACCOUNT_CATEGORY IN (@CATEGORY) AND AAD.ACCOUNT_TYPE IN (@TYPE) AND AAD.ACCOUNT IN (@ACCOUNT)   
               UNION ALL

        SELECT
                A.TRANSACTION_NAME AS ADJUSTMENT_TYPE,
		AAD.BALANCE_TYPE,
                AAD."DATABASE"           AS "DATABASE",
                AAD.DATA_ACCESS_SET      AS DATA_ACCESS_SET,
                AAD.CHART_OF_ACCOUNTS    AS CHARTS_OF_ACCOUNTS,
                AAD.LEDGER               AS LEDGER,
                AAD.CATEGORY             AS CATEGORY,
                AAD."SOURCE"             AS [SOURCE],
                AAD.CURRENCY             AS CURRENCY,
                A.ACCOUNTING_DATE        AS ACCOUNTING_DATE,
                BATCH_NAME = CASE
                                WHEN A.WORKFLOW_ID IS NULL THEN ''
                                ELSE CONVERT(VARCHAR(100), A.TRANSACTION_NAME)
                                     + ' - ' + ISNULL(A.WORKFLOW_ID, ' ') + ' - '
                                     + AAD.JOURNAL_DESCRIPTION
                              END,
                AAD.JOURNAL_NAME         AS JOURNAL_NAME,
                AAD.JOURNAL_DESCRIPTION  AS JOURNAL_DESCRIPTION,
                AAD.REVERSE_JOURNAL      AS REVERSE_JOURNAL,
                AAD.REVERSAL_PERIOD_DATE AS REVERSAL_PERIOD_DATE,

                A.GL_COMPANY_ID          AS COMPANY,
                AAD.DIVISION             AS DIVISION,
                A.BU_COMPANY_ID          AS BUSINESS_UNIT,
                AAD.COST_CENTER          AS COST_CENTER,
                AAD.ACCOUNT              AS ACCOUNT,
                '000'                    AS BRAND_ID,
                AAD.PROJECT              AS PROJECT,

                AAD.FUTURE_1             AS FUTURE_1,
                AAD.FUTURE_2             AS FUTURE_2,
                DEBIT = CASE
                       WHEN A.AMOUNT < 0
                       AND        AAD.DEBIT = 1 THEN ABS(A.AMOUNT)
                       WHEN A.AMOUNT > 0
                       AND        AAD.DEBIT = 0 THEN ABS(A.AMOUNT)
                END ,
                CREDIT = CASE
                       WHEN A.AMOUNT < 0
                       AND        AAD.CREDIT = 1 THEN ABS(A.AMOUNT)
                       WHEN A.AMOUNT > 0
                       AND        AAD.CREDIT = 0 THEN A.AMOUNT
                                    END,
                AAD.LINE_DESCRIPTION     AS LINE_DESCRIPTION,
                UDC1.DESCRIPTION                AS UDC_1,
                AAD.UDC_2                AS UDC_2,
                AAD.UDC_3                AS UDC_3,
                AAD.UDC_4                AS UDC_4,
                AAD.UDC_5                AS UDC_5,
                AAD.UDC_6                AS UDC_6,
                AAD.ACCOUNT_CATEGORY     AS ACCOUNT_CATEGORY,

                HT.DESCRIPTION         AS ACCOUNT_TYPE,
		AAD.ADJUSTMENT_LEVEL     AS ADJUSTMENT_LEVEL,
		AAD.ACCOUNT_INDICATOR    AS ACCOUNT_INDICATOR,
		AAD.ACCOUNT_DESC         AS ACCOUNT_DESCRIPTION,
                REDEMPTION_DATE=CASE WHEN A.REDEMPTION_PERIOD_CHECK=1 THEN  A.REDEMPTION_DATE ELSE NULL END,
                A.REDEMPTION_DATE        AS CALCULATION_PERIOD,
		A.WORKFLOW_ID            AS WORKFLOW_ID,
                WORKFLOW_NAME            AS WORKFLOW_NAME,
                WORKFLOW_STATUS          AS WORKFLOW_STATUS

         FROM   (SELECT ARM_ADJ_RES_CONFIG_MASTER_SID,
                        GL_COMPANY_ID,
                        GL_COMPANY_NO,
                        BU_COMPANY_ID,
                        BU_COMPANY_NO,
                        BU_COMPANY_MASTER_SID,
                        ACCOUNTING_DATE,
                        PROJECTION_DESCRIPTION,
                        REDEMPTION_PERIOD_CHECK,
                       SUM(AMOUNT) AS AMOUNT,
                        SUM(RATE) AS RATE,
                        WORKFLOW_ID,
                        WORKFLOW_STATUS,
                        WORKFLOW_NAME,
                        REDEMPTION_DATE,
                        ADJUSTMENT_TYPE,
                  ARM_ADJUSTMENT_CONFIG_SID ,
                 TRANSACTION_NAME,
                 METHODOLOGY
                 FROM   CTE A
                 GROUP  BY ARM_ADJ_RES_CONFIG_MASTER_SID,
                           GL_COMPANY_ID,
                           GL_COMPANY_NO,
                           BU_COMPANY_ID,
                           BU_COMPANY_NO,
                           BU_COMPANY_MASTER_SID,
                           ACCOUNTING_DATE,
                           PROJECTION_DESCRIPTION,
                           REDEMPTION_PERIOD_CHECK,
                           WORKFLOW_ID,
                           WORKFLOW_STATUS,
                           WORKFLOW_NAME,
                           REDEMPTION_DATE,
                           ADJUSTMENT_TYPE,
                 ARM_ADJUSTMENT_CONFIG_SID ,
                 TRANSACTION_NAME,
                 METHODOLOGY) A
                JOIN #ARM_ADJ_RES_CCP AAD
                  ON AAD.ARM_ADJ_RES_CONFIG_MASTER_SID = A.ARM_ADJ_RES_CONFIG_MASTER_SID
                  AND AAD.ADJUSTMENT_TYPE=A.ARM_ADJUSTMENT_CONFIG_SID
	AND AAD.WORKFLOW_ID=A.WORKFLOW_ID
                JOIN HELPER_TABLE HT
                  ON HT.HELPER_TABLE_SID = AAD.ACCOUNT_TYPE
                  LEFT JOIN HELPER_TABLE UDC1		
                  ON UDC1.HELPER_TABLE_SID = AAD.UDC_1
        WHERE  AAD.ADJUSTMENT_LEVEL = @ADJUSTMENTLEVELTOTAL AND AAD.ADJUSTMENT_TYPE in (@ADJUSTMENT_TYPE)
                            AND AAD.ACCOUNT_CATEGORY IN (@CATEGORY) AND AAD.ACCOUNT_TYPE IN (@TYPE) AND AAD.ACCOUNT IN (@ACCOUNT)   
          
                                 @PAGINATION
            ]]>  
        </query>
    </entity>
    
    <entity id="Adjustment Reserve Details common query For data">
     
        <query>
            <![CDATA[
                   
 DECLARE @PROJECTION_MASTER_SID INT = @PROJECTIONMASTER,
              @ACCOUNT VARCHAR(1000) = '@ACC_VAL1'
              @SESSION_DECLARE


IF OBJECT_ID('TEMPDB..#ARM_ACC') IS NOT NULL
    DROP TABLE #ARM_ACC
CREATE TABLE  #ARM_ACC 
    (ACC_ID VARCHAR(50) )


INSERT INTO #ARM_ACC(ACC_ID)
SELECT TOKEN
FROM  UDF_SPLITSTRING(@ACCOUNT, ',')  

    IF OBJECT_ID('TEMPDB..#ARM_ADJ_RES_CCP') IS NOT NULL
      DROP TABLE #ARM_ADJ_RES_CCP

SELECT  DISTINCT A.ARM_ADJUSTMENT_DETAILS_SID,BM.BRAND_ID,ARM_ADJ_RES_CONFIG_MASTER_SID
      ,A.ADJUSTMENT_TYPE
      ,A.ACCOUNT_CATEGORY
      ,A.ACCOUNT_TYPE
      ,A.ACCOUNT
      ,A.ADJUSTMENT_LEVEL
      ,A.CREDIT
      ,A.DEBIT
        ,ACCOUNT_DESC
        ,ACCOUNT_INDICATOR
        ,COST_CENTER
        ,PROJECT
        ,FUTURE_1
        ,FUTURE_2
        ,UDC_1
        ,UDC_2
        ,UDC_3
        ,UDC_4
        ,UDC_5
        ,UDC_6
        ,BALANCE_TYPE
        ,[DATABASE]
        ,DATA_ACCESS_SET
        ,CHART_OF_ACCOUNTS
        ,LEDGER
        ,CATEGORY
        ,A.SOURCE
        ,CURRENCY
        ,JOURNAL_NAME
        ,JOURNAL_DESCRIPTION
        ,REVERSE_JOURNAL
        ,REVERSAL_PERIOD_DATE
        ,LINE_DESCRIPTION 
        ,DIVISION
 INTO #ARM_ADJ_RES_CCP
 FROM ARM_ADJUSTMENT_MASTER AM
 JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID
 JOIN ARM_ADJUSTMENT_DETAILS B ON AM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
 INNER JOIN ARM_ADJ_RES_CCP A ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
      AND AM.TRANSACTION_TYPE = A.ADJUSTMENT_TYPE
 JOIN CCP_DETAILS C 
    ON C.CCP_DETAILS_SID = B.CCP_DETAILS_SID 
 JOIN ITEM_MASTER IM 
    ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID 
 JOIN BRAND_MASTER BM 
    ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
 WHERE AM.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
 
    IF OBJECT_ID('TEMPDB..#ARM_ADJ_RES_CCP_BRAND') IS NOT NULL
        DROP TABLE #ARM_ADJ_RES_CCP_BRAND
			
        SELECT  DISTINCT BM.BRAND_ID,ARM_ADJ_RES_CONFIG_MASTER_SID
             ,A.ADJUSTMENT_TYPE
             ,A.ACCOUNT_CATEGORY
             ,A.ACCOUNT_TYPE
             ,A.ACCOUNT
             ,A.ADJUSTMENT_LEVEL
             ,A.CREDIT
             ,A.DEBIT
               ,ACCOUNT_DESC
               ,ACCOUNT_INDICATOR
               ,COST_CENTER
               ,PROJECT
               ,FUTURE_1
               ,FUTURE_2
               ,UDC_1
               ,UDC_2
               ,UDC_3
               ,UDC_4
               ,UDC_5
               ,UDC_6
               ,BALANCE_TYPE
               ,[DATABASE]
               ,DATA_ACCESS_SET
               ,CHART_OF_ACCOUNTS
               ,LEDGER
               ,CATEGORY
               ,A.SOURCE
               ,CURRENCY
               ,JOURNAL_NAME
               ,JOURNAL_DESCRIPTION
               ,REVERSE_JOURNAL
               ,REVERSAL_PERIOD_DATE
               ,LINE_DESCRIPTION 
               ,DIVISION
        INTO #ARM_ADJ_RES_CCP_BRAND
        FROM ARM_ADJUSTMENT_MASTER AM
        JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID
        JOIN ARM_ADJUSTMENT_DETAILS B ON AM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
        INNER JOIN ARM_ADJ_RES_CCP A ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
             AND AM.TRANSACTION_TYPE = A.ADJUSTMENT_TYPE
        JOIN CCP_DETAILS C 
           ON C.CCP_DETAILS_SID = B.CCP_DETAILS_SID 
        JOIN ITEM_MASTER IM 
           ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID 
        JOIN BRAND_MASTER BM 
           ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
        WHERE AM.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
 IF OBJECT_ID('TEMPDB..#ARM_ADJ_RES_CCP_TOTAL') IS NOT NULL
        DROP TABLE #ARM_ADJ_RES_CCP_TOTAL
			
        SELECT  DISTINCT ARM_ADJ_RES_CONFIG_MASTER_SID
             ,A.ADJUSTMENT_TYPE
             ,A.ACCOUNT_CATEGORY
             ,A.ACCOUNT_TYPE
             ,A.ACCOUNT
             ,A.ADJUSTMENT_LEVEL
             ,A.CREDIT
             ,A.DEBIT
               ,ACCOUNT_DESC
               ,ACCOUNT_INDICATOR
               ,COST_CENTER
               ,PROJECT
               ,FUTURE_1
               ,FUTURE_2
               ,UDC_1
               ,UDC_2
               ,UDC_3
               ,UDC_4
               ,UDC_5
               ,UDC_6
               ,BALANCE_TYPE
               ,[DATABASE]
               ,DATA_ACCESS_SET
               ,CHART_OF_ACCOUNTS
               ,LEDGER
               ,CATEGORY
               ,A.SOURCE
               ,CURRENCY
               ,JOURNAL_NAME
               ,JOURNAL_DESCRIPTION
               ,REVERSE_JOURNAL
               ,REVERSAL_PERIOD_DATE
               ,LINE_DESCRIPTION 
               ,DIVISION
        INTO #ARM_ADJ_RES_CCP_TOTAL
        FROM ARM_ADJUSTMENT_MASTER AM
        JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID
        JOIN ARM_ADJUSTMENT_DETAILS B ON AM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
        INNER JOIN ARM_ADJ_RES_CCP A ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
             AND AM.TRANSACTION_TYPE = A.ADJUSTMENT_TYPE
        JOIN CCP_DETAILS C 
           ON C.CCP_DETAILS_SID = B.CCP_DETAILS_SID 
        JOIN ITEM_MASTER IM 
           ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID 
        JOIN BRAND_MASTER BM 
           ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
        WHERE AM.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
 

  IF OBJECT_ID('TEMPDB..#TEMP_PROJ_RES_BRAND') IS NOT NULL
        DROP TABLE #TEMP_PROJ_RES_BRAND

CREATE TABLE #TEMP_PROJ_RES_BRAND 
    ( 
     BRAND_MASTER_SID      INT, 
     BRAND_ID              VARCHAR(50), 
     ACCOUNT               VARCHAR(50), 
     PERIOD_DATE           DATETIME, 
     RS_CATEGORY           INT, 
     RS_TYPE               INT, 
     REBATE_PROGRAM_TYPE   INT, 
     DEBIT                 NUMERIC(22, 6), 
     CREDIT                NUMERIC(22,6),
     ACCRUAL_AMOUNT NUMERIC(22,6),
     PROJECTION_MASTER_SID INT, 
     WORKFLOW_MASTER_SID   INT NULL, 
     WORKFLOW_ID           VARCHAR(50),
     WORKFLOW_NAME           VARCHAR(500),
     WORKFLOW_STATUS           INT,
     ARM_ADJUSTMENT_CONFIG_SID INT,
     TRANSACTION_NAME VARCHAR(50)
    )

INSERT INTO #TEMP_PROJ_RES_BRAND  
            (BRAND_MASTER_SID, 
             BRAND_ID,
             ACCOUNT, 
             PERIOD_DATE, 
             RS_CATEGORY, 
             RS_TYPE, 
             REBATE_PROGRAM_TYPE, 
             DEBIT, 
             CREDIT,
             ACCRUAL_AMOUNT,
             PROJECTION_MASTER_SID, 
             WORKFLOW_MASTER_SID, 
             WORKFLOW_ID,
             WORKFLOW_NAME,
             WORKFLOW_STATUS,
             ARM_ADJUSTMENT_CONFIG_SID,
             TRANSACTION_NAME) 
SELECT IM.BRAND_MASTER_SID, 
       BM.BRAND_ID,
       AR.ACCOUNT,
       P.PERIOD_DATE, 
       RS_CATEGORY, 
       RS_TYPE, 
       REBATE_PROGRAM_TYPE, 
       CASE WHEN ISNULL(SUM(B.DEBIT),0) -  ISNULL(SUM(B.CREDIT),0) > 0 THEN ISNULL(SUM(B.DEBIT),0) -  ISNULL(SUM(B.CREDIT),0) 
	       			        ELSE NULL END AS DEBIT,
				   CASE WHEN ISNULL(SUM(B.CREDIT),0) -  ISNULL(SUM(B.DEBIT),0) > 0 THEN ISNULL(SUM(B.CREDIT),0) -  ISNULL(SUM(B.DEBIT),0)
				   ELSE NULL END  AS CREDIT,
       ISNULL(SUM(B.CREDIT), 0) - ISNULL(SUM(B.DEBIT), 0) AS ACCRUAL_AMOUNT, 
       A.PROJECTION_MASTER_SID, 
       WORKFLOW_MASTER_SID, 
       WORKFLOW_ID,
       PM.PROJECTION_DESCRIPTION,
       WM.WORKFLOW_STATUS_ID,
       ARM_ADJUSTMENT_CONFIG_SID,
       TRANSACTION_NAME
FROM   ARM_ADJUSTMENT_DETAILS A
       JOIN PROJECTION_MASTER PM ON PM.PROJECTION_MASTER_SID=@PROJECTION_MASTER_SID 
       JOIN #ARM_ADJ_RES_CCP AR
	   ON AR.ARM_ADJUSTMENT_DETAILS_SID=A.ARM_ADJUSTMENT_DETAILS_SID 
	   JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=AR.ADJUSTMENT_LEVEL AND HT.DESCRIPTION='BRAND'

           LEFT JOIN  @TABLE_1 B  

              ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
              AND  AR.ACCOUNT=B.ACCOUNT
       LEFT JOIN PERIOD P 
         ON P.PERIOD_SID = B.PERIOD_SID 
       LEFT JOIN WORKFLOW_MASTER WM 
         ON WM.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID 
          JOIN ARM_ADJUSTMENT_MASTER AM ON AM.PROJECTION_MASTER_SID=A.PROJECTION_MASTER_SID
          JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE=AC.ARM_ADJUSTMENT_CONFIG_SID
       JOIN CCP_DETAILS C 
         ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID 
       JOIN ITEM_MASTER IM 
         ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID 
       JOIN BRAND_MASTER BM 
         ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
       JOIN RS_CONTRACT R 
         ON R.RS_MODEL_SID = A.RS_MODEL_SID 
            AND R.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID 
       JOIN ARM_DEDUCTION_SELECTION ADS 
         ON ADS.RS_CONTRACT_SID = R.RS_CONTRACT_SID 
            AND ADS.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 
WHERE  A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID AND P.PERIOD_DATE IS NOT NULL
@SESSION_INCLUDE


GROUP  BY IM.BRAND_MASTER_SID,
          AR.ACCOUNT,
          BM.BRAND_ID, 
          P.PERIOD_DATE, 
          RS_CATEGORY, 
          RS_TYPE, 
          REBATE_PROGRAM_TYPE, 
          WORKFLOW_MASTER_SID, 
          A.PROJECTION_MASTER_SID, 
          WORKFLOW_ID,
          PM.PROJECTION_DESCRIPTION,
          WM.WORKFLOW_STATUS_ID,
          ARM_ADJUSTMENT_CONFIG_SID,

          TRANSACTION_NAME ;
IF OBJECT_ID ('TEMPDB..#TEMP_PROJ_RES_TOTAL') IS NOT NULL 
  DROP TABLE #TEMP_PROJ_RES_TOTAL 

CREATE TABLE #TEMP_PROJ_RES_TOTAL 
  ( 
     BRAND_MASTER_SID      INT, 
     BRAND_ID              VARCHAR(50),
	 ACCOUNT               VARCHAR(50), 
     PERIOD_DATE           DATETIME, 
     RS_CATEGORY           INT, 
     RS_TYPE               INT, 
     REBATE_PROGRAM_TYPE   INT, 
     DEBIT        NUMERIC(22, 6), 
	 CREDIT NUMERIC(22,6),
	 ACCRUAL_AMOUNT NUMERIC(22,6),
     PROJECTION_MASTER_SID INT, 
     WORKFLOW_MASTER_SID   INT NULL, 
     WORKFLOW_ID           VARCHAR(50),
     WORKFLOW_NAME           VARCHAR(500),
     WORKFLOW_STATUS           INT,
     ARM_ADJUSTMENT_CONFIG_SID INT,
     TRANSACTION_NAME VARCHAR(50)
  )

INSERT INTO #TEMP_PROJ_RES_TOTAL 
            (BRAND_MASTER_SID, 
             BRAND_ID,
			 ACCOUNT, 
             PERIOD_DATE, 
             RS_CATEGORY, 
             RS_TYPE, 
             REBATE_PROGRAM_TYPE, 
             DEBIT, 
             CREDIT,
			 ACCRUAL_AMOUNT,
             PROJECTION_MASTER_SID, 
             WORKFLOW_MASTER_SID, 
             WORKFLOW_ID,
             WORKFLOW_NAME,
             WORKFLOW_STATUS,
             ARM_ADJUSTMENT_CONFIG_SID,
             TRANSACTION_NAME) 
SELECT IM.BRAND_MASTER_SID, 
       BM.BRAND_ID,
	   AR.ACCOUNT,
       P.PERIOD_DATE, 
       RS_CATEGORY, 
       RS_TYPE, 
       REBATE_PROGRAM_TYPE, 
       ISNULL(SUM(B.DEBIT),0) AS DEBIT,
	   ISNULL(SUM(B.CREDIT),0) AS CREDIT,
	   ISNULL(SUM(B.CREDIT), 0) - ISNULL(SUM(B.DEBIT), 0) AS ACCRUAL_AMOUNT, 
       A.PROJECTION_MASTER_SID, 
       WORKFLOW_MASTER_SID, 
       WORKFLOW_ID,
       PM.PROJECTION_DESCRIPTION,
       WM.WORKFLOW_STATUS_ID,
       ARM_ADJUSTMENT_CONFIG_SID,
       TRANSACTION_NAME
FROM   ARM_ADJUSTMENT_DETAILS A
       JOIN PROJECTION_MASTER PM ON PM.PROJECTION_MASTER_SID=@PROJECTION_MASTER_SID 
       JOIN #ARM_ADJ_RES_CCP AR
	   ON AR.ARM_ADJUSTMENT_DETAILS_SID=A.ARM_ADJUSTMENT_DETAILS_SID 
	   JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=AR.ADJUSTMENT_LEVEL AND HT.DESCRIPTION='TOTAL'

           LEFT JOIN @TABLE_1 B  

              ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
              AND  AR.ACCOUNT=B.ACCOUNT
       LEFT JOIN PERIOD P 
         ON P.PERIOD_SID = B.PERIOD_SID 
       LEFT JOIN WORKFLOW_MASTER WM 
         ON WM.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID 
          JOIN ARM_ADJUSTMENT_MASTER AM ON AM.PROJECTION_MASTER_SID=A.PROJECTION_MASTER_SID
          JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE=AC.ARM_ADJUSTMENT_CONFIG_SID
       JOIN CCP_DETAILS C 
         ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID 
       JOIN ITEM_MASTER IM 
         ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID 
       JOIN BRAND_MASTER BM 
         ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
       JOIN RS_CONTRACT R 
         ON R.RS_MODEL_SID = A.RS_MODEL_SID 
            AND R.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID 
       JOIN ARM_DEDUCTION_SELECTION ADS 
         ON ADS.RS_CONTRACT_SID = R.RS_CONTRACT_SID 
            AND ADS.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 
WHERE  A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID  AND P.PERIOD_DATE IS NOT NULL

GROUP  BY IM.BRAND_MASTER_SID,
          AR.ACCOUNT,
          BM.BRAND_ID, 
          P.PERIOD_DATE, 
          RS_CATEGORY, 
          RS_TYPE, 
          REBATE_PROGRAM_TYPE, 
          WORKFLOW_MASTER_SID, 
          A.PROJECTION_MASTER_SID, 
          WORKFLOW_ID,
          PM.PROJECTION_DESCRIPTION,
          WM.WORKFLOW_STATUS_ID,
          ARM_ADJUSTMENT_CONFIG_SID,
          TRANSACTION_NAME  
           IF OBJECT_ID('TEMPDB..#FINAL_OUTPUT') IS NOT NULL
            DROP TABLE #FINAL_OUTPUT
          SELECT
  * INTO #FINAL_OUTPUT
FROM ( 
        SELECT   AAC.TRANSACTION_NAME       AS ADJUSTMENT_TYPE,
               AAD.BALANCE_TYPE         AS BALANCE_TYPE, 
               AAD."DATABASE"           AS DATABASE_DESC, 
               AAD.DATA_ACCESS_SET      AS DATA_ACCESS_SET, 
               AAD.CHART_OF_ACCOUNTS    AS CHART_OF_ACCOUNTS, 
               AAD.LEDGER               AS LEDGER, 
               AAD.CATEGORY             AS CATEGORY, 
               AAD."SOURCE"             AS SOURCE_DESC, 
               AAD.CURRENCY             AS CURRENCY, 
               B.GL_IMPACT_DATE       AS ACCOUNTING_DATE, 
               BATCH_NAME = CASE 
                              WHEN A.WORKFLOW_ID = NULL THEN '' 
                              ELSE CONVERT(VARCHAR(100), A.TRANSACTION_NAME) 
                                   + ' - ' + ISNULL(A.WORKFLOW_ID, ' ') + ' - ' 
                                   + AAD.JOURNAL_DESCRIPTION
                            END, 
               AAD.JOURNAL_NAME         AS JOURNAL_NAME, 
               AAD.JOURNAL_DESCRIPTION  AS JOURNAL_DESCRIPTION, 
               AAD.REVERSE_JOURNAL      AS REVERSE_JOURNAL, 
               AAD.REVERSAL_PERIOD_DATE AS REVERSAL_PERIOD_DATE, 
               GL.COMPANY_ID         AS GL_COMPANY_ID, 
               AAD.DIVISION             AS DIVISION, 
                BU.COMPANY_ID          AS BU, 
               AAD.COST_CENTER          AS COST_CENTER, 
               AAD.ACCOUNT              AS ACCOUNT, 
               A.BRAND_ID               AS BRAND_ID, 
               AAD.PROJECT              AS PROJECT, 
               AAD.FUTURE_1             AS FUTURE_1, 
               AAD.FUTURE_2             AS FUTURE_2, 
              CASE WHEN (A.DEBIT IS NULL AND A.CREDIT IS NULL) THEN 0 ELSE  A.DEBIT END DEBIT,
              CASE WHEN (A.DEBIT IS NULL AND A.CREDIT IS NULL) THEN 0 ELSE A.CREDIT END CREDIT, 
               AAD.LINE_DESCRIPTION     AS LINE_DESCRIPTION, 
               UDC1.DESCRIPTION         AS UDC_1, 
               AAD.UDC_2                AS UDC_2, 
               AAD.UDC_3                AS UDC_3, 
               AAD.UDC_4                AS UDC_4, 
               AAD.UDC_5                AS UDC_5, 
               AAD.UDC_6                AS UDC_6, 
               AAD.ACCOUNT_CATEGORY     AS ACCOUNT_CATEGORY, 
               HT.DESCRIPTION           AS ACCOUNT_TYPE ,
               AAD.ADJUSTMENT_LEVEL AS ADJUSTMENT_LEVEL,
               AAD.ACCOUNT_INDICATOR AS ACCOUNT_INDICATOR,
               AAD.ACCOUNT_DESC AS ACCOUNT_DESC,
               CASE WHEN AAC.REDEMPTION_PERIOD = 1 THEN A.PERIOD_DATE ELSE NULL END  AS REP_PERIIOD,
               A.PERIOD_DATE AS CALCULATION_PERIOD,
               A.WORKFLOW_ID,
               A.WORKFLOW_NAME,
               A.WORKFLOW_STATUS
            FROM    #TEMP_PROJ_RES_BRAND A 
                JOIN ARM_ADJUSTMENT_MASTER B 
                  ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID 
                JOIN PROJECTION_MASTER PM 
                  ON PM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID 
                JOIN COMPANY_MASTER BU 
                  ON BU.COMPANY_MASTER_SID = B.BU_COMPANY_MASTER_SID 
                JOIN COMPANY_MASTER GL 
                  ON GL.COMPANY_MASTER_SID = PM.COMPANY_MASTER_SID 
                JOIN ARM_ADJ_RES_CONFIG_MASTER AAM 
                  ON AAM.RS_CATEGORY = A.RS_CATEGORY 
                     AND AAM.RS_TYPE = A.RS_TYPE 
                     AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE 
                     AND PM.COMPANY_MASTER_SID = AAM.GL_COMPANY_MASTER_SID 
                     AND B.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID 
                     AND AAM.CONFIGURATION_TYPE = 0
               JOIN #ARM_ADJ_RES_CCP_BRAND AAD 
                 ON AAD.ARM_ADJ_RES_CONFIG_MASTER_SID = AAM.ARM_ADJ_RES_CONFIG_MASTER_SID 
                             --- Don't delete. This line is needed in the future for calculation changes
                           AND A.ARM_ADJUSTMENT_CONFIG_SID=AAD.ADJUSTMENT_TYPE
                           AND A.ACCOUNT=AAD.ACCOUNT
                           AND A.BRAND_ID=AAD.BRAND_ID
               JOIN HELPER_TABLE HT 
                 ON HT.HELPER_TABLE_SID = AAD.ACCOUNT_TYPE 
                 JOIN ARM_ADJUSTMENT_CONFIG AAC ON AAC.ARM_ADJUSTMENT_CONFIG_SID=AAD.ADJUSTMENT_TYPE
                 LEFT JOIN HELPER_TABLE UDC1
                  ON UDC1.HELPER_TABLE_SID = AAD.UDC_1

        WHERE  
        ?AMOUNTCONDITION
        
--A.ACCRUAL_AMOUNT>0.01 AND 
AAD.ADJUSTMENT_LEVEL = @ADJUSTMENTLEVELBRAND 
               AND AAD.ADJUSTMENT_TYPE = @ADJUSTMENT_TYPE 
                @CATEGORY 
               @TYPE 
               @ACCOUNT_CONDITION 



        UNION ALL 
        SELECT AAC.TRANSACTION_NAME       AS ADJUSTMENT_TYPE,
               AAD.BALANCE_TYPE         AS BALANCE_TYPE, 
               AAD."DATABASE"           AS DATABASE_DESC, 
               AAD.DATA_ACCESS_SET      AS DATA_ACCESS_SET, 
               AAD.CHART_OF_ACCOUNTS    AS CHART_OF_ACCOUNTS, 
               AAD.LEDGER               AS LEDGER, 
               AAD.CATEGORY             AS CATEGORY, 
               AAD."SOURCE"             AS SOURCE_DESC, 
               AAD.CURRENCY             AS CURRENCY, 
               A.ACCOUNTING_DATE        AS ACCOUNTING_DATE, 
               BATCH_NAME = CASE 
                              WHEN A.WORKFLOW_ID = NULL THEN '' 
                              ELSE CONVERT(VARCHAR(100), A.TRANSACTION_NAME) 
                                   + ' - ' + ISNULL(A.WORKFLOW_ID, ' ') + ' - ' 
                                   + AAD.JOURNAL_DESCRIPTION 
                            END, 
               AAD.JOURNAL_NAME         AS JOURNAL_NAME, 
               AAD.JOURNAL_DESCRIPTION  AS JOURNAL_DESCRIPTION, 
               AAD.REVERSE_JOURNAL      AS REVERSE_JOURNAL, 
               AAD.REVERSAL_PERIOD_DATE AS REVERSAL_PERIOD_DATE, 
               A.GL_COMPANY_ID          AS GL_COMPANY_ID, 
               AAD.DIVISION            AS DIVISION, 
               A.BU_COMPANY_ID         AS BU, 
               AAD.COST_CENTER          AS COST_CENTER, 
               AAD.ACCOUNT              AS ACCOUNT, 
               '000'                    AS BRAND_ID, 
               AAD.PROJECT              AS PROJECT, 
               AAD.FUTURE_1             AS FUTURE_1, 
               AAD.FUTURE_2             AS FUTURE_2, 
                CASE WHEN (A.DEBIT IS NULL AND A.CREDIT IS NULL) THEN 0 ELSE A.DEBIT END DEBIT,
               CASE WHEN (A.DEBIT IS NULL AND A.CREDIT IS NULL) THEN 0 ELSE  A.CREDIT END CREDIT, 
               AAD.LINE_DESCRIPTION     AS LINE_DESCRIPTION, 
               UDC1.DESCRIPTION         AS UDC_1, 
               AAD.UDC_2                AS UDC_2, 
               AAD.UDC_3                AS UDC_3, 
               AAD.UDC_4                AS UDC_4, 
               AAD.UDC_5                AS UDC_5, 
               AAD.UDC_6                AS UDC_6, 
               AAD.ACCOUNT_CATEGORY     AS ACCOUNT_CATEGORY, 
               HT.DESCRIPTION         AS ACCOUNT_TYPE ,
               AAD.ADJUSTMENT_LEVEL AS ADJUSTMENT_LEVEL,
               AAD.ACCOUNT_INDICATOR AS ACCOUNT_INDICATOR,
               AAD.ACCOUNT_DESC AS ACCOUNT_DESC,
               CASE WHEN AAC.REDEMPTION_PERIOD = 1 THEN A.REDEMPTION_PERIOD ELSE NULL END AS REP_PERIIOD,
               A.REDEMPTION_PERIOD AS CALCULATION_PERIOD,
               A.WORKFLOW_ID,
               A.WORKFLOW_NAME,
               A.WORKFLOW_STATUS    
               

        FROM   (SELECT ARM_ADJ_RES_CONFIG_MASTER_SID, 
                       GL.COMPANY_ID AS GL_COMPANY_ID, 
                       GL.COMPANY_NO AS GL_COMPANY_NO, 
                       BU.COMPANY_ID AS BU_COMPANY_ID, 
                       BU.COMPANY_NO AS BU_COMPANY_NO, 
                       B.BU_COMPANY_MASTER_SID, 
                       B.GL_IMPACT_DATE AS ACCOUNTING_DATE, 
                       PROJECTION_DESCRIPTION, 
                       CASE WHEN ISNULL(SUM(DEBIT),0) -  ISNULL(SUM(CREDIT),0) > 0 THEN ISNULL(SUM(DEBIT),0) -  ISNULL(SUM(CREDIT),0) 
	                   ELSE NULL END AS DEBIT,
	                   CASE WHEN ISNULL(SUM(CREDIT),0) -  ISNULL(SUM(DEBIT),0) > 0 THEN ISNULL(SUM(CREDIT),0) -  ISNULL(SUM(DEBIT),0)
	                   ELSE NULL END  AS CREDIT,
                       SUM(ACCRUAL_AMOUNT) AS ACCRUAL_AMOUNT,
                       WORKFLOW_ID ,
                       ARM_ADJUSTMENT_CONFIG_SID,
                       TRANSACTION_NAME
						,A.ACCOUNT
                ,A.PERIOD_DATE AS REDEMPTION_PERIOD  ,
         		WORKFLOW_NAME,
         		WORKFLOW_STATUS
                FROM    
				 #TEMP_PROJ_RES_TOTAL A 
                JOIN ARM_ADJUSTMENT_MASTER B 
                  ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID 
                JOIN PROJECTION_MASTER PM 
                  ON PM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID 
                JOIN COMPANY_MASTER BU 
                  ON BU.COMPANY_MASTER_SID = B.BU_COMPANY_MASTER_SID 
                JOIN COMPANY_MASTER GL 
                  ON GL.COMPANY_MASTER_SID = PM.COMPANY_MASTER_SID 
                JOIN ARM_ADJ_RES_CONFIG_MASTER AAM 
                  ON AAM.RS_CATEGORY = A.RS_CATEGORY 
                     AND AAM.RS_TYPE = A.RS_TYPE 
                     AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE 
                     AND PM.COMPANY_MASTER_SID = AAM.GL_COMPANY_MASTER_SID 
                     AND B.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID 
                     AND AAM.CONFIGURATION_TYPE = 0
                GROUP  BY ARM_ADJ_RES_CONFIG_MASTER_SID, 
                          GL.COMPANY_ID, 
                          GL.COMPANY_NO, 
                          BU.COMPANY_ID, 
                          BU.COMPANY_NO, 
                          B.BU_COMPANY_MASTER_SID, 
                          B.GL_IMPACT_DATE, 
                          PROJECTION_DESCRIPTION, 
                          WORKFLOW_ID ,
                          ARM_ADJUSTMENT_CONFIG_SID,
                          TRANSACTION_NAME
                         ,A.PERIOD_DATE ,
         		WORKFLOW_NAME,
         		WORKFLOW_STATUS,
				A.ACCOUNT
               ) A 
               JOIN #ARM_ADJ_RES_CCP_TOTAL AAD
                 ON AAD.ARM_ADJ_RES_CONFIG_MASTER_SID = A.ARM_ADJ_RES_CONFIG_MASTER_SID 
                            --- Don't delete. This line is needed in the future for calculation changes
                         AND A.ARM_ADJUSTMENT_CONFIG_SID=AAD.ADJUSTMENT_TYPE
							AND A.ACCOUNT=AAD.ACCOUNT
               JOIN HELPER_TABLE HT 
                 ON HT.HELPER_TABLE_SID = AAD.ACCOUNT_TYPE 
                  JOIN ARM_ADJUSTMENT_CONFIG AAC ON AAC.ARM_ADJUSTMENT_CONFIG_SID=AAD.ADJUSTMENT_TYPE
                  LEFT JOIN HELPER_TABLE UDC1
                  ON UDC1.HELPER_TABLE_SID = AAD.UDC_1
        WHERE  
        ?AMOUNTCONDITION
        
--A.ACCRUAL_AMOUNT>0.01 AND 
AAD.ADJUSTMENT_LEVEL = @ADJUSTMENTLEVELTOTAL 
               AND AAD.ADJUSTMENT_TYPE = @ADJUSTMENT_TYPE 
               @CATEGORY  
               @TYPE
               @ACCOUNT_CONDITION ) A
                  @PAGINATION
                  SELECT		   
			   ADJUSTMENT_TYPE,
               BALANCE_TYPE, 
               DATABASE_DESC, 
               DATA_ACCESS_SET, 
               CHART_OF_ACCOUNTS, 
               LEDGER, 
               CATEGORY, 
               SOURCE_DESC, 
               CURRENCY, 
               ACCOUNTING_DATE, 
               BATCH_NAME, 
               JOURNAL_NAME, 
               JOURNAL_DESCRIPTION, 
               REVERSE_JOURNAL, 
               REVERSAL_PERIOD_DATE, 
               GL_COMPANY_ID, 
               DIVISION, 
               BU, 
               COST_CENTER, 
               ACCOUNT, 
               BRAND_ID, 
               PROJECT, 
               FUTURE_1, 
               FUTURE_2, 
               DEBIT,
               CREDIT, 
               LINE_DESCRIPTION, 
               UDC_1, 
               UDC_2, 
               UDC_3, 
               UDC_4, 
               UDC_5, 
               UDC_6, 
               ACCOUNT_CATEGORY, 
               ACCOUNT_TYPE ,
               ADJUSTMENT_LEVEL,
               ACCOUNT_INDICATOR,
               ACCOUNT_DESC,
               REP_PERIIOD,
               CALCULATION_PERIOD,
               WORKFLOW_ID,
               WORKFLOW_NAME,
               WORKFLOW_STATUS			   
FROM #FINAL_OUTPUT A
ORDER BY ROW_NUMBER () OVER (@VALUE)
@OFFSET

            ]]>  
        </query>
        
    </entity>
    
    <entity id="Adjustment Reserve Details common query For count">
     
        <query>
            <![CDATA[
                         
              DECLARE @PROJECTION_MASTER_SID INT = @PROJECTIONMASTER,
              @ACCOUNT VARCHAR(8000) = '@ACC_VAL1'
        @SESSION_DECLARE
                
IF OBJECT_ID('TEMPDB..#ARM_ACC') IS NOT NULL
    DROP TABLE #ARM_ACC
CREATE TABLE  #ARM_ACC 
    (ACC_ID VARCHAR(50) )

INSERT INTO #ARM_ACC(ACC_ID)
SELECT TOKEN
FROM  UDF_SPLITSTRING(@ACCOUNT, ',')  

    IF OBJECT_ID('TEMPDB..#ARM_ADJ_RES_CCP') IS NOT NULL
      DROP TABLE #ARM_ADJ_RES_CCP

SELECT  DISTINCT A.ARM_ADJUSTMENT_DETAILS_SID,BM.BRAND_ID,ARM_ADJ_RES_CONFIG_MASTER_SID
      ,A.ADJUSTMENT_TYPE
      ,A.ACCOUNT_CATEGORY
      ,A.ACCOUNT_TYPE
      ,A.ACCOUNT
      ,A.ADJUSTMENT_LEVEL
      ,A.CREDIT
      ,A.DEBIT
        ,ACCOUNT_DESC
        ,ACCOUNT_INDICATOR
        ,COST_CENTER
        ,PROJECT
        ,FUTURE_1
        ,FUTURE_2
        ,UDC_1
        ,UDC_2
        ,UDC_3
        ,UDC_4
        ,UDC_5
        ,UDC_6
        ,BALANCE_TYPE
        ,[DATABASE]
        ,DATA_ACCESS_SET
        ,CHART_OF_ACCOUNTS
        ,LEDGER
        ,CATEGORY
        ,A.SOURCE
        ,CURRENCY
        ,JOURNAL_NAME
        ,JOURNAL_DESCRIPTION
        ,REVERSE_JOURNAL
        ,REVERSAL_PERIOD_DATE
        ,LINE_DESCRIPTION 
        ,DIVISION
 INTO #ARM_ADJ_RES_CCP
 FROM ARM_ADJUSTMENT_MASTER AM
 JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID
 JOIN ARM_ADJUSTMENT_DETAILS B ON AM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
 INNER JOIN ARM_ADJ_RES_CCP A ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
      AND AM.TRANSACTION_TYPE = A.ADJUSTMENT_TYPE
 JOIN CCP_DETAILS C 
    ON C.CCP_DETAILS_SID = B.CCP_DETAILS_SID 
 JOIN ITEM_MASTER IM 
    ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID 
 JOIN BRAND_MASTER BM 
    ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
 WHERE AM.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
 
 
    IF OBJECT_ID('TEMPDB..#ARM_ADJ_RES_CCP_BRAND') IS NOT NULL
        DROP TABLE #ARM_ADJ_RES_CCP_BRAND
			
			
        SELECT  DISTINCT BM.BRAND_ID,ARM_ADJ_RES_CONFIG_MASTER_SID
             ,A.ADJUSTMENT_TYPE
             ,A.ACCOUNT_CATEGORY
             ,A.ACCOUNT_TYPE
             ,A.ACCOUNT
             ,A.ADJUSTMENT_LEVEL
             ,A.CREDIT
             ,A.DEBIT
               ,ACCOUNT_DESC
               ,ACCOUNT_INDICATOR
               ,COST_CENTER
               ,PROJECT
               ,FUTURE_1
               ,FUTURE_2
               ,UDC_1
               ,UDC_2
               ,UDC_3
               ,UDC_4
               ,UDC_5
               ,UDC_6
               ,BALANCE_TYPE
               ,[DATABASE]
               ,DATA_ACCESS_SET
               ,CHART_OF_ACCOUNTS
               ,LEDGER
               ,CATEGORY
               ,A.SOURCE
               ,CURRENCY
               ,JOURNAL_NAME
               ,JOURNAL_DESCRIPTION
               ,REVERSE_JOURNAL
               ,REVERSAL_PERIOD_DATE
               ,LINE_DESCRIPTION 
               ,DIVISION
        INTO #ARM_ADJ_RES_CCP_BRAND
        FROM ARM_ADJUSTMENT_MASTER AM
        JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID
        JOIN ARM_ADJUSTMENT_DETAILS B ON AM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
        INNER JOIN ARM_ADJ_RES_CCP A ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
             AND AM.TRANSACTION_TYPE = A.ADJUSTMENT_TYPE
        JOIN CCP_DETAILS C 
           ON C.CCP_DETAILS_SID = B.CCP_DETAILS_SID 
        JOIN ITEM_MASTER IM 
           ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID 
        JOIN BRAND_MASTER BM 
           ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
        WHERE AM.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID

 IF OBJECT_ID('TEMPDB..#ARM_ADJ_RES_CCP_TOTAL') IS NOT NULL
        DROP TABLE #ARM_ADJ_RES_CCP_TOTAL
			
        SELECT  DISTINCT ARM_ADJ_RES_CONFIG_MASTER_SID
             ,A.ADJUSTMENT_TYPE
             ,A.ACCOUNT_CATEGORY
             ,A.ACCOUNT_TYPE
             ,A.ACCOUNT
             ,A.ADJUSTMENT_LEVEL
             ,A.CREDIT
             ,A.DEBIT
               ,ACCOUNT_DESC
               ,ACCOUNT_INDICATOR
               ,COST_CENTER
               ,PROJECT
               ,FUTURE_1
               ,FUTURE_2
               ,UDC_1
               ,UDC_2
               ,UDC_3
               ,UDC_4
               ,UDC_5
               ,UDC_6
               ,BALANCE_TYPE
               ,[DATABASE]
               ,DATA_ACCESS_SET
               ,CHART_OF_ACCOUNTS
               ,LEDGER
               ,CATEGORY
               ,A.SOURCE
               ,CURRENCY
               ,JOURNAL_NAME
               ,JOURNAL_DESCRIPTION
               ,REVERSE_JOURNAL
               ,REVERSAL_PERIOD_DATE
               ,LINE_DESCRIPTION 
               ,DIVISION
        INTO #ARM_ADJ_RES_CCP_TOTAL
        FROM ARM_ADJUSTMENT_MASTER AM
        JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID
        JOIN ARM_ADJUSTMENT_DETAILS B ON AM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
        INNER JOIN ARM_ADJ_RES_CCP A ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
             AND AM.TRANSACTION_TYPE = A.ADJUSTMENT_TYPE
        JOIN CCP_DETAILS C 
           ON C.CCP_DETAILS_SID = B.CCP_DETAILS_SID 
        JOIN ITEM_MASTER IM 
           ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID 
        JOIN BRAND_MASTER BM 
           ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
        WHERE AM.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
 

  IF OBJECT_ID('TEMPDB..#TEMP_PROJ_RES_BRAND') IS NOT NULL
        DROP TABLE #TEMP_PROJ_RES_BRAND

CREATE TABLE #TEMP_PROJ_RES_BRAND 

    ( 
     BRAND_MASTER_SID      INT, 
     BRAND_ID              VARCHAR(50), 
     ACCOUNT               VARCHAR(50), 
     PERIOD_DATE           DATETIME, 
     RS_CATEGORY           INT, 
     RS_TYPE               INT, 
     REBATE_PROGRAM_TYPE   INT, 
     DEBIT                 NUMERIC(22, 6), 
     CREDIT                NUMERIC(22,6),
     ACCRUAL_AMOUNT NUMERIC(22,6),
     PROJECTION_MASTER_SID INT, 
     WORKFLOW_MASTER_SID   INT NULL, 
     WORKFLOW_ID           VARCHAR(50),
     WORKFLOW_NAME           VARCHAR(500),
     WORKFLOW_STATUS           INT,
     ARM_ADJUSTMENT_CONFIG_SID INT,
     TRANSACTION_NAME VARCHAR(50)
    )

INSERT INTO #TEMP_PROJ_RES_BRAND  
            (BRAND_MASTER_SID, 
             BRAND_ID,
             ACCOUNT, 
             PERIOD_DATE, 
             RS_CATEGORY, 
             RS_TYPE, 
             REBATE_PROGRAM_TYPE, 

             DEBIT, 
             CREDIT,
             ACCRUAL_AMOUNT,
             PROJECTION_MASTER_SID, 
             WORKFLOW_MASTER_SID, 
             WORKFLOW_ID,
             WORKFLOW_NAME,
             WORKFLOW_STATUS,
             ARM_ADJUSTMENT_CONFIG_SID,
             TRANSACTION_NAME) 
SELECT IM.BRAND_MASTER_SID, 
       BM.BRAND_ID,
       AR.ACCOUNT,
       P.PERIOD_DATE, 
       RS_CATEGORY, 
       RS_TYPE, 
       REBATE_PROGRAM_TYPE, 
       CASE WHEN ISNULL(SUM(B.DEBIT),0) -  ISNULL(SUM(B.CREDIT),0) > 0 THEN ISNULL(SUM(B.DEBIT),0) -  ISNULL(SUM(B.CREDIT),0) 
	       			        ELSE NULL END AS DEBIT,
				   CASE WHEN ISNULL(SUM(B.CREDIT),0) -  ISNULL(SUM(B.DEBIT),0) > 0 THEN ISNULL(SUM(B.CREDIT),0) -  ISNULL(SUM(B.DEBIT),0)
				   ELSE NULL END  AS CREDIT,
       ISNULL(SUM(B.CREDIT), 0) - ISNULL(SUM(B.DEBIT), 0) AS ACCRUAL_AMOUNT, 
       A.PROJECTION_MASTER_SID, 
       WORKFLOW_MASTER_SID, 
       WORKFLOW_ID,
       PM.PROJECTION_DESCRIPTION,
       WM.WORKFLOW_STATUS_ID,
       ARM_ADJUSTMENT_CONFIG_SID,
       TRANSACTION_NAME
FROM   ARM_ADJUSTMENT_DETAILS A
       JOIN PROJECTION_MASTER PM ON PM.PROJECTION_MASTER_SID=@PROJECTION_MASTER_SID 
       JOIN #ARM_ADJ_RES_CCP AR
	   ON AR.ARM_ADJUSTMENT_DETAILS_SID=A.ARM_ADJUSTMENT_DETAILS_SID 
	   JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=AR.ADJUSTMENT_LEVEL AND HT.DESCRIPTION='BRAND'

           LEFT JOIN @TABLE_1 B  
              ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
              AND  AR.ACCOUNT=B.ACCOUNT
       LEFT JOIN PERIOD P 
         ON P.PERIOD_SID = B.PERIOD_SID 
       LEFT JOIN WORKFLOW_MASTER WM 
         ON WM.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID 
          JOIN ARM_ADJUSTMENT_MASTER AM ON AM.PROJECTION_MASTER_SID=A.PROJECTION_MASTER_SID
          JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE=AC.ARM_ADJUSTMENT_CONFIG_SID
       JOIN CCP_DETAILS C 
         ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID 
       JOIN ITEM_MASTER IM 
         ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID 
       JOIN BRAND_MASTER BM 
         ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
       JOIN RS_CONTRACT R 
         ON R.RS_MODEL_SID = A.RS_MODEL_SID 
            AND R.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID 
       JOIN ARM_DEDUCTION_SELECTION ADS 
         ON ADS.RS_CONTRACT_SID = R.RS_CONTRACT_SID 
            AND ADS.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 
WHERE  A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID AND P.PERIOD_DATE IS NOT NULL
@SESSION_INCLUDE

GROUP  BY IM.BRAND_MASTER_SID,
          AR.ACCOUNT,
          BM.BRAND_ID, 
          P.PERIOD_DATE, 
          RS_CATEGORY, 
          RS_TYPE, 
          REBATE_PROGRAM_TYPE, 
          WORKFLOW_MASTER_SID, 
          A.PROJECTION_MASTER_SID, 
          WORKFLOW_ID,
          PM.PROJECTION_DESCRIPTION,
          WM.WORKFLOW_STATUS_ID,
          ARM_ADJUSTMENT_CONFIG_SID,

          TRANSACTION_NAME ;

IF OBJECT_ID ('TEMPDB..#TEMP_PROJ_RES_TOTAL') IS NOT NULL 
  DROP TABLE #TEMP_PROJ_RES_TOTAL 

CREATE TABLE #TEMP_PROJ_RES_TOTAL 

  ( 
     BRAND_MASTER_SID      INT, 
     BRAND_ID              VARCHAR(50),
	 ACCOUNT               VARCHAR(50), 
     PERIOD_DATE           DATETIME, 
     RS_CATEGORY           INT, 
     RS_TYPE               INT, 
     REBATE_PROGRAM_TYPE   INT, 
     DEBIT        NUMERIC(22, 6), 
	 CREDIT NUMERIC(22,6),
	 ACCRUAL_AMOUNT NUMERIC(22,6),
     PROJECTION_MASTER_SID INT, 
     WORKFLOW_MASTER_SID   INT NULL, 
     WORKFLOW_ID           VARCHAR(50),
     WORKFLOW_NAME           VARCHAR(500),
     WORKFLOW_STATUS           INT,
     ARM_ADJUSTMENT_CONFIG_SID INT,
     TRANSACTION_NAME VARCHAR(50)
  )

INSERT INTO #TEMP_PROJ_RES_TOTAL 
            (BRAND_MASTER_SID, 
             BRAND_ID,

			 ACCOUNT, 
             PERIOD_DATE, 
             RS_CATEGORY, 
             RS_TYPE, 
             REBATE_PROGRAM_TYPE, 

             DEBIT, 
             CREDIT,
			 ACCRUAL_AMOUNT,
             PROJECTION_MASTER_SID, 
             WORKFLOW_MASTER_SID, 
             WORKFLOW_ID,
             WORKFLOW_NAME,
             WORKFLOW_STATUS,
             ARM_ADJUSTMENT_CONFIG_SID,
             TRANSACTION_NAME) 
SELECT IM.BRAND_MASTER_SID, 
       BM.BRAND_ID,
	   AR.ACCOUNT,
       P.PERIOD_DATE, 
       RS_CATEGORY, 
       RS_TYPE, 
       REBATE_PROGRAM_TYPE, 
       ISNULL(SUM(B.DEBIT),0) AS DEBIT,
	   ISNULL(SUM(B.CREDIT),0) AS CREDIT,
	   ISNULL(SUM(B.CREDIT), 0) - ISNULL(SUM(B.DEBIT), 0) AS ACCRUAL_AMOUNT, 
       A.PROJECTION_MASTER_SID, 
       WORKFLOW_MASTER_SID, 
       WORKFLOW_ID,
       PM.PROJECTION_DESCRIPTION,
       WM.WORKFLOW_STATUS_ID,
       ARM_ADJUSTMENT_CONFIG_SID,
       TRANSACTION_NAME
FROM   ARM_ADJUSTMENT_DETAILS A
       JOIN PROJECTION_MASTER PM ON PM.PROJECTION_MASTER_SID=@PROJECTION_MASTER_SID 
       JOIN #ARM_ADJ_RES_CCP AR
	   ON AR.ARM_ADJUSTMENT_DETAILS_SID=A.ARM_ADJUSTMENT_DETAILS_SID 
	   JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=AR.ADJUSTMENT_LEVEL AND HT.DESCRIPTION='TOTAL'

           LEFT JOIN @TABLE_1 B  
              ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
              AND  AR.ACCOUNT=B.ACCOUNT
       LEFT JOIN PERIOD P 
         ON P.PERIOD_SID = B.PERIOD_SID 
       LEFT JOIN WORKFLOW_MASTER WM 
         ON WM.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID 
          JOIN ARM_ADJUSTMENT_MASTER AM ON AM.PROJECTION_MASTER_SID=A.PROJECTION_MASTER_SID
          JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE=AC.ARM_ADJUSTMENT_CONFIG_SID
       JOIN CCP_DETAILS C 
         ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID 
       JOIN ITEM_MASTER IM 
         ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID 
       JOIN BRAND_MASTER BM 
         ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
       JOIN RS_CONTRACT R 
         ON R.RS_MODEL_SID = A.RS_MODEL_SID 
            AND R.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID 
       JOIN ARM_DEDUCTION_SELECTION ADS 
         ON ADS.RS_CONTRACT_SID = R.RS_CONTRACT_SID 
            AND ADS.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 
WHERE  A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID  AND P.PERIOD_DATE IS NOT NULL

GROUP  BY IM.BRAND_MASTER_SID,
          AR.ACCOUNT,
          BM.BRAND_ID, 
          P.PERIOD_DATE, 
          RS_CATEGORY, 
          RS_TYPE, 
          REBATE_PROGRAM_TYPE, 
          WORKFLOW_MASTER_SID, 
          A.PROJECTION_MASTER_SID, 
          WORKFLOW_ID,
          PM.PROJECTION_DESCRIPTION,
          WM.WORKFLOW_STATUS_ID,
          ARM_ADJUSTMENT_CONFIG_SID,
          TRANSACTION_NAME   

    select count(*) from (
        SELECT   AAC.TRANSACTION_NAME       AS ADJUSTMENT_TYPE,
               AAD.BALANCE_TYPE         AS BALANCE_TYPE, 
               AAD."DATABASE"           AS DATABASE_DESC, 
               AAD.DATA_ACCESS_SET      AS DATA_ACCESS_SET, 
               AAD.CHART_OF_ACCOUNTS    AS CHART_OF_ACCOUNTS, 
               AAD.LEDGER               AS LEDGER, 
               AAD.CATEGORY             AS CATEGORY, 
               AAD."SOURCE"             AS SOURCE_DESC, 
               AAD.CURRENCY             AS CURRENCY, 
               B.GL_IMPACT_DATE       AS ACCOUNTING_DATE, 
               BATCH_NAME = CASE 
                              WHEN A.WORKFLOW_ID = NULL THEN '' 
                              ELSE CONVERT(VARCHAR(100), A.TRANSACTION_NAME) 
                                   + ' - ' + ISNULL(A.WORKFLOW_ID, ' ') + ' - ' 
                                   + AAD.JOURNAL_DESCRIPTION

                            END, 
               AAD.JOURNAL_NAME         AS JOURNAL_NAME, 
               AAD.JOURNAL_DESCRIPTION  AS JOURNAL_DESCRIPTION, 
               AAD.REVERSE_JOURNAL      AS REVERSE_JOURNAL, 
               AAD.REVERSAL_PERIOD_DATE AS REVERSAL_PERIOD_DATE, 
               GL.COMPANY_ID         AS GL_COMPANY_ID, 
               AAD.DIVISION             AS DIVISION, 
                BU.COMPANY_ID          AS BU, 
               AAD.COST_CENTER          AS COST_CENTER, 
               AAD.ACCOUNT              AS ACCOUNT, 
               A.BRAND_ID               AS BRAND_ID, 
               AAD.PROJECT              AS PROJECT, 
               AAD.FUTURE_1             AS FUTURE_1, 
               AAD.FUTURE_2             AS FUTURE_2, 
              CASE WHEN (A.DEBIT IS NULL AND A.CREDIT IS NULL) THEN 0 ELSE  A.DEBIT END DEBIT,
              CASE WHEN (A.DEBIT IS NULL AND A.CREDIT IS NULL) THEN 0 ELSE A.CREDIT END CREDIT, 
               AAD.LINE_DESCRIPTION     AS LINE_DESCRIPTION, 
               UDC1.DESCRIPTION         AS UDC_1, 
               AAD.UDC_2                AS UDC_2, 
               AAD.UDC_3                AS UDC_3, 
               AAD.UDC_4                AS UDC_4, 
               AAD.UDC_5                AS UDC_5, 
               AAD.UDC_6                AS UDC_6, 
               AAD.ACCOUNT_CATEGORY     AS ACCOUNT_CATEGORY, 
               HT.DESCRIPTION           AS ACCOUNT_TYPE ,
               AAD.ADJUSTMENT_LEVEL AS ADJUSTMENT_LEVEL,
               AAD.ACCOUNT_INDICATOR AS ACCOUNT_INDICATOR,
               AAD.ACCOUNT_DESC AS ACCOUNT_DESC,
               CASE WHEN AAC.REDEMPTION_PERIOD = 1 THEN A.PERIOD_DATE ELSE NULL END  AS REP_PERIIOD,
               A.PERIOD_DATE AS CALCULATION_PERIOD,
               A.WORKFLOW_ID,
               A.WORKFLOW_NAME,
               A.WORKFLOW_STATUS

            FROM    #TEMP_PROJ_RES_BRAND A 
                JOIN ARM_ADJUSTMENT_MASTER B 
                  ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID 
                JOIN PROJECTION_MASTER PM 
                  ON PM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID 
                JOIN COMPANY_MASTER BU 
                  ON BU.COMPANY_MASTER_SID = B.BU_COMPANY_MASTER_SID 
                JOIN COMPANY_MASTER GL 
                  ON GL.COMPANY_MASTER_SID = PM.COMPANY_MASTER_SID 
                JOIN ARM_ADJ_RES_CONFIG_MASTER AAM 
                  ON AAM.RS_CATEGORY = A.RS_CATEGORY 
                     AND AAM.RS_TYPE = A.RS_TYPE 
                     AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE 
                     AND PM.COMPANY_MASTER_SID = AAM.GL_COMPANY_MASTER_SID 
                     AND B.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID 
                     AND AAM.CONFIGURATION_TYPE = 0
               JOIN #ARM_ADJ_RES_CCP_BRAND AAD 
                 ON AAD.ARM_ADJ_RES_CONFIG_MASTER_SID = AAM.ARM_ADJ_RES_CONFIG_MASTER_SID 
                             --- Don't delete. This line is needed in the future for calculation changes
                           AND A.ARM_ADJUSTMENT_CONFIG_SID=AAD.ADJUSTMENT_TYPE
                           AND A.ACCOUNT=AAD.ACCOUNT
                           AND A.BRAND_ID=AAD.BRAND_ID
                           
               JOIN HELPER_TABLE HT 
                 ON HT.HELPER_TABLE_SID = AAD.ACCOUNT_TYPE 
                 JOIN ARM_ADJUSTMENT_CONFIG AAC ON AAC.ARM_ADJUSTMENT_CONFIG_SID=AAD.ADJUSTMENT_TYPE
                 LEFT JOIN HELPER_TABLE UDC1
                  ON UDC1.HELPER_TABLE_SID = AAD.UDC_1

        WHERE ?AMOUNTCONDITION 
        
--A.ACCRUAL_AMOUNT>0.01 AND 
AAD.ADJUSTMENT_LEVEL = @ADJUSTMENTLEVELBRAND 
               AND AAD.ADJUSTMENT_TYPE = @ADJUSTMENT_TYPE 

                @CATEGORY 
               @TYPE 
               @ACCOUNT_CONDITION 
        UNION ALL 
        SELECT AAC.TRANSACTION_NAME       AS ADJUSTMENT_TYPE,
               AAD.BALANCE_TYPE         AS BALANCE_TYPE, 
               AAD."DATABASE"           AS DATABASE_DESC, 
               AAD.DATA_ACCESS_SET      AS DATA_ACCESS_SET, 
               AAD.CHART_OF_ACCOUNTS    AS CHART_OF_ACCOUNTS, 
               AAD.LEDGER               AS LEDGER, 
               AAD.CATEGORY             AS CATEGORY, 
               AAD."SOURCE"             AS SOURCE_DESC, 
               AAD.CURRENCY             AS CURRENCY, 
               A.ACCOUNTING_DATE        AS ACCOUNTING_DATE, 
               BATCH_NAME = CASE 
                              WHEN A.WORKFLOW_ID = NULL THEN '' 
                              ELSE CONVERT(VARCHAR(100), A.TRANSACTION_NAME) 
                                   + ' - ' + ISNULL(A.WORKFLOW_ID, ' ') + ' - ' 
                                   + AAD.JOURNAL_DESCRIPTION 
                            END, 
               AAD.JOURNAL_NAME         AS JOURNAL_NAME, 
               AAD.JOURNAL_DESCRIPTION  AS JOURNAL_DESCRIPTION, 
               AAD.REVERSE_JOURNAL      AS REVERSE_JOURNAL, 
               AAD.REVERSAL_PERIOD_DATE AS REVERSAL_PERIOD_DATE, 
               A.GL_COMPANY_ID          AS GL_COMPANY_ID, 
               AAD.DIVISION            AS DIVISION, 
               A.BU_COMPANY_ID         AS BU, 
               AAD.COST_CENTER          AS COST_CENTER, 
               AAD.ACCOUNT              AS ACCOUNT, 
               '000'                    AS BRAND_ID, 
               AAD.PROJECT              AS PROJECT, 
               AAD.FUTURE_1             AS FUTURE_1, 
               AAD.FUTURE_2             AS FUTURE_2, 
                CASE WHEN (A.DEBIT IS NULL AND A.CREDIT IS NULL) THEN 0 ELSE A.DEBIT END DEBIT,
               CASE WHEN (A.DEBIT IS NULL AND A.CREDIT IS NULL) THEN 0 ELSE  A.CREDIT END CREDIT, 
               AAD.LINE_DESCRIPTION     AS LINE_DESCRIPTION, 
               UDC1.DESCRIPTION         AS UDC_1, 
               AAD.UDC_2                AS UDC_2, 
               AAD.UDC_3                AS UDC_3, 
               AAD.UDC_4                AS UDC_4, 
               AAD.UDC_5                AS UDC_5, 
               AAD.UDC_6                AS UDC_6, 
               AAD.ACCOUNT_CATEGORY     AS ACCOUNT_CATEGORY, 
               HT.DESCRIPTION         AS ACCOUNT_TYPE ,
               AAD.ADJUSTMENT_LEVEL AS ADJUSTMENT_LEVEL,
               AAD.ACCOUNT_INDICATOR AS ACCOUNT_INDICATOR,
               AAD.ACCOUNT_DESC AS ACCOUNT_DESC,
               CASE WHEN AAC.REDEMPTION_PERIOD = 1 THEN A.REDEMPTION_PERIOD ELSE NULL END AS REP_PERIIOD,
               A.REDEMPTION_PERIOD AS CALCULATION_PERIOD,
               A.WORKFLOW_ID,
               A.WORKFLOW_NAME,
               A.WORKFLOW_STATUS    
               
        FROM   (SELECT ARM_ADJ_RES_CONFIG_MASTER_SID, 
                       GL.COMPANY_ID AS GL_COMPANY_ID, 
                       GL.COMPANY_NO AS GL_COMPANY_NO, 
                       BU.COMPANY_ID AS BU_COMPANY_ID, 
                       BU.COMPANY_NO AS BU_COMPANY_NO, 
                       B.BU_COMPANY_MASTER_SID, 
                       B.GL_IMPACT_DATE AS ACCOUNTING_DATE, 
                       PROJECTION_DESCRIPTION, 
                       CASE WHEN ISNULL(SUM(DEBIT),0) -  ISNULL(SUM(CREDIT),0) > 0 THEN ISNULL(SUM(DEBIT),0) -  ISNULL(SUM(CREDIT),0) 
	                   ELSE NULL END AS DEBIT,
	                   CASE WHEN ISNULL(SUM(CREDIT),0) -  ISNULL(SUM(DEBIT),0) > 0 THEN ISNULL(SUM(CREDIT),0) -  ISNULL(SUM(DEBIT),0)
	                   ELSE NULL END  AS CREDIT,
                       SUM(ACCRUAL_AMOUNT) AS ACCRUAL_AMOUNT,
                       WORKFLOW_ID ,
                       ARM_ADJUSTMENT_CONFIG_SID,

                       TRANSACTION_NAME
						,A.ACCOUNT
                ,A.PERIOD_DATE AS REDEMPTION_PERIOD  ,
         		WORKFLOW_NAME,
         		WORKFLOW_STATUS

                FROM    
				 #TEMP_PROJ_RES_TOTAL A 
                JOIN ARM_ADJUSTMENT_MASTER B 
                  ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID 
                JOIN PROJECTION_MASTER PM 
                  ON PM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID 
                JOIN COMPANY_MASTER BU 
                  ON BU.COMPANY_MASTER_SID = B.BU_COMPANY_MASTER_SID 
                JOIN COMPANY_MASTER GL 
                  ON GL.COMPANY_MASTER_SID = PM.COMPANY_MASTER_SID 
                JOIN ARM_ADJ_RES_CONFIG_MASTER AAM 
                  ON AAM.RS_CATEGORY = A.RS_CATEGORY 
                     AND AAM.RS_TYPE = A.RS_TYPE 
                     AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE 
                     AND PM.COMPANY_MASTER_SID = AAM.GL_COMPANY_MASTER_SID 
                     AND B.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID 
                     AND AAM.CONFIGURATION_TYPE = 0
                GROUP  BY ARM_ADJ_RES_CONFIG_MASTER_SID, 
                          GL.COMPANY_ID, 
                          GL.COMPANY_NO, 
                          BU.COMPANY_ID, 
                          BU.COMPANY_NO, 
                          B.BU_COMPANY_MASTER_SID, 
                          B.GL_IMPACT_DATE, 
                          PROJECTION_DESCRIPTION, 
                          WORKFLOW_ID ,
                          ARM_ADJUSTMENT_CONFIG_SID,
                          TRANSACTION_NAME
                         ,A.PERIOD_DATE ,
         		WORKFLOW_NAME,
         		WORKFLOW_STATUS,
				A.ACCOUNT
               ) A 
               JOIN #ARM_ADJ_RES_CCP_TOTAL AAD
                 ON AAD.ARM_ADJ_RES_CONFIG_MASTER_SID = A.ARM_ADJ_RES_CONFIG_MASTER_SID 
                            --- Don't delete. This line is needed in the future for calculation changes
                         AND A.ARM_ADJUSTMENT_CONFIG_SID=AAD.ADJUSTMENT_TYPE
							AND A.ACCOUNT=AAD.ACCOUNT
               JOIN HELPER_TABLE HT 
                 ON HT.HELPER_TABLE_SID = AAD.ACCOUNT_TYPE 
                  JOIN ARM_ADJUSTMENT_CONFIG AAC ON AAC.ARM_ADJUSTMENT_CONFIG_SID=AAD.ADJUSTMENT_TYPE
                  LEFT JOIN HELPER_TABLE UDC1
                  ON UDC1.HELPER_TABLE_SID = AAD.UDC_1
        WHERE  
?AMOUNTCONDITION
--A.ACCRUAL_AMOUNT>0.01 AND 
AAD.ADJUSTMENT_LEVEL = @ADJUSTMENTLEVELTOTAL 
               AND AAD.ADJUSTMENT_TYPE = @ADJUSTMENT_TYPE 

                @CATEGORY  
               @TYPE
               @ACCOUNT_CONDITION ) A

              
            ]]>  
        </query>
        
    </entity>
    
    <entity id="Adjustment GTN Details common query For count">
     
        <query>
            <![CDATA[
             DECLARE 
                @GL_COMP     INT = @GLCOMP,
                @PROJECTION_MASTER_SID INT = @PROJECTIONMASTER
                   @SESSION_DECLARE

IF OBJECT_ID ('TEMPDB..#TEMP_PROJ_GTN') IS NOT NULL 
        DROP TABLE #TEMP_PROJ_GTN 
                   
CREATE TABLE  #TEMP_PROJ_GTN 
(
   ARM_ADJUSTMENT_DETAILS_SID INT,
   CCP_DETAILS_SID INT,
   RS_MODEL_SID INT,
   PERIOD_DATE DATETIME,
   ACCOUNT VARCHAR(50),
   DEBIT NUMERIC(22, 6),
   CREDIT NUMERIC(22, 6),
   ACCRUAL_AMOUNT NUMERIC(22, 6),
   ACCRUAL_RATE NUMERIC(22, 6)
)

INSERT INTO #TEMP_PROJ_GTN
(
   ARM_ADJUSTMENT_DETAILS_SID,
   CCP_DETAILS_SID,
   RS_MODEL_SID,
   PERIOD_DATE,
   ACCOUNT,
   DEBIT,
   CREDIT,
   ACCRUAL_AMOUNT,
   ACCRUAL_RATE
)
SELECT
A.ARM_ADJUSTMENT_DETAILS_SID,
A.CCP_DETAILS_SID,
A.RS_MODEL_SID,
P.PERIOD_DATE,
ARC.ACCOUNT,
ISNULL(SUM(AA.DEBIT),0) AS DEBIT,
ISNULL(SUM(AA.CREDIT),0) AS CREDIT,
 ISNULL(SUM(AA.CREDIT),0) - ISNULL(SUM(AA.DEBIT),0) AS ACCRUAL_AMOUNT,
 MAX(@RATE_COLUMN) AS RATE
FROM ARM_ADJUSTMENT_DETAILS A

JOIN @TABLE_1 B ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID

JOIN @TABLE_2 ARC ON ARC.ARM_ADJUSTMENT_DETAILS_SID=B.ARM_ADJUSTMENT_DETAILS_SID 

JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=ARC.ADJUSTMENT_LEVEL AND HT.DESCRIPTION='ITEM'
JOIN PERIOD P ON P.PERIOD_SID=B.PERIOD_SID 
LEFT JOIN @TABLE_3 AA ON AA.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
AND ARC.ADJUSTMENT_TYPE=AA.ADJUSTMENT_TYPE
AND ARC.ACCOUNT=AA.ACCOUNT AND B.PERIOD_SID= AA.PERIOD_SID
WHERE A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 
@SESSION_INCLUDE
GROUP BY A.ARM_ADJUSTMENT_DETAILS_SID,
A.CCP_DETAILS_SID,
A.RS_MODEL_SID ,
P.PERIOD_DATE,
ARC.ACCOUNT

IF OBJECT_ID
(
   'TEMPDB..#TEMP_GTN'
)
IS NOT NULL DROP TABLE #TEMP_GTN 
CREATE TABLE #TEMP_GTN
(
   ARM_ADJUSTMENT_DETAILS INT,
   CONTRACT_MASTER_SID INT,
   CONTRACT_ID VARCHAR(50),
   CONTRACT_NO VARCHAR(50),
   [CONTRACT_NAME] VARCHAR(100),
   COMPANY_MASTER_SID INT,
   COMPANY_ID VARCHAR(50),
   COMPANY_NO VARCHAR(50),
   COMPANY_NAME VARCHAR(100),
   ITEM_MASTER_SID INT,
   ITEM_ID VARCHAR(50),
   ITEM_NO VARCHAR(50),
   ITEM_NAME VARCHAR(100),
   BRAND_MASTER_SID INT,
   BRAND_ID VARCHAR(50),
   BRAND_NAME VARCHAR(100),
   RS_MODEL_SID INT,
   RS_CATEGORY VARCHAR(50),
   RS_TYPE VARCHAR(50),
   REBATE_PROGRAM_TYPE VARCHAR(50),
   DEDUCTION_INCLUSION INT,
   RS_ID VARCHAR(50),
   RS_NAME VARCHAR(100),
   RS_NO VARCHAR(50),
   RS_UDC_1 INT,
   RS_UDC_2 INT,
   RS_UDC_3 INT,
   RS_UDC_4 INT,
   RS_UDC_5 INT,
   RS_UDC_6 INT,
   PROJECTION_MASTER_SID INT,
   WORKFLOW_MASTER_SID INT NULL ,
   CREATED_DATE DATETIME,
    WORKFLOW_ID VARCHAR(50),
    WORKFLOW_NAME VARCHAR(500),
    WORKFLOW_STATUS INT 
)
INSERT INTO #TEMP_GTN
(
   ARM_ADJUSTMENT_DETAILS,
   CONTRACT_MASTER_SID,
   CONTRACT_ID,
   CONTRACT_NO,
   [CONTRACT_NAME],
   COMPANY_MASTER_SID,
   COMPANY_ID,
   COMPANY_NO,
   COMPANY_NAME,
   ITEM_MASTER_SID,
   ITEM_ID,
   ITEM_NO,
   ITEM_NAME,
   BRAND_MASTER_SID,
   BRAND_ID,
   BRAND_NAME,
   RS_MODEL_SID,
   RS_CATEGORY,
   RS_TYPE,
   REBATE_PROGRAM_TYPE,
   DEDUCTION_INCLUSION,
   RS_ID,
   RS_NO,
   RS_NAME,
   RS_UDC_1,
   RS_UDC_2,
   RS_UDC_3,
   RS_UDC_4,
   RS_UDC_5,
   RS_UDC_6,
   PROJECTION_MASTER_SID,
   WORKFLOW_MASTER_SID,
   CREATED_DATE,
    WORKFLOW_ID ,
    WORKFLOW_NAME ,
    WORKFLOW_STATUS 
)
SELECT
A.ARM_ADJUSTMENT_DETAILS_SID,
C.CONTRACT_MASTER_SID,
CON.CONTRACT_ID,
CON.CONTRACT_NO,
CON.[CONTRACT_NAME],
C.COMPANY_MASTER_SID,
CM.COMPANY_ID,
CM.COMPANY_NO,
CM.COMPANY_NAME,
C.ITEM_MASTER_SID,
IM.ITEM_ID,
IM.ITEM_NO,
IM.ITEM_NAME,
BM.BRAND_MASTER_SID,
BM.BRAND_ID,
BM.BRAND_NAME,
A.RS_MODEL_SID,
RS_CATEGORY,
RS_TYPE,
REBATE_PROGRAM_TYPE,
DEDUCTION_INCLUSION,
R.RS_ID,
R.RS_NO,
R.RS_NAME,
U.UDC1 AS RS_UDC_1,
U.UDC2 AS RS_UDC_2,
U.UDC3 AS RS_UDC_3,
U.UDC4 AS RS_UDC_4,
U.UDC5 AS RS_UDC_5,
U.UDC6 AS RS_UDC_6,
A.PROJECTION_MASTER_SID,
WM.WORKFLOW_MASTER_SID,
WM.CREATED_DATE,
WM.WORKFLOW_ID,
PM.PROJECTION_DESCRIPTION,
WM.WORKFLOW_STATUS_ID
FROM ARM_ADJUSTMENT_DETAILS A
JOIN CCP_DETAILS C ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID
JOIN PROJECTION_MASTER PM ON PM.PROJECTION_MASTER_SID=@PROJECTION_MASTER_SID
JOIN ITEM_MASTER IM ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
JOIN COMPANY_MASTER CM ON CM.COMPANY_MASTER_SID=C.COMPANY_MASTER_SID
JOIN CONTRACT_MASTER CON ON CON.CONTRACT_MASTER_SID=C.CONTRACT_MASTER_SID
JOIN BRAND_MASTER BM ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
JOIN RS_CONTRACT R ON R.RS_MODEL_SID = A.RS_MODEL_SID
AND R.CONTRACT_MASTER_SID=C.CONTRACT_MASTER_SID
JOIN ARM_DEDUCTION_SELECTION ADS ON ADS.RS_CONTRACT_SID=R.RS_CONTRACT_SID
AND ADS.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
LEFT JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID=A.PROJECTION_MASTER_SID
LEFT JOIN UDCS U ON U.MASTER_SID=R.RS_CONTRACT_SID
AND U.MASTER_TYPE='RS_CONTRACT'
WHERE A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
select count(*) from (
                    SELECT       AC.TRANSACTION_NAME AS ADJUSTMENT_TYPE
        ,RTYPE.DESCRIPTION AS DEDUCTION_TYPE
        ,MONTH(GL_IMPACT_DATE) AS GL_MONTH
        ,YEAR(GL_IMPACT_DATE) AS GL_YEAR
        ,GL.COMPANY_ID+' - '+
	CASE WHEN 
		 (AAD.DIVISION='' OR AAd.DIVISION IS NULL) AND (AAD.COST_CENTER='' OR AAd.COST_CENTER IS NULL)
		THEN AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		WHEN (AAD.DIVISION='' OR AAd.DIVISION IS NULL) AND (AAD.COST_CENTER IS NOT NULL) THEN +AAD.COST_CENTER+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		WHEN (AAD.DIVISION IS NOT NULL) AND (AAD.COST_CENTER='' OR AAd.COST_CENTER IS NULL) THEN AAD.DIVISION+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		ELSE AAD.DIVISION+' - '+AAD.COST_CENTER+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
         END AS GLSTRING
        ,GL.COMPANY_ID AS GL_COMPANY_ID
        ,AAD.DIVISION       AS DIVISION
        ,BU.COMPANY_ID AS BU_COMPANY_ID
        ,AAD.COST_CENTER AS COST_CENTER
        ,AAD.ACCOUNT AS ACCOUNT
        ,A.BRAND_ID AS BRAND_ID
        ,AAD.PROJECT AS PROJECT
        ,AAD.FUTURE_1 AS FUTURE_1
        ,AAD.FUTURE_2 AS FUTURE_2
        ,A.ITEM_NO AS ITEM_NO
        ,CASE WHEN ISNULL(TP.DEBIT,0)-ISNULL(TP.CREDIT,0) > 0 THEN TP.DEBIT
		 ELSE TP.CREDIT * -1 END  AS ACCRUAL_AMOUNT
        ,GL.COMPANY_NO AS GL_COMPANY_NO
        ,GL.COMPANY_NAME AS GL_COMPANY_NAME
        ,BU.COMPANY_NO AS BU_COMPANY_NO
        ,BU.COMPANY_NAME AS BU_COMPANY_NAME
        ,GL_IMPACT_DATE AS GLDATE 
        ,A.CREATED_DATE AS CREATED_DATE
        ,CASE WHEN AC.REDEMPTION_PERIOD=1 THEN TP.PERIOD_DATE ELSE NULL END AS REDEMPTION_PERIOD
        ,A.CONTRACT_ID AS CONTRACT_ID
        ,A.CONTRACT_NO AS CONTRACT_NO
        ,A.CONTRACT_NAME AS CONTRACT_NAME
        ,A.COMPANY_ID AS COMPANY_ID
        ,A.COMPANY_NO AS COMPANY_NO
        ,A.COMPANY_NAME AS COMPANY_NAME
        ,A.ITEM_NO AS ITEM_ID
        ,A.ITEM_NAME AS ITEM_NAME
        ,A.BRAND_NAME AS BRAND_NAME
        ,A.RS_ID AS DEDUCTION_ID
        ,A.RS_NO AS DEDUCTION_NO
        ,A.RS_NAME AS DEDUCTION_NAME
        ,A.RS_CATEGORY AS DEDUCTION_CATEGORY
        ,A.REBATE_PROGRAM_TYPE AS REBATE_PROGRAM_TYPE
        ,A.DEDUCTION_INCLUSION AS DEDUCTION_INCLUSION
        ,A.RS_UDC_1 AS DEDUCTION_UDC_1
        ,A.RS_UDC_2 AS DEDUCTION_UDC_2
        ,A.RS_UDC_3 AS DEDUCTION_UDC_3
        ,A.RS_UDC_4 AS DEDUCTION_UDC_4
        ,A.RS_UDC_5 AS DEDUCTION_UDC_5
        ,A.RS_UDC_6 AS DEDUCTION_UDC_6
        ,TP.ACCRUAL_RATE AS RATE
        ,UDC1.DESCRIPTION AS UDC_1
        ,AAD.UDC_2 AS UDC_2
        ,AAD.UDC_3 AS UDC_3
        ,AAD.UDC_4 AS UDC_4
        ,AAD.UDC_5 AS UDC_5
        ,AAD.UDC_6 AS UDC_6
        ,AAD.ACCOUNT_TYPE AS ACCOUNT_TYPE
        ,AAD.ACCOUNT_CATEGORY AS ACCOUNT_CATEGORY
        ,AAD.ADJUSTMENT_LEVEL AS ADJUSTMENT_LEVEL
        ,AAD.ACCOUNT_DESC AS ACCOUNT_DESC
        ,AAD.ACCOUNT_INDICATOR AS ACCOUNT_INDICATOR
        ,TP.PERIOD_DATE AS CALCULATION_PERIOD
        ,A.WORKFLOW_ID
        ,A.WORKFLOW_NAME
        ,A.WORKFLOW_STATUS
                 FROM #TEMP_GTN A
JOIN ARM_ADJUSTMENT_MASTER AM ON A.PROJECTION_MASTER_SID=AM.PROJECTION_MASTER_SID
JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE=AC.ARM_ADJUSTMENT_CONFIG_SID
LEFT JOIN #TEMP_PROJ_GTN TP ON TP.ARM_ADJUSTMENT_DETAILS_SID=A.ARM_ADJUSTMENT_DETAILS
JOIN ARM_ADJ_RES_CONFIG_MASTER AAM ON AAM.RS_CATEGORY = A.RS_CATEGORY
AND AAM.RS_TYPE = A.RS_TYPE
AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE
AND AAM.GL_COMPANY_MASTER_SID = @GL_COMP
AND AM.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID
AND AAM.CONFIGURATION_TYPE=1
JOIN ARM_ADJ_RES_CCP AAD ON AAD.ARM_ADJ_RES_CONFIG_MASTER_SID = AAM.ARM_ADJ_RES_CONFIG_MASTER_SID
                            AND AC.ARM_ADJUSTMENT_CONFIG_SID=AAD.ADJUSTMENT_TYPE
 AND AAD.ARM_ADJUSTMENT_DETAILS_SID = TP.ARM_ADJUSTMENT_DETAILS_SID
 AND AAD.ACCOUNT=TP.ACCOUNT 
JOIN COMPANY_MASTER GL ON GL.COMPANY_MASTER_SID=@GL_COMP
JOIN COMPANY_MASTER BU ON BU.COMPANY_MASTER_SID=AM.BU_COMPANY_MASTER_SID
LEFT JOIN HELPER_TABLE UDC1 ON UDC1.HELPER_TABLE_SID=AAD.UDC_1
LEFT JOIN HELPER_TABLE RTYPE ON RTYPE.HELPER_TABLE_SID=A.RS_TYPE
WHERE 
?AMOUNTCONDITION
--TP.ACCRUAL_AMOUNT >0.01 AND 
AAD.ADJUSTMENT_TYPE = @ADJUSTMENT_TYPE
@CATEGORY
@TYPE
@ACCOUNT
)A                       


  
            ]]>  
        </query>
        
    </entity>
    <entity id="Adjustment GTN Details common query For data">
     
        <query>
            <![CDATA[
                          DECLARE 
                @GL_COMP     INT = @GLCOMP,
                @PROJECTION_MASTER_SID INT = @PROJECTIONMASTER
                   @SESSION_DECLARE

IF OBJECT_ID ('TEMPDB..#TEMP_PROJ_GTN') IS NOT NULL 
        DROP TABLE #TEMP_PROJ_GTN 
                   
CREATE TABLE  #TEMP_PROJ_GTN 
(
   ARM_ADJUSTMENT_DETAILS_SID INT,
   CCP_DETAILS_SID INT,
   RS_MODEL_SID INT,
   PERIOD_DATE DATETIME,
   ACCOUNT VARCHAR(50),
   DEBIT NUMERIC(22, 6),
   CREDIT NUMERIC(22, 6),
   ACCRUAL_AMOUNT NUMERIC(22, 6),
   ACCRUAL_RATE NUMERIC(22, 6)
)

INSERT INTO #TEMP_PROJ_GTN
(
   ARM_ADJUSTMENT_DETAILS_SID,
   CCP_DETAILS_SID,
   RS_MODEL_SID,
   PERIOD_DATE,
   ACCOUNT,
   DEBIT,
   CREDIT,
   ACCRUAL_AMOUNT,
   ACCRUAL_RATE
)
SELECT
A.ARM_ADJUSTMENT_DETAILS_SID,
A.CCP_DETAILS_SID,
A.RS_MODEL_SID,
P.PERIOD_DATE,
ARC.ACCOUNT,
ISNULL(SUM(AA.DEBIT),0) AS DEBIT,
ISNULL(SUM(AA.CREDIT),0) AS CREDIT,
 ISNULL(SUM(AA.CREDIT),0) - ISNULL(SUM(AA.DEBIT),0) AS ACCRUAL_AMOUNT,
 MAX(@RATE_COLUMN) AS RATE
FROM ARM_ADJUSTMENT_DETAILS A
JOIN @TABLE_1 B ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID

JOIN @TABLE_2 ARC ON ARC.ARM_ADJUSTMENT_DETAILS_SID=B.ARM_ADJUSTMENT_DETAILS_SID 

JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=ARC.ADJUSTMENT_LEVEL AND HT.DESCRIPTION='ITEM'
JOIN PERIOD P ON P.PERIOD_SID=B.PERIOD_SID 
LEFT JOIN @TABLE_3 AA ON AA.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
AND ARC.ADJUSTMENT_TYPE=AA.ADJUSTMENT_TYPE
AND ARC.ACCOUNT=AA.ACCOUNT AND B.PERIOD_SID= AA.PERIOD_SID
WHERE A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 
@SESSION_INCLUDE
GROUP BY A.ARM_ADJUSTMENT_DETAILS_SID,
A.CCP_DETAILS_SID,
A.RS_MODEL_SID ,
P.PERIOD_DATE,
ARC.ACCOUNT

IF OBJECT_ID
(
   'TEMPDB..#TEMP_GTN'
)
IS NOT NULL DROP TABLE #TEMP_GTN 
CREATE TABLE #TEMP_GTN
(
   ARM_ADJUSTMENT_DETAILS INT,
   CONTRACT_MASTER_SID INT,
   CONTRACT_ID VARCHAR(50),
   CONTRACT_NO VARCHAR(50),
   [CONTRACT_NAME] VARCHAR(100),
   COMPANY_MASTER_SID INT,
   COMPANY_ID VARCHAR(50),
   COMPANY_NO VARCHAR(50),
   COMPANY_NAME VARCHAR(100),
   ITEM_MASTER_SID INT,
   ITEM_ID VARCHAR(50),
   ITEM_NO VARCHAR(50),
   ITEM_NAME VARCHAR(100),
   BRAND_MASTER_SID INT,
   BRAND_ID VARCHAR(50),
   BRAND_NAME VARCHAR(100),
   RS_MODEL_SID INT,
   RS_CATEGORY VARCHAR(50),
   RS_TYPE VARCHAR(50),
   REBATE_PROGRAM_TYPE VARCHAR(50),
   DEDUCTION_INCLUSION INT,
   RS_ID VARCHAR(50),
   RS_NAME VARCHAR(100),
   RS_NO VARCHAR(50),
   RS_UDC_1 INT,
   RS_UDC_2 INT,
   RS_UDC_3 INT,
   RS_UDC_4 INT,
   RS_UDC_5 INT,
   RS_UDC_6 INT,
   PROJECTION_MASTER_SID INT,
   WORKFLOW_MASTER_SID INT NULL ,
   CREATED_DATE DATETIME,
    WORKFLOW_ID VARCHAR(50),
    WORKFLOW_NAME VARCHAR(500),
    WORKFLOW_STATUS INT 
)
INSERT INTO #TEMP_GTN
(
   ARM_ADJUSTMENT_DETAILS,
   CONTRACT_MASTER_SID,
   CONTRACT_ID,
   CONTRACT_NO,
   [CONTRACT_NAME],
   COMPANY_MASTER_SID,
   COMPANY_ID,
   COMPANY_NO,
   COMPANY_NAME,
   ITEM_MASTER_SID,
   ITEM_ID,
   ITEM_NO,
   ITEM_NAME,
   BRAND_MASTER_SID,
   BRAND_ID,
   BRAND_NAME,
   RS_MODEL_SID,
   RS_CATEGORY,
   RS_TYPE,
   REBATE_PROGRAM_TYPE,
   DEDUCTION_INCLUSION,
   RS_ID,
   RS_NO,
   RS_NAME,
   RS_UDC_1,
   RS_UDC_2,
   RS_UDC_3,
   RS_UDC_4,
   RS_UDC_5,
   RS_UDC_6,
   PROJECTION_MASTER_SID,
   WORKFLOW_MASTER_SID,
   CREATED_DATE,
    WORKFLOW_ID ,
    WORKFLOW_NAME ,
    WORKFLOW_STATUS 
)
SELECT
A.ARM_ADJUSTMENT_DETAILS_SID,
C.CONTRACT_MASTER_SID,
CON.CONTRACT_ID,
CON.CONTRACT_NO,
CON.[CONTRACT_NAME],
C.COMPANY_MASTER_SID,
CM.COMPANY_ID,
CM.COMPANY_NO,
CM.COMPANY_NAME,
C.ITEM_MASTER_SID,
IM.ITEM_ID,
IM.ITEM_NO,
IM.ITEM_NAME,
BM.BRAND_MASTER_SID,
BM.BRAND_ID,
BM.BRAND_NAME,
A.RS_MODEL_SID,
RS_CATEGORY,
RS_TYPE,
REBATE_PROGRAM_TYPE,
DEDUCTION_INCLUSION,
R.RS_ID,
R.RS_NO,
R.RS_NAME,
U.UDC1 AS RS_UDC_1,
U.UDC2 AS RS_UDC_2,
U.UDC3 AS RS_UDC_3,
U.UDC4 AS RS_UDC_4,
U.UDC5 AS RS_UDC_5,
U.UDC6 AS RS_UDC_6,
A.PROJECTION_MASTER_SID,
WM.WORKFLOW_MASTER_SID,
WM.CREATED_DATE,
WM.WORKFLOW_ID,
PM.PROJECTION_DESCRIPTION,
WM.WORKFLOW_STATUS_ID
FROM ARM_ADJUSTMENT_DETAILS A
JOIN CCP_DETAILS C ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID
JOIN PROJECTION_MASTER PM ON PM.PROJECTION_MASTER_SID=@PROJECTION_MASTER_SID
JOIN ITEM_MASTER IM ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
JOIN COMPANY_MASTER CM ON CM.COMPANY_MASTER_SID=C.COMPANY_MASTER_SID
JOIN CONTRACT_MASTER CON ON CON.CONTRACT_MASTER_SID=C.CONTRACT_MASTER_SID
JOIN BRAND_MASTER BM ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
JOIN RS_CONTRACT R ON R.RS_MODEL_SID = A.RS_MODEL_SID
AND R.CONTRACT_MASTER_SID=C.CONTRACT_MASTER_SID
JOIN ARM_DEDUCTION_SELECTION ADS ON ADS.RS_CONTRACT_SID=R.RS_CONTRACT_SID
AND ADS.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
LEFT JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID=A.PROJECTION_MASTER_SID
LEFT JOIN UDCS U ON U.MASTER_SID=R.RS_CONTRACT_SID
AND U.MASTER_TYPE='RS_CONTRACT'
WHERE A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
          IF OBJECT_ID('TEMPDB..#FINAL_OUTPUT') IS NOT NULL
      DROP TABLE #FINAL_OUTPUT
         SELECT
 * INTO #FINAL_OUTPUT
FROM (
                    SELECT       AC.TRANSACTION_NAME AS ADJUSTMENT_TYPE
        ,RTYPE.DESCRIPTION AS DEDUCTION_TYPE
        ,MONTH(GL_IMPACT_DATE) AS GL_MONTH
        ,YEAR(GL_IMPACT_DATE) AS GL_YEAR
        ,GL.COMPANY_ID+' - '+
	CASE WHEN 
		 (AAD.DIVISION='' OR AAd.DIVISION IS NULL) AND (AAD.COST_CENTER='' OR AAd.COST_CENTER IS NULL)
		THEN AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		WHEN (AAD.DIVISION='' OR AAd.DIVISION IS NULL) AND (AAD.COST_CENTER IS NOT NULL) THEN +AAD.COST_CENTER+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		WHEN (AAD.DIVISION IS NOT NULL) AND (AAD.COST_CENTER='' OR AAd.COST_CENTER IS NULL) THEN AAD.DIVISION+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		ELSE AAD.DIVISION+' - '+AAD.COST_CENTER+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
         END AS GLSTRING
        ,GL.COMPANY_ID AS GL_COMPANY_ID
        ,AAD.DIVISION       AS DIVISION
        ,BU.COMPANY_ID AS BU_COMPANY_ID
        ,AAD.COST_CENTER AS COST_CENTER
        ,AAD.ACCOUNT AS ACCOUNT
        ,A.BRAND_ID AS BRAND_ID
        ,AAD.PROJECT AS PROJECT
        ,AAD.FUTURE_1 AS FUTURE_1
        ,AAD.FUTURE_2 AS FUTURE_2
        ,A.ITEM_NO AS ITEM_NO
        ,CASE WHEN ISNULL(TP.DEBIT,0)-ISNULL(TP.CREDIT,0) > 0 THEN TP.DEBIT
		 ELSE TP.CREDIT * -1 END  AS ACCRUAL_AMOUNT
        ,GL.COMPANY_NO AS GL_COMPANY_NO
        ,GL.COMPANY_NAME AS GL_COMPANY_NAME
        ,BU.COMPANY_NO AS BU_COMPANY_NO
        ,BU.COMPANY_NAME AS BU_COMPANY_NAME
        ,GL_IMPACT_DATE AS GLDATE 
        ,A.CREATED_DATE AS CREATED_DATE
        ,CASE WHEN AC.REDEMPTION_PERIOD=1 THEN TP.PERIOD_DATE ELSE NULL END AS REDEMPTION_PERIOD
        ,A.CONTRACT_ID AS CONTRACT_ID
        ,A.CONTRACT_NO AS CONTRACT_NO
        ,A.CONTRACT_NAME AS CONTRACT_NAME
        ,A.COMPANY_ID AS COMPANY_ID
        ,A.COMPANY_NO AS COMPANY_NO
        ,A.COMPANY_NAME AS COMPANY_NAME
        ,A.ITEM_NO AS ITEM_ID
        ,A.ITEM_NAME AS ITEM_NAME
        ,A.BRAND_NAME AS BRAND_NAME
        ,A.RS_ID AS DEDUCTION_ID
        ,A.RS_NO AS DEDUCTION_NO
        ,A.RS_NAME AS DEDUCTION_NAME
        ,A.RS_CATEGORY AS DEDUCTION_CATEGORY
        ,A.REBATE_PROGRAM_TYPE AS REBATE_PROGRAM_TYPE
        ,A.DEDUCTION_INCLUSION AS DEDUCTION_INCLUSION
        ,A.RS_UDC_1 AS DEDUCTION_UDC_1
        ,A.RS_UDC_2 AS DEDUCTION_UDC_2
        ,A.RS_UDC_3 AS DEDUCTION_UDC_3
        ,A.RS_UDC_4 AS DEDUCTION_UDC_4
        ,A.RS_UDC_5 AS DEDUCTION_UDC_5
        ,A.RS_UDC_6 AS DEDUCTION_UDC_6
        ,TP.ACCRUAL_RATE AS RATE
        ,UDC1.DESCRIPTION AS UDC_1
        ,AAD.UDC_2 AS UDC_2
        ,AAD.UDC_3 AS UDC_3
        ,AAD.UDC_4 AS UDC_4
        ,AAD.UDC_5 AS UDC_5
        ,AAD.UDC_6 AS UDC_6
        ,AAD.ACCOUNT_TYPE AS ACCOUNT_TYPE
        ,AAD.ACCOUNT_CATEGORY AS ACCOUNT_CATEGORY
        ,AAD.ADJUSTMENT_LEVEL AS ADJUSTMENT_LEVEL
        ,AAD.ACCOUNT_DESC AS ACCOUNT_DESC
        ,AAD.ACCOUNT_INDICATOR AS ACCOUNT_INDICATOR
        ,TP.PERIOD_DATE AS CALCULATION_PERIOD
        ,A.WORKFLOW_ID
        ,A.WORKFLOW_NAME
        ,A.WORKFLOW_STATUS
                 FROM #TEMP_GTN A
JOIN ARM_ADJUSTMENT_MASTER AM ON A.PROJECTION_MASTER_SID=AM.PROJECTION_MASTER_SID
JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE=AC.ARM_ADJUSTMENT_CONFIG_SID
LEFT JOIN #TEMP_PROJ_GTN TP ON TP.ARM_ADJUSTMENT_DETAILS_SID=A.ARM_ADJUSTMENT_DETAILS
JOIN ARM_ADJ_RES_CONFIG_MASTER AAM ON AAM.RS_CATEGORY = A.RS_CATEGORY
AND AAM.RS_TYPE = A.RS_TYPE
AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE
AND AAM.GL_COMPANY_MASTER_SID = @GL_COMP
AND AM.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID
AND AAM.CONFIGURATION_TYPE=1
JOIN ARM_ADJ_RES_CCP AAD ON AAD.ARM_ADJ_RES_CONFIG_MASTER_SID = AAM.ARM_ADJ_RES_CONFIG_MASTER_SID
                            AND AC.ARM_ADJUSTMENT_CONFIG_SID=AAD.ADJUSTMENT_TYPE
 AND AAD.ARM_ADJUSTMENT_DETAILS_SID = TP.ARM_ADJUSTMENT_DETAILS_SID
 AND AAD.ACCOUNT=TP.ACCOUNT 
JOIN COMPANY_MASTER GL ON GL.COMPANY_MASTER_SID=@GL_COMP
JOIN COMPANY_MASTER BU ON BU.COMPANY_MASTER_SID=AM.BU_COMPANY_MASTER_SID
LEFT JOIN HELPER_TABLE UDC1 ON UDC1.HELPER_TABLE_SID=AAD.UDC_1
LEFT JOIN HELPER_TABLE RTYPE ON RTYPE.HELPER_TABLE_SID=A.RS_TYPE
WHERE 
?AMOUNTCONDITION
--TP.ACCRUAL_AMOUNT >0.01 AND 
AAD.ADJUSTMENT_TYPE = @ADJUSTMENT_TYPE
@CATEGORY
@TYPE
@ACCOUNT
) A
@PAGINATION   
 
 SELECT		   
	ADJUSTMENT_TYPE,
DEDUCTION_TYPE,
GL_MONTH,
GL_YEAR,
GLSTRING,
GL_COMPANY_ID,
DIVISION,
BU_COMPANY_ID,
COST_CENTER,
ACCOUNT,
BRAND_ID,
PROJECT,
FUTURE_1,
FUTURE_2,
ITEM_NO,
ACCRUAL_AMOUNT,
GL_COMPANY_NO,
GL_COMPANY_NAME,
BU_COMPANY_NO,
BU_COMPANY_NAME,
GLDATE ,
CREATED_DATE,
REDEMPTION_PERIOD,
CONTRACT_ID,
CONTRACT_NO,
CONTRACT_NAME,
COMPANY_ID,
COMPANY_NO,
COMPANY_NAME,
ITEM_ID,
ITEM_NAME,
BRAND_NAME,
DEDUCTION_ID,
DEDUCTION_NO,
DEDUCTION_NAME,
DEDUCTION_CATEGORY,
REBATE_PROGRAM_TYPE,
DEDUCTION_INCLUSION,
DEDUCTION_UDC_1,
DEDUCTION_UDC_2,
DEDUCTION_UDC_3,
DEDUCTION_UDC_4,
DEDUCTION_UDC_5,
DEDUCTION_UDC_6,
RATE,
UDC_1,
UDC_2,
UDC_3,
 UDC_4,
UDC_5,
UDC_6,
ACCOUNT_TYPE,
ACCOUNT_CATEGORY,
ADJUSTMENT_LEVEL,
ACCOUNT_DESC,
ACCOUNT_INDICATOR,
CALCULATION_PERIOD,
WORKFLOW_ID,
WORKFLOW_NAME,
WORKFLOW_STATUS			   
FROM #FINAL_OUTPUT A
ORDER BY ROW_NUMBER () OVER (@VALUE)
@OFFSET
  
                                
            ]]>  
        </query>
        
    </entity>
    <entity id="Adjustment GTN Details Trx6 query For data">
     
        <query>
            <![CDATA[
DECLARE 
   @GL_COMP     INT = @GLCOMP,
   @PROJECTION_MASTER_SID INT = @PROJECTIONMASTER
   @SESSION_DECLARE   
DECLARE @TEMP_PROJ_GTN AS TABLE
(
   ARM_ADJUSTMENT_DETAILS_SID INT,
   CCP_DETAILS_SID INT,
   RS_MODEL_SID INT,
   PERIOD_DATE DATETIME,
   ACCOUNT VARCHAR(50),
   DEBIT NUMERIC(22, 6),
   CREDIT NUMERIC(22, 6),
   ACCRUAL_AMOUNT NUMERIC(22, 6),
   ACCRUAL_RATE NUMERIC(22, 6)
)
INSERT INTO @TEMP_PROJ_GTN
(
   ARM_ADJUSTMENT_DETAILS_SID,
   CCP_DETAILS_SID,
   RS_MODEL_SID,
   PERIOD_DATE,
   ACCOUNT,
   DEBIT,
   CREDIT,
   ACCRUAL_AMOUNT,
   ACCRUAL_RATE
)
SELECT
A.ARM_ADJUSTMENT_DETAILS_SID,
A.CCP_DETAILS_SID,
A.RS_MODEL_SID,
P.PERIOD_DATE,
AA.ACCOUNT,
ISNULL(SUM(AA.DEBIT),0) AS DEBIT,
ISNULL(SUM(AA.CREDIT),0) AS CREDIT,
ISNULL(SUM(AA.CREDIT),0) - ISNULL(SUM(AA.DEBIT),0) AS ACCRUAL_AMOUNT,
SUM(INFLATION_FACTOR) AS RATE
FROM ARM_ADJUSTMENT_DETAILS A
JOIN @TABLE_1 B ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
JOIN @TABLE_3 AA ON AA.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
JOIN CCP_DETAILS CD 
ON A.CCP_DETAILS_SID=CD.CCP_DETAILS_SID 
JOIN @TABLE_2 C ON A.PROJECTION_MASTER_SID=C.PROJECTION_MASTER_SID
AND CD.COMPANY_MASTER_SID=C.COMPANY_MASTER_SID AND CD.ITEM_MASTER_SID=C.ITEM_MASTER_SID
AND B.PERIOD_SID=C.PERIOD_SID 
JOIN PERIOD P ON P.PERIOD_SID=B.PERIOD_SID AND B.PERIOD_SID=AA.PERIOD_SID
WHERE A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
@SESSION_INCLUDE
GROUP BY A.ARM_ADJUSTMENT_DETAILS_SID,
A.CCP_DETAILS_SID,
A.RS_MODEL_SID ,
P.PERIOD_DATE,
AA.ACCOUNT

IF OBJECT_ID
(
   'TEMPDB..#TEMP_GTN'
)
IS NOT NULL DROP TABLE #TEMP_GTN 
CREATE TABLE #TEMP_GTN
(
   ARM_ADJUSTMENT_DETAILS INT,
   CONTRACT_MASTER_SID INT,
   CONTRACT_ID VARCHAR(50),
   CONTRACT_NO VARCHAR(50),
   [CONTRACT_NAME] VARCHAR(100),
   COMPANY_MASTER_SID INT,
   COMPANY_ID VARCHAR(50),
   COMPANY_NO VARCHAR(50),
   COMPANY_NAME VARCHAR(100),
   ITEM_MASTER_SID INT,
   ITEM_ID VARCHAR(50),
   ITEM_NO VARCHAR(50),
   ITEM_NAME VARCHAR(100),
   BRAND_MASTER_SID INT,
   BRAND_ID VARCHAR(50),
   BRAND_NAME VARCHAR(100),
   RS_MODEL_SID INT,
   RS_CATEGORY VARCHAR(50),
   RS_TYPE VARCHAR(50),
   REBATE_PROGRAM_TYPE VARCHAR(50),
   DEDUCTION_INCLUSION INT,
   RS_ID VARCHAR(50),
   RS_NAME VARCHAR(100),
   RS_NO VARCHAR(50),
   RS_UDC_1 INT,
   RS_UDC_2 INT,
   RS_UDC_3 INT,
   RS_UDC_4 INT,
   RS_UDC_5 INT,
   RS_UDC_6 INT,
   PROJECTION_MASTER_SID INT,
   WORKFLOW_MASTER_SID INT NULL ,
   CREATED_DATE DATETIME,
    WORKFLOW_ID VARCHAR(50),
    WORKFLOW_NAME VARCHAR(500),
    WORKFLOW_STATUS INT 
)
INSERT INTO #TEMP_GTN
(
   ARM_ADJUSTMENT_DETAILS,
   CONTRACT_MASTER_SID,
   CONTRACT_ID,
   CONTRACT_NO,
   [CONTRACT_NAME],
   COMPANY_MASTER_SID,
   COMPANY_ID,
   COMPANY_NO,
   COMPANY_NAME,
   ITEM_MASTER_SID,
   ITEM_ID,
   ITEM_NO,
   ITEM_NAME,
   BRAND_MASTER_SID,
   BRAND_ID,
   BRAND_NAME,
   RS_MODEL_SID,
   RS_CATEGORY,
   RS_TYPE,
   REBATE_PROGRAM_TYPE,
   DEDUCTION_INCLUSION,
   RS_ID,
   RS_NO,
   RS_NAME,
   RS_UDC_1,
   RS_UDC_2,
   RS_UDC_3,
   RS_UDC_4,
   RS_UDC_5,
   RS_UDC_6,
   PROJECTION_MASTER_SID,
   WORKFLOW_MASTER_SID,
   CREATED_DATE,
    WORKFLOW_ID ,
    WORKFLOW_NAME ,
    WORKFLOW_STATUS 
)
SELECT
A.ARM_ADJUSTMENT_DETAILS_SID,
C.CONTRACT_MASTER_SID,
CON.CONTRACT_ID,
CON.CONTRACT_NO,
CON.[CONTRACT_NAME],
C.COMPANY_MASTER_SID,
CM.COMPANY_ID,
CM.COMPANY_NO,
CM.COMPANY_NAME,
C.ITEM_MASTER_SID,
IM.ITEM_ID,
IM.ITEM_NO,
IM.ITEM_NAME,
BM.BRAND_MASTER_SID,
BM.BRAND_ID,
BM.BRAND_NAME,
A.RS_MODEL_SID,
RS_CATEGORY,
RS_TYPE,
REBATE_PROGRAM_TYPE,
DEDUCTION_INCLUSION,
R.RS_ID,
R.RS_NO,
R.RS_NAME,
U.UDC1 AS RS_UDC_1,
U.UDC2 AS RS_UDC_2,
U.UDC3 AS RS_UDC_3,
U.UDC4 AS RS_UDC_4,
U.UDC5 AS RS_UDC_5,
U.UDC6 AS RS_UDC_6,
A.PROJECTION_MASTER_SID,
WM.WORKFLOW_MASTER_SID,
WM.CREATED_DATE,
WM.WORKFLOW_ID,
PM.PROJECTION_DESCRIPTION,
WM.WORKFLOW_STATUS_ID
FROM ARM_ADJUSTMENT_DETAILS A
JOIN CCP_DETAILS C ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID
JOIN PROJECTION_MASTER PM ON PM.PROJECTION_MASTER_SID=@PROJECTION_MASTER_SID
JOIN ITEM_MASTER IM ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
JOIN COMPANY_MASTER CM ON CM.COMPANY_MASTER_SID=C.COMPANY_MASTER_SID
JOIN CONTRACT_MASTER CON ON CON.CONTRACT_MASTER_SID=C.CONTRACT_MASTER_SID
JOIN BRAND_MASTER BM ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
JOIN RS_CONTRACT R ON R.RS_MODEL_SID = A.RS_MODEL_SID
AND R.CONTRACT_MASTER_SID=C.CONTRACT_MASTER_SID
JOIN ARM_DEDUCTION_SELECTION ADS ON ADS.RS_CONTRACT_SID=R.RS_CONTRACT_SID
AND ADS.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
LEFT JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID=A.PROJECTION_MASTER_SID
LEFT JOIN UDCS U ON U.MASTER_SID=R.RS_CONTRACT_SID
AND U.MASTER_TYPE='RS_CONTRACT'
WHERE A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
  IF OBJECT_ID('TEMPDB..#FINAL_OUTPUT') IS NOT NULL
      DROP TABLE #FINAL_OUTPUT
         SELECT
 * INTO #FINAL_OUTPUT
FROM (
                    SELECT         AC.TRANSACTION_NAME AS ADJUSTMENT_TYPE
        ,A.RS_TYPE AS DEDUCTION_TYPE
        ,MONTH(GL_IMPACT_DATE) AS GL_MONTH
        ,YEAR(GL_IMPACT_DATE) AS GL_YEAR
        ,GL.COMPANY_ID+' - '+	
        CASE WHEN 
		 (AAD.DIVISION='' OR AAd.DIVISION IS NULL) AND (AAD.COST_CENTER='' OR AAd.COST_CENTER IS NULL)
		THEN AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		WHEN (AAD.DIVISION='' OR AAd.DIVISION IS NULL) AND (AAD.COST_CENTER IS NOT NULL) THEN +AAD.COST_CENTER+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		WHEN (AAD.DIVISION IS NOT NULL) AND (AAD.COST_CENTER='' OR AAd.COST_CENTER IS NULL) THEN AAD.DIVISION+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		ELSE AAD.DIVISION+' - '+AAD.COST_CENTER+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
         END AS GLSTRING
        ,GL.COMPANY_ID AS GL_COMPANY_ID
        ,AAD.DIVISION       AS DIVISION
        ,BU.COMPANY_ID AS BU_COMPANY_ID
        ,AAD.COST_CENTER AS COST_CENTER
        ,AAD.ACCOUNT AS ACCOUNT
        ,A.BRAND_ID AS BRAND_ID
        ,AAD.PROJECT AS PROJECT
        ,AAD.FUTURE_1 AS FUTURE_1
        ,AAD.FUTURE_2 AS FUTURE_2
        ,A.ITEM_NO AS ITEM_NO
        ,TP.ACCRUAL_AMOUNT AS ACCRUAL_AMOUNT
        ,GL.COMPANY_NO AS GL_COMPANY_NO
        ,GL.COMPANY_NAME AS GL_COMPANY_NAME
        ,BU.COMPANY_NO AS BU_COMPANY_NO
        ,BU.COMPANY_NAME AS BU_COMPANY_NAME
        ,GL_IMPACT_DATE AS GLDATE 
        ,A.CREATED_DATE AS CREATED_DATE
        ,CASE WHEN AC.REDEMPTION_PERIOD=1 THEN TP.PERIOD_DATE ELSE NULL END AS REDEMPTION_PERIOD
        ,A.CONTRACT_ID AS CONTRACT_ID
        ,A.CONTRACT_NO AS CONTRACT_NO
        ,A.CONTRACT_NAME AS CONTRACT_NAME
        ,A.COMPANY_ID AS COMPANY_ID
        ,A.COMPANY_NO AS COMPANY_NO
        ,A.COMPANY_NAME AS COMPANY_NAME
        ,A.ITEM_NO AS ITEM_ID
        ,A.ITEM_NAME AS ITEM_NAME
        ,A.BRAND_NAME AS BRAND_NAME
        ,A.RS_ID AS DEDUCTION_ID
        ,A.RS_NO AS DEDUCTION_NO
        ,A.RS_NAME AS DEDUCTION_NAME
        ,A.RS_CATEGORY AS DEDUCTION_CATEGORY
        ,A.REBATE_PROGRAM_TYPE AS REBATE_PROGRAM_TYPE
        ,A.DEDUCTION_INCLUSION AS DEDUCTION_INCLUSION
        ,A.RS_UDC_1 AS DEDUCTION_UDC_1
        ,A.RS_UDC_2 AS DEDUCTION_UDC_2
        ,A.RS_UDC_3 AS DEDUCTION_UDC_3
        ,A.RS_UDC_4 AS DEDUCTION_UDC_4
        ,A.RS_UDC_5 AS DEDUCTION_UDC_5
        ,A.RS_UDC_6 AS DEDUCTION_UDC_6
        ,TP.ACCRUAL_RATE AS RATE
        ,AAD.UDC_1 AS UDC_1
        ,AAD.UDC_2 AS UDC_2
        ,AAD.UDC_3 AS UDC_3
        ,AAD.UDC_4 AS UDC_4
        ,AAD.UDC_5 AS UDC_5
        ,AAD.UDC_6 AS UDC_6
        ,AAD.ACCOUNT_TYPE AS ACCOUNT_TYPE
        ,AAD.ACCOUNT_CATEGORY AS ACCOUNT_CATEGORY
        ,AAD.ADJUSTMENT_LEVEL AS ADJUSTMENT_LEVEL
        ,AAD.ACCOUNT_DESC AS ACCOUNT_DESC
        ,AAD.ACCOUNT_INDICATOR AS ACCOUNT_INDICATOR
        ,TP.PERIOD_DATE AS CALCULATION_PERIOD
        ,A.WORKFLOW_ID
        ,A.WORKFLOW_NAME
        ,A.WORKFLOW_STATUS
                 FROM #TEMP_GTN A
JOIN ARM_ADJUSTMENT_MASTER AM ON A.PROJECTION_MASTER_SID=AM.PROJECTION_MASTER_SID
JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE=AC.ARM_ADJUSTMENT_CONFIG_SID
LEFT JOIN @TEMP_PROJ_GTN TP ON TP.ARM_ADJUSTMENT_DETAILS_SID=A.ARM_ADJUSTMENT_DETAILS
JOIN ARM_ADJ_RES_CONFIG_MASTER AAM ON AAM.RS_CATEGORY = A.RS_CATEGORY
AND AAM.RS_TYPE = A.RS_TYPE
AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE
AND AAM.GL_COMPANY_MASTER_SID = @GL_COMP
AND AM.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID
AND AAM.CONFIGURATION_TYPE=1
JOIN ARM_ADJ_RES_CCP AAD ON AAD.ARM_ADJ_RES_CONFIG_MASTER_SID = AAM.ARM_ADJ_RES_CONFIG_MASTER_SID
                          AND AC.ARM_ADJUSTMENT_CONFIG_SID=AAD.ADJUSTMENT_TYPE
 AND AAD.ARM_ADJUSTMENT_DETAILS_SID = TP.ARM_ADJUSTMENT_DETAILS_SID
 AND AAD.ACCOUNT=TP.ACCOUNT 
JOIN COMPANY_MASTER GL ON GL.COMPANY_MASTER_SID=@GL_COMP
JOIN COMPANY_MASTER BU ON BU.COMPANY_MASTER_SID=AM.BU_COMPANY_MASTER_SID
WHERE 
?AMOUNTCONDITION
--TP.ACCRUAL_AMOUNT >0.01 AND 
AAD.ADJUSTMENT_TYPE = @ADJUSTMENT_TYPE
@CATEGORY
@TYPE
@ACCOUNT ) A
@PAGINATION  
SELECT ADJUSTMENT_TYPE,
DEDUCTION_TYPE,
GL_MONTH,
GL_YEAR,
GLSTRING,
GL_COMPANY_ID,
DIVISION,
BU_COMPANY_ID,
COST_CENTER,
ACCOUNT,
BRAND_ID,
PROJECT,
FUTURE_1,
FUTURE_2,
ITEM_NO,
ACCRUAL_AMOUNT,
GL_COMPANY_NO,
GL_COMPANY_NAME,
BU_COMPANY_NO,
BU_COMPANY_NAME,
GLDATE ,
CREATED_DATE,
REDEMPTION_PERIOD,
CONTRACT_ID,
CONTRACT_NO,
CONTRACT_NAME,
COMPANY_ID,
COMPANY_NO,
COMPANY_NAME,
ITEM_ID,
ITEM_NAME,
BRAND_NAME,
DEDUCTION_ID,
DEDUCTION_NO,
DEDUCTION_NAME,
DEDUCTION_CATEGORY,
REBATE_PROGRAM_TYPE,
DEDUCTION_INCLUSION,
DEDUCTION_UDC_1,
DEDUCTION_UDC_2,
DEDUCTION_UDC_3,
DEDUCTION_UDC_4,
DEDUCTION_UDC_5,
DEDUCTION_UDC_6,
RATE,
UDC_1,
UDC_2,
UDC_3,
UDC_4,
UDC_5,
UDC_6,
ACCOUNT_TYPE,
ACCOUNT_CATEGORY,
ADJUSTMENT_LEVEL,
ACCOUNT_DESC,
ACCOUNT_INDICATOR,
CALCULATION_PERIOD,
WORKFLOW_ID,
WORKFLOW_NAME,
WORKFLOW_STATUS
FROM #FINAL_OUTPUT A
ORDER BY ROW_NUMBER () OVER (@VALUE)
@OFFSET       
  
                                
            ]]>  
        </query>
        
    </entity>
    
    
    <entity id="Adjustment GTN Details Trx6 query For count">
     
        <query>
            <![CDATA[
DECLARE 
   @GL_COMP     INT = @GLCOMP,
   @PROJECTION_MASTER_SID INT = @PROJECTIONMASTER
   @SESSION_DECLARE   
DECLARE @TEMP_PROJ_GTN AS TABLE
(
   ARM_ADJUSTMENT_DETAILS_SID INT,
   CCP_DETAILS_SID INT,
   RS_MODEL_SID INT,
   PERIOD_DATE DATETIME,
   ACCOUNT VARCHAR(50),
   DEBIT NUMERIC(22, 6),
   CREDIT NUMERIC(22, 6),
   ACCRUAL_AMOUNT NUMERIC(22, 6),
   ACCRUAL_RATE NUMERIC(22, 6)
)
INSERT INTO @TEMP_PROJ_GTN
(
   ARM_ADJUSTMENT_DETAILS_SID,
   CCP_DETAILS_SID,
   RS_MODEL_SID,
   PERIOD_DATE,
   ACCOUNT,
   DEBIT,
   CREDIT,
   ACCRUAL_AMOUNT,
   ACCRUAL_RATE
)
SELECT
A.ARM_ADJUSTMENT_DETAILS_SID,
A.CCP_DETAILS_SID,
A.RS_MODEL_SID,
P.PERIOD_DATE,
AA.ACCOUNT,
ISNULL(SUM(AA.DEBIT),0) AS DEBIT,
ISNULL(SUM(AA.CREDIT),0) AS CREDIT,
ISNULL(SUM(AA.CREDIT),0) - ISNULL(SUM(AA.DEBIT),0) AS ACCRUAL_AMOUNT,
SUM(INFLATION_FACTOR) AS RATE
FROM ARM_ADJUSTMENT_DETAILS A
JOIN @TABLE_1 B ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
JOIN @TABLE_3 AA ON AA.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
JOIN CCP_DETAILS CD 
ON A.CCP_DETAILS_SID=CD.CCP_DETAILS_SID 
JOIN @TABLE_2 C ON A.PROJECTION_MASTER_SID=C.PROJECTION_MASTER_SID
AND CD.COMPANY_MASTER_SID=C.COMPANY_MASTER_SID AND CD.ITEM_MASTER_SID=C.ITEM_MASTER_SID
AND B.PERIOD_SID=C.PERIOD_SID 
JOIN PERIOD P ON P.PERIOD_SID=B.PERIOD_SID AND B.PERIOD_SID=AA.PERIOD_SID
WHERE A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
@SESSION_INCLUDE
GROUP BY A.ARM_ADJUSTMENT_DETAILS_SID,
A.CCP_DETAILS_SID,
A.RS_MODEL_SID ,
P.PERIOD_DATE,
AA.ACCOUNT

IF OBJECT_ID
(
   'TEMPDB..#TEMP_GTN'
)
IS NOT NULL DROP TABLE #TEMP_GTN 
CREATE TABLE #TEMP_GTN
(
   ARM_ADJUSTMENT_DETAILS INT,
   CONTRACT_MASTER_SID INT,
   CONTRACT_ID VARCHAR(50),
   CONTRACT_NO VARCHAR(50),
   [CONTRACT_NAME] VARCHAR(100),
   COMPANY_MASTER_SID INT,
   COMPANY_ID VARCHAR(50),
   COMPANY_NO VARCHAR(50),
   COMPANY_NAME VARCHAR(100),
   ITEM_MASTER_SID INT,
   ITEM_ID VARCHAR(50),
   ITEM_NO VARCHAR(50),
   ITEM_NAME VARCHAR(100),
   BRAND_MASTER_SID INT,
   BRAND_ID VARCHAR(50),
   BRAND_NAME VARCHAR(100),
   RS_MODEL_SID INT,
   RS_CATEGORY VARCHAR(50),
   RS_TYPE VARCHAR(50),
   REBATE_PROGRAM_TYPE VARCHAR(50),
   DEDUCTION_INCLUSION INT,
   RS_ID VARCHAR(50),
   RS_NAME VARCHAR(100),
   RS_NO VARCHAR(50),
   RS_UDC_1 INT,
   RS_UDC_2 INT,
   RS_UDC_3 INT,
   RS_UDC_4 INT,
   RS_UDC_5 INT,
   RS_UDC_6 INT,
   PROJECTION_MASTER_SID INT,
   WORKFLOW_MASTER_SID INT NULL ,
   CREATED_DATE DATETIME,
    WORKFLOW_ID VARCHAR(50),
    WORKFLOW_NAME VARCHAR(500),
    WORKFLOW_STATUS INT 
)
INSERT INTO #TEMP_GTN
(
   ARM_ADJUSTMENT_DETAILS,
   CONTRACT_MASTER_SID,
   CONTRACT_ID,
   CONTRACT_NO,
   [CONTRACT_NAME],
   COMPANY_MASTER_SID,
   COMPANY_ID,
   COMPANY_NO,
   COMPANY_NAME,
   ITEM_MASTER_SID,
   ITEM_ID,
   ITEM_NO,
   ITEM_NAME,
   BRAND_MASTER_SID,
   BRAND_ID,
   BRAND_NAME,
   RS_MODEL_SID,
   RS_CATEGORY,
   RS_TYPE,
   REBATE_PROGRAM_TYPE,
   DEDUCTION_INCLUSION,
   RS_ID,
   RS_NO,
   RS_NAME,
   RS_UDC_1,
   RS_UDC_2,
   RS_UDC_3,
   RS_UDC_4,
   RS_UDC_5,
   RS_UDC_6,
   PROJECTION_MASTER_SID,
   WORKFLOW_MASTER_SID,
   CREATED_DATE,
    WORKFLOW_ID ,
    WORKFLOW_NAME ,
    WORKFLOW_STATUS 
)
SELECT
A.ARM_ADJUSTMENT_DETAILS_SID,
C.CONTRACT_MASTER_SID,
CON.CONTRACT_ID,
CON.CONTRACT_NO,
CON.[CONTRACT_NAME],
C.COMPANY_MASTER_SID,
CM.COMPANY_ID,
CM.COMPANY_NO,
CM.COMPANY_NAME,
C.ITEM_MASTER_SID,
IM.ITEM_ID,
IM.ITEM_NO,
IM.ITEM_NAME,
BM.BRAND_MASTER_SID,
BM.BRAND_ID,
BM.BRAND_NAME,
A.RS_MODEL_SID,
RS_CATEGORY,
RS_TYPE,
REBATE_PROGRAM_TYPE,
DEDUCTION_INCLUSION,
R.RS_ID,
R.RS_NO,
R.RS_NAME,
U.UDC1 AS RS_UDC_1,
U.UDC2 AS RS_UDC_2,
U.UDC3 AS RS_UDC_3,
U.UDC4 AS RS_UDC_4,
U.UDC5 AS RS_UDC_5,
U.UDC6 AS RS_UDC_6,
A.PROJECTION_MASTER_SID,
WM.WORKFLOW_MASTER_SID,
WM.CREATED_DATE,
WM.WORKFLOW_ID,
PM.PROJECTION_DESCRIPTION,
WM.WORKFLOW_STATUS_ID
FROM ARM_ADJUSTMENT_DETAILS A
JOIN CCP_DETAILS C ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID
JOIN PROJECTION_MASTER PM ON PM.PROJECTION_MASTER_SID=@PROJECTION_MASTER_SID
JOIN ITEM_MASTER IM ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
JOIN COMPANY_MASTER CM ON CM.COMPANY_MASTER_SID=C.COMPANY_MASTER_SID
JOIN CONTRACT_MASTER CON ON CON.CONTRACT_MASTER_SID=C.CONTRACT_MASTER_SID
JOIN BRAND_MASTER BM ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
JOIN RS_CONTRACT R ON R.RS_MODEL_SID = A.RS_MODEL_SID
AND R.CONTRACT_MASTER_SID=C.CONTRACT_MASTER_SID
JOIN ARM_DEDUCTION_SELECTION ADS ON ADS.RS_CONTRACT_SID=R.RS_CONTRACT_SID
AND ADS.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
LEFT JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID=A.PROJECTION_MASTER_SID
LEFT JOIN UDCS U ON U.MASTER_SID=R.RS_CONTRACT_SID
AND U.MASTER_TYPE='RS_CONTRACT'
WHERE A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
select count(*)from (
                    SELECT      AC.TRANSACTION_NAME AS ADJUSTMENT_TYPE
        ,A.RS_TYPE AS DEDUCTION_TYPE
        ,MONTH(GL_IMPACT_DATE) AS GL_MONTH
        ,YEAR(GL_IMPACT_DATE) AS GL_YEAR
        ,GL.COMPANY_ID+' - '+ 	CASE WHEN 
		 (AAD.DIVISION='' OR AAd.DIVISION IS NULL) AND (AAD.COST_CENTER='' OR AAd.COST_CENTER IS NULL)
		THEN AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		WHEN (AAD.DIVISION='' OR AAd.DIVISION IS NULL) AND (AAD.COST_CENTER IS NOT NULL) THEN +AAD.COST_CENTER+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		WHEN (AAD.DIVISION IS NOT NULL) AND (AAD.COST_CENTER='' OR AAd.COST_CENTER IS NULL) THEN AAD.DIVISION+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		ELSE AAD.DIVISION+' - '+AAD.COST_CENTER+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
         END AS GLSTRING
        ,GL.COMPANY_ID AS GL_COMPANY_ID
        ,AAD.DIVISION       AS DIVISION
        ,BU.COMPANY_ID AS BU_COMPANY_ID
        ,AAD.COST_CENTER AS COST_CENTER
        ,AAD.ACCOUNT AS ACCOUNT
        ,A.BRAND_ID AS BRAND_ID
        ,AAD.PROJECT AS PROJECT
        ,AAD.FUTURE_1 AS FUTURE_1
        ,AAD.FUTURE_2 AS FUTURE_2
        ,A.ITEM_NO AS ITEM_NO
        ,TP.ACCRUAL_AMOUNT AS ACCRUAL_AMOUNT
        ,GL.COMPANY_NO AS GL_COMPANY_NO
        ,GL.COMPANY_NAME AS GL_COMPANY_NAME
        ,BU.COMPANY_NO AS BU_COMPANY_NO
        ,BU.COMPANY_NAME AS BU_COMPANY_NAME
        ,GL_IMPACT_DATE AS GLDATE 
        ,A.CREATED_DATE AS CREATED_DATE
        ,CASE WHEN AC.REDEMPTION_PERIOD=1 THEN TP.PERIOD_DATE ELSE NULL END AS REDEMPTION_PERIOD
        ,A.CONTRACT_ID AS CONTRACT_ID
        ,A.CONTRACT_NO AS CONTRACT_NO
        ,A.CONTRACT_NAME AS CONTRACT_NAME
        ,A.COMPANY_ID AS COMPANY_ID
        ,A.COMPANY_NO AS COMPANY_NO
        ,A.COMPANY_NAME AS COMPANY_NAME
        ,A.ITEM_NO AS ITEM_ID
        ,A.ITEM_NAME AS ITEM_NAME
        ,A.BRAND_NAME AS BRAND_NAME
        ,A.RS_ID AS DEDUCTION_ID
        ,A.RS_NO AS DEDUCTION_NO
        ,A.RS_NAME AS DEDUCTION_NAME
        ,A.RS_CATEGORY AS DEDUCTION_CATEGORY
        ,A.REBATE_PROGRAM_TYPE AS REBATE_PROGRAM_TYPE
        ,A.DEDUCTION_INCLUSION AS DEDUCTION_INCLUSION
        ,A.RS_UDC_1 AS DEDUCTION_UDC_1
        ,A.RS_UDC_2 AS DEDUCTION_UDC_2
        ,A.RS_UDC_3 AS DEDUCTION_UDC_3
        ,A.RS_UDC_4 AS DEDUCTION_UDC_4
        ,A.RS_UDC_5 AS DEDUCTION_UDC_5
        ,A.RS_UDC_6 AS DEDUCTION_UDC_6
        ,TP.ACCRUAL_RATE AS RATE
        ,AAD.UDC_1 AS UDC_1
        ,AAD.UDC_2 AS UDC_2
        ,AAD.UDC_3 AS UDC_3
        ,AAD.UDC_4 AS UDC_4
        ,AAD.UDC_5 AS UDC_5
        ,AAD.UDC_6 AS UDC_6
        ,AAD.ACCOUNT_TYPE AS ACCOUNT_TYPE
        ,AAD.ACCOUNT_CATEGORY AS ACCOUNT_CATEGORY
        ,AAD.ADJUSTMENT_LEVEL AS ADJUSTMENT_LEVEL
        ,AAD.ACCOUNT_DESC AS ACCOUNT_DESC
        ,AAD.ACCOUNT_INDICATOR AS ACCOUNT_INDICATOR
        ,TP.PERIOD_DATE AS CALCULATION_PERIOD
        ,A.WORKFLOW_ID
        ,A.WORKFLOW_NAME
        ,A.WORKFLOW_STATUS
                 FROM #TEMP_GTN A
JOIN ARM_ADJUSTMENT_MASTER AM ON A.PROJECTION_MASTER_SID=AM.PROJECTION_MASTER_SID
JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE=AC.ARM_ADJUSTMENT_CONFIG_SID
LEFT JOIN @TEMP_PROJ_GTN TP ON TP.ARM_ADJUSTMENT_DETAILS_SID=A.ARM_ADJUSTMENT_DETAILS
JOIN ARM_ADJ_RES_CONFIG_MASTER AAM ON AAM.RS_CATEGORY = A.RS_CATEGORY
AND AAM.RS_TYPE = A.RS_TYPE
AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE
AND AAM.GL_COMPANY_MASTER_SID = @GL_COMP
AND AM.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID
AND AAM.CONFIGURATION_TYPE=1
JOIN ARM_ADJ_RES_CCP AAD ON AAD.ARM_ADJ_RES_CONFIG_MASTER_SID = AAM.ARM_ADJ_RES_CONFIG_MASTER_SID
                          AND AC.ARM_ADJUSTMENT_CONFIG_SID=AAD.ADJUSTMENT_TYPE
 AND AAD.ARM_ADJUSTMENT_DETAILS_SID = TP.ARM_ADJUSTMENT_DETAILS_SID
 AND AAD.ACCOUNT=TP.ACCOUNT 
JOIN COMPANY_MASTER GL ON GL.COMPANY_MASTER_SID=@GL_COMP
JOIN COMPANY_MASTER BU ON BU.COMPANY_MASTER_SID=AM.BU_COMPANY_MASTER_SID
            WHERE 
            ?AMOUNTCONDITION
            --TP.ACCRUAL_AMOUNT >0.01 AND 
            AAD.ADJUSTMENT_TYPE = @ADJUSTMENT_TYPE
            @CATEGORY
            @TYPE
            @ACCOUNT
            )A      
  
                                
            ]]>  
        </query>
        
    </entity>
    
    <entity id="creditDebitEqualCheck">
     
        <query>
            <![CDATA[
DECLARE @RETVAL INT 
SELECT 	@RETVAL = COUNT( * ) FROM ST_ARM_ADJUSTMENTS 
IF(@RETVAL > 0) 
	BEGIN 
		SELECT CASE WHEN SUM( ISNULL( DEBIT, 0 ) ) = SUM( ISNULL( CREDIT, 0 ) ) THEN 0 ELSE 1 END
		FROM ST_ARM_ADJUSTMENTS
	END
ELSE 
	BEGIN 
		SELECT @RETVAL
	END
            ]]>  
        </query>
        
    </entity>
 
</sql>