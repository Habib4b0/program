
DECLARE @INTFLAG INT,@MAXCOUNT INT,@HIERARCHY_DEFINITION_SID INT
SET @INTFLAG = 1
SET @MAXCOUNT=(SELECT COUNT(1) FROM RELATIONSHIP_BUILDER WHERE HIERARCHY_DEFINITION_SID IN (
SELECT HIERARCHY_DEFINITION_SID FROM HIERARCHY_DEFINITION hd join HELPER_TABLE ht on ht.helper_table_sid=hd.HIERARCHY_CATEGORY where ht.DESCRIPTION='Product Hierarchy'))
SET @HIERARCHY_DEFINITION_SID=(SELECT HIERARCHY_DEFINITION_SID FROM HIERARCHY_DEFINITION WHERE HIERARCHY_NAME='DEDUCTIONHIERARCHY')

WHILE (@INTFLAG <=@MAXCOUNT)
BEGIN
IF OBJECT_ID('TEMPDB..#TEMP_DED') IS NOT NULL
DROP TABLE #TEMP_DED;
SELECT * INTO #TEMP_DED  FROM (

SELECT ROW_NUMBER() OVER (ORDER BY RELATIONSHIP_BUILDER_SID) AS RN,*  
FROM RELATIONSHIP_BUILDER 
WHERE HIERARCHY_DEFINITION_SID 
IN (
SELECT HIERARCHY_DEFINITION_SID FROM HIERARCHY_DEFINITION hd join HELPER_TABLE ht on ht.helper_table_sid=hd.HIERARCHY_CATEGORY where ht.DESCRIPTION='Product Hierarchy'))A  WHERE RN=@INTFLAG

IF NOT  EXISTS (SELECT 1 FROM RELATIONSHIP_BUILDER WHERE RELATIONSHIP_NAME=(SELECT  RELATIONSHIP_NAME+'Deduction' FROM #TEMP_DED))
BEGIN
INSERT INTO RELATIONSHIP_BUILDER(
RELATIONSHIP_NAME
,RELATIONSHIP_TYPE
,RELATIONSHIP_DESCRIPTION
,HIERARCHY_DEFINITION_SID
,START_DATE
,BUILD_TYPE
,VERSION_NO
,HIERARCHY_VERSION
,CREATED_BY
,CREATED_DATE
,MODIFIED_BY
,MODIFIED_DATE
,DEDUCTION_RELATION
) 
SELECT 
RELATIONSHIP_NAME+'DEDUCTION'
,RELATIONSHIP_TYPE
,RELATIONSHIP_DESCRIPTION
,@HIERARCHY_DEFINITION_SID
,START_DATE
,BUILD_TYPE
,VERSION_NO
,HIERARCHY_VERSION
,CREATED_BY
,CREATED_DATE
,MODIFIED_BY
,MODIFIED_DATE
,RELATIONSHIP_BUILDER_SID
FROM #TEMP_DED


      IF OBJECT_ID('TEMPDB..#TEMP_DEDUCTION_HIERARCHY') IS NOT NULL
        DROP TABLE #TEMP_DEDUCTION_HIERARCHY

      CREATE TABLE #TEMP_DEDUCTION_HIERARCHY
        (
           ITEM_MASTER_SID          INT,
           RS_CONTRACT_SID          INT,
           REBATE_SCHEDULE_CATEGORY INT,
           REBATE_SCHEDULE_TYPE     INT,
           REBATE_PROGRAM_TYPE      INT,
           UDC1                     INT,
           UDC2                     INT,
           UDC3                     INT,
           UDC4                     INT,
           UDC5                     INT,
           UDC6                     INT
        )

      INSERT INTO #TEMP_DEDUCTION_HIERARCHY
                  (ITEM_MASTER_SID,
                   RS_CONTRACT_SID,
                   REBATE_SCHEDULE_CATEGORY,
                   REBATE_SCHEDULE_TYPE,
                   REBATE_PROGRAM_TYPE,
                   UDC1,
                   UDC2,
                   UDC3,
                   UDC4,
                   UDC5,
                   UDC6)
       SELECT A.ITEM_MASTER_SID,
             A.RS_CONTRACT_SID,
             RS.RS_CATEGORY,
             RS.RS_TYPE,
             RS.REBATE_PROGRAM_TYPE,
             U.UDC1,
             U.UDC2,
             U.UDC3,
             U.UDC4,
             U.UDC5,
             U.UDC6
      FROM   ( SELECT * FROM RS_CONTRACT_DETAILS WHERE ITEM_MASTER_SID IN(
SELECT RELATIONSHIP_LEVEL_VALUES FROM RELATIONSHIP_LEVEL_DEFINITION WHERE RELATIONSHIP_BUILDER_SID=( SELECT RELATIONSHIP_BUILDER_SID FROM #TEMP_DED ) AND LEVEL_NAME='NDC')) A
             JOIN RS_CONTRACT RS
               ON RS.RS_CONTRACT_SID = A.RS_CONTRACT_SID
             LEFT JOIN UDCS U
                    ON U.MASTER_SID = A.RS_CONTRACT_SID AND MASTER_TYPE='RS_CONTRACT'



 
  IF Object_id('tempdb..#LEVEL') IS NOT NULL
    DROP TABLE #LEVEL
  
  CREATE TABLE #LEVEL
    (
       LEVEL_NAME               VARCHAR(50),
       LEVEL_NO                 INT,
       RELATIONSHIP_BUILDER_SID INT,
       DEDUCTION_RELATION       INT,
       HIERARCHY_DEFINATION_SID INT
    )
  
  IF Object_id('tempdb..#NEWLEVEL') IS NOT NULL
    DROP TABLE #NEWLEVEL
  
  CREATE TABLE #NEWLEVEL
    (
       LEVEL_NAME               VARCHAR(50),
       LEVEL_NO                 INT,
       RELATIONSHIP_BUILDER_SID INT,
       DEDUCTION_RELATION       INT,
       HIERARCHY_DEFINATION_SID INT
    ) 
  


 IF Object_id('tempdb..#NEWLEVEL1') IS NOT NULL
    DROP TABLE #NEWLEVEL1
  
  CREATE TABLE #NEWLEVEL1
    (
       LEVEL_NAME               VARCHAR(50),
       LEVEL_NO                 INT,
       RELATIONSHIP_BUILDER_SID INT,
       DEDUCTION_RELATION       INT,
       HIERARCHY_DEFINATION_SID INT
    ) 
  

  
  IF Object_id('tempdb..#LEVEL1') IS NOT NULL
    DROP TABLE #LEVEL1
  
  CREATE TABLE #LEVEL1
    (
   
       RELATIONSHIP_BUILDER_SID INT,
       DEDUCTION_RELATION       INT,
      
    ) 




	insert into #LEVEL1


select  distinct DEDUCTION_RELATION,RELATIONSHIP_BUILDER_SID from RELATIONSHIP_BUILDER     where DEDUCTION_RELATION in (
select distinct  RELATIONSHIP_BUILDER_SID  from RELATIONSHIP_LEVEL_DEFINITION
 where  RELATIONSHIP_LEVEL_VALUES IN (SELECT DISTINCT a.ITEM_MASTER_SID    FROM   #TEMP_DEDUCTION_HIERARCHY a) ) and deduction_relation in 
 (
 select RELATIONSHIP_BUILDER_SID from #TEMP_DED
 )




INSERT INTO #LEVEL
            (LEVEL_NAME,
             LEVEL_NO,
             RELATIONSHIP_BUILDER_SID)
 select b.LEVEL_NAME,b.LEVEL_NO ,a.RELATIONSHIP_BUILDER_SID  from #LEVEL1 a 
 left join
 RELATIONSHIP_LEVEL_DEFINITION  b 
 on a.RELATIONSHIP_BUILDER_SID=b.RELATIONSHIP_BUILDER_SID  




IF Object_id('tempdb..#LEVEL_DEDUCTION_RELATION') IS NOT NULL
  DROP TABLE #LEVEL_DEDUCTION_RELATION

CREATE TABLE #LEVEL_DEDUCTION_RELATION
  (
     RELATIONSHIP_BUILDER_SID INT,
     DEDUCTION_RELATION       INT,
  ) 





IF Object_id('tempdb..#LEVEL_HIERARCHY_DEFINATION_SID') IS NOT NULL
  DROP TABLE #LEVEL_HIERARCHY_DEFINATION_SID

CREATE TABLE #LEVEL_HIERARCHY_DEFINATION_SID
  (
     RELATIONSHIP_BUILDER_SID INT,
     DEDUCTION_RELATION       INT,
  )


INSERT INTO #NEWLEVEL

SELECT a.LEVEL_NAME,
       a.LEVEL_NO,
       a.RELATIONSHIP_BUILDER_SID,
       b.DEDUCTION_RELATION AS DEDUCTION_RELATION,
       b.HIERARCHY_DEFINITION_SID
FROM   #LEVEL a
       LEFT JOIN RELATIONSHIP_BUILDER b
              ON a.RELATIONSHIP_BUILDER_SID = b.RELATIONSHIP_BUILDER_SID
--WHERE  b.DEDUCTION_RELATION IS NOT NULL 





INSERT INTO #NEWLEVEL1
SELECT a.LEVEL_NAME,
       a.LEVEL_NO,
       a.RELATIONSHIP_BUILDER_SID,
	   b.deduction_relation,
	   a.HIERARCHY_DEFINATION_SID
	   from

#NEWLEVEL a  left join
#LEVEL1 b on a.RELATIONSHIP_BUILDER_SID=b.RELATIONSHIP_BUILDER_SID


IF Object_id('tempdb..#RELATION_SHIP_BUILDER_SID') IS NOT NULL
  DROP TABLE #RELATION_SHIP_BUILDER_SID

CREATE TABLE #RELATION_SHIP_BUILDER_SID
  (
     ROWNUMBER                INT IDENTITY(1, 1) NOT NULL,
     RELATIONSHIP_BUILDER_SID INT,
	 DEDUCTION_RELATION_SID INT
  )


INSERT INTO #RELATION_SHIP_BUILDER_SID
            (RELATIONSHIP_BUILDER_SID,DEDUCTION_RELATION_SID)
SELECT DISTINCT RELATIONSHIP_BUILDER_SID,DEDUCTION_RELATION
FROM   #NEWLEVEL1



--IF Object_id('tempdb..#FINAL_RELATIONSHIP_LEVEL_DEFINITION') IS NOT NULL
--  DROP TABLE #FINAL_RELATIONSHIP_LEVEL_DEFINITION

--CREATE TABLE #FINAL_RELATIONSHIP_LEVEL_DEFINITION
--  (
--     RELATIONSHIP_BUILDER_SID       INT,
--     HIERARCHY_LEVEL_DEFINITION_SID INT,
--     RELATIONSHIP_LEVEL_VALUES      VARCHAR(100),
--     LEVEL_NO                       VARCHAR(100),
--     LEVEL_NAME                     VARCHAR(100),
--     PARENT_NODE                    VARCHAR(100),
--     HIERARCHY_NO                   VARCHAR(100),
--     CREATED_BY                     INT,
--     CREATED_DATE                   DATETIME,
--     MODIFIED_BY                    INT,
--     MODIFIED_DATE                  DATETIME,
--     VERSION_NO                     INT
--  )

--IF Object_id('tempdb..#INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION') IS NOT NULL
--  DROP TABLE #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION

--CREATE TABLE #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION
--  (
--     RELATIONSHIP_BUILDER_SID       INT,
--     HIERARCHY_LEVEL_DEFINITION_SID INT,
--     RELATIONSHIP_LEVEL_VALUES      VARCHAR(100),
--     LEVEL_NO                       VARCHAR(100),
--     LEVEL_NAME                     VARCHAR(100),
--     PARENT_NODE                    VARCHAR(100),
--     HIERARCHY_NO                   VARCHAR(100),
--     CREATED_BY                     INT,
--     CREATED_DATE                   DATETIME,
--     MODIFIED_BY                    INT,
--     MODIFIED_DATE                  DATETIME,
--     VERSION_NO                     INT
--  ) 


  DECLARE @LEVEL_NAME  VARCHAR(50),
        @COLUMN_NAME VARCHAR(50),
        @ITERATION   VARCHAR(10),
        @SQL         NVARCHAR(2000),
        @rowcnt      INT
DECLARE @intFlagp                  int,
        @sql1                     VARCHAR(max),
        @RELATIONSHIP_BUILDER_SID NVARCHAR(max),@DEDUCTION_RELATION_SID NVARCHAR(max),@VERSION NVARCHAR(max),
        @maxcountp                 INT,
        @query                    VARCHAR(max),
        @sid                      INT

SET @intFlagp = 1
SET @maxcountp =(SELECT Count(*)
                FROM   #RELATION_SHIP_BUILDER_SID)

DECLARE @xx INT

SET @xx = 0

IF Object_id('tempdb..#FINAL_RELATIONSHIP_LEVEL_DEFINITION') IS NOT NULL
  DROP TABLE #FINAL_RELATIONSHIP_LEVEL_DEFINITION

CREATE TABLE #FINAL_RELATIONSHIP_LEVEL_DEFINITION
  (
     RELATIONSHIP_BUILDER_SID       INT,
     HIERARCHY_LEVEL_DEFINITION_SID INT,
     RELATIONSHIP_LEVEL_VALUES      VARCHAR(100),
     LEVEL_NO                       VARCHAR(100),
     LEVEL_NAME                     VARCHAR(100),
     PARENT_NODE                    VARCHAR(100),
     HIERARCHY_NO                   VARCHAR(100),
     CREATED_BY                     INT,
     CREATED_DATE                   DATETIME,
     MODIFIED_BY                    INT,
     MODIFIED_DATE                  DATETIME,
     VERSION_NO                     INT
  )

IF Object_id('tempdb..#INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION') IS NOT NULL
  DROP TABLE #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION

CREATE TABLE #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION
  (
     RELATIONSHIP_BUILDER_SID       INT,
     HIERARCHY_LEVEL_DEFINITION_SID INT,
     RELATIONSHIP_LEVEL_VALUES      VARCHAR(100),
     LEVEL_NO                       VARCHAR(100),
     LEVEL_NAME                     VARCHAR(100),
     PARENT_NODE                    VARCHAR(100),
     HIERARCHY_NO                   VARCHAR(100),
     CREATED_BY                     INT,
     CREATED_DATE                   DATETIME,
     MODIFIED_BY                    INT,
     MODIFIED_DATE                  DATETIME,
     VERSION_NO                     INT
  ) 



--DECLARE @RELATIONSHIP_BUILDER_SID VARCHAR(max),@intFlag VARCHAR =9
SET @RELATIONSHIP_BUILDER_SID= 'select RELATIONSHIP_BUILDER_SID  from #RELATION_SHIP_BUILDER_SID   where ROWNUMBER ='+cast(@intFlagp as varchar)

--select @RELATIONSHIP_BUILDER_SID
IF Object_id('tempdb..#tem') IS NOT NULL
  DROP TABLE #tem

CREATE TABLE #tem
  (
     RELATIONSHIP_BUILDER_SID INT
  )

INSERT INTO #tem
EXEC (@RELATIONSHIP_BUILDER_SID) 

--DECLARE @DEDUCTION_RELATION_SID VARCHAR(max),@intFlag VARCHAR =9,@VERSION VARCHAR(MAX)
SET @DEDUCTION_RELATION_SID= 'select DEDUCTION_RELATION_SID  from #RELATION_SHIP_BUILDER_SID   where ROWNUMBER ='+cast(@intFlagp as varchar)

--select @RELATIONSHIP_BUILDER_SID
IF Object_id('tempdb..#tem1') IS NOT NULL
  DROP TABLE #tem1

CREATE TABLE #tem1
  (
     DEDUCTION_RELATION_SID INT
  )

INSERT INTO #tem1
EXEC (@DEDUCTION_RELATION_SID) 

SET @VERSION= (SELECT VERSION_NO FROM RELATIONSHIP_BUILDER WHERE  RELATIONSHIP_BUILDER_SID = (SELECT DEDUCTION_RELATION_SID FROM #TEM1))


SELECT @VERSION

 IF Object_id('tempdb..#RELATIONSHIP_LEVEL_VALUES') IS NOT NULL
   DROP TABLE #RELATIONSHIP_LEVEL_VALUES
 
 CREATE TABLE #RELATIONSHIP_LEVEL_VALUES
   (
      ITEM_MASTER_SID INT
   )


IF 3 = (select  count (distinct LEVEL_NO) from #NEWLEVEL1 WHERE RELATIONSHIP_BUILDER_SID =(SELECT RELATIONSHIP_BUILDER_SID FROM #tem  ))

BEGIn


 
 INSERT INTO #RELATIONSHIP_LEVEL_VALUES


 SELECT DISTINCT RELATIONSHIP_LEVEL_VALUES
 FROM   RELATIONSHIP_LEVEL_DEFINITION
 WHERE  RELATIONSHIP_BUILDER_SID = (SELECT RELATIONSHIP_BUILDER_SID
                                    FROM   #tem) and LEVEL_NAME='ndc'


end

else
IF 2= (select  count (distinct LEVEL_NO) from #NEWLEVEL1 WHERE RELATIONSHIP_BUILDER_SID =(SELECT RELATIONSHIP_BUILDER_SID FROM #tem  ))
begiN


IF EXISTS ( SELECT 1 FROM #NEWLEVEL1 WHERE RELATIONSHIP_BUILDER_SID 
=(SELECT RELATIONSHIP_BUILDER_SID FROM #tem  )  AND level_name='ndc')

begin

 --IF Object_id('tempdb..#RELATIONSHIP_LEVEL_VALUES') IS NOT NULL
 --  DROP TABLE #RELATIONSHIP_LEVEL_VALUES
 
 --CREATE TABLE #RELATIONSHIP_LEVEL_VALUES
 --  (
 --     ITEM_MASTER_SID INT
 --  )
 
 INSERT INTO #RELATIONSHIP_LEVEL_VALUES


 SELECT DISTINCT RELATIONSHIP_LEVEL_VALUES
 FROM   RELATIONSHIP_LEVEL_DEFINITION
 WHERE  RELATIONSHIP_BUILDER_SID = (SELECT RELATIONSHIP_BUILDER_SID
                                    FROM   #tem) and LEVEL_NAME='ndc'
	enD

IF EXISTS ( SELECT 1 FROM #NEWLEVEL1 WHERE RELATIONSHIP_BUILDER_SID 
=(SELECT RELATIONSHIP_BUILDER_SID FROM #tem  )  AND level_name='BRAND')

begin

 --IF Object_id('tempdb..#RELATIONSHIP_LEVEL_VALUES') IS NOT NULL
 --  DROP TABLE #RELATIONSHIP_LEVEL_VALUES
 
 --CREATE TABLE #RELATIONSHIP_LEVEL_VALUES
 --  (
 --     ITEM_MASTER_SID INT
 --  )
 
 INSERT INTO #RELATIONSHIP_LEVEL_VALUES

select distinct ITEM_MASTER_SID from ITEM_MASTER where BRAND_MASTER_SID in (
select BRAND_MASTER_SID from BRAND_MASTER where BRAND_MASTER_SID in (
 SELECT DISTINCT RELATIONSHIP_LEVEL_VALUES
 FROM   RELATIONSHIP_LEVEL_DEFINITION
 WHERE  RELATIONSHIP_BUILDER_SID = 
 (SELECT RELATIONSHIP_BUILDER_SID FROM   #tem) and LEVEL_NAME='Brand'))


END

END

else
IF 1= (select  count (distinct LEVEL_NO) from #NEWLEVEL1 WHERE RELATIONSHIP_BUILDER_SID =(SELECT RELATIONSHIP_BUILDER_SID FROM #tem  ))
begin

 --IF Object_id('tempdb..#RELATIONSHIP_LEVEL_VALUES') IS NOT NULL
 --  DROP TABLE #RELATIONSHIP_LEVEL_VALUES
 
 --CREATE TABLE #RELATIONSHIP_LEVEL_VALUES
 --  (
 --     ITEM_MASTER_SID INT
 --  )
 
 INSERT INTO #RELATIONSHIP_LEVEL_VALUES




 SELECT
                              DISTINCT IM.ITEM_NAME
                           
                      FROM
                              ITEM_MASTER IM
                              JOIN BRAND_MASTER B1 ON
                              B1.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
                              JOIN GL_COST_CENTER_MASTER GLC ON
                              GLC.NDC8 = IM.NDC8
                              JOIN COMPANY_MASTER CM ON
                              CM.COMPANY_ID = GLC.COMPANY_CODE
                              WHERE
                              IM.ITEM_NAME IS NOT NULL
--                              AND IM.ITEM_MASTER_SID in (128)
                              AND CM.COMPANY_MASTER_SID  IN
							  (
 SELECT DISTINCT RELATIONSHIP_LEVEL_VALUES
 FROM   RELATIONSHIP_LEVEL_DEFINITION
 WHERE  RELATIONSHIP_BUILDER_SID = (SELECT RELATIONSHIP_BUILDER_SID
                                    FROM   #tem) and LEVEL_NAME='Company')


end





 IF Object_id('tempdb..#udc') IS NOT NULL
   DROP TABLE #udc
 
 CREATE TABLE #udc
   (
      HELPER_TABLE_SID INT,
      DESCRIPTION      VARCHAR(50),
      LIST_NAME        VARCHAR(50)
   )
 
 INSERT INTO #udc
 SELECT HELPER_TABLE_SID,
        DESCRIPTION,
        LIST_NAME
 FROM   HELPER_TABLE
 WHERE  DESCRIPTION IN ( 'UDC1', 'UDC2', 'UDC3', 'UDC4',
                         'UDC5', 'UDC6' )
        AND LIST_NAME IN ( 'RS_UDC1', 'RS_UDC2', 'RS_UDC3', 'RS_UDC4',
                           'RS_UDC5', 'RS_UDC6' ) 
 	
	IF Object_id('tempdb..#TEMP_DEDUCTION') IS NOT NULL
      DROP TABLE #TEMP_DEDUCTION
    
    CREATE TABLE #TEMP_DEDUCTION
      (
         RS_CONTRACT_SID          INT,
         RS_ID                    VARCHAR(50),
         REBATE_SCHEDULE_CATEGORY INT,
         REBATE_SCHEDULE_TYPE     INT,
         REBATE_PROGRAM_TYPE      INT,
         UDC1                     INT,
         UDC2                     INT,
         UDC3                     INT,
         UDC4                     INT,
         UDC5                     INT,
         UDC6                     INT
      )
   
   
   
 
INSERT INTO #TEMP_DEDUCTIOn

SELECT DISTINCT c.RS_CONTRACT_SID,
                C.RS_ID,
                C.RS_CATEGORY,
                C.RS_TYPE,
                C.REBATE_PROGRAM_TYPE,

                isnull(CASE WHEN (U.UDC1)=0 THEN ( SELECT HELPER_TABLE_SID
                                FROM   #udc
                                WHERE  DESCRIPTION = 'UDC1'
                                       AND LIST_NAME = 'RS_UDC1')  END ,( SELECT HELPER_TABLE_SID
                                FROM   #udc
                                WHERE  DESCRIPTION = 'UDC1'
                                       AND LIST_NAME = 'RS_UDC1') )
									    AS UDC1,



				      isnull(CASE WHEN (U.udc2)=0 THEN ( SELECT HELPER_TABLE_SID
                                FROM   #udc
                                WHERE  DESCRIPTION = 'udc2'
                                       AND LIST_NAME = 'RS_UDC2')  END ,( SELECT HELPER_TABLE_SID
                                FROM   #udc
                                WHERE  DESCRIPTION = 'udc2'
                                       AND LIST_NAME = 'RS_UDC2') )
									    AS udc2,


										      isnull(CASE WHEN (U.UDC3)=0 THEN ( SELECT HELPER_TABLE_SID
                                FROM   #udc
                                WHERE  DESCRIPTION = 'UDC3'
                                       AND LIST_NAME = 'RS_UDC3')  END ,( SELECT HELPER_TABLE_SID
                                FROM   #udc
                                WHERE  DESCRIPTION = 'UDC3'
                                       AND LIST_NAME = 'RS_UDC3') )
									    AS UDC3,


										      isnull(CASE WHEN (U.UDC4)=0 THEN ( SELECT HELPER_TABLE_SID
                                FROM   #udc
                                WHERE  DESCRIPTION = 'UDC4'
                                       AND LIST_NAME = 'RS_UDC4')  END ,( SELECT HELPER_TABLE_SID
                                FROM   #udc
                                WHERE  DESCRIPTION = 'UDC4'
                                       AND LIST_NAME = 'RS_UDC4') )
									    AS UDC4,


										      isnull(CASE WHEN (U.UDC5)=0 THEN ( SELECT HELPER_TABLE_SID
                                FROM   #udc
                                WHERE  DESCRIPTION = 'UDC5'
                                       AND LIST_NAME = 'RS_UDC5')  END ,( SELECT HELPER_TABLE_SID
                                FROM   #udc
                                WHERE  DESCRIPTION = 'UDC5'
                                       AND LIST_NAME = 'RS_UDC5') )
									    AS UDC5,


										      isnull(CASE WHEN (U.UDC6)=0 THEN ( SELECT HELPER_TABLE_SID
                                FROM   #udc
                                WHERE  DESCRIPTION = 'UDC6'
                                       AND LIST_NAME = 'RS_UDC6')  END ,( SELECT HELPER_TABLE_SID
                                FROM   #udc
                                WHERE  DESCRIPTION = 'UDC6'
                                       AND LIST_NAME = 'RS_UDC6') )
									    AS UDC6

FROM   #RELATIONSHIP_LEVEL_VALUES A
       LEFT JOIN RS_CONTRACT_DETAILS B
              ON A.ITEM_MASTER_SID = B.ITEM_MASTER_SID
         AND b.inbound_status <> 'd'
       LEFT JOIN RS_CONTRACT C
              ON C.RS_CONTRACT_SID = B.RS_CONTRACT_SID
         AND c.inbound_status <> 'd'
       LEFT JOIN UDCS U
              ON U.MASTER_SID = B.RS_CONTRACT_SID
WHERE  c.RS_ID IS NOT NULL
   

--DECLARE @LEVEL_NAME VARCHAR(50),@COLUMN_NAME VARCHAR(50),@ITERATION VARCHAR(10) , @SQL NVARCHAR(2000), @rowcnt INT
DECLARE @COLUMN_NAME1 VARCHAR(50),@COLUMN_NAME2 VARCHAR(50),@HIERARCHY VARCHAR(50)='DeductionHierarchy'

 
SET @iteration = 1
WHILE(@iteration<=10)
BEGIN



IF(  @ITERATION=1)
BEGIN
SET @LEVEL_NAME='Schedule Category'
SET @COLUMN_NAME='REBATE_SCHEDULE_CATEGORY'


END
ELSE IF (  @ITERATION=2)
BEGIN
SET @LEVEL_NAME='Schedule Type'
--SET @COLUMN_NAME='REBATE_SCHEDULE_TYPE'
SET @COLUMN_NAME1='REBATE_SCHEDULE_CATEGORY'
SET @COLUMN_NAME2='REBATE_SCHEDULE_TYPE'

END
ELSE IF (  @ITERATION=3)
BEGIN
SET @LEVEL_NAME='Program Type'
--SET @COLUMN_NAME='REBATE_PROGRAM_TYPE'
SET @COLUMN_NAME1='REBATE_SCHEDULE_TYPE'
SET @COLUMN_NAME2='REBATE_PROGRAM_TYPE'
END
ELSE IF (  @ITERATION=4)
BEGIN
SET @LEVEL_NAME='UDC 1'
--SET @COLUMN_NAME='UDC1'
SET @COLUMN_NAME1='REBATE_PROGRAM_TYPE'
SET @COLUMN_NAME2='UDC1'
END
ELSE IF (  @ITERATION=5)
BEGIN
SET @LEVEL_NAME='UDC 2'
--SET @COLUMN_NAME='UDC2'
SET @COLUMN_NAME1='UDC1'
SET @COLUMN_NAME2='UDC2'
END
ELSE IF (  @ITERATION=6)
BEGIN
SET @LEVEL_NAME='UDC 3'
--SET @COLUMN_NAME='UDC3'
SET @COLUMN_NAME1='UDC2'
SET @COLUMN_NAME2='UDC3'
END
ELSE IF (  @ITERATION=7)
BEGIN
SET @LEVEL_NAME='UDC 4'
--SET @COLUMN_NAME='UDC4'
SET @COLUMN_NAME1='UDC3'
SET @COLUMN_NAME2='UDC4'
END
ELSE IF (  @ITERATION=8)
BEGIN
SET @LEVEL_NAME='UDC 5'
--SET @COLUMN_NAME='UDC5'
SET @COLUMN_NAME1='UDC4'
SET @COLUMN_NAME2='UDC5'
END
ELSE IF (  @ITERATION=9)
BEGIN
SET @LEVEL_NAME='UDC 6'
--SET @COLUMN_NAME='UDC6'
SET @COLUMN_NAME1='UDC5'
SET @COLUMN_NAME2='UDC6'
END
ELSE IF (  @ITERATION=10)
BEGIN
SET @LEVEL_NAME='Schedule ID'
--SET @COLUMN_NAME='RS_CONTRACT_SID'
SET @COLUMN_NAME1='UDC6'
SET @COLUMN_NAME2='RS_CONTRACT_SID'
END



IF(  @ITERATION=1)

BEGIN

SET @SQL ='INSERT INTO #FINAL_RELATIONSHIP_LEVEL_DEFINITION select 
 a.RELATIONSHIP_BUILDER_SID
,a.HIERARCHY_LEVEL_DEFINITION_SID
,a.RELATIONSHIP_LEVEL_VALUES
,a.LEVEL_NO
,a.LEVEL_NAME
,case when a.LEVEL_NO=1 then ''0'' else CONCAT(FINAL.LEVEL_NO,''~'',FINAL.RELATIONSHIP_LEVEL_VALUES ) end AS PARENT_NODE
,case when a.LEVEL_NO=1 then a.HIERARCHY_NO 
else  CONCAT(FINAL.HIERARCHY_NO,'''', DENSE_RANK () OVER( ORDER BY A.RELATIONSHIP_LEVEL_VALUES  ))+''.'' end AS HIERARCHY_NO
,a.CREATED_BY
,a.CREATED_DATE
,a.MODIFIED_BY
,a.MODIFIED_DATE
,b.VERSION_NO+1 as VERSION_NO
	
	
	 from (
	
	SELECT 	 
	DEDUCTION_RELATION as RELATIONSHIP_BUILDER_SID,

	HIERARCHY_LEVEL_DEFINITION_SID,

	'+@COLUMN_NAME +'  as RELATIONSHIP_LEVEL_VALUES,
	'+@ITERATION +' AS LEVEL_NO,'''+@LEVEL_NAME +''' AS LEVEL_NAME,0 as PARENT_NODE,
		concat(DEDUCTION_RELATION ,''-'', ROW_NUMBER () OVER(ORDER BY '+@COLUMN_NAME +'))+''.'' as HIERARCHY_NO,
		1 as CREATED_BY
,getdate() as CREATED_DATE
,1 as MODIFIED_BY
,getdate() as MODIFIED_DATE

	FROM #TEMP_DEDUCTION T1 ,#NEWLEVEL1  T2
	 JOIN 
		  HIERARCHY_LEVEL_DEFINITION  B 
		  ON  T2.HIERARCHY_DEFINATION_SID=B.HIERARCHY_DEFINITION_SID WHERE B.LEVEL_NO='+@ITERATION +'
		   AND T2.RELATIONSHIP_BUILDER_SID=(SELECT RELATIONSHIP_BUILDER_SID FROM #tem)
	GROUP BY '+@COLUMN_NAME +',DEDUCTION_RELATION,HIERARCHY_DEFINATION_SID,HIERARCHY_LEVEL_DEFINITION_SID


	)a left join RELATIONSHIP_BUILDER b on  a.RELATIONSHIP_BUILDER_SID=b.RELATIONSHIP_BUILDER_SID
	left join #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION FINAL ON FINAL.RELATIONSHIP_BUILDER_SID=A.RELATIONSHIP_BUILDER_SID
	WHERE A. RELATIONSHIP_LEVEL_VALUES IS NOT NULL AND A. RELATIONSHIP_LEVEL_VALUES<>0'


EXEC (@SQL)


SET @SQL ='INSERT INTO #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION select 
 a.RELATIONSHIP_BUILDER_SID
,a.HIERARCHY_LEVEL_DEFINITION_SID
,a.RELATIONSHIP_LEVEL_VALUES
,a.LEVEL_NO
,a.LEVEL_NAME
,case when a.LEVEL_NO=1 then ''0'' else CONCAT(FINAL.LEVEL_NO,''~'',FINAL.RELATIONSHIP_LEVEL_VALUES ) end AS PARENT_NODE
,case when a.LEVEL_NO=1 then a.HIERARCHY_NO 
else  CONCAT(FINAL.HIERARCHY_NO,'''', DENSE_RANK () OVER( ORDER BY A.RELATIONSHIP_LEVEL_VALUES  ))+''.'' end AS HIERARCHY_NO
,a.CREATED_BY
,a.CREATED_DATE
,a.MODIFIED_BY
,a.MODIFIED_DATE
,b.VERSION_NO+1 as VERSION_NO
	
	
	 from (
	
	SELECT 	 
	DEDUCTION_RELATION as RELATIONSHIP_BUILDER_SID,

	HIERARCHY_LEVEL_DEFINITION_SID,

	'+@COLUMN_NAME +'  as RELATIONSHIP_LEVEL_VALUES,
	'+@ITERATION +' AS LEVEL_NO,'''+@LEVEL_NAME +''' AS LEVEL_NAME,0 as PARENT_NODE,
		concat(DEDUCTION_RELATION ,''-'', ROW_NUMBER () OVER(ORDER BY '+@COLUMN_NAME +'))+''.'' as HIERARCHY_NO,
		1 as CREATED_BY
,getdate() as CREATED_DATE
,1 as MODIFIED_BY
,getdate() as MODIFIED_DATE

	FROM #TEMP_DEDUCTION T1 ,#NEWLEVEL1  T2
	 JOIN 
		  HIERARCHY_LEVEL_DEFINITION  B 
		  ON  T2.HIERARCHY_DEFINATION_SID=B.HIERARCHY_DEFINITION_SID WHERE B.LEVEL_NO='+@ITERATION +'
		   AND T2.RELATIONSHIP_BUILDER_SID=(SELECT RELATIONSHIP_BUILDER_SID FROM #tem)
	GROUP BY '+@COLUMN_NAME +',DEDUCTION_RELATION,HIERARCHY_DEFINATION_SID,HIERARCHY_LEVEL_DEFINITION_SID


	)a left join RELATIONSHIP_BUILDER b on  a.RELATIONSHIP_BUILDER_SID=b.RELATIONSHIP_BUILDER_SID
	left join #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION FINAL ON FINAL.RELATIONSHIP_BUILDER_SID=A.RELATIONSHIP_BUILDER_SID
	WHERE A. RELATIONSHIP_LEVEL_VALUES IS NOT NULL AND A. RELATIONSHIP_LEVEL_VALUES<>0'


EXEC(@SQL)

	--print @ITERATION 

	--print 		'delete from #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION where  LEVEL_NO<>'+@ITERATION
	
	DELETE FROM #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION WHERE  LEVEL_NO<>@ITERATION


update #FINAL_RELATIONSHIP_LEVEL_DEFINITION set HIERARCHY_LEVEL_DEFINITION_SID =(select top 1 HIERARCHY_LEVEL_DEFINITION_SID from HIERARCHY_LEVEL_DEFINITION where LEVEL_NAME=@LEVEL_NAME )

	END

	else if (@ITERATION=10)
	begin

	
IF Object_id('tempdb..#TEMP2') IS NOT NULL
DROP TABLE #TEMP2

 CREATE TABLE #TEMP2
(

	REBATE_SCHEDULE_CATEGORY INT,
   REBATE_SCHEDULE_TYPE  INT,
   REBATE_PROGRAM_TYPE   INT,
   UDC6 INT,
   HIERARCHY_NO varchar(100),
   RS_CONTRACT_SID int,
   ROWNUMBER INT
 
)

insert into #TEMP2
SELECT 

a.REBATE_SCHEDULE_CATEGORY,
a.REBATE_SCHEDULE_TYPE,
a.REBATE_PROGRAM_TYPE,
a.UDC6,
a.HIERARCHY_NO,
a.rs_contract_sid,
     
       Row_number ()
         OVER(
           partition BY a.UDC6,a.REBATE_SCHEDULE_CATEGORY,a.REBATE_SCHEDULE_TYPE,a.REBATE_PROGRAM_TYPE
   ,a.HIERARCHY_NO
           ORDER BY a.UDC6)
FROM   (SELECT  
 B.REBATE_SCHEDULE_CATEGORY,
                        B.REBATE_SCHEDULE_TYPE,
                        B.REBATE_PROGRAM_TYPE
						,B.RS_CONTRACT_SID,
						b.udc6
						,						a.HIERARCHY_NO
						
        FROM   #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION A 
              JOIN 
				#TEMP_DEDUCTION B
                     ON A.RELATIONSHIP_LEVEL_VALUES = B.UDC6  
			   JOIN (SELECT IRLD.HIERARCHY_NO,MAX(CASE WHEN FRLD.LEVEL_NAME='SCHEDULE CATEGORY' THEN FRLD.RELATIONSHIP_LEVEL_VALUES END) SCHEDULE_CATEGORY
,MAX(CASE WHEN FRLD.LEVEL_NAME='SCHEDULE TYPE' THEN FRLD.RELATIONSHIP_LEVEL_VALUES END) SCHEDULE_TYPE
,MAX(CASE WHEN FRLD.LEVEL_NAME='PROGRAM TYPE' THEN FRLD.RELATIONSHIP_LEVEL_VALUES END) PROGRAM_TYPE

 FROM #FINAL_RELATIONSHIP_LEVEL_DEFINITION FRLD		
JOIN  #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION  IRLD  ON FRLD. LEVEL_NO<=3 AND   IRLD.HIERARCHY_NO LIKE FRLD.HIERARCHY_NO+'%'
GROUP BY IRLD.HIERARCHY_NO)c
on c.PROGRAM_TYPE=b.REBATE_PROGRAM_TYPE and c.SCHEDULE_CATEGORY=b.REBATE_SCHEDULE_CATEGORY and c.SCHEDULE_TYPE=b.REBATE_SCHEDULE_TYPE and A.HIERARCHY_NO=c.HIERARCHY_NO
																	 
									

					  )a 


----SELECT IRLD.HIERARCHY_NO,MAX(CASE WHEN FRLD.LEVEL_NAME='SCHEDULE CATEGORY' THEN FRLD.RELATIONSHIP_LEVEL_VALUES END) SCHEDULE_CATEGORY
----,MAX(CASE WHEN FRLD.LEVEL_NAME='SCHEDULE TYPE' THEN FRLD.RELATIONSHIP_LEVEL_VALUES END) SCHEDULE_TYPE
----,MAX(CASE WHEN FRLD.LEVEL_NAME='PROGRAM TYPE' THEN FRLD.RELATIONSHIP_LEVEL_VALUES END) PROGRAM_TYPE

---- FROM #FINAL_RELATIONSHIP_LEVEL_DEFINITION FRLD		
----JOIN  #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION  IRLD  ON FRLD. LEVEL_NO<=3 AND   IRLD.HIERARCHY_NO LIKE FRLD.HIERARCHY_NO+'%'
----GROUP BY IRLD.HIERARCHY_NO

			                                   	                   
				
--select * from #TEMP2
--select * from #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION


INSERT INTO #FINAL_RELATIONSHIP_LEVEL_DEFINITION
            (RELATIONSHIP_BUILDER_SID,
             HIERARCHY_LEVEL_DEFINITION_SID,
             RELATIONSHIP_LEVEL_VALUES,
             LEVEL_NO,
             LEVEL_NAME,
             PARENT_NODE,
             HIERARCHY_NO,
             CREATED_BY,
             CREATED_DATE,
             MODIFIED_BY,
             MODIFIED_DATE)
select distinct b.RELATIONSHIP_BUILDER_SID,d.HIERARCHY_LEVEL_DEFINITION_SID,a.RS_CONTRACT_SID ,
'10 ' as level_no ,'Schedule ID' AS LEVEL_NAME, B.LEVEL_NO + '~' + B.RELATIONSHIP_LEVEL_VALUES AS PARENT_NODE,
cast(A.HIERARCHY_NO as varchar)+'.'+cast(A.ROWNUMBER as varchar)+'.'  as HIERARCHY_NO,
     1                                              AS CREATED_BY,
     Getdate()                                      AS CREATED_DATE,
    1                                              AS MODIFIED_BY,
    Getdate()                                      AS MODIFIED_DATE


from  #TEMP2 a left join 
  #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION b
 on A.HIERARCHY_NO = B.HIERARCHY_NO 

 left join
 (SELECT HIERARCHY_LEVEL_DEFINITION_SID FROM HIERARCHY_LEVEL_DEFINITION WHERE  HIERARCHY_DEFINITION_SID
				 =(  SELECT HIERARCHY_DEFINITION_SID FROM HIERARCHY_DEFINITION WHERE HIERARCHY_NAME='DeductionHierarchy') AND
				  LEVEL_NO=10    )d   ON 1=1


	end


ELSE

BEGIN


IF Object_id('tempdb..#TEMP1') IS NOT NULL
DROP TABLE #TEMP1

 CREATE TABLE #TEMP1
(

	column1 INT,
   column2  INT,
   column3   INT

 
)


SET @SQL =' insert into  #TEMP1
select 
a.'+@COLUMN_NAME1+',
a.'+@COLUMN_NAME2+',
 ROW_NUMBER () OVER(partition by a.'+@COLUMN_NAME1+' ORDER BY a.'+@COLUMN_NAME1+')
 from
(
select 
distinct b.'+@COLUMN_NAME1+',
b.'+@COLUMN_NAME2+'
from #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION a left join
 #TEMP_DEDUCTION b on a.RELATIONSHIP_LEVEL_VALUES=b.'+@COLUMN_NAME1+'
 )a'


EXEC (@SQL)


 

SET @SQL='INSERT INTO #FINAL_RELATIONSHIP_LEVEL_DEFINITION(RELATIONSHIP_BUILDER_SID,HIERARCHY_LEVEL_DEFINITION_SID, RELATIONSHIP_LEVEL_VALUES,
LEVEL_NO,LEVEL_NAME,PARENT_NODE,HIERARCHY_NO,CREATED_BY,CREATED_DATE,MODIFIED_BY,MODIFIED_DATE

)

 SELECT  
 A.RELATIONSHIP_BUILDER_SID
 ,A.HIERARCHY_LEVEL_DEFINITION_SID
 ,A.RELATIONSHIP_LEVEL_VALUES
 ,A.LEVEL_NO
 ,A.LEVEL_NAME
 ,B.LEVEL_NO+''~''+B.RELATIONSHIP_LEVEL_VALUES AS PARENT_NODE
  ,A.HIERARCHY_NO+''.''
 ,		1 as CREATED_BY
,getdate() as CREATED_DATE
,1 as MODIFIED_BY
,getdate() as MODIFIED_DATE

 FROM 
 (
 select DISTINCT a.RELATIONSHIP_BUILDER_SID
, d.HIERARCHY_LEVEL_DEFINITION_SID
,b.column2 AS RELATIONSHIP_LEVEL_VALUES,
'+@iteration+' AS LEVEL_NO,
'''+@LEVEL_NAME+''' AS LEVEL_NAME ,
A.HIERARCHY_NO+CAST(B.COLUMN3 AS VARCHAR) AS HIERARCHY_NO,
A.HIERARCHY_NO AS ORIGINAL_HIERARCHY_NO

  from #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION a
 left join #TEMP1 b on a.RELATIONSHIP_LEVEL_VALUES=b.column1
  INNER join #NEWLEVEL1 c on c.DEDUCTION_RELATION=a.RELATIONSHIP_BUILDER_SID
  AND C.RELATIONSHIP_BUILDER_SID= (SELECT RELATIONSHIP_BUILDER_SID FROM #TEM)
    left join (select HIERARCHY_LEVEL_DEFINITION_SID from HIERARCHY_LEVEL_DEFINITION where  HIERARCHY_DEFINITION_SID =(
select HIERARCHY_DEFINITION_SID from HIERARCHY_DEFINITION where HIERARCHY_NAME='''+@HIERARCHY+''') and LEVEL_NO='+@iteration+'

)d 
on 1=1)A LEFT JOIN  #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION B
ON A.ORIGINAL_HIERARCHY_NO=B.HIERARCHY_NO'


EXEC(@SQL)



SET @SQL='INSERT INTO #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION(RELATIONSHIP_BUILDER_SID,HIERARCHY_LEVEL_DEFINITION_SID, RELATIONSHIP_LEVEL_VALUES,
LEVEL_NO,LEVEL_NAME,PARENT_NODE,HIERARCHY_NO,CREATED_BY,CREATED_DATE,MODIFIED_BY,MODIFIED_DATE
)
 SELECT  
 A.RELATIONSHIP_BUILDER_SID
 ,A.HIERARCHY_LEVEL_DEFINITION_SID
 ,A.RELATIONSHIP_LEVEL_VALUES
 ,A.LEVEL_NO
 ,A.LEVEL_NAME
 ,B.LEVEL_NO+''~''+B.RELATIONSHIP_LEVEL_VALUES AS PARENT_NODE
  ,A.HIERARCHY_NO+''.''
 ,		1 as CREATED_BY
,getdate() as CREATED_DATE
,1 as MODIFIED_BY
,getdate() as MODIFIED_DATE

 FROM 
 (
 select DISTINCT a.RELATIONSHIP_BUILDER_SID
, d.HIERARCHY_LEVEL_DEFINITION_SID
,b.column2 AS RELATIONSHIP_LEVEL_VALUES,
'+@iteration+' AS LEVEL_NO,
'''+@LEVEL_NAME+''' AS LEVEL_NAME ,
A.HIERARCHY_NO+CAST(B.COLUMN3 AS VARCHAR) AS HIERARCHY_NO,
A.HIERARCHY_NO AS ORIGINAL_HIERARCHY_NO

  from #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION a
 left join #TEMP1 b on a.RELATIONSHIP_LEVEL_VALUES=b.column1
  INNER join #NEWLEVEL1 c on c.DEDUCTION_RELATION=a.RELATIONSHIP_BUILDER_SID
  AND C.RELATIONSHIP_BUILDER_SID= (SELECT RELATIONSHIP_BUILDER_SID FROM #TEM)
    left join (select HIERARCHY_LEVEL_DEFINITION_SID from HIERARCHY_LEVEL_DEFINITION where  HIERARCHY_DEFINITION_SID =(
select HIERARCHY_DEFINITION_SID from HIERARCHY_DEFINITION where HIERARCHY_NAME='''+@HIERARCHY+''') and LEVEL_NO='+@iteration+'

)d 
on 1=1)A LEFT JOIN  #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION B
ON A.ORIGINAL_HIERARCHY_NO=B.HIERARCHY_NO'




EXEC (@SQL)


	DELETE FROM #INTERMEDIATE_RELATIONSHIP_LEVEL_DEFINITION WHERE  LEVEL_NO<>@iteration





END





    SET @iteration+=1

--update #FINAL_RELATIONSHIP_LEVEL_DEFINITION  set VERSION_NO=(	SELECT VERSION_NO+1 FROM RELATIONSHIP_BUILDER WHERE  RELATIONSHIP_BUILDER_SID = (SELECT DEDUCTION_RELATION_SID FROM #TEM1))
update #FINAL_RELATIONSHIP_LEVEL_DEFINITION  set VERSION_NO=(select coalesce((
 SELECT TOP 1  VERSION_NO+1 FROM RELATIONSHIP_LEVEL_DEFINITION WHERE RELATIONSHIP_BUILDER_SID =( SELECT TOP 1 RELATIONSHIP_BUILDER_SID FROM #FINAL_RELATIONSHIP_LEVEL_DEFINITION )
 ORDER BY VERSION_NO DESC),1))
--select * from #FINAL_RELATIONSHIP_LEVEL_DEFINITION
 
    RAISERROR('',10,1) WITH NOWAIT
END

INSERT INTO RELATIONSHIP_LEVEL_DEFINITION (
RELATIONSHIP_BUILDER_SID
,HIERARCHY_LEVEL_DEFINITION_SID
,RELATIONSHIP_LEVEL_VALUES
,LEVEL_NO
,LEVEL_NAME
,PARENT_NODE
,HIERARCHY_NO
,CREATED_BY
,CREATED_DATE
,MODIFIED_BY
,MODIFIED_DATE
,VERSION_NO)



SELECT 
RELATIONSHIP_BUILDER_SID
,HIERARCHY_LEVEL_DEFINITION_SID
,RELATIONSHIP_LEVEL_VALUES
,LEVEL_NO
,LEVEL_NAME
,PARENT_NODE
,HIERARCHY_NO
,CREATED_BY
,CREATED_DATE
,MODIFIED_BY
,MODIFIED_DATE
,VERSION_NO


 FROM #FINAL_RELATIONSHIP_LEVEL_DEFINITION 

   SET @intFlagp+=1

       RAISERROR('',10,1) WITH NOWAIT



END







    SET @INTFLAG = @INTFLAG + 1
end



     IF OBJECT_ID('TEMPDB..#TEMP') IS NOT NULL
        DROP TABLE #TEMP

      CREATE TABLE #TEMP
        (
           PROJECTION_MASTER_SID          INT,
           PROD_RELATIONSHIP_BUILDER_SID          INT,
           RELATIONSHIP_BUILDER_SID INT,
                 DeductionHierarchy int
        )

insert into  #TEMP (PROJECTION_MASTER_SID,PROD_RELATIONSHIP_BUILDER_SID,RELATIONSHIP_BUILDER_SID,DeductionHierarchy)
  select PROJECTION_MASTER_SID,PROD_RELATIONSHIP_BUILDER_SID,b.RELATIONSHIP_BUILDER_SID ,(select top 1 HIERARCHY_DEFINITION_SID
    from HIERARCHY_DEFINITION where HIERARCHY_NAME='DeductionHierarchy') as DeductionHierarchy  from PROJECTION_MASTER a 
  join RELATIONSHIP_BUILDER b on a.PROD_RELATIONSHIP_BUILDER_SID=b.DEDUCTION_RELATION
  where  DEDUCTION_HIERARCHY_SID is null and DED_RELATIONSHIP_BULDER_SID is null


UPDATE t1
SET 
t1.DEDUCTION_HIERARCHY_SID = t2.DeductionHierarchy, 
t1.DED_RELATIONSHIP_BULDER_SID = t2.RELATIONSHIP_BUILDER_SID
FROM PROJECTION_MASTER t1
right  JOIN
#TEMP t2
ON t1.PROD_RELATIONSHIP_BUILDER_SID =t2.PROD_RELATIONSHIP_BUILDER_SID
where t1.DEDUCTION_HIERARCHY_SID is null and t1.DED_RELATIONSHIP_BULDER_SID is null







     IF OBJECT_ID('TEMPDB..#TEMP_CFF') IS NOT NULL
        DROP TABLE #TEMP_CFF

      CREATE TABLE #TEMP_CFF
        (
           CFF_MASTER_SID          INT,
           PROD_RELATIONSHIP_BUILDER_SID          INT,
           RELATIONSHIP_BUILDER_SID INT,
                 DEDUCTIONHIERARCHY INT
        )

INSERT INTO  #TEMP_CFF (CFF_MASTER_SID,PROD_RELATIONSHIP_BUILDER_SID,RELATIONSHIP_BUILDER_SID,DEDUCTIONHIERARCHY)

  SELECT CFF_MASTER_SID,PROD_RELATIONSHIP_BUILDER_SID,B.RELATIONSHIP_BUILDER_SID ,(SELECT TOP 1 HIERARCHY_DEFINITION_SID
    FROM HIERARCHY_DEFINITION WHERE HIERARCHY_NAME='DEDUCTIONHIERARCHY') AS DEDUCTIONHIERARCHY  FROM CFF_MASTER A 
  JOIN RELATIONSHIP_BUILDER B ON A.PROD_RELATIONSHIP_BUILDER_SID=B.DEDUCTION_RELATION
  WHERE  DEDUCTION_HIERARCHY_SID IS NULL AND DED_RELATIONSHIP_BULDER_SID IS NULL


UPDATE T1
SET 
T1.DEDUCTION_HIERARCHY_SID = T2.DEDUCTIONHIERARCHY, 
T1.DED_RELATIONSHIP_BULDER_SID = T2.RELATIONSHIP_BUILDER_SID
FROM CFF_MASTER T1
RIGHT  JOIN
#TEMP_CFF T2
ON T1.PROD_RELATIONSHIP_BUILDER_SID =T2.PROD_RELATIONSHIP_BUILDER_SID
WHERE T1.DEDUCTION_HIERARCHY_SID IS NULL AND T1.DED_RELATIONSHIP_BULDER_SID IS NULL





	
     IF OBJECT_ID('TEMPDB..#TEMP1_DED') IS NOT NULL
            DROP TABLE #TEMP1_DED

create table #temp1_DED
(
RELATIONSHIP_BUILDER_SID int,
VERSION_NO int
)
INSERT INTO  #temp1_DED


select RELATIONSHIP_BUILDER_SID,VERSION_NO FROM 
(
select *,row_number() over(partition by RELATIONSHIP_BUILDER_SID order by RELATIONSHIP_BUILDER_SID,version_no desc) rno from
(
select distinct RELATIONSHIP_BUILDER_SID,VERSION_NO from RELATIONSHIP_LEVEL_DEFINITION rld where exists(select 1 from RELATIONSHIP_BUILDER rb where rb.RELATIONSHIP_BUILDER_SID=rld.RELATIONSHIP_BUILDER_SID and rb.RELATIONSHIP_NAME like '%deduction' ) )c )B
where rno>1 

order by RELATIONSHIP_BUILDER_SID	

DELETE A FROM RELATIONSHIP_LEVEL_DEFINITION A 
JOIN
#temp1_DED B ON
A.RELATIONSHIP_BUILDER_SID=B.RELATIONSHIP_BUILDER_SID
AND 
 A.VERSION_NO=B.VERSION_NO
