<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<custom-sql>
    <sql id="getHierarchyMapQuery">
		<![CDATA[
                    SELECT RLD.RELATIONSHIP_LEVEL_SID,
                    RLD.RELATIONSHIP_LEVEL_VALUES,
                    RLD.LEVEL_NO,
                    RLD.LEVEL_NAME,
                    RLD.HIERARCHY_NO,
                    CASE WHEN HLD.TABLE_NAME=JVIEW.REFERENCE_TABLE_NAME THEN HLD.TABLE_NAME ELSE JVIEW.REFERENCE_TABLE_NAME  END AS TABLE_NAME,
                    CASE WHEN JVIEW.MAPPING_COLUMN_NAME is null THEN JVIEW.PRIMARY_KEY_COLUMN_NAME ELSE JVIEW.MAPPING_COLUMN_NAME  END AS FIELD_NAME,
                    HT.DESCRIPTION,
                    RLD.PARENT_NODE, RLD.FLAG
                    FROM RELATIONSHIP_LEVEL_DEFINITION RLD 
                    JOIN HIERARCHY_LEVEL_DEFINITION HLD ON HLD.HIERARCHY_LEVEL_DEFINITION_SID=RLD.HIERARCHY_LEVEL_DEFINITION_SID 
                        AND (HLD.TABLE_NAME <>'') 
                    AND RLD.RELATIONSHIP_BUILDER_SID = ? 
                    JOIN HIERARCHY_DEFINITION HD ON HD.HIERARCHY_DEFINITION_SID=HLD.HIERARCHY_DEFINITION_SID
                    JOIN vw_helper_list JVIEW ON JVIEW.ACTUAL_TABLE_NAME=HLD.TABLE_NAME AND JVIEW.ACTUAL_COLUMN_NAME=HLD.FIELD_NAME
                    JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=HD.HIERARCHY_CATEGORY 
                    ORDER BY RLD.HIERARCHY_NO;
                ]]>
    </sql>
    <sql id="nm.saveCcp">
		<![CDATA[
                   MERGE PROJECTION_DETAILS AS TARGET
                   USING (SELECT distinct ?PMPROJECTION_MASTER_SID, CCP1.CCP_DETAILS_SID FROM 
                    (SELECT CCP.CCP_DETAILS_SID
                    FROM RELATIONSHIP_LEVEL_DEFINITION RLD, 
                    CCP_MAP CCP 
                    WHERE RLD.HIERARCHY_NO like '?HN%' 
                    AND CCP.RELATIONSHIP_LEVEL_SID=RLD.RELATIONSHIP_LEVEL_SID) CCP1, 
                    (SELECT distinct CCPD.CCP_DETAILS_SID 
                    FROM CCP_MAP CCP JOIN RELATIONSHIP_LEVEL_DEFINITION RLD 
                    ON CCP.RELATIONSHIP_LEVEL_SID=RLD.RELATIONSHIP_LEVEL_SID 
                    JOIN PROJECTION_PROD_HIERARCHY PPH 
                    ON PPH.RELATIONSHIP_LEVEL_SID=RLD.RELATIONSHIP_LEVEL_SID AND PPH.PROJECTION_MASTER_SID=?PM
                    JOIN CCP_DETAILS CCPD ON CCP.CCP_DETAILS_SID=CCPD.CCP_DETAILS_SID) CCP2 
                    WHERE CCP1.CCP_DETAILS_SID=CCP2.CCP_DETAILS_SID) AS SOURCE
                   ON ( TARGET.PROJECTION_MASTER_SID = SOURCE.PROJECTION_MASTER_SID
                   AND TARGET.CCP_DETAILS_SID = SOURCE.CCP_DETAILS_SID)
                   WHEN NOT MATCHED THEN
                   INSERT (PROJECTION_MASTER_SID,CCP_DETAILS_SID)
                   VALUES (SOURCE.PROJECTION_MASTER_SID, SOURCE.CCP_DETAILS_SID); 

                ]]>
    </sql>
    
    <sql id="nm.salesTableUpdate">
	<![CDATA[
            Update NM_SALES_PROJECTION  SET PROJECTION_SALES=0,PROJECTION_UNITS=0 Where 
            PERIOD_SID>=(select PERIOD_SID from PERIOD  Where "MONTH"=MONTH(GETDATE()) and "YEAR" = YEAR(GETDATE())) 
            and PROJECTION_DETAILS_SID in(
            select distinct PROJECTION_DETAILS_SID from PROJECTION_DETAILS PD 
            JOIN CCP_DETAILS CCP_D ON CCP_D.CCP_DETAILS_SID=PD.CCP_DETAILS_SID 
            AND CCP_D.CONTRACT_MASTER_SID=?CON AND CCP_D.?FIELD in (?COM) 
            Where PD.PROJECTION_MASTER_SID=?PM) ;
                ]]>
    </sql>
    <sql id="nm.discountTableUpdate">
	<![CDATA[
            Update NM_DISCOUNT_PROJECTION  SET PROJECTION_SALES=0,PROJECTION_RATE=0 Where 
            PERIOD_SID>=(select PERIOD_SID from PERIOD  Where "MONTH"=MONTH(GETDATE()) and "YEAR" = YEAR(GETDATE())) 
            and PROJECTION_DETAILS_SID in(
            select distinct PROJECTION_DETAILS_SID from PROJECTION_DETAILS PD 
            JOIN CCP_DETAILS CCP_D ON CCP_D.CCP_DETAILS_SID=PD.CCP_DETAILS_SID 
            AND CCP_D.CONTRACT_MASTER_SID=?CON AND CCP_D.?FIELD in (?COM) 
            Where PD.PROJECTION_MASTER_SID=?PM) ;
                ]]>
    </sql>
    <sql id="nm.ppaTableUpdate">
	<![CDATA[
            Update NM_PPA_PROJECTION SET PROJECTION_SALES=0,PROJECTION_RATE=0 Where 
            PERIOD_SID>=(select PERIOD_SID from PERIOD  Where "MONTH"=MONTH(GETDATE()) and "YEAR" = YEAR(GETDATE())) 
            and PROJECTION_DETAILS_SID in(
            select distinct PROJECTION_DETAILS_SID from PROJECTION_DETAILS PD  
            JOIN CCP_DETAILS CCP_D ON CCP_D.CCP_DETAILS_SID=PD.CCP_DETAILS_SID 
            AND CCP_D.CONTRACT_MASTER_SID=?CON AND CCP_D.?FIELD in (?COM) 
            Where PD.PROJECTION_MASTER_SID=?PM) ;
                ]]>
    </sql>
    <sql id="man.salesTableUpdate">
	<![CDATA[
            Update M_SALES_PROJECTION  SET PROJECTION_SALES=0,PROJECTION_UNITS=0 Where 
            PERIOD_SID>=(select PERIOD_SID from PERIOD  Where "MONTH"=MONTH(GETDATE()) and "YEAR" = YEAR(GETDATE())) 
            and PROJECTION_DETAILS_SID in(
            select distinct PROJECTION_DETAILS_SID from PROJECTION_DETAILS PD 
            JOIN CCP_DETAILS CCP_D ON CCP_D.CCP_DETAILS_SID=PD.CCP_DETAILS_SID 
            AND CCP_D.CONTRACT_MASTER_SID=?CON AND CCP_D.?FIELD in (?COM)
            Where PD.PROJECTION_MASTER_SID=?PM) ;
                ]]>
    </sql>
    <sql id="man.discountTableUpdate">
	<![CDATA[
            Update M_DISCOUNT_PROJECTION  SET PROJECTION_SALES=0,PROJECTION_RATE=0 Where 
            PERIOD_SID>=(select PERIOD_SID from PERIOD  Where "MONTH"=MONTH(GETDATE()) and "YEAR" = YEAR(GETDATE())) 
            and PROJECTION_DETAILS_SID in(
            select distinct PROJECTION_DETAILS_SID from PROJECTION_DETAILS PD  
            JOIN CCP_DETAILS CCP_D ON CCP_D.CCP_DETAILS_SID=PD.CCP_DETAILS_SID 
            AND CCP_D.CONTRACT_MASTER_SID=?CON AND CCP_D.?FIELD in (?COM) 
            Where PD.PROJECTION_MASTER_SID=?PM) ;
                ]]>
    </sql>
    <sql id="man.suppTableUpdate">
	<![CDATA[
            Update M_SUPPLEMENTAL_DISC_PROJ SET PROJECTION_SALES=0,PROJECTION_RATE=0 Where 
            PERIOD_SID>=(select PERIOD_SID from PERIOD  Where "MONTH"=MONTH(GETDATE()) and "YEAR" = YEAR(GETDATE())) 
            and PROJECTION_DETAILS_SID in(
            select distinct PROJECTION_DETAILS_SID from PROJECTION_DETAILS PD   
            JOIN CCP_DETAILS CCP_D ON CCP_D.CCP_DETAILS_SID=PD.CCP_DETAILS_SID 
            AND CCP_D.CONTRACT_MASTER_SID=?CON AND CCP_D.?FIELD in (?COM) 
            Where PD.PROJECTION_MASTER_SID=?PM) ;
                ]]>
    </sql>
    <sql id="nm.removediscountupdate">
	<![CDATA[
            UPDATE ST_NM_DISCOUNT_PROJECTION  SET PROJECTION_SALES=0,PROJECTION_RATE=0 Where
                PERIOD_SID>=(select PERIOD_SID from PERIOD  Where "MONTH"=MONTH(GETDATE()) and "YEAR" = YEAR(GETDATE()) ) AND
                PROJECTION_DETAILS_SID in(
                select distinct PROJECTION_DETAILS_SID from PROJECTION_DETAILS PD
                JOIN CCP_DETAILS CCP_D ON CCP_D.CCP_DETAILS_SID=PD.CCP_DETAILS_SID
                AND CCP_D.CONTRACT_MASTER_SID = ?CON  AND CCP_D.COMPANY_MASTER_SID IN (?COM)
                Where PD.PROJECTION_MASTER_SID=?PM
                )AND  RS_MODEL_SID IN (SELECT RS_MODEL_SID FROM RS_CONTRACT 
                WHERE RS_CONTRACT_SID IN (?RS)) ;
                ]]>
    </sql>
    <sql id="nm.saveCustomerCcp">
		<![CDATA[
                   IF OBJECT_ID('TEMPDB.DBO.#RELATIONSHIP_INFO', 'U') IS NOT NULL
            DROP TABLE #RELATIONSHIP_INFO

                CREATE TABLE #RELATIONSHIP_INFO (
                       RELATIONSHIP_LEVEL_SID INT
                       ,RELATIONSHIP_LEVEL_VALUES INT
                       ,LEVEL_NO INT
                       ,LEVEL_NAME VARCHAR(100)
                       ,HIERARCHY_NO VARCHAR(100)
                       ,TABLE_NAME VARCHAR(30)
                       ,FIELD_NAME VARCHAR(30)
                       ,HELPER_VALUE VARCHAR(100)
                       ,PARENT_NODE VARCHAR(100)
                       ,FLAG VARCHAR(50)
                       ,PARENT VARCHAR(100)
                       ,PRIMARY KEY (
                              RELATIONSHIP_LEVEL_VALUES
                              ,HIERARCHY_NO
                              ,LEVEL_NAME
                              )
                       )

                INSERT INTO #RELATIONSHIP_INFO (
                       RELATIONSHIP_LEVEL_SID
                       ,RELATIONSHIP_LEVEL_VALUES
                       ,LEVEL_NO
                       ,LEVEL_NAME
                       ,HIERARCHY_NO
                       ,TABLE_NAME
                       ,FIELD_NAME
                       ,HELPER_VALUE
                       ,PARENT_NODE
                       ,FLAG
                       ,PARENT
                       )
                        SELECT RLD.RELATIONSHIP_LEVEL_SID,
               RLD.RELATIONSHIP_LEVEL_VALUES,
               RLD.LEVEL_NO,
               RLD.LEVEL_NAME,
               RLD.HIERARCHY_NO,
               CASE
                 WHEN HLD.TABLE_NAME = JVIEW.REFERENCE_TABLE_NAME THEN HLD.TABLE_NAME
                 ELSE JVIEW.REFERENCE_TABLE_NAME
               END                   AS TABLE_NAME,
               CASE
                 WHEN JVIEW.MAPPING_COLUMN_NAME IS NULL THEN
                 JVIEW.PRIMARY_KEY_COLUMN_NAME
                 ELSE JVIEW.MAPPING_COLUMN_NAME
               END                   AS FIELD_NAME,
               HT.DESCRIPTION,
               RLD.PARENT_NODE,
               RLD.FLAG,
               SUBSTRING(RLD.PARENT_NODE, CHARINDEX('~', RLD.PARENT_NODE) + 1,
               LEN(RLD.PARENT_NODE)) AS PARENT
        FROM   RELATIONSHIP_LEVEL_DEFINITION RLD
               JOIN HIERARCHY_LEVEL_DEFINITION HLD
                 ON HLD.HIERARCHY_LEVEL_DEFINITION_SID = RLD.HIERARCHY_LEVEL_DEFINITION_SID
                    AND ( HLD.TABLE_NAME <> '' )
                 
                       AND RLD.RELATIONSHIP_BUILDER_SID IN (?RBS)
               JOIN HIERARCHY_DEFINITION HD
                 ON HD.HIERARCHY_DEFINITION_SID = HLD.HIERARCHY_DEFINITION_SID
               JOIN VW_HELPER_LIST JVIEW
                 ON JVIEW.ACTUAL_TABLE_NAME = HLD.TABLE_NAME
                    AND JVIEW.ACTUAL_COLUMN_NAME = HLD.FIELD_NAME
               JOIN HELPER_TABLE HT
                 ON HT.HELPER_TABLE_SID = HD.HIERARCHY_CATEGORY
        WHERE  RLD.RELATIONSHIP_LEVEL_VALUES IS NOT NULL
        ORDER  BY RLD.RELATIONSHIP_LEVEL_SID

                        IF OBJECT_ID('TEMPDB.DBO.#CCP_MAP', 'U') IS NOT NULL
          DROP TABLE #CCP_MAP

        CREATE TABLE #CCP_MAP
          (
             RELATIONSHIP_LEVEL_SID INT,
             CCP_DETAILS_SID        INT
             PRIMARY KEY CLUSTERED ( CCP_DETAILS_SID, RELATIONSHIP_LEVEL_SID )
          )

        INSERT INTO #CCP_MAP
                    (RELATIONSHIP_LEVEL_SID,
                     CCP_DETAILS_SID)
        SELECT RELATIONSHIP_LEVEL_SID,
               CCP.CCP_DETAILS_SID
        FROM   CCP_DETAILS CCP
               INNER JOIN #RELATIONSHIP_INFO RI
                       ON CCP.COMPANY_MASTER_SID = RI.RELATIONSHIP_LEVEL_VALUES
                          AND CCP.CONTRACT_MASTER_SID = RI.PARENT
                          AND RI.LEVEL_NAME IN ( 'TRADING PARTNER', 'CUSTOMER' )
               INNER JOIN CONTRACT_MASTER CM
                       ON CM.CONTRACT_MASTER_SID = CCP.CONTRACT_MASTER_SID
               INNER JOIN HELPER_TABLE HT
                       ON CM.CONTRACT_TYPE = HT.HELPER_TABLE_SID
                          AND HT.LIST_NAME = 'CONTRACT_TYPE'


        IF OBJECT_ID('TEMPDB.DBO.#CCP_INFO', 'U') IS NOT NULL
          DROP TABLE #CCP_INFO

        CREATE TABLE #CCP_INFO
          (
             RELATIONSHIP_LEVEL_SID INT,
             CONTRACT_MASTER_SID    INT,
             CCP_DETAILS_SID        INT
             PRIMARY KEY CLUSTERED ( CCP_DETAILS_SID, CONTRACT_MASTER_SID,
             RELATIONSHIP_LEVEL_SID )
        )

        INSERT INTO #CCP_INFO
                    (RELATIONSHIP_LEVEL_SID,
                     CONTRACT_MASTER_SID,
                     CCP_DETAILS_SID)
        SELECT RELATIONSHIP_LEVEL_SID,
               CCP.CONTRACT_MASTER_SID,
               CCP_DETAILS_SID
        FROM   CCP_DETAILS CCP
               INNER JOIN (SELECT CONTRACT_MASTER_SID,
                                  RELATIONSHIP_LEVEL_SID
                           FROM   #RELATIONSHIP_INFO RI
                                  INNER JOIN CONTRACT_MASTER CON
                                          ON CON.CONTRACT_MASTER_SID =
                                             RI.RELATIONSHIP_LEVEL_VALUES
                                             AND RI.LEVEL_NAME = 'CONTRACT'
                                  INNER JOIN HELPER_TABLE HT
                                          ON RI.PARENT = HT.HELPER_TABLE_SID
                                             AND HT.LIST_NAME = 'CONTRACT_TYPE') A
                       ON CCP.CONTRACT_MASTER_SID = A.CONTRACT_MASTER_SID



        
        INSERT INTO CCP_MAP
                    (RELATIONSHIP_LEVEL_SID,
                     CCP_DETAILS_SID)
        SELECT RELATIONSHIP_LEVEL_SID,
               CCP_DETAILS_SID
        FROM   (SELECT RELATIONSHIP_LEVEL_SID,
                       CCP_DETAILS_SID
                FROM   (SELECT RELATIONSHIP_LEVEL_SID,
                               RELATIONSHIP_LEVEL_VALUES
                        FROM   #RELATIONSHIP_INFO RI
                               INNER JOIN ITEM_MASTER IM
                                       ON IM.ITEM_MASTER_SID =
                                          RI.RELATIONSHIP_LEVEL_VALUES
                                          AND IM.BRAND_MASTER_SID = RI.PARENT
                                          AND RI.LEVEL_NAME IN (
                                              'NDC', 'N.D.C.', 'PRODUCT',
                                              'ITEM' )
                               INNER JOIN BRAND_MASTER BM
                                       ON IM.BRAND_MASTER_SID = BM.BRAND_MASTER_SID)A
                       INNER JOIN CCP_DETAILS CCP
                               ON CCP.ITEM_MASTER_SID = A.RELATIONSHIP_LEVEL_VALUES) CP
        WHERE  NOT EXISTS (SELECT 1
                           FROM   CCP_MAP C
                           WHERE  C.RELATIONSHIP_LEVEL_SID = CP.RELATIONSHIP_LEVEL_SID
                                  AND C.CCP_DETAILS_SID = CP.CCP_DETAILS_SID)
        UNION ALL
        SELECT RELATIONSHIP_LEVEL_SID,
               CCP_DETAILS_SID
        FROM   #CCP_INFO CP
        WHERE  NOT EXISTS (SELECT 1
                           FROM   CCP_MAP C
                           WHERE  C.RELATIONSHIP_LEVEL_SID = CP.RELATIONSHIP_LEVEL_SID
                                  AND C.CCP_DETAILS_SID = CP.CCP_DETAILS_SID)
        UNION ALL
        SELECT RELATIONSHIP_LEVEL_SID,
               CCP_DETAILS_SID
        FROM   #CCP_MAP CP
        WHERE  NOT EXISTS (SELECT 1
                           FROM   CCP_MAP C
                           WHERE  C.RELATIONSHIP_LEVEL_SID = CP.RELATIONSHIP_LEVEL_SID
                                  AND C.CCP_DETAILS_SID = CP.CCP_DETAILS_SID)
                ]]>
    </sql>

    
</custom-sql>
