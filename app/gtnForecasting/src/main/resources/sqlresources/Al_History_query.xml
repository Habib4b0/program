<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<sql>
 
   
    <entity id="AllocationTab_reset_query_sales">
        <query> 
            <![CDATA[
update ST_ALTERNATE_HIST_ALLOCATION   SET ACTUAL_UNITS =0 ,PROJECTION_UNITS =0,
ACTUAL_ALLOCATION_PERCENT=0,PROJECTION_ALLOCATION_PERCENT=0 WHERE CHECK_RECORD=1
         ]]>
        </query>
    </entity>
    
    <entity id="AllocationTab_reset_query_Discount">
        <query> 
            <![CDATA[
update dbo.ST_DISC_ALTERNATE_HIST_ALLOCATION   SET ACTUAL_AMOUNT =0 ,PROJECTION_AMOUNT =0,
ACTUAL_ALLOCATION_PERCENT=0,PROJECTION_ALLOCATION_PERCENT=0 WHERE CHECK_RECORD=1
         ]]>
        </query>
    </entity>
    <entity id="CUSTOMER_SELECTION_AVAILABLE_SEARCH_QUERY">
        <query> 
            <![CDATA[
SELECT DISTINCT CM.COMPANY_NAME AS CONTRACT_HOLDER, 
                CON_M.CONTRACT_NO, 
                CON_M.CONTRACT_NAME, 
                HT.DESCRIPTION  AS MARKET_TYPE, 
                CM1.COMPANY_NO, 
                CM1.COMPANY_NAME, 
                CON_M.CONTRACT_MASTER_SID, 
                CM1.COMPANY_MASTER_SID,CS.AVAILABLE_CHECKBOX 
FROM   DBO.CONTRACT_MASTER CON_M 
       LEFT JOIN DBO.COMPANY_MASTER CM 
              ON CON_M.CONT_HOLD_COMPANY_MASTER_SID = CM.COMPANY_MASTER_SID 
       INNER JOIN DBO.HELPER_TABLE HT 
               ON CON_M.CONTRACT_TYPE = HT.HELPER_TABLE_SID 
       INNER JOIN DBO.CFP_CONTRACT CFP_CON 
               ON CON_M.CONTRACT_MASTER_SID = CFP_CON.CONTRACT_MASTER_SID 
       INNER JOIN DBO.CFP_CONTRACT_DETAILS CFP_CD 
               ON CFP_CON.CFP_CONTRACT_SID = CFP_CD.CFP_CONTRACT_SID 
       JOIN DBO.COMPANY_MASTER CM1 
         ON CM1.COMPANY_MASTER_SID = CFP_CD.COMPANY_MASTER_SID 
       LEFT JOIN ST_AL_HISTORY_CUSTOMER_SELECTION CS 
              ON CM1.COMPANY_MASTER_SID = CS.COMPANY_MASTER_SID
                 AND CON_M.CONTRACT_MASTER_SID = CS.CONTRACT_MASTER_SID 
         ]]>
        </query>
    </entity>
    
    <entity id="CUSTOMER_SELECTION_AVAILABLE_SEARCH_ADD_ALL_QUERY">
        <query> 
            <![CDATA[
SELECT DISTINCT CM.COMPANY_NAME AS CONTRACT_HOLDER, 
                CON_M.CONTRACT_NO, 
                CON_M.CONTRACT_NAME, 
                HT.DESCRIPTION  AS MARKET_TYPE, 
                CM1.COMPANY_NO, 
                CM1.COMPANY_NAME, 
                CON_M.CONTRACT_MASTER_SID, 
                CM1.COMPANY_MASTER_SID
FROM   DBO.CONTRACT_MASTER CON_M 
       LEFT JOIN DBO.COMPANY_MASTER CM 
              ON CON_M.CONT_HOLD_COMPANY_MASTER_SID = CM.COMPANY_MASTER_SID 
       INNER JOIN DBO.HELPER_TABLE HT 
               ON CON_M.CONTRACT_TYPE = HT.HELPER_TABLE_SID 
       INNER JOIN DBO.CFP_CONTRACT CFP_CON 
               ON CON_M.CONTRACT_MASTER_SID = CFP_CON.CONTRACT_MASTER_SID 
       INNER JOIN DBO.CFP_CONTRACT_DETAILS CFP_CD 
               ON CFP_CON.CFP_CONTRACT_SID = CFP_CD.CFP_CONTRACT_SID 
       JOIN DBO.COMPANY_MASTER CM1 
         ON CM1.COMPANY_MASTER_SID = CFP_CD.COMPANY_MASTER_SID 
      
         ]]>
        </query>
    </entity>
    
    <entity id="CUSTOMER_SELECTION_ADD_ALL_QUERY">
        <query> 
            <![CDATA[

MERGE ST_AL_HISTORY_CUSTOMER_SELECTION AS T
USING ([$SOURCE_TABLE]) AS S
ON T.CONTRACT_MASTER_SID = S.CONTRACT_MASTER_SID
   AND T.COMPANY_MASTER_SID = S.COMPANY_MASTER_SID
WHEN NOT MATCHED THEN
  INSERT (CONTRACT_MASTER_SID,
          COMPANY_MASTER_SID,
          AVAILABLE_CHECKBOX,
          SELECTED_RECORDS)
  VALUES (S.CONTRACT_MASTER_SID,
          S.COMPANY_MASTER_SID,
          [$AVAILABLE_CHECKBOX],
          [$SELECTED_RECORDS])
WHEN matched THEN
  UPDATE SET  T.AVAILABLE_CHECKBOX =[$AVAILABLE_CHECKBOX];
  
         ]]>
        </query>
    </entity>
    <entity id="CUSTOMER_SELECTION_REMOVE_ALL_QUERY">
        <query> 
            <![CDATA[
                    UPDATE ST_AL_HISTORY_CUSTOMER_SELECTION 
             SET    SELECTED_RECORDS = 0, 
                    SELECTED_CHECKBOX = 0 
         ]]>
        </query>
    </entity>
    
    <entity id="CUSTOMER_SELECTION_REMOVE_QUERY">
        <query> 
            <![CDATA[
                    UPDATE ST_AL_HISTORY_CUSTOMER_SELECTION 
           SET    SELECTED_RECORDS = 0, 
                  SELECTED_CHECKBOX = 0 
           WHERE  SELECTED_CHECKBOX = 1 
         ]]>
        </query>
    </entity>
     <entity id="CUSTOMER_SELECTION_SELECTED_CHECK_ALL_QUERY">
        <query> 
            <![CDATA[
                    UPDATE ST_AL_HISTORY_CUSTOMER_SELECTION 
           SET    SELECTED_CHECKBOX = [$SELECTED_CHECKBOX]
           WHERE  SELECTED_RECORDS = 1 
         ]]>
        </query>
    </entity>
    
    <entity id="CUSTOMER_SELECTION_SINGLE_UPDATE_QUERY_AVALILABLE">
        <query> 
            <![CDATA[
                    UPDATE ST_AL_HISTORY_CUSTOMER_SELECTION 
        SET    AVAILABLE_CHECKBOX = [$AVAILABLE_CHECKBOX] 
        WHERE  CONTRACT_MASTER_SID = [$CONTRACT_MASTER_SID] 
               AND COMPANY_MASTER_SID = [$COMPANY_MASTER_SID]; 
         ]]>
        </query>
    </entity>
    
    <entity id="CUSTOMER_SELECTION_INSERT_OR_UPDATE_SINGLE_RECORD">
        <query> 
            <![CDATA[
IF NOT EXISTS (SELECT  1 FROM ST_AL_HISTORY_CUSTOMER_SELECTION WHERE CONTRACT_MASTER_SID =[$CONTRACT_MASTER_SID]  AND COMPANY_MASTER_SID=[$COMPANY_MASTER_SID] )
BEGIN 
 INSERT INTO ST_AL_HISTORY_CUSTOMER_SELECTION (
          CONTRACT_MASTER_SID,
          COMPANY_MASTER_SID,
          AVAILABLE_CHECKBOX) 
VALUES ([$CONTRACT_MASTER_SID],[$COMPANY_MASTER_SID],[$AVAILABLE_CHECKBOX])
END
ELSE
BEGIN

UPDATE ST_AL_HISTORY_CUSTOMER_SELECTION SET AVAILABLE_CHECKBOX = [$AVAILABLE_CHECKBOX] ,
 LAST_MODIFIED_DATE=GETDATE() WHERE CONTRACT_MASTER_SID=[$CONTRACT_MASTER_SID] AND COMPANY_MASTER_SID=[$COMPANY_MASTER_SID]

END
         ]]>
        </query>
    </entity>
    <entity id="CUSTOMER_SELECTION_ADD_RECORDS">
        <query> 
            <![CDATA[

            UPDATE DBO.ST_AL_HISTORY_CUSTOMER_SELECTION 
            SET    SELECTED_RECORDS = [$SELECTED_RECORDS], 
                   AVAILABLE_CHECKBOX = 0, 
                   LAST_MODIFIED_DATE = Getdate() 
            WHERE  AVAILABLE_CHECKBOX = 1 

         ]]>
        </query>
    </entity>
    <entity id="CUSTOMER_SELECTION_CHECK_UNCHECK_SELECTED">
        <query> 
            <![CDATA[
            UPDATE DBO.ST_AL_HISTORY_CUSTOMER_SELECTION 
            SET    SELECTED_CHECKBOX = [$SELECTED_CHECKBOX] , LAST_MODIFIED_DATE=GETDATE() 
            WHERE  CONTRACT_MASTER_SID=[$CONTRACT_MASTER_SID] 
            AND    COMPANY_MASTER_SID=[$COMPANY_MASTER_SID]

         ]]>
        </query>
    </entity>
    <entity id="CUSTOMER_SELECTION_CHECK_COUNT">
        <query> 
            <![CDATA[
                      IF EXISTS (  SELECT 1
            FROM   ST_AL_HISTORY_CUSTOMER_SELECTION 
            WHERE  AVAILABLE_CHECKBOX = [$AVAILABLE_CHECKBOX] )
                SELECT 1
            ELSE
                SELECT 0 
            
         ]]>
        </query>
    </entity>
    <entity id="CUSTOMER_SELECTION_SELECTED_SEARCH">
        <query> 
            <![CDATA[
                SELECT CM.COMPANY_NAME AS CONTRACT_HOLDER, 
       CON_M.CONTRACT_NO, 
       CON_M.CONTRACT_NAME, 
       HT.DESCRIPTION  AS MARKET_TYPE, 
       CM1.COMPANY_NO, 
       CM1.COMPANY_NAME, 
       CS.CONTRACT_MASTER_SID, 
       CS.COMPANY_MASTER_SID, 
       CS.SELECTED_CHECKBOX 
FROM   ST_AL_HISTORY_CUSTOMER_SELECTION CS 
       JOIN CONTRACT_MASTER CON_M 
         ON CON_M.CONTRACT_MASTER_SID = CS.CONTRACT_MASTER_SID 
       LEFT JOIN DBO.COMPANY_MASTER CM 
              ON CON_M.CONT_HOLD_COMPANY_MASTER_SID = CM.COMPANY_MASTER_SID 
       INNER JOIN DBO.HELPER_TABLE HT 
               ON CON_M.CONTRACT_TYPE = HT.HELPER_TABLE_SID 
       JOIN DBO.COMPANY_MASTER CM1 
         ON CM1.COMPANY_MASTER_SID = CS.COMPANY_MASTER_SID 
WHERE  SELECTED_RECORDS = 1 

         ]]>
        </query>
    </entity>
    <entity id="CUSTOMER_SELECTION_DELETE_QUERY">
        <query> 
            <![CDATA[
            DELETE ST_AL_HISTORY_CUSTOMER_SELECTION 
            WHERE SELECTED_RECORDS = 0
         ]]>
        </query>
    </entity>
    
    <entity id="reset-sales-allocation-table-on-allocation">
        <query> 
            <![CDATA[
                UPDATE
                    ST_ALTERNATE_HIST_ALLOCATION
                SET
                    ACTUAL_UNITS = 0,
                    PROJECTION_UNITS = 0,
                    ACTUAL_ALLOCATION_PERCENT = 0,
                    PROJECTION_ALLOCATION_PERCENT = 0;
        ]]>
        </query>
    </entity>
    
    <entity id="reset-discount-allocation-table-on-allocation">
        <query> 
            <![CDATA[
                UPDATE
                    ST_DISC_ALTERNATE_HIST_ALLOCATION
                SET
                    ACTUAL_AMOUNT = 0,
                    PROJECTION_AMOUNT = 0,
                    ACTUAL_ALLOCATION_PERCENT = 0,
                    PROJECTION_ALLOCATION_PERCENT = 0;
            ]]>
        </query>
    </entity>
    
    <entity id="update-allocation-percent">
        <query> 
            <![CDATA[
                UPDATE
                    ST
                SET
                    ST.[$ALLOCATION_PERCENT_COLUMN] = [$ALLOCATION_PERCENT],
                    ST.[$UPDATE_COLUMN] = ST.[$TOTAL_COLUMN] * ([$ALLOCATION_PERCENT] / 100),
                    ST.FLAG = '1'
                FROM 
                    [$TABLE_NAME] ST
                JOIN 
                    PERIOD PER 
                    ON PER.PERIOD_SID = ST.PERIOD_SID 
                WHERE
                    ST.CCP_DETAILS_SID = [$PROJECTION_DETAILS_SID]
                    AND PER."YEAR" = [$YEAR]
                    AND PER.[$FREQUENCY_COLUMN] = [$FREQUENCY];
            ]]>
        </query>
    </entity>
    
        <entity id="update-allocation-unit-amount">
        <query> 
            <![CDATA[
                DECLARE @NEW_VALUE NUMERIC(22,6) = [$NEW_VALUE],
                        @OLD_VALUE NUMERIC(22,6) = (SELECT SUM(ST.[$TOTAL_COLUMN])
                            FROM
                                    [$TABLE_NAME] ST
                            JOIN PERIOD PER ON PER.PERIOD_SID = ST.PERIOD_SID 	
                            WHERE
                                    CCP_DETAILS_SID = [$PROJECTION_DETAILS_SID]
                                    AND PER."YEAR" = [$YEAR]
                                    AND PER.[$FREQUENCY_COLUMN] = [$FREQUENCY]);


                UPDATE
                        ST
                SET
                        [$UPDATE_COLUMN] = ((@NEW_VALUE - @OLD_VALUE)/ NULLIF(@OLD_VALUE,0)) * ST.[$TOTAL_COLUMN] + ST.[$TOTAL_COLUMN],
                        [$ALLOCATION_PERCENT_COLUMN] = (@NEW_VALUE / NULLIF(@OLD_VALUE,0)) * 100,
                        FLAG = '0'
                FROM 
                        [$TABLE_NAME] ST
                JOIN PERIOD PER 
                        ON PER.PERIOD_SID = ST.PERIOD_SID 	
                WHERE
                        CCP_DETAILS_SID = [$PROJECTION_DETAILS_SID]
                        AND PER."YEAR" = [$YEAR]
                        AND PER.[$FREQUENCY_COLUMN] = [$FREQUENCY];
            ]]>
        </query>
    </entity>
    
                
</sql>