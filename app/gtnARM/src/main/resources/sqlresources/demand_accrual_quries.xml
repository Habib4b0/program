<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->


<sql>
    <entity id="Summary_DA_generate">

        <query>
                    <![CDATA[
                 DECLARE @PROJECTION      INT = ?,   
                @DEDUCTION_LEVEL VARCHAR(50) = '?',
                @MULTIPLE_PERIOD BIT = ?,
                @VIEW            VARCHAR(50) = '?',
                @BASE_VIEW VARCHAR(50) = '?',
                @FROM_PERIOD     VARCHAR(50) = '?', 
                @TO_PERIOD       VARCHAR(50) = '?', 
                @STRING          CHAR(1), 
                @RATE_FREQUENCY  VARCHAR(20) ='?', 
                @FROM_PERIOD_SID INT, 
                @TO_PERIOD_SID   INT,
                @LEVEL_NO INT,
                @ITEM_NO BIT select
                @LEVEL_NO = CASE
                WHEN @MULTIPLE_PERIOD = '0' THEN CASE
                    WHEN @BASE_VIEW = 'DEDUCTION_CUSTOMER_CONTRACT' THEN CASE
                            WHEN @VIEW = 'PRODUCT' THEN 5
                            WHEN @VIEW = 'BRAND' THEN 4
                            WHEN @VIEW = 'CONTRACT' THEN 3
                            WHEN @VIEW = 'CUSTOMER' THEN 2
                            WHEN @VIEW = 'DEDUCTION' THEN 1
                            WHEN @VIEW = 'DEDUCTION CATEGORY' THEN 1
                            WHEN @VIEW = 'DEDUCTION TYPE' THEN 1
                            WHEN @VIEW = 'DEDUCTION PROGRAM' THEN 1
                            WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN 1
                            WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN 1
                            WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN 1
                            WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN 1
                            WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN 1
                    END
                    WHEN @BASE_VIEW <> 'DEDUCTION_CUSTOMER_CONTRACT' THEN CASE
                            WHEN @VIEW = 'PRODUCT' THEN 5
                            WHEN @VIEW = 'BRAND' THEN 4
                            WHEN @VIEW = 'CUSTOMER' THEN 3
                            WHEN @VIEW = 'CONTRACT' THEN 2
                            WHEN @VIEW = 'DEDUCTION' THEN 1
                            WHEN @VIEW = 'DEDUCTION CATEGORY' THEN 1
                            WHEN @VIEW = 'DEDUCTION TYPE' THEN 1
                            WHEN @VIEW = 'DEDUCTION PROGRAM' THEN 1
                            WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN 1
                            WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN 1
                            WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN 1
                            WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN 1
                            WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN 1
                    END
                    END
		WHEN @MULTIPLE_PERIOD = '1' THEN CASE
			WHEN @BASE_VIEW = 'DEDUCTION_PRODUCT' THEN CASE
				WHEN @VIEW = 'PRODUCT' THEN 3
				WHEN @VIEW = 'BRAND' THEN 2
				WHEN @VIEW = 'DEDUCTION' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY' THEN 1
                                WHEN @VIEW = 'DEDUCTION TYPE' THEN 1
                                WHEN @VIEW = 'DEDUCTION PROGRAM' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN 1
			END
			WHEN @BASE_VIEW = 'DEDUCTION_CUSTOMER' THEN CASE
				WHEN @VIEW = 'PRODUCT' THEN 4
				WHEN @VIEW = 'BRAND' THEN 3
				WHEN @VIEW = 'CUSTOMER' THEN 2
				WHEN @VIEW = 'DEDUCTION' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY' THEN 1
                                WHEN @VIEW = 'DEDUCTION TYPE' THEN 1
                                WHEN @VIEW = 'DEDUCTION PROGRAM' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN 1
			END
			WHEN @BASE_VIEW = 'CUSTOMER_DEDUCTION' THEN CASE
				WHEN @VIEW = 'PRODUCT' THEN 4
				WHEN @VIEW = 'BRAND' THEN 3
				WHEN @VIEW = 'DEDUCTION' THEN 2
                                WHEN @VIEW = 'DEDUCTION CATEGORY' THEN 2
                                WHEN @VIEW = 'DEDUCTION TYPE' THEN 2
                                WHEN @VIEW = 'DEDUCTION PROGRAM' THEN 2
                                WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN 2
                                WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN 2
                                WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN 2
                                WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN 2
                                WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN 2
				WHEN @VIEW = 'CUSTOMER' THEN 1
			END
			WHEN @BASE_VIEW = 'DEDUCTION_CUSTOMER_CONTRACT' THEN CASE
				WHEN @VIEW = 'PRODUCT' THEN 5
				WHEN @VIEW = 'BRAND' THEN 4
				WHEN @VIEW = 'CONTRACT' THEN 3
				WHEN @VIEW = 'CUSTOMER' THEN 2
				WHEN @VIEW = 'DEDUCTION' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY' THEN 1
                                WHEN @VIEW = 'DEDUCTION TYPE' THEN 1
                                WHEN @VIEW = 'DEDUCTION PROGRAM' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN 1
                                WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN 1
			END
		END
	END SELECT
		@ITEM_NO = CASE
			WHEN @VIEW = 'PRODUCT' THEN 0
			WHEN @VIEW = 'BRAND' THEN 1
			WHEN @VIEW = 'CUSTOMER' THEN 1
			WHEN @VIEW = 'CONTRACT' THEN 1
			WHEN @VIEW = 'DEDUCTION' THEN 1
                        WHEN @VIEW = 'DEDUCTION CATEGORY' THEN 1
                        WHEN @VIEW = 'DEDUCTION TYPE' THEN 1
                        WHEN @VIEW = 'DEDUCTION PROGRAM' THEN 1
                        WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN 1
                        WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN 1
                        WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN 1
                        WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN 1
                        WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN 1
		END

SET @STRING=LEFT(@RATE_FREQUENCY, 1) 

IF OBJECT_ID('TEMPDB..#TEMP_PERIOD') IS NOT NULL 
  DROP TABLE #TEMP_PERIOD 

CREATE TABLE #TEMP_PERIOD 
  ( 
     PERIOD_SID  INT, 
     PERIODS     VARCHAR(50), 
     PERIOD_DATE DATETIME, 
     MONTH       INT, 
     YEAR        INT, 
     PRIMARY KEY(PERIOD_SID) 
  ) 

INSERT INTO #TEMP_PERIOD 
            (PERIOD_SID, 
             PERIODS, 
             PERIOD_DATE, 
             MONTH, 
             YEAR) 
SELECT PERIOD_SID, 
       PERIODS = CASE 
                   WHEN @STRING = 'M' THEN CONCAT (LEFT(DATENAME(MM, PERIOD_DATE), 3), ' ', YEAR)
                   WHEN @STRING = 'Q' THEN CONCAT ('Q', QUARTER, ' ', YEAR) 
                   WHEN @STRING = 'S' THEN CONCAT ('S', SEMI_ANNUAL, ' ', YEAR) 
                   ELSE CAST(YEAR AS CHAR(4)) 
                 END, 
       PERIOD_DATE, 
       MONTH, 
       YEAR 
FROM   PERIOD 

SELECT @FROM_PERIOD_SID = MIN(PERIOD_SID) 
FROM   #TEMP_PERIOD 
WHERE  PERIODS = @FROM_PERIOD 

SELECT @TO_PERIOD_SID = MAX(PERIOD_SID) 
FROM   #TEMP_PERIOD 
WHERE  PERIODS = @TO_PERIOD 

IF OBJECT_ID('TEMPDB..#CURR_PROJ') IS NOT NULL 
  DROP TABLE #CURR_PROJ 

CREATE TABLE #CURR_PROJ 
  ( 
     ARM_ADJUSTMENT_DETAILS_SID INT, 
     CCP_DETAILS_SID            INT, 
     RS_MODEL_SID               INT, 
     CONTRACT_MASTER_SID        INT, 
     COMPANY_MASTER_SID         INT, 
     ITEM_MASTER_SID            INT, 
     PRIMARY KEY (ARM_ADJUSTMENT_DETAILS_SID) 
  ) 

INSERT INTO #CURR_PROJ 
            (ARM_ADJUSTMENT_DETAILS_SID, 
             COMPANY_MASTER_SID, 
             CONTRACT_MASTER_SID, 
             ITEM_MASTER_SID, 
             CCP_DETAILS_SID, 
             RS_MODEL_SID) 
SELECT B.ARM_ADJUSTMENT_DETAILS_SID, 
       C.COMPANY_MASTER_SID, 
       C.CONTRACT_MASTER_SID, 
       C.ITEM_MASTER_SID, 
       B.CCP_DETAILS_SID, 
       B.RS_MODEL_SID 
FROM   ARM_ADJUSTMENT_DETAILS B 
       JOIN CCP_DETAILS C 
         ON B.CCP_DETAILS_SID = C.CCP_DETAILS_SID 
WHERE  B.PROJECTION_MASTER_SID = @PROJECTION 

IF OBJECT_ID('TEMPDB..#CURR_PROJ_PERIOD') IS NOT NULL 
  DROP TABLE #CURR_PROJ_PERIOD 

CREATE TABLE #CURR_PROJ_PERIOD 
  ( 
     ARM_ADJUSTMENT_DETAILS_SID INT, 
     CCP_DETAILS_SID            INT, 
     RS_MODEL_SID               INT, 
     CONTRACT_MASTER_SID        INT, 
     COMPANY_MASTER_SID         INT, 
     ITEM_MASTER_SID            INT, 
     PERIOD_SID                 INT, 
	 PERIODS                    VARCHAR(50),
     PRIMARY KEY (ARM_ADJUSTMENT_DETAILS_SID,PERIOD_SID) 
  ) 

INSERT INTO #CURR_PROJ_PERIOD 
            (ARM_ADJUSTMENT_DETAILS_SID, 
             COMPANY_MASTER_SID, 
             CONTRACT_MASTER_SID, 
             ITEM_MASTER_SID, 
             CCP_DETAILS_SID, 
             RS_MODEL_SID,
			 PERIOD_SID,
			 PERIODS) 
SELECT A.ARM_ADJUSTMENT_DETAILS_SID, 
       A.COMPANY_MASTER_SID, 
       A.CONTRACT_MASTER_SID, 
       A.ITEM_MASTER_SID, 
       A.CCP_DETAILS_SID, 
       A.RS_MODEL_SID, 
       P.PERIOD_SID,
	   P.PERIODS 
FROM   #CURR_PROJ A 
       CROSS JOIN #TEMP_PERIOD P 
WHERE  P.PERIOD_SID BETWEEN @FROM_PERIOD_SID AND @TO_PERIOD_SID 

DECLARE @TEMP_HELPER AS TABLE 
  ( 
     HELPER_TABLE_SID INT, 
     DESCRIPTION      VARCHAR(100), 
     LIST_NAME        VARCHAR(100), 
     PRIMARY KEY (HELPER_TABLE_SID) 
  ) 

INSERT INTO @TEMP_HELPER 
            (HELPER_TABLE_SID, 
             DESCRIPTION, 
             LIST_NAME) 
SELECT HELPER_TABLE_SID, 
       DESCRIPTION, 
       LIST_NAME 
FROM   HELPER_TABLE 
WHERE  LIST_NAME IN ( 'RS_UDC1', 'RS_UDC2', 'RS_UDC3', 'RS_UDC4', 
                      'RS_UDC5', 'RS_UDC6', 'RS_TYPE', 'RS_CATEGORY', 'REBATE_PROGRAM_TYPE' )

IF OBJECT_ID('TEMPDB..#ARM_DEMAND_ADJ_SUMMARY') IS NOT NULL 
  DROP TABLE #ARM_DEMAND_ADJ_SUMMARY 

CREATE TABLE #ARM_DEMAND_ADJ_SUMMARY 
  ( 
     ARM_ADJUSTMENT_DETAILS_SID INT, 
     PERIOD                     VARCHAR(50), 
     PERIOD_SID                 VARCHAR(10),
     ITEM_ID                    VARCHAR(50), 
     ITEM_NAME                  VARCHAR(100), 
     BRAND_ID                   VARCHAR(50), 
     BRAND_NAME                 VARCHAR(100), 
     COMPANY_ID                 VARCHAR(50), 
     COMPANY_NAME               VARCHAR(100), 
     CONTRACT_ID                VARCHAR(50), 
     [CONTRACT_NAME]            VARCHAR(100), 
     RS_CATEGORY                VARCHAR(50), 
     RS_TYPE                    VARCHAR(50), 
     REBATE_PROGRAM_TYPE        VARCHAR(50), 
     RS_ID                      VARCHAR(50), 
     RS_NAME                    VARCHAR(100), 
     UDC1                       VARCHAR(50), 
     UDC2                       VARCHAR(50), 
     UDC3                       VARCHAR(50), 
     UDC4                       VARCHAR(50), 
     UDC5                       VARCHAR(50), 
     UDC6                       VARCHAR(50), 
     DEMAND_ACCRUAL             NUMERIC(22, 6), 
     DEMAND_ACCRUAL_REFORECAST  NUMERIC(22, 6), 
     TOTAL_DEMAND_ACCRUAL       NUMERIC(22, 6), 
     PROJ_TOTAL_DEMAND_ACCRUAL  NUMERIC(22, 6), 
     DEMAND_ACCRUAL_RATIO       NUMERIC(22, 6), 
     VARIANCE                   NUMERIC(22, 6), 
     [OVERRIDE]                 NUMERIC(22, 6), 
     ADJUSTMENT                 NUMERIC(22, 6), 
     DEDUCTION_SET_1            VARCHAR(150), 
     DEDUCTION_SET_2            VARCHAR(150) ,
     MASTER_SID       INT,
     LEVEL_NO        INT,
     ITEM_NO  BIT,
     RANK_VIEW INT
  ) 

INSERT INTO #ARM_DEMAND_ADJ_SUMMARY 
            (ARM_ADJUSTMENT_DETAILS_SID, 
             PERIOD, 
               PERIOD_SID,
             ITEM_ID, 
             ITEM_NAME, 
             BRAND_ID, 
             BRAND_NAME, 
             COMPANY_ID, 
             COMPANY_NAME, 
             CONTRACT_ID, 
             [CONTRACT_NAME], 
             RS_CATEGORY, 
             RS_TYPE, 
             REBATE_PROGRAM_TYPE, 
             RS_ID, 
             RS_NAME, 
             UDC1, 
             UDC2, 
             UDC3, 
             UDC4, 
             UDC5, 
             UDC6, 
             DEMAND_ACCRUAL, 
             DEMAND_ACCRUAL_REFORECAST, 
             TOTAL_DEMAND_ACCRUAL, 
             PROJ_TOTAL_DEMAND_ACCRUAL, 
             DEMAND_ACCRUAL_RATIO, 
             VARIANCE, 
             [OVERRIDE], 
             ADJUSTMENT, 
             DEDUCTION_SET_1, 
                     DEDUCTION_SET_2,
                     MASTER_SID,
                     LEVEL_NO,
                     ITEM_NO,
                     RANK_VIEW ) 
SELECT B.ARM_ADJUSTMENT_DETAILS_SID, 
       B.PERIODS,
        B.PERIOD_SID, 
       IM.ITEM_ID, 
       IM.ITEM_NAME, 
       BM.BRAND_ID, 
       BM.BRAND_NAME, 
       CM.COMPANY_ID, 
       CM.COMPANY_NAME, 
       CON.CONTRACT_ID, 
       CON.[CONTRACT_NAME], 
       RS_CAT.DESCRIPTION               AS RS_CATEGORY, 
       RS_TYP.DESCRIPTION               AS RS_TYPE, 
       REB_PRGM.DESCRIPTION             AS REBATE_PROGRAM_TYPE, 
       R.RS_ID, 
       R.RS_NAME, 
       U1.DESCRIPTION                   AS UDC1, 
       U2.DESCRIPTION                   AS UDC2, 
       U3.DESCRIPTION                   AS UDC3, 
       U4.DESCRIPTION                   AS UDC4, 
       U5.DESCRIPTION                   AS UDC5, 
       U6.DESCRIPTION                   AS UDC6, 
       A.DEMAND_ACCRUAL, 
       A.DEMAND_ACCRUAL_REFORECAST, 
       A.TOTAL_DEMAND_ACCRUAL, 
       A.PROJ_TOTAL_DEMAND_ACCRUAL, 
       A.DEMAND_ACCRUAL_RATIO, 
       A.VARIANCE , 
       A.[OVERRIDE], 
       ISNULL(A.[OVERRIDE], A.VARIANCE)  AS ADJUSTMENT, 
       DEDUCTION_SET_1 =  CASE
	WHEN @VIEW = 'CUSTOMER'
	AND @BASE_VIEW = 'CUSTOMER_DEDUCTION' THEN CM.COMPANY_ID + ' - ' + CM.COMPANY_NAME
	WHEN @BASE_VIEW <> 'CUSTOMER_DEDUCTION' THEN CASE
		WHEN @DEDUCTION_LEVEL = 'DEDUCTION PROGRAM' THEN REB_PRGM.DESCRIPTION
		WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY' THEN RS_CAT.DESCRIPTION
		WHEN @DEDUCTION_LEVEL = 'DEDUCTION TYPE' THEN RS_TYP.DESCRIPTION
		WHEN @DEDUCTION_LEVEL = 'DEDUCTION' THEN R.RS_ID
		WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 2' THEN U2.DESCRIPTION
		WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 3' THEN U3.DESCRIPTION
		WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 4' THEN U4.DESCRIPTION
		WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 5' THEN U5.DESCRIPTION
		WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 6' THEN U6.DESCRIPTION
	END
END,
       DEDUCTION_SET_2 = CASE 
                           WHEN @VIEW = 'PRODUCT' THEN IM.ITEM_ID+' - '+IM.ITEM_NAME
                           WHEN @VIEW = 'BRAND' THEN BM.BRAND_ID+' - '+BM.BRAND_NAME
                           WHEN @VIEW = 'CUSTOMER' THEN CM.COMPANY_ID+' - '+CM.COMPANY_NAME
                           WHEN @VIEW = 'CONTRACT' THEN CON.CONTRACT_ID+' - '+CON.[CONTRACT_NAME]
                           WHEN @VIEW = 'DEDUCTION PROGRAM' THEN REB_PRGM.DESCRIPTION
                           WHEN @VIEW = 'DEDUCTION CATEGORY' THEN RS_CAT.DESCRIPTION
                           WHEN @VIEW = 'DEDUCTION TYPE' THEN RS_TYP.DESCRIPTION
                           WHEN @VIEW = 'DEDUCTION' THEN R.RS_ID+ ' - '+R.RS_NAME
                           WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN U2.DESCRIPTION
                           WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN U3.DESCRIPTION
                           WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN U4.DESCRIPTION
                           WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN U5.DESCRIPTION
                           WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN U6.DESCRIPTION
                                 END ,
                MASTER_SID= CASE
                              WHEN @VIEW='PRODUCT' THEN IM.ITEM_MASTER_SID
                               WHEN @VIEW='BRAND' THEN BM.BRAND_MASTER_SID
                                               WHEN @VIEW='CUSTOMER' THEN  CM.COMPANY_MASTER_SID
                                               WHEN @VIEW='CONTRACT' THEN CON.CONTRACT_MASTER_SID
                                               WHEN @VIEW = 'DEDUCTION CATEGORY' THEN R.RS_CATEGORY 
                                               WHEN @VIEW = 'DEDUCTION TYPE' THEN R.RS_TYPE
                                               WHEN @VIEW = 'DEDUCTION' THEN R.RS_MODEL_SID
                                               WHEN @VIEW = 'DEDUCTION PROGRAM' THEN R.REBATE_PROGRAM_TYPE 
                                               WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN U.UDC2
                                               WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN U.UDC3
                                               WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN U.UDC4
                                               WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN U.UDC5
                                               WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN U.UDC6
                                               END,
        @LEVEL_NO,
        @ITEM_NO,
        RANK_VIEW = DENSE_RANK() OVER(
                        ORDER BY
                CASE
		WHEN @VIEW = 'PRODUCT' THEN IM.ITEM_MASTER_SID
		WHEN @VIEW = 'BRAND' THEN BM.BRAND_MASTER_SID
		WHEN @VIEW = 'CUSTOMER' THEN CM.COMPANY_MASTER_SID
		WHEN @VIEW = 'CONTRACT' THEN CON.CONTRACT_MASTER_SID
		WHEN @VIEW = 'DEDUCTION' THEN R.RS_MODEL_SID
                WHEN @VIEW = 'DEDUCTION CATEGORY' THEN R.RS_CATEGORY
		WHEN @VIEW = 'DEDUCTION TYPE' THEN R.RS_TYPE
		WHEN @VIEW = 'DEDUCTION PROGRAM' THEN R.REBATE_PROGRAM_TYPE
		WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN U.UDC2
		WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN U.UDC3
		WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN U.UDC4
		WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN U.UDC5
		WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN U.UDC6
	END  ) 
                  
        FROM   #CURR_PROJ_PERIOD B 
       LEFT JOIN ARM_DEMAND_ADJ_SUMMARY A 
              ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID 
              AND A.PERIOD_SID=B.PERIOD_SID
       JOIN ITEM_MASTER IM 
         ON IM.ITEM_MASTER_SID = B.ITEM_MASTER_SID 
       JOIN BRAND_MASTER BM 
         ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
       JOIN RS_CONTRACT R 
         ON R.RS_MODEL_SID = B.RS_MODEL_SID 
            AND R.CONTRACT_MASTER_SID = B.CONTRACT_MASTER_SID 
        JOIN ARM_DEDUCTION_SELECTION ADS
            ON ADS.RS_CONTRACT_SID=R.RS_CONTRACT_SID AND ADS.PROJECTION_MASTER_SID=@PROJECTION
       JOIN COMPANY_MASTER CM 
         ON CM.COMPANY_MASTER_SID = B.COMPANY_MASTER_SID 
       LEFT JOIN UDCS U 
         ON U.MASTER_SID = R.RS_CONTRACT_SID 
            AND U.MASTER_TYPE = 'RS_CONTRACT' 
       LEFT JOIN @TEMP_HELPER RS_CAT 
              ON RS_CAT.HELPER_TABLE_SID = R.RS_CATEGORY 
       LEFT JOIN @TEMP_HELPER RS_TYP 
              ON RS_TYP.HELPER_TABLE_SID = R.RS_TYPE 
       LEFT JOIN @TEMP_HELPER REB_PRGM
              ON REB_PRGM.HELPER_TABLE_SID = R.REBATE_PROGRAM_TYPE 
       LEFT JOIN @TEMP_HELPER U1 
              ON U1.HELPER_TABLE_SID = U.UDC1 
       LEFT JOIN @TEMP_HELPER U2 
              ON U2.HELPER_TABLE_SID = U.UDC2 
       LEFT JOIN @TEMP_HELPER U3 
              ON U3.HELPER_TABLE_SID = U.UDC3 
       LEFT JOIN @TEMP_HELPER U4 
              ON U4.HELPER_TABLE_SID = U.UDC4 
       LEFT JOIN @TEMP_HELPER U5 
              ON U5.HELPER_TABLE_SID = U.UDC5 
       LEFT JOIN @TEMP_HELPER U6 
              ON U6.HELPER_TABLE_SID = U.UDC6 
       JOIN CONTRACT_MASTER CON 
         ON CON.CONTRACT_MASTER_SID = B.CONTRACT_MASTER_SID 
            where  ? like '?'
	    and R.CONTRACT_MASTER_SID Like '?'
	    and CM.COMPANY_MASTER_SID like '?'
            and IM.BRAND_MASTER_SID like '?'
	    and IM.ITEM_MASTER_SID like '?'
    AND CASE
	WHEN @DEDUCTION_LEVEL = 'DEDUCTION PROGRAM' THEN REB_PRGM.DESCRIPTION
	WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY' THEN RS_CAT.DESCRIPTION
	WHEN @DEDUCTION_LEVEL = 'DEDUCTION TYPE' THEN RS_TYP.DESCRIPTION
	WHEN @DEDUCTION_LEVEL = 'DEDUCTION' THEN R.RS_ID
	WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 2' THEN U2.DESCRIPTION
	WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 3' THEN U3.DESCRIPTION
	WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 4' THEN U4.DESCRIPTION
	WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 5' THEN U5.DESCRIPTION
	WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 6' THEN U6.DESCRIPTION
    END IN (?)
                    ]]>  
        </query>

    </entity>
    <entity id="Summary_DA_generate_count">

        <query>
                    <![CDATA[
                     SELECT   COUNT (1) FROM (
                SELECT   DISTINCT DEDUCTION_SET_2
        FROM   #ARM_DEMAND_ADJ_SUMMARY     
        GROUP  BY DEDUCTION_SET_1, 
                  DEDUCTION_SET_2, 
                  LEVEL_NO,
                ITEM_NO,
                MASTER_SID
                 
        ) A 
                      ]]>  
        </query>

    </entity>
    <entity id="Summary_DA_generate_data">

        <query>
                    <![CDATA[
                         SELECT DEDUCTION_SET_1 $$$$VIEW_CONTROL$$$$, 
               DEDUCTION_SET_2, 
               ISNULL(SUM(DEMAND_ACCRUAL),0)    AS DEMAND_ACCRUAL, 
               ISNULL(SUM(DEMAND_ACCRUAL_REFORECAST ),0)    AS DEMAND_ACCRUAL_REFORECAST, 
               ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0) AS TOTAL_DEMAND_ACCRUAL, 
               ISNULL(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0) AS PROJ_TOTAL_DEMAND_ACCRUAL, 
               ISNULL(SUM(TOTAL_DEMAND_ACCRUAL)/NULLIF(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0),0)*100 AS DEMAND_ACCRUAL_RATIO,
               ISNULL(SUM(VARIANCE),0) AS VARIANCE,  
               SUM([OVERRIDE]) AS [OVERRIDE], 
               ISNULL(SUM(ISNULL([OVERRIDE], (VARIANCE))),0) AS ADJUSTMENT ,
               LEVEL_NO,
                ITEM_NO,
                MASTER_SID,
              PERIOD_COLUMN = CASE 
	WHEN @RATE_FREQUENCY = 'Monthly' THEN PERIOD_SID
	WHEN @RATE_FREQUENCY <> 'Monthly' THEN PERIOD
                END
        FROM   #ARM_DEMAND_ADJ_SUMMARY 
        $$$$PAGE_CONTROL$$$$        
        GROUP  BY DEDUCTION_SET_1, 
                  DEDUCTION_SET_2, 
                  LEVEL_NO,
                ITEM_NO,
                MASTER_SID,
                CASE
	WHEN @RATE_FREQUENCY = 'Monthly' THEN PERIOD_SID
	WHEN @RATE_FREQUENCY <> 'Monthly' THEN PERIOD
                 END           
                      ]]>  
        </query>

    </entity>
    <entity id="Summary_DA_generate_data_orderby">
        
        <query>
            <![CDATA[
    ORDER BY
             DEDUCTION_SET_2,
          CASE
	WHEN @RATE_FREQUENCY = 'Monthly' THEN PERIOD_SID
	WHEN @RATE_FREQUENCY <> 'Monthly' THEN PERIOD
                  END
              ]]>  
        </query>

    </entity>
    <entity id="Update_Summary_Demand_Override">
        
        <query>
            <![CDATA[
             DECLARE @PROJECTION_MASTER_SID INT = ?, 
                    @CONTRACT_MASTER_SID      INT = ?, 
                    @COMPANY_MASTER_SID       INT = ?, 
                    @BRAND_MASTER_SID         INT = ?, 
                    @RS_MODEL_SID             INT = ?,
                    @ITEM_MASTER_SID          INT = ?, 
                    @OVERRIDE_VALUE           INT = ? 
                    ,@FREQUENCY varchar(100) = '?'
                    ,@FREQUENCY_PERIOD varchar(100) = '?'
            
                    IF OBJECT_ID('TEMPDB.DBO.#PERIOD', 'U') IS NOT NULL
                      DROP TABLE #PERIOD;
                    WITH CTE
                    AS (SELECT
                      PERIOD_SID,
                      PERIOD_DATE,
                      PERIOD_MONTH = MONTH,
                      PERIOD_QUARTER = QUARTER,
                      PERIOD_SEMI = SEMI_ANNUAL,
                      PERIOD_YEAR = YEAR,
                      PERIOD =
                              CASE
                                WHEN @FREQUENCY = 'M' THEN convert(varchar(100),PERIOD_SID)
                                WHEN @FREQUENCY = 'Q' THEN CONCAT('Q', QUARTER, ' ', YEAR)
                                WHEN @FREQUENCY = 'S' THEN CONCAT('S', SEMI_ANNUAL, ' ', YEAR)
                                ELSE CAST(YEAR AS char(4))
                              END

                    FROM PERIOD)
                    SELECT
                      * INTO #PERIOD
                    FROM CTE
                    WHERE PERIOD = @FREQUENCY_PERIOD

                    UPDATE RATE
                    SET RATE.TEMP_OVERRIDE = @OVERRIDE_VALUE
                    FROM ? RATE
                    JOIN (SELECT
                      RATE.ARM_ADJUSTMENT_DETAILS_SID,
                      COALESCE(abs(PROJ_TOTAL_DEMAND_ACCRUAL) /
                      NULLIF(SUM(abs(PROJ_TOTAL_DEMAND_ACCRUAL))
                      OVER (
                      PARTITION BY CCP.ITEM_MASTER_SID,CCP.COMPANY_MASTER_SID,CCP.CONTRACT_MASTER_SID, AD.RS_MODEL_SID , PERIOD), 0), 0) AS RATIO,P.PERIOD_SID
                    FROM ? RATE
                    JOIN DBO.ARM_ADJUSTMENT_DETAILS AD
                      ON AD.ARM_ADJUSTMENT_DETAILS_SID =
                      RATE.ARM_ADJUSTMENT_DETAILS_SID
                    JOIN DBO.CCP_DETAILS CCP
                      ON CCP.CCP_DETAILS_SID = AD.CCP_DETAILS_SID
                    JOIN DBO.ITEM_MASTER IM
                      ON IM.ITEM_MASTER_SID = CCP.ITEM_MASTER_SID
                    INNER JOIN #PERIOD P
                      ON P.PERIOD_SID = RATE.PERIOD_SID
                     WHERE AD.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
                    AND CCP.COMPANY_MASTER_SID = @COMPANY_MASTER_SID
                    AND CCP.CONTRACT_MASTER_SID = @CONTRACT_MASTER_SID
                    AND IM.BRAND_MASTER_SID = @BRAND_MASTER_SID
                    AND CCP.ITEM_MASTER_SID = @ITEM_MASTER_SID
                    AND  AD.RS_MODEL_SID  = @RS_MODEL_SID) A
                      ON RATE.ARM_ADJUSTMENT_DETAILS_SID = A.ARM_ADJUSTMENT_DETAILS_SID
                       AND RATE.PERIOD_SID=A.PERIOD_SID
                   ]]>  
        </query>
    </entity>
    
    <entity id="Total_Level_Summary_Demand_Accrual">
        <query>
            <![CDATA[
                            select  DEDUCTION_SET_1,
                'TOTAL' as DEDUCTION_SET_2,
                sum(DEMAND_ACCRUAL) as DEMAND_ACCRUAL,
                sum(DEMAND_ACCRUAL_REFORECAST) as DEMAND_ACCRUAL_REFORECAST,
                sum(TOTAL_DEMAND_ACCRUAL) as TOTAL_DEMAND_ACCRUAL,
                sum(PROJ_TOTAL_DEMAND_ACCRUAL) as PROJ_TOTAL_DEMAND_ACCRUAL,
                ISNULL(sum(TOTAL_DEMAND_ACCRUAL)/nullif(sum(PROJ_TOTAL_DEMAND_ACCRUAL),0),0)*100 as DEMAND_ACCRUAL_RATIO,
                sum(VARIANCE) as VARIANCE,
                sum([OVERRIDE]) as [OVERRIDE],
                sum(ADJUSTMENT) as ADJUSTMENT,
                0 as LEVEL_NO,
                ITEM_NO = 0 ,
                0 as MASTER_SID,
                PERIOD_COLUMN as PERIOD_COLUMN
                from($$$$CHILD_QUERY$$$$) a group by DEDUCTION_SET_1,PERIOD_COLUMN               
                                     ]]>  
        </query>
    </entity>
    <entity id="TRANSACTION_2_Wf_Save_Query">
        <query>
            <![CDATA[
                        DELETE
                            ADAS
                        FROM
                            ARM_DEMAND_ADJ_SUMMARY ADAS
                        JOIN ARM_ADJUSTMENT_DETAILS AAD ON
                            AAD.ARM_ADJUSTMENT_DETAILS_SID = ADAS.ARM_ADJUSTMENT_DETAILS_SID
                        WHERE
                            AAD.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID;

                        INSERT
                            INTO
                                ARM_DEMAND_ADJ_SUMMARY(
                                    ARM_ADJUSTMENT_DETAILS_SID,
                                    PERIOD_SID,
                                    DEMAND_ACCRUAL,
                                    DEMAND_ACCRUAL_REFORECAST,
                                    TOTAL_DEMAND_ACCRUAL,
                                    PROJ_TOTAL_DEMAND_ACCRUAL,
                                    DEMAND_ACCRUAL_RATIO,
                                    VARIANCE,
                                    OVERRIDE,
                                    PROJECTED_RATE
                        )SELECT
                            ADAS.ARM_ADJUSTMENT_DETAILS_SID,
                            ADAS.PERIOD_SID,
                            ADAS.DEMAND_ACCRUAL,
                            ADAS.DEMAND_ACCRUAL_REFORECAST,
                            ADAS.TOTAL_DEMAND_ACCRUAL,
                            ADAS.PROJ_TOTAL_DEMAND_ACCRUAL,
                            ADAS.DEMAND_ACCRUAL_RATIO,
                            ADAS.VARIANCE,
                            ADAS.OVERRIDE,
                            ADAS.PROJECTED_RATE 
                        FROM
                            ST_ARM_DEMAND_ADJ_SUMMARY ADAS
                        JOIN ARM_ADJUSTMENT_DETAILS AAD ON
                            AAD.ARM_ADJUSTMENT_DETAILS_SID = ADAS.ARM_ADJUSTMENT_DETAILS_SID
                        WHERE
                            AAD.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID;

                        DELETE
                            ADAS
                        FROM
                            ST_ARM_DEMAND_ADJ_SUMMARY ADAS
                        JOIN ARM_ADJUSTMENT_DETAILS AAD ON
                            AAD.ARM_ADJUSTMENT_DETAILS_SID = ADAS.ARM_ADJUSTMENT_DETAILS_SID
                        WHERE
                            AAD.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID;
                                     ]]>  
        </query>
    </entity>
    <entity id="TRANSACTION~2_Wf_Edit_Query">
        <query>
            <![CDATA[
                INSERT
                    INTO
                        ST_ARM_DEMAND_ADJ_SUMMARY(
                            ARM_ADJUSTMENT_DETAILS_SID,
                            PERIOD_SID,
                            DEMAND_ACCRUAL,
                            DEMAND_ACCRUAL_REFORECAST,
                            TOTAL_DEMAND_ACCRUAL,
                            PROJ_TOTAL_DEMAND_ACCRUAL,
                            DEMAND_ACCRUAL_RATIO,
                            VARIANCE,
                            OVERRIDE,
                            PROJECTED_RATE
                        ) SELECT
                            ADAS.ARM_ADJUSTMENT_DETAILS_SID,
                            ADAS.PERIOD_SID,
                            ADAS.DEMAND_ACCRUAL,
                            ADAS.DEMAND_ACCRUAL_REFORECAST,
                            ADAS.TOTAL_DEMAND_ACCRUAL,
                            ADAS.PROJ_TOTAL_DEMAND_ACCRUAL,
                            ADAS.DEMAND_ACCRUAL_RATIO,
                            ADAS.VARIANCE,
                            ADAS.OVERRIDE,
                            ADAS.PROJECTED_RATE
                        FROM
                            ARM_DEMAND_ADJ_SUMMARY ADAS
                        JOIN ARM_ADJUSTMENT_DETAILS AAD ON
                            AAD.ARM_ADJUSTMENT_DETAILS_SID = ADAS.ARM_ADJUSTMENT_DETAILS_SID
                        WHERE
                            AAD.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID;
                                     ]]>  
        </query>
    </entity>
             
    <entity id="Summary_DA_generateEdit">
        <query>
                    <![CDATA[
                                DECLARE @PROJECTION      INT = ?,   
                               @DEDUCTION_LEVEL VARCHAR(50) = '?',
                               @MULTIPLE_PERIOD BIT = ?,
                               @VIEW            VARCHAR(50) = '?',
                               @BASE_VIEW VARCHAR(50) = '?',
                               @FROM_PERIOD     VARCHAR(50) = '?', 
                               @TO_PERIOD       VARCHAR(50) = '?', 
                               @STRING          CHAR(1), 
                               @RATE_FREQUENCY  VARCHAR(20) ='?', 
                               @FROM_PERIOD_SID INT, 
                               @TO_PERIOD_SID   INT,
                               @LEVEL_NO INT,
                               @ITEM_NO BIT select
                               @LEVEL_NO = CASE
                               WHEN @MULTIPLE_PERIOD = '0' THEN CASE
                                WHEN @BASE_VIEW = 'DEDUCTION_CUSTOMER_CONTRACT' THEN CASE
                                        WHEN @VIEW = 'PRODUCT' THEN 5
                                        WHEN @VIEW = 'BRAND' THEN 4
                                        WHEN @VIEW = 'CONTRACT' THEN 3
                                        WHEN @VIEW = 'CUSTOMER' THEN 2
                                        WHEN @VIEW = 'DEDUCTION' THEN 1
                                        WHEN @VIEW = 'DEDUCTION CATEGORY' THEN 1
                                        WHEN @VIEW = 'DEDUCTION TYPE' THEN 1
                                        WHEN @VIEW = 'DEDUCTION PROGRAM' THEN 1
                                        WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN 1
                                        WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN 1
                                        WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN 1
                                        WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN 1
                                        WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN 1
                                END
                                WHEN @BASE_VIEW <> 'DEDUCTION_CUSTOMER_CONTRACT' THEN CASE
                                        WHEN @VIEW = 'PRODUCT' THEN 5
                                        WHEN @VIEW = 'BRAND' THEN 4
                                        WHEN @VIEW = 'CUSTOMER' THEN 3
                                        WHEN @VIEW = 'CONTRACT' THEN 2
                                        WHEN @VIEW = 'DEDUCTION' THEN 1
                                        WHEN @VIEW = 'DEDUCTION CATEGORY' THEN 1
                                        WHEN @VIEW = 'DEDUCTION TYPE' THEN 1
                                        WHEN @VIEW = 'DEDUCTION PROGRAM' THEN 1
                                        WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN 1
                                        WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN 1
                                        WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN 1
                                        WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN 1
                                        WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN 1
                                END
                                END
                            WHEN @MULTIPLE_PERIOD = '1' THEN CASE
                                    WHEN @BASE_VIEW = 'DEDUCTION_PRODUCT' THEN CASE
                                            WHEN @VIEW = 'PRODUCT' THEN 3
                                            WHEN @VIEW = 'BRAND' THEN 2
                                            WHEN @VIEW = 'DEDUCTION' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY' THEN 1
                                            WHEN @VIEW = 'DEDUCTION TYPE' THEN 1
                                            WHEN @VIEW = 'DEDUCTION PROGRAM' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN 1
                                    END
                                    WHEN @BASE_VIEW = 'DEDUCTION_CUSTOMER' THEN CASE
                                            WHEN @VIEW = 'PRODUCT' THEN 4
                                            WHEN @VIEW = 'BRAND' THEN 3
                                            WHEN @VIEW = 'CUSTOMER' THEN 2
                                            WHEN @VIEW = 'DEDUCTION' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY' THEN 1
                                            WHEN @VIEW = 'DEDUCTION TYPE' THEN 1
                                            WHEN @VIEW = 'DEDUCTION PROGRAM' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN 1
                                    END
                                    WHEN @BASE_VIEW = 'CUSTOMER_DEDUCTION' THEN CASE
                                            WHEN @VIEW = 'PRODUCT' THEN 4
                                            WHEN @VIEW = 'BRAND' THEN 3
                                            WHEN @VIEW = 'DEDUCTION' THEN 2
                                            WHEN @VIEW = 'DEDUCTION CATEGORY' THEN 2
                                            WHEN @VIEW = 'DEDUCTION TYPE' THEN 2
                                            WHEN @VIEW = 'DEDUCTION PROGRAM' THEN 2
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN 2
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN 2
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN 2
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN 2
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN 2
                                            WHEN @VIEW = 'CUSTOMER' THEN 1
                                    END
                                    WHEN @BASE_VIEW = 'DEDUCTION_CUSTOMER_CONTRACT' THEN CASE
                                            WHEN @VIEW = 'PRODUCT' THEN 5
                                            WHEN @VIEW = 'BRAND' THEN 4
                                            WHEN @VIEW = 'CONTRACT' THEN 3
                                            WHEN @VIEW = 'CUSTOMER' THEN 2
                                            WHEN @VIEW = 'DEDUCTION' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY' THEN 1
                                            WHEN @VIEW = 'DEDUCTION TYPE' THEN 1
                                            WHEN @VIEW = 'DEDUCTION PROGRAM' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN 1
                                            WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN 1
                                    END
                            END
                    END SELECT
                            @ITEM_NO = CASE
                                    WHEN @VIEW = 'PRODUCT' THEN 0
                                    WHEN @VIEW = 'BRAND' THEN 1
                                    WHEN @VIEW = 'CUSTOMER' THEN 1
                                    WHEN @VIEW = 'CONTRACT' THEN 1
                                    WHEN @VIEW = 'DEDUCTION' THEN 1
                                    WHEN @VIEW = 'DEDUCTION CATEGORY' THEN 1
                                    WHEN @VIEW = 'DEDUCTION TYPE' THEN 1
                                    WHEN @VIEW = 'DEDUCTION PROGRAM' THEN 1
                                    WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN 1
                                    WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN 1
                                    WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN 1
                                    WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN 1
                                    WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN 1
                            END

               SET @STRING=LEFT(@RATE_FREQUENCY, 1) 

               IF OBJECT_ID('TEMPDB..#TEMP_PERIOD') IS NOT NULL 
                 DROP TABLE #TEMP_PERIOD 

               CREATE TABLE #TEMP_PERIOD 
                 ( 
                    PERIOD_SID  INT, 
                    PERIODS     VARCHAR(50), 
                    PERIOD_DATE DATETIME, 
                    MONTH       INT, 
                    YEAR        INT, 
                    PRIMARY KEY(PERIOD_SID) 
                 ) 

               INSERT INTO #TEMP_PERIOD 
                           (PERIOD_SID, 
                            PERIODS, 
                            PERIOD_DATE, 
                            MONTH, 
                            YEAR) 
               SELECT PERIOD_SID, 
                      PERIODS = CASE 
                                  WHEN @STRING = 'M' THEN CONCAT (LEFT(DATENAME(MM, PERIOD_DATE), 3), ' ', YEAR)
                                  WHEN @STRING = 'Q' THEN CONCAT ('Q', QUARTER, ' ', YEAR) 
                                  WHEN @STRING = 'S' THEN CONCAT ('S', SEMI_ANNUAL, ' ', YEAR) 
                                  ELSE CAST(YEAR AS CHAR(4)) 
                                END, 
                      PERIOD_DATE, 
                      MONTH, 
                      YEAR 
               FROM   PERIOD 

               SELECT @FROM_PERIOD_SID = MIN(PERIOD_SID) 
               FROM   #TEMP_PERIOD 
               WHERE  PERIODS = @FROM_PERIOD 

               SELECT @TO_PERIOD_SID = MAX(PERIOD_SID) 
               FROM   #TEMP_PERIOD 
               WHERE  PERIODS = @TO_PERIOD 

               IF OBJECT_ID('TEMPDB..#CURR_PROJ') IS NOT NULL 
                 DROP TABLE #CURR_PROJ 

               CREATE TABLE #CURR_PROJ 
                 ( 
                    ARM_ADJUSTMENT_DETAILS_SID INT, 
                    CCP_DETAILS_SID            INT, 
                    RS_MODEL_SID               INT, 
                    CONTRACT_MASTER_SID        INT, 
                    COMPANY_MASTER_SID         INT, 
                    ITEM_MASTER_SID            INT, 
                    PRIMARY KEY (ARM_ADJUSTMENT_DETAILS_SID) 
                 ) 

               INSERT INTO #CURR_PROJ 
                           (ARM_ADJUSTMENT_DETAILS_SID, 
                            COMPANY_MASTER_SID, 
                            CONTRACT_MASTER_SID, 
                            ITEM_MASTER_SID, 
                            CCP_DETAILS_SID, 
                            RS_MODEL_SID) 
               SELECT B.ARM_ADJUSTMENT_DETAILS_SID, 
                      C.COMPANY_MASTER_SID, 
                      C.CONTRACT_MASTER_SID, 
                      C.ITEM_MASTER_SID, 
                      B.CCP_DETAILS_SID, 
                      B.RS_MODEL_SID 
               FROM   ARM_ADJUSTMENT_DETAILS B 
                      JOIN CCP_DETAILS C 
                        ON B.CCP_DETAILS_SID = C.CCP_DETAILS_SID 
               WHERE  B.PROJECTION_MASTER_SID = @PROJECTION 

               IF OBJECT_ID('TEMPDB..#CURR_PROJ_PERIOD') IS NOT NULL 
                 DROP TABLE #CURR_PROJ_PERIOD 

               CREATE TABLE #CURR_PROJ_PERIOD 
                 ( 
                    ARM_ADJUSTMENT_DETAILS_SID INT, 
                    CCP_DETAILS_SID            INT, 
                    RS_MODEL_SID               INT, 
                    CONTRACT_MASTER_SID        INT, 
                    COMPANY_MASTER_SID         INT, 
                    ITEM_MASTER_SID            INT, 
                    PERIOD_SID                 INT, 
                        PERIODS                    VARCHAR(50),
                    PRIMARY KEY (ARM_ADJUSTMENT_DETAILS_SID,PERIOD_SID) 
                 ) 

               INSERT INTO #CURR_PROJ_PERIOD 
                           (ARM_ADJUSTMENT_DETAILS_SID, 
                            COMPANY_MASTER_SID, 
                            CONTRACT_MASTER_SID, 
                            ITEM_MASTER_SID, 
                            CCP_DETAILS_SID, 
                            RS_MODEL_SID,
                                        PERIOD_SID,
                                        PERIODS) 
               SELECT A.ARM_ADJUSTMENT_DETAILS_SID, 
                      A.COMPANY_MASTER_SID, 
                      A.CONTRACT_MASTER_SID, 
                      A.ITEM_MASTER_SID, 
                      A.CCP_DETAILS_SID, 
                      A.RS_MODEL_SID, 
                      P.PERIOD_SID,
                          P.PERIODS 
               FROM   #CURR_PROJ A 
                      CROSS JOIN #TEMP_PERIOD P 
               WHERE  P.PERIOD_SID BETWEEN @FROM_PERIOD_SID AND @TO_PERIOD_SID 

               DECLARE @TEMP_HELPER AS TABLE 
                 ( 
                    HELPER_TABLE_SID INT, 
                    DESCRIPTION      VARCHAR(100), 
                    LIST_NAME        VARCHAR(100), 
                    PRIMARY KEY (HELPER_TABLE_SID) 
                 ) 

               INSERT INTO @TEMP_HELPER 
                           (HELPER_TABLE_SID, 
                            DESCRIPTION, 
                            LIST_NAME) 
               SELECT HELPER_TABLE_SID, 
                      DESCRIPTION, 
                      LIST_NAME 
               FROM   HELPER_TABLE 
               WHERE  LIST_NAME IN ( 'RS_UDC1', 'RS_UDC2', 'RS_UDC3', 'RS_UDC4', 
                                     'RS_UDC5', 'RS_UDC6', 'RS_TYPE', 'RS_CATEGORY', 'REBATE_PROGRAM_TYPE' )

               IF OBJECT_ID('TEMPDB..#ARM_DEMAND_ADJ_SUMMARY') IS NOT NULL 
                 DROP TABLE #ARM_DEMAND_ADJ_SUMMARY 

               CREATE TABLE #ARM_DEMAND_ADJ_SUMMARY 
                 ( 
                    ARM_ADJUSTMENT_DETAILS_SID INT, 
                    PERIOD                     VARCHAR(50), 
                    PERIOD_SID                 VARCHAR(10),
                    ITEM_ID                    VARCHAR(50), 
                    ITEM_NAME                  VARCHAR(100), 
                    BRAND_ID                   VARCHAR(50), 
                    BRAND_NAME                 VARCHAR(100), 
                    COMPANY_ID                 VARCHAR(50), 
                    COMPANY_NAME               VARCHAR(100), 
                    CONTRACT_ID                VARCHAR(50), 
                    [CONTRACT_NAME]            VARCHAR(100), 
                    RS_CATEGORY                VARCHAR(50), 
                    RS_TYPE                    VARCHAR(50), 
                    REBATE_PROGRAM_TYPE        VARCHAR(50), 
                    RS_ID                      VARCHAR(50), 
                    RS_NAME                    VARCHAR(100), 
                    UDC1                       VARCHAR(50), 
                    UDC2                       VARCHAR(50), 
                    UDC3                       VARCHAR(50), 
                    UDC4                       VARCHAR(50), 
                    UDC5                       VARCHAR(50), 
                    UDC6                       VARCHAR(50), 
                    DEMAND_ACCRUAL             NUMERIC(22, 6), 
                    DEMAND_ACCRUAL_REFORECAST  NUMERIC(22, 6), 
                    TOTAL_DEMAND_ACCRUAL       NUMERIC(22, 6), 
                    PROJ_TOTAL_DEMAND_ACCRUAL  NUMERIC(22, 6), 
                    DEMAND_ACCRUAL_RATIO       NUMERIC(22, 6), 
                    VARIANCE                   NUMERIC(22, 6), 
                    [OVERRIDE]                 NUMERIC(22, 6), 
                    ADJUSTMENT                 NUMERIC(22, 6), 
                    DEDUCTION_SET_1            VARCHAR(150), 
                    DEDUCTION_SET_2            VARCHAR(150) ,
                    MASTER_SID       INT,
                    LEVEL_NO        INT,
                    ITEM_NO  BIT,
                    RANK_VIEW INT
                 ) 

               INSERT INTO #ARM_DEMAND_ADJ_SUMMARY 
                           (ARM_ADJUSTMENT_DETAILS_SID, 
                            PERIOD, 
                              PERIOD_SID,
                            ITEM_ID, 
                            ITEM_NAME, 
                            BRAND_ID, 
                            BRAND_NAME, 
                            COMPANY_ID, 
                            COMPANY_NAME, 
                            CONTRACT_ID, 
                            [CONTRACT_NAME], 
                            RS_CATEGORY, 
                            RS_TYPE, 
                            REBATE_PROGRAM_TYPE, 
                            RS_ID, 
                            RS_NAME, 
                            UDC1, 
                            UDC2, 
                            UDC3, 
                            UDC4, 
                            UDC5, 
                            UDC6, 
                            DEMAND_ACCRUAL, 
                            DEMAND_ACCRUAL_REFORECAST, 
                            TOTAL_DEMAND_ACCRUAL, 
                            PROJ_TOTAL_DEMAND_ACCRUAL, 
                            DEMAND_ACCRUAL_RATIO, 
                            VARIANCE, 
                            [OVERRIDE], 
                            ADJUSTMENT, 
                            DEDUCTION_SET_1, 
                                    DEDUCTION_SET_2,
                                    MASTER_SID,
                                    LEVEL_NO,
                                    ITEM_NO,
                                    RANK_VIEW ) 
               SELECT B.ARM_ADJUSTMENT_DETAILS_SID, 
                      B.PERIODS,
                       B.PERIOD_SID, 
                      IM.ITEM_ID, 
                      IM.ITEM_NAME, 
                      BM.BRAND_ID, 
                      BM.BRAND_NAME, 
                      CM.COMPANY_ID, 
                      CM.COMPANY_NAME, 
                      CON.CONTRACT_ID, 
                      CON.[CONTRACT_NAME], 
                      RS_CAT.DESCRIPTION               AS RS_CATEGORY, 
                      RS_TYP.DESCRIPTION               AS RS_TYPE, 
                      REB_PRGM.DESCRIPTION             AS REBATE_PROGRAM_TYPE, 
                      R.RS_ID, 
                      R.RS_NAME, 
                      U1.DESCRIPTION                   AS UDC1, 
                      U2.DESCRIPTION                   AS UDC2, 
                      U3.DESCRIPTION                   AS UDC3, 
                      U4.DESCRIPTION                   AS UDC4, 
                      U5.DESCRIPTION                   AS UDC5, 
                      U6.DESCRIPTION                   AS UDC6, 
                      A.DEMAND_ACCRUAL, 
                      A.DEMAND_ACCRUAL_REFORECAST, 
                      A.TOTAL_DEMAND_ACCRUAL, 
                      A.PROJ_TOTAL_DEMAND_ACCRUAL, 
                      A.DEMAND_ACCRUAL_RATIO, 
                      A.VARIANCE , 
                      A.[OVERRIDE], 
                      ISNULL(A.[OVERRIDE], A.VARIANCE)  AS ADJUSTMENT, 
                      DEDUCTION_SET_1 =  CASE
                       WHEN @VIEW = 'CUSTOMER'
                       AND @BASE_VIEW = 'CUSTOMER_DEDUCTION' THEN CM.COMPANY_ID + ' - ' + CM.COMPANY_NAME
                       WHEN @BASE_VIEW <> 'CUSTOMER_DEDUCTION' THEN CASE
                               WHEN @DEDUCTION_LEVEL = 'DEDUCTION PROGRAM' THEN REB_PRGM.DESCRIPTION
                               WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY' THEN RS_CAT.DESCRIPTION
                               WHEN @DEDUCTION_LEVEL = 'DEDUCTION TYPE' THEN RS_TYP.DESCRIPTION
                               WHEN @DEDUCTION_LEVEL = 'DEDUCTION' THEN R.RS_ID
                               WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 2' THEN U2.DESCRIPTION
                               WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 3' THEN U3.DESCRIPTION
                               WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 4' THEN U4.DESCRIPTION
                               WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 5' THEN U5.DESCRIPTION
                               WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 6' THEN U6.DESCRIPTION
                       END
               END,
                      DEDUCTION_SET_2 = CASE 
                                          WHEN @VIEW = 'PRODUCT' THEN IM.ITEM_ID+' - '+IM.ITEM_NAME
                                          WHEN @VIEW = 'BRAND' THEN BM.BRAND_ID+' - '+BM.BRAND_NAME
                                          WHEN @VIEW = 'CUSTOMER' THEN CM.COMPANY_ID+' - '+CM.COMPANY_NAME
                                          WHEN @VIEW = 'CONTRACT' THEN CON.CONTRACT_ID+' - '+CON.[CONTRACT_NAME]
                                          WHEN @VIEW = 'DEDUCTION PROGRAM' THEN REB_PRGM.DESCRIPTION
                                          WHEN @VIEW = 'DEDUCTION CATEGORY' THEN RS_CAT.DESCRIPTION
                                          WHEN @VIEW = 'DEDUCTION TYPE' THEN RS_TYP.DESCRIPTION
                                          WHEN @VIEW = 'DEDUCTION' THEN R.RS_ID+ ' - '+R.RS_NAME
                                          WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN U2.DESCRIPTION
                                          WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN U3.DESCRIPTION
                                          WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN U4.DESCRIPTION
                                          WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN U5.DESCRIPTION
                                          WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN U6.DESCRIPTION
                                                END ,
                               MASTER_SID= CASE
                                             WHEN @VIEW='PRODUCT' THEN IM.ITEM_MASTER_SID
                                              WHEN @VIEW='BRAND' THEN BM.BRAND_MASTER_SID
                                                              WHEN @VIEW='CUSTOMER' THEN  CM.COMPANY_MASTER_SID
                                                              WHEN @VIEW='CONTRACT' THEN CON.CONTRACT_MASTER_SID
                                                              WHEN @VIEW = 'DEDUCTION CATEGORY' THEN R.RS_CATEGORY 
                                                              WHEN @VIEW = 'DEDUCTION TYPE' THEN R.RS_TYPE
                                                              WHEN @VIEW = 'DEDUCTION' THEN R.RS_MODEL_SID
                                                              WHEN @VIEW = 'DEDUCTION PROGRAM' THEN R.REBATE_PROGRAM_TYPE 
                                                              WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN U.UDC2
                                                              WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN U.UDC3
                                                              WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN U.UDC4
                                                              WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN U.UDC5
                                                              WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN U.UDC6
                                                              END,
                       @LEVEL_NO,
                       @ITEM_NO,
                       RANK_VIEW = DENSE_RANK() OVER(
                                       ORDER BY
                               CASE
                               WHEN @VIEW = 'PRODUCT' THEN IM.ITEM_MASTER_SID
                               WHEN @VIEW = 'BRAND' THEN BM.BRAND_MASTER_SID
                               WHEN @VIEW = 'CUSTOMER' THEN CM.COMPANY_MASTER_SID
                               WHEN @VIEW = 'CONTRACT' THEN CON.CONTRACT_MASTER_SID
                               WHEN @VIEW = 'DEDUCTION' THEN R.RS_MODEL_SID
                               WHEN @VIEW = 'DEDUCTION CATEGORY' THEN R.RS_CATEGORY
                               WHEN @VIEW = 'DEDUCTION TYPE' THEN R.RS_TYPE
                               WHEN @VIEW = 'DEDUCTION PROGRAM' THEN R.REBATE_PROGRAM_TYPE
                               WHEN @VIEW = 'DEDUCTION CATEGORY 2' THEN U.UDC2
                               WHEN @VIEW = 'DEDUCTION CATEGORY 3' THEN U.UDC3
                               WHEN @VIEW = 'DEDUCTION CATEGORY 4' THEN U.UDC4
                               WHEN @VIEW = 'DEDUCTION CATEGORY 5' THEN U.UDC5
                               WHEN @VIEW = 'DEDUCTION CATEGORY 6' THEN U.UDC6
                       END  ) 

                       FROM   #CURR_PROJ_PERIOD B 
                      LEFT JOIN $$$$TABLE_NAME$$$$ A
                             ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID 
                             AND A.PERIOD_SID=B.PERIOD_SID
                      JOIN ITEM_MASTER IM 
                        ON IM.ITEM_MASTER_SID = B.ITEM_MASTER_SID 
                      JOIN BRAND_MASTER BM 
                        ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
                      JOIN RS_CONTRACT R 
                        ON R.RS_MODEL_SID = B.RS_MODEL_SID 
                           AND R.CONTRACT_MASTER_SID = B.CONTRACT_MASTER_SID 
                      JOIN ARM_DEDUCTION_SELECTION ADS
                            ON ADS.RS_CONTRACT_SID=R.RS_CONTRACT_SID AND ADS.PROJECTION_MASTER_SID=@PROJECTION
                      JOIN COMPANY_MASTER CM 
                        ON CM.COMPANY_MASTER_SID = B.COMPANY_MASTER_SID 
                      LEFT JOIN UDCS U 
                        ON U.MASTER_SID = R.RS_CONTRACT_SID 
                           AND U.MASTER_TYPE = 'RS_CONTRACT' 
                      LEFT JOIN @TEMP_HELPER RS_CAT 
                             ON RS_CAT.HELPER_TABLE_SID = R.RS_CATEGORY 
                      LEFT JOIN @TEMP_HELPER RS_TYP 
                             ON RS_TYP.HELPER_TABLE_SID = R.RS_TYPE 
                      LEFT JOIN @TEMP_HELPER REB_PRGM
                             ON REB_PRGM.HELPER_TABLE_SID = R.REBATE_PROGRAM_TYPE 
                      LEFT JOIN @TEMP_HELPER U1 
                             ON U1.HELPER_TABLE_SID = U.UDC1 
                      LEFT JOIN @TEMP_HELPER U2 
                             ON U2.HELPER_TABLE_SID = U.UDC2 
                      LEFT JOIN @TEMP_HELPER U3 
                             ON U3.HELPER_TABLE_SID = U.UDC3 
                      LEFT JOIN @TEMP_HELPER U4 
                             ON U4.HELPER_TABLE_SID = U.UDC4 
                      LEFT JOIN @TEMP_HELPER U5 
                             ON U5.HELPER_TABLE_SID = U.UDC5 
                      LEFT JOIN @TEMP_HELPER U6 
                             ON U6.HELPER_TABLE_SID = U.UDC6 
                      JOIN CONTRACT_MASTER CON 
                        ON CON.CONTRACT_MASTER_SID = B.CONTRACT_MASTER_SID 
                           where  ? like '?'
                           and R.CONTRACT_MASTER_SID Like '?'
                           and CM.COMPANY_MASTER_SID like '?'
                           and IM.BRAND_MASTER_SID like '?'
                           and IM.ITEM_MASTER_SID like '?'
               AND CASE
                       WHEN @DEDUCTION_LEVEL = 'DEDUCTION PROGRAM' THEN REB_PRGM.DESCRIPTION
                       WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY' THEN RS_CAT.DESCRIPTION
                       WHEN @DEDUCTION_LEVEL = 'DEDUCTION TYPE' THEN RS_TYP.DESCRIPTION
                       WHEN @DEDUCTION_LEVEL = 'DEDUCTION' THEN R.RS_ID
                       WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 2' THEN U2.DESCRIPTION
                       WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 3' THEN U3.DESCRIPTION
                       WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 4' THEN U4.DESCRIPTION
                       WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 5' THEN U5.DESCRIPTION
                       WHEN @DEDUCTION_LEVEL = 'DEDUCTION CATEGORY 6' THEN U6.DESCRIPTION
               END IN (?)
            ]]>  
        </query>
    </entity> 
    <entity id="Excel_Muliple_Period_Demand_Accrual_Query">
        <query>
            <![CDATA[
                  DECLARE @LEVEL                VARCHAR(30)=@LEVEL_VAL, 
		@MAX_VAL               INT=0, 
        @I                     INT=1, 
        @SQL                   NVARCHAR(max)='', 
		@SQL_TEMP                   NVARCHAR(max)='', 
        @VAR                   VARCHAR(1000)='', 
		@VAR_ADD               VARCHAR(1000)='', 
		@VAR_TEST               VARCHAR(1000)='', 
        @SQL_GROUP             NVARCHAR(max), 
        @SQL_SELECT            NVARCHAR(max), 
        @SQL_UNION             NVARCHAR(4000), 
        @SQL_OUTER_SELECT      NVARCHAR(1000)='', 
        @SQL_COUNT             NVARCHAR(1000)='',
		@SQL_ADD_COUNT         NVARCHAR(1000)='',
		@SQL_SUM           NVARCHAR(1000)='', 
		@CONDITION             VARCHAR(50)='@DEDUCTIONLEVEL',
		@CONDITION_VALUE VARCHAR(1000)='@DEDUCTIONVALUE',
		@FREQUENCY VARCHAR(20)='@FREQUENCYSELECTED',
		@START VARCHAR(20)='@STARTPERIOD',
		@START_SID INT,
		@END VARCHAR(20)='@ENDPERIOD',
		@END_SID INT,
        @PROJECTION_MASTER_SID INT=@PROJECTIONMASTERSID,
		@USER_ID INT=@USERID,
		@SESSION_ID INT=@SESSIONID,
                @LEV VARCHAR(10),
                @SHIFT  CHAR(1)='@SHIFT_VALUE'

                
    SELECT @START_SID=MIN(PERIOD_SID) FROM PERIOD P
WHERE CASE WHEN @FREQUENCY='MONTHLY'  THEN Left(DateName( month , DateAdd( month , P.PERIOD_SID , -1 ) ),3)+' '+CONVERT(VARCHAR(4),P.YEAR)
              WHEN @FREQUENCY='QUARTERLY'  THEN 'Q'+CONVERT(VARCHAR(4),P.QUARTER)+' '+CONVERT(VARCHAR(4),P.YEAR)
  WHEN @FREQUENCY='SEMI-ANNUALLY'  THEN 'S'+CONVERT(VARCHAR(4),P.SEMI_ANNUAL)+' '+CONVERT(VARCHAR(4),P.YEAR)
  WHEN @FREQUENCY='ANNUALLY'  THEN CONVERT(VARCHAR(4),P.YEAR)
         END =@START
SELECT @END_SID=MAX(PERIOD_SID) FROM PERIOD P
WHERE CASE WHEN @FREQUENCY='MONTHLY'  THEN Left(DateName( month , DateAdd( month , P.PERIOD_SID , -1 ) ),3)+' '+CONVERT(VARCHAR(4),P.YEAR)
              WHEN @FREQUENCY='QUARTERLY'  THEN 'Q'+CONVERT(VARCHAR(4),P.QUARTER)+' '+CONVERT(VARCHAR(4),P.YEAR)
  WHEN @FREQUENCY='SEMI-ANNUALLY'  THEN 'S'+CONVERT(VARCHAR(4),P.SEMI_ANNUAL)+' '+CONVERT(VARCHAR(4),P.YEAR)
  WHEN @FREQUENCY='ANNUALLY'  THEN CONVERT(VARCHAR(4),P.YEAR)
         END =@END
  Declare @ARM_DEMAND_ADJ_SUMMARY_TABLE VARCHAR(200)= CONCAT( 'ST_ARM_DEMAND_ADJ_SUMMARY_', @USER_ID, '_', @SESSION_ID, '_', REPLACE( CONVERT( VARCHAR( 50 ), GETDATE(), 2 ), '.', '' ))
 
SET @SQL=';WITH CTE
     AS (SELECT B.CONTRACT_MASTER_SID,
    CN.CONTRACT_ID,CN.CONTRACT_NAME, B.COMPANY_MASTER_SID,
             CM.COMPANY_ID,CM.COMPANY_NAME, B.ITEM_MASTER_SID,
             IM.ITEM_ID, IM.ITEM_NAME,
             BM.BRAND_MASTER_SID, BM.BRAND_ID, BM.BRAND_NAME,
             A.RS_MODEL_SID, RS.RS_ID,RS_NAME,'
SET @SQL+=CASE WHEN @FREQUENCY='MONTHLY'  THEN 'Left(DateName( month , DateAdd( month , P.PERIOD_SID , -1 ) ),3)+'' ''+CONVERT(VARCHAR(4),P.YEAR)AS PERIOD,'
              WHEN @FREQUENCY='QUARTERLY'  THEN '''Q''+'+'CONVERT(VARCHAR(4),P.QUARTER)+'' ''+CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
  WHEN @FREQUENCY='SEMI-ANNUALLY'  THEN '''S''+'+'CONVERT(VARCHAR(4),P.SEMI_ANNUAL)+'' ''+CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
  WHEN @FREQUENCY='ANNUALLY'  THEN 'CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
         END
                SET @SQL+='P.PERIOD_SID,ARP.DEMAND_ACCRUAL,
ARP.DEMAND_ACCRUAL_REFORECAST,
ARP.TOTAL_DEMAND_ACCRUAL,
ARP.PROJ_TOTAL_DEMAND_ACCRUAL,
ARP.VARIANCE  AS VARIANCE,
ARP.OVERRIDE,ARP.TEMP_OVERRIDE'
    SET @SQL+=CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN ',RS_CAT.DESCRIPTION AS RS_CATEGORY,RS.RS_CATEGORY AS RS_CATEGORY_SID'
              WHEN @CONDITION='DEDUCTION TYPE' THEN ',RS_TYP.DESCRIPTION AS RS_TYPE,RS.RS_TYPE AS RS_TYPE_SID'
WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN ',RS_PGM_TYP.DESCRIPTION AS REBATE_PROGRAM_TYPE,RS.REBATE_PROGRAM_TYPE AS REBATE_PROGRAM_TYPE_SID'
  WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN ',DC2.DESCRIPTION AS DEDUCTION_CATEGORY_2,U.UDC2 AS DEDUCTION_CATEGORY_2_SID'
  WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN ',DC3.DESCRIPTION AS DEDUCTION_CATEGORY_3,U.UDC3 AS DEDUCTION_CATEGORY_3_SID'
  WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN ',DC4.DESCRIPTION AS DEDUCTION_CATEGORY_4,U.UDC4 AS DEDUCTION_CATEGORY_4_SID'
  WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN ',DC5.DESCRIPTION AS DEDUCTION_CATEGORY_5,U.UDC5 AS DEDUCTION_CATEGORY_5_SID'
  WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN ',DC6.DESCRIPTION AS DEDUCTION_CATEGORY_6,U.UDC6 AS DEDUCTION_CATEGORY_6_SID'
  ELSE ''
END
SET @SQL+=' FROM   ARM_ADJUSTMENT_DETAILS A
                JOIN CCP_DETAILS B
                  ON A.CCP_DETAILS_SID = B.CCP_DETAILS_SID
                JOIN ITEM_MASTER IM
                  ON IM.ITEM_MASTER_SID = B.ITEM_MASTER_SID
                JOIN BRAND_MASTER BM
                  ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
                JOIN '+@ARM_DEMAND_ADJ_SUMMARY_TABLE+' ARP
                  ON ARP.ARM_ADJUSTMENT_DETAILS_SID = A.ARM_ADJUSTMENT_DETAILS_SID
JOIN PERIOD P ON P.PERIOD_SID=ARP.PERIOD_SID
JOIN CONTRACT_MASTER CN
 ON CN.CONTRACT_MASTER_SID=B.CONTRACT_MASTER_SID
JOIN COMPANY_MASTER CM
ON CM.COMPANY_MASTER_SID=B.COMPANY_MASTER_SID
JOIN RS_CONTRACT RS
 ON RS.RS_MODEL_SID=A.RS_MODEL_SID AND RS.CONTRACT_MASTER_SID=B.CONTRACT_MASTER_SID
JOIN ARM_DEDUCTION_SELECTION ADS
 ON ADS.PROJECTION_MASTER_SID=A.PROJECTION_MASTER_SID AND ADS.RS_CONTRACT_SID=RS.RS_CONTRACT_SID'
SET @SQL+=CASE WHEN @CONDITION IN ('DEDUCTION CATEGORY 2','DEDUCTION CATEGORY 3','DEDUCTION CATEGORY 4','DEDUCTION CATEGORY 5','DEDUCTION CATEGORY 6') THEN ' 
                                LEFT JOIN UDCS U ON U.MASTER_TYPE=''RS_CONTRACT'' AND U.MASTER_SID=RS.RS_CONTRACT_SID' ELSE '' END
SET @SQL+=CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN ' JOIN HELPER_TABLE RS_CAT ON RS_CAT.HELPER_TABLE_SID=RS.RS_CATEGORY'
   WHEN @CONDITION='DEDUCTION TYPE' THEN ' JOIN HELPER_TABLE RS_TYP ON RS_TYP.HELPER_TABLE_SID=RS.RS_TYPE'
WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN ' JOIN HELPER_TABLE RS_PGM_TYP ON RS_PGM_TYP.HELPER_TABLE_SID=RS.REBATE_PROGRAM_TYPE'
WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN ' JOIN HELPER_TABLE DC2 ON DC2.HELPER_TABLE_SID=U.UDC2'
WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN ' JOIN HELPER_TABLE DC3 ON DC3.HELPER_TABLE_SID=U.UDC3'
WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN ' JOIN HELPER_TABLE DC4 ON DC4.HELPER_TABLE_SID=U.UDC4'
WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN ' JOIN HELPER_TABLE DC5 ON DC5.HELPER_TABLE_SID=U.UDC5'
WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN ' JOIN HELPER_TABLE DC6 ON DC6.HELPER_TABLE_SID=U.UDC6'
ELSE ''
                                    END
    SET @SQL+=' WHERE  A.PROJECTION_MASTER_SID = '+CONVERT(VARCHAR(10),@PROJECTION_MASTER_SID)
SET @SQL+=CASE WHEN @CONDITION='DEDUCTION' THEN ' AND RS.RS_ID IN ('+@CONDITION_VALUE+')' WHEN @CONDITION='DEDUCTION CATEGORY'
            THEN ' AND RS_CAT.DESCRIPTION IN ('+@CONDITION_VALUE+')'
WHEN @CONDITION='DEDUCTION TYPE' THEN ' AND RS_TYP.DESCRIPTION IN ('+@CONDITION_VALUE+')' 
WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN ' AND RS_PGM_TYP.DESCRIPTION IN ('+@CONDITION_VALUE+')'
WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN ' AND DC2.DESCRIPTION IN ('+@CONDITION_VALUE+')'
WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN ' AND DC3.DESCRIPTION IN ('+@CONDITION_VALUE+')'
WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN ' AND DC4.DESCRIPTION IN ('+@CONDITION_VALUE+')'
WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN ' AND DC5.DESCRIPTION IN ('+@CONDITION_VALUE+')'
WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN ' AND DC6.DESCRIPTION IN ('+@CONDITION_VALUE+')'
ELSE '' END SET @SQL+=' AND P.PERIOD_SID BETWEEN '+CONVERT(VARCHAR(10),@START_SID)+' AND '+CONVERT(VARCHAR(10),@END_SID)+'),'
 
IF OBJECT_ID('tempdb..#TEMP_TABLE')IS NOT NULL
DROP TABLE #TEMP_TABLE
 
CREATE TABLE #TEMP_TABLE
(
ID INT IDENTITY(1,1),
STRING CHAR(3),
COLUMN_NAME VARCHAR(50),
COLUMN_ADD_NAME VARCHAR(50),
ALIAS_NAME VARCHAR(50)
)
--LEFT(@String, LEN(@String) - 1)
INSERT INTO #TEMP_TABLE(STRING,COLUMN_NAME,COLUMN_ADD_NAME,ALIAS_NAME)
SELECT token,CASE WHEN token='B' THEN 'BRAND_MASTER_SID' 
 WHEN token='I' THEN 'ITEM_MASTER_SID'
WHEN token='T' THEN 'COMPANY_MASTER_SID'
WHEN token='C' THEN 'CONTRACT_MASTER_SID'
WHEN token='D' THEN 'RS_MODEL_SID'
 WHEN token='DC' THEN 'RS_CATEGORY_SID'
 WHEN token='DT' THEN 'RS_TYPE_SID'
 WHEN token='DP' THEN 'REBATE_PROGRAM_TYPE_SID'
 WHEN token='DC2' THEN 'DEDUCTION_CATEGORY_2_SID'
 WHEN token='DC3' THEN 'DEDUCTION_CATEGORY_3_SID'
WHEN token='DC4' THEN 'DEDUCTION_CATEGORY_4_SID'
 WHEN token='DC5' THEN 'DEDUCTION_CATEGORY_5_SID'
WHEN token='DC6' THEN 'DEDUCTION_CATEGORY_6_SID'
    END AS COLUMN_NAME,
CASE WHEN token='B' THEN 'BRAND_ID+'' - ''+BRAND_NAME' 
 WHEN token='I' THEN 'ITEM_ID+'' - ''+ITEM_NAME'
WHEN token='T' THEN 'COMPANY_ID+'' - ''+COMPANY_NAME'
WHEN token='C' THEN 'CONTRACT_ID+'' - ''+CONTRACT_NAME'
 WHEN token='D' THEN 'RS_ID+'' - ''+RS_NAME'
WHEN token='DC' THEN 'RS_CATEGORY'
WHEN token='DT' THEN 'RS_TYPE'
 WHEN token='DP' THEN 'REBATE_PROGRAM_TYPE'
 WHEN token='DC2' THEN 'DEDUCTION_CATEGORY_2'
 WHEN token='DC3' THEN 'DEDUCTION_CATEGORY_3'
WHEN token='DC4' THEN 'DEDUCTION_CATEGORY_4'
 WHEN token='DC5' THEN 'DEDUCTION_CATEGORY_5'
WHEN token='DC6' THEN 'DEDUCTION_CATEGORY_6'
    END AS COLUMN_ADD_NAME,
CASE WHEN token='B' THEN 'BRAND ' 
 WHEN token='I' THEN 'ITEM '
WHEN token='T' THEN 'COMPANY'
WHEN token='C' THEN 'CONTRACT'
WHEN token='D' THEN 'DEDUCTION'
WHEN token='DC' THEN 'DEDUCTION_CATEGORY'
WHEN token='DT' THEN 'DEDUCTION_TYPE'
 WHEN token='DP' THEN 'DEDUCTION_PROGRAM_TYPE'
 WHEN token='DC2' THEN 'DEDUCTION_CATEGORY_2'
 WHEN token='DC3' THEN 'DEDUCTION_CATEGORY_3'
WHEN token='DC4' THEN 'DEDUCTION_CATEGORY_4'
 WHEN token='DC5' THEN 'DEDUCTION_CATEGORY_5'
WHEN token='DC6' THEN 'DEDUCTION_CATEGORY_6'
    END AS ALIAS_NAME
FROM udf_splitstring(@LEVEL,',')
 
SELECT  @MAX_VAL=MAX(ID) FROM #TEMP_TABLE
 
 
WHILE(@I<=@MAX_VAL)
 
BEGIN
SELECT
    @SQL_SELECT=
    STUFF((
        SELECT ', NULL AS ' + U.COLUMN_NAME +', NULL AS ' +U.ALIAS_NAME
        FROM #TEMP_TABLE U
        WHERE U.ID = ID AND U.ID>@I
        ORDER BY U.ID
        FOR XML PATH('')
    ),1,1,'') ,
@SQL_COUNT=
STUFF((
        SELECT ', 0 AS ' + U.COLUMN_NAME +', '+
        CASE WHEN STRING IN ('D','DC','DT','DP','DC2','DC3','DC4','DC5','DC6') AND @SHIFT='S'
        THEN column_add_name+' AS ' ELSE '''Total'' AS ' END + U.ALIAS_NAME
        FROM #TEMP_TABLE U
        WHERE U.ID = ID AND U.ID>=1
        ORDER BY U.ID
        FOR XML PATH('')
    ),1,1,'') ,
@SQL_ADD_COUNT=
STUFF((
        SELECT ', NULL AS ' + U.COLUMN_NAME +', NULL AS ' +U.ALIAS_NAME
        FROM #TEMP_TABLE U
        WHERE U.ID = ID AND U.ID>=1
        ORDER BY U.ID
        FOR XML PATH('')
    ),1,1,'')
FROM #TEMP_TABLE
SET   @SQL_SELECT+=','
SET @SQL_SELECT=ISNULL(@SQL_SELECT,'')
SET @SQL_ADD_COUNT=ISNULL(@SQL_ADD_COUNT,'')
SET @SQL_COUNT=ISNULL(@SQL_COUNT,'')
SELECT @LEV=STRING FROM #TEMP_TABLE WHERE ID=@I
SELECT @VAR=@VAR+COLUMN_NAME+','+COLUMN_ADD_NAME+' AS '+ALIAS_NAME+',', @SQL_UNION=STRING FROM #TEMP_TABLE WHERE ID=@I
SELECT @VAR_ADD+=COLUMN_NAME+','+COLUMN_ADD_NAME+',' FROM #TEMP_TABLE WHERE ID=@I
 
SELECT @SQL_OUTER_SELECT+='SELECT * FROM '+@SQL_UNION+' UNION ALL '
SET @VAR_ADD=LEFT(@VAR_ADD, LEN(@VAR) - 1)
SET @SQL_TEMP+= ',' +@SQL_UNION+' AS (SELECT '+@VAR+@SQL_SELECT+'PERIOD, ISNULL(SUM(DEMAND_ACCRUAL),0)  AS DEMAND_ACCRUAL,
            ISNULL(SUM(DEMAND_ACCRUAL_REFORECAST),0) AS DEMAND_ACCRUAL_REFORECAST,
ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0) AS TOTAL_DEMAND_ACCRUAL,
ISNULL(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0) AS PROJ_TOTAL_DEMAND_ACCRUAL,
COALESCE(ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0)/NULLIF(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0),0)*100 AS DEMAND_ACCRUAL_RATIO,
ISNULL(SUM(VARIANCE),0) AS VARIANCE,'
             SET @SQL_TEMP+=CASE WHEN @LEV='I' THEN 'SUM(TEMP_OVERRIDE) AS TEMP_OVERRIDE,COALESCE(SUM(ISNULL(OVERRIDE,VARIANCE)),0) AS ADJUSTMENT,SUM(OVERRIDE) AS OVERRIDE' ELSE 'NULL AS TEMP_OVERRIDE,COALESCE(SUM(ISNULL(OVERRIDE,VARIANCE)),0) AS ADJUSTMENT,NULL AS OVERRIDE' END
             SET @SQL_TEMP+=' FROM   CTE
         GROUP  BY '+@VAR_ADD+CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN 'RS_CATEGORY_SID,RS_CATEGORY,'
              WHEN @CONDITION='DEDUCTION TYPE' THEN 'RS_TYPE_SID,RS_TYPE,'
  WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN 'REBATE_PROGRAM_TYPE_SID,REBATE_PROGRAM_TYPE,'
  WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN 'DEDUCTION_CATEGORY_2_SID,DEDUCTION_CATEGORY_2,'
  WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN 'DEDUCTION_CATEGORY_3_SID,DEDUCTION_CATEGORY_3,'
  WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN 'DEDUCTION_CATEGORY_4_SID,DEDUCTION_CATEGORY_4,'
  WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN 'DEDUCTION_CATEGORY_5_SID,DEDUCTION_CATEGORY_5,'
  WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN 'DEDUCTION_CATEGORY_6_SID,DEDUCTION_CATEGORY_6,'
  WHEN @CONDITION='DEDUCTION' THEN 'RS_MODEL_SID,RS_ID+'' - ''+RS_NAME,'
  ELSE ''
 END+
'PERIOD)'
SET @I+=1
 
 
END
 
SET @SQL_OUTER_SELECT=LEFT(@SQL_OUTER_SELECT, LEN(@SQL_OUTER_SELECT) - 10)
 
SET @SQL+='TOTAL AS (SELECT '+@SQL_COUNT+','+'PERIOD,  ISNULL(SUM(DEMAND_ACCRUAL),0)                       AS DEMAND_ACCRUAL,
            ISNULL(SUM(DEMAND_ACCRUAL_REFORECAST),0) AS DEMAND_ACCRUAL_REFORECAST,
ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0) AS TOTAL_DEMAND_ACCRUAL,
ISNULL(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0) AS PROJ_TOTAL_DEMAND_ACCRUAL,
COALESCE(ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0)/NULLIF(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0),0)*100 AS DEMAND_ACCRUAL_RATIO,
ISNULL(SUM(VARIANCE),0) AS VARIANCE,
NULL AS TEMP_OVERRIDE,
COALESCE(SUM(ISNULL(OVERRIDE,VARIANCE)),0) AS ADJUSTMENT,
NULL AS OVERRIDE
FROM   CTE
         GROUP  BY '+CASE WHEN @SHIFT='S' THEN CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN 'RS_CATEGORY_SID,RS_CATEGORY,'
              WHEN @CONDITION='DEDUCTION TYPE' THEN 'RS_TYPE_SID,RS_TYPE,'
  WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN 'REBATE_PROGRAM_TYPE_SID,REBATE_PROGRAM_TYPE,'
  WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN 'DEDUCTION_CATEGORY_2_SID,DEDUCTION_CATEGORY_2,'
  WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN 'DEDUCTION_CATEGORY_3_SID,DEDUCTION_CATEGORY_3,'
  WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN 'DEDUCTION_CATEGORY_4_SID,DEDUCTION_CATEGORY_4,'
  WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN 'DEDUCTION_CATEGORY_5_SID,DEDUCTION_CATEGORY_5,'
  WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN 'DEDUCTION_CATEGORY_6_SID,DEDUCTION_CATEGORY_6,'
  WHEN @CONDITION='DEDUCTION' THEN 'RS_MODEL_SID,RS_ID+'' - ''+RS_NAME,'
  ELSE ''
END ELSE '' END+
'PERIOD)'+@SQL_TEMP
 
 
SET @SQL+=' SELECT * FROM TOTAL UNION ALL '+@SQL_OUTER_SELECT
 
EXECUTE (@SQL)
                                     ]]>  
        </query>
    </entity>
    <entity id="Excel_Demand_Accrual_Query">
        <query>
       <![CDATA[

      DECLARE @LEVEL                VARCHAR(30)=@LEVEL_VAL, 
                    @MAX_VAL               INT=0, 
            @I                     INT=1, 
            @SQL                   NVARCHAR(max)='', 
                     @SQL_TEMP                   NVARCHAR(max)='', 
            @VAR                   VARCHAR(1000)='', 
                    @VAR_ADD               VARCHAR(1000)='', 
                    @VAR_TEST               VARCHAR(1000)='', 
            @SQL_GROUP             NVARCHAR(max), 
            @SQL_SELECT            NVARCHAR(max), 
            @SQL_UNION             NVARCHAR(4000), 
            @SQL_OUTER_SELECT      NVARCHAR(1000)='', 
            @SQL_COUNT             NVARCHAR(1000)='',
                    @SQL_ADD_COUNT         NVARCHAR(1000)='',
                     @CONDITION             VARCHAR(50)='@DEDUCTIONLEVEL',
                                            @CONDITION_VALUE VARCHAR(1000)='@DEDUCTIONVALUE',
                                            @FREQUENCY VARCHAR(20)='@FREQUENCYSELECTED',
                                            @START VARCHAR(20)='@STARTPERIOD',
                                @START_SID INT,
                                @END VARCHAR(20)='@ENDPERIOD',
                                @END_SID INT,
                                    @PROJECTION_MASTER_SID INT=@PROJECTIONMASTERSID,
                                    @LEV VARCHAR(10),
                                            @USER_ID INT=@USERID,
                                                    @SESSION_ID INT=@SESSIONID,
                                                    @SHIFT  CHAR(1)='@SHIFT_VALUE'

            Declare @ARM_DEMAND_ADJ_SUMMARY_TABLE VARCHAR(200)= CONCAT( 'ST_ARM_DEMAND_ADJ_SUMMARY_', @USER_ID, '_', @SESSION_ID, '_', REPLACE( CONVERT( VARCHAR( 50 ), GETDATE(), 2 ), '.', '' ))
 
SELECT @START_SID=MIN(PERIOD_SID) FROM PERIOD P
WHERE CASE WHEN @FREQUENCY='MONTHLY'  THEN Left(DateName( month , DateAdd( month , P.PERIOD_SID , -1 ) ),3)+' '+CONVERT(VARCHAR(4),P.YEAR)
              WHEN @FREQUENCY='QUARTERLY'  THEN 'Q'+CONVERT(VARCHAR(4),P.QUARTER)+' '+CONVERT(VARCHAR(4),P.YEAR)
  WHEN @FREQUENCY='SEMI-ANNUALLY'  THEN 'S'+CONVERT(VARCHAR(4),P.SEMI_ANNUAL)+' '+CONVERT(VARCHAR(4),P.YEAR)
           WHEN @FREQUENCY='QUARTERLY'  THEN 'Q'+CONVERT(VARCHAR(4),P.QUARTER)+' '+CONVERT(VARCHAR(4),P.YEAR)
  WHEN @FREQUENCY='ANNUALLY'  THEN CONVERT(VARCHAR(4),P.YEAR)
         END =@START
SELECT @END_SID=MAX(PERIOD_SID) FROM PERIOD P
WHERE CASE WHEN @FREQUENCY='MONTHLY'  THEN Left(DateName( month , DateAdd( month , P.PERIOD_SID , -1 ) ),3)+' '+CONVERT(VARCHAR(4),P.YEAR)
              WHEN @FREQUENCY='QUARTERLY'  THEN 'Q'+CONVERT(VARCHAR(4),P.QUARTER)+' '+CONVERT(VARCHAR(4),P.YEAR)
  WHEN @FREQUENCY='SEMI-ANNUALLY'  THEN 'S'+CONVERT(VARCHAR(4),P.SEMI_ANNUAL)+' '+CONVERT(VARCHAR(4),P.YEAR)
  WHEN @FREQUENCY='ANNUALLY'  THEN CONVERT(VARCHAR(4),P.YEAR)
         END =@END
 
SET @SQL=';WITH CTE
     AS (SELECT B.CONTRACT_MASTER_SID, CN.CONTRACT_ID,CN.CONTRACT_NAME,
                B.COMPANY_MASTER_SID, CM.COMPANY_ID,CM.COMPANY_NAME,
                B.ITEM_MASTER_SID, IM.ITEM_ID, IM.ITEM_NAME,
                BM.BRAND_MASTER_SID, BM.BRAND_ID, BM.BRAND_NAME,
                A.RS_MODEL_SID, RS.RS_ID,RS_NAME,'
SET @SQL+=CASE WHEN @FREQUENCY='MONTHLY'  THEN 'Left(DateName( month , DateAdd( month , P.PERIOD_SID , -1 ) ),3)+'' ''+CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
              WHEN @FREQUENCY='QUARTERLY'  THEN '''Q''+'+'CONVERT(VARCHAR(4),P.QUARTER)+'' ''+CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
  WHEN @FREQUENCY='SEMI-ANNUALLY'  THEN '''S''+'+'CONVERT(VARCHAR(4),P.SEMI_ANNUAL)+'' ''+CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
  WHEN @FREQUENCY='ANNUALLY'  THEN 'CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
         END
                SET @SQL+='P.PERIOD_SID,ARP.DEMAND_ACCRUAL,
ARP.DEMAND_ACCRUAL_REFORECAST,
ARP.TOTAL_DEMAND_ACCRUAL,
ARP.PROJ_TOTAL_DEMAND_ACCRUAL,
ARP.VARIANCE  AS VARIANCE,
ARP.OVERRIDE,ARP.TEMP_OVERRIDE'
    SET @SQL+=CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN ',RS_CAT.DESCRIPTION AS RS_CATEGORY'
              WHEN @CONDITION='DEDUCTION TYPE' THEN ',RS_TYP.DESCRIPTION AS RS_TYPE'
  WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN ',RS_PGM_TYP.DESCRIPTION AS REBATE_PROGRAM_TYPE'
  WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN ',DC2.DESCRIPTION AS DEDUCTION_CATEGORY_2'
  WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN ',DC3.DESCRIPTION AS DEDUCTION_CATEGORY_3'
  WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN ',DC4.DESCRIPTION AS DEDUCTION_CATEGORY_4'
  WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN ',DC5.DESCRIPTION AS DEDUCTION_CATEGORY_5'
  WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN ',DC6.DESCRIPTION AS DEDUCTION_CATEGORY_6'
  ELSE ''
END
SET @SQL+=' FROM   ARM_ADJUSTMENT_DETAILS A
                JOIN CCP_DETAILS B
                  ON A.CCP_DETAILS_SID = B.CCP_DETAILS_SID
                JOIN ITEM_MASTER IM
                  ON IM.ITEM_MASTER_SID = B.ITEM_MASTER_SID
                JOIN BRAND_MASTER BM
                  ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
                JOIN '+@ARM_DEMAND_ADJ_SUMMARY_TABLE+' ARP
                  ON ARP.ARM_ADJUSTMENT_DETAILS_SID = A.ARM_ADJUSTMENT_DETAILS_SID
JOIN PERIOD P ON P.PERIOD_SID=ARP.PERIOD_SID
JOIN CONTRACT_MASTER CN
 ON CN.CONTRACT_MASTER_SID=B.CONTRACT_MASTER_SID
JOIN COMPANY_MASTER CM
ON CM.COMPANY_MASTER_SID=B.COMPANY_MASTER_SID
JOIN RS_CONTRACT RS
 ON RS.RS_MODEL_SID=A.RS_MODEL_SID AND RS.CONTRACT_MASTER_SID=B.CONTRACT_MASTER_SID
JOIN ARM_DEDUCTION_SELECTION ADS
 ON ADS.PROJECTION_MASTER_SID=A.PROJECTION_MASTER_SID AND ADS.RS_CONTRACT_SID=RS.RS_CONTRACT_SID'
SET @SQL+=CASE WHEN @CONDITION IN ('DEDUCTION CATEGORY 2','DEDUCTION CATEGORY 3','DEDUCTION CATEGORY 4','DEDUCTION CATEGORY 5','DEDUCTION CATEGORY 6') THEN '
                                LEFT JOIN UDCS U ON U.MASTER_TYPE=''RS_CONTRACT'' AND U.MASTER_SID=RS.RS_CONTRACT_SID' ELSE '' END
SET @SQL+=CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN ' JOIN HELPER_TABLE RS_CAT ON RS_CAT.HELPER_TABLE_SID=RS.RS_CATEGORY'
              WHEN @CONDITION='DEDUCTION TYPE' THEN ' JOIN HELPER_TABLE RS_TYP ON RS_TYP.HELPER_TABLE_SID=RS.RS_TYPE'
  WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN ' JOIN HELPER_TABLE RS_PGM_TYP ON RS_PGM_TYP.HELPER_TABLE_SID=RS.REBATE_PROGRAM_TYPE'
  WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN ' JOIN HELPER_TABLE DC2 ON DC2.HELPER_TABLE_SID=U.UDC2'
  WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN ' JOIN HELPER_TABLE DC3 ON DC3.HELPER_TABLE_SID=U.UDC3'
  WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN ' JOIN HELPER_TABLE DC4 ON DC4.HELPER_TABLE_SID=U.UDC4'
  WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN ' JOIN HELPER_TABLE DC5 ON DC5.HELPER_TABLE_SID=U.UDC5'
  WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN ' JOIN HELPER_TABLE DC6 ON DC6.HELPER_TABLE_SID=U.UDC6'
  ELSE ''
END
    SET @SQL+=' WHERE  A.PROJECTION_MASTER_SID = '+CONVERT(VARCHAR(10),@PROJECTION_MASTER_SID)
    SET @SQL+=CASE WHEN @CONDITION='DEDUCTION' THEN ' AND RS.RS_ID IN ('+@CONDITION_VALUE+')' WHEN @CONDITION='DEDUCTION CATEGORY' THEN '
    AND RS_CAT.DESCRIPTION IN ('+@CONDITION_VALUE+')'
WHEN @CONDITION='DEDUCTION TYPE' THEN ' AND RS_TYP.DESCRIPTION IN ('+@CONDITION_VALUE+')' 
WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN ' AND RS_PGM_TYP.DESCRIPTION IN ('+@CONDITION_VALUE+')'
WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN ' AND DC2.DESCRIPTION IN ('+@CONDITION_VALUE+')'
WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN ' AND DC3.DESCRIPTION IN ('+@CONDITION_VALUE+')'
WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN ' AND DC4.DESCRIPTION IN ('+@CONDITION_VALUE+')'
WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN ' AND DC5.DESCRIPTION IN ('+@CONDITION_VALUE+')'
WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN ' AND DC6.DESCRIPTION IN ('+@CONDITION_VALUE+')'
ELSE '' END SET @SQL+=' AND P.PERIOD_SID BETWEEN '+CONVERT(VARCHAR(10),@START_SID)+' AND '+CONVERT(VARCHAR(10),@END_SID)+'),'
 
IF OBJECT_ID('tempdb..#TEMP_TABLE')IS NOT NULL
DROP TABLE #TEMP_TABLE
 
CREATE TABLE #TEMP_TABLE
(
ID INT IDENTITY(1,1),
STRING CHAR(2),
COLUMN_NAME VARCHAR(50),
COLUMN_ADD_NAME VARCHAR(50),
ALIAS_NAME VARCHAR(50)
)
--LEFT(@String, LEN(@String) - 1)
INSERT INTO #TEMP_TABLE(STRING,COLUMN_NAME,COLUMN_ADD_NAME,ALIAS_NAME)
SELECT token,CASE WHEN token='B' THEN 'BRAND_MASTER_SID' 
 WHEN token='I' THEN 'ITEM_MASTER_SID'
WHEN token='T' THEN 'COMPANY_MASTER_SID'
WHEN token='C' THEN 'CONTRACT_MASTER_SID'
WHEN token='D' THEN 'RS_MODEL_SID'
WHEN token='RC' THEN 'RS_CATEGORY'
WHEN token='RT' THEN 'RS_TYPE'
WHEN token='RCB' THEN 'REBATE_PROGRAM_TYPE'
WHEN token='U2' THEN 'DEDUCTION_CATEGORY_2'
WHEN token='U3' THEN 'DEDUCTION_CATEGORY_3'
WHEN token='U4' THEN 'DEDUCTION_CATEGORY_4'
WHEN token='U5' THEN 'DEDUCTION_CATEGORY_5'
WHEN token='U6' THEN 'DEDUCTION_CATEGORY_6'
    END AS COLUMN_NAME,
CASE WHEN token='B' THEN 'BRAND_ID+'' - ''+BRAND_NAME' 
 WHEN token='I' THEN 'ITEM_ID+'' - ''+ITEM_NAME'
WHEN token='T' THEN 'COMPANY_ID+'' - ''+COMPANY_NAME'
WHEN token='C' THEN 'CONTRACT_ID+'' - ''+CONTRACT_NAME'
 WHEN token='D' THEN 'RS_ID+'' - ''+RS_NAME'
    END AS COLUMN_ADD_NAME,
CASE WHEN token='B' THEN 'BRAND ' 
 WHEN token='I' THEN 'ITEM '
WHEN token='T' THEN 'COMPANY'
WHEN token='C' THEN 'CONTRACT'
WHEN token='D' THEN 'DEDUCTION'
    END AS ALIAS_NAME
FROM udf_splitstring(@LEVEL,',')
 
SELECT  @MAX_VAL=MAX(ID) FROM #TEMP_TABLE
 
WHILE(@I<=@MAX_VAL)
 
BEGIN
SELECT
    @SQL_SELECT=
    STUFF((
        SELECT ', NULL AS ' + U.COLUMN_NAME +', NULL AS ' +U.ALIAS_NAME
        FROM #TEMP_TABLE U
        WHERE U.ID = ID AND U.ID>@I
        ORDER BY U.ID
        FOR XML PATH('')
    ),1,1,'') ,
@SQL_COUNT=
STUFF((
        SELECT ', 0 AS ' + U.COLUMN_NAME +', ''TOTAL'' AS ' +U.ALIAS_NAME
        FROM #TEMP_TABLE U
        WHERE U.ID = ID AND U.ID>=1
        ORDER BY U.ID
        FOR XML PATH('')
    ),1,1,'') ,
@SQL_ADD_COUNT=
STUFF((
        SELECT ', NULL AS ' + U.ALIAS_NAME
        FROM #TEMP_TABLE U
        WHERE U.ID = ID AND U.ID>@I
        ORDER BY U.ID
        FOR XML PATH('')
    ),1,1,'')
FROM #TEMP_TABLE
SET   @SQL_SELECT+=','
SET   @SQL_ADD_COUNT+=','
SET @SQL_SELECT=ISNULL(@SQL_SELECT,'')
SET @SQL_ADD_COUNT=ISNULL(@SQL_ADD_COUNT,'')
SET @SQL_COUNT=ISNULL(@SQL_COUNT,'')
SELECT @LEV=STRING FROM #TEMP_TABLE WHERE ID=@I
SELECT @VAR=@VAR+COLUMN_NAME+','+COLUMN_ADD_NAME+' AS '+ALIAS_NAME+',', @SQL_UNION=STRING FROM #TEMP_TABLE WHERE ID=@I
SELECT @VAR_ADD+=COLUMN_NAME+','+COLUMN_ADD_NAME+',' FROM #TEMP_TABLE WHERE ID=@I
 
SELECT @SQL_OUTER_SELECT+='SELECT * FROM '+@SQL_UNION+' UNION ALL '
SET @VAR_ADD=LEFT(@VAR_ADD, LEN(@VAR) - 1)
SET @SQL_TEMP+=',' +@SQL_UNION+' AS (SELECT '+@VAR+@SQL_SELECT+CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN 'RS_CATEGORY,'
              WHEN @CONDITION='DEDUCTION TYPE' THEN 'RS_TYPE,'
  WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN 'REBATE_PROGRAM_TYPE,'
  WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN 'DEDUCTION_CATEGORY_2,'
  WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN 'DEDUCTION_CATEGORY_3,'
  WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN 'DEDUCTION_CATEGORY_4,'
  WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN 'DEDUCTION_CATEGORY_5,'
  WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN 'DEDUCTION_CATEGORY_6,'
  WHEN @CONDITION='DEDUCTION' THEN 'RS_ID,'
  ELSE ''
END+'  ISNULL(SUM(DEMAND_ACCRUAL),0)                       AS DEMAND_ACCRUAL,
            ISNULL(SUM(DEMAND_ACCRUAL_REFORECAST),0) AS DEMAND_ACCRUAL_REFORECAST,
ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0) AS TOTAL_DEMAND_ACCRUAL,
ISNULL(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0) AS PROJ_TOTAL_DEMAND_ACCRUAL,
COALESCE(ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0)/NULLIF(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0),0)*100 AS DEMAND_ACCRUAL_RATIO,
ISNULL(SUM(VARIANCE),0) AS VARIANCE,'
             SET @SQL_TEMP+=CASE WHEN @LEV='I' THEN 'SUM(TEMP_OVERRIDE) AS TEMP_OVERRIDE,COALESCE(SUM(ISNULL(OVERRIDE,VARIANCE)),0) AS ADJUSTMENT,SUM(OVERRIDE) AS OVERRIDE,' ELSE 'NULL AS TEMP_OVERRIDE,COALESCE(SUM(ISNULL(OVERRIDE,VARIANCE)),0) AS ADJUSTMENT,NULL AS OVERRIDE,' END
             SET @SQL_TEMP+=' PERIOD
FROM   CTE
         GROUP  BY '+@VAR_ADD+CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN 'RS_CATEGORY,'
              WHEN @CONDITION='DEDUCTION TYPE' THEN 'RS_TYPE,'
  WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN 'REBATE_PROGRAM_TYPE,'
  WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN 'DEDUCTION_CATEGORY_2,'
  WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN 'DEDUCTION_CATEGORY_3,'
  WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN 'DEDUCTION_CATEGORY_4,'
  WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN 'DEDUCTION_CATEGORY_5,'
  WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN 'DEDUCTION_CATEGORY_6,'
  WHEN @CONDITION='DEDUCTION' THEN 'RS_ID,'
  ELSE ''
 END+
'PERIOD)'
SET @I+=1
 
 
END
 
SET @SQL_OUTER_SELECT=LEFT(@SQL_OUTER_SELECT, LEN(@SQL_OUTER_SELECT) - 10)
SET @SQL+='TOTAL AS (SELECT '+@SQL_COUNT+','+CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN 'RS_CATEGORY,'
              WHEN @CONDITION='DEDUCTION TYPE' THEN 'RS_TYPE,'
  WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN 'REBATE_PROGRAM_TYPE,'
  WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN 'DEDUCTION_CATEGORY_2,'
  WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN 'DEDUCTION_CATEGORY_3,'
  WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN 'DEDUCTION_CATEGORY_4,'
  WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN 'DEDUCTION_CATEGORY_5,'
  WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN 'DEDUCTION_CATEGORY_6,'
  WHEN @CONDITION='DEDUCTION' THEN 'RS_ID,'
  ELSE ''
END+'  ISNULL(SUM(DEMAND_ACCRUAL),0)                       AS DEMAND_ACCRUAL,
            ISNULL(SUM(DEMAND_ACCRUAL_REFORECAST),0) AS DEMAND_ACCRUAL_REFORECAST,
ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0) AS TOTAL_DEMAND_ACCRUAL,
ISNULL(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0) AS PROJ_TOTAL_DEMAND_ACCRUAL,
COALESCE(ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0)/NULLIF(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0),0)*100 AS DEMAND_ACCRUAL_RATIO,
ISNULL(SUM(VARIANCE),0) AS VARIANCE,
NULL AS TEMP_OVERRIDE,
COALESCE(SUM(ISNULL(OVERRIDE,VARIANCE)),0) AS ADJUSTMENT,NULL AS OVERRIDE,PERIOD
FROM   CTE
         GROUP  BY '+CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN 'RS_CATEGORY,'
              WHEN @CONDITION='DEDUCTION TYPE' THEN 'RS_TYPE,'
  WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN 'REBATE_PROGRAM_TYPE,'
  WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN 'DEDUCTION_CATEGORY_2,'
  WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN 'DEDUCTION_CATEGORY_3,'
  WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN 'DEDUCTION_CATEGORY_4,'
  WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN 'DEDUCTION_CATEGORY_5,'
  WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN 'DEDUCTION_CATEGORY_6,'
  WHEN @CONDITION='DEDUCTION' THEN 'RS_ID,'
  ELSE ''
 END+
'PERIOD)'+@SQL_TEMP
 
SET @SQL+='SELECT * FROM TOTAL UNION ALL '+@SQL_OUTER_SELECT
 
 
EXECUTE (@SQL)

]]> 
        </query> 
    </entity>       
    
    <entity id="Excel_Muliple_Period_Demand_Accrual_QueryView">
        <query>
            <![CDATA[
                  DECLARE @LEVEL                VARCHAR(30)=@LEVEL_VAL, 
		@MAX_VAL               INT=0, 
        @I                     INT=1, 
        @SQL                   NVARCHAR(max)='', 
		@SQL_TEMP                   NVARCHAR(max)='', 
        @VAR                   VARCHAR(1000)='', 
		@VAR_ADD               VARCHAR(1000)='', 
		@VAR_TEST               VARCHAR(1000)='', 
        @SQL_GROUP             NVARCHAR(max), 
        @SQL_SELECT            NVARCHAR(max), 
        @SQL_UNION             NVARCHAR(4000), 
        @SQL_OUTER_SELECT      NVARCHAR(1000)='', 
        @SQL_COUNT             NVARCHAR(1000)='',
		@SQL_ADD_COUNT         NVARCHAR(1000)='',
		@SQL_SUM           NVARCHAR(1000)='', 
		@CONDITION             VARCHAR(50)='@DEDUCTIONLEVEL',
		@CONDITION_VALUE VARCHAR(1000)='@DEDUCTIONVALUE',
		@FREQUENCY VARCHAR(20)='@FREQUENCYSELECTED',
		@START VARCHAR(20)='@STARTPERIOD',
		@START_SID INT,
		@END VARCHAR(20)='@ENDPERIOD',
		@END_SID INT,
        @PROJECTION_MASTER_SID INT=@PROJECTIONMASTERSID,
		@USER_ID INT=@USERID,
		@SESSION_ID INT=@SESSIONID,
                @LEV VARCHAR(10),
                @SHIFT  CHAR(1)='@SHIFT_VALUE'

SELECT @START_SID=MIN(PERIOD_SID) FROM PERIOD P
WHERE CASE WHEN @FREQUENCY='MONTHLY'  THEN Left(DateName( month , DateAdd( month , P.PERIOD_SID , -1 ) ),3)+' '+CONVERT(VARCHAR(4),P.YEAR)
				               WHEN @FREQUENCY='QUARTERLY'  THEN 'Q'+CONVERT(VARCHAR(4),P.QUARTER)+' '+CONVERT(VARCHAR(4),P.YEAR) 
							   WHEN @FREQUENCY='SEMI-ANNUALLY'  THEN 'S'+CONVERT(VARCHAR(4),P.SEMI_ANNUAL)+' '+CONVERT(VARCHAR(4),P.YEAR) 
							   WHEN @FREQUENCY='ANNUALLY'  THEN CONVERT(VARCHAR(4),P.YEAR) 
				          END =@START
SELECT @END_SID=MAX(PERIOD_SID) FROM PERIOD P
WHERE CASE WHEN @FREQUENCY='MONTHLY'  THEN Left(DateName( month , DateAdd( month , P.PERIOD_SID , -1 ) ),3)+' '+CONVERT(VARCHAR(4),P.YEAR)
				               WHEN @FREQUENCY='QUARTERLY'  THEN 'Q'+CONVERT(VARCHAR(4),P.QUARTER)+' '+CONVERT(VARCHAR(4),P.YEAR) 
							   WHEN @FREQUENCY='SEMI-ANNUALLY'  THEN 'S'+CONVERT(VARCHAR(4),P.SEMI_ANNUAL)+' '+CONVERT(VARCHAR(4),P.YEAR) 
							   WHEN @FREQUENCY='ANNUALLY'  THEN CONVERT(VARCHAR(4),P.YEAR) 
				          END =@END


SET @SQL=';WITH CTE 
     AS (SELECT B.CONTRACT_MASTER_SID, 
	            CN.CONTRACT_ID,CN.CONTRACT_NAME,
                B.COMPANY_MASTER_SID, 
				CM.COMPANY_ID,CM.COMPANY_NAME,
                B.ITEM_MASTER_SID, 
				IM.ITEM_ID,
				IM.ITEM_NAME,
                BM.BRAND_MASTER_SID,
				BM.BRAND_ID,
				BM.BRAND_NAME,
                A.RS_MODEL_SID,
				RS.RS_ID,RS_NAME,'
				SET @SQL+=CASE WHEN @FREQUENCY='MONTHLY'  THEN 'Left(DateName( month , DateAdd( month , P.PERIOD_SID , -1 ) ),3)+'' ''+CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
				               WHEN @FREQUENCY='QUARTERLY'  THEN '''Q''+'+'CONVERT(VARCHAR(4),P.QUARTER)+'' ''+CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
							   WHEN @FREQUENCY='SEMI-ANNUALLY'  THEN '''S''+'+'CONVERT(VARCHAR(4),P.SEMI_ANNUAL)+'' ''+CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
							   WHEN @FREQUENCY='ANNUALLY'  THEN 'CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
				          END 
                SET @SQL+='P.PERIOD_SID,ARP.DEMAND_ACCRUAL, 
				ARP.DEMAND_ACCRUAL_REFORECAST,
				ARP.TOTAL_DEMAND_ACCRUAL,
				ARP.PROJ_TOTAL_DEMAND_ACCRUAL,
				ARP.VARIANCE  AS VARIANCE,
				ARP.OVERRIDE' 
	     SET @SQL+=CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN ',RS_CAT.DESCRIPTION AS RS_CATEGORY,RS.RS_CATEGORY AS RS_CATEGORY_SID'
				               WHEN @CONDITION='DEDUCTION TYPE' THEN ',RS_TYP.DESCRIPTION AS RS_TYPE,RS.RS_TYPE AS RS_TYPE_SID'
							   WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN ',RS_PGM_TYP.DESCRIPTION AS REBATE_PROGRAM_TYPE,RS.REBATE_PROGRAM_TYPE AS REBATE_PROGRAM_TYPE_SID'
							   WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN ',DC2.DESCRIPTION AS DEDUCTION_CATEGORY_2,U.UDC2 AS DEDUCTION_CATEGORY_2_SID'
							   WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN ',DC3.DESCRIPTION AS DEDUCTION_CATEGORY_3,U.UDC3 AS DEDUCTION_CATEGORY_3_SID'
							   WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN ',DC4.DESCRIPTION AS DEDUCTION_CATEGORY_4,U.UDC4 AS DEDUCTION_CATEGORY_4_SID'
							   WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN ',DC5.DESCRIPTION AS DEDUCTION_CATEGORY_5,U.UDC5 AS DEDUCTION_CATEGORY_5_SID'
							   WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN ',DC6.DESCRIPTION AS DEDUCTION_CATEGORY_6,U.UDC6 AS DEDUCTION_CATEGORY_6_SID'
							   ELSE ''
						  END
		 SET @SQL+=' FROM   ARM_ADJUSTMENT_DETAILS A 
                JOIN CCP_DETAILS B 
                  ON A.CCP_DETAILS_SID = B.CCP_DETAILS_SID 
                JOIN ITEM_MASTER IM 
                  ON IM.ITEM_MASTER_SID = B.ITEM_MASTER_SID 
                JOIN BRAND_MASTER BM 
                  ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
                JOIN ARM_DEMAND_ADJ_SUMMARY ARP 
                  ON ARP.ARM_ADJUSTMENT_DETAILS_SID = A.ARM_ADJUSTMENT_DETAILS_SID 
				JOIN PERIOD P ON P.PERIOD_SID=ARP.PERIOD_SID
				JOIN CONTRACT_MASTER CN 
				  ON CN.CONTRACT_MASTER_SID=B.CONTRACT_MASTER_SID 
				JOIN COMPANY_MASTER CM
				  ON CM.COMPANY_MASTER_SID=B.COMPANY_MASTER_SID
				JOIN RS_CONTRACT RS 
				  ON RS.RS_MODEL_SID=A.RS_MODEL_SID AND RS.CONTRACT_MASTER_SID=B.CONTRACT_MASTER_SID 
				JOIN ARM_DEDUCTION_SELECTION ADS 
				  ON ADS.PROJECTION_MASTER_SID=A.PROJECTION_MASTER_SID AND ADS.RS_CONTRACT_SID=RS.RS_CONTRACT_SID'
				SET @SQL+=CASE WHEN @CONDITION IN ('DEDUCTION CATEGORY 2','DEDUCTION CATEGORY 3','DEDUCTION CATEGORY 4','DEDUCTION CATEGORY 5','DEDUCTION CATEGORY 6') THEN '  
                                LEFT JOIN UDCS U ON U.MASTER_TYPE=''RS_CONTRACT'' AND U.MASTER_SID=RS.RS_CONTRACT_SID' ELSE '' END
				SET @SQL+=CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN ' JOIN HELPER_TABLE RS_CAT ON RS_CAT.HELPER_TABLE_SID=RS.RS_CATEGORY'
				               WHEN @CONDITION='DEDUCTION TYPE' THEN ' JOIN HELPER_TABLE RS_TYP ON RS_TYP.HELPER_TABLE_SID=RS.RS_TYPE'
							   WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN ' JOIN HELPER_TABLE RS_PGM_TYP ON RS_PGM_TYP.HELPER_TABLE_SID=RS.REBATE_PROGRAM_TYPE'
							   WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN ' JOIN HELPER_TABLE DC2 ON DC2.HELPER_TABLE_SID=U.UDC2'
							   WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN ' JOIN HELPER_TABLE DC3 ON DC3.HELPER_TABLE_SID=U.UDC3'
							   WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN ' JOIN HELPER_TABLE DC4 ON DC4.HELPER_TABLE_SID=U.UDC4'
							   WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN ' JOIN HELPER_TABLE DC5 ON DC5.HELPER_TABLE_SID=U.UDC5'
							   WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN ' JOIN HELPER_TABLE DC6 ON DC6.HELPER_TABLE_SID=U.UDC6'
							   ELSE ''
						  END
    SET @SQL+=' WHERE  A.PROJECTION_MASTER_SID = '+CONVERT(VARCHAR(10),@PROJECTION_MASTER_SID)
	SET @SQL+=CASE WHEN @CONDITION='DEDUCTION' THEN ' AND RS.RS_ID IN ('+@CONDITION_VALUE+')' WHEN @CONDITION='DEDUCTION CATEGORY' THEN ' AND RS_CAT.DESCRIPTION IN ('+@CONDITION_VALUE+')' 
	 WHEN @CONDITION='DEDUCTION TYPE' THEN ' AND RS_TYP.DESCRIPTION IN ('+@CONDITION_VALUE+')'  
	 WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN ' AND RS_PGM_TYP.DESCRIPTION IN ('+@CONDITION_VALUE+')'
	 WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN ' AND DC2.DESCRIPTION IN ('+@CONDITION_VALUE+')'
	 WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN ' AND DC3.DESCRIPTION IN ('+@CONDITION_VALUE+')'
	 WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN ' AND DC4.DESCRIPTION IN ('+@CONDITION_VALUE+')'
	 WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN ' AND DC5.DESCRIPTION IN ('+@CONDITION_VALUE+')'
	 WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN ' AND DC6.DESCRIPTION IN ('+@CONDITION_VALUE+')'
	 ELSE '' END SET @SQL+=' AND P.PERIOD_SID BETWEEN '+CONVERT(VARCHAR(10),@START_SID)+' AND '+CONVERT(VARCHAR(10),@END_SID)+'),'

IF OBJECT_ID('tempdb..#TEMP_TABLE')IS NOT NULL
DROP TABLE #TEMP_TABLE

CREATE TABLE #TEMP_TABLE
(
	ID INT IDENTITY(1,1),
	STRING CHAR(3),
	COLUMN_NAME VARCHAR(50),
	COLUMN_ADD_NAME VARCHAR(50),
	ALIAS_NAME VARCHAR(50)
)
--LEFT(@String, LEN(@String) - 1) 
INSERT INTO #TEMP_TABLE(STRING,COLUMN_NAME,COLUMN_ADD_NAME,ALIAS_NAME)
SELECT token,CASE WHEN token='B' THEN 'BRAND_MASTER_SID'  
				  WHEN token='I' THEN 'ITEM_MASTER_SID'
				  WHEN token='T' THEN 'COMPANY_MASTER_SID'
				  WHEN token='C' THEN 'CONTRACT_MASTER_SID'
				  WHEN token='D' THEN 'RS_MODEL_SID'				 
				  WHEN token='DC' THEN 'RS_CATEGORY_SID'	
				  WHEN token='DT' THEN 'RS_TYPE_SID'	
				  WHEN token='DP' THEN 'REBATE_PROGRAM_TYPE_SID'	
				  WHEN token='DC2' THEN 'DEDUCTION_CATEGORY_2_SID'	
				  WHEN token='DC3' THEN 'DEDUCTION_CATEGORY_3_SID'
				  WHEN token='DC4' THEN 'DEDUCTION_CATEGORY_4_SID'	
				  WHEN token='DC5' THEN 'DEDUCTION_CATEGORY_5_SID'
				  WHEN token='DC6' THEN 'DEDUCTION_CATEGORY_6_SID'				 
		     END AS COLUMN_NAME,
			 CASE WHEN token='B' THEN 'BRAND_ID+'' - ''+BRAND_NAME'  
				  WHEN token='I' THEN 'ITEM_ID+'' - ''+ITEM_NAME'
				  WHEN token='T' THEN 'COMPANY_ID+'' - ''+COMPANY_NAME'
				  WHEN token='C' THEN 'CONTRACT_ID+'' - ''+CONTRACT_NAME' 
				  WHEN token='D' THEN 'RS_ID+'' - ''+RS_NAME'
				  WHEN token='DC' THEN 'RS_CATEGORY'
				  WHEN token='DT' THEN 'RS_TYPE'	
				  WHEN token='DP' THEN 'REBATE_PROGRAM_TYPE'	
				  WHEN token='DC2' THEN 'DEDUCTION_CATEGORY_2'	
				  WHEN token='DC3' THEN 'DEDUCTION_CATEGORY_3'
				  WHEN token='DC4' THEN 'DEDUCTION_CATEGORY_4'	
				  WHEN token='DC5' THEN 'DEDUCTION_CATEGORY_5'
				  WHEN token='DC6' THEN 'DEDUCTION_CATEGORY_6'				 
		     END AS COLUMN_ADD_NAME,
			 CASE WHEN token='B' THEN 'BRAND '  
				  WHEN token='I' THEN 'ITEM '
				  WHEN token='T' THEN 'COMPANY'
				  WHEN token='C' THEN 'CONTRACT'
				  WHEN token='D' THEN 'DEDUCTION'
				  WHEN token='DC' THEN 'DEDUCTION_CATEGORY'
				  WHEN token='DT' THEN 'DEDUCTION_TYPE'	
				  WHEN token='DP' THEN 'DEDUCTION_PROGRAM_TYPE'	
				  WHEN token='DC2' THEN 'DEDUCTION_CATEGORY_2'	
				  WHEN token='DC3' THEN 'DEDUCTION_CATEGORY_3'
				  WHEN token='DC4' THEN 'DEDUCTION_CATEGORY_4'	
				  WHEN token='DC5' THEN 'DEDUCTION_CATEGORY_5'
				  WHEN token='DC6' THEN 'DEDUCTION_CATEGORY_6'		
		     END AS ALIAS_NAME
FROM udf_splitstring(@LEVEL,',')

SELECT  @MAX_VAL=MAX(ID) FROM #TEMP_TABLE


WHILE(@I<=@MAX_VAL)

BEGIN
 SELECT 
    @SQL_SELECT=
    STUFF((
        SELECT ', NULL AS ' + U.COLUMN_NAME +', NULL AS ' +U.ALIAS_NAME
        FROM #TEMP_TABLE U
        WHERE U.ID = ID AND U.ID>@I
        ORDER BY U.ID
        FOR XML PATH('')
    ),1,1,'') ,
	@SQL_COUNT=
	STUFF((
        SELECT ', 0 AS ' + U.COLUMN_NAME +', '+
        CASE WHEN STRING IN ('D','DC','DT','DP','DC2','DC3','DC4','DC5','DC6') AND @SHIFT='S' 
        THEN column_add_name+' AS ' ELSE '''Total'' AS ' END + U.ALIAS_NAME
        FROM #TEMP_TABLE U
        WHERE U.ID = ID AND U.ID>=1
        ORDER BY U.ID
        FOR XML PATH('')
    ),1,1,'') ,
	@SQL_ADD_COUNT=
	STUFF((
        SELECT ', NULL AS ' + U.COLUMN_NAME +', NULL AS ' +U.ALIAS_NAME
        FROM #TEMP_TABLE U
        WHERE U.ID = ID AND U.ID>=1
        ORDER BY U.ID
        FOR XML PATH('')
    ),1,1,'') 
FROM #TEMP_TABLE
 SET   @SQL_SELECT+=','
 SET @SQL_SELECT=ISNULL(@SQL_SELECT,'')
 SET @SQL_ADD_COUNT=ISNULL(@SQL_ADD_COUNT,'')
 SET @SQL_COUNT=ISNULL(@SQL_COUNT,'')
 SELECT @LEV=STRING FROM #TEMP_TABLE WHERE ID=@I
 SELECT @VAR=@VAR+COLUMN_NAME+','+COLUMN_ADD_NAME+' AS '+ALIAS_NAME+',', @SQL_UNION=STRING FROM #TEMP_TABLE WHERE ID=@I
 SELECT @VAR_ADD+=CASE WHEN @I=1 THEN '' ELSE ',' END + COLUMN_NAME+','+COLUMN_ADD_NAME+',' FROM #TEMP_TABLE WHERE ID=@I

 SELECT @SQL_OUTER_SELECT+='SELECT * FROM '+@SQL_UNION+' UNION ALL '
 SET @VAR_ADD=LEFT(@VAR_ADD, LEN(@VAR_ADD) - 1)
 SET @SQL_TEMP+= ',' +@SQL_UNION+' AS (SELECT '+@VAR+@SQL_SELECT+'PERIOD, ISNULL(SUM(DEMAND_ACCRUAL),0) AS DEMAND_ACCRUAL,
            ISNULL(SUM(DEMAND_ACCRUAL_REFORECAST),0) AS DEMAND_ACCRUAL_REFORECAST,
			ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0) AS TOTAL_DEMAND_ACCRUAL,
			ISNULL(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0) AS PROJ_TOTAL_DEMAND_ACCRUAL,
			COALESCE(ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0)/NULLIF(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0),0)*100 AS DEMAND_ACCRUAL_RATIO,
			ISNULL(SUM(VARIANCE),0) AS VARIANCE,'
             SET @SQL_TEMP+=CASE WHEN @LEV='I' THEN 'SUM(OVERRIDE) AS OVERRIDE,' ELSE 'NULL AS OVERRIDE,' END
             SET @SQL_TEMP+='COALESCE(SUM(ISNULL(OVERRIDE,VARIANCE)),0) AS ADJUSTMENT
			FROM   CTE 

         GROUP  BY '+@VAR_ADD+CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN ',RS_CATEGORY_SID,RS_CATEGORY,'
				               WHEN @CONDITION='DEDUCTION TYPE' THEN ',RS_TYPE_SID,RS_TYPE,'
							   WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN ',REBATE_PROGRAM_TYPE_SID,REBATE_PROGRAM_TYPE,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN ',DEDUCTION_CATEGORY_2_SID,DEDUCTION_CATEGORY_2,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN ',DEDUCTION_CATEGORY_3_SID,DEDUCTION_CATEGORY_3,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN ',DEDUCTION_CATEGORY_4_SID,DEDUCTION_CATEGORY_4,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN ',DEDUCTION_CATEGORY_5_SID,DEDUCTION_CATEGORY_5,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN ',DEDUCTION_CATEGORY_6_SID,DEDUCTION_CATEGORY_6,'
							   WHEN @CONDITION='DEDUCTION' THEN ',RS_MODEL_SID,RS_ID+'' - ''+RS_NAME,'
							   ELSE '' 
						  END+ 
		 'PERIOD)'
 SET @I+=1


END

SET @SQL_OUTER_SELECT=LEFT(@SQL_OUTER_SELECT, LEN(@SQL_OUTER_SELECT) - 10) 

SET @SQL+='TOTAL AS (SELECT '+@SQL_COUNT+','+'PERIOD,  ISNULL(SUM(DEMAND_ACCRUAL),0)                       AS DEMAND_ACCRUAL,
            ISNULL(SUM(DEMAND_ACCRUAL_REFORECAST),0) AS DEMAND_ACCRUAL_REFORECAST,
			ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0) AS TOTAL_DEMAND_ACCRUAL,
			ISNULL(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0) AS PROJ_TOTAL_DEMAND_ACCRUAL,
			COALESCE(ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0)/NULLIF(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0),0)*100 AS DEMAND_ACCRUAL_RATIO,
			ISNULL(SUM(VARIANCE),0) AS VARIANCE,
			NULL AS OVERRIDE,
			COALESCE(SUM(ISNULL(OVERRIDE,VARIANCE)),0) AS ADJUSTMENT
			FROM   CTE 
         GROUP  BY '+CASE WHEN @SHIFT='S' THEN CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN 'RS_CATEGORY_SID,RS_CATEGORY,'
				               WHEN @CONDITION='DEDUCTION TYPE' THEN 'RS_TYPE_SID,RS_TYPE,'
							   WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN 'REBATE_PROGRAM_TYPE_SID,REBATE_PROGRAM_TYPE,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN 'DEDUCTION_CATEGORY_2_SID,DEDUCTION_CATEGORY_2,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN 'DEDUCTION_CATEGORY_3_SID,DEDUCTION_CATEGORY_3,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN 'DEDUCTION_CATEGORY_4_SID,DEDUCTION_CATEGORY_4,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN 'DEDUCTION_CATEGORY_5_SID,DEDUCTION_CATEGORY_5,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN 'DEDUCTION_CATEGORY_6_SID,DEDUCTION_CATEGORY_6,'
							   WHEN @CONDITION='DEDUCTION' THEN 'RS_MODEL_SID,RS_ID+'' - ''+RS_NAME,'
							   ELSE '' 
						END ELSE '' END+ 
		 'PERIOD)'+@SQL_TEMP


SET @SQL+=' SELECT * FROM TOTAL UNION ALL '+@SQL_OUTER_SELECT

 EXECUTE (@SQL)
                                     ]]>  
        </query>
    </entity>
    
    <entity id="Excel_Demand_Accrual_QueryView">
        <query>
       <![CDATA[

      DECLARE @LEVEL                VARCHAR(30)=@LEVEL_VAL, 
                    @MAX_VAL               INT=0, 
            @I                     INT=1, 
            @SQL                   NVARCHAR(max)='', 
                     @SQL_TEMP                   NVARCHAR(max)='', 
            @VAR                   VARCHAR(1000)='', 
                    @VAR_ADD               VARCHAR(1000)='', 
                    @VAR_TEST               VARCHAR(1000)='', 
            @SQL_GROUP             NVARCHAR(max), 
            @SQL_SELECT            NVARCHAR(max), 
            @SQL_UNION             NVARCHAR(4000), 
            @SQL_OUTER_SELECT      NVARCHAR(1000)='', 
            @SQL_COUNT             NVARCHAR(1000)='',
                    @SQL_ADD_COUNT         NVARCHAR(1000)='',
                     @CONDITION             VARCHAR(50)='@DEDUCTIONLEVEL',
                                            @CONDITION_VALUE VARCHAR(1000)='@DEDUCTIONVALUE',
                                            @FREQUENCY VARCHAR(20)='@FREQUENCYSELECTED',
                                            @START VARCHAR(20)='@STARTPERIOD',
                                @START_SID INT,
                                @END VARCHAR(20)='@ENDPERIOD',
                                @END_SID INT,
                                    @PROJECTION_MASTER_SID INT=@PROJECTIONMASTERSID,
                                    @LEV VARCHAR(10),
                                            @USER_ID INT=@USERID,
                                                    @SESSION_ID INT=@SESSIONID,
                                                    @SHIFT  CHAR(1)='@SHIFT_VALUE'


SELECT @START_SID=MIN(PERIOD_SID) FROM PERIOD P
WHERE CASE WHEN @FREQUENCY='MONTHLY'  THEN Left(DateName( month , DateAdd( month , P.PERIOD_SID , -1 ) ),3)+' '+CONVERT(VARCHAR(4),P.YEAR)
				               WHEN @FREQUENCY='QUARTERLY'  THEN 'Q'+CONVERT(VARCHAR(4),P.QUARTER)+' '+CONVERT(VARCHAR(4),P.YEAR) 
							   WHEN @FREQUENCY='SEMI-ANNUALLY'  THEN 'S'+CONVERT(VARCHAR(4),P.SEMI_ANNUAL)+' '+CONVERT(VARCHAR(4),P.YEAR) 
							   WHEN @FREQUENCY='ANNUALLY'  THEN CONVERT(VARCHAR(4),P.YEAR) 
				          END =@START
SELECT @END_SID=MAX(PERIOD_SID) FROM PERIOD P
WHERE CASE WHEN @FREQUENCY='MONTHLY'  THEN Left(DateName( month , DateAdd( month , P.PERIOD_SID , -1 ) ),3)+' '+CONVERT(VARCHAR(4),P.YEAR)
				               WHEN @FREQUENCY='QUARTERLY'  THEN 'Q'+CONVERT(VARCHAR(4),P.QUARTER)+' '+CONVERT(VARCHAR(4),P.YEAR) 
							   WHEN @FREQUENCY='SEMI-ANNUALLY'  THEN 'S'+CONVERT(VARCHAR(4),P.SEMI_ANNUAL)+' '+CONVERT(VARCHAR(4),P.YEAR) 
							   WHEN @FREQUENCY='ANNUALLY'  THEN CONVERT(VARCHAR(4),P.YEAR) 
				          END =@END

SET @SQL=';WITH CTE 
     AS (SELECT B.CONTRACT_MASTER_SID, 
	            CN.CONTRACT_ID,CN.CONTRACT_NAME,
                B.COMPANY_MASTER_SID, 
				CM.COMPANY_ID,CM.COMPANY_NAME,
                B.ITEM_MASTER_SID, 
				IM.ITEM_ID,
				IM.ITEM_NAME,
                BM.BRAND_MASTER_SID,
				BM.BRAND_ID,
				BM.BRAND_NAME,
                A.RS_MODEL_SID,
				RS.RS_ID,RS_NAME,'
				SET @SQL+=CASE WHEN @FREQUENCY='MONTHLY' THEN 'Left(DateName( month , DateAdd( month , P.PERIOD_SID , -1 ) ),3)+'' ''+CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
				               WHEN @FREQUENCY='QUARTERLY'  THEN '''Q''+'+'CONVERT(VARCHAR(4),P.QUARTER)+'' ''+CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
							   WHEN @FREQUENCY='SEMI-ANNUALLY'  THEN '''S''+'+'CONVERT(VARCHAR(4),P.SEMI_ANNUAL)+'' ''+CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
							   WHEN @FREQUENCY='ANNUALLY'  THEN 'CONVERT(VARCHAR(4),P.YEAR) AS PERIOD,'
				          END 
                SET @SQL+='P.PERIOD_SID,ARP.DEMAND_ACCRUAL, 
				ARP.DEMAND_ACCRUAL_REFORECAST,
				ARP.TOTAL_DEMAND_ACCRUAL,
				ARP.PROJ_TOTAL_DEMAND_ACCRUAL,
				ARP.VARIANCE  AS VARIANCE,
				ARP.OVERRIDE' 
	     SET @SQL+=CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN ',RS_CAT.DESCRIPTION AS RS_CATEGORY'
				               WHEN @CONDITION='DEDUCTION TYPE' THEN ',RS_TYP.DESCRIPTION AS RS_TYPE'
							   WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN ',RS_PGM_TYP.DESCRIPTION AS REBATE_PROGRAM_TYPE'
							   WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN ',DC2.DESCRIPTION AS DEDUCTION_CATEGORY_2'
							   WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN ',DC3.DESCRIPTION AS DEDUCTION_CATEGORY_3'
							   WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN ',DC4.DESCRIPTION AS DEDUCTION_CATEGORY_4'
							   WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN ',DC5.DESCRIPTION AS DEDUCTION_CATEGORY_5'
							   WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN ',DC6.DESCRIPTION AS DEDUCTION_CATEGORY_6'
							   ELSE ''
						  END
		 SET @SQL+=' FROM   ARM_ADJUSTMENT_DETAILS A 
                JOIN CCP_DETAILS B 
                  ON A.CCP_DETAILS_SID = B.CCP_DETAILS_SID 
                JOIN ITEM_MASTER IM 
                  ON IM.ITEM_MASTER_SID = B.ITEM_MASTER_SID 
                JOIN BRAND_MASTER BM 
                  ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
                JOIN ARM_DEMAND_ADJ_SUMMARY ARP 
                  ON ARP.ARM_ADJUSTMENT_DETAILS_SID = A.ARM_ADJUSTMENT_DETAILS_SID 
				JOIN PERIOD P ON P.PERIOD_SID=ARP.PERIOD_SID
				JOIN CONTRACT_MASTER CN 
				  ON CN.CONTRACT_MASTER_SID=B.CONTRACT_MASTER_SID 
				JOIN COMPANY_MASTER CM
				  ON CM.COMPANY_MASTER_SID=B.COMPANY_MASTER_SID
				JOIN RS_CONTRACT RS 
				  ON RS.RS_MODEL_SID=A.RS_MODEL_SID AND RS.CONTRACT_MASTER_SID=B.CONTRACT_MASTER_SID 
				JOIN ARM_DEDUCTION_SELECTION ADS 
				  ON ADS.PROJECTION_MASTER_SID=A.PROJECTION_MASTER_SID AND ADS.RS_CONTRACT_SID=RS.RS_CONTRACT_SID'
				SET @SQL+=CASE WHEN @CONDITION IN ('DEDUCTION CATEGORY 2','DEDUCTION CATEGORY 3','DEDUCTION CATEGORY 4','DEDUCTION CATEGORY 5','DEDUCTION CATEGORY 6') THEN '  
                                LEFT JOIN UDCS U ON U.MASTER_TYPE=''RS_CONTRACT'' AND U.MASTER_SID=RS.RS_CONTRACT_SID' ELSE '' END
				SET @SQL+=CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN ' JOIN HELPER_TABLE RS_CAT ON RS_CAT.HELPER_TABLE_SID=RS.RS_CATEGORY'
				               WHEN @CONDITION='DEDUCTION TYPE' THEN ' JOIN HELPER_TABLE RS_TYP ON RS_TYP.HELPER_TABLE_SID=RS.RS_TYPE'
							   WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN ' JOIN HELPER_TABLE RS_PGM_TYP 
                                                                            ON RS_PGM_TYP.HELPER_TABLE_SID=RS.REBATE_PROGRAM_TYPE'
							   WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN ' JOIN HELPER_TABLE DC2 ON DC2.HELPER_TABLE_SID=U.UDC2'
							   WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN ' JOIN HELPER_TABLE DC3 ON DC3.HELPER_TABLE_SID=U.UDC3'
							   WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN ' JOIN HELPER_TABLE DC4 ON DC4.HELPER_TABLE_SID=U.UDC4'
							   WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN ' JOIN HELPER_TABLE DC5 ON DC5.HELPER_TABLE_SID=U.UDC5'
							   WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN ' JOIN HELPER_TABLE DC6 ON DC6.HELPER_TABLE_SID=U.UDC6'
							   ELSE ''
						  END
        SET @SQL+=' WHERE  A.PROJECTION_MASTER_SID = '+CONVERT(VARCHAR(10),@PROJECTION_MASTER_SID)
	SET @SQL+=CASE WHEN @CONDITION='DEDUCTION' THEN ' AND RS.RS_ID IN ('+@CONDITION_VALUE+')' WHEN @CONDITION='DEDUCTION CATEGORY' THEN  
            ' AND RS_CAT.DESCRIPTION IN ('+@CONDITION_VALUE+')' 
	 WHEN @CONDITION='DEDUCTION TYPE' THEN ' AND RS_TYP.DESCRIPTION IN ('+@CONDITION_VALUE+')'  
	 WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN ' AND RS_PGM_TYP.DESCRIPTION IN ('+@CONDITION_VALUE+')'
	 WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN ' AND DC2.DESCRIPTION IN ('+@CONDITION_VALUE+')'
	 WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN ' AND DC3.DESCRIPTION IN ('+@CONDITION_VALUE+')'
	 WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN ' AND DC4.DESCRIPTION IN ('+@CONDITION_VALUE+')'
	 WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN ' AND DC5.DESCRIPTION IN ('+@CONDITION_VALUE+')'
	 WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN ' AND DC6.DESCRIPTION IN ('+@CONDITION_VALUE+')'
	 ELSE '' END SET @SQL+=' AND P.PERIOD_SID BETWEEN '+CONVERT(VARCHAR(10),@START_SID)+' AND '+CONVERT(VARCHAR(10),@END_SID)+'),'

IF OBJECT_ID('tempdb..#TEMP_TABLE')IS NOT NULL
DROP TABLE #TEMP_TABLE

CREATE TABLE #TEMP_TABLE
(
	ID INT IDENTITY(1,1),
	STRING CHAR(2),
	COLUMN_NAME VARCHAR(50),
	COLUMN_ADD_NAME VARCHAR(50),
	ALIAS_NAME VARCHAR(50)
)
--LEFT(@String, LEN(@String) - 1) 
INSERT INTO #TEMP_TABLE(STRING,COLUMN_NAME,COLUMN_ADD_NAME,ALIAS_NAME)
SELECT token,CASE WHEN token='B' THEN 'BRAND_MASTER_SID'  
				  WHEN token='I' THEN 'ITEM_MASTER_SID'
				  WHEN token='T' THEN 'COMPANY_MASTER_SID'
				  WHEN token='C' THEN 'CONTRACT_MASTER_SID'
				  WHEN token='D' THEN 'RS_MODEL_SID'
				  WHEN token='RC' THEN 'RS_CATEGORY'
				  WHEN token='RT' THEN 'RS_TYPE'
				  WHEN token='RCB' THEN 'REBATE_PROGRAM_TYPE'
				  WHEN token='U2' THEN 'DEDUCTION_CATEGORY_2'
				  WHEN token='U3' THEN 'DEDUCTION_CATEGORY_3'
				  WHEN token='U4' THEN 'DEDUCTION_CATEGORY_4'
				  WHEN token='U5' THEN 'DEDUCTION_CATEGORY_5'
				  WHEN token='U6' THEN 'DEDUCTION_CATEGORY_6'
		     END AS COLUMN_NAME,
			 CASE WHEN token='B' THEN 'BRAND_ID+'' - ''+BRAND_NAME'  
				  WHEN token='I' THEN 'ITEM_ID+'' - ''+ITEM_NAME'
				  WHEN token='T' THEN 'COMPANY_ID+'' - ''+COMPANY_NAME'
				  WHEN token='C' THEN 'CONTRACT_ID+'' - ''+CONTRACT_NAME' 
				  WHEN token='D' THEN 'RS_ID+'' - ''+RS_NAME'
		     END AS COLUMN_ADD_NAME,
			 CASE WHEN token='B' THEN 'BRAND '  
				  WHEN token='I' THEN 'ITEM '
				  WHEN token='T' THEN 'COMPANY'
				  WHEN token='C' THEN 'CONTRACT'
				  WHEN token='D' THEN 'DEDUCTION'
		     END AS ALIAS_NAME
FROM udf_splitstring(@LEVEL,',')

SELECT  @MAX_VAL=MAX(ID) FROM #TEMP_TABLE

WHILE(@I<=@MAX_VAL)

BEGIN
 SELECT 
    @SQL_SELECT=
    STUFF((
        SELECT ', NULL AS ' + U.COLUMN_NAME +', NULL AS ' +U.ALIAS_NAME
        FROM #TEMP_TABLE U
        WHERE U.ID = ID AND U.ID>@I
        ORDER BY U.ID
        FOR XML PATH('')
    ),1,1,'') ,
	@SQL_COUNT=
	STUFF((
        SELECT ', 0 AS ' + U.COLUMN_NAME +', ''TOTAL'' AS ' +U.ALIAS_NAME
        FROM #TEMP_TABLE U
        WHERE U.ID = ID AND U.ID>=1
        ORDER BY U.ID
        FOR XML PATH('')
    ),1,1,'') ,
	@SQL_ADD_COUNT=
	STUFF((
        SELECT ', NULL AS ' + U.ALIAS_NAME 
        FROM #TEMP_TABLE U
        WHERE U.ID = ID AND U.ID>@I
        ORDER BY U.ID
        FOR XML PATH('')
    ),1,1,'') 
FROM #TEMP_TABLE
 SET   @SQL_SELECT+=','
 SET   @SQL_ADD_COUNT+=','
 SET @SQL_SELECT=ISNULL(@SQL_SELECT,'')
 SET @SQL_ADD_COUNT=ISNULL(@SQL_ADD_COUNT,'')
 SET @SQL_COUNT=ISNULL(@SQL_COUNT,'')
 SELECT @LEV=STRING FROM #TEMP_TABLE WHERE ID=@I
 SELECT @VAR=@VAR+COLUMN_NAME+','+COLUMN_ADD_NAME+' AS '+ALIAS_NAME+',', @SQL_UNION=STRING FROM #TEMP_TABLE WHERE ID=@I
 SELECT @VAR_ADD+=CASE WHEN @I=1 THEN '' ELSE ',' END +COLUMN_NAME+','+COLUMN_ADD_NAME+',' FROM #TEMP_TABLE WHERE ID=@I

 SELECT @SQL_OUTER_SELECT+='SELECT * FROM '+@SQL_UNION+' UNION ALL '
 SET @VAR_ADD=LEFT(@VAR_ADD, LEN(@VAR_ADD) - 1)
 SET @SQL_TEMP+=',' +@SQL_UNION+' AS (SELECT '+@VAR+@SQL_SELECT+CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN 'RS_CATEGORY,'
				               WHEN @CONDITION='DEDUCTION TYPE' THEN 'RS_TYPE,'
							   WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN 'REBATE_PROGRAM_TYPE,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN 'DEDUCTION_CATEGORY_2,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN 'DEDUCTION_CATEGORY_3,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN 'DEDUCTION_CATEGORY_4,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN 'DEDUCTION_CATEGORY_5,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN 'DEDUCTION_CATEGORY_6,'
							   WHEN @CONDITION='DEDUCTION' THEN 'RS_ID,'
							   ELSE ''
						  END+'  ISNULL(SUM(DEMAND_ACCRUAL),0)                       AS DEMAND_ACCRUAL,
            ISNULL(SUM(DEMAND_ACCRUAL_REFORECAST),0) AS DEMAND_ACCRUAL_REFORECAST,
			ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0) AS TOTAL_DEMAND_ACCRUAL,
			ISNULL(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0) AS PROJ_TOTAL_DEMAND_ACCRUAL,
			COALESCE(ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0)/NULLIF(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0),0)*100 AS DEMAND_ACCRUAL_RATIO,
			ISNULL(SUM(VARIANCE),0) AS VARIANCE,'
             SET @SQL_TEMP+=CASE WHEN @LEV='I' THEN 'SUM(OVERRIDE) AS OVERRIDE,' ELSE 'NULL AS OVERRIDE,' END
             SET @SQL_TEMP+='COALESCE(SUM(ISNULL(OVERRIDE,VARIANCE)),0) AS ADJUSTMENT, PERIOD
			FROM   CTE 

         GROUP  BY '+@VAR_ADD+CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN ',RS_CATEGORY,'
				               WHEN @CONDITION='DEDUCTION TYPE' THEN ',RS_TYPE,'
							   WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN ',REBATE_PROGRAM_TYPE,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN ',DEDUCTION_CATEGORY_2,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN ',DEDUCTION_CATEGORY_3,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN ',DEDUCTION_CATEGORY_4,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN ',DEDUCTION_CATEGORY_5,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN ',DEDUCTION_CATEGORY_6,'
							   WHEN @CONDITION='DEDUCTION' THEN ',RS_ID,'
							   ELSE '' 
						  END+ 
		 'PERIOD)'
 SET @I+=1


END

SET @SQL_OUTER_SELECT=LEFT(@SQL_OUTER_SELECT, LEN(@SQL_OUTER_SELECT) - 10) 
SET @SQL+='TOTAL AS (SELECT '+@SQL_COUNT+','+CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN 'RS_CATEGORY,'
				               WHEN @CONDITION='DEDUCTION TYPE' THEN 'RS_TYPE,'
							   WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN 'REBATE_PROGRAM_TYPE,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN 'DEDUCTION_CATEGORY_2,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN 'DEDUCTION_CATEGORY_3,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN 'DEDUCTION_CATEGORY_4,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN 'DEDUCTION_CATEGORY_5,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN 'DEDUCTION_CATEGORY_6,'
							   WHEN @CONDITION='DEDUCTION' THEN 'RS_ID,'
							   ELSE ''
						  END+'  ISNULL(SUM(DEMAND_ACCRUAL),0)                       AS DEMAND_ACCRUAL,
            ISNULL(SUM(DEMAND_ACCRUAL_REFORECAST),0) AS DEMAND_ACCRUAL_REFORECAST,
			ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0) AS TOTAL_DEMAND_ACCRUAL,
			ISNULL(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0) AS PROJ_TOTAL_DEMAND_ACCRUAL,
			COALESCE(ISNULL(SUM(TOTAL_DEMAND_ACCRUAL),0)/NULLIF(SUM(PROJ_TOTAL_DEMAND_ACCRUAL),0),0)*100 AS DEMAND_ACCRUAL_RATIO,
			ISNULL(SUM(VARIANCE),0) AS VARIANCE,
			NULL AS OVERRIDE,
			COALESCE(SUM(ISNULL(OVERRIDE,VARIANCE)),0) AS ADJUSTMENT,PERIOD
			FROM   CTE 
         GROUP  BY '+CASE WHEN @CONDITION='DEDUCTION CATEGORY' THEN 'RS_CATEGORY,'
				               WHEN @CONDITION='DEDUCTION TYPE' THEN 'RS_TYPE,'
							   WHEN @CONDITION='DEDUCTION PROGRAM TYPE' THEN 'REBATE_PROGRAM_TYPE,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 2' THEN 'DEDUCTION_CATEGORY_2,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 3' THEN 'DEDUCTION_CATEGORY_3,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 4' THEN 'DEDUCTION_CATEGORY_4,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 5' THEN 'DEDUCTION_CATEGORY_5,'
							   WHEN @CONDITION='DEDUCTION CATEGORY 6' THEN 'DEDUCTION_CATEGORY_6,'
							   WHEN @CONDITION='DEDUCTION' THEN 'RS_ID,'
							   ELSE '' 
						  END+ 
		 'PERIOD)'+@SQL_TEMP

SET @SQL+='SELECT * FROM TOTAL UNION ALL '+@SQL_OUTER_SELECT


 EXECUTE (@SQL)

]]> 
        </query> 
    </entity>    
    
    <entity id="update_demand_overridecolumn">

        <query>
                    <![CDATA[
                     IF OBJECT_ID('TEMPDB..#TEMP_AMOUNT') IS NOT NULL 
  DROP TABLE #TEMP_AMOUNT 

CREATE TABLE #TEMP_AMOUNT 
  ( 
     ARM_ADJUSTMENT_DETAILS_SID INT, 
     PERIOD_SID                 INT, 
     ACCRUAL_AMOUNT             NUMERIC(22, 6), 
     INDICATOR                  BIT 
  ) 

INSERT INTO #TEMP_AMOUNT 
            (ARM_ADJUSTMENT_DETAILS_SID, 
             PERIOD_SID, 
             ACCRUAL_AMOUNT, 
             INDICATOR) 
SELECT ARM_ADJUSTMENT_DETAILS_SID, 
       PERIOD_SID, 
       ISNULL(OVERRIDE, VARIANCE) AS ACCRUAL_AMOUNT, 
       CASE 
         WHEN ISNULL(OVERRIDE, VARIANCE) > 0 THEN 0 
         WHEN ISNULL(OVERRIDE, VARIANCE) < 0 THEN 1 
       END                        AS INDICATOR 
FROM   ? 
WHERE  OVERRIDE IS NOT NULL 
       AND OVERRIDE != 0 

IF OBJECT_ID('TEMPDB..#CURRENT_LIABILITY') IS NOT NULL 
  DROP TABLE #CURRENT_LIABILITY 

CREATE TABLE #CURRENT_LIABILITY 
  ( 
     ARM_ADJUSTMENT_DETAILS_SID INT, 
     PERIOD_SID                 INT, 
     CREDIT_AMOUNT              NUMERIC(22, 6), 
     DEBIT_AMOUNT               NUMERIC(22, 6), 
     CURRENT_AMOUNT             NUMERIC(22, 6) 
  ) 

IF OBJECT_ID('TEMPDB..#CURRENT_EXPENSE') IS NOT NULL 
  DROP TABLE #CURRENT_EXPENSE 

CREATE TABLE #CURRENT_EXPENSE 
  ( 
     ARM_ADJUSTMENT_DETAILS_SID INT, 
     PERIOD_SID                 INT, 
     CREDIT_AMOUNT              NUMERIC(22, 6), 
     DEBIT_AMOUNT               NUMERIC(22, 6), 
     CURRENT_AMOUNT             NUMERIC(22, 6) 
  ) 

INSERT INTO #CURRENT_LIABILITY 
            (ARM_ADJUSTMENT_DETAILS_SID, 
             PERIOD_SID, 
             CREDIT_AMOUNT, 
             DEBIT_AMOUNT, 
             CURRENT_AMOUNT) 
SELECT TAM.ARM_ADJUSTMENT_DETAILS_SID, 
       ISNULL(A1.PERIOD_SID, A2.PERIOD_SID), 
       SUM(ABS(A1.ACCRUAL_AMOUNT))                                                     AS CREDIT_AMOUNT,
       SUM(ABS(A2.ACCRUAL_AMOUNT))                                                     AS DEBIT_AMOUNT,
       ISNULL(SUM(ABS(A1.ACCRUAL_AMOUNT)), 0) - ISNULL(SUM(ABS(A2.ACCRUAL_AMOUNT)), 0) AS CURRENT_AMOUNT
FROM   #TEMP_AMOUNT TAM 
       JOIN ARM_ADJ_RES_CCP AAC 
         ON TAM.ARM_ADJUSTMENT_DETAILS_SID = AAC.ARM_ADJUSTMENT_DETAILS_SID 
       INNER JOIN HELPER_TABLE HT 
               ON AAC.ACCOUNT_TYPE = HT.HELPER_TABLE_SID 
                  AND HT.DESCRIPTION = 'LIABILITY' 
       LEFT JOIN #TEMP_AMOUNT A1 
              ON AAC.ARM_ADJUSTMENT_DETAILS_SID = A1.ARM_ADJUSTMENT_DETAILS_SID 
                 AND AAC.CREDIT = A1.INDICATOR 
       LEFT JOIN #TEMP_AMOUNT A2 
              ON AAC.ARM_ADJUSTMENT_DETAILS_SID = A2.ARM_ADJUSTMENT_DETAILS_SID 
                 AND AAC.DEBIT = A2.INDICATOR 
GROUP  BY TAM.ARM_ADJUSTMENT_DETAILS_SID, 
          ISNULL(A1.PERIOD_SID, A2.PERIOD_SID) 

INSERT INTO #CURRENT_EXPENSE 
SELECT TAM.ARM_ADJUSTMENT_DETAILS_SID, 
       ISNULL(A1.PERIOD_SID, A2.PERIOD_SID), 
       SUM(ABS(A1.ACCRUAL_AMOUNT))                                                     AS CREDIT_AMOUNT,
       SUM(ABS(A2.ACCRUAL_AMOUNT))                                                     AS DEBIT_AMOUNT,
       ISNULL(SUM(ABS(A1.ACCRUAL_AMOUNT)), 0) - ISNULL(SUM(ABS(A2.ACCRUAL_AMOUNT)), 0) AS CURRENT_AMOUNT
FROM   #TEMP_AMOUNT TAM 
       JOIN ARM_ADJ_RES_CCP AAC 
         ON TAM.ARM_ADJUSTMENT_DETAILS_SID = AAC.ARM_ADJUSTMENT_DETAILS_SID 
       INNER JOIN HELPER_TABLE HT 
               ON AAC.ACCOUNT_TYPE = HT.HELPER_TABLE_SID 
                  AND HT.DESCRIPTION = 'EXPENSE' 
       LEFT JOIN #TEMP_AMOUNT A1 
              ON AAC.ARM_ADJUSTMENT_DETAILS_SID = A1.ARM_ADJUSTMENT_DETAILS_SID 
                 AND AAC.CREDIT = A1.INDICATOR 
       LEFT JOIN #TEMP_AMOUNT A2 
              ON AAC.ARM_ADJUSTMENT_DETAILS_SID = A2.ARM_ADJUSTMENT_DETAILS_SID 
                 AND AAC.DEBIT = A2.INDICATOR 
GROUP  BY TAM.ARM_ADJUSTMENT_DETAILS_SID, 
          ISNULL(A1.PERIOD_SID, A2.PERIOD_SID) 

UPDATE T 
SET    T.LIABILITY_AMOUNT = LIA.CURRENT_AMOUNT, 
       T.EXPENSE_AMOUNT = CEX.CURRENT_AMOUNT 
FROM   ? T 
       LEFT JOIN #CURRENT_LIABILITY LIA 
              ON T.ARM_ADJUSTMENT_DETAILS_SID = LIA.ARM_ADJUSTMENT_DETAILS_SID 
                 AND T.PERIOD_SID = LIA.PERIOD_SID 
       LEFT JOIN #CURRENT_EXPENSE CEX 
              ON T.ARM_ADJUSTMENT_DETAILS_SID = CEX.ARM_ADJUSTMENT_DETAILS_SID 
                 AND T.PERIOD_SID = CEX.PERIOD_SID 
                      ]]>  
        </query>

    </entity>
    
</sql>
