<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->

<sql>
   
    <entity id="NM_SALES_PROJECTION_CHECK_RECORD_UPDATE">
        <query> 
                    <![CDATA[
       
DECLARE  @PROJECTION_MASTER_SID INT =?,
@CUSTOM_VIEW_MASTER_SID INT = ?,
@CUST_HIERARCHY_NO VARCHAR(500)= '?',
@PROD_HIERARCHY_NO VARCHAR(500)= '?',
@CUST_LEVEL_NO VARCHAR(20)= '?',
@PROD_LEVEL_NO VARCHAR(20)= '?',
@USER_ID INT =?,
@SESSION_ID INT = ?,
@CHECK_RECORD BIT=?

;WITH CCPMAPC 
     AS (SELECT RLD.RELATIONSHIP_LEVEL_VALUES, 
                RLD.HIERARCHY_NO, 
                CCP.CCP_DETAILS_SID ,
				PROJECTION_DETAILS_SID
         FROM   RELATIONSHIP_LEVEL_DEFINITION RLD 
                JOIN CCP_MAP CCP 
                  ON RLD.RELATIONSHIP_LEVEL_SID = CCP.RELATIONSHIP_LEVEL_SID 
                JOIN PROJECTION_DETAILS PD 
                  ON PD.CCP_DETAILS_SID = CCP.CCP_DETAILS_SID 
                     AND PD.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID), 
     HLDC 
     AS (SELECT RLD2.HIERARCHY_NO, 
                RLD2.RELATIONSHIP_LEVEL_SID, 
                CVD.LEVEL_NO 
         FROM   DBO.CUSTOM_VIEW_DETAILS CVD 
                JOIN DBO.CUSTOM_VIEW_MASTER CVM 
                  ON CVD.CUSTOM_VIEW_MASTER_SID = @CUSTOM_VIEW_MASTER_SID 
                     AND CVD.LEVEL_NO LIKE @CUST_LEVEL_NO
                JOIN DBO.HIERARCHY_LEVEL_DEFINITION HLD 
                  ON CVD.HIERARCHY_ID = HLD.HIERARCHY_LEVEL_DEFINITION_SID 
                JOIN RELATIONSHIP_LEVEL_DEFINITION RLD2 
                  ON HLD.HIERARCHY_LEVEL_DEFINITION_SID = RLD2.HIERARCHY_LEVEL_DEFINITION_SID
                JOIN PROJECTION_CUST_HIERARCHY PCH2 
                  ON PCH2.RELATIONSHIP_LEVEL_SID = RLD2.RELATIONSHIP_LEVEL_SID 
                     AND PCH2.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 
                     AND RLD2.HIERARCHY_NO LIKE @CUST_HIERARCHY_NO), 
     HLDP 
     AS (SELECT RLD2.HIERARCHY_NO, 
                RLD2.RELATIONSHIP_LEVEL_SID, 
                CVD.LEVEL_NO 
         FROM   DBO.CUSTOM_VIEW_DETAILS CVD 
                JOIN DBO.CUSTOM_VIEW_MASTER CVM 
                  ON CVD.CUSTOM_VIEW_MASTER_SID = @CUSTOM_VIEW_MASTER_SID 
                     AND CVD.LEVEL_NO LIKE @PROD_LEVEL_NO
                JOIN DBO.HIERARCHY_LEVEL_DEFINITION HLD 
                  ON CVD.HIERARCHY_ID = HLD.HIERARCHY_LEVEL_DEFINITION_SID 
                JOIN RELATIONSHIP_LEVEL_DEFINITION RLD2 
                  ON HLD.HIERARCHY_LEVEL_DEFINITION_SID = RLD2.HIERARCHY_LEVEL_DEFINITION_SID
                JOIN PROJECTION_PROD_HIERARCHY PCH2 
                  ON PCH2.RELATIONSHIP_LEVEL_SID = RLD2.RELATIONSHIP_LEVEL_SID 
                     AND PCH2.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 
                     AND RLD2.HIERARCHY_NO LIKE @PROD_HIERARCHY_NO) 
UPDATE ST_NM_SALES_PROJECTION_MASTER  SET   CHECK_RECORD=@CHECK_RECORD  WHERE PROJECTION_DETAILS_SID   IN (
SELECT DISTINCT CCPMAPC.PROJECTION_DETAILS_SID
FROM   CCPMAPC CCPMAPC 
       JOIN CCPMAPC CCPMAPP 
         ON CCPMAPC.CCP_DETAILS_SID = CCPMAPP.CCP_DETAILS_SID 
       JOIN HLDC 
         ON CCPMAPC.HIERARCHY_NO LIKE HLDC.HIERARCHY_NO + '%' 
       JOIN HLDP 
         ON CCPMAPP.HIERARCHY_NO LIKE HLDP.HIERARCHY_NO + '%' )
AND USER_ID = @USER_ID AND SESSION_ID = @SESSION_ID  
                    ]]>
        </query>
    </entity>
  
        
</sql>