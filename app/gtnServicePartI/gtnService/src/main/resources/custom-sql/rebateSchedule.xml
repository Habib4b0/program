<?xml version="1.0"?>

<custom-sql>
	<sql id="getItemDetailsOfIfp">
		<![CDATA[
SELECT IFD.IFP_MODEL_SID,IM.ITEM_NO,IM.ITEM_NAME,IM.ITEM_TYPE,IM.ITEM_MASTER_SID,
IM.ITEM_ID 
FROM IFP_DETAILS IFD,ITEM_MASTER IM 
WHERE IFD.ITEM_MASTER_SID = IM.ITEM_MASTER_SID 
		]]>
	</sql>


	<sql id="getRebateScheduleDetails">
		<![CDATA[
                    SELECT  
                        RSD.IFP_MODEL_SID,IM.ITEM_NO,IM.ITEM_NAME,IM.ITEM_TYPE,
                        IM.ITEM_MASTER_SID
                        ,ISNULL((RSD.REBATE_PLAN_MASTER_SID),0) REBATE_PLAN_SID
                        ,ISNULL((RSD.REBATE_AMOUNT),0) REBATE_AMOUNT,RSD.ITEM_REBATE_START_DATE,
                        RSD.ITEM_REBATE_END_DATE,RSD.ITEM_RS_ATTACHED_STATUS,
                       RSD.ITEM_RS_ATTACHED_DATE,RSD.MODIFIED_DATE,IM.ITEM_ID,RSD.BUNDLE_NO,RPM.REBATE_PLAN_NO,RPM.REBATE_PLAN_NAME,DC.DEDUCTION_CALENDAR_MASTER_SID,DC.DEDUCTION_CALENDAR_NO,DC.DEDUCTION_CALENDAR_NAME,NSF.NET_SALES_FORMULA_MASTER_SID,
                        NSF.NET_SALES_FORMULA_NO,NET_SALES_RULE,EVALUATION_RULE,CALCULATION_RULE,EVALUATION_RULE_BUNDLE,CALCULATION_RULE_BUNDLE ,RSD.formula_id ,FF.FORMULA_NAME,FF.FORMULA_NO 
                    FROM 
                        RS_DETAILS RSD
                    JOIN  
                        ITEM_MASTER IM 
                            ON RSD.ITEM_MASTER_SID = IM.ITEM_MASTER_SID
                    LEFT JOIN  
                        REBATE_PLAN_MASTER RPM 
                            ON RSD.REBATE_PLAN_MASTER_SID = RPM.REBATE_PLAN_MASTER_SID
                    LEFT JOIN  
                       DEDUCTION_CALENDAR_MASTER DC ON RSD.DEDUCTION_CALENDAR_MASTER_SID =  DC.DEDUCTION_CALENDAR_MASTER_SID  
                    LEFT JOIN  
                       NET_SALES_FORMULA_MASTER NSF ON RSD.NET_SALES_FORMULA_MASTER_SID =  NSF.NET_SALES_FORMULA_MASTER_SID  
                    LEFT JOIN dbo.FORECASTING_FORMULA FF on FF.FORECASTING_FORMULA_SID = RSD.FORMULA_ID 
                    WHERE 
                        RSD.RS_MODEL_SID = @RSD.RS_MODEL_SID     
                        AND RSD.INBOUND_STATUS <> 'D'
		]]>
        </sql>

        <sql id="mergeRsDetails">
		<![CDATA[
 MERGE dbo.RS_Details AS Target USING ( SELECT RS_DETAILS_SID,  RS_MODEL_SID, ITEM_MASTER_SID, RS_DETAILS_ATTACHED_STATUS, RS_DETAILS_ATTACHED_DATE,  MODIFIED_DATE,
 ITEM_REBATE_START_DATE,  ITEM_REBATE_END_DATE, RS_DETAILS_REBATE_AMOUNT, RS_DETAILS_FORMULA_ID, IFP_MODEL_SID, RS_DETAILS_CREATED_BY, CREATED_DATE ,
 RS_DETAILS_MODIFIED_BY,"Operation" as  INBOUND_STATUS, RS_DETAILS_FORMULA_METHOD_ID, REBATE_PLAN_MASTER_SID,  
 RS_DETAILS_BUNDLE_NO,DEDUCTION_CALENDAR_MASTER_SID,NET_SALES_FORMULA_MASTER_SID,NET_SALES_RULE,EVALUATION_RULE,CALCULATION_RULE,EVALUATION_RULE_BUNDLE,CALCULATION_RULE_BUNDLE from dbo.IMTD_RS_DETAILS WHERE USERS_SID='[$USERS_SID]' and
 SESSION_ID='[$SESSION_ID]' and "Operation" = 'A' and CHECK_RECORD=1) 
 AS Source ON 
 (Target.RS_MODEL_SID = Source.RS_MODEL_SID AND Target.IFP_MODEL_SID= Source.IFP_MODEL_SID AND
 Target.ITEM_MASTER_SID=Source.ITEM_MASTER_SID )
 WHEN MATCHED THEN UPDATE SET 
 Target.ITEM_RS_ATTACHED_STATUS = Source.RS_DETAILS_ATTACHED_STATUS, Target.ITEM_RS_ATTACHED_DATE = Source.RS_DETAILS_ATTACHED_DATE, 
 Target.MODIFIED_DATE = convert(datetime,'[$CURRENT_DATE]'), Target.ITEM_REBATE_START_DATE = Source.ITEM_REBATE_START_DATE, Target.ITEM_REBATE_END_DATE = Source.ITEM_REBATE_END_DATE, 
 Target.REBATE_AMOUNT = Source.RS_DETAILS_REBATE_AMOUNT, Target.FORMULA_ID = Source.RS_DETAILS_FORMULA_ID,Target.MODIFIED_BY = Source.RS_DETAILS_MODIFIED_BY,
 Target.FORMULA_METHOD_ID = Source.RS_DETAILS_FORMULA_METHOD_ID, Target.BUNDLE_NO=Source.RS_DETAILS_BUNDLE_NO ,Target.IFP_MODEL_SID=Source.IFP_MODEL_SID,
 Target.REBATE_PLAN_MASTER_SID = Source.REBATE_PLAN_MASTER_SID, Target.INBOUND_STATUS = 'A',Target.RECORD_LOCK_STATUS = 'false' ,
 Target.DEDUCTION_CALENDAR_MASTER_SID = Source.DEDUCTION_CALENDAR_MASTER_SID, Target.NET_SALES_FORMULA_MASTER_SID = Source.NET_SALES_FORMULA_MASTER_SID,
 Target.NET_SALES_RULE=Source.NET_SALES_RULE,Target.EVALUATION_RULE=Source.EVALUATION_RULE,Target.CALCULATION_RULE=Source.CALCULATION_RULE,Target.EVALUATION_RULE_BUNDLE=Source.EVALUATION_RULE_BUNDLE,Target.CALCULATION_RULE_BUNDLE=Source.CALCULATION_RULE_BUNDLE 
WHEN NOT MATCHED BY Target then
 Insert (RS_MODEL_SID,ITEM_MASTER_SID,ITEM_RS_ATTACHED_STATUS, ITEM_RS_ATTACHED_DATE, MODIFIED_DATE, ITEM_REBATE_START_DATE,
 ITEM_REBATE_END_DATE, REBATE_AMOUNT, FORMULA_ID, IFP_MODEL_SID, CREATED_BY, CREATED_DATE, MODIFIED_BY, INBOUND_STATUS, FORMULA_METHOD_ID, REBATE_PLAN_MASTER_SID,  BUNDLE_NO,DEDUCTION_CALENDAR_MASTER_SID,
NET_SALES_FORMULA_MASTER_SID,NET_SALES_RULE,EVALUATION_RULE,CALCULATION_RULE,EVALUATION_RULE_BUNDLE,CALCULATION_RULE_BUNDLE) 
 values (Source.RS_MODEL_SID, Source.ITEM_MASTER_SID,Source.RS_DETAILS_ATTACHED_STATUS, Source.RS_DETAILS_ATTACHED_DATE, Source.MODIFIED_DATE,Source.ITEM_REBATE_START_DATE,
 Source.ITEM_REBATE_END_DATE,Source.RS_DETAILS_REBATE_AMOUNT,Source.RS_DETAILS_FORMULA_ID,Source.IFP_MODEL_SID, Source.RS_DETAILS_CREATED_BY,Source.CREATED_DATE ,
 Source.RS_DETAILS_MODIFIED_BY, Source.INBOUND_STATUS, Source.RS_DETAILS_FORMULA_METHOD_ID, Source.REBATE_PLAN_MASTER_SID,Source.RS_DETAILS_BUNDLE_NO,Source.DEDUCTION_CALENDAR_MASTER_SID,
Source.NET_SALES_FORMULA_MASTER_SID,Source.NET_SALES_RULE,Source.EVALUATION_RULE,Source.CALCULATION_RULE,Source.EVALUATION_RULE_BUNDLE,Source.CALCULATION_RULE_BUNDLE);
		]]>
        </sql>


	<!-- Actual Query is 
	SELECT RSD.ITEM_FAMILYPLAN_SYSTEM_ID,IM.ITEM_NO,IM.ITEM_NAME,IM.ITEM_TYPE, 
		IM.ITEM_SYSTEM_ID ,RPM.REBATE_PLAN_NAME ,RSD.REBATE_AMOUNT,RSD.ITEM_START_DATE,RSD.ITEM_END_DATE,IM.ITEM_ID 
		FROM REBATE_SCHEDULE_DETAILS RSD,ITEM_MASTER IM ,REBATE_PLAN_MASTER RPM WHERE 
		RSD.ITEM_SYSTEM_ID = IM.ITEM_SYSTEM_ID AND RPM.REBATE_PLAN_SYSTEM_ID = RSD.REBATE_PLAN_SYSTEM_ID 
		AND RSD.REBATE_SCHEDULE_SYSTEM_ID = 3 
		-->

</custom-sql>