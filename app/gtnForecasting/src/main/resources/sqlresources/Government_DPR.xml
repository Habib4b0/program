<sql>
   
    <entity id="mmdprgetNonmandatedtotal">
        <query>  <![CDATA[
DECLARE @PROJECTION_MASTER_SID INT = @projID
DECLARE @THERAPEUTIC_CLASS INT
DECLARE @BRAND INT
IF OBJECT_ID('TEMPDB..#INPUT_INFO') IS NOT NULL
DROP TABLE #INPUT_INFO

CREATE TABLE #INPUT_INFO 
  (
     PROJECTION_MASTER_SID  INT,
     CCP_DETAILS_SID        INT,
     ITEM_MASTER_SID        INT,
     COMPANY_MASTER_SID     INT,
     BRAND_MASTER_SID       INT,
     BRAND_NAME             VARCHAR(100),
     THERAPEUTIC_CLASS      INT,
     COMPANY_CATEGORY       INT
  )

INSERT INTO #INPUT_INFO
SELECT @PROJECTION_MASTER_SID,
       PD.CCP_DETAILS_SID,
       C.ITEM_MASTER_SID,
       CM.COMPANY_MASTER_SID,
       IM.BRAND_MASTER_SID,
       BRAND_NAME,
       THERAPEUTIC_CLASS,
       COMPANY_CATEGORY
FROM   ST_CCP_HIERARCHY PD
       INNER JOIN CCP_DETAILS C
               ON C.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
       INNER JOIN ITEM_MASTER IM
               ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
       INNER JOIN BRAND_MASTER B
               ON B.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
       INNER JOIN COMPANY_MASTER CM
               ON CM.COMPANY_MASTER_SID = C.COMPANY_MASTER_SID


SELECT PER.YEAR,
       PER.@frequency_var,
       Sum(B1.PROJECTION_SALES)                                                   PROJECTION_SALES,
       'PROJECTION'                                                               AS TYPE,
       ( COALESCE(Sum(B1.PROJECTION_SALES) / NULLIF(Sum(A1.SALES), 0), 0) * 100 ) AS PROJECTION_RATE,
       ( COALESCE(Sum(B1.PROJECTION_SALES) / NULLIF(Sum(A1.UNITS), 0), 0) )       AS PROJECTION_RPU
FROM   (SELECT BRAND_NAME,
               Sum(SALES) AS SALES,
               Sum(UNITS) AS UNITS,
               PERIOD_SID
        FROM   (SELECT Sum(B.PROJECTION_SALES) AS SALES,
                       Sum(B.PROJECTION_UNITS) AS UNITS,
                       PER.PERIOD_SID,
                       I.BRAND_NAME,
                       I.BRAND_MASTER_SID,
                       I.THERAPEUTIC_CLASS
                FROM   DBO.ST_M_SALES_PROJECTION_MASTER A
                       JOIN DBO.ST_M_SALES_PROJECTION B
                         ON A.CCP_DETAILS_SID = B.CCP_DETAILS_SID
                       JOIN #INPUT_INFO I
                         ON I.CCP_DETAILS_SID = A.CCP_DETAILS_SID
                       JOIN PERIOD PER
                         ON PER.PERIOD_SID = B.PERIOD_SID
             
                GROUP  BY PER.PERIOD_SID,
                          I.BRAND_NAME,
                          I.BRAND_MASTER_SID,
                          I.THERAPEUTIC_CLASS) A
        WHERE  ( A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
                 AND @THERAPEUTIC_CLASS IS NOT NULL
                 AND @BRAND IS NULL )
                OR ( A.BRAND_MASTER_SID = @BRAND
                     AND @BRAND IS NOT NULL
                     AND @THERAPEUTIC_CLASS IS NULL )
                OR ( A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
                     AND A.BRAND_MASTER_SID = @BRAND )
                OR ( @THERAPEUTIC_CLASS IS NULL
                     AND @BRAND IS NULL )
        GROUP  BY A.BRAND_NAME,
                  A.PERIOD_SID) A1
       LEFT JOIN (SELECT BRAND_NAME,
                         Sum(PROJECTION_SALES) AS PROJECTION_SALES,
                         PERIOD_SID
                  FROM   (SELECT BRAND_NAME,
                                 Sum(PROJECTION_SALES) AS PROJECTION_SALES,
                                 PERIOD_SID,
                                 I.BRAND_MASTER_SID,
                                 THERAPEUTIC_CLASS
                          FROM   #INPUT_INFO I
                                 CROSS APPLY (
								 
								  SELECT PROJECTION_MASTER_SID,PROJECTION_DETAILS_SID FROM 
								  (
								 SELECT  PM.PROJECTION_MASTER_SID,
								                      PD.PROJECTION_DETAILS_SID,
								 ROW_NUMBER() OVER(PARTITION BY I.CCP_DETAILS_SID ORDER BY wm.MODIFIED_DATE DESC) RNO
                                              FROM   PROJECTION_MASTER PM
                                                     JOIN WORKFLOW_MASTER WM
                                                       ON PM.PROJECTION_MASTER_SID = WM.PROJECTION_MASTER_SID
                                                          AND WM.WORKFLOW_STATUS_ID = (SELECT HELPER_TABLE_SID
                                                                                       FROM   HELPER_TABLE
                                                                                       WHERE  LIST_NAME = 'WORKFLOWSTATUS'
                                                                                              AND DESCRIPTION = 'APPROVED')
                                                   
												       JOIN PROJECTION_DETAILS PD
                                                       ON pd.PROJECTION_MASTER_SID = PM.PROJECTION_MASTER_SID
												   AND
                                                        I.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
														)A
														WHERE RNO=1

                                              ) CS
                                 JOIN [DBO].[NM_DISCOUNT_PROJECTION] C
                                   ON C.PROJECTION_DETAILS_SID = CS.PROJECTION_DETAILS_SID
                                 JOIN HELPER_TABLE H
                                   ON I.COMPANY_CATEGORY = H.HELPER_TABLE_SID
                          WHERE  I.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
                                 AND H.DESCRIPTION IN ( 'MM MEDI', 'MCG PLAN' )
                          GROUP  BY BRAND_NAME,
                                    PERIOD_SID,
                                    I.BRAND_MASTER_SID,
                                    THERAPEUTIC_CLASS) B
                  WHERE  ( B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
                           AND @THERAPEUTIC_CLASS IS NOT NULL
                           AND @BRAND IS NULL )
                          OR ( B.BRAND_MASTER_SID = @BRAND
                               AND @BRAND IS NOT NULL
                               AND @THERAPEUTIC_CLASS IS NULL )
                          OR ( B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
                               AND B.BRAND_MASTER_SID = @BRAND )
                          OR ( @THERAPEUTIC_CLASS IS NULL
                               AND @BRAND IS NULL )
                  GROUP  BY B.BRAND_NAME,
                            B.PERIOD_SID) B1
              ON A1.BRAND_NAME = B1.BRAND_NAME
                 AND A1.PERIOD_SID = B1.PERIOD_SID
       JOIN PERIOD AS PER
         ON PER.PERIOD_SID = A1.PERIOD_SID
GROUP  BY PER.YEAR,
          PER.@frequency_var
UNION ALL
SELECT PER.YEAR,
       PER.@frequency_var,
       Sum(B1.PROJECTION_SALES)                                                   AS PROJECTION_SALES,
       'ACTUAL'                                                                   AS TYPE,
       ( COALESCE(Sum(B1.PROJECTION_SALES) / NULLIF(Sum(A1.SALES), 0), 0) * 100 ) AS PROJECTION_RATE,
       ( COALESCE(Sum(B1.PROJECTION_SALES) / NULLIF(Sum(A1.UNITS), 0), 0) )       AS PROJECTION_RPU
FROM   (SELECT BRAND_NAME,
               Sum(SALES) AS SALES,
               Sum(UNITS) AS UNITS,
               PERIOD_SID
        FROM   (SELECT Sum(B.ACTUAL_SALES) AS SALES,
                       Sum(B.ACTUAL_UNITS) AS UNITS,
                       PER.PERIOD_SID,
                       I.BRAND_NAME,
                       I.BRAND_MASTER_SID,
                       I.THERAPEUTIC_CLASS
                FROM   DBO.ST_M_SALES_PROJECTION_MASTER A
                       JOIN DBO.ST_M_ACTUAL_SALES B
                         ON A.CCP_DETAILS_SID = B.CCP_DETAILS_SID
                       JOIN #INPUT_INFO I
                         ON I.CCP_DETAILS_SID = A.CCP_DETAILS_SID
                       JOIN PERIOD PER
                         ON PER.PERIOD_SID = B.PERIOD_SID
                WHERE  I.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
                GROUP  BY PER.PERIOD_SID,
                          I.BRAND_NAME,
                          I.BRAND_MASTER_SID,
                          I.THERAPEUTIC_CLASS) A
        WHERE  ( A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
                 AND @THERAPEUTIC_CLASS IS NOT NULL
                 AND @BRAND IS NULL )
                OR ( A.BRAND_MASTER_SID = @BRAND
                     AND @BRAND IS NOT NULL
                     AND @THERAPEUTIC_CLASS IS NULL )
                OR ( A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
                     AND A.BRAND_MASTER_SID = @BRAND )
                OR ( @THERAPEUTIC_CLASS IS NULL
                     AND @BRAND IS NULL )
        GROUP  BY A.BRAND_NAME,
                  A.PERIOD_SID) A1
       LEFT JOIN (SELECT BRAND_NAME,
                         Sum(PROJECTION_SALES) AS PROJECTION_SALES,
                         PERIOD_SID
                  FROM   (SELECT BRAND_NAME,
                                 Sum(ACTUAL_SALES) AS PROJECTION_SALES,
                                 PERIOD_SID,
                                 I.BRAND_MASTER_SID,
                                 THERAPEUTIC_CLASS
                          FROM   #INPUT_INFO I
                                 CROSS APPLY (					  SELECT PROJECTION_MASTER_SID,PROJECTION_DETAILS_SID FROM 
								  (
								 SELECT  PM.PROJECTION_MASTER_SID,
								                      PD.PROJECTION_DETAILS_SID,
								 ROW_NUMBER() OVER(PARTITION BY I.CCP_DETAILS_SID ORDER BY wm.MODIFIED_DATE DESC) RNO
                                              FROM   PROJECTION_MASTER PM
                                                     JOIN WORKFLOW_MASTER WM
                                                       ON PM.PROJECTION_MASTER_SID = WM.PROJECTION_MASTER_SID
                                                          AND WM.WORKFLOW_STATUS_ID = (SELECT HELPER_TABLE_SID
                                                                                       FROM   HELPER_TABLE
                                                                                       WHERE  LIST_NAME = 'WORKFLOWSTATUS'
                                                                                              AND DESCRIPTION = 'APPROVED')
                                                   
												       JOIN PROJECTION_DETAILS PD
                                                       ON pd.PROJECTION_MASTER_SID = PM.PROJECTION_MASTER_SID
												   AND
                                                        I.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
														)A
														WHERE RNO=1) CS
                                 JOIN [DBO].[NM_ACTUAL_DISCOUNT] C
                                   ON C.PROJECTION_DETAILS_SID = CS.PROJECTION_DETAILS_SID
                                 JOIN HELPER_TABLE H
                                   ON I.COMPANY_CATEGORY = H.HELPER_TABLE_SID
                          WHERE  I.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
                                 AND H.DESCRIPTION IN ( 'MM MEDI', 'MCG PLAN' )
                          GROUP  BY BRAND_NAME,
                                    PERIOD_SID,
                                    I.BRAND_MASTER_SID,
                                    THERAPEUTIC_CLASS) B
                  WHERE  ( B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
                           AND @THERAPEUTIC_CLASS IS NOT NULL
                           AND @BRAND IS NULL )
                          OR ( B.BRAND_MASTER_SID = @BRAND
                               AND @BRAND IS NOT NULL
                               AND @THERAPEUTIC_CLASS IS NULL )
                          OR ( B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
                               AND B.BRAND_MASTER_SID = @BRAND )
                          OR ( @THERAPEUTIC_CLASS IS NULL
                               AND @BRAND IS NULL )
                  GROUP  BY B.BRAND_NAME,
                            B.PERIOD_SID) B1
              ON A1.BRAND_NAME = B1.BRAND_NAME
                 AND A1.PERIOD_SID = B1.PERIOD_SID
       JOIN PERIOD AS PER
         ON PER.PERIOD_SID = A1.PERIOD_SID
GROUP  BY per.year,
          per.@frequency_var
ORDER  BY per.year ]]>
        </query>
    </entity>
    <entity id="mmdprgetNonmandatedbrand">
        <query>  <![CDATA[
   DECLARE @PROJECTION_MASTER_SID int =  @projID
DECLARE @THERAPEUTIC_CLASS int
DECLARE @BRAND int

DECLARE @INPUT_INFO TABLE (
  PROJECTION_MASTER_SID int,
  CCP_DETAILS_SID int,
  ITEM_MASTER_SID int,
  COMPANY_MASTER_SID int,
  BRAND_MASTER_SID int,
  BRAND_NAME varchar(100),
  THERAPEUTIC_CLASS int,
  COMPANY_CATEGORY int
)

INSERT INTO @INPUT_INFO
  SELECT
    @PROJECTION_MASTER_SID,
    PD.CCP_DETAILS_SID,
    C.ITEM_MASTER_SID,
    CM.COMPANY_MASTER_SID,
    IM.BRAND_MASTER_SID,
    BRAND_NAME,
    THERAPEUTIC_CLASS,
    COMPANY_CATEGORY
  FROM ST_CCP_HIERARCHY PD
  INNER JOIN CCP_DETAILS C
    ON C.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
  INNER JOIN ITEM_MASTER IM
    ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
  INNER JOIN BRAND_MASTER B
    ON B.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
  INNER JOIN COMPANY_MASTER CM
    ON CM.COMPANY_MASTER_SID = C.COMPANY_MASTER_SID
  

SELECT
  FINALQ.BRAND_NAME,
  FINALQ.YEARS,
  FINALQ.PERIODS,
  FINALQ.PROJECTION_SALES,
  FINALQ.TYPE,
  FINALQ.PROJECTION_RATE,
  FINALQ.PROJECTION_RPU
FROM (SELECT
  Q.BRAND_NAME,
  Q.YEARS,
  Q.PERIODS,
  Q.PROJECTION_SALES,
  Q.TYPE,
  Q.PROJECTION_RATE,
  Q.PROJECTION_RPU,
  DENSE_RANK()
  OVER (
  ORDER BY Q.BRAND_NAME) AS TEMP_INDEX
FROM (SELECT
  A1.BRAND_NAME AS BRAND_NAME,
  PER.year AS YEARS,
  PER.@frequency_var AS PERIODS,
  SUM(B1.PROJECTION_SALES) PROJECTION_SALES,
  'PROJECTION' AS TYPE,
  (COALESCE(SUM(B1.PROJECTION_SALES) / NULLIF(SUM(A1.SALES), 0), 0) * 100) AS PROJECTION_RATE,
  (COALESCE(SUM(B1.PROJECTION_SALES) / NULLIF(SUM(A1.UNITS), 0), 0)) AS PROJECTION_RPU
FROM (SELECT
  BRAND_NAME,
  SUM(SALES) AS SALES,
  SUM(UNITS) AS UNITS,
  PERIOD_SID
FROM (SELECT
  SUM(B.PROJECTION_SALES) AS SALES,
  SUM(B.PROJECTION_UNITS) AS UNITS,
  PER.PERIOD_SID,
  I.BRAND_NAME,
  I.BRAND_MASTER_SID,
  I.THERAPEUTIC_CLASS
FROM dbo.ST_M_SALES_PROJECTION_MASTER A
JOIN dbo.ST_M_SALES_PROJECTION B
  ON A.CCP_DETAILS_SID = B.CCP_DETAILS_SID
JOIN @INPUT_INFO I
  ON I.CCP_DETAILS_SID = A.CCP_DETAILS_SID
JOIN PERIOD PER
  ON PER.PERIOD_SID = B.PERIOD_SID

GROUP BY PER.PERIOD_SID,
         I.BRAND_NAME,
         I.BRAND_MASTER_SID,
         I.THERAPEUTIC_CLASS) A
WHERE (A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND @THERAPEUTIC_CLASS IS NOT NULL
AND @BRAND IS NULL)
OR (A.BRAND_MASTER_SID = @BRAND
AND @BRAND IS NOT NULL
AND @THERAPEUTIC_CLASS IS NULL)
OR (A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND A.BRAND_MASTER_SID = @BRAND)
OR (@THERAPEUTIC_CLASS IS NULL
AND @BRAND IS NULL)
GROUP BY A.BRAND_NAME,
         A.PERIOD_SID) A1
LEFT JOIN (SELECT
  BRAND_NAME,
  SUM(PROJECTION_SALES) AS PROJECTION_SALES,
  PERIOD_SID
FROM (SELECT
  BRAND_NAME,
  SUM(PROJECTION_SALES) AS PROJECTION_SALES,
  PERIOD_SID,
  I.BRAND_MASTER_SID,
  THERAPEUTIC_CLASS
FROM @INPUT_INFO I
CROSS APPLY (SELECT
  PROJECTION_MASTER_SID,
  PROJECTION_DETAILS_SID
FROM (SELECT
  PM.PROJECTION_MASTER_SID,
  PD.PROJECTION_DETAILS_SID,
  ROW_NUMBER() OVER (PARTITION BY I.CCP_DETAILS_SID ORDER BY wm.MODIFIED_DATE DESC) RNO
FROM PROJECTION_MASTER PM
JOIN WORKFLOW_MASTER WM
  ON PM.PROJECTION_MASTER_SID = WM.PROJECTION_MASTER_SID
  AND WM.WORKFLOW_STATUS_ID = (SELECT
    HELPER_TABLE_SID
  FROM HELPER_TABLE
  WHERE LIST_NAME = 'WORKFLOWSTATUS'
  AND DESCRIPTION = 'APPROVED')

JOIN PROJECTION_DETAILS PD
  ON pd.PROJECTION_MASTER_SID = PM.PROJECTION_MASTER_SID
  AND I.CCP_DETAILS_SID = PD.CCP_DETAILS_SID) A
WHERE RNO = 1) CS
JOIN [DBO].[NM_DISCOUNT_PROJECTION] C
  ON C.PROJECTION_DETAILS_SID = CS.PROJECTION_DETAILS_SID
JOIN HELPER_TABLE H
  ON I.COMPANY_CATEGORY = H.HELPER_TABLE_SID
WHERE I.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
AND H.DESCRIPTION IN ('MM MEDI', 'MCG PLAN')
GROUP BY BRAND_NAME,
         PERIOD_SID,
         I.BRAND_MASTER_SID,
         THERAPEUTIC_CLASS) B
WHERE (B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND @THERAPEUTIC_CLASS IS NOT NULL
AND @BRAND IS NULL)
OR (B.BRAND_MASTER_SID = @BRAND
AND @BRAND IS NOT NULL
AND @THERAPEUTIC_CLASS IS NULL)
OR (B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND B.BRAND_MASTER_SID = @BRAND)
OR (@THERAPEUTIC_CLASS IS NULL
AND @BRAND IS NULL)
GROUP BY B.BRAND_NAME,
         B.PERIOD_SID) B1
  ON A1.BRAND_NAME = B1.BRAND_NAME
  AND A1.PERIOD_SID = B1.PERIOD_SID
JOIN period AS per
  ON per.PERIOD_SID = A1.PERIOD_SID
GROUP BY A1.BRAND_NAME,
         per.year,
         per.@frequency_var
UNION ALL
SELECT
  A1.BRAND_NAME AS BRAND_NAME,
  per.year AS YEARS,
  per.@frequency_var AS PERIODS,
  SUM(B1.PROJECTION_SALES) AS PROJECTION_SALES,
  'ACTUAL' AS TYPE,
  (COALESCE(SUM(B1.PROJECTION_SALES) / NULLIF(SUM(A1.SALES), 0), 0) * 100) AS PROJECTION_RATE,
  (COALESCE(SUM(B1.PROJECTION_SALES) / NULLIF(SUM(A1.UNITS), 0), 0)) AS PROJECTION_RPU
FROM (SELECT
  BRAND_NAME,
  SUM(SALES) AS SALES,
  SUM(UNITS) AS UNITS,
  PERIOD_SID
FROM (SELECT
  SUM(B.ACTUAL_SALES) AS SALES,
  SUM(B.ACTUAL_UNITS) AS UNITS,
  PER.PERIOD_SID,
  I.BRAND_NAME,
  I.BRAND_MASTER_SID,
  I.THERAPEUTIC_CLASS
FROM dbo.ST_M_SALES_PROJECTION_MASTER A
JOIN dbo.ST_M_ACTUAL_SALES B
  ON A.CCP_DETAILS_SID = B.CCP_DETAILS_SID
JOIN @INPUT_INFO I
  ON I.CCP_DETAILS_SID = A.CCP_DETAILS_SID
JOIN PERIOD PER
  ON PER.PERIOD_SID = B.PERIOD_SID
WHERE I.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
GROUP BY PER.PERIOD_SID,
         I.BRAND_NAME,
         I.BRAND_MASTER_SID,
         I.THERAPEUTIC_CLASS) A
WHERE (A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND @THERAPEUTIC_CLASS IS NOT NULL
AND @BRAND IS NULL)
OR (A.BRAND_MASTER_SID = @BRAND
AND @BRAND IS NOT NULL
AND @THERAPEUTIC_CLASS IS NULL)
OR (A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND A.BRAND_MASTER_SID = @BRAND)
OR (@THERAPEUTIC_CLASS IS NULL
AND @BRAND IS NULL)
GROUP BY A.BRAND_NAME,
         A.PERIOD_SID) A1
LEFT JOIN (SELECT
  BRAND_NAME,
  SUM(PROJECTION_SALES) AS PROJECTION_SALES,
  PERIOD_SID
FROM (SELECT
  BRAND_NAME,
  SUM(ACTUAL_SALES) AS PROJECTION_SALES,
  PERIOD_SID,
  I.BRAND_MASTER_SID,
  THERAPEUTIC_CLASS
FROM @INPUT_INFO I
CROSS APPLY (SELECT
  PROJECTION_MASTER_SID,
  PROJECTION_DETAILS_SID
FROM (SELECT
  PM.PROJECTION_MASTER_SID,
  PD.PROJECTION_DETAILS_SID,
  ROW_NUMBER() OVER (PARTITION BY I.CCP_DETAILS_SID ORDER BY wm.MODIFIED_DATE DESC) RNO
FROM PROJECTION_MASTER PM
JOIN WORKFLOW_MASTER WM
  ON PM.PROJECTION_MASTER_SID = WM.PROJECTION_MASTER_SID
  AND WM.WORKFLOW_STATUS_ID = (SELECT
    HELPER_TABLE_SID
  FROM HELPER_TABLE
  WHERE LIST_NAME = 'WORKFLOWSTATUS'
  AND DESCRIPTION = 'APPROVED')

JOIN PROJECTION_DETAILS PD
  ON pd.PROJECTION_MASTER_SID = PM.PROJECTION_MASTER_SID
  AND I.CCP_DETAILS_SID = PD.CCP_DETAILS_SID) A
WHERE RNO = 1) CS
JOIN [DBO].[NM_ACTUAL_DISCOUNT] C
  ON C.PROJECTION_DETAILS_SID = CS.PROJECTION_DETAILS_SID
JOIN HELPER_TABLE H
  ON I.COMPANY_CATEGORY = H.HELPER_TABLE_SID
WHERE I.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
AND H.DESCRIPTION IN ('MM MEDI', 'MCG PLAN')
GROUP BY BRAND_NAME,
         PERIOD_SID,
         I.BRAND_MASTER_SID,
         THERAPEUTIC_CLASS) B
WHERE (B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND @THERAPEUTIC_CLASS IS NOT NULL
AND @BRAND IS NULL)
OR (B.BRAND_MASTER_SID = @BRAND
AND @BRAND IS NOT NULL
AND @THERAPEUTIC_CLASS IS NULL)
OR (B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND B.BRAND_MASTER_SID = @BRAND)
OR (@THERAPEUTIC_CLASS IS NULL
AND @BRAND IS NULL)
GROUP BY B.BRAND_NAME,
         B.PERIOD_SID) B1
  ON A1.BRAND_NAME = B1.BRAND_NAME
  AND A1.PERIOD_SID = B1.PERIOD_SID
JOIN period AS per
  ON per.PERIOD_SID = A1.PERIOD_SID
GROUP BY per.year,
         A1.BRAND_NAME,
         per.@frequency_var) Q) FINALQ
    ]]>
        </query>
    </entity>
 
    <entity id="mmdprgetSumNMPivotValue">
        <query>  <![CDATA[ DECLARE @PROJECTION_MASTER_SID int = @projID
DECLARE @THERAPEUTIC_CLASS int
DECLARE @BRAND int
IF OBJECT_ID('TEMPDB..#INPUT_INFO') IS NOT NULL
  DROP TABLE #INPUT_INFO

CREATE TABLE #INPUT_INFO (
  PROJECTION_MASTER_SID int,
  CCP_DETAILS_SID int,
  ITEM_MASTER_SID int,
  COMPANY_MASTER_SID int,
  BRAND_MASTER_SID int,
  BRAND_NAME varchar(100),
  THERAPEUTIC_CLASS int,
  COMPANY_CATEGORY int
)

INSERT INTO #INPUT_INFO
  SELECT
    @PROJECTION_MASTER_SID,
    PD.CCP_DETAILS_SID,
    C.ITEM_MASTER_SID,
    CM.COMPANY_MASTER_SID,
    IM.BRAND_MASTER_SID,
    BRAND_NAME,
    THERAPEUTIC_CLASS,
    COMPANY_CATEGORY
  FROM ST_CCP_HIERARCHY PD
  INNER JOIN CCP_DETAILS C
    ON C.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
  INNER JOIN ITEM_MASTER IM
    ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
  INNER JOIN BRAND_MASTER B
    ON B.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
  INNER JOIN COMPANY_MASTER CM
    ON CM.COMPANY_MASTER_SID = C.COMPANY_MASTER_SID


SELECT
  YEARS,
  PERIODS,
  SUM(PROJECTION_SALES) PROJECTION_SALES,
  TYPE,
  SUM(PROJECTION_RATE) PROJECTION_RATE,
  SUM(PROJECTION_RPU) PROJECTION_RPU
FROM (SELECT
  PER.year AS YEARS,
  PER.@frequency_var AS PERIODS,
  SUM(B1.PROJECTION_SALES) PROJECTION_SALES,
  'PROJECTION' AS TYPE,
  (COALESCE(SUM(B1.PROJECTION_SALES) / NULLIF(SUM(A1.SALES), 0), 0) * 100) AS PROJECTION_RATE,
  (COALESCE(SUM(B1.PROJECTION_SALES) / NULLIF(SUM(A1.UNITS), 0), 0)) AS PROJECTION_RPU
FROM (SELECT
  BRAND_NAME,
  SUM(SALES) AS SALES,
  SUM(UNITS) AS UNITS,
  PERIOD_SID
FROM (SELECT
  SUM(B.PROJECTION_SALES) AS SALES,
  SUM(B.PROJECTION_UNITS) AS UNITS,
  PER.PERIOD_SID,
  I.BRAND_NAME,
  I.BRAND_MASTER_SID,
  I.THERAPEUTIC_CLASS
FROM DBO.ST_M_SALES_PROJECTION_MASTER A
JOIN DBO.ST_M_SALES_PROJECTION B
  ON A.CCP_DETAILS_SID = B.CCP_DETAILS_SID
JOIN #INPUT_INFO I
  ON I.CCP_DETAILS_SID = A.CCP_DETAILS_SID
JOIN PERIOD PER
  ON PER.PERIOD_SID = B.PERIOD_SID

GROUP BY PER.PERIOD_SID,
         I.BRAND_NAME,
         I.BRAND_MASTER_SID,
         I.THERAPEUTIC_CLASS) A
WHERE (A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND @THERAPEUTIC_CLASS IS NOT NULL
AND @BRAND IS NULL)
OR (A.BRAND_MASTER_SID = @BRAND
AND @BRAND IS NOT NULL
AND @THERAPEUTIC_CLASS IS NULL)
OR (A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND A.BRAND_MASTER_SID = @BRAND)
OR (@THERAPEUTIC_CLASS IS NULL
AND @BRAND IS NULL)
GROUP BY A.BRAND_NAME,
         A.PERIOD_SID) A1
LEFT JOIN (SELECT
  BRAND_NAME,
  SUM(PROJECTION_SALES) AS PROJECTION_SALES,
  PERIOD_SID
FROM (SELECT
  BRAND_NAME,
  SUM(PROJECTION_SALES) AS PROJECTION_SALES,
  PERIOD_SID,
  I.BRAND_MASTER_SID,
  THERAPEUTIC_CLASS
FROM #INPUT_INFO I
CROSS APPLY (SELECT
  PROJECTION_MASTER_SID,
  PROJECTION_DETAILS_SID
FROM (SELECT
  PM.PROJECTION_MASTER_SID,
  PD.PROJECTION_DETAILS_SID,
  ROW_NUMBER() OVER (PARTITION BY I.CCP_DETAILS_SID ORDER BY wm.MODIFIED_DATE DESC) RNO
FROM PROJECTION_MASTER PM
JOIN WORKFLOW_MASTER WM
  ON PM.PROJECTION_MASTER_SID = WM.PROJECTION_MASTER_SID
  AND WM.WORKFLOW_STATUS_ID = (SELECT
    HELPER_TABLE_SID
  FROM HELPER_TABLE
  WHERE LIST_NAME = 'WORKFLOWSTATUS'
  AND DESCRIPTION = 'APPROVED')

JOIN PROJECTION_DETAILS PD
  ON pd.PROJECTION_MASTER_SID = PM.PROJECTION_MASTER_SID
  AND I.CCP_DETAILS_SID = PD.CCP_DETAILS_SID) A
WHERE RNO = 1) CS
JOIN [DBO].[NM_DISCOUNT_PROJECTION] C
  ON C.PROJECTION_DETAILS_SID = CS.PROJECTION_DETAILS_SID
JOIN HELPER_TABLE H
  ON I.COMPANY_CATEGORY = H.HELPER_TABLE_SID
WHERE I.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
AND H.DESCRIPTION IN ('MM MEDI', 'MCG PLAN')
GROUP BY BRAND_NAME,
         PERIOD_SID,
         I.BRAND_MASTER_SID,
         THERAPEUTIC_CLASS) B
WHERE (B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND @THERAPEUTIC_CLASS IS NOT NULL
AND @BRAND IS NULL)
OR (B.BRAND_MASTER_SID = @BRAND
AND @BRAND IS NOT NULL
AND @THERAPEUTIC_CLASS IS NULL)
OR (B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND B.BRAND_MASTER_SID = @BRAND)
OR (@THERAPEUTIC_CLASS IS NULL
AND @BRAND IS NULL)
GROUP BY B.BRAND_NAME,
         B.PERIOD_SID) B1
  ON A1.BRAND_NAME = B1.BRAND_NAME
  AND A1.PERIOD_SID = B1.PERIOD_SID
JOIN PERIOD AS PER
  ON PER.PERIOD_SID = A1.PERIOD_SID
GROUP BY A1.BRAND_NAME,PER.YEAR,
         PER.@frequency_var
UNION ALL
SELECT
  PER.YEAR,
  PER.@frequency_var,
  SUM(B1.PROJECTION_SALES) AS PROJECTION_SALES,
  'ACTUAL' AS TYPE,
  (COALESCE(SUM(B1.PROJECTION_SALES) / NULLIF(SUM(A1.SALES), 0), 0) * 100) AS PROJECTION_RATE,
  (COALESCE(SUM(B1.PROJECTION_SALES) / NULLIF(SUM(A1.UNITS), 0), 0)) AS PROJECTION_RPU
FROM (SELECT
  BRAND_NAME,
  SUM(SALES) AS SALES,
  SUM(UNITS) AS UNITS,
  PERIOD_SID
FROM (SELECT
  SUM(B.ACTUAL_SALES) AS SALES,
  SUM(B.ACTUAL_UNITS) AS UNITS,
  PER.PERIOD_SID,
  I.BRAND_NAME,
  I.BRAND_MASTER_SID,
  I.THERAPEUTIC_CLASS
FROM DBO.ST_M_SALES_PROJECTION_MASTER A
JOIN DBO.ST_M_ACTUAL_SALES B
  ON A.CCP_DETAILS_SID = B.CCP_DETAILS_SID
JOIN #INPUT_INFO I
  ON I.CCP_DETAILS_SID = A.CCP_DETAILS_SID
JOIN PERIOD PER
  ON PER.PERIOD_SID = B.PERIOD_SID
WHERE I.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
GROUP BY PER.PERIOD_SID,
         I.BRAND_NAME,
         I.BRAND_MASTER_SID,
         I.THERAPEUTIC_CLASS) A
WHERE (A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND @THERAPEUTIC_CLASS IS NOT NULL
AND @BRAND IS NULL)
OR (A.BRAND_MASTER_SID = @BRAND
AND @BRAND IS NOT NULL
AND @THERAPEUTIC_CLASS IS NULL)
OR (A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND A.BRAND_MASTER_SID = @BRAND)
OR (@THERAPEUTIC_CLASS IS NULL
AND @BRAND IS NULL)
GROUP BY A.BRAND_NAME,
         A.PERIOD_SID) A1
LEFT JOIN (SELECT
  BRAND_NAME,
  SUM(PROJECTION_SALES) AS PROJECTION_SALES,
  PERIOD_SID
FROM (SELECT
  BRAND_NAME,
  SUM(ACTUAL_SALES) AS PROJECTION_SALES,
  PERIOD_SID,
  I.BRAND_MASTER_SID,
  THERAPEUTIC_CLASS
FROM #INPUT_INFO I
CROSS APPLY (SELECT
  PROJECTION_MASTER_SID,
  PROJECTION_DETAILS_SID
FROM (SELECT
  PM.PROJECTION_MASTER_SID,
  PD.PROJECTION_DETAILS_SID,
  ROW_NUMBER() OVER (PARTITION BY I.CCP_DETAILS_SID ORDER BY wm.MODIFIED_DATE DESC) RNO
FROM PROJECTION_MASTER PM
JOIN WORKFLOW_MASTER WM
  ON PM.PROJECTION_MASTER_SID = WM.PROJECTION_MASTER_SID
  AND WM.WORKFLOW_STATUS_ID = (SELECT
    HELPER_TABLE_SID
  FROM HELPER_TABLE
  WHERE LIST_NAME = 'WORKFLOWSTATUS'
  AND DESCRIPTION = 'APPROVED')

JOIN PROJECTION_DETAILS PD
  ON pd.PROJECTION_MASTER_SID = PM.PROJECTION_MASTER_SID
  AND I.CCP_DETAILS_SID = PD.CCP_DETAILS_SID) A
WHERE RNO = 1 ) CS
JOIN [DBO].[NM_ACTUAL_DISCOUNT] C
  ON C.PROJECTION_DETAILS_SID = CS.PROJECTION_DETAILS_SID
JOIN HELPER_TABLE H
  ON I.COMPANY_CATEGORY = H.HELPER_TABLE_SID
WHERE I.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
AND H.DESCRIPTION IN ('MM MEDI', 'MCG PLAN')
GROUP BY BRAND_NAME,
         PERIOD_SID,
         I.BRAND_MASTER_SID,
         THERAPEUTIC_CLASS) B
WHERE (B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND @THERAPEUTIC_CLASS IS NOT NULL
AND @BRAND IS NULL)
OR (B.BRAND_MASTER_SID = @BRAND
AND @BRAND IS NOT NULL
AND @THERAPEUTIC_CLASS IS NULL)
OR (B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND B.BRAND_MASTER_SID = @BRAND)
OR (@THERAPEUTIC_CLASS IS NULL
AND @BRAND IS NULL)
GROUP BY B.BRAND_NAME,
         B.PERIOD_SID) B1
  ON A1.BRAND_NAME = B1.BRAND_NAME
  AND A1.PERIOD_SID = B1.PERIOD_SID
JOIN PERIOD AS PER
  ON PER.PERIOD_SID = A1.PERIOD_SID
GROUP BY per.year,
         per.@frequency_var) a
GROUP BY a.YEARS,
         a.periods,
         TYPE
ORDER BY YEARS,
PERIODS  ]]>
        </query>
    </entity>
  
       <entity id="mmdprgetNonMandateTotalValue">
        <query>  <![CDATA[ 
        DECLARE @PROJECTION_MASTER_SID int = @projID
DECLARE @THERAPEUTIC_CLASS int
DECLARE @BRAND int
IF OBJECT_ID('TEMPDB..#INPUT_INFO') IS NOT NULL
  DROP TABLE #INPUT_INFO

CREATE TABLE #INPUT_INFO (
  PROJECTION_MASTER_SID int,
  CCP_DETAILS_SID int,
  ITEM_MASTER_SID int,
  COMPANY_MASTER_SID int,
  BRAND_MASTER_SID int,
  BRAND_NAME varchar(100),
  THERAPEUTIC_CLASS int,
  COMPANY_CATEGORY int
)

INSERT INTO #INPUT_INFO
  SELECT
    @PROJECTION_MASTER_SID,
    PD.CCP_DETAILS_SID,
    C.ITEM_MASTER_SID,
    CM.COMPANY_MASTER_SID,
    IM.BRAND_MASTER_SID,
    BRAND_NAME,
    THERAPEUTIC_CLASS,
    COMPANY_CATEGORY
  FROM ST_CCP_HIERARCHY PD
  INNER JOIN CCP_DETAILS C
    ON C.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
  INNER JOIN ITEM_MASTER IM
    ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
  INNER JOIN BRAND_MASTER B
    ON B.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
  INNER JOIN COMPANY_MASTER CM
    ON CM.COMPANY_MASTER_SID = C.COMPANY_MASTER_SID


 
SELECT A1.BRAND_NAME AS BRAND_NAME,
  PER.year AS YEARS,
  @frequency_var AS PERIODS,
  SUM(B1.PROJECTION_SALES) PROJECTION_SALES,
  'PROJECTION' AS TYPE,
  (COALESCE(SUM(B1.PROJECTION_SALES) / NULLIF(SUM(A1.SALES), 0), 0) * 100) AS PROJECTION_RATE,
  (COALESCE(SUM(B1.PROJECTION_SALES) / NULLIF(SUM(A1.UNITS), 0), 0)) AS PROJECTION_RPU
FROM (SELECT
  BRAND_NAME,
  SUM(SALES) AS SALES,
  SUM(UNITS) AS UNITS,
  PERIOD_SID
FROM (SELECT
  SUM(B.PROJECTION_SALES) AS SALES,
  SUM(B.PROJECTION_UNITS) AS UNITS,
  PER.PERIOD_SID,
  I.BRAND_NAME,
  I.BRAND_MASTER_SID,
  I.THERAPEUTIC_CLASS
FROM DBO.ST_M_SALES_PROJECTION_MASTER A
JOIN DBO.ST_M_SALES_PROJECTION B
  ON A.CCP_DETAILS_SID = B.CCP_DETAILS_SID
JOIN #INPUT_INFO I
  ON I.CCP_DETAILS_SID = A.CCP_DETAILS_SID
JOIN PERIOD PER
  ON PER.PERIOD_SID = B.PERIOD_SID

GROUP BY PER.PERIOD_SID,
         I.BRAND_NAME,
         I.BRAND_MASTER_SID,
         I.THERAPEUTIC_CLASS) A
WHERE (A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND @THERAPEUTIC_CLASS IS NOT NULL
AND @BRAND IS NULL)
OR (A.BRAND_MASTER_SID = @BRAND
AND @BRAND IS NOT NULL
AND @THERAPEUTIC_CLASS IS NULL)
OR (A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND A.BRAND_MASTER_SID = @BRAND)
OR (@THERAPEUTIC_CLASS IS NULL
AND @BRAND IS NULL)
GROUP BY A.BRAND_NAME,
         A.PERIOD_SID) A1
LEFT JOIN (SELECT
  BRAND_NAME,
  SUM(PROJECTION_SALES) AS PROJECTION_SALES,
  PERIOD_SID
FROM (SELECT
  BRAND_NAME,
  SUM(PROJECTION_SALES) AS PROJECTION_SALES,
  PERIOD_SID,
  I.BRAND_MASTER_SID,
  THERAPEUTIC_CLASS
FROM #INPUT_INFO I
CROSS APPLY (SELECT
  PROJECTION_MASTER_SID,
  PROJECTION_DETAILS_SID
FROM (SELECT
  PM.PROJECTION_MASTER_SID,
  PD.PROJECTION_DETAILS_SID,
  ROW_NUMBER() OVER (PARTITION BY I.CCP_DETAILS_SID ORDER BY wm.MODIFIED_DATE DESC) RNO
FROM PROJECTION_MASTER PM
JOIN WORKFLOW_MASTER WM
  ON PM.PROJECTION_MASTER_SID = WM.PROJECTION_MASTER_SID
  AND WM.WORKFLOW_STATUS_ID = (SELECT
    HELPER_TABLE_SID
  FROM HELPER_TABLE
  WHERE LIST_NAME = 'WORKFLOWSTATUS'
  AND DESCRIPTION = 'APPROVED')

JOIN PROJECTION_DETAILS PD
  ON pd.PROJECTION_MASTER_SID = PM.PROJECTION_MASTER_SID
  AND I.CCP_DETAILS_SID = PD.CCP_DETAILS_SID) A
WHERE RNO = 1) CS
JOIN [DBO].[NM_DISCOUNT_PROJECTION] C
  ON C.PROJECTION_DETAILS_SID = CS.PROJECTION_DETAILS_SID
JOIN HELPER_TABLE H
  ON I.COMPANY_CATEGORY = H.HELPER_TABLE_SID
WHERE I.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
AND H.DESCRIPTION IN ('MM MEDI', 'MCG PLAN')
GROUP BY BRAND_NAME,
         PERIOD_SID,
         I.BRAND_MASTER_SID,
         THERAPEUTIC_CLASS) B
WHERE (B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND @THERAPEUTIC_CLASS IS NOT NULL
AND @BRAND IS NULL)
OR (B.BRAND_MASTER_SID = @BRAND
AND @BRAND IS NOT NULL
AND @THERAPEUTIC_CLASS IS NULL)
OR (B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND B.BRAND_MASTER_SID = @BRAND)
OR (@THERAPEUTIC_CLASS IS NULL
AND @BRAND IS NULL)
GROUP BY B.BRAND_NAME,
         B.PERIOD_SID) B1
  ON A1.BRAND_NAME = B1.BRAND_NAME
  AND A1.PERIOD_SID = B1.PERIOD_SID
JOIN PERIOD AS PER
  ON PER.PERIOD_SID = A1.PERIOD_SID
GROUP BY A1.BRAND_NAME,PER.YEAR,
         @frequency_var
UNION ALL
SELECT
A1.BRAND_NAME AS BRAND_NAME,
  PER.YEAR,
  @frequency_var,
  SUM(B1.PROJECTION_SALES) AS PROJECTION_SALES,
  'ACTUAL' AS TYPE,
  (COALESCE(SUM(B1.PROJECTION_SALES) / NULLIF(SUM(A1.SALES), 0), 0) * 100) AS PROJECTION_RATE,
  (COALESCE(SUM(B1.PROJECTION_SALES) / NULLIF(SUM(A1.UNITS), 0), 0)) AS PROJECTION_RPU
FROM (SELECT
  BRAND_NAME,
  SUM(SALES) AS SALES,
  SUM(UNITS) AS UNITS,
  PERIOD_SID
FROM (SELECT
  SUM(B.ACTUAL_SALES) AS SALES,
  SUM(B.ACTUAL_UNITS) AS UNITS,
  PER.PERIOD_SID,
  I.BRAND_NAME,
  I.BRAND_MASTER_SID,
  I.THERAPEUTIC_CLASS
FROM DBO.ST_M_SALES_PROJECTION_MASTER A
JOIN DBO.ST_M_ACTUAL_SALES B
  ON A.CCP_DETAILS_SID = B.CCP_DETAILS_SID
JOIN #INPUT_INFO I
  ON I.CCP_DETAILS_SID = A.CCP_DETAILS_SID
JOIN PERIOD PER
  ON PER.PERIOD_SID = B.PERIOD_SID
WHERE I.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
GROUP BY PER.PERIOD_SID,
         I.BRAND_NAME,
         I.BRAND_MASTER_SID,
         I.THERAPEUTIC_CLASS) A
WHERE (A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND @THERAPEUTIC_CLASS IS NOT NULL
AND @BRAND IS NULL)
OR (A.BRAND_MASTER_SID = @BRAND
AND @BRAND IS NOT NULL
AND @THERAPEUTIC_CLASS IS NULL)
OR (A.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND A.BRAND_MASTER_SID = @BRAND)
OR (@THERAPEUTIC_CLASS IS NULL
AND @BRAND IS NULL)
GROUP BY A.BRAND_NAME,
         A.PERIOD_SID) A1
LEFT JOIN (SELECT
  BRAND_NAME,
  SUM(PROJECTION_SALES) AS PROJECTION_SALES,
  PERIOD_SID
FROM (SELECT
  BRAND_NAME,
  SUM(ACTUAL_SALES) AS PROJECTION_SALES,
  PERIOD_SID,
  I.BRAND_MASTER_SID,
  THERAPEUTIC_CLASS
FROM #INPUT_INFO I
CROSS APPLY (SELECT
  PROJECTION_MASTER_SID,
  PROJECTION_DETAILS_SID
FROM (SELECT
  PM.PROJECTION_MASTER_SID,
  PD.PROJECTION_DETAILS_SID,
  ROW_NUMBER() OVER (PARTITION BY I.CCP_DETAILS_SID ORDER BY wm.MODIFIED_DATE DESC) RNO
FROM PROJECTION_MASTER PM
JOIN WORKFLOW_MASTER WM
  ON PM.PROJECTION_MASTER_SID = WM.PROJECTION_MASTER_SID
  AND WM.WORKFLOW_STATUS_ID = (SELECT
    HELPER_TABLE_SID
  FROM HELPER_TABLE
  WHERE LIST_NAME = 'WORKFLOWSTATUS'
  AND DESCRIPTION = 'APPROVED')

JOIN PROJECTION_DETAILS PD
  ON pd.PROJECTION_MASTER_SID = PM.PROJECTION_MASTER_SID
  AND I.CCP_DETAILS_SID = PD.CCP_DETAILS_SID) A
WHERE RNO = 1 ) CS
JOIN [DBO].[NM_ACTUAL_DISCOUNT] C
  ON C.PROJECTION_DETAILS_SID = CS.PROJECTION_DETAILS_SID
JOIN HELPER_TABLE H
  ON I.COMPANY_CATEGORY = H.HELPER_TABLE_SID
WHERE I.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
AND H.DESCRIPTION IN ('MM MEDI', 'MCG PLAN')
GROUP BY BRAND_NAME,
         PERIOD_SID,
         I.BRAND_MASTER_SID,
         THERAPEUTIC_CLASS) B
WHERE (B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND @THERAPEUTIC_CLASS IS NOT NULL
AND @BRAND IS NULL)
OR (B.BRAND_MASTER_SID = @BRAND
AND @BRAND IS NOT NULL
AND @THERAPEUTIC_CLASS IS NULL)
OR (B.THERAPEUTIC_CLASS = @THERAPEUTIC_CLASS
AND B.BRAND_MASTER_SID = @BRAND)
OR (@THERAPEUTIC_CLASS IS NULL
AND @BRAND IS NULL)
GROUP BY B.BRAND_NAME,
         B.PERIOD_SID) B1
  ON A1.BRAND_NAME = B1.BRAND_NAME
  AND A1.PERIOD_SID = B1.PERIOD_SID
JOIN PERIOD AS PER
  ON PER.PERIOD_SID = A1.PERIOD_SID
GROUP BY per.year,
       A1.BRAND_NAME,
         @frequency_var

    ]]> </query>
    </entity>
</sql>