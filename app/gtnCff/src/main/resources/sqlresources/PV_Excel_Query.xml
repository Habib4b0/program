<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<sql>
    <entity id="GET_TABLE_NAME-AND-COLUMN">
        <query> 
            <![CDATA[
             SELECT TABLE_NAME,
       FIELD_NAME,
       LEVEL_VALUE_REFERENCE,
       RELATIONSHIP_LEVEL_VALUES,
       HLV.LEVEL_VALUES
FROM   RELATIONSHIP_LEVEL_DEFINITION RLD
       INNER JOIN CFF_CUSTOM_VIEW_DETAILS CVD
               ON CVD.HIERARCHY_ID = RLD.HIERARCHY_LEVEL_DEFINITION_SID
       INNER JOIN CFF_CUSTOM_VIEW_MASTER CVM
               ON CVD.CFF_CUSTOM_VIEW_MASTER_SID = CVM.CFF_CUSTOM_VIEW_MASTER_SID
       JOIN CFF_MASTER PM
         ON PM.CFF_MASTER_SID = CVM.CFF_MASTER_SID
       LEFT JOIN HIERARCHY_LEVEL_DEFINITION HLD
              ON HLD.HIERARCHY_LEVEL_DEFINITION_SID = RLD.HIERARCHY_LEVEL_DEFINITION_SID
       LEFT JOIN HIERARCHY_LEVEL_VALUES HLV
              ON HLV.HIERARCHY_LEVEL_DEFINITION_SID = HLD.HIERARCHY_LEVEL_DEFINITION_SID
WHERE  RLD.RELATIONSHIP_BUILDER_SID IN( PM.CUST_RELATIONSHIP_BUILDER_SID, PM.PROD_RELATIONSHIP_BUILDER_SID )
       AND PM.CFF_MASTER_SID = [$PROJECTION_MASTER_SID]
       AND CVM.CFF_CUSTOM_VIEW_MASTER_SID = [$CUSTOM_VIEW_MASTER_SID]

           ]]>
        </query> 
    </entity>
    
    
    <entity id="VW_HELPER_LIST_SELCTION">
        <query> 
            <![CDATA[
              select ACTUAL_TABLE_NAME,ACTUAL_COLUMN_NAME,REFERENCE_TABLE_NAME,REFERENCE_COLUMN_NAME,MAPPING_COLUMN_NAME,LIST_NAME,PRIMARY_KEY_COLUMN_NAME 
from VW_HELPER_LIST 
where ACTUAL_TABLE_NAME in ([$TABLE_NAMES])
and ACTUAL_COLUMN_NAME in ([$COLUMN_NAMES]) 
and MAPPING_COLUMN_NAME IS NOT  null
           ]]>
        </query> 
    </entity>
    
       
    <entity id="GET_CCP_VALUES">
        <query> 
            <![CDATA[
select CVD.LEVEL_NO AS LEVEL_NO,CCP.CFF_RELATIONSHIP_LEVEL_VALUES_SID AS LEVEL_SID,CCP.CCP_DETAILS_SID AS CCP_DETAILS_SID,CVD.CFF_CUSTOM_VIEW_DETAILS_SID as CFF_CUSTOM_VIEW_DETAILS_SID
from CFF_CUSTOM_VIEW CCP 
JOIN CFF_CUSTOM_VIEW_DETAILS CVD on CVD.CFF_CUSTOM_VIEW_DETAILS_SID=CCP.CFF_CUSTOM_VIEW_DETAILS_SID and CVD.CFF_CUSTOM_VIEW_MASTER_SID=[$CUSTOM_VIEW_MASTER_SID]
order by  CVD.LEVEL_NO,CCP.CFF_RELATIONSHIP_LEVEL_VALUES_SID
           ]]>
        </query> 
    </entity>
    
    <entity id="CUSTOM_CCP_MAP_INSERT_QUERY">
        <query> 
            <![CDATA[
DECLARE @CCP TABLE
  (
     CCP_DETAILS_SID                INT,
     CUST_HIERARCHY_NO              VARCHAR(100),
     CUST_RELATIONSHIP_LEVEL_VALUES INT,
     PROD_HIERARCHY_NO              VARCHAR(100),
     PROD_RELATIONSHIP_LEVEL_VALUES INT
  )
DECLARE @PROJECTION_MASTER_SID  INT=[$PROJECTION_MASTER_SID],
        @CUSTOM_VIEW_MASTER_SID INT = [$CUSTOM_VIEW_MASTER_SID]

INSERT @CCP
       (CCP_DETAILS_SID,
        CUST_HIERARCHY_NO,
        CUST_RELATIONSHIP_LEVEL_VALUES,
        PROD_HIERARCHY_NO,
        PROD_RELATIONSHIP_LEVEL_VALUES)
SELECT CCPMAPC.CCP_DETAILS_SID,
       CUST_HIERARCHY_NO,
       CUST_RELATIONSHIP_LEVEL_VALUES,
       PROD_HIERARCHY_NO,
       PROD_RELATIONSHIP_LEVEL_VALUES
FROM   (SELECT RLD.RELATIONSHIP_LEVEL_VALUES AS CUST_RELATIONSHIP_LEVEL_VALUES,
               RLD.HIERARCHY_NO              AS CUST_HIERARCHY_NO,
               CCP.CCP_DETAILS_SID
        FROM   RELATIONSHIP_LEVEL_DEFINITION RLD
               JOIN CCP_MAP CCP
                 ON RLD.RELATIONSHIP_LEVEL_SID = CCP.RELATIONSHIP_LEVEL_SID
               JOIN CFF_DETAILS PD
                 ON PD.CCP_DETAILS_SID = CCP.CCP_DETAILS_SID
               JOIN CFF_MASTER PM
                 ON PM.CFF_MASTER_SID = PD.CFF_MASTER_SID
                    AND RLD.RELATIONSHIP_BUILDER_SID = PM.CUST_RELATIONSHIP_BUILDER_SID
                    AND PD.CFF_MASTER_SID = @PROJECTION_MASTER_SID) CCPMAPC
       JOIN (SELECT RLD.RELATIONSHIP_LEVEL_VALUES AS PROD_RELATIONSHIP_LEVEL_VALUES,
                    RLD.HIERARCHY_NO              AS PROD_HIERARCHY_NO,
                    CCP.CCP_DETAILS_SID
             FROM   RELATIONSHIP_LEVEL_DEFINITION RLD
                    JOIN CCP_MAP CCP
                      ON RLD.RELATIONSHIP_LEVEL_SID = CCP.RELATIONSHIP_LEVEL_SID
                    JOIN CFF_DETAILS PD
                      ON PD.CCP_DETAILS_SID = CCP.CCP_DETAILS_SID
                    JOIN CFF_MASTER PM
                      ON PM.CFF_MASTER_SID = PD.CFF_MASTER_SID
                         AND RLD.RELATIONSHIP_BUILDER_SID = PM.PROD_RELATIONSHIP_BUILDER_SID
                         AND PD.CFF_MASTER_SID = @PROJECTION_MASTER_SID) CCPMAPP
         ON CCPMAPC.CCP_DETAILS_SID = CCPMAPP.CCP_DETAILS_SID;

WITH PIVOT_DATE
     AS (SELECT DISTINCT LEVEL_NO,
                         CCP_DETAILS_SID,
                         CUST_RELATIONSHIP_LEVEL_VALUES,
                         CUST_HIERARCHY_NO,
                         C_LEVEL_NAME,
                         RELATIONSHIP_LEVEL_VALUES,
                         CFF_CUSTOM_VIEW_DETAILS_SID
         FROM   @CCP
                JOIN (SELECT RLD2.HIERARCHY_NO,
                             CFF_CUSTOM_VIEW_DETAILS_SID,
                             RLD2.RELATIONSHIP_LEVEL_SID,
                             CVD.LEVEL_NO   AS LEVEL_NO,
                             HLD.LEVEL_NAME AS C_LEVEL_NAME,
                             RELATIONSHIP_LEVEL_VALUES
                      FROM   DBO.CFF_CUSTOM_VIEW_DETAILS CVD
                             JOIN DBO.HIERARCHY_LEVEL_DEFINITION HLD
                               ON CVD.HIERARCHY_ID = HLD.HIERARCHY_LEVEL_DEFINITION_SID
                                  AND CVD.CFF_CUSTOM_VIEW_MASTER_SID = @CUSTOM_VIEW_MASTER_SID
                             JOIN RELATIONSHIP_LEVEL_DEFINITION RLD2
                               ON HLD.HIERARCHY_LEVEL_DEFINITION_SID = RLD2.HIERARCHY_LEVEL_DEFINITION_SID
                             JOIN CFF_CUST_HIERARCHY PCH2
                               ON PCH2.RELATIONSHIP_LEVEL_SID = RLD2.RELATIONSHIP_LEVEL_SID
                                  AND PCH2.CFF_MASTER_SID = @PROJECTION_MASTER_SID) HLDC
                  ON CUST_HIERARCHY_NO LIKE HLDC.HIERARCHY_NO + '%'
         UNION ALL
         SELECT DISTINCT P_LEVEL_NO,
                         CCP_DETAILS_SID,
                         PROD_RELATIONSHIP_LEVEL_VALUES,
                         PROD_HIERARCHY_NO,
                         P_LEVEL_NAME,
                         RELATIONSHIP_LEVEL_VALUES,
                         CFF_CUSTOM_VIEW_DETAILS_SID
         FROM   @CCP
                JOIN (SELECT RLD2.HIERARCHY_NO,
                             CFF_CUSTOM_VIEW_DETAILS_SID,
                             RLD2.RELATIONSHIP_LEVEL_SID,
                             CVD.LEVEL_NO   AS P_LEVEL_NO,
                             HLD.LEVEL_NAME AS P_LEVEL_NAME,
                             RELATIONSHIP_LEVEL_VALUES
                      FROM   DBO.CFF_CUSTOM_VIEW_DETAILS CVD
                             JOIN DBO.HIERARCHY_LEVEL_DEFINITION HLD
                               ON CVD.HIERARCHY_ID = HLD.HIERARCHY_LEVEL_DEFINITION_SID
                                  AND CVD.CFF_CUSTOM_VIEW_MASTER_SID = @CUSTOM_VIEW_MASTER_SID
                             JOIN RELATIONSHIP_LEVEL_DEFINITION RLD2
                               ON HLD.HIERARCHY_LEVEL_DEFINITION_SID = RLD2.HIERARCHY_LEVEL_DEFINITION_SID
                             JOIN CFF_PROD_HIERARCHY PCH2
                               ON PCH2.RELATIONSHIP_LEVEL_SID = RLD2.RELATIONSHIP_LEVEL_SID
                                  AND PCH2.CFF_MASTER_SID = @PROJECTION_MASTER_SID) HLDP
                  ON PROD_HIERARCHY_NO LIKE HLDP.HIERARCHY_NO + '%')
INSERT INTO CFF_CUSTOM_VIEW
            (CFF_CUSTOM_VIEW_DETAILS_SID,
             CFF_RELATIONSHIP_LEVEL_VALUES_SID,
             CCP_DETAILS_SID)
SELECT CFF_CUSTOM_VIEW_DETAILS_SID,
       RELATIONSHIP_LEVEL_VALUES,
       CCP_DETAILS_SID
FROM   PIVOT_DATE PD
WHERE  NOT EXISTS(SELECT 1
                  FROM   CFF_CUSTOM_VIEW CCM
                  WHERE  CCM.CFF_CUSTOM_VIEW_DETAILS_SID = PD.CFF_CUSTOM_VIEW_DETAILS_SID
                         AND CCM.CFF_RELATIONSHIP_LEVEL_VALUES_SID = PD.RELATIONSHIP_LEVEL_VALUES
                         AND CCM.CCP_DETAILS_SID = PD.CCP_DETAILS_SID) 
           ]]>
        </query> 
    </entity>
           
    <entity id="INSERT_CUSTOM_RELATIONSHIP_BUILDER">
        <query> 
            <![CDATA[ 
INSERT INTO CFF_CUSTOM_RELATIONSHIP_BUILDER     (CFF_CUSTOM_VIEW_DETAILS_SID,RELATIONSHIP_LEVEL_VALUES,CUSTOM_HIERARCHY_NO) 
VALUES          ]]>
        </query> 
    </entity>
    
    <entity id="INSERT_CUSTOM_RELATIONSHIP_BUILDER_SUB">
        <query> 
            <![CDATA[ ('[$CUSTOM_VIEW_DETAILS_SID]','[$RELATIONSHIP_LEVEL_VALUES]','[$CUSTOM_HIERARCHY_NO]')]]>
        </query> 
    </entity>
    
    <entity id="DELETE_CUSTOM_VIEW_TABLES">
        <query> 
            <![CDATA[
             DECLARE @custom_view_master INT = [$CUSTOM_VIEW_MASTER_SID]

DELETE ccm
FROM   CFF_CUSTOM_VIEW ccm
WHERE  EXISTS (SELECT 1
               FROM   CFF_CUSTOM_VIEW_DETAILS cvd
               WHERE  cvd.CFF_CUSTOM_VIEW_DETAILS_SID = ccm.CFF_CUSTOM_VIEW_DETAILS_SID
                      AND cvd.CFF_CUSTOM_VIEW_MASTER_SID = @custom_view_master)

DELETE crb
FROM   CFF_CUSTOM_RELATIONSHIP_BUILDER crb
WHERE  EXISTS (SELECT 1
               FROM   CFF_CUSTOM_VIEW_DETAILS cvd
               WHERE  cvd.CFF_CUSTOM_VIEW_DETAILS_SID = crb.CFF_CUSTOM_VIEW_DETAILS_SID
                      AND cvd.CFF_CUSTOM_VIEW_MASTER_SID = @custom_view_master) 

           ]]>
        </query> 
    </entity>
    <entity id="FIND_CUSTOM_RELATIOSHIP_BUILDER">
        <query> 
            <![CDATA[
select CRB.RELATIONSHIP_LEVEL_VALUES as RELATIONSHIP_LEVEL_VALUES,CRB.CUSTOM_HIERARCHY_NO from CFF_CUSTOM_RELATIONSHIP_BUILDER CRB 
join CFF_CUSTOM_VIEW_DETAILS CVD on CVD.CFF_CUSTOM_VIEW_DETAILS_SID=CRB.CFF_CUSTOM_VIEW_DETAILS_SID 
and CVD.CFF_CUSTOM_VIEW_MASTER_SID =[$CUSTOM_VIEW_MASTER_SID]
           ]]>
        </query> 
    </entity>
    
    <entity id="get-projection-names-by-id">
        <query> 
        <![CDATA[
            SELECT CFF_MASTER_SID,CFF_NAME FROM 
            CFF_MASTER WHERE CFF_MASTER_SID IN (@CFF_MASTER_SID);
        ]]>
        </query> 
    </entity>
    
</sql>