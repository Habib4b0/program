<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE xml>

<sql>

	<entity id="RelationCustHierarchy">
		<query> 
<![CDATA[

DECLARE @RelationVersion INT
SET @RelationVersion = (SELECT VERSION_NO FROM RELATIONSHIP_BUILDER WHERE RELATIONSHIP_BUILDER_SID = ?)
     
IF Object_id('TEMPDB..#SELECTED_CUST_RELATION') IS NOT NULL DROP
	TABLE
		#SELECTED_CUST_RELATION CREATE
			TABLE
				#SELECTED_CUST_RELATION(
					RELATIONSHIP_LEVEL_SID INT,
				) insert
					into
						#SELECTED_CUST_RELATION(RELATIONSHIP_LEVEL_SID) SELECT
							RELATIONSHIP_LEVEL_SID
						from
							dbo.PROJECTION_CUST_HIERARCHY
						where
							PROJECTION_MASTER_SID = ?;
DELete from PROJECTION_CUST_HIERARCHY where PROJECTION_MASTER_SID=?
INSERT
	into
		PROJECTION_CUST_HIERARCHY(
			PROJECTION_MASTER_SID,
			RELATIONSHIP_LEVEL_SID
		) SELECT
			PM.PROJECTION_MASTER_SID,
			RLD1.RELATIONSHIP_LEVEL_SID
		from
			PROJECTION_MASTER PM
		JOIN RELATIONSHIP_LEVEL_DEFINITION as RLD on
			PM.CUST_RELATIONSHIP_BUILDER_SID = RLD.RELATIONSHIP_BUILDER_SID
		JOIN #SELECTED_CUST_RELATION PCH on
			PCH.RELATIONSHIP_LEVEL_SID = RLD.RELATIONSHIP_LEVEL_SID
			and pm.PROJECTION_CUST_VERSION = rld.VERSION_NO
			and rld.RELATIONSHIP_BUILDER_SID = ?
			and PM.PROJECTION_MASTER_SID = ?
		JOIN RELATIONSHIP_LEVEL_DEFINITION RLD1 on
			RLD1.RELATIONSHIP_BUILDER_SID = RLD.RELATIONSHIP_BUILDER_SID
			and RLD1.HIERARCHY_NO = rld.HIERARCHY_NO
			and rld1.VERSION_NO=@RelationVersion;
			
			update PROJECTION_MASTER set PROJECTION_CUST_VERSION=@RelationVersion where PROJECTION_MASTER_SID = ?
			
        ]]>
		</query>
	</entity>
	<entity id="RelationProdHierarchy">
		<query> 
<![CDATA[
   
    
    DECLARE @RelationVersion INT
SET @RelationVersion = (SELECT VERSION_NO FROM RELATIONSHIP_BUILDER WHERE RELATIONSHIP_BUILDER_SID = ?)
IF Object_id('TEMPDB..#SELECTED_PROD_RELATION') IS NOT NULL DROP
	TABLE
		#SELECTED_PROD_RELATION CREATE
			TABLE
				#SELECTED_PROD_RELATION(
					RELATIONSHIP_LEVEL_SID INT,
				) insert
					into
						#SELECTED_PROD_RELATION(RELATIONSHIP_LEVEL_SID) SELECT
							RELATIONSHIP_LEVEL_SID
						from
							PROJECTION_PROD_HIERARCHY
						where
							PROJECTION_MASTER_SID = ?;
		DELete from PROJECTION_PROD_HIERARCHY where PROJECTION_MASTER_SID=?;

INSERT
	into
		PROJECTION_PROD_HIERARCHY(
			PROJECTION_MASTER_SID,
			RELATIONSHIP_LEVEL_SID
		) SELECT
			PM.PROJECTION_MASTER_SID,
			RLD1.RELATIONSHIP_LEVEL_SID
		from
			PROJECTION_MASTER PM
		JOIN RELATIONSHIP_LEVEL_DEFINITION as RLD on
			PM.PROD_RELATIONSHIP_BUILDER_SID = RLD.RELATIONSHIP_BUILDER_SID
		JOIN #SELECTED_PROD_RELATION PCH on
			PCH.RELATIONSHIP_LEVEL_SID = RLD.RELATIONSHIP_LEVEL_SID
			and pm.PROJECTION_PROD_VERSION = rld.VERSION_NO
			and rld.RELATIONSHIP_BUILDER_SID = ?
			and PM.PROJECTION_MASTER_SID = ?
		JOIN RELATIONSHIP_LEVEL_DEFINITION RLD1 on
			RLD1.RELATIONSHIP_BUILDER_SID = RLD.RELATIONSHIP_BUILDER_SID
			and RLD1.HIERARCHY_NO = rld.HIERARCHY_NO
			and rld1.VERSION_NO=@RelationVersion;
			
			update PROJECTION_MASTER set PROJECTION_PROD_VERSION=@RelationVersion where PROJECTION_MASTER_SID = ?
        ]]>
		</query>
	</entity>
	<entity id="checkCustRelationIsUPdateed">
		<query> 
<![CDATA[
    if EXISTS(
	SELECT
		1
	from
		dbo.RELATIONSHIP_BUILDER
	where
		RELATIONSHIP_BUILDER_SID = ?
		and VERSION_NO = ?
) BEGIN SELECT
	0
	END
	ELSE IF EXISTS(
		SELECT
			1
		from
			dbo.PROJECTION_MASTER pm
		where
			PROJECTION_MASTER_SID = ?
			and CUSTOMER_HIERARCHY_SID = ?
			and CUSTOMER_HIER_VERSION_NO=?
			and CUST_RELATIONSHIP_BUILDER_SID=?
	) BEGIN SELECT
		1 END
		ELSE  SELECT 0
	;
        ]]>
		</query>
	</entity>
	<entity id="checkProdRelationIsUPdateed">
		<query> 
<![CDATA[
    if EXISTS(
	SELECT
		1
	from
		dbo.RELATIONSHIP_BUILDER
	where
		RELATIONSHIP_BUILDER_SID = ?
		and VERSION_NO = ?
) BEGIN SELECT
	0
	END
	ELSE IF EXISTS(
		SELECT
			1
		from
			dbo.PROJECTION_MASTER pm
		where
				PROJECTION_MASTER_SID = ?
			and PRODUCT_HIERARCHY_SID = ?
			and PRODUCT_HIER_VERSION_NO=?
			and PROD_RELATIONSHIP_BUILDER_SID=?
	) BEGIN SELECT
		1 END
		ELSE  SELECT 0
	;
        ]]>
		</query>
	</entity>

</sql>