<?xml version="1.0"?>
<custom-sql>    
    
    <sql id="checktpcustomeractual">
        
        <![CDATA[            
            SELECT COUNT(DISTINCT PROJECTION_DETAILS_SID)
FROM   PROJECTION_DETAILS P
       JOIN CCP_DETAILS C
         ON P.CCP_DETAILS_SID = C.CCP_DETAILS_SID
            JOIN  (SELECT
                        DISTINCT CCP.COMPANY_MASTER_SID
                    FROM
                        PROJECTION_DETAILS PD 
                    JOIN CCP_DETAILS CCP
                                   ON CCP.CCP_DETAILS_SID = PD.CCP_DETAILS_SID  AND PD.PROJECTION_MASTER_SID = @PROJECTION_ID 
                    LEFT JOIN ACTUALS_MASTER AM
                            ON AM.COMPANY_MASTER_SID = CCP.COMPANY_MASTER_SID AND AM.ITEM_MASTER_SID = CCP.ITEM_MASTER_SID AND AM.CONTRACT_MASTER_SID = CCP.CONTRACT_MASTER_SID
                    GROUP BY
                        CCP.COMPANY_MASTER_SID
                    HAVING
                        SUM(AM.SALES_AMOUNT) = 0
                        OR SUM(AM.SALES_AMOUNT) IS NULL) COMP
         ON COMP.COMPANY_MASTER_SID = C.COMPANY_MASTER_SID
            AND P.PROJECTION_MASTER_SID = @PROJECTION_ID;
        ]]>
        
    </sql>
    
    <sql id="remove-tp-customer-with-no-actuals">
        
        <![CDATA[
            DELETE PCH
            FROM   PROJECTION_CUST_HIERARCHY PCH
            JOIN   CCP_MAP CCM ON CCM.RELATIONSHIP_LEVEL_SID = PCH.RELATIONSHIP_LEVEL_SID
            JOIN   CCP_DETAILS C ON CCM.CCP_DETAILS_SID = C.CCP_DETAILS_SID
            JOIN  (SELECT
                        DISTINCT CCP.COMPANY_MASTER_SID
                    FROM
                        PROJECTION_DETAILS PD 
                    JOIN CCP_DETAILS CCP
                                   ON CCP.CCP_DETAILS_SID = PD.CCP_DETAILS_SID  AND PD.PROJECTION_MASTER_SID = @PROJECTION_ID 
                    LEFT JOIN ACTUALS_MASTER AM
                            ON AM.COMPANY_MASTER_SID = CCP.COMPANY_MASTER_SID AND AM.ITEM_MASTER_SID = CCP.ITEM_MASTER_SID AND AM.CONTRACT_MASTER_SID = CCP.CONTRACT_MASTER_SID
                    GROUP BY
                        CCP.COMPANY_MASTER_SID
                    HAVING
                        SUM(AM.SALES_AMOUNT) = 0
                        OR SUM(AM.SALES_AMOUNT) IS NULL) COMP
                           ON COMP.COMPANY_MASTER_SID = C.COMPANY_MASTER_SID
                   AND PCH.PROJECTION_MASTER_SID = @PROJECTION_ID;
    
            DELETE  P       
            FROM   PROJECTION_DETAILS P
                   JOIN CCP_DETAILS C
                     ON P.CCP_DETAILS_SID = C.CCP_DETAILS_SID
            JOIN  (SELECT
                        DISTINCT CCP.COMPANY_MASTER_SID
                    FROM
                        PROJECTION_DETAILS PD 
                    JOIN CCP_DETAILS CCP
                                   ON CCP.CCP_DETAILS_SID = PD.CCP_DETAILS_SID  AND PD.PROJECTION_MASTER_SID = @PROJECTION_ID 
                    LEFT JOIN ACTUALS_MASTER AM
                            ON AM.COMPANY_MASTER_SID = CCP.COMPANY_MASTER_SID AND AM.ITEM_MASTER_SID = CCP.ITEM_MASTER_SID AND AM.CONTRACT_MASTER_SID = CCP.CONTRACT_MASTER_SID
                    GROUP BY
                        CCP.COMPANY_MASTER_SID
                    HAVING
                        SUM(AM.SALES_AMOUNT) = 0
                        OR SUM(AM.SALES_AMOUNT) IS NULL) COMP
                           ON COMP.COMPANY_MASTER_SID = C.COMPANY_MASTER_SID
                   AND P.PROJECTION_MASTER_SID = @PROJECTION_ID;
        ]]>        
    </sql>
    
</custom-sql>