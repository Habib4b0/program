<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<sql>
    <entity id="updateCfpDetailsAttched">
        <query>
            <![CDATA[					       
                DECLARE @CFP_MODEL_SID      VARCHAR(100) = '?',
                        @USERS_SID          VARCHAR(100) = '?',
                        @SESSION_ID         VARCHAR(100) = '?',
                        @IMTD_CREATED_DATE  VARCHAR(100) = '?'
                DELETE
                FROM
                        DBO.CFP_DETAILS
                WHERE
                        CFP_MODEL_SID = @CFP_MODEL_SID;

                INSERT
                    INTO
                        DBO.CFP_DETAILS(
                            COMPANY_MASTER_SID,
                            COMPANY_START_DATE,
                            COMPANY_END_DATE,
                            TRADING_PARTNER_CONTRACT_NO,
                            COMPANY_CFP_ATTACHED_STATUS,
                            COMPANY_CFP_ATTACHED_DATE,
                            CREATED_BY,
                            CREATED_DATE,
                            TRADE_CLASS,
                            CFP_MODEL_SID,
                            INBOUND_STATUS,
                            RECORD_LOCK_STATUS,
                            MODIFIED_BY
                        ) SELECT
                                ICD.COMPANY_MASTER_SID,
                                ICD.CFP_DETAILS_START_DATE,
                                ICD.CFP_DETAILS_END_DATE,
                                ICD.TRADING_PARTNER_CONTRACT_NO,
                                ICD.CFP_DETAILS_ATTACHED_STATUS,
                                ICD.CFP_DETAILS_ATTACHED_DATE,
                                ICD.CFP_DETAILS_CREATED_BY,
                                ICD.CFP_DETAILS_CREATED_DATE,
                                HT.HELPER_TABLE_SID,
                                @CFP_MODEL_SID,
                                'A',
                                0,
                                @USERS_SID
                        FROM
                                IMTD_CFP_DETAILS ICD
                                JOIN HELPER_TABLE HT ON ICD.CFP_DETAILS_TRADE_CLASS = HT.DESCRIPTION
                                AND LIST_NAME LIKE 'COMPANY_TRADE_CLASS'
                        WHERE
                                USERS_SID = @USERS_SID
                                AND SESSION_ID = @SESSION_ID
                                AND IMTD_CREATED_DATE = @IMTD_CREATED_DATE
                                AND CHECK_RECORD = 1
                                AND "OPERATION" <> 'D';

                DELETE
                FROM
                        DBO.IMTD_CFP_DETAILS
                WHERE
                        USERS_SID = @USERS_SID
                        AND SESSION_ID = @SESSION_ID
                        AND IMTD_CREATED_DATE = @IMTD_CREATED_DATE;
                ]]>
        </query>
    </entity>
    <entity id="insertTempCfpDetailsEdit">
        <query>
            <![CDATA[					       
                DECLARE @CFP_MODEL_SID        VARCHAR(100) = '?',
                        @USERS_SID            VARCHAR(100) = '?',
                        @SESSION_ID           VARCHAR(100) = '?',
                        @IMTD_CREATED_DATE    VARCHAR(100) = '?',
                        @IMTD_YCREATED_DATE   VARCHAR(100) = '?'
                DELETE
                FROM
                        IMTD_CFP_DETAILS
                WHERE
                        IMTD_CREATED_DATE = @IMTD_YCREATED_DATE;

                DELETE
                FROM
                        DBO.IMTD_CFP_DETAILS
                WHERE
                        USERS_SID = @USERS_SID
                        AND SESSION_ID = @SESSION_ID
                        AND IMTD_CREATED_DATE = @IMTD_CREATED_DATE;

                INSERT
                        INTO
                                DBO.IMTD_CFP_DETAILS(
                                        COMPANY_MASTER_SID,
                                        CFP_DETAILS_SID,
                                        COMPANY_ID,
                                        COMPANY_NO,
                                        COMPANY_NAME,
                                        COMPANY_TYPE,
                                        COMPANY_START_DATE,
                                        COMPANY_END_DATE,
                                        COMPANY_STATUS,
                                        TRADING_PARTNER_CONTRACT_NO,
                                        CFP_DETAILS_ATTACHED_DATE,
                                        CFP_DETAILS_START_DATE,
                                        CFP_DETAILS_END_DATE,
                                        CFP_DETAILS_ATTACHED_STATUS,
                                        CFP_DETAILS_CREATED_BY,
                                        CFP_DETAILS_CREATED_DATE,
                                        CFP_DETAILS_TRADE_CLASS,
                                        "OPERATION",
                                        CFP_DETAILS_MODIFIED_DATE,
                                        CFP_DETAILS_MODIFIED_BY,
                                        USERS_SID,
                                        SESSION_ID,
                                        IMTD_CREATED_DATE,
                                        CHECK_RECORD,
                                        CFP_MODEL_SID
                                ) SELECT
                                        CM.COMPANY_MASTER_SID,
                                        CFP.CFP_DETAILS_SID,
                                        CM.COMPANY_ID,
                                        CM.COMPANY_NO,
                                        CM.COMPANY_NAME,
                                        CM.COMPANY_TYPE,
                                        CM.COMPANY_START_DATE,
                                        CM.COMPANY_END_DATE,
                                        CM.COMPANY_STATUS,
                                        CFP.TRADING_PARTNER_CONTRACT_NO,
                                        CFP.COMPANY_CFP_ATTACHED_DATE,
                                        CFP.COMPANY_START_DATE,
                                        CFP.COMPANY_END_DATE,
                                        CFP.COMPANY_CFP_ATTACHED_STATUS,
                                        CFP.CREATED_BY,
                                        CFP.CREATED_DATE,
                                        HT.DESCRIPTION AS CFP_DETAILS_TRADE_CLASS,
                                        CASE
                                                WHEN CFP.INBOUND_STATUS <> 'D' THEN 'A'
                                                ELSE 'F'
                                        END,
                                        @IMTD_CREATED_DATE,
                                        @USERS_SID,
                                        @USERS_SID,
                                        @SESSION_ID,
                                        @IMTD_CREATED_DATE,
                                        1,
                                        @CFP_MODEL_SID
                                FROM
                                        CFP_DETAILS CFP
                                JOIN COMPANY_MASTER CM ON
                                        CM.COMPANY_MASTER_SID = CFP.COMPANY_MASTER_SID
                                JOIN COMPANY_TRADE_CLASS CTC ON
                                        CTC.COMPANY_MASTER_SID = CM.COMPANY_MASTER_SID
                                        AND CFP.TRADE_CLASS = CTC.COMPANY_TRADE_CLASS
                                JOIN HELPER_TABLE HT ON
                                        HT.HELPER_TABLE_SID = CTC.COMPANY_TRADE_CLASS
                                WHERE
                                        CM.INBOUND_STATUS <> 'D'
                                        AND CTC.INBOUND_STATUS <> 'D'
                                        AND CFP.CFP_MODEL_SID = @CFP_MODEL_SID
                ]]>
        </query>
    </entity>
</sql>