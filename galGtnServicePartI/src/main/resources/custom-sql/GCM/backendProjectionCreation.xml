<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<custom-sql>
    <sql id="getHierarchyMapQuery">
		<![CDATA[
                    SELECT RLD.RELATIONSHIP_LEVEL_SID,
                    RLD.RELATIONSHIP_LEVEL_VALUES,
                    RLD.LEVEL_NO,
                    RLD.LEVEL_NAME,
                    RLD.HIERARCHY_NO,
                    CASE WHEN HLD.TABLE_NAME=JVIEW.REFERENCE_TABLE_NAME THEN HLD.TABLE_NAME ELSE JVIEW.REFERENCE_TABLE_NAME  END AS TABLE_NAME,
                    CASE WHEN JVIEW.MAPPING_COLUMN_NAME is null THEN JVIEW.PRIMARY_KEY_COLUMN_NAME ELSE JVIEW.MAPPING_COLUMN_NAME  END AS FIELD_NAME,
                    HT.DESCRIPTION,
                    RLD.PARENT_NODE, RLD.FLAG
                    FROM RELATIONSHIP_LEVEL_DEFINITION RLD 
                    JOIN HIERARCHY_LEVEL_DEFINITION HLD ON HLD.HIERARCHY_LEVEL_DEFINITION_SID=RLD.HIERARCHY_LEVEL_DEFINITION_SID 
                        AND (HLD.TABLE_NAME <>'') 
                    AND RLD.RELATIONSHIP_BUILDER_SID = ? 
                    JOIN HIERARCHY_DEFINITION HD ON HD.HIERARCHY_DEFINITION_SID=HLD.HIERARCHY_DEFINITION_SID
                    JOIN vw_helper_list JVIEW ON JVIEW.ACTUAL_TABLE_NAME=HLD.TABLE_NAME AND JVIEW.ACTUAL_COLUMN_NAME=HLD.FIELD_NAME
                    JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=HD.HIERARCHY_CATEGORY 
                    ORDER BY RLD.HIERARCHY_NO;
                ]]>
    </sql>
    <sql id="nm.saveCcp">
		<![CDATA[
                   MERGE PROJECTION_DETAILS AS TARGET
                   USING (SELECT distinct ?PMPROJECTION_MASTER_SID, CCP1.CCP_DETAILS_SID FROM 
                    (SELECT CCP.CCP_DETAILS_SID
                    FROM RELATIONSHIP_LEVEL_DEFINITION RLD, 
                    CCP_MAP CCP 
                    WHERE RLD.HIERARCHY_NO like '?HN%' 
                    AND CCP.RELATIONSHIP_LEVEL_SID=RLD.RELATIONSHIP_LEVEL_SID) CCP1, 
                    (SELECT distinct CCPD.CCP_DETAILS_SID 
                    FROM CCP_MAP CCP JOIN RELATIONSHIP_LEVEL_DEFINITION RLD 
                    ON CCP.RELATIONSHIP_LEVEL_SID=RLD.RELATIONSHIP_LEVEL_SID 
                    JOIN PROJECTION_PROD_HIERARCHY PPH 
                    ON PPH.RELATIONSHIP_LEVEL_SID=RLD.RELATIONSHIP_LEVEL_SID AND PPH.PROJECTION_MASTER_SID=?PM
                    JOIN CCP_DETAILS CCPD ON CCP.CCP_DETAILS_SID=CCPD.CCP_DETAILS_SID) CCP2 
                    WHERE CCP1.CCP_DETAILS_SID=CCP2.CCP_DETAILS_SID) AS SOURCE
                   ON ( TARGET.PROJECTION_MASTER_SID = SOURCE.PROJECTION_MASTER_SID
                   AND TARGET.CCP_DETAILS_SID = SOURCE.CCP_DETAILS_SID)
                   WHEN NOT MATCHED THEN
                   INSERT (PROJECTION_MASTER_SID,CCP_DETAILS_SID)
                   VALUES (SOURCE.PROJECTION_MASTER_SID, SOURCE.CCP_DETAILS_SID); 

                ]]>
    </sql>
    
    <sql id="nm.salesTableUpdate">
	<![CDATA[
            Update NM_SALES_PROJECTION  SET PROJECTION_SALES=0,PROJECTION_UNITS=0 Where 
            PERIOD_SID>=(select PERIOD_SID from PERIOD  Where "MONTH"=MONTH(GETDATE()) and "YEAR" = YEAR(GETDATE())) 
            and PROJECTION_DETAILS_SID in(
            select distinct PROJECTION_DETAILS_SID from PROJECTION_DETAILS PD 
            JOIN CCP_DETAILS CCP_D ON CCP_D.CCP_DETAILS_SID=PD.CCP_DETAILS_SID 
            AND CCP_D.CONTRACT_MASTER_SID=?CON AND CCP_D.?FIELD in (?COM) 
            Where PD.PROJECTION_MASTER_SID=?PM) ;
                ]]>
    </sql>
    <sql id="nm.discountTableUpdate">
	<![CDATA[
            Update NM_DISCOUNT_PROJECTION  SET PROJECTION_SALES=0,PROJECTION_RATE=0 Where 
            PERIOD_SID>=(select PERIOD_SID from PERIOD  Where "MONTH"=MONTH(GETDATE()) and "YEAR" = YEAR(GETDATE())) 
            and PROJECTION_DETAILS_SID in(
            select distinct PROJECTION_DETAILS_SID from PROJECTION_DETAILS PD 
            JOIN CCP_DETAILS CCP_D ON CCP_D.CCP_DETAILS_SID=PD.CCP_DETAILS_SID 
            AND CCP_D.CONTRACT_MASTER_SID=?CON AND CCP_D.?FIELD in (?COM) 
            Where PD.PROJECTION_MASTER_SID=?PM) ;
                ]]>
    </sql>
    <sql id="nm.ppaTableUpdate">
	<![CDATA[
            Update NM_PPA_PROJECTION SET PROJECTION_SALES=0,PROJECTION_RATE=0 Where 
            PERIOD_SID>=(select PERIOD_SID from PERIOD  Where "MONTH"=MONTH(GETDATE()) and "YEAR" = YEAR(GETDATE())) 
            and PROJECTION_DETAILS_SID in(
            select distinct PROJECTION_DETAILS_SID from PROJECTION_DETAILS PD  
            JOIN CCP_DETAILS CCP_D ON CCP_D.CCP_DETAILS_SID=PD.CCP_DETAILS_SID 
            AND CCP_D.CONTRACT_MASTER_SID=?CON AND CCP_D.?FIELD in (?COM) 
            Where PD.PROJECTION_MASTER_SID=?PM) ;
                ]]>
    </sql>
    <sql id="man.salesTableUpdate">
	<![CDATA[
            Update M_SALES_PROJECTION  SET PROJECTION_SALES=0,PROJECTION_UNITS=0 Where 
            PERIOD_SID>=(select PERIOD_SID from PERIOD  Where "MONTH"=MONTH(GETDATE()) and "YEAR" = YEAR(GETDATE())) 
            and PROJECTION_DETAILS_SID in(
            select distinct PROJECTION_DETAILS_SID from PROJECTION_DETAILS PD 
            JOIN CCP_DETAILS CCP_D ON CCP_D.CCP_DETAILS_SID=PD.CCP_DETAILS_SID 
            AND CCP_D.CONTRACT_MASTER_SID=?CON AND CCP_D.?FIELD in (?COM)
            Where PD.PROJECTION_MASTER_SID=?PM) ;
                ]]>
    </sql>
    <sql id="man.discountTableUpdate">
	<![CDATA[
            Update M_DISCOUNT_PROJECTION  SET PROJECTION_SALES=0,PROJECTION_RATE=0 Where 
            PERIOD_SID>=(select PERIOD_SID from PERIOD  Where "MONTH"=MONTH(GETDATE()) and "YEAR" = YEAR(GETDATE())) 
            and PROJECTION_DETAILS_SID in(
            select distinct PROJECTION_DETAILS_SID from PROJECTION_DETAILS PD  
            JOIN CCP_DETAILS CCP_D ON CCP_D.CCP_DETAILS_SID=PD.CCP_DETAILS_SID 
            AND CCP_D.CONTRACT_MASTER_SID=?CON AND CCP_D.?FIELD in (?COM) 
            Where PD.PROJECTION_MASTER_SID=?PM) ;
                ]]>
    </sql>
    <sql id="man.suppTableUpdate">
	<![CDATA[
            Update M_SUPPLEMENTAL_DISC_PROJ SET PROJECTION_SALES=0,PROJECTION_RATE=0 Where 
            PERIOD_SID>=(select PERIOD_SID from PERIOD  Where "MONTH"=MONTH(GETDATE()) and "YEAR" = YEAR(GETDATE())) 
            and PROJECTION_DETAILS_SID in(
            select distinct PROJECTION_DETAILS_SID from PROJECTION_DETAILS PD   
            JOIN CCP_DETAILS CCP_D ON CCP_D.CCP_DETAILS_SID=PD.CCP_DETAILS_SID 
            AND CCP_D.CONTRACT_MASTER_SID=?CON AND CCP_D.?FIELD in (?COM) 
            Where PD.PROJECTION_MASTER_SID=?PM) ;
                ]]>
    </sql>
    <sql id="nm.removediscountupdate">
	<![CDATA[
            UPDATE ST_NM_DISCOUNT_PROJECTION  SET PROJECTION_SALES=0,PROJECTION_RATE=0 Where
                PERIOD_SID>=(select PERIOD_SID from PERIOD  Where "MONTH"=MONTH(GETDATE()) and "YEAR" = YEAR(GETDATE()) ) AND
                PROJECTION_DETAILS_SID in(
                select distinct PROJECTION_DETAILS_SID from PROJECTION_DETAILS PD
                JOIN CCP_DETAILS CCP_D ON CCP_D.CCP_DETAILS_SID=PD.CCP_DETAILS_SID
                AND CCP_D.CONTRACT_MASTER_SID = ?CON  AND CCP_D.COMPANY_MASTER_SID IN (?COM)
                Where PD.PROJECTION_MASTER_SID=?PM
                )AND  RS_MODEL_SID IN (SELECT RS_MODEL_SID FROM RS_CONTRACT 
                WHERE RS_CONTRACT_SID IN (?RS)) ;
                ]]>
    </sql>
</custom-sql>
