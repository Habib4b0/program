IF EXISTS (SELECT 'X'
           FROM   INFORMATION_SCHEMA.ROUTINES
           WHERE  ROUTINE_NAME = 'PRC_PROJECTION_RESULTS_DISCOUNT'
                  AND ROUTINE_SCHEMA = 'DBO')
  BEGIN
      DROP PROCEDURE [DBO].[PRC_PROJECTION_RESULTS_DISCOUNT]
  END

GO


CREATE PROCEDURE [dbo].[PRC_PROJECTION_RESULTS_DISCOUNT] (
	@PROJECTION_SID VARCHAR(500)
	,@PROJ_FREQUENCY VARCHAR(20)
	,@DISCOUNT_ID NVARCHAR(MAX)
	,---INPUT IS  RS_CONTRACT_SID --GAL-1163
	@SCREEN_NAME VARCHAR(50)
	,@SESSION_ID VARCHAR(50)
	,@USER_ID INT
	,@ORDER_FLAG BIT
	,@PROGRAM_TYPE VARCHAR(50) = 'Program'
	,@CCP            VARCHAR(MAX) = NULL
	,@SALES_INCLUSION BIT
	,@DEDUCTION_INCLUSION BIT
	,@UOM_CODE VARCHAR(10)
	,@FILTER_UDCS VARCHAR(MAX)=NULL
	)
AS
BEGIN
SET NOCOUNT ON
DECLARE @SP INT
		,@SP_PROJ_SID INT
		,@TEMP_PROJ_SID VARCHAR(500)
		,@START_PERIOD_SID INT
		,@END_PERIOD_SID INT
		,@STARTFROM DATE
		,@START_DATE DATE
		,@PROJECTION_DATE DATE
		,@PROJ_START_PERIOD_SID INT,
         @CURRENT_DATE                  DATE

DECLARE @SALES_ACTUAL_TABLE VARCHAR(200) = CONCAT (
		'ST_NM_ACTUAL_SALES_'
		,@USER_ID
		,'_'
		,@SESSION_ID
		,'_'
		,REPLACE(CONVERT(VARCHAR(50), GETDATE(), 2), '.', '')
		)
	,@SALES_PROJECTION_TABLE VARCHAR(200) = CONCAT (
		'ST_NM_SALES_PROJECTION_'
		,@USER_ID
		,'_'
		,@SESSION_ID
		,'_'
		,REPLACE(CONVERT(VARCHAR(50), GETDATE(), 2), '.', '')
		)
	,@SALES_MASTER_TABLE VARCHAR(200) = CONCAT (
		'ST_NM_SALES_PROJECTION_MASTER_'
		,@USER_ID
		,'_'
		,@SESSION_ID
		,'_'
		,REPLACE(CONVERT(VARCHAR(50), GETDATE(), 2), '.', '')
		)
	,@DISC_PROJECTION_TABLE VARCHAR(200) = CONCAT (
		'ST_NM_DISCOUNT_PROJECTION_'
		,@USER_ID
		,'_'
		,@SESSION_ID
		,'_'
		,REPLACE(CONVERT(VARCHAR(50), GETDATE(), 2), '.', '')
		)
	,@DISC_ACTUAL_TABLE VARCHAR(200) = CONCAT (
		'ST_NM_ACTUAL_DISCOUNT_'
		,@USER_ID
		,'_'
		,@SESSION_ID
		,'_'
		,REPLACE(CONVERT(VARCHAR(50), GETDATE(), 2), '.', '')
		)
	,@DISC_MASTER_TABLE VARCHAR(200) = CONCAT (
		'ST_NM_DISCOUNT_PROJ_MASTER_'
		,@USER_ID
		,'_'
		,@SESSION_ID
		,'_'
		,REPLACE(CONVERT(VARCHAR(50), GETDATE(), 2), '.', '')
		)
	,@PPA_PROJECTION_TABLE VARCHAR(200) = CONCAT (
		'ST_NM_PPA_PROJECTION_'
		,@USER_ID
		,'_'
		,@SESSION_ID
		,'_'
		,REPLACE(CONVERT(VARCHAR(50), GETDATE(), 2), '.', '')
		)
	,@PPA_ACTUAL_TABLE VARCHAR(200) = CONCAT (
		'ST_NM_ACTUAL_PPA_'
		,@USER_ID
		,'_'
		,@SESSION_ID
		,'_'
		,REPLACE(CONVERT(VARCHAR(50), GETDATE(), 2), '.', '')
		)
	,@PPA_MASTER_TABLE VARCHAR(200) = CONCAT (
		'ST_NM_PPA_PROJECTION_MASTER_'
		,@USER_ID
		,'_'
		,@SESSION_ID
		,'_'
		,REPLACE(CONVERT(VARCHAR(50), GETDATE(), 2), '.', '')
		)
	,@CCP_HIERARCHY VARCHAR(200) = CONCAT (
		'ST_CCP_HIERARCHY_'
		,@USER_ID
		,'_'
		,@SESSION_ID
		,'_'
		,REPLACE(CONVERT(VARCHAR(50), GETDATE(), 2), '.', '')
		)
	,---- ccp deatils information
	@PRODUCT_FILE VARCHAR(100) = CONCAT (
		'ST_PRODUCT_FILE_'
		,@USER_ID
		,'_'
		,@SESSION_ID
		,'_'
		,REPLACE(CONVERT(VARCHAR(50), GETDATE(), 2), '.', '')
		)
	,-----lastest file of that product based on projection
	@ITEM_UOM_TABLE VARCHAR(100) = CONCAT (
		'ST_ITEM_UOM_DETAILS_'
		,@USER_ID
		,'_'
		,@SESSION_ID
		,'_'
		,Replace(CONVERT(VARCHAR(50), Getdate(), 2), '.', '')
		)

IF Object_id('TEMPDB..#PROJECTION_MASTER') IS NOT NULL
	TRUNCATE TABLE #PROJECTION_MASTER
ELSE
	CREATE TABLE #PROJECTION_MASTER (
		ID INT IDENTITY(1, 1)
		,PROJECTION_MASTER_SID INT
		)
SET @TEMP_PROJ_SID = Replace(@PROJECTION_SID + ',', ',,', ',')

WHILE Patindex('%,%', @TEMP_PROJ_SID) <> 0
BEGIN
	SELECT @SP = Patindex('%,%', @TEMP_PROJ_SID)

	SELECT @SP_PROJ_SID = LEFT(@TEMP_PROJ_SID, @SP - 1)

	SELECT @TEMP_PROJ_SID = Stuff(@TEMP_PROJ_SID, 1, @SP, '')

	INSERT INTO #PROJECTION_MASTER (PROJECTION_MASTER_SID)
	SELECT @SP_PROJ_SID
END

DECLARE @FIRST_PROJ_SID INT

SELECT @FIRST_PROJ_SID = PM.PROJECTION_MASTER_SID
FROM #PROJECTION_MASTER PM
WHERE ID = 1

DECLARE @SQL NVARCHAR(MAX)

SET @SQL = CONCAT (
		'SELECT @START_PERIOD_SID = Min(ST.PERIOD_SID)
	,@END_PERIOD_SID = Max(ST.PERIOD_SID)
FROM ' ,@SALES_PROJECTION_TABLE, ' ST
')

EXEC Sp_executesql @sql
	,N'@START_PERIOD_SID int OUTPUT,  @END_PERIOD_SID int OUTPUT'
	,@START_PERIOD_SID = @START_PERIOD_SID OUTPUT
	,@END_PERIOD_SID = @END_PERIOD_SID OUTPUT

SELECT TOP 1 @STARTFROM = Dateadd(YY, Datediff(YY, 0, Dateadd(YY, - 3, Getdate())), 0)
	,@START_DATE = Dateadd(dd, 1, Eomonth(FROM_DATE, - 1))
	,@PROJECTION_DATE = Dateadd(dd, 1, Eomonth(TO_DATE, - 1))
FROM PROJECTION_MASTER
WHERE PROJECTION_MASTER_SID = @FIRST_PROJ_SID
ORDER BY PROJECTION_MASTER_SID

SELECT @START_PERIOD_SID = Max(CASE 
			WHEN PERIOD_DATE = @STARTFROM
				THEN PERIOD_SID
			END)
	,@END_PERIOD_SID = Max(CASE 
			WHEN PERIOD_DATE = Dateadd(MM, Datediff(MM, 0, @PROJECTION_DATE), 0)
				THEN PERIOD_SID
			END)
	,@PROJ_START_PERIOD_SID = Max(CASE 
			WHEN PERIOD_DATE = @START_DATE
				THEN PERIOD_SID
			END)
FROM PERIOD
WHERE PERIOD_DATE IN (
		@STARTFROM
		,@PROJECTION_DATE
		,@START_DATE
		)

SET @CURRENT_DATE = CASE 
		WHEN LEFT(@PROJ_FREQUENCY, 1) = 'M'
			THEN Dateadd(DD, 1, Eomonth(Getdate(), - 1))
		WHEN LEFT(@PROJ_FREQUENCY, 1) = 'Q'
			THEN Datefromparts(Year(Getdate()), Datepart(QUARTER, Getdate()), 01)
		WHEN LEFT(@PROJ_FREQUENCY, 1) = 'S'
			THEN Datefromparts(Year(Getdate()), (((((Month(Getdate())) - 1) / 6) * 6) + 1), 01)
		ELSE Datefromparts(Year(Getdate()), 01, 01)
		END

IF Object_id('TEMPDB.DBO.#PERIOD', 'U') IS NOT NULL
	DROP TABLE #PERIOD;

SELECT PERIOD_SID
	,PERIOD_DATE
	,MONTH
	,QUARTER
	,SEMI_ANNUAL
	,YEAR
	,CASE 
		WHEN LEFT(@PROJ_FREQUENCY, 1) = 'M'
			THEN MONTH
		WHEN LEFT(@PROJ_FREQUENCY, 1) = 'Q'
			THEN QUARTER
		WHEN LEFT(@PROJ_FREQUENCY, 1) = 'S'
			THEN SEMI_ANNUAL
		ELSE 01
		END AS PERIOD
INTO #PERIOD
FROM PERIOD


IF OBJECT_ID('TEMPDB..#TEMP_CCP') IS NOT NULL
	DROP TABLE #TEMP_CCP

CREATE TABLE #TEMP_CCP (
	COMPANY_MASTER_SID INT
	,CONTRACT_MASTER_SID INT
	,ITEM_MASTER_SID INT
	,PROJECTION_DETAILS_SID INT
	,PROJECTION_MASTER_SID INT
	,CCP_DETAILS_SID INT
	)

	SET @SQL = 'INSERT INTO #TEMP_CCP (
	COMPANY_MASTER_SID
	,CONTRACT_MASTER_SID
	,ITEM_MASTER_SID
	,PROJECTION_DETAILS_SID
	,PROJECTION_MASTER_SID
	,CCP_DETAILS_SID
	)
SELECT CCP.COMPANY_MASTER_SID
	,CCP.CONTRACT_MASTER_SID
	,CCP.ITEM_MASTER_SID
	,PD.PROJECTION_DETAILS_SID
	,PD.PROJECTION_MASTER_SID
	,CCP.CCP_DETAILS_SID
FROM CCP_DETAILS CCP
INNER JOIN PROJECTION_DETAILS PD ON CCP.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
	AND PD.PROJECTION_MASTER_SID = @FIRST_PROJ_SID
INNER JOIN ' + @CCP_HIERARCHY + ' CH ON CH.CCP_DETAILS_SID = CCP.CCP_DETAILS_SID
	AND (
		EXISTS (
			SELECT TOKEN
			FROM UDF_SPLITSTRING(@CCP, '','') U
			WHERE U.TOKEN = CONVERT(VARCHAR(50),PD.CCP_DETAILS_SID) 
			)
		OR @CCP IS NULL
		)  '

EXEC sp_executesql @SQL
	,N'@CCP VARCHAR(MAX),@FIRST_PROJ_SID INT'
	,@CCP = @CCP
	,@FIRST_PROJ_SID=@FIRST_PROJ_SID

IF Object_id('TEMPDB..#SPLIT_TABLE') IS NOT NULL
	DROP TABLE #SPLIT_TABLE

SELECT TOKEN
INTO #SPLIT_TABLE
FROM [DBO].[UDF_SPLITSTRING](@DISCOUNT_ID, ',')


IF OBJECT_ID('TEMPDB..#ITEM_UOM_DETAILS') IS NOT NULL
	DROP TABLE #ITEM_UOM_DETAILS

CREATE TABLE #ITEM_UOM_DETAILS (
	ITEM_MASTER_SID INT
	,UOM_VALUE NUMERIC(22, 6)
	,UOM_CODE VARCHAR(50)
	)

SET @SQL = 'INSERT INTO #ITEM_UOM_DETAILS (
	ITEM_MASTER_SID
	,UOM_VALUE
	,UOM_CODE
	)
SELECT UOM.ITEM_MASTER_SID
	,UOM_VALUE
	,UOM_CODE
FROM ' + @ITEM_UOM_TABLE + ' UOM
WHERE UOM.UOM_CODE = @UOM_CODE
AND EXISTS (SELECT 1 FROM #TEMP_CCP TC WHERE TC.ITEM_MASTER_SID=UOM.ITEM_MASTER_SID)
'

EXEC sp_executesql @SQL
	,N'@UOM_CODE VARCHAR(50)'
	,@UOM_CODE = @UOM_CODE

IF OBJECT_ID('TEMPDB..#MULTISELECT_DISCOUNTS') IS NOT NULL
	DROP TABLE #MULTISELECT_DISCOUNTS;

CREATE TABLE #MULTISELECT_DISCOUNTS (
	CCP_DETAILS_SID INT
	,RS_CONTRACT_SID INT
	,PRICE_GROUP_TYPE VARCHAR(50)
	,CHECK_RECORD BIT
	,PV_FILTERS BIT
	,SELECTED_LEVEL VARCHAR(50)
	,RS_MODEL_SID INT
	,DEDUCTION_INCLUSION BIT
	)

SET @SQL = CONCAT (
		'INSERT INTO #MULTISELECT_DISCOUNTS (
	CCP_DETAILS_SID
	,RS_CONTRACT_SID
	,PRICE_GROUP_TYPE
	,CHECK_RECORD
	,PV_FILTERS
	,RS_MODEL_SID
	,DEDUCTION_INCLUSION
	)
SELECT A.CCP_DETAILS_SID
	,RS_CONTRACT_SID
	,PRICE_GROUP_TYPE
	,CHECK_RECORD
	,PV_FILTERS
	,RS_MODEL_SID
	,DEDUCTION_INCLUSION
FROM '
		,@DISC_MASTER_TABLE
		,' A
WHERE PV_FILTERS = 1 
AND EXISTS (SELECT 1 FROM #TEMP_CCP B WHERE A.CCP_DETAILS_SID=B.CCP_DETAILS_SID) 
AND  (EXISTS ( SELECT 1 FROM #SPLIT_TABLE C WHERE C.TOKEN = A.RS_CONTRACT_SID )
OR @DISCOUNT_ID IS NULL)'
		)

EXEC SP_EXECUTESQL @SQL,
N'@DISCOUNT_ID NVARCHAR(MAX)',
@DISCOUNT_ID=@DISCOUNT_ID

IF OBJECT_ID('TEMPDB..#HELPER_TABLE') IS NOT NULL
	DROP TABLE #HELPER_TABLE;

CREATE TABLE #HELPER_TABLE (
	HELPER_TABLE_SID INT
	,DESCRIPTION VARCHAR(100)
	)

INSERT INTO #HELPER_TABLE (
	HELPER_TABLE_SID
	,DESCRIPTION
	)
SELECT HELPER_TABLE_SID
	,DESCRIPTION
FROM HELPER_TABLE HT
WHERE (
		EXISTS (
			SELECT 1
			FROM UDF_SPLITSTRING(@FILTER_UDCS, ',') A
			WHERE A.TOKEN = CONVERT(VARCHAR(100), HT.HELPER_TABLE_SID)
			)
		OR @FILTER_UDCS IS NULL
		)
	AND @PROGRAM_TYPE <> 'PROGRAM'
	AND @PROGRAM_TYPE <> 'SCHEDULE ID'



IF (@PROGRAM_TYPE LIKE '%UDC%')
BEGIN
	UPDATE A
	SET A.SELECTED_LEVEL = HT.DESCRIPTION
	FROM #MULTISELECT_DISCOUNTS A
	JOIN UDCS B ON B.MASTER_TYPE = 'RS_CONTRACT'
		AND A.RS_CONTRACT_SID = B.MASTER_SID
	JOIN #HELPER_TABLE HT ON HT.HELPER_TABLE_SID = CASE @PROGRAM_TYPE
			WHEN 'UDC 1'
				THEN UDC1
			WHEN 'UDC 2'
				THEN UDC2
			WHEN 'UDC 3'
				THEN UDC3
			WHEN 'UDC 4'
				THEN UDC4
			WHEN 'UDC 5'
				THEN UDC5
			WHEN 'UDC 6'
				THEN UDC6
			END
	
END
ELSE IF (@PROGRAM_TYPE = 'PROGRAM' OR @PROGRAM_TYPE = 'SCHEDULE ID')
BEGIN
	UPDATE A
	SET A.SELECTED_LEVEL = CONVERT(VARCHAR(100),B.RS_CONTRACT_SID)
	FROM #MULTISELECT_DISCOUNTS A
	JOIN RS_CONTRACT B ON A.RS_CONTRACT_SID = B.RS_CONTRACT_SID
	WHERE (
		EXISTS (
			SELECT 1
			FROM UDF_SPLITSTRING(@FILTER_UDCS, ',') A
			WHERE A.TOKEN = CONVERT(VARCHAR(100), B.RS_CONTRACT_SID)
			)
		OR @FILTER_UDCS IS NULL
		)
END
ELSE
BEGIN
	UPDATE A
	SET A.SELECTED_LEVEL = HT.DESCRIPTION
	FROM #MULTISELECT_DISCOUNTS A
	JOIN RS_CONTRACT B ON A.RS_CONTRACT_SID = B.RS_CONTRACT_SID
	JOIN #HELPER_TABLE HT ON HT.HELPER_TABLE_SID = CASE @PROGRAM_TYPE
			WHEN 'SCHEDULE CATEGORY'
				THEN RS_CATEGORY
			WHEN 'SCHEDULE TYPE'
				THEN RS_TYPE
			WHEN 'PROGRAM CATEGORY'
				THEN REBATE_PROGRAM_TYPE
			WHEN 'PROGRAM TYPE'
				THEN REBATE_PROGRAM_TYPE
			END
END

DELETE FROM #MULTISELECT_DISCOUNTS WHERE  SELECTED_LEVEL IS NULL

IF Object_id('TEMPDB..#PIVOT_RESULT') IS NOT NULL
	TRUNCATE TABLE #PIVOT_RESULT
ELSE
	CREATE TABLE #PIVOT_RESULT (
		PROJECTION_ID INT
		,[PERIOD] SMALLINT
		,[YEAR] INT
		,RS_NAME VARCHAR(100)
		,CONTRACT_DISCOUNT_ACTUAL NUMERIC(22, 6)
		,CONTRACT_DISCOUNT_PROJECTED NUMERIC(22, 6)
		,TOTAL_DISCOUNT_ACTUAL_PERCENTAGE NUMERIC(22, 6)
		,TOTAL_DISCOUNT_PROJECTED_PERCENTAGE NUMERIC(22, 6)
		,TOTAL_RPU_ACTUAL NUMERIC(22, 6)
		,TOTAL_RPU_PROJECTED NUMERIC(22, 6)
		,DISCOUNT_OF_EX_FACTORY_ACTUALS NUMERIC(22, 6)
		,DISCOUNT_OF_EX_FACTORY_PROJECTED NUMERIC(22, 6)
		,RS_CONTRACT_SID INT
		,CONTRACT_DISCOUNT_ACCRUAL NUMERIC(22, 6)
		,TOTAL_DISCOUNT_ACCRUAL_PERCENTAGE NUMERIC(22, 6)
		,TOTAL_RPU_ACCRUAL NUMERIC(22, 6)
		,DISCOUNT_OF_EX_FACTORY_ACCRUAL NUMERIC(22, 6)
		)

DECLARE @VAR INT

SET @VAR = CASE 
		WHEN @PROGRAM_TYPE = 'PROGRAM' 
			OR @PROGRAM_TYPE ='SCHEDULE ID' OR @PROGRAM_TYPE IS NULL
			THEN 1
		ELSE 0
		END

IF OBJECT_ID('TEMPDB.DBO.#PPA_RS_DATA', 'U') IS NOT NULL
	DROP TABLE #PPA_RS_DATA;

CREATE TABLE #PPA_RS_DATA (
	CCP_DETAILS_SID INT
	,PPA_DISCOUNT VARCHAR(100)
	)

SET @SQL = CONCAT (
		'
INSERT INTO #PPA_RS_DATA (
	CCP_DETAILS_SID
	,PPA_DISCOUNT
	)
SELECT DISTINCT PPA.CCP_DETAILS_SID AS CCP_DETAILS_SID
	,IIF(@VAR = 1,CONVERT(VARCHAR(100), RM.RS_CONTRACT_SID),''PRICE PROTECTION'') AS PPA_DISCOUNT
FROM ' ,@PPA_MASTER_TABLE ,' PPA
INNER JOIN RS_CONTRACT RM ON PPA.RS_CONTRACT_SID = RM.RS_CONTRACT_SID
	AND EXISTS ( SELECT 1 FROM #TEMP_CCP A WHERE A.CCP_DETAILS_SID = PPA.CCP_DETAILS_SID )' 
	) --GAL-1163

EXEC Sp_executesql @sql
	,N'@VAR INT'
	,@VAR = @VAR

IF Object_id('tempdb..#PRODUCT_FILE_TEMP') IS NOT NULL
	DROP TABLE #PRODUCT_FILE_TEMP

CREATE TABLE #PRODUCT_FILE_TEMP (
	PROJECTION_MASTER_SID INT
	,ITEM_MASTER_SID INT
	,PERIOD_SID INT
	,EXFACTORY_ACTUAL_SALES NUMERIC(22, 6)
	,EXFACTORY_ACTUAL_UNITS NUMERIC(22, 6)
	,EXFACTORY_FORECAST_SALES NUMERIC(22, 6)
	,EXFACTORY_FORECAST_UNITS NUMERIC(22, 6)
	,DEMAND_ACTUAL_SALES NUMERIC(22, 6)
	,DEMAND_ACTUAL_UNITS NUMERIC(22, 6)
	,DEMAND_FORECAST_SALES NUMERIC(22, 6)
	,DEMAND_FORECAST_UNITS NUMERIC(22, 6)
	,ADJUSTED_DEMAND_ACTUAL_SALES NUMERIC(22, 6)
	,ADJUSTED_DEMAND_ACTUAL_UNITS NUMERIC(22, 6)
	,ADJUSTED_DEMAND_FORECAST_SALES NUMERIC(22, 6)
	,ADJUSTED_DEMAND_FORECAST_UNITS NUMERIC(22, 6)
	,INVENTORY_ACTUAL_SALES NUMERIC(22, 6)
	,INVENTORY_ACTUAL_UNITS NUMERIC(22, 6)
	,INVENTORY_FORECAST_SALES NUMERIC(22, 6)
	,INVENTORY_FORECAST_UNITS NUMERIC(22, 6)
	,ITEM_PRICE NUMERIC(22, 6)
	,EXFACTORY_CUST_ACTUAL_SALES NUMERIC(22, 6)
	,EXFACTORY_CUST_ACTUAL_UNITS NUMERIC(22, 6)
	,EXFACTORY_CUST_FORECAST_SALES NUMERIC(22, 6)
	,EXFACTORY_CUST_FORECAST_UNITS NUMERIC(22, 6)
	,INVENTORY_CUST_ACTUAL_SALES NUMERIC(22, 6)
	,INVENTORY_CUST_ACTUAL_UNITS NUMERIC(22, 6)
	,INVENTORY_CUST_FORECAST_SALES NUMERIC(22, 6)
	,INVENTORY_CUST_FORECAST_UNITS NUMERIC(22, 6)
	)

IF (
		(
			SELECT Count(ID)
			FROM #PROJECTION_MASTER
			) > 1
		)
BEGIN
	INSERT INTO #PRODUCT_FILE_TEMP (
		PROJECTION_MASTER_SID
		,ITEM_MASTER_SID
		,PERIOD_SID
		,EXFACTORY_ACTUAL_SALES
		,EXFACTORY_ACTUAL_UNITS
		,EXFACTORY_FORECAST_SALES
		,EXFACTORY_FORECAST_UNITS
		,DEMAND_ACTUAL_SALES
		,DEMAND_ACTUAL_UNITS
		,DEMAND_FORECAST_SALES
		,DEMAND_FORECAST_UNITS
		,ADJUSTED_DEMAND_ACTUAL_SALES
		,ADJUSTED_DEMAND_ACTUAL_UNITS
		,ADJUSTED_DEMAND_FORECAST_SALES
		,ADJUSTED_DEMAND_FORECAST_UNITS
		,INVENTORY_ACTUAL_SALES
		,INVENTORY_ACTUAL_UNITS
		,INVENTORY_FORECAST_SALES
		,INVENTORY_FORECAST_UNITS
		,ITEM_PRICE
		,EXFACTORY_CUST_ACTUAL_SALES
		,EXFACTORY_CUST_ACTUAL_UNITS
		,EXFACTORY_CUST_FORECAST_SALES
		,EXFACTORY_CUST_FORECAST_UNITS
		,INVENTORY_CUST_ACTUAL_SALES
		,INVENTORY_CUST_ACTUAL_UNITS
		,INVENTORY_CUST_FORECAST_SALES
		,INVENTORY_CUST_FORECAST_UNITS
		)
	EXEC dbo.Prc_prior_proj_prod_file_data
END

IF OBJECT_ID('TEMPDB..#ACCRUAL_DISCOUNT') IS NOT NULL
	DROP TABLE #ACCRUAL_DISCOUNT;

CREATE TABLE #ACCRUAL_DISCOUNT (
	PROJECTION_MASTER_SID INT
	,CCP_DETAILS_SID INT
	,PERIOD_SID INT
	,RS_CONTRACT_SID INT
	,DISCOUNT_AMOUNT NUMERIC(22, 6)
	)

DECLARE @SQL_ACC NVARCHAR(max)

SET @SQL_ACC = 
	' ;

WITH CTE
AS (
	SELECT  COMPANY_MASTER_SID
		,CONTRACT_MASTER_SID
		,ITEM_MASTER_SID
		,a.PROJECTION_MASTER_SID
		,A.CCP_DETAILS_SID
		,PERIOD_SID
		,PERIOD_DATE
		,YEAR
		,RS.RS_CONTRACT_SID
		,RS.RS_MODEL_SID
	FROM #TEMP_CCP A
	JOIN #MULTISELECT_DISCOUNTS   RS ON RS.CCP_DETAILS_SID = A.CCP_DETAILS_SID
	JOIN #PERIOD P ON P.PERIOD_SID BETWEEN @START_PERIOD_SID
			AND @END_PERIOD_SID
	)
INSERT INTO #ACCRUAL_DISCOUNT (
	PROJECTION_MASTER_SID
	,CCP_DETAILS_SID
	,PERIOD_SID
	,RS_CONTRACT_SID
	,DISCOUNT_AMOUNT
	)
SELECT PROJECTION_MASTER_SID
	,A2.CCP_DETAILS_SID
	,PERIOD_SID
	,A2.RS_CONTRACT_SID
	,SUM(DEDUCTION_AMOUNT) / (DATEDIFF(MM, A1.ACCRUAL_PERIOD_START_DATE, A1.ACCRUAL_PERIOD_END_DATE) + 1) DISCOUNT_AMOUNT
FROM ACCRUAL_MASTER A1
JOIN CTE A2 ON A2.PERIOD_DATE BETWEEN CONVERT(DATETIME, DATEADD(MM, - 1, DATEADD(DD, 1, EOMONTH(A1.ACCRUAL_PERIOD_START_DATE, 0))))
		AND CONVERT(DATETIME, DATEADD(MM, - 1, DATEADD(DD, 1, EOMONTH(A1.ACCRUAL_PERIOD_END_DATE, 0))))
	AND A1.CONTRACT_MASTER_SID = A2.CONTRACT_MASTER_SID
	AND A1.COMPANY_MASTER_SID = A2.COMPANY_MASTER_SID
	AND A1.ITEM_MASTER_SID = A2.ITEM_MASTER_SID
	AND A2.RS_MODEL_SID = A1.RS_MODEL_SID
	AND DATEADD(DD, 1, EOMONTH(A1.ACCRUAL_PERIOD_START_DATE, - 1)) >= @STARTFROM
	AND A1.ACCRUAL_PERIOD_END_DATE <= @PROJECTION_DATE
GROUP BY PROJECTION_MASTER_SID
	,A2.CCP_DETAILS_SID
	,PERIOD_SID
	,A2.RS_CONTRACT_SID
	,ACCRUAL_PERIOD_START_DATE
	,ACCRUAL_PERIOD_END_DATE '

EXEC Sp_executesql @SQL_ACC
	,N'@START_PERIOD_SID INT,@END_PERIOD_SID INT,@STARTFROM DATETIME,@PROJECTION_DATE DATETIME, @DISCOUNT_ID NVARCHAR(MAX),@FIRST_PROJ_SID INT'
	,@START_PERIOD_SID = @START_PERIOD_SID
	,@END_PERIOD_SID = @END_PERIOD_SID
	,@STARTFROM = @STARTFROM
	,@PROJECTION_DATE = @PROJECTION_DATE
	,@DISCOUNT_ID = @DISCOUNT_ID
	,@FIRST_PROJ_SID=@FIRST_PROJ_SID


IF Object_id('TEMPDB.DBO.#CURRENT_ST_NM_ACTUAL_DISCOUNT', 'U') IS NOT NULL
	DROP TABLE #CURRENT_ST_NM_ACTUAL_DISCOUNT;

CREATE TABLE #CURRENT_ST_NM_ACTUAL_DISCOUNT (
	ACTUAL_SALES NUMERIC(22, 6)
	,ACCRUAL_DISCOUNT_ACTUAL NUMERIC(22, 6)
	,PERIOD INT
	,YEAR INT
	,DISCOUNT VARCHAR(100)
	)

DECLARE @DISC_Asql NVARCHAR(4000) = ''

SET @DISC_Asql = 'INSERT INTO #CURRENT_ST_NM_ACTUAL_DISCOUNT (
	ACTUAL_SALES
	,ACCRUAL_DISCOUNT_ACTUAL
	,PERIOD
	,YEAR
	,DISCOUNT
	)
SELECT SUM(IIF(( DEDUCTION_INCLUSION = CONVERT(CHAR(1), @DEDUCTION_INCLUSION) OR @DEDUCTION_INCLUSION IS NULL ), NSP.ACTUAL_SALES, NULL)) AS ACTUAL_SALES
	,sum(DISCOUNT_AMOUNT) ACCRUAL_DISCOUNT_ACTUAL
	,P.PERIOD
	,P.YEAR
	,IIF(@VAR=1,CONVERT(VARCHAR(100),DM.RS_CONTRACT_SID),SELECTED_LEVEL) DISCOUNT
FROM ' + @DISC_ACTUAL_TABLE + ' NSP
INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
INNER JOIN #MULTISELECT_DISCOUNTS DM ON DM.CCP_DETAILS_SID = NSP.CCP_DETAILS_SID
	AND DM.RS_CONTRACT_SID = NSP.RS_CONTRACT_SID
LEFT JOIN #ACCRUAL_DISCOUNT AD ON AD.CCP_DETAILS_SID = NSP.CCP_DETAILS_SID
	AND AD.RS_CONTRACT_SID = NSP.RS_CONTRACT_SID
	AND AD.PERIOD_SID = NSP.PERIOD_SID
GROUP BY P.PERIOD
	,P.YEAR
	,IIF(@VAR=1,CONVERT(VARCHAR(100),DM.RS_CONTRACT_SID),SELECTED_LEVEL)
	'
EXEC Sp_executesql @DISC_Asql
	,N'@DEDUCTION_INCLUSION BIT,@VAR INT'
	,@DEDUCTION_INCLUSION = @DEDUCTION_INCLUSION
	,@VAR = @VAR
	
	IF Object_id('TEMPDB.DBO.#CURRENT_ST_NM_DISCOUNT_PROJECTION', 'U') IS NOT NULL
	DROP TABLE #CURRENT_ST_NM_DISCOUNT_PROJECTION;

CREATE TABLE #CURRENT_ST_NM_DISCOUNT_PROJECTION (
	PROJECTION_SALES NUMERIC(22, 6)
	,ACCRUAL_DISCOUNT_PROJ NUMERIC(22, 6)
	,PERIOD INT
	,YEAR INT
	,DISCOUNT VARCHAR(100)
	)

DECLARE @psql NVARCHAR(4000) = ''

SET @psql = 'INSERT INTO #CURRENT_ST_NM_DISCOUNT_PROJECTION (
	PROJECTION_SALES,ACCRUAL_DISCOUNT_PROJ
	,PERIOD
	,YEAR
	,DISCOUNT
	)
SELECT Sum(IIF((DEDUCTION_INCLUSION= CONVERT (CHAR(1),@DEDUCTION_INCLUSION) OR @DEDUCTION_INCLUSION IS NULL),NSP.PROJECTION_SALES,NULL)) AS PROJECTION_SALES
	,sum(DISCOUNT_AMOUNT) ACCRUAL_DISCOUNT_PROJ
	,P.PERIOD
	,P.YEAR 
	,IIF(@VAR=1,CONVERT(VARCHAR(100),DM.RS_CONTRACT_SID),SELECTED_LEVEL)
FROM ' + @DISC_PROJECTION_TABLE + ' NSP
INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
INNER JOIN #MULTISELECT_DISCOUNTS DM ON DM.CCP_DETAILS_SID=NSP.CCP_DETAILS_SID
						AND DM.RS_CONTRACT_SID=NSP.RS_CONTRACT_SID
LEFT JOIN #ACCRUAL_DISCOUNT AD ON AD.CCP_DETAILS_SID = NSP.CCP_DETAILS_SID
	AND AD.RS_CONTRACT_SID = NSP.RS_CONTRACT_SID
	AND AD.PERIOD_SID = NSP.PERIOD_SID
WHERE  NSP.PERIOD_SID BETWEEN @PROJ_START_PERIOD_SID
		AND @END_PERIOD_SID
GROUP BY P.PERIOD
	,P.YEAR
	,IIF(@VAR=1,CONVERT(VARCHAR(100),DM.RS_CONTRACT_SID),SELECTED_LEVEL)
'

EXEC Sp_executesql @psql
	,N'@PROJ_START_PERIOD_SID INT,@END_PERIOD_SID INT,@DEDUCTION_INCLUSION BIT,@VAR INT'
	,@PROJ_START_PERIOD_SID = @PROJ_START_PERIOD_SID
	,@END_PERIOD_SID = @END_PERIOD_SID
	,@DEDUCTION_INCLUSION = @DEDUCTION_INCLUSION
	,@VAR = @VAR

IF Object_id('TEMPDB.DBO.#CURRENT_ST_NM_PPA_ACTUAL', 'U') IS NOT NULL
	DROP TABLE #CURRENT_ST_NM_PPA_ACTUAL;

CREATE TABLE #CURRENT_ST_NM_PPA_ACTUAL (
	ACTUAL_DISCOUNT_DOLLAR NUMERIC(22, 6)
	,PERIOD INT
	,YEAR INT
	,DISCOUNT VARCHAR(100)
	,RATE NUMERIC(22, 6)
	,RPU NUMERIC(22, 6)
	,UNIT NUMERIC(22, 6)
	)

DECLARE @PPA_ASQL NVARCHAR(MAX) = ''

SET @PPA_ASQL = '
;WITH PPA_SALES
AS (
	SELECT SUM(IIF(( SALES_INCLUSION = CONVERT(CHAR(1), @SALES_INCLUSION) OR @SALES_INCLUSION IS NULL ), ACTUAL_SALES, NULL)) PROJECTION_SALES
		,SUM(IIF(( SALES_INCLUSION = CONVERT(CHAR(1), @SALES_INCLUSION) OR @SALES_INCLUSION IS NULL ), ACTUAL_UNITS, NULL) * Isnull(UOM_VALUE, 0)) PROJECTION_UNITS
		,P.PERIOD
		,P.YEAR
		,CD.PPA_DISCOUNT
	FROM ' + @SALES_ACTUAL_TABLE + ' NSP
	INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
	INNER JOIN ' + @SALES_MASTER_TABLE +  ' SM ON SM.CCP_DETAILS_SID = nsp.CCP_DETAILS_SID
	INNER JOIN #PPA_RS_DATA CD ON CD.CCP_DETAILS_SID = SM.CCP_DETAILS_SID
	INNER JOIN CCP_DETAILS CD1 ON CD1.CCP_DETAILS_SID=SM.CCP_DETAILS_SID
	LEFT JOIN #ITEM_UOM_DETAILS UOM ON UOM.ITEM_MASTER_SID = CD1.ITEM_MASTER_SID
	GROUP BY PERIOD
		,YEAR
		,CD.PPA_DISCOUNT
	)
INSERT INTO #CURRENT_ST_NM_PPA_ACTUAL (
	ACTUAL_DISCOUNT_DOLLAR
	,RATE
	,RPU
	,PERIOD
	,YEAR
	,DISCOUNT
	)
SELECT PPA_PROJECTION_DISCOUNT
	,(PPA_PROJECTION_DISCOUNT / NULLIF(PROJECTION_SALES, 0)) * 100 AS PPA_PROJECTION_RATE
	,(PPA_PROJECTION_DISCOUNT / NULLIF(PROJECTION_UNITS, 0)) AS PPA_PROJECTION_RPU
	,A.PERIOD
	,A.YEAR
	,A.PPA_DISCOUNT
FROM (
	SELECT ISNULL(SUM(NSP.ACTUAL_DISCOUNT_DOLLAR), 0) AS PPA_PROJECTION_DISCOUNT
		,PERIOD
		,YEAR
		,RM.PPA_DISCOUNT
	FROM ' + @PPA_ACTUAL_TABLE + 
	' NSP
	INNER JOIN #PPA_RS_DATA RM ON RM.CCP_DETAILS_SID = NSP.CCP_DETAILS_SID --GAL-1163
	INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
	GROUP BY PERIOD
		,YEAR
		,PPA_DISCOUNT
	) A
JOIN PPA_SALES B ON A.YEAR = B.YEAR
	AND A.PERIOD = B.PERIOD
	AND A.PPA_DISCOUNT = B.PPA_DISCOUNT'
EXEC Sp_executesql @PPA_ASQL
	,N'@SALES_INCLUSION BIT'
	,@SALES_INCLUSION = @SALES_INCLUSION
	

IF Object_id('TEMPDB.DBO.#CURRENT_ST_NM_PPA_PROJECTION', 'U') IS NOT NULL
	DROP TABLE #CURRENT_ST_NM_PPA_PROJECTION;

CREATE TABLE #CURRENT_ST_NM_PPA_PROJECTION (
	PROJECTION_DISCOUNT_DOLLAR NUMERIC(22, 6)
	,PERIOD INT
	,YEAR INT
	,DISCOUNT VARCHAR(100)
	,RATE NUMERIC(22, 6)
	,RPU NUMERIC(22, 6)
	,UNIT NUMERIC(22, 6)
	)

DECLARE @PPA_pSQL NVARCHAR(MAX) = ''

SET @PPA_PSQL = '
;WITH PPA_SALES
AS (
	SELECT SUM(IIF(( SALES_INCLUSION = CONVERT(CHAR(1), @SALES_INCLUSION) OR @SALES_INCLUSION IS NULL ), PROJECTION_SALES, NULL)) PROJECTION_SALES
		,SUM(IIF(( SALES_INCLUSION = CONVERT(CHAR(1), @SALES_INCLUSION) OR @SALES_INCLUSION IS NULL ), PROJECTION_UNITS, NULL) * Isnull(UOM_VALUE, 0)) PROJECTION_UNITS
		,P.PERIOD
		,P.YEAR
		,CD.PPA_DISCOUNT
	FROM ' + @SALES_PROJECTION_TABLE + ' NSP
	INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
	INNER JOIN ' + @SALES_MASTER_TABLE +  ' SM ON SM.CCP_DETAILS_SID = nsp.CCP_DETAILS_SID
	INNER JOIN #PPA_RS_DATA CD ON CD.CCP_DETAILS_SID = SM.CCP_DETAILS_SID
	INNER JOIN CCP_DETAILS CD1 ON CD1.CCP_DETAILS_SID=SM.CCP_DETAILS_SID
	LEFT JOIN #ITEM_UOM_DETAILS UOM ON UOM.ITEM_MASTER_SID = CD1.ITEM_MASTER_SID
	GROUP BY PERIOD
		,YEAR
		,CD.PPA_DISCOUNT
	)
INSERT INTO #CURRENT_ST_NM_PPA_PROJECTION  (
	PROJECTION_DISCOUNT_DOLLAR
	,RATE
	,RPU
	,PERIOD
	,YEAR
	,DISCOUNT
	)
SELECT PPA_PROJECTION_DISCOUNT
	,(PPA_PROJECTION_DISCOUNT / NULLIF(PROJECTION_SALES, 0)) * 100 AS PPA_PROJECTION_RATE
	,(PPA_PROJECTION_DISCOUNT / NULLIF(PROJECTION_UNITS, 0)) AS PPA_PROJECTION_RPU
	,A.PERIOD
	,A.YEAR
	,A.PPA_DISCOUNT
FROM (
	SELECT ISNULL(SUM(NSP.PROJECTION_DISCOUNT_DOLLAR), 0) AS PPA_PROJECTION_DISCOUNT
		,PERIOD
		,YEAR
		,RM.PPA_DISCOUNT
	FROM ' + @PPA_PROJECTION_TABLE +  ' NSP
	INNER JOIN #PPA_RS_DATA RM ON RM.CCP_DETAILS_SID = NSP.CCP_DETAILS_SID --GAL-1163
	INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
	WHERE P.PERIOD_SID BETWEEN @PROJ_START_PERIOD_SID AND @END_PERIOD_SID
	GROUP BY PERIOD
		,YEAR
		,PPA_DISCOUNT
	) A
JOIN PPA_SALES B ON A.YEAR = B.YEAR
	AND A.PERIOD = B.PERIOD
	AND A.PPA_DISCOUNT = B.PPA_DISCOUNT'
EXEC Sp_executesql @PPA_PSQL
	,N'@SALES_INCLUSION BIT,@PROJ_START_PERIOD_SID INT,@END_PERIOD_SID INT'
	,@SALES_INCLUSION = @SALES_INCLUSION
	,@PROJ_START_PERIOD_SID = @PROJ_START_PERIOD_SID
	,@END_PERIOD_SID = @END_PERIOD_SID


IF Object_id('TEMPDB.DBO.#CURRENT_ST_NM_ACTUAL_SALES', 'U') IS NOT NULL
	DROP TABLE #CURRENT_ST_NM_ACTUAL_SALES;

CREATE TABLE #CURRENT_ST_NM_ACTUAL_SALES (
	ACTUAL_SALES NUMERIC(22, 6)
	,ACTUAL_UNITS NUMERIC(22, 6)
	,SELECTED_LEVEL VARCHAR(100)
	,PERIOD INT
	,YEAR INT
	)

DECLARE @ASQL NVARCHAR(MAX)

SET @ASQL = ''
SET @ASQL = 'INSERT INTO #CURRENT_ST_NM_ACTUAL_SALES (
	ACTUAL_SALES
	,ACTUAL_UNITS
	,PERIOD
	,YEAR
	,SELECTED_LEVEL
	)
SELECT SUM(IIF(( SALES_INCLUSION = CONVERT(CHAR(1), @SALES_INCLUSION) OR @SALES_INCLUSION IS NULL ), ACTUAL_SALES, NULL)) ACTUAL_SALES
	,SUM(IIF(( SALES_INCLUSION = CONVERT(CHAR(1), @SALES_INCLUSION) OR @SALES_INCLUSION IS NULL ), ACTUAL_UNITS, NULL) * Isnull(UOM_VALUE, 0)) ACTUAL_UNITS
	,P.PERIOD
	,P.YEAR
	,SELECTED_LEVEL
FROM ' + @SALES_ACTUAL_TABLE + ' NSP
JOIN (
	SELECT DISTINCT CCP_DETAILS_SID
		,SELECTED_LEVEL
	FROM #MULTISELECT_DISCOUNTS
	) B ON NSP.CCP_DETAILS_SID = B.CCP_DETAILS_SID
INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
INNER JOIN ' + @SALES_MASTER_TABLE + ' SM ON SM.CCP_DETAILS_SID = NSP.CCP_DETAILS_SID
INNER JOIN CCP_DETAILS CD ON CD.CCP_DETAILS_SID = SM.CCP_DETAILS_SID
LEFT JOIN #ITEM_UOM_DETAILS UOM ON UOM.ITEM_MASTER_SID = cd.ITEM_MASTER_SID
GROUP BY PERIOD
	,YEAR
	,SELECTED_LEVEL
'

EXEC Sp_executesql @ASQL
	,N'@SALES_INCLUSION BIT'
	,@SALES_INCLUSION = @SALES_INCLUSION
		
	IF Object_id('TEMPDB.DBO.#CURRENT_ST_NM_SALES_PROJECTION', 'U') IS NOT NULL
	DROP TABLE #CURRENT_ST_NM_SALES_PROJECTION;

CREATE TABLE #CURRENT_ST_NM_SALES_PROJECTION (
	PROJECTION_SALES NUMERIC(22, 6)
	,PROJECTION_UNITS NUMERIC(22, 6)
	,SELECTED_LEVEL VARCHAR(100)
	,PERIOD INT
	,YEAR INT
	)

SET @psql = 'INSERT INTO #CURRENT_ST_NM_SALES_PROJECTION (
	PROJECTION_SALES
	,PROJECTION_UNITS
	,PERIOD
	,YEAR
	,SELECTED_LEVEL
	)
SELECT SUM(IIF(( SALES_INCLUSION = CONVERT(CHAR(1), @SALES_INCLUSION) OR @SALES_INCLUSION IS NULL ), PROJECTION_SALES, NULL)) PROJECTION_SALES
	,SUM(IIF(( SALES_INCLUSION = CONVERT(CHAR(1), @SALES_INCLUSION) OR @SALES_INCLUSION IS NULL ), PROJECTION_UNITS, NULL) * ISNULL(UOM_VALUE, 0)) PROJECTION_UNITS
	,P.PERIOD
	,P.YEAR
	,SELECTED_LEVEL
FROM ' + @SALES_PROJECTION_TABLE + ' NSP
JOIN (
	SELECT DISTINCT CCP_DETAILS_SID
		,SELECTED_LEVEL
	FROM #MULTISELECT_DISCOUNTS
	) B ON NSP.CCP_DETAILS_SID = B.CCP_DETAILS_SID
INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
INNER JOIN ' + @SALES_MASTER_TABLE + 
	' SM ON SM.CCP_DETAILS_SID = NSP.CCP_DETAILS_SID
INNER JOIN CCP_DETAILS CD ON CD.CCP_DETAILS_SID = SM.CCP_DETAILS_SID
LEFT JOIN #ITEM_UOM_DETAILS UOM ON UOM.ITEM_MASTER_SID = CD.ITEM_MASTER_SID
WHERE P.PERIOD_SID BETWEEN @PROJ_START_PERIOD_SID
		AND @END_PERIOD_SID
GROUP BY PERIOD
	,YEAR
	,SELECTED_LEVEL
'

EXEC Sp_executesql @psql
	,N'@PROJ_START_PERIOD_SID INT,@END_PERIOD_SID INT,@SALES_INCLUSION BIT'
	,@PROJ_START_PERIOD_SID = @PROJ_START_PERIOD_SID
	,@END_PERIOD_SID = @END_PERIOD_SID
	,@SALES_INCLUSION = @SALES_INCLUSION

	IF Object_id('TEMPDB.DBO.#DATA_TABLE', 'U') IS NOT NULL
	DROP TABLE #DATA_TABLE;
WITH CTE
AS (
	SELECT DISTINCT SELECTED_LEVEL
	FROM #MULTISELECT_DISCOUNTS
	
	UNION ALL
	
	SELECT DISTINCT PPA_DISCOUNT
	FROM #PPA_RS_DATA
	)
SELECT DISTINCT SELECTED_LEVEL
	,PERIOD
	,YEAR
INTO #DATA_TABLE
FROM CTE A
JOIN #PERIOD P ON PERIOD_SID BETWEEN @START_PERIOD_SID
		AND @END_PERIOD_SID

	IF Object_id('TEMPDB.DBO.#CURRENT_SALES', 'U') IS NOT NULL
	DROP TABLE #CURRENT_SALES;

SELECT FD.YEAR
	,FD.PERIOD
	,FD.SELECTED_LEVEL
	,NAS.ACTUAL_SALES AS NM_ACTUAL_SALES
	,NSP.PROJECTION_SALES AS NM_PROJECTED_SALES
	,NAS.ACTUAL_UNITS AS NM_ACTUAL_UNITS
	,NSP.PROJECTION_UNITS AS NM_PROJECTED_UNITS
INTO #CURRENT_SALES
FROM #DATA_TABLE FD
LEFT JOIN #CURRENT_ST_NM_SALES_PROJECTION NSP ON NSP.YEAR = FD.YEAR
	AND NSP.PERIOD = FD.PERIOD
	AND NSP.SELECTED_LEVEL = FD.SELECTED_LEVEL
LEFT JOIN #CURRENT_ST_NM_ACTUAL_SALES NAS ON NAS.YEAR = FD.YEAR
	AND NAS.PERIOD = FD.PERIOD
	AND NAS.SELECTED_LEVEL = FD.SELECTED_LEVEL

IF OBJECT_ID('TEMPDB.DBO.#CURRENT_DISCOUNT', 'U') IS NOT NULL
	DROP TABLE #CURRENT_DISCOUNT;

SELECT FD.YEAR
	,FD.PERIOD
	,NSP.PROJECTION_SALES AS NM_PROJECTION_DISCOUNT
	,NAD.ACTUAL_SALES AS NM_ACTUAL_DISCOUNT
	,COALESCE(ACCRUAL_DISCOUNT_PROJ, ACCRUAL_DISCOUNT_ACTUAL) ACCRUAL_DISCOUNT
	,FD.SELECTED_LEVEL
INTO #CURRENT_DISCOUNT
FROM #DATA_TABLE FD
LEFT JOIN #CURRENT_ST_NM_DISCOUNT_PROJECTION NSP ON NSP.YEAR = FD.YEAR
	AND NSP.PERIOD = FD.PERIOD
	AND NSP.DISCOUNT = FD.SELECTED_LEVEL
LEFT JOIN #CURRENT_ST_NM_ACTUAL_DISCOUNT NAD ON NAD.YEAR = FD.YEAR
	AND NAD.PERIOD = FD.PERIOD
	AND NAD.DISCOUNT = FD.SELECTED_LEVEL
ORDER BY FD.PERIOD
	,FD.YEAR
	,FD.SELECTED_LEVEL

IF OBJECT_ID('TEMPDB.DBO.#CURRENT_PPA', 'U') IS NOT NULL
	DROP TABLE #CURRENT_PPA;

SELECT FD.YEAR
	,FD.PERIOD
	,COALESCE((NSP.projection_discount_dollar), 0) AS PPA_PROJECTION_DISCOUNT
	,COALESCE((NAS.actual_discount_dollar), 0) AS PPA_ACTUAL_DISCOUNT
	,COALESCE((NAS.RATE), 0) AS PPA_ACTUAL_RATE
	,COALESCE((NSP.RATE), 0) AS PPA_PROJECTION_RATE
	,COALESCE((NSP.RPU), 0) AS PPA_PROJECTION_RPU
	,COALESCE((NAS.RPU), 0) AS PPA_ACTUAL_RPU
	,FD.SELECTED_LEVEL
INTO #CURRENT_PPA
FROM #DATA_TABLE FD
LEFT JOIN #CURRENT_ST_NM_PPA_ACTUAL NAS ON NAS.YEAR = FD.YEAR
	AND NAS.PERIOD = FD.PERIOD
	AND NAS.DISCOUNT = FD.SELECTED_LEVEL
LEFT JOIN #CURRENT_ST_NM_PPA_PROJECTION NSP ON FD.YEAR = NSP.YEAR
	AND FD.PERIOD = NSP.PERIOD
	AND FD.SELECTED_LEVEL = NSP.DISCOUNT
ORDER BY FD.PERIOD
	,FD.YEAR
	,FD.SELECTED_LEVEL

	IF OBJECT_ID('TEMPDB..#FILE_DATA') IS NOT NULL
	DROP TABLE #FILE_DATA

CREATE TABLE #FILE_DATA (
	PERIOD INT
	,YEAR INT
	,SELECTED_LEVEL VARCHAR(100)
	,GTS_SALES_ACTUALS NUMERIC(22, 6)
	,GTS_SALES_PROJECTED NUMERIC(22, 6)
	)

SET @SQL = CONCAT (
		'
	INSERT INTO #FILE_DATA (
	PERIOD
	,YEAR
	,SELECTED_LEVEL
	,GTS_SALES_ACTUALS
	,GTS_SALES_PROJECTED
	) '
		,' (
	SELECT P.PERIOD
	,P.YEAR
	,FD.SELECTED_LEVEL
	,GTS_SALES_ACTUALS = SUM(EXFACTORY_ACTUAL_SALES)
	,GTS_SALES_PROJECTED = SUM(COALESCE(EXFACTORY_FORECAST_SALES, EXFACTORY_ACTUAL_SALES)) 
	FROM #DATA_TABLE FD JOIN 
	#PERIOD P ON P.PERIOD=FD.PERIOD
	AND P.YEAR=FD.YEAR
	JOIN (SELECT DISTINCT SELECTED_LEVEL ,ITEM_MASTER_SID FROM (SELECT DISTINCT CCP_DETAILS_SID,SELECTED_LEVEL
	FROM #MULTISELECT_DISCOUNTS
	UNION ALL
	SELECT DISTINCT CCP_DETAILS_SID,PPA_DISCOUNT
	FROM #PPA_RS_DATA) CD1 
	JOIN CCP_DETAILS CD ON CD1.CCP_DETAILS_SID=CD.CCP_DETAILS_SID) CD ON CD.SELECTED_LEVEL=FD.SELECTED_LEVEL
	JOIN  ' ,@PRODUCT_FILE ,' PF ON PF.ITEM_MASTER_SID = CD.ITEM_MASTER_SID 
	AND PF.PERIOD_SID=P.PERIOD_SID GROUP BY FD.SELECTED_LEVEL
	,P.PERIOD
	,P.YEAR
	)
'
		)

EXEC SP_EXECUTESQL @SQL

IF OBJECT_ID('TEMPDB.DBO.#RESULT_DETAILS_INFO', 'U') IS NOT NULL
	DROP TABLE #RESULT_DETAILS_INFO;

CREATE TABLE #RESULT_DETAILS_INFO (
	PROJECTION_MASTER_SID INT
	,YEAR INT
	,PERIOD INT
	,RS_NAME VARCHAR(100)
	,TOTAL_DISCOUNT_ACCRUAL NUMERIC(22, 6)
	,TOTAL_DISCOUNT NUMERIC(22, 6)
	,TOTAL_DISCOUNT_PROJECTED NUMERIC(22, 6)
	,TOTAL_DISCOUNT_ACCRUAL_PERCENTAGE NUMERIC(22, 6)
	,TOTAL_DISCOUNT_ACTUAL_PERCENTAGE NUMERIC(22, 6)
	,TOTAL_DISCOUNT_PROJECTED_PERCENTAGE NUMERIC(22, 6)
	,TOTAL_RPU_ACCRUAL NUMERIC(22, 6)
	,TOTAL_PROJECTED_RPU NUMERIC(22, 6)
	,TOTAL_ACTUAL_RPU NUMERIC(22, 6)
	,RS_CONTRACT_SID INT
	,DISCOUNT_OF_EX_FACTORY_ACCRUAL NUMERIC(22, 6)
	,DISCOUNT_OF_EX_FACTORY_ACTUALS NUMERIC(22, 6)
	,DISCOUNT_OF_EX_FACTORY_PROJECTED NUMERIC(22, 6)
	)

INSERT INTO #RESULT_DETAILS_INFO (
	PROJECTION_MASTER_SID
	,YEAR
	,PERIOD
	,RS_NAME
	,TOTAL_DISCOUNT
	,TOTAL_DISCOUNT_PROJECTED
	,TOTAL_DISCOUNT_ACTUAL_PERCENTAGE
	,TOTAL_DISCOUNT_PROJECTED_PERCENTAGE
	,TOTAL_ACTUAL_RPU
	,TOTAL_PROJECTED_RPU
	,RS_CONTRACT_SID
	,DISCOUNT_OF_EX_FACTORY_ACTUALS
	,DISCOUNT_OF_EX_FACTORY_PROJECTED
	,TOTAL_DISCOUNT_ACCRUAL
	)
SELECT @FIRST_PROJ_SID
	,ND.YEAR
	,ND.PERIOD
	,ND.SELECTED_LEVEL
	,ND.NM_ACTUAL_DISCOUNT
	,ND.NM_PROJECTION_DISCOUNT
	,isnull((ND.NM_ACTUAL_DISCOUNT / NULLIF(RD.NM_ACTUAL_SALES, 0)),0) * 100
	,isnull((ND.NM_PROJECTION_DISCOUNT / NULLIF(RD.NM_PROJECTED_SALES, 0)),0) * 100
	,isnull((ND.NM_ACTUAL_DISCOUNT / NULLIF(RD.NM_ACTUAL_UNITS, 0)),0)
	,isnull((ND.NM_PROJECTION_DISCOUNT / NULLIF(RD.NM_PROJECTED_UNITS, 0)),0)
	,CASE WHEN @VAR=1 THEN ND.SELECTED_LEVEL ELSE NULL END
	,isnull(CAST((ND.NM_ACTUAL_DISCOUNT / NULLIF(B.GTS_SALES_ACTUALS, 0)) * 100 AS NUMERIC(22, 6)),0) AS DISCOUNT_OF_EX_FACTORY_ACTUALS
	,isnull(CAST((ND.NM_PROJECTION_DISCOUNT / NULLIF(B.GTS_SALES_PROJECTED, 0)) * 100 AS NUMERIC(22, 6)),0) AS DISCOUNT_OF_EX_FACTORY_PROJECTED
	,ACCRUAL_DISCOUNT AS TOTAL_DISCOUNT_ACCRUAL
FROM #CURRENT_DISCOUNT ND
INNER JOIN #CURRENT_SALES RD ON RD.YEAR = ND.YEAR
	AND RD.PERIOD = ND.PERIOD
	AND ND.SELECTED_LEVEL = RD.SELECTED_LEVEL
LEFT JOIN #FILE_DATA B ON ND.SELECTED_LEVEL = B.SELECTED_LEVEL
	AND ND.YEAR = B.YEAR
	AND ND.PERIOD = B.PERIOD

UNION

SELECT @FIRST_PROJ_SID
	,PD.YEAR
	,PD.PERIOD
	,PD.SELECTED_LEVEL
	,PD.PPA_ACTUAL_DISCOUNT
	,PD.PPA_PROJECTION_DISCOUNT
	,PD.PPA_ACTUAL_RATE
	,PD.PPA_PROJECTION_RATE
	,PD.PPA_ACTUAL_RPU
	,PD.PPA_PROJECTION_RPU
	,CASE WHEN @VAR=1 THEN PD.SELECTED_LEVEL ELSE NULL END
	,isnull(CAST((PD.PPA_ACTUAL_DISCOUNT / NULLIF(B.GTS_SALES_ACTUALS, 0)) * 100 AS NUMERIC(22, 6)),0) AS DISCOUNT_OF_EX_FACTORY_ACTUALS
	,isnull(CAST((PD.PPA_PROJECTION_DISCOUNT / NULLIF(B.GTS_SALES_PROJECTED, 0)) * 100 AS NUMERIC(22, 6)),0) AS DISCOUNT_OF_EX_FACTORY_PROJECTED
	,NULL AS TOTAL_DISCOUNT_ACCRUAL
FROM #CURRENT_PPA PD
LEFT JOIN #FILE_DATA B ON PD.SELECTED_LEVEL = B.SELECTED_LEVEL
	AND PD.YEAR = B.YEAR
	AND PD.PERIOD = B.PERIOD

IF @VAR=1
BEGIN
INSERT INTO #PIVOT_RESULT (
	PROJECTION_ID
	,[PERIOD]
	,[YEAR]
	,RS_NAME
	,CONTRACT_DISCOUNT_ACTUAL
	,CONTRACT_DISCOUNT_PROJECTED
	,TOTAL_DISCOUNT_ACTUAL_PERCENTAGE
	,TOTAL_DISCOUNT_PROJECTED_PERCENTAGE
	,TOTAL_RPU_ACTUAL
	,TOTAL_RPU_PROJECTED
	,DISCOUNT_OF_EX_FACTORY_ACTUALS
	,DISCOUNT_OF_EX_FACTORY_PROJECTED
	,RS_CONTRACT_SID
	,CONTRACT_DISCOUNT_ACCRUAL
	)
SELECT DISTINCT PROJECTION_MASTER_SID
	,RD.PERIOD
	,RD.YEAR
	,IIF(@PROGRAM_TYPE='PROGRAM',RC.RS_NAME,RS_ID) RS_NAME
	,TOTAL_DISCOUNT
	,TOTAL_DISCOUNT_PROJECTED
	,TOTAL_DISCOUNT_ACTUAL_PERCENTAGE
	,TOTAL_DISCOUNT_PROJECTED_PERCENTAGE
	,TOTAL_ACTUAL_RPU
	,TOTAL_PROJECTED_RPU
	,DISCOUNT_OF_EX_FACTORY_ACTUALS
	,DISCOUNT_OF_EX_FACTORY_PROJECTED
	,RC.RS_CONTRACT_SID
	,TOTAL_DISCOUNT_ACCRUAL
FROM #RESULT_DETAILS_INFO RD
JOIN RS_CONTRACT RC ON  RC.RS_CONTRACT_SID=RD.RS_NAME
ORDER BY RS_NAME
	,RD.YEAR
	,RD.PERIOD
	,RS_CONTRACT_SID
END
ELSE
BEGIN 
INSERT INTO #PIVOT_RESULT (
	PROJECTION_ID
	,[PERIOD]
	,[YEAR]
	,RS_NAME
	,CONTRACT_DISCOUNT_ACTUAL
	,CONTRACT_DISCOUNT_PROJECTED
	,TOTAL_DISCOUNT_ACTUAL_PERCENTAGE
	,TOTAL_DISCOUNT_PROJECTED_PERCENTAGE
	,TOTAL_RPU_ACTUAL
	,TOTAL_RPU_PROJECTED
	,DISCOUNT_OF_EX_FACTORY_ACTUALS
	,DISCOUNT_OF_EX_FACTORY_PROJECTED
	,RS_CONTRACT_SID
	,CONTRACT_DISCOUNT_ACCRUAL
	)
SELECT DISTINCT PROJECTION_MASTER_SID
	,RD.PERIOD
	,RD.YEAR
	,RS_NAME
	,TOTAL_DISCOUNT
	,TOTAL_DISCOUNT_PROJECTED
	,TOTAL_DISCOUNT_ACTUAL_PERCENTAGE
	,TOTAL_DISCOUNT_PROJECTED_PERCENTAGE
	,TOTAL_ACTUAL_RPU
	,TOTAL_PROJECTED_RPU
	,DISCOUNT_OF_EX_FACTORY_ACTUALS
	,DISCOUNT_OF_EX_FACTORY_PROJECTED
	,RS_CONTRACT_SID
	,TOTAL_DISCOUNT_ACCRUAL
FROM #RESULT_DETAILS_INFO RD
ORDER BY RS_NAME
	,RD.YEAR
	,RD.PERIOD
	,RS_CONTRACT_SID
END

IF @SCREEN_NAME <> 'ASSUMPTIONS'
BEGIN
IF OBJECT_ID('TEMPDB..#PRIOR_TEMP_CCP') IS NOT NULL
	DROP TABLE #PRIOR_TEMP_CCP

CREATE TABLE #PRIOR_TEMP_CCP (
	COMPANY_MASTER_SID INT
	,CONTRACT_MASTER_SID INT
	,ITEM_MASTER_SID INT
	,PROJECTION_DETAILS_SID INT
	,PROJECTION_MASTER_SID INT
	,CCP_DETAILS_SID INT
	)

INSERT INTO #PRIOR_TEMP_CCP (
	COMPANY_MASTER_SID
	,CONTRACT_MASTER_SID
	,ITEM_MASTER_SID
	,PROJECTION_DETAILS_SID
	,PROJECTION_MASTER_SID
	,CCP_DETAILS_SID
	)
SELECT CCP.COMPANY_MASTER_SID
	,CCP.CONTRACT_MASTER_SID
	,CCP.ITEM_MASTER_SID
	,PD.PROJECTION_DETAILS_SID
	,PD.PROJECTION_MASTER_SID
	,CCP.CCP_DETAILS_SID
FROM CCP_DETAILS CCP
INNER JOIN PROJECTION_DETAILS PD ON CCP.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
	AND  EXISTS (SELECT 1 FROM #PROJECTION_MASTER PM WHERE PM.PROJECTION_MASTER_SID=PD.PROJECTION_MASTER_SID AND ID<>1) 
	AND EXISTS (SELECT 1 FROM #TEMP_CCP TC WHERE TC.CCP_DETAILS_SID=CCP.CCP_DETAILS_SID)

IF OBJECT_ID('TEMPDB..#SALES_INCLUSION') IS NOT NULL
	DROP TABLE #SALES_INCLUSION

SELECT A.PROJECTION_DETAILS_SID
	,B.CCP_DETAILS_SID
	,CASE 
		WHEN DESCRIPTION = 'YES'
			THEN 1
		ELSE 0
		END SALES_INCLUSION
INTO #SALES_INCLUSION
FROM NM_SALES_PROJECTION_MASTER A
JOIN PROJECTION_DETAILS B ON A.PROJECTION_DETAILS_SID = B.PROJECTION_DETAILS_SID
	AND EXISTS (
		SELECT 1
		FROM #PRIOR_TEMP_CCP A
		WHERE A.CCP_DETAILS_SID = B.CCP_DETAILS_SID
		)
JOIN CCP_DETAILS CD ON CD.CCP_DETAILS_SID = B.CCP_DETAILS_SID
JOIN CFP_CONTRACT_DETAILS CC ON CC.COMPANY_MASTER_SID = CD.COMPANY_MASTER_SID
JOIN CFP_CONTRACT CC1 ON CC1.CFP_CONTRACT_SID = CC.CFP_CONTRACT_SID
	AND CC1.CONTRACT_MASTER_SID = CD.CONTRACT_MASTER_SID
JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID = CC1.SALES_INCLUSION


IF OBJECT_ID('TEMPDB..#DEDUCTION_INCLUSION') IS NOT NULL
	DROP TABLE #DEDUCTION_INCLUSION

SELECT A.PROJECTION_DETAILS_SID
	,B.CCP_DETAILS_SID
	,RS.RS_CONTRACT_SID
	,CASE 
		WHEN DESCRIPTION = 'YES'
			THEN 1
		ELSE 0
		END DEDUCTION_INCLUSION
INTO #DEDUCTION_INCLUSION
FROM NM_DISCOUNT_PROJ_MASTER A
JOIN PROJECTION_DETAILS B ON A.PROJECTION_DETAILS_SID = B.PROJECTION_DETAILS_SID
	AND EXISTS (
		SELECT 1
		FROM #PRIOR_TEMP_CCP A
		WHERE A.CCP_DETAILS_SID = B.CCP_DETAILS_SID
		)
	AND EXISTS (
		SELECT 1
		FROM #MULTISELECT_DISCOUNTS MD
		WHERE MD.CCP_DETAILS_SID = B.CCP_DETAILS_SID
			AND MD.RS_CONTRACT_SID = A.RS_CONTRACT_SID
		)
JOIN RS_CONTRACT RS ON A.RS_CONTRACT_SID = RS.RS_CONTRACT_SID
JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID = RS.DEDUCTION_INCLUSION

IF Object_id('TEMPDB.DBO.#PRIOR_DATA_TABLE', 'U') IS NOT NULL
	DROP TABLE #PRIOR_DATA_TABLE;

WITH CTE
AS (
	SELECT DISTINCT SELECTED_LEVEL
		--,PTC.CCP_DETAILS_SID
		,PROJECTION_MASTER_SID
	FROM #MULTISELECT_DISCOUNTS MD
	JOIN #PRIOR_TEMP_CCP PTC ON MD.CCP_DETAILS_SID = PTC.CCP_DETAILS_SID
	
	UNION ALL
	
	SELECT DISTINCT PPA_DISCOUNT
		--,PTC.CCP_DETAILS_SID
		,PROJECTION_MASTER_SID
	FROM #PPA_RS_DATA PRD
	JOIN #PRIOR_TEMP_CCP PTC ON PRD.CCP_DETAILS_SID = PTC.CCP_DETAILS_SID
	)
SELECT DISTINCT PROJECTION_MASTER_SID,SELECTED_LEVEL
	,PERIOD
	,YEAR
INTO #PRIOR_DATA_TABLE
FROM CTE A
JOIN #PERIOD P ON PERIOD_SID BETWEEN @START_PERIOD_SID
		AND @END_PERIOD_SID

IF OBJECT_ID('TEMPDB..#PRIOR_DISCOUNT_FILE_DATA') IS NOT NULL
	DROP TABLE #PRIOR_DISCOUNT_FILE_DATA

CREATE TABLE #PRIOR_DISCOUNT_FILE_DATA (
	PERIOD INT
	,YEAR INT
	,SELECTED_LEVEL VARCHAR(100)
	,GTS_SALES_ACTUALS NUMERIC(22, 6)
	,GTS_SALES_PROJECTED NUMERIC(22, 6)
	,PROJECTION_MASTER_SID INT
	)

INSERT INTO #PRIOR_DISCOUNT_FILE_DATA (
	PERIOD
	,YEAR
	,SELECTED_LEVEL
	,GTS_SALES_ACTUALS
	,GTS_SALES_PROJECTED
	,PROJECTION_MASTER_SID
	)
SELECT P.PERIOD
	,P.YEAR
	,FD.SELECTED_LEVEL
	,GTS_SALES_ACTUALS = SUM(EXFACTORY_ACTUAL_SALES)
	,GTS_SALES_PROJECTED = SUM(COALESCE(EXFACTORY_FORECAST_SALES, EXFACTORY_ACTUAL_SALES))
	,FD.PROJECTION_MASTER_SID
FROM #PRIOR_DATA_TABLE FD
JOIN #PERIOD P ON P.PERIOD = FD.PERIOD
	AND P.YEAR = FD.YEAR
JOIN (SELECT DISTINCT  SELECTED_LEVEL,ITEM_MASTER_SID FROM(
	SELECT DISTINCT CCP_DETAILS_SID
		,SELECTED_LEVEL
	FROM #MULTISELECT_DISCOUNTS
	
	UNION ALL
	
	SELECT DISTINCT CCP_DETAILS_SID
		,PPA_DISCOUNT
	FROM #PPA_RS_DATA
	) MD 
JOIN CCP_DETAILS CD ON CD.CCP_DETAILS_SID = MD.CCP_DETAILS_SID) CD ON CD.SELECTED_LEVEL = FD.SELECTED_LEVEL
LEFT JOIN #PRODUCT_FILE_TEMP PF ON PF.ITEM_MASTER_SID = CD.ITEM_MASTER_SID
AND PF.PERIOD_SID=P.PERIOD_SID
	AND PF.PROJECTION_MASTER_SID = FD.PROJECTION_MASTER_SID
GROUP BY FD.SELECTED_LEVEL
	,P.PERIOD
	,P.YEAR
	,FD.PROJECTION_MASTER_SID

IF Object_id('TEMPDB.DBO.#NM_ACTUAL_DISCOUNT', 'U') IS NOT NULL
	DROP TABLE #NM_ACTUAL_DISCOUNT;

SELECT PD.PROJECTION_MASTER_SID
	,SUM(IIF(( DI.DEDUCTION_INCLUSION = @DEDUCTION_INCLUSION OR @DEDUCTION_INCLUSION IS NULL ), ACTUAL_SALES, NULL)) AS ACTUAL_SALES
	,SUM(DISCOUNT_AMOUNT) ACCRUAL_DISCOUNT_ACTUAL
	,P.PERIOD
	,P.YEAR
	,SELECTED_LEVEL
INTO #NM_ACTUAL_DISCOUNT
FROM NM_ACTUAL_DISCOUNT NAD
INNER JOIN #PERIOD P ON P.PERIOD_SID = NAD.PERIOD_SID
INNER JOIN PROJECTION_DETAILS PD ON PD.PROJECTION_DETAILS_SID = NAD.PROJECTION_DETAILS_SID
	AND EXISTS (
		SELECT 1
		FROM #PRIOR_TEMP_CCP A
		WHERE A.PROJECTION_DETAILS_SID=PD.PROJECTION_DETAILS_SID
		)
INNER JOIN #MULTISELECT_DISCOUNTS DM ON DM.CCP_DETAILS_SID = pd.CCP_DETAILS_SID
	AND DM.RS_CONTRACT_SID = NAD.RS_CONTRACT_SID
	LEFT  JOIN #DEDUCTION_INCLUSION DI ON DI.PROJECTION_DETAILS_SID = NAD.PROJECTION_DETAILS_SID
	AND DI.RS_CONTRACT_SID = NAD.RS_CONTRACT_SID
LEFT JOIN #ACCRUAL_DISCOUNT AD ON AD.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
	AND AD.RS_CONTRACT_SID = NAD.RS_CONTRACT_SID
	AND AD.PERIOD_SID = NAD.PERIOD_SID
GROUP BY PD.PROJECTION_MASTER_SID
	,P.PERIOD
	,P.YEAR
	,SELECTED_LEVEL

IF Object_id('TEMPDB.DBO.#NM_DISCOUNT_PROJECTION', 'U') IS NOT NULL
	DROP TABLE #NM_DISCOUNT_PROJECTION;

SELECT pd.PROJECTION_MASTER_SID
	,SUM(IIF(( DI.DEDUCTION_INCLUSION = @DEDUCTION_INCLUSION OR @DEDUCTION_INCLUSION IS NULL ), PROJECTION_SALES, NULL)) AS PROJECTION_SALES
	,P.PERIOD
	,P.YEAR
	,SELECTED_LEVEL
	,SUM(DISCOUNT_AMOUNT) ACCRUAL_DISCOUNT_PROJ
INTO #NM_DISCOUNT_PROJECTION
FROM NM_DISCOUNT_PROJECTION NSP
INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
INNER JOIN PROJECTION_DETAILS PD ON PD.PROJECTION_DETAILS_SID = NSP.PROJECTION_DETAILS_SID
	AND EXISTS (
		SELECT 1
		FROM #PRIOR_TEMP_CCP A
		WHERE A.PROJECTION_DETAILS_SID=PD.PROJECTION_DETAILS_SID
		)
INNER JOIN #DEDUCTION_INCLUSION DI ON DI.PROJECTION_DETAILS_SID = NSP.PROJECTION_DETAILS_SID
	AND DI.RS_CONTRACT_SID = NSP.RS_CONTRACT_SID
INNER JOIN #MULTISELECT_DISCOUNTS DM ON DM.CCP_DETAILS_SID = DI.CCP_DETAILS_SID
	AND DM.RS_CONTRACT_SID = NSP.RS_CONTRACT_SID
LEFT JOIN #ACCRUAL_DISCOUNT AD ON AD.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
	AND AD.RS_CONTRACT_SID = NSP.RS_CONTRACT_SID
	AND AD.PERIOD_SID = NSP.PERIOD_SID
GROUP BY PD.PROJECTION_MASTER_SID
	,P.PERIOD
	,P.YEAR
	,SELECTED_LEVEL


IF Object_id('TEMPDB.DBO.#NM_ACTUAL_PPA', 'U') IS NOT NULL
DROP TABLE #NM_ACTUAL_PPA;

WITH PPA_SALES
AS (
	SELECT SUM(IIF(( SALES_INCLUSION = @SALES_INCLUSION OR @SALES_INCLUSION IS NULL ), ACTUAL_SALES, NULL)) PROJECTION_SALES
		,SUM(IIF(( SALES_INCLUSION = @SALES_INCLUSION OR @SALES_INCLUSION IS NULL ), ACTUAL_UNITS, NULL) * ISNULL(UOM_VALUE, 0)) PROJECTION_UNITS
		,P.PERIOD
		,P.YEAR
		,PPA_DISCOUNT
		,PD.PROJECTION_MASTER_SID
	FROM NM_ACTUAL_SALES NSP
    INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
	INNER JOIN PROJECTION_DETAILS PD ON PD.PROJECTION_DETAILS_SID = NSP.PROJECTION_DETAILS_SID
	INNER JOIN #PPA_RS_DATA CD ON CD.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
	INNER JOIN #SALES_INCLUSION SI ON SI.PROJECTION_DETAILS_SID = PD.PROJECTION_DETAILS_SID
	INNER JOIN CCP_DETAILS CD1 ON CD1.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
	LEFT JOIN #ITEM_UOM_DETAILS UOM ON UOM.ITEM_MASTER_SID = CD1.ITEM_MASTER_SID
	WHERE EXISTS (
		SELECT 1
		FROM #PRIOR_TEMP_CCP A
		WHERE A.PROJECTION_DETAILS_SID=PD.PROJECTION_DETAILS_SID
		)
	GROUP BY PERIOD
		,YEAR
		,PPA_DISCOUNT
		,PD.PROJECTION_MASTER_SID
	)
SELECT PPA_PROJECTION_DISCOUNT AS ACTUAL_DISCOUNT_DOLLAR
	,(PPA_PROJECTION_DISCOUNT / NULLIF(PROJECTION_SALES, 0)) * 100 AS RATE
	,(PPA_PROJECTION_DISCOUNT / NULLIF(PROJECTION_UNITS, 0)) AS RPU
	,a.PERIOD
	,a.YEAR
	,a.PPA_DISCOUNT
	,a.PROJECTION_MASTER_SID
INTO #NM_ACTUAL_PPA
FROM (
	SELECT ISNULL(Sum(NSP.ACTUAL_DISCOUNT_DOLLAR), 0) AS PPA_PROJECTION_DISCOUNT
		,PERIOD
		,YEAR
		,PPA_DISCOUNT
		,pd.PROJECTION_MASTER_SID
	FROM NM_ACTUAL_PPA NSP
	INNER JOIN PROJECTION_DETAILS PD ON PD.PROJECTION_DETAILS_SID = NSP.PROJECTION_DETAILS_SID
	INNER JOIN #PPA_RS_DATA RM ON RM.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
	INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
	WHERE EXISTS (
		SELECT 1
		FROM #PRIOR_TEMP_CCP A
		WHERE A.PROJECTION_DETAILS_SID=PD.PROJECTION_DETAILS_SID
		)
	GROUP BY PD.PROJECTION_MASTER_SID
		,PERIOD
		,YEAR
		,PPA_DISCOUNT
	) A
JOIN PPA_SALES B ON A.YEAR = B.YEAR
	AND A.PERIOD = B.PERIOD
	AND A.PPA_DISCOUNT = B.PPA_DISCOUNT
	AND A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID

IF Object_id('TEMPDB.DBO.#NM_PPA_PROJECTION', 'U') IS NOT NULL
	DROP TABLE #NM_PPA_PROJECTION;;

WITH PPA_SALES
AS (
	SELECT pd.PROJECTION_MASTER_SID
		,SUM(IIF(( SALES_INCLUSION = @SALES_INCLUSION OR @SALES_INCLUSION IS NULL ), PROJECTION_SALES, NULL)) PROJECTION_SALES
		,SUM(IIF(( SALES_INCLUSION = @SALES_INCLUSION OR @SALES_INCLUSION IS NULL ), PROJECTION_UNITS, NULL) * ISNULL(UOM_VALUE, 0)) PROJECTION_UNITS
		,P.PERIOD
		,P.YEAR
		,PPA_DISCOUNT
	FROM NM_SALES_PROJECTION NSP
    INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
	INNER JOIN PROJECTION_DETAILS PD ON PD.PROJECTION_DETAILS_SID = NSP.PROJECTION_DETAILS_SID
	INNER JOIN #PPA_RS_DATA CD ON CD.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
	INNER JOIN #SALES_INCLUSION SI ON SI.PROJECTION_DETAILS_SID = PD.PROJECTION_DETAILS_SID
	INNER JOIN CCP_DETAILS CD1 ON CD1.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
	LEFT JOIN #ITEM_UOM_DETAILS UOM ON UOM.ITEM_MASTER_SID = CD1.ITEM_MASTER_SID
	WHERE EXISTS (
		SELECT 1
		FROM #PRIOR_TEMP_CCP A
		WHERE A.PROJECTION_DETAILS_SID=PD.PROJECTION_DETAILS_SID
		)
		
	GROUP BY pd.PROJECTION_MASTER_SID
		,PERIOD
		,YEAR
		,PPA_DISCOUNT
	)
SELECT PPA_PROJECTION_DISCOUNT AS PROJECTION_DISCOUNT_DOLLAR
	,(PPA_PROJECTION_DISCOUNT / NULLIF(PROJECTION_SALES, 0)) * 100 AS RATE
	,(PPA_PROJECTION_DISCOUNT / NULLIF(PROJECTION_UNITS, 0)) AS RPU
	,A.PERIOD
	,A.YEAR
	,A.PPA_DISCOUNT
	,A.PROJECTION_MASTER_SID
INTO #NM_PPA_PROJECTION
FROM (
	SELECT ISNULL(SUM(NSP.PROJECTION_DISCOUNT_DOLLAR), 0) AS PPA_PROJECTION_DISCOUNT
		,PERIOD
		,YEAR
		,PPA_DISCOUNT
		,PD.PROJECTION_MASTER_SID
	FROM NM_PPA_PROJECTION NSP
	INNER JOIN PROJECTION_DETAILS PD ON PD.PROJECTION_DETAILS_SID = NSP.PROJECTION_DETAILS_SID
	INNER JOIN #PPA_RS_DATA RM ON RM.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
	INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
	WHERE EXISTS (
		SELECT 1
		FROM #PRIOR_TEMP_CCP A
		WHERE A.PROJECTION_DETAILS_SID=PD.PROJECTION_DETAILS_SID
		)
	GROUP BY PD.PROJECTION_MASTER_SID
		,PERIOD
		,YEAR
		,PPA_DISCOUNT
	) A
JOIN PPA_SALES B ON A.YEAR = B.YEAR
	AND A.PERIOD = B.PERIOD
	AND A.PPA_DISCOUNT = B.PPA_DISCOUNT
	AND A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID


	IF Object_id('TEMPDB.DBO.#NM_ACTUAL_SALES', 'U') IS NOT NULL
	DROP TABLE #NM_ACTUAL_SALES;

SELECT SUM(IIF(( SALES_INCLUSION = @SALES_INCLUSION OR @SALES_INCLUSION IS NULL ), ACTUAL_SALES, NULL)) ACTUAL_SALES
	,SUM(IIF(( SALES_INCLUSION = @SALES_INCLUSION OR @SALES_INCLUSION IS NULL ), ACTUAL_UNITS, NULL) * ISNULL(UOM_VALUE, 0)) ACTUAL_UNITS
	,P.PERIOD
	,P.YEAR
	,b.SELECTED_LEVEL
	,pd.PROJECTION_MASTER_SID
INTO #NM_ACTUAL_SALES
FROM NM_ACTUAL_SALES NSP
INNER JOIN PROJECTION_DETAILS PD ON PD.PROJECTION_DETAILS_SID = NSP.PROJECTION_DETAILS_SID
 JOIN (
	SELECT DISTINCT CCP_DETAILS_SID
		,SELECTED_LEVEL
	FROM #MULTISELECT_DISCOUNTS
	) B ON pd.CCP_DETAILS_SID = B.CCP_DETAILS_SID
INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
INNER JOIN #SALES_INCLUSION SI ON SI.PROJECTION_DETAILS_SID = PD.PROJECTION_DETAILS_SID
INNER JOIN CCP_DETAILS CD ON CD.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
LEFT JOIN #ITEM_UOM_DETAILS UOM ON UOM.ITEM_MASTER_SID = CD.ITEM_MASTER_SID
WHERE EXISTS (
		SELECT 1
		FROM #PRIOR_TEMP_CCP A
		WHERE A.PROJECTION_DETAILS_SID=PD.PROJECTION_DETAILS_SID
		)
GROUP BY pd.PROJECTION_MASTER_SID
	,PERIOD
	,YEAR
	,b.SELECTED_LEVEL

IF Object_id('TEMPDB.DBO.#NM_SALES_PROJECTION', 'U') IS NOT NULL
	DROP TABLE #NM_SALES_PROJECTION;

SELECT SUM(IIF(( SALES_INCLUSION = @SALES_INCLUSION OR @SALES_INCLUSION IS NULL ), PROJECTION_SALES, NULL)) PROJECTION_SALES
	,SUM(IIF(( SALES_INCLUSION = @SALES_INCLUSION OR @SALES_INCLUSION IS NULL ), PROJECTION_UNITS, NULL) * ISNULL(UOM_VALUE, 0)) PROJECTION_UNITS
	,P.PERIOD
	,P.YEAR
	,b.SELECTED_LEVEL
	,pd.PROJECTION_MASTER_SID
INTO #NM_SALES_PROJECTION
FROM NM_SALES_PROJECTION NSP
INNER JOIN PROJECTION_DETAILS PD ON PD.PROJECTION_DETAILS_SID = NSP.PROJECTION_DETAILS_SID
 JOIN (
	SELECT DISTINCT CCP_DETAILS_SID
		,SELECTED_LEVEL
	FROM #MULTISELECT_DISCOUNTS
	) B ON pd.CCP_DETAILS_SID = B.CCP_DETAILS_SID
INNER JOIN #PERIOD P ON P.PERIOD_SID = NSP.PERIOD_SID
INNER JOIN #SALES_INCLUSION SI ON SI.PROJECTION_DETAILS_SID = PD.PROJECTION_DETAILS_SID
INNER JOIN CCP_DETAILS CD ON CD.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
LEFT JOIN #ITEM_UOM_DETAILS UOM ON UOM.ITEM_MASTER_SID = CD.ITEM_MASTER_SID
WHERE EXISTS (
		SELECT 1
		FROM #PRIOR_TEMP_CCP A
		WHERE A.PROJECTION_DETAILS_SID=PD.PROJECTION_DETAILS_SID
		)
GROUP BY pd.PROJECTION_MASTER_SID
	,PERIOD
	,YEAR
	,b.SELECTED_LEVEL
	
	
	IF Object_id('TEMPDB.DBO.#PRIOR_SALES', 'U') IS NOT NULL
	DROP TABLE #PRIOR_SALES;

SELECT FD.PROJECTION_MASTER_SID
	,FD.YEAR
	,FD.PERIOD
	,FD.SELECTED_LEVEL
	,(NAS.ACTUAL_SALES) AS NM_ACTUAL_SALES
	,(NAS.ACTUAL_UNITS) AS NM_ACTUAL_UNITS
	,(NSP.PROJECTION_SALES) AS NM_PROJECTED_SALES
	,(NSP.PROJECTION_UNITS) AS NM_PROJECTED_UNITS
INTO #PRIOR_SALES
FROM #PRIOR_DATA_TABLE FD
LEFT JOIN #NM_SALES_PROJECTION NSP ON FD.PROJECTION_MASTER_SID = NSP.PROJECTION_MASTER_SID
	AND NSP.YEAR = FD.YEAR
	AND NSP.PERIOD = FD.PERIOD
	AND NSP.SELECTED_LEVEL = FD.SELECTED_LEVEL
LEFT JOIN #NM_ACTUAL_SALES NAS ON FD.PROJECTION_MASTER_SID = NAS.PROJECTION_MASTER_SID
	AND NAS.YEAR = FD.YEAR
	AND NAS.PERIOD = FD.PERIOD
	AND NAS.SELECTED_LEVEL = FD.SELECTED_LEVEL


IF Object_id('TEMPDB.DBO.#PRIOR_DISCOUNT', 'U') IS NOT NULL
	DROP TABLE #PRIOR_DISCOUNT;

SELECT FD.PROJECTION_MASTER_SID
	,FD.YEAR
	,FD.PERIOD
	,(ACTUAL_SALES) AS ACTUAL_SALES
	,(PROJECTION_SALES) AS PROJECTION_SALES
	,COALESCE(ACCRUAL_DISCOUNT_PROJ,ACCRUAL_DISCOUNT_ACTUAL)ACCRUAL_DISCOUNT
	,FD.SELECTED_LEVEL
INTO #PRIOR_DISCOUNT
FROM #PRIOR_DATA_TABLE FD
LEFT JOIN  #NM_ACTUAL_DISCOUNT  NAD ON  NAD.PERIOD = FD.PERIOD
		AND NAD.YEAR = FD.YEAR
		AND NAD.SELECTED_LEVEL = FD.SELECTED_LEVEL
		AND NAD.PROJECTION_MASTER_SID = FD.PROJECTION_MASTER_SID
LEFT JOIN   #NM_DISCOUNT_PROJECTION  NSP ON FD.PERIOD = NSP.PERIOD
		AND FD.YEAR = NSP.YEAR
		AND FD.SELECTED_LEVEL = NSP.SELECTED_LEVEL
		AND FD.PROJECTION_MASTER_SID = NSP.PROJECTION_MASTER_SID
	
ORDER BY FD.PERIOD
	,FD.YEAR
	,FD.SELECTED_LEVEL

IF Object_id('TEMPDB.DBO.#PRIOR_PPA', 'U') IS NOT NULL
	DROP TABLE #PRIOR_PPA;

SELECT FD.PROJECTION_MASTER_SID
	,FD.YEAR
	,FD.PERIOD
	,COALESCE((NAD.ACTUAL_DISCOUNT_DOLLAR), 0) AS PPA_ACTUAL
	,COALESCE((NAD.RATE), 0) AS PPA_RATE
	,COALESCE((NAD.RPU), 0) AS PPA_RPU
	,COALESCE((NSP.PROJECTION_DISCOUNT_DOLLAR), 0) AS PPA_DISCOUNT_PROJECTED
	,COALESCE((NSP.RATE), 0) AS PPA_RATE_PROJECTION
	,COALESCE((NSP.RPU), 0) AS PPA_RPU_PROJECTION
	,FD.SELECTED_LEVEL
INTO #PRIOR_PPA
FROM #PRIOR_DATA_TABLE FD 
JOIN #NM_ACTUAL_PPA NAD ON  FD.PERIOD = NAD.PERIOD
	AND FD.YEAR = NAD.YEAR
	AND FD.SELECTED_LEVEL = NAD.PPA_DISCOUNT
	AND FD.PROJECTION_MASTER_SID = NAD.PROJECTION_MASTER_SID 
 JOIN  #NM_PPA_PROJECTION NSP ON FD.PERIOD = NSP.PERIOD
		AND FD.YEAR = NSP.YEAR
		AND FD.SELECTED_LEVEL = NSP.PPA_DISCOUNT
		AND FD.PROJECTION_MASTER_SID = NSP.PROJECTION_MASTER_SID
	
ORDER BY FD.PERIOD
	,FD.YEAR
	,FD.SELECTED_LEVEL

INSERT INTO #RESULT_DETAILS_INFO (
	PROJECTION_MASTER_SID
	,YEAR
	,PERIOD
	,RS_NAME
	,TOTAL_DISCOUNT
	,TOTAL_DISCOUNT_PROJECTED
	,TOTAL_DISCOUNT_ACTUAL_PERCENTAGE
	,TOTAL_DISCOUNT_PROJECTED_PERCENTAGE
	,TOTAL_ACTUAL_RPU
	,TOTAL_PROJECTED_RPU
	,RS_CONTRACT_SID
	,DISCOUNT_OF_EX_FACTORY_ACTUALS
	,DISCOUNT_OF_EX_FACTORY_PROJECTED
	,TOTAL_DISCOUNT_ACCRUAL
	)
SELECT RD.PROJECTION_MASTER_SID
	,ND.YEAR
	,ND.PERIOD
	,ND.SELECTED_LEVEL
	,ND.ACTUAL_SALES
	,ND.PROJECTION_SALES
	,COALESCE(ND.ACTUAL_SALES / NULLIF(RD.NM_ACTUAL_SALES, 0), 0) * 100
	,COALESCE(ND.PROJECTION_SALES / NULLIF(RD.NM_PROJECTED_SALES, 0), 0) * 100
	,COALESCE(ND.ACTUAL_SALES / NULLIF(RD.NM_ACTUAL_UNITS, 0), 0)
	,COALESCE(ND.PROJECTION_SALES / NULLIF(RD.NM_PROJECTED_UNITS, 0), 0)
	,CASE WHEN @VAR=1 THEN ND.SELECTED_LEVEL ELSE NULL END RS_CONTRACT_SID
	,isnull(CAST(COALESCE(ND.ACTUAL_SALES / NULLIF(B.GTS_SALES_ACTUALS, 0), 0) * 100 AS NUMERIC(22, 6)),0) AS DISCOUNT_OF_EX_FACTORY_ACTUALS
	,isnull(CAST(COALESCE(ND.PROJECTION_SALES / NULLIF(B.GTS_SALES_PROJECTED, 0), 0) * 100 AS NUMERIC(22, 6)),0) AS DISCOUNT_OF_EX_FACTORY_PROJECTED
	,ACCRUAL_DISCOUNT AS TOTAL_DISCOUNT_ACCRUAL
FROM #PRIOR_DISCOUNT ND
INNER JOIN #PRIOR_SALES RD ON ND.PROJECTION_MASTER_SID = RD.PROJECTION_MASTER_SID
	AND RD.YEAR = ND.YEAR
	AND RD.PERIOD = ND.PERIOD
	AND RD.SELECTED_LEVEL = ND.SELECTED_LEVEL
LEFT JOIN #PRIOR_DISCOUNT_FILE_DATA B ON ND.SELECTED_LEVEL = B.SELECTED_LEVEL
	AND ND.YEAR = B.YEAR
	AND ND.PERIOD = B.PERIOD
	AND B.PROJECTION_MASTER_SID = ND.PROJECTION_MASTER_SID

UNION

SELECT pd.PROJECTION_MASTER_SID
	,PD.YEAR
	,PD.PERIOD
	,PD.SELECTED_LEVEL
	,PD.PPA_ACTUAL
	,PD.PPA_DISCOUNT_PROJECTED
	,PPA_RATE
	,PPA_RATE_PROJECTION
	,PPA_RPU
	,PPA_RPU_PROJECTION
	,CASE WHEN @VAR=1 THEN PD.SELECTED_LEVEL ELSE NULL END RS_CONTRACT_SID
	,isnull(CAST(COALESCE(pd.PPA_ACTUAL / NULLIF(B.GTS_SALES_ACTUALS, 0), 0) * 100 AS NUMERIC(22, 6)),0) AS DISCOUNT_OF_EX_FACTORY_ACTUALS
	,isnull(CAST(COALESCE(pd.PPA_DISCOUNT_PROJECTED / NULLIF(B.GTS_SALES_PROJECTED, 0), 0) * 100 AS NUMERIC(22, 6)),0) AS DISCOUNT_OF_EX_FACTORY_PROJECTED
	,NULL AS TOTAL_DISCOUNT_ACCRUAL
FROM #PRIOR_PPA PD
LEFT JOIN #PRIOR_DISCOUNT_FILE_DATA B ON PD.SELECTED_LEVEL = B.SELECTED_LEVEL
	AND PD.YEAR = B.YEAR
	AND PD.PERIOD = B.PERIOD
	AND B.PROJECTION_MASTER_SID = PD.PROJECTION_MASTER_SID

IF  @VAR=1
BEGIN 
INSERT INTO #PIVOT_RESULT (
	PROJECTION_ID
	,[PERIOD]
	,[YEAR]
	,RS_NAME
	,CONTRACT_DISCOUNT_ACTUAL
	,CONTRACT_DISCOUNT_PROJECTED
	,TOTAL_DISCOUNT_ACTUAL_PERCENTAGE
	,TOTAL_DISCOUNT_PROJECTED_PERCENTAGE
	,TOTAL_RPU_ACTUAL
	,TOTAL_RPU_PROJECTED
	,RS_CONTRACT_SID
	,DISCOUNT_OF_EX_FACTORY_ACTUALS
	,DISCOUNT_OF_EX_FACTORY_PROJECTED
	,CONTRACT_DISCOUNT_ACCRUAL
	)
SELECT DISTINCT RD.PROJECTION_MASTER_SID
	,RD.PERIOD
	,RD.YEAR
	,IIF(@PROGRAM_TYPE='PROGRAM',RC.RS_NAME,RS_ID) RS_NAME
	,ISNULL(TOTAL_DISCOUNT, 0)
	,ISNULL(TOTAL_DISCOUNT_PROJECTED, 0)
	,ISNULL(TOTAL_DISCOUNT_ACTUAL_PERCENTAGE, 0)
	,ISNULL(TOTAL_DISCOUNT_PROJECTED_PERCENTAGE, 0)
	,ISNULL(TOTAL_ACTUAL_RPU, 0)
	,ISNULL(TOTAL_PROJECTED_RPU, 0)
	,RC.RS_CONTRACT_SID
	,DISCOUNT_OF_EX_FACTORY_ACTUALS
	,DISCOUNT_OF_EX_FACTORY_PROJECTED
	,TOTAL_DISCOUNT_ACCRUAL
FROM #RESULT_DETAILS_INFO RD
JOIN RS_CONTRACT RC ON  RC.RS_CONTRACT_SID=RD.RS_NAME
ORDER BY RS_NAME
	,RD.YEAR
	,RD.PERIOD
	,RS_CONTRACT_SID
	END			
	ELSE 
	BEGIN
	INSERT INTO #PIVOT_RESULT (
	PROJECTION_ID
	,[PERIOD]
	,[YEAR]
	,RS_NAME
	,CONTRACT_DISCOUNT_ACTUAL
	,CONTRACT_DISCOUNT_PROJECTED
	,TOTAL_DISCOUNT_ACTUAL_PERCENTAGE
	,TOTAL_DISCOUNT_PROJECTED_PERCENTAGE
	,TOTAL_RPU_ACTUAL
	,TOTAL_RPU_PROJECTED
	,RS_CONTRACT_SID
	,DISCOUNT_OF_EX_FACTORY_ACTUALS
	,DISCOUNT_OF_EX_FACTORY_PROJECTED
	,CONTRACT_DISCOUNT_ACCRUAL
	)
SELECT DISTINCT RD.PROJECTION_MASTER_SID
	,RD.PERIOD
	,RD.YEAR
	,RS_NAME
	,ISNULL(TOTAL_DISCOUNT, 0)
	,ISNULL(TOTAL_DISCOUNT_PROJECTED, 0)
	,ISNULL(TOTAL_DISCOUNT_ACTUAL_PERCENTAGE, 0)
	,ISNULL(TOTAL_DISCOUNT_PROJECTED_PERCENTAGE, 0)
	,ISNULL(TOTAL_ACTUAL_RPU, 0)
	,ISNULL(TOTAL_PROJECTED_RPU, 0)
	,RS_CONTRACT_SID
	,DISCOUNT_OF_EX_FACTORY_ACTUALS
	,DISCOUNT_OF_EX_FACTORY_PROJECTED
	,TOTAL_DISCOUNT_ACCRUAL
FROM #RESULT_DETAILS_INFO RD
ORDER BY RS_NAME
	,RD.YEAR
	,RD.PERIOD
	,RS_CONTRACT_SID
	END
	END
	DECLARE @SQL1 NVARCHAR(MAX)
			,@LOOP_CNTR INT
			,@MAX_CCP INT

		SET @SQL1 = 'SELECT YEAR,PERIOD,RS_NAME,'
		SET @LOOP_CNTR = 1
		SET @MAX_CCP = (
				SELECT Max(ID)
				FROM #PROJECTION_MASTER
				)

		WHILE @LOOP_CNTR <= @MAX_CCP
		BEGIN
		IF @LOOP_CNTR=1
		BEGIN
			SET @SQL1 += 'CONTRACT_DISCOUNT_ACCRUAL_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN IIF(CONTRACT_DISCOUNT_ACCRUAL=0,NULL,CONTRACT_DISCOUNT_ACCRUAL) END), 
						   CONTRACT_DISCOUNT_ACTUAL_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = CASE WHEN '''+CAST(@CURRENT_DATE AS VARCHAR(10))+''' > DATEFROMPARTS(YEAR,PERIOD,01) THEN MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN CONTRACT_DISCOUNT_ACTUAL END) ELSE NULL END, 
								  CONTRACT_DISCOUNT_PROJECTED_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = ISNULL(MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN CONTRACT_DISCOUNT_PROJECTED END),0), 
								  TOTAL_DISCOUNT_ACCRUAL_PERCENTAGE_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN TOTAL_DISCOUNT_ACCRUAL_PERCENTAGE END),
								  TOTAL_DISCOUNT_ACTUAL_PERCENTAGE_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' =CASE WHEN '''+CAST(@CURRENT_DATE AS VARCHAR(10))+''' > DATEFROMPARTS(YEAR,PERIOD,01) THEN MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN TOTAL_DISCOUNT_ACTUAL_PERCENTAGE END) ELSE NULL END,  
                                  TOTAL_DISCOUNT_PROJECTED_PERCENTAGE_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = ISNULL(MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN TOTAL_DISCOUNT_PROJECTED_PERCENTAGE END),0),
                                   TOTAL_RPU_ACCRUAL_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN TOTAL_RPU_ACCRUAL END),
                                   TOTAL_RPU_ACTUAL_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' =CASE WHEN '''+CAST(@CURRENT_DATE AS VARCHAR(10))+''' > DATEFROMPARTS(YEAR,PERIOD,01) THEN MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 
				'THEN TOTAL_RPU_ACTUAL END) ELSE NULL END,
                                   TOTAL_RPU_PROJECTED_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = ISNULL(MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN TOTAL_RPU_PROJECTED END),0),
                                   DISCOUNT_OF_EX_FACTORY_ACCRUAL_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN DISCOUNT_OF_EX_FACTORY_ACCRUAL END),
                                   DISCOUNT_OF_EX_FACTORY_ACTUALS_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' =CASE WHEN '''+CAST(@CURRENT_DATE AS VARCHAR(10))+''' > DATEFROMPARTS(YEAR,PERIOD,01) THEN MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN DISCOUNT_OF_EX_FACTORY_ACTUALS END) ELSE NULL END,
                                   DISCOUNT_OF_EX_FACTORY_PROJECTED_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = ISNULL(MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN DISCOUNT_OF_EX_FACTORY_PROJECTED END),0),'
			END 
			ELSE 
			BEGIN
			SET @SQL1 += 'CONTRACT_DISCOUNT_ACCRUAL_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN CONTRACT_DISCOUNT_ACCRUAL END), 
						   CONTRACT_DISCOUNT_ACTUAL_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = ISNULL(MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN CONTRACT_DISCOUNT_ACTUAL END),0), 
								  CONTRACT_DISCOUNT_PROJECTED_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = ISNULL(MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN CONTRACT_DISCOUNT_PROJECTED END),0), 
								  TOTAL_DISCOUNT_ACCRUAL_PERCENTAGE_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN TOTAL_DISCOUNT_ACCRUAL_PERCENTAGE END),
								  TOTAL_DISCOUNT_ACTUAL_PERCENTAGE_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = ISNULL(MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN TOTAL_DISCOUNT_ACTUAL_PERCENTAGE END),0),      
                                  TOTAL_DISCOUNT_PROJECTED_PERCENTAGE_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = ISNULL(MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN TOTAL_DISCOUNT_PROJECTED_PERCENTAGE END),0),
                                   TOTAL_RPU_ACCRUAL_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN TOTAL_RPU_ACCRUAL END),
                                   TOTAL_RPU_ACTUAL_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = ISNULL(MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 
					'THEN TOTAL_RPU_ACTUAL END),0),
                                   TOTAL_RPU_PROJECTED_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = ISNULL(MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN TOTAL_RPU_PROJECTED END),0),
								     DISCOUNT_OF_EX_FACTORY_ACCRUAL_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN DISCOUNT_OF_EX_FACTORY_ACCRUAL END),
                                   DISCOUNT_OF_EX_FACTORY_ACTUALS_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = ISNULL(MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN DISCOUNT_OF_EX_FACTORY_ACTUALS END),0) ,
                                   DISCOUNT_OF_EX_FACTORY_PROJECTED_' + Cast(@LOOP_CNTR AS VARCHAR(10)) + ' = ISNULL(MAX(CASE WHEN ID = ' + Cast(@LOOP_CNTR AS VARCHAR(10)) + 'THEN DISCOUNT_OF_EX_FACTORY_PROJECTED END),0),'
				END

			SET @LOOP_CNTR += 1
	
		END

		SET @SQL1 = LEFT(@SQL1, Len(@SQL1) - 1)
		SET @SQL1 += ',RS_CONTRACT_SID FROM   #PIVOT_RESULT PR
                                                     INNER JOIN #PROJECTION_MASTER PM
                                                             ON PR.PROJECTION_ID = PM.PROJECTION_MASTER_SID
                                                       GROUP  BY [YEAR],PERIOD,RS_NAME,RS_CONTRACT_SID
                                                       ORDER BY RS_NAME,RS_CONTRACT_SID,[YEAR],PERIOD'

		EXEC SP_EXECUTESQL @SQL1
	END
	