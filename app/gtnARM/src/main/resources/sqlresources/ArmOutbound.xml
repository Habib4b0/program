<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->

<sql>
    <entity id="Pipeline_Adjustment_details_Insert_GTN">        
        <query>
            <![CDATA[
     DECLARE @FROM_PERIOD DATE
 ,@TO_PERIOD DATE
      ,@GL_COMP INT
	,@PROJECTION_MASTER_SID INT = ?

 SELECT @FROM_PERIOD = FROM_DATE
 ,@TO_PERIOD =TO_DATE
      ,@GL_COMP = COMPANY_MASTER_SID
 FROM PROJECTION_MASTER
 WHERE PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID

 DECLARE @TEMP_PROJ_GTN AS TABLE (
      ARM_ADJUSTMENT_DETAILS_SID INT
      ,CCP_DETAILS_SID INT
      ,RS_MODEL_SID INT
      ,PERIOD_DATE DATETIME
	   ,ACCOUNT VARCHAR(50)
       ,DEBIT NUMERIC(22,6)
       ,CREDIT NUMERIC(22,6)
      ,ACCRUAL_AMOUNT NUMERIC(22, 6)
      ,ACCRUAL_RATE NUMERIC(22, 6)
      )

 INSERT INTO @TEMP_PROJ_GTN (
      ARM_ADJUSTMENT_DETAILS_SID
      ,CCP_DETAILS_SID
      ,RS_MODEL_SID
      ,PERIOD_DATE
	  ,ACCOUNT
	  ,DEBIT
	  ,CREDIT
      ,ACCRUAL_AMOUNT
      ,ACCRUAL_RATE
      )
 SELECT A.ARM_ADJUSTMENT_DETAILS_SID
      ,A.CCP_DETAILS_SID
      ,A.RS_MODEL_SID
      ,P.PERIOD_DATE
	  ,AA.ACCOUNT,
      ISNULL(SUM(AA.DEBIT),0) AS DEBIT,
      ISNULL(SUM(AA.CREDIT),0) AS CREDIT,
      ISNULL(SUM(AA.CREDIT),0) - ISNULL(SUM(AA.DEBIT),0) AS ACCRUAL_AMOUNT
      ?
 FROM ARM_ADJUSTMENT_DETAILS A
 JOIN ? B ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
 JOIN ARM_ADJUSTMENTS AA ON AA.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
 JOIN PERIOD P ON P.PERIOD_SID=B.PERIOD_SID AND P.PERIOD_SID= AA.PERIOD_SID
 JOIN ARM_ADJ_RES_CCP ARC ON ARC.ARM_ADJUSTMENT_DETAILS_SID=AA.ARM_ADJUSTMENT_DETAILS_SID AND ARC.ADJUSTMENT_TYPE=AA.ADJUSTMENT_TYPE
 AND ARC.ACCOUNT=AA.ACCOUNT
JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=ARC.ADJUSTMENT_LEVEL AND HT.DESCRIPTION='ITEM'
WHERE A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
GROUP BY A.ARM_ADJUSTMENT_DETAILS_SID,
A.CCP_DETAILS_SID,
A.RS_MODEL_SID ,
P.PERIOD_DATE,
AA.ACCOUNT

 IF OBJECT_ID('TEMPDB..#TEMP_GTN') IS NOT NULL
      DROP TABLE #TEMP_GTN

 CREATE TABLE #TEMP_GTN (
      ARM_ADJUSTMENT_DETAILS INT
      ,CONTRACT_MASTER_SID INT
      ,CONTRACT_ID VARCHAR(50)
      ,CONTRACT_NO VARCHAR(50)
      ,[CONTRACT_NAME] VARCHAR(100)
      ,COMPANY_MASTER_SID INT
      ,COMPANY_ID VARCHAR(50)
      ,COMPANY_NO VARCHAR(50)
      ,COMPANY_NAME VARCHAR(100)
      ,ITEM_MASTER_SID INT
      ,ITEM_ID VARCHAR(50)
      ,ITEM_NO VARCHAR(50)
      ,ITEM_NAME VARCHAR(100)
      ,BRAND_MASTER_SID INT
      ,BRAND_ID VARCHAR(50)
      ,BRAND_NAME VARCHAR(100)
      ,RS_MODEL_SID INT
      ,RS_CATEGORY VARCHAR(50)
      ,RS_TYPE VARCHAR(50)
      ,REBATE_PROGRAM_TYPE VARCHAR(50)
      ,DEDUCTION_INCLUSION INT
      ,RS_ID VARCHAR(50)
      ,RS_NAME VARCHAR(100)
      ,RS_NO VARCHAR(50)
      ,RS_UDC_1 INT
      ,RS_UDC_2 INT
      ,RS_UDC_3 INT
      ,RS_UDC_4 INT
      ,RS_UDC_5 INT
      ,RS_UDC_6 INT
      ,PROJECTION_MASTER_SID INT
      ,WORKFLOW_MASTER_SID INT NULL
      ,CREATED_DATE DATETIME
      ,WORKFLOW_ID VARCHAR(50)
      ,WORKFLOW_NAME VARCHAR(500)
      ,WORKFLOW_STATUS INT
      )

 INSERT INTO #TEMP_GTN (
      ARM_ADJUSTMENT_DETAILS
      ,CONTRACT_MASTER_SID
      ,CONTRACT_ID
      ,CONTRACT_NO
      ,[CONTRACT_NAME]
      ,COMPANY_MASTER_SID
      ,COMPANY_ID
      ,COMPANY_NO
      ,COMPANY_NAME
      ,ITEM_MASTER_SID
      ,ITEM_ID
      ,ITEM_NO
      ,ITEM_NAME
      ,BRAND_MASTER_SID
      ,BRAND_ID
      ,BRAND_NAME
      ,RS_MODEL_SID
      ,RS_CATEGORY
      ,RS_TYPE
      ,REBATE_PROGRAM_TYPE
      ,DEDUCTION_INCLUSION
      ,RS_ID
      ,RS_NO
      ,RS_NAME
      ,RS_UDC_1
      ,RS_UDC_2
      ,RS_UDC_3
      ,RS_UDC_4
      ,RS_UDC_5
      ,RS_UDC_6
      ,PROJECTION_MASTER_SID
      ,WORKFLOW_MASTER_SID
      ,CREATED_DATE
      ,WORKFLOW_ID
      ,WORKFLOW_NAME
      ,WORKFLOW_STATUS
      )
 SELECT A.ARM_ADJUSTMENT_DETAILS_SID
      ,C.CONTRACT_MASTER_SID
      ,CON.CONTRACT_ID
      ,CON.CONTRACT_NO
      ,CON.[CONTRACT_NAME]
      ,C.COMPANY_MASTER_SID
      ,CM.COMPANY_ID
      ,CM.COMPANY_NO
      ,CM.COMPANY_NAME
      ,C.ITEM_MASTER_SID
      ,IM.ITEM_ID
      ,IM.ITEM_NO
      ,IM.ITEM_NAME
      ,BM.BRAND_MASTER_SID
      ,BM.BRAND_ID
      ,BM.BRAND_NAME
      ,A.RS_MODEL_SID
      ,RS_CATEGORY
      ,RS_TYPE
      ,R.REBATE_PROGRAM_TYPE
      ,R.DEDUCTION_INCLUSION
      ,R.RS_ID
      ,R.RS_NO
      ,R.RS_NAME
      ,U.UDC1 AS RS_UDC_1
      ,U.UDC2 AS RS_UDC_2
      ,U.UDC3 AS RS_UDC_3
      ,U.UDC4 AS RS_UDC_4
      ,U.UDC5 AS RS_UDC_5
      ,U.UDC6 AS RS_UDC_6
      ,A.PROJECTION_MASTER_SID
      ,WM.WORKFLOW_MASTER_SID
      ,WM.CREATED_DATE
      ,WM.WORKFLOW_ID
      ,WM.WORKFLOW_DESCRPTION
      ,WM.WORKFLOW_STATUS_ID
 FROM ARM_ADJUSTMENT_DETAILS A
 JOIN CCP_DETAILS C ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID
 JOIN ITEM_MASTER IM ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
 JOIN COMPANY_MASTER CM ON CM.COMPANY_MASTER_SID = C.COMPANY_MASTER_SID
 JOIN CONTRACT_MASTER CON ON CON.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID
 JOIN BRAND_MASTER BM ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
 JOIN RS_CONTRACT R ON R.RS_MODEL_SID = A.RS_MODEL_SID
      AND R.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID
 JOIN ARM_DEDUCTION_SELECTION ADS ON ADS.RS_CONTRACT_SID = R.RS_CONTRACT_SID
      AND ADS.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
 LEFT JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID
 JOIN UDCS U ON U.MASTER_SID = R.RS_CONTRACT_SID
      AND U.MASTER_TYPE = 'RS_CONTRACT'
 WHERE A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID

 INSERT INTO ADJUSTMENT_GTN_DETAIL (
      WORKFLOW_ID
      ,WORKFLOW_NAME
      ,ADJUSTMENT_TYPE
      ,GL_YEAR
      ,GL_MONTH
      ,GL_DATE
      ,REDEMPTION_PERIOD
   ,CALCULATION_PERIOD
      ,GL_COMPANY_ID
      ,GL_COMPANY_NO
      ,GL_COMPANY_NAME
      ,BUSINESS_UNIT_ID
      ,BUSINESS_UNIT_NO
      ,BUSINESS_UNIT_NAME
      ,COST_CENTER
      ,PROJECT
      ,FUTURE_1
      ,FUTURE_2
      ,GL_STRING
      ,ACCOUNT_CATEGORY
      ,ACCOUNT_TYPE
      ,ACCOUNT
      ,CONTRACT_ID
      ,CONTRACT_NO
      ,CONTRACT_NAME
      ,COMPANY_ID
      ,COMPANY_NO
      ,COMPANY_NAME
      ,ITEM_ID
      ,ITEM_NO
      ,ITEM_NAME
      ,BRAND_ID
      ,BRAND_NAME
      ,DEDUCTION_ID
      ,DEDUCTION_NO
      ,DEDUCTION_NAME
      ,DEDUCTION_CATEGORY
      ,DEDUCTION_TYPE
      ,DEDUCTION_PROGRAM
      ,DEDUCTION_INCLUSION
      ,DEDUCTION_UDC_1
      ,DEDUCTION_UDC_2
      ,DEDUCTION_UDC_3
      ,DEDUCTION_UDC_4
      ,DEDUCTION_UDC_5
      ,DEDUCTION_UDC_6
      ,DEDUCTION_AMOUNT
      ,DEDUCTION_RATE
      ,UDC_1
      ,UDC_2
      ,UDC_3
      ,UDC_4
      ,UDC_5
      ,UDC_6
      ,WORKFLOW_CREATED_BY
      ,WORKFLOW_CREATED_DATE
      ,WORKFLOW_APPROVED_BY
      ,WORKFLOW_APPROVED_DATE
      ,ADJUSTMENT_LEVEL
      ,ACCOUNT_DESCRIPTION
      ,ACCOUNT_INDICATOR
      ,DIVISION
      )
 SELECT A.WORKFLOW_ID
      ,A.WORKFLOW_NAME
      ,ARC.ADJUSTMENT_TYPE  AS ADJUSTMENT_TYPE
      ,YEAR(GL_IMPACT_DATE) AS GL_YEAR
      ,MONTH(GL_IMPACT_DATE) AS GL_MONTH
      ,GL_IMPACT_DATE AS GLDATE
      ,CASE
              WHEN AC.REDEMPTION_PERIOD = 1
                      THEN @FROM_PERIOD
              ELSE NULL
              END AS REDEMPTION_PERIOD
   ,@FROM_PERIOD AS CALCULATION_PERIOD
      ,GL.COMPANY_ID AS GL_COMPANY_ID
      ,GL.COMPANY_NO AS GL_COMPANY_NO
      ,GL.COMPANY_NAME AS GL_COMPANY_NAME
      ,BU.COMPANY_ID AS BU_COMPANY_ID
      ,BU.COMPANY_NO AS BU_COMPANY_NO
      ,BU.COMPANY_NAME AS BU_COMPANY_NAME
      ,ARC.COST_CENTER AS COST_CENTER
      ,ARC.PROJECT AS PROJECT
      ,ARC.FUTURE_1 AS FUTURE_1
      ,ARC.FUTURE_2 AS FUTURE_2
      ,GL.COMPANY_ID + ' - ' + 
        CASE WHEN 
		 (AAD.DIVISION='' OR AAd.DIVISION IS NULL) AND (AAD.COST_CENTER='' OR AAd.COST_CENTER IS NULL)
		THEN AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		WHEN (AAD.DIVISION='' OR AAd.DIVISION IS NULL) AND (AAD.COST_CENTER IS NOT NULL) THEN +AAD.COST_CENTER+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		WHEN (AAD.DIVISION IS NOT NULL) AND (AAD.COST_CENTER='' OR AAd.COST_CENTER IS NULL) THEN AAD.DIVISION+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		ELSE AAD.DIVISION+' - '+AAD.COST_CENTER+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
         END AS GLSTRING
      ,ARC.ACCOUNT_CATEGORY AS ACCOUNT_CATEGORY
      ,ARC.ACCOUNT_TYPE AS ACCOUNT_TYPE
      ,ARC.ACCOUNT AS ACCOUNT
      ,A.CONTRACT_ID AS CONTRACT_ID
      ,A.CONTRACT_NO AS CONTRACT_NO
      ,A.CONTRACT_NAME AS CONTRACT_NAME
      ,A.COMPANY_ID AS COMPANY_ID
      ,A.COMPANY_NO AS COMPANY_NO
      ,A.COMPANY_NAME AS COMPANY_NAME
      ,A.ITEM_ID AS ITEM_ID
      ,A.ITEM_NO AS ITEM_NO
      ,A.ITEM_NAME AS ITEM_NAME
      ,A.BRAND_ID AS BRAND_ID
      ,A.BRAND_NAME AS BRAND_NAME
      ,A.RS_ID AS DEDUCTION_ID
      ,A.RS_NO AS DEDUCTION_NO
      ,A.RS_NAME AS DEDUCTION_NAME
      ,A.RS_CATEGORY AS DEDUCTION_CATEGORY
      ,A.RS_TYPE AS DEDUCTION_TYPE
      ,A.REBATE_PROGRAM_TYPE AS REBATE_PROGRAM_TYPE
      ,A.DEDUCTION_INCLUSION AS DEDUCTION_INCLUSION
      ,A.RS_UDC_1 AS DEDUCTION_UDC_1
      ,A.RS_UDC_2 AS DEDUCTION_UDC_2
      ,A.RS_UDC_3 AS DEDUCTION_UDC_3
      ,A.RS_UDC_4 AS DEDUCTION_UDC_4
      ,A.RS_UDC_5 AS DEDUCTION_UDC_5
      ,A.RS_UDC_6 AS DEDUCTION_UDC_6
      ,CASE WHEN ISNULL(TP.DEBIT,0)-ISNULL(TP.CREDIT,0) > 0 THEN TP.DEBIT
		 ELSE TP.CREDIT * -1 END  AS ACCRUAL_AMOUNT
      ,TP.ACCRUAL_RATE AS RATE
      ,ARC.UDC_1 AS UDC_1
      ,ARC.UDC_2 AS UDC_2
      ,ARC.UDC_3 AS UDC_3
      ,ARC.UDC_4 AS UDC_4
      ,ARC.UDC_5 AS UDC_5
      ,ARC.UDC_6 AS UDC_6
      ,WM.CREATED_BY AS WORKFLOW_CREATED_BY
      ,WM.CREATED_DATE AS WORKFLOW_CREATED_DATE
      ,WM.APPROVED_BY AS WORKFLOW_APPROVED_BY
      ,WM.APPROVED_DATE AS WORKFLOW_APPROVED_DATE
      ,ARC.ADJUSTMENT_LEVEL
      ,AAD.ACCOUNT_DESC
      ,AAD.ACCOUNT_INDICATOR
      ,ARC.DIVISION
 FROM #TEMP_GTN A
 JOIN ARM_ADJUSTMENT_MASTER AM ON A.PROJECTION_MASTER_SID = AM.PROJECTION_MASTER_SID
 JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID = AM.PROJECTION_MASTER_SID
 JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID
 LEFT JOIN @TEMP_PROJ_GTN TP ON TP.ARM_ADJUSTMENT_DETAILS_SID = A.ARM_ADJUSTMENT_DETAILS
 JOIN ARM_ADJ_RES_CONFIG_MASTER AAM ON AAM.RS_CATEGORY = A.RS_CATEGORY
      AND AAM.RS_TYPE = A.RS_TYPE
      AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE
      AND AAM.GL_COMPANY_MASTER_SID = @GL_COMP
      AND AM.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID
      AND AAM.CONFIGURATION_TYPE = 1
 JOIN ARM_ADJ_RES_CONFIG_DETAIL AAD ON AAD.ARM_ADJ_RES_CONFIG_MASTER_SID = AAM.ARM_ADJ_RES_CONFIG_MASTER_SID
     
 INNER JOIN ARM_ADJ_RES_CCP ARC ON ARC.ARM_ADJ_RES_CONFIG_MASTER_SID = AAM.ARM_ADJ_RES_CONFIG_MASTER_SID
      AND ARC.ADJUSTMENT_TYPE = AAD.ADJUSTMENT_TYPE
      AND ARC.ACCOUNT = AAD.ACCOUNT
      AND A.ARM_ADJUSTMENT_DETAILS = ARC.ARM_ADJUSTMENT_DETAILS_SID
      AND AC.ARM_ADJUSTMENT_CONFIG_SID = AAD.ADJUSTMENT_TYPE
	   AND ARC.ARM_ADJUSTMENT_DETAILS_SID = TP.ARM_ADJUSTMENT_DETAILS_SID
 AND ARC.ACCOUNT=TP.ACCOUNT
 JOIN COMPANY_MASTER GL ON GL.COMPANY_MASTER_SID = @GL_COMP
 JOIN COMPANY_MASTER BU ON BU.COMPANY_MASTER_SID = AM.BU_COMPANY_MASTER_SID
 WHERE AAD.ADJUSTMENT_TYPE = ?
         AND TP.ACCRUAL_AMOUNT <>0
            ]]>  
        </query>
             
    </entity>
    
    <entity id="Demand_Adjustment_details_Insert_GTN">      
        <query>  
       <![CDATA[  
 DECLARE @GL_COMP INT
	,@PROJECTION_MASTER_SID INT = ?
 ,@FROM_PERIOD DATE
 ,@TO_PERIOD DATE

 SELECT @FROM_PERIOD = FROM_DATE
 ,@TO_PERIOD =TO_DATE
      ,@GL_COMP = COMPANY_MASTER_SID
 FROM PROJECTION_MASTER
 WHERE PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID

 DECLARE @TEMP_PROJ_GTN AS TABLE (
    ARM_ADJUSTMENT_DETAILS_SID INT,
    CCP_DETAILS_SID INT,
    RS_MODEL_SID INT,
    PERIOD_DATE DATETIME,
    ACCOUNT VARCHAR(50),
    DEBIT NUMERIC(22, 6),
    CREDIT NUMERIC(22, 6),
    ACCRUAL_AMOUNT NUMERIC(22, 6),
    ACCRUAL_RATE NUMERIC(22, 6)
      )

 INSERT INTO @TEMP_PROJ_GTN (
   ARM_ADJUSTMENT_DETAILS_SID,
   CCP_DETAILS_SID,
   RS_MODEL_SID,
   PERIOD_DATE,
   ACCOUNT,
   DEBIT,
   CREDIT,
   ACCRUAL_AMOUNT,
   ACCRUAL_RATE
)
SELECT
    A.ARM_ADJUSTMENT_DETAILS_SID,
    A.CCP_DETAILS_SID,
    A.RS_MODEL_SID,
    P.PERIOD_DATE,
    AA.ACCOUNT,
    ISNULL(SUM(AA.DEBIT),0) AS DEBIT,
    ISNULL(SUM(AA.CREDIT),0) AS CREDIT,
    ISNULL(SUM(AA.CREDIT),0) - ISNULL(SUM(AA.DEBIT),0) AS ACCRUAL_AMOUNT,
    MAX(B.PROJECTED_RATE) AS RATE
    ?
FROM ARM_ADJUSTMENT_DETAILS A
JOIN ? B ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
JOIN ARM_ADJUSTMENTS AA ON AA.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
JOIN PERIOD P ON P.PERIOD_SID=B.PERIOD_SID AND P.PERIOD_SID= AA.PERIOD_SID
JOIN ARM_ADJ_RES_CCP ARC ON ARC.ARM_ADJUSTMENT_DETAILS_SID=AA.ARM_ADJUSTMENT_DETAILS_SID AND ARC.ADJUSTMENT_TYPE=AA.ADJUSTMENT_TYPE
AND ARC.ACCOUNT=AA.ACCOUNT
JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=ARC.ADJUSTMENT_LEVEL AND HT.DESCRIPTION='ITEM'
WHERE A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
GROUP BY A.ARM_ADJUSTMENT_DETAILS_SID,
A.CCP_DETAILS_SID,
A.RS_MODEL_SID ,
P.PERIOD_DATE,
AA.ACCOUNT

 IF OBJECT_ID('TEMPDB..#TEMP_GTN') IS NOT NULL
      DROP TABLE #TEMP_GTN

 CREATE TABLE #TEMP_GTN (
      ARM_ADJUSTMENT_DETAILS INT
      ,CONTRACT_MASTER_SID INT
      ,CONTRACT_ID VARCHAR(50)
      ,CONTRACT_NO VARCHAR(50)
      ,[CONTRACT_NAME] VARCHAR(100)
      ,COMPANY_MASTER_SID INT
      ,COMPANY_ID VARCHAR(50)
      ,COMPANY_NO VARCHAR(50)
      ,COMPANY_NAME VARCHAR(100)
      ,ITEM_MASTER_SID INT
      ,ITEM_ID VARCHAR(50)
      ,ITEM_NO VARCHAR(50)
      ,ITEM_NAME VARCHAR(100)
      ,BRAND_MASTER_SID INT
      ,BRAND_ID VARCHAR(50)
      ,BRAND_NAME VARCHAR(100)
      ,RS_MODEL_SID INT
      ,RS_CATEGORY VARCHAR(50)
      ,RS_TYPE VARCHAR(50)
      ,REBATE_PROGRAM_TYPE VARCHAR(50)
      ,DEDUCTION_INCLUSION INT
      ,RS_ID VARCHAR(50)
      ,RS_NAME VARCHAR(100)
      ,RS_NO VARCHAR(50)
      ,RS_UDC_1 INT
      ,RS_UDC_2 INT
      ,RS_UDC_3 INT
      ,RS_UDC_4 INT
      ,RS_UDC_5 INT
      ,RS_UDC_6 INT
      ,PROJECTION_MASTER_SID INT
      ,WORKFLOW_MASTER_SID INT NULL
      ,CREATED_DATE DATETIME
      ,WORKFLOW_ID VARCHAR(50)
      ,WORKFLOW_NAME VARCHAR(500)
      ,WORKFLOW_STATUS INT
      )

 INSERT INTO #TEMP_GTN (
      ARM_ADJUSTMENT_DETAILS
      ,CONTRACT_MASTER_SID
      ,CONTRACT_ID
      ,CONTRACT_NO
      ,[CONTRACT_NAME]
      ,COMPANY_MASTER_SID
      ,COMPANY_ID
      ,COMPANY_NO
      ,COMPANY_NAME
      ,ITEM_MASTER_SID
      ,ITEM_ID
      ,ITEM_NO
      ,ITEM_NAME
      ,BRAND_MASTER_SID
      ,BRAND_ID
      ,BRAND_NAME
      ,RS_MODEL_SID
      ,RS_CATEGORY
      ,RS_TYPE
      ,REBATE_PROGRAM_TYPE
      ,DEDUCTION_INCLUSION
      ,RS_ID
      ,RS_NO
      ,RS_NAME
      ,RS_UDC_1
      ,RS_UDC_2
      ,RS_UDC_3
      ,RS_UDC_4
      ,RS_UDC_5
      ,RS_UDC_6
      ,PROJECTION_MASTER_SID
      ,WORKFLOW_MASTER_SID
      ,CREATED_DATE
      ,WORKFLOW_ID
      ,WORKFLOW_NAME
      ,WORKFLOW_STATUS
      )
 SELECT A.ARM_ADJUSTMENT_DETAILS_SID
      ,C.CONTRACT_MASTER_SID
      ,CON.CONTRACT_ID
      ,CON.CONTRACT_NO
      ,CON.[CONTRACT_NAME]
      ,C.COMPANY_MASTER_SID
      ,CM.COMPANY_ID
      ,CM.COMPANY_NO
      ,CM.COMPANY_NAME
      ,C.ITEM_MASTER_SID
      ,IM.ITEM_ID
      ,IM.ITEM_NO
      ,IM.ITEM_NAME
      ,BM.BRAND_MASTER_SID
      ,BM.BRAND_ID
      ,BM.BRAND_NAME
      ,A.RS_MODEL_SID
      ,RS_CATEGORY
      ,RS_TYPE
      ,REBATE_PROGRAM_TYPE
      ,R.DEDUCTION_INCLUSION
      ,R.RS_ID
      ,R.RS_NO
      ,R.RS_NAME
      ,U.UDC1 AS RS_UDC_1
      ,U.UDC2 AS RS_UDC_2
      ,U.UDC3 AS RS_UDC_3
      ,U.UDC4 AS RS_UDC_4
      ,U.UDC5 AS RS_UDC_5
      ,U.UDC6 AS RS_UDC_6
      ,A.PROJECTION_MASTER_SID
      ,WM.WORKFLOW_MASTER_SID
      ,WM.CREATED_DATE
      ,WM.WORKFLOW_ID
      ,WM.WORKFLOW_DESCRPTION
      ,WM.WORKFLOW_STATUS_ID
 FROM ARM_ADJUSTMENT_DETAILS A
 JOIN CCP_DETAILS C ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID
 JOIN ITEM_MASTER IM ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
 JOIN COMPANY_MASTER CM ON CM.COMPANY_MASTER_SID = C.COMPANY_MASTER_SID
 JOIN CONTRACT_MASTER CON ON CON.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID
 JOIN BRAND_MASTER BM ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
 JOIN RS_CONTRACT R ON R.RS_MODEL_SID = A.RS_MODEL_SID
      AND R.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID
 JOIN ARM_DEDUCTION_SELECTION ADS ON ADS.RS_CONTRACT_SID = R.RS_CONTRACT_SID
      AND ADS.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
 LEFT JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID
 JOIN UDCS U ON U.MASTER_SID = R.RS_CONTRACT_SID
      AND U.MASTER_TYPE = 'RS_CONTRACT'
 WHERE A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID

 INSERT INTO ADJUSTMENT_GTN_DETAIL (
      WORKFLOW_ID
      ,WORKFLOW_NAME
      ,ADJUSTMENT_TYPE
      ,GL_YEAR
      ,GL_MONTH
      ,GL_DATE
      ,REDEMPTION_PERIOD
      ,CALCULATION_PERIOD
      ,GL_COMPANY_ID
      ,GL_COMPANY_NO
      ,GL_COMPANY_NAME
      ,BUSINESS_UNIT_ID
      ,BUSINESS_UNIT_NO
      ,BUSINESS_UNIT_NAME
      ,COST_CENTER
      ,PROJECT
      ,FUTURE_1
      ,FUTURE_2
      ,GL_STRING
      ,ACCOUNT_CATEGORY
      ,ACCOUNT_TYPE
      ,ACCOUNT
      ,CONTRACT_ID
      ,CONTRACT_NO
      ,CONTRACT_NAME
      ,COMPANY_ID
      ,COMPANY_NO
      ,COMPANY_NAME
      ,ITEM_ID
      ,ITEM_NO
      ,ITEM_NAME
      ,BRAND_ID
      ,BRAND_NAME
      ,DEDUCTION_ID
      ,DEDUCTION_NO
      ,DEDUCTION_NAME
      ,DEDUCTION_CATEGORY
      ,DEDUCTION_TYPE
      ,DEDUCTION_PROGRAM
      ,DEDUCTION_INCLUSION
      ,DEDUCTION_UDC_1
      ,DEDUCTION_UDC_2
      ,DEDUCTION_UDC_3
      ,DEDUCTION_UDC_4
      ,DEDUCTION_UDC_5
      ,DEDUCTION_UDC_6
      ,DEDUCTION_AMOUNT
      ,DEDUCTION_RATE
      ,UDC_1
      ,UDC_2
      ,UDC_3
      ,UDC_4
      ,UDC_5
      ,UDC_6
      ,WORKFLOW_CREATED_BY
      ,WORKFLOW_CREATED_DATE
      ,WORKFLOW_APPROVED_BY
      ,WORKFLOW_APPROVED_DATE
      ,ADJUSTMENT_LEVEL
      ,ACCOUNT_DESCRIPTION
      ,ACCOUNT_INDICATOR
      ,DIVISION
      )
 SELECT A.WORKFLOW_ID
      ,A.WORKFLOW_NAME
      ,ARC.ADJUSTMENT_TYPE  AS ADJUSTMENT_TYPE
      ,YEAR(GL_IMPACT_DATE) AS GL_YEAR
      ,MONTH(GL_IMPACT_DATE) AS GL_MONTH
      ,GL_IMPACT_DATE AS GLDATE
      ,CASE
              WHEN AC.REDEMPTION_PERIOD = 1
                      THEN TP.PERIOD_DATE
              ELSE NULL
              END AS REDEMPTION_PERIOD
   ,TP.PERIOD_DATE AS CALCULATION_PERIOD
      ,GL.COMPANY_ID AS GL_COMPANY_ID
      ,GL.COMPANY_NO AS GL_COMPANY_NO
      ,GL.COMPANY_NAME AS GL_COMPANY_NAME
      ,BU.COMPANY_ID AS BU_COMPANY_ID
      ,BU.COMPANY_NO AS BU_COMPANY_NO
      ,BU.COMPANY_NAME AS BU_COMPANY_NAME
      ,ARC.COST_CENTER AS COST_CENTER
      ,ARC.PROJECT AS PROJECT
      ,ARC.FUTURE_1 AS FUTURE_1
      ,ARC.FUTURE_2 AS FUTURE_2
      ,GL.COMPANY_ID + ' - ' + 
         CASE WHEN 
		 (AAD.DIVISION='' OR AAd.DIVISION IS NULL) AND (AAD.COST_CENTER='' OR AAd.COST_CENTER IS NULL)
		THEN AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		WHEN (AAD.DIVISION='' OR AAd.DIVISION IS NULL) AND (AAD.COST_CENTER IS NOT NULL) THEN +AAD.COST_CENTER+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		WHEN (AAD.DIVISION IS NOT NULL) AND (AAD.COST_CENTER='' OR AAd.COST_CENTER IS NULL) THEN AAD.DIVISION+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
		ELSE AAD.DIVISION+' - '+AAD.COST_CENTER+' - '+AAD.ACCOUNT+' - '+A.BRAND_ID+' - '+AAD.PROJECT+'- '+AAD.FUTURE_1+' - '+AAD.FUTURE_2
         END AS GLSTRING
      ,ARC.ACCOUNT_CATEGORY AS ACCOUNT_CATEGORY
      ,ARC.ACCOUNT_TYPE AS ACCOUNT_TYPE
      ,ARC.ACCOUNT AS ACCOUNT
      ,A.CONTRACT_ID AS CONTRACT_ID
      ,A.CONTRACT_NO AS CONTRACT_NO
      ,A.CONTRACT_NAME AS CONTRACT_NAME
      ,A.COMPANY_ID AS COMPANY_ID
      ,A.COMPANY_NO AS COMPANY_NO
      ,A.COMPANY_NAME AS COMPANY_NAME
      ,A.ITEM_ID AS ITEM_ID
      ,A.ITEM_NO AS ITEM_NO
	  
      ,A.ITEM_NAME AS ITEM_NAME
      ,A.BRAND_ID AS BRAND_ID
      ,A.BRAND_NAME AS BRAND_NAME
      ,A.RS_ID AS DEDUCTION_ID
      ,A.RS_NO AS DEDUCTION_NO
      ,A.RS_NAME AS DEDUCTION_NAME
      ,A.RS_CATEGORY AS DEDUCTION_CATEGORY
      ,A.RS_TYPE AS DEDUCTION_TYPE
      ,A.REBATE_PROGRAM_TYPE AS REBATE_PROGRAM_TYPE
      ,A.DEDUCTION_INCLUSION AS DEDUCTION_INCLUSION
      ,A.RS_UDC_1 AS DEDUCTION_UDC_1
      ,A.RS_UDC_2 AS DEDUCTION_UDC_2
      ,A.RS_UDC_3 AS DEDUCTION_UDC_3
      ,A.RS_UDC_4 AS DEDUCTION_UDC_4
      ,A.RS_UDC_5 AS DEDUCTION_UDC_5
      ,A.RS_UDC_6 AS DEDUCTION_UDC_6
      ,CASE WHEN ISNULL(TP.DEBIT,0)-ISNULL(TP.CREDIT,0) > 0 THEN TP.DEBIT
		 ELSE TP.CREDIT * -1 END  AS ACCRUAL_AMOUNT
      ,TP.ACCRUAL_RATE AS RATE
      ,ARC.UDC_1 AS UDC_1
      ,ARC.UDC_2 AS UDC_2
      ,ARC.UDC_3 AS UDC_3
      ,ARC.UDC_4 AS UDC_4
      ,ARC.UDC_5 AS UDC_5
      ,ARC.UDC_6 AS UDC_6
      ,WM.CREATED_BY AS WORKFLOW_CREATED_BY
      ,WM.CREATED_DATE AS WORKFLOW_CREATED_DATE
      ,WM.APPROVED_BY AS WORKFLOW_APPROVED_BY
      ,WM.APPROVED_DATE AS WORKFLOW_APPROVED_DATE
      ,ARC.ADJUSTMENT_LEVEL
      ,AAD.ACCOUNT_DESC
      ,AAD.ACCOUNT_INDICATOR
      ,ARC.DIVISION
 FROM #TEMP_GTN A
 JOIN ARM_ADJUSTMENT_MASTER AM ON A.PROJECTION_MASTER_SID = AM.PROJECTION_MASTER_SID
 JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID = AM.PROJECTION_MASTER_SID
 JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID
 LEFT JOIN @TEMP_PROJ_GTN TP ON TP.ARM_ADJUSTMENT_DETAILS_SID = A.ARM_ADJUSTMENT_DETAILS
 JOIN ARM_ADJ_RES_CONFIG_MASTER AAM ON AAM.RS_CATEGORY = A.RS_CATEGORY
      AND AAM.RS_TYPE = A.RS_TYPE
      AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE
      AND AAM.GL_COMPANY_MASTER_SID = @GL_COMP
      AND AM.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID
      AND AAM.CONFIGURATION_TYPE = 1
 JOIN ARM_ADJ_RES_CONFIG_DETAIL AAD ON AAD.ARM_ADJ_RES_CONFIG_MASTER_SID = AAM.ARM_ADJ_RES_CONFIG_MASTER_SID
 INNER JOIN ARM_ADJ_RES_CCP ARC ON ARC.ARM_ADJ_RES_CONFIG_MASTER_SID = AAM.ARM_ADJ_RES_CONFIG_MASTER_SID
      AND ARC.ADJUSTMENT_TYPE = AAD.ADJUSTMENT_TYPE
      AND ARC.ACCOUNT = AAD.ACCOUNT
      AND A.ARM_ADJUSTMENT_DETAILS = ARC.ARM_ADJUSTMENT_DETAILS_SID
      AND AC.ARM_ADJUSTMENT_CONFIG_SID = AAD.ADJUSTMENT_TYPE
	   AND ARC.ARM_ADJUSTMENT_DETAILS_SID = TP.ARM_ADJUSTMENT_DETAILS_SID
       AND ARC.ACCOUNT=TP.ACCOUNT 
 JOIN COMPANY_MASTER GL ON GL.COMPANY_MASTER_SID = @GL_COMP
 JOIN COMPANY_MASTER BU ON BU.COMPANY_MASTER_SID = AM.BU_COMPANY_MASTER_SID
 WHERE AAD.ADJUSTMENT_TYPE = ? AND TP.ACCRUAL_AMOUNT<>0
 ORDER BY AAD.ACCOUNT
      ,BRAND_ID ;
 
         ]]>  
        </query>
             
    </entity>   
    <entity id="Pipeline_Adjustment_details_Insert_Reserve">      
        <query>  
       <![CDATA[   

 DECLARE @GL_COMP INT, @FROM_PERIOD DATE
      ,@PROJECTION_MASTER_SID INT = ?

 SELECT @FROM_PERIOD = FROM_DATE
      ,@GL_COMP = COMPANY_MASTER_SID
 FROM PROJECTION_MASTER
 WHERE PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID

 IF OBJECT_ID('TEMPDB..#ARM_ADJ_RES_CCP') IS NOT NULL
      DROP TABLE #ARM_ADJ_RES_CCP

  SELECT DISTINCT BM.BRAND_ID,ARM_ADJ_RES_CONFIG_MASTER_SID
         ,A.ADJUSTMENT_TYPE
         ,A.ACCOUNT_CATEGORY
         ,A.ACCOUNT_TYPE
         ,A.ACCOUNT
         ,A.ADJUSTMENT_LEVEL
         ,A.CREDIT
         ,A.DEBIT
         ,ACCOUNT_DESC
         ,ACCOUNT_INDICATOR
         ,COST_CENTER
         ,PROJECT
         ,FUTURE_1
         ,FUTURE_2
         ,UDC_1
         ,UDC_2
         ,UDC_3
         ,UDC_4
         ,UDC_5
         ,UDC_6
         ,BALANCE_TYPE
         ,[DATABASE]
         ,DATA_ACCESS_SET
         ,CHART_OF_ACCOUNTS
         ,LEDGER
         ,CATEGORY
         ,A.SOURCE
         ,CURRENCY
         ,JOURNAL_NAME
         ,JOURNAL_DESCRIPTION
         ,REVERSE_JOURNAL
         ,REVERSAL_PERIOD_DATE
         ,LINE_DESCRIPTION
         ,DIVISION
  INTO #ARM_ADJ_RES_CCP
  FROM ARM_ADJUSTMENT_MASTER AM
  JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID
  JOIN ARM_ADJUSTMENT_DETAILS B ON AM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
  INNER JOIN ARM_ADJ_RES_CCP A ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
       AND AM.TRANSACTION_TYPE = A.ADJUSTMENT_TYPE
 JOIN CCP_DETAILS C
          ON C.CCP_DETAILS_SID = B.CCP_DETAILS_SID
        JOIN ITEM_MASTER IM
          ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
        JOIN BRAND_MASTER BM
          ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID
     JOIN HELPER_TABLE HT1
         ON HT1.HELPER_TABLE_SID = A.ADJUSTMENT_LEVEL
         AND HT1.DESCRIPTION IN ('BRAND','TOTAL')
  WHERE AM.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID

  IF OBJECT_ID ('TEMPDB..#TEMP_PROJ_RES_BRAND') IS NOT NULL 
     DROP TABLE #TEMP_PROJ_RES_BRAND 

    CREATE TABLE #TEMP_PROJ_RES_BRAND 
    ( 
     BRAND_MASTER_SID      INT, 
     BRAND_ID              VARCHAR(50), 
     ACCOUNT               VARCHAR(50), 
     PERIOD_DATE           DATETIME, 
     RS_CATEGORY           INT, 
     RS_TYPE               INT, 
     REBATE_PROGRAM_TYPE   INT, 
     DEBIT                 NUMERIC(22, 6), 
     CREDIT                NUMERIC(22,6),
     PROJECTION_MASTER_SID INT, 
     WORKFLOW_MASTER_SID   INT NULL, 
     WORKFLOW_ID           VARCHAR(50),
     WORKFLOW_NAME           VARCHAR(500),
     WORKFLOW_STATUS           INT,
     ARM_ADJUSTMENT_CONFIG_SID INT,
     TRANSACTION_NAME VARCHAR(50)
    )

INSERT INTO #TEMP_PROJ_RES_BRAND  
            (BRAND_MASTER_SID, 
             BRAND_ID,
             ACCOUNT, 
             PERIOD_DATE, 
             RS_CATEGORY, 
             RS_TYPE, 
             REBATE_PROGRAM_TYPE, 
             DEBIT, 
             CREDIT,
             PROJECTION_MASTER_SID, 
             WORKFLOW_MASTER_SID, 
             WORKFLOW_ID,
             WORKFLOW_NAME,
             WORKFLOW_STATUS,
             ARM_ADJUSTMENT_CONFIG_SID,
             TRANSACTION_NAME) 

 SELECT IM.BRAND_MASTER_SID
      ,BM.BRAND_ID
	  ,AA.ACCOUNT
      ,P.PERIOD_DATE
      ,RS_CATEGORY
      ,RS_TYPE
      ,REBATE_PROGRAM_TYPE
	  ,CASE WHEN ISNULL(SUM(AA.DEBIT),0) -  ISNULL(SUM(AA.CREDIT),0) > 0 THEN ISNULL(SUM(AA.DEBIT),0) -  ISNULL(SUM(AA.CREDIT),0) 
	       			        ELSE 0 END AS DEBIT,
	   CASE WHEN ISNULL(SUM(AA.CREDIT),0) -  ISNULL(SUM(AA.DEBIT),0) > 0 THEN ISNULL(SUM(AA.CREDIT),0) -  ISNULL(SUM(AA.DEBIT),0)
				   ELSE 0 END  AS CREDIT
      ,A.PROJECTION_MASTER_SID
      ,WORKFLOW_MASTER_SID
      ,WORKFLOW_ID
      ,WM.WORKFLOW_DESCRPTION
      ,WM.WORKFLOW_STATUS_ID
      ,ARM_ADJUSTMENT_CONFIG_SID
      ,TRANSACTION_NAME
 FROM ARM_ADJUSTMENT_DETAILS A
  JOIN ? B ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID  --DYNAMIC
  JOIN PERIOD P ON P.PERIOD_SID = B.PERIOD_SID
  JOIN ARM_ADJ_RES_CCP AAC ON A.ARM_ADJUSTMENT_DETAILS_SID=AAC.ARM_ADJUSTMENT_DETAILS_SID
  JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=AAC.ADJUSTMENT_LEVEL AND HT.DESCRIPTION='BRAND'
 LEFT JOIN ARM_ADJUSTMENTS AA 
              ON AA.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
			  AND AA.PERIOD_SID=B.PERIOD_SID
              AND  AA.ACCOUNT=AAC.ACCOUNT
			  AND AA.ADJUSTMENT_TYPE=AAC.ADJUSTMENT_TYPE
 LEFT JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID
 JOIN ARM_ADJUSTMENT_MASTER AM ON AM.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID
 JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID
 JOIN CCP_DETAILS C ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID
 JOIN ITEM_MASTER IM ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
 JOIN BRAND_MASTER BM ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
 JOIN RS_CONTRACT R ON R.RS_MODEL_SID = A.RS_MODEL_SID
      AND R.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID
 JOIN dbo.ARM_DEDUCTION_SELECTION ADS ON ADS.RS_CONTRACT_SID = R.RS_CONTRACT_SID
      AND ADS.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID
 WHERE A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
      AND P.PERIOD_DATE = @FROM_PERIOD
 GROUP BY IM.BRAND_MASTER_SID
      ,BM.BRAND_ID
	  ,AA.ACCOUNT
      ,P.PERIOD_DATE
      ,RS_CATEGORY
      ,RS_TYPE
      ,REBATE_PROGRAM_TYPE
      ,WORKFLOW_MASTER_SID
      ,A.PROJECTION_MASTER_SID
      ,WORKFLOW_ID
      ,WM.WORKFLOW_DESCRPTION
      ,WM.WORKFLOW_STATUS_ID
      ,ARM_ADJUSTMENT_CONFIG_SID
      ,TRANSACTION_NAME;

IF OBJECT_ID ('TEMPDB..#TEMP_PROJ_RES_TOTAL') IS NOT NULL 
  DROP TABLE #TEMP_PROJ_RES_TOTAL 

CREATE TABLE #TEMP_PROJ_RES_TOTAL 
  ( 
     BRAND_MASTER_SID      INT, 
     BRAND_ID              VARCHAR(50),
	 ACCOUNT               VARCHAR(50), 
     PERIOD_DATE           DATETIME, 
     RS_CATEGORY           INT, 
     RS_TYPE               INT, 
     REBATE_PROGRAM_TYPE   INT, 
     DEBIT        NUMERIC(22, 6), 
	 CREDIT NUMERIC(22,6),
     PROJECTION_MASTER_SID INT, 
     WORKFLOW_MASTER_SID   INT NULL, 
     WORKFLOW_ID           VARCHAR(50),
     WORKFLOW_NAME           VARCHAR(500),
     WORKFLOW_STATUS           INT,
     ARM_ADJUSTMENT_CONFIG_SID INT,
     TRANSACTION_NAME VARCHAR(50)
  )

INSERT INTO #TEMP_PROJ_RES_TOTAL 
            (BRAND_MASTER_SID, 
             BRAND_ID,
			 ACCOUNT, 
             PERIOD_DATE, 
             RS_CATEGORY, 
             RS_TYPE, 
             REBATE_PROGRAM_TYPE, 
             DEBIT, 
             CREDIT,
             PROJECTION_MASTER_SID, 
             WORKFLOW_MASTER_SID, 
             WORKFLOW_ID,
             WORKFLOW_NAME,
             WORKFLOW_STATUS,
             ARM_ADJUSTMENT_CONFIG_SID,
             TRANSACTION_NAME) 

 SELECT IM.BRAND_MASTER_SID
      ,BM.BRAND_ID
	  ,AA.ACCOUNT
      ,P.PERIOD_DATE
      ,RS_CATEGORY
      ,RS_TYPE
      ,REBATE_PROGRAM_TYPE
	  ,CASE WHEN ISNULL(SUM(AA.DEBIT),0) -  ISNULL(SUM(AA.CREDIT),0) > 0 THEN ISNULL(SUM(AA.DEBIT),0) -  ISNULL(SUM(AA.CREDIT),0) 
	       			        ELSE 0 END AS DEBIT,
	   CASE WHEN ISNULL(SUM(AA.CREDIT),0) -  ISNULL(SUM(AA.DEBIT),0) > 0 THEN ISNULL(SUM(AA.CREDIT),0) -  ISNULL(SUM(AA.DEBIT),0)
				   ELSE 0 END  AS CREDIT
      ,A.PROJECTION_MASTER_SID
      ,WORKFLOW_MASTER_SID
      ,WORKFLOW_ID
      ,WM.WORKFLOW_DESCRPTION
      ,WM.WORKFLOW_STATUS_ID
      ,ARM_ADJUSTMENT_CONFIG_SID
      ,TRANSACTION_NAME
 FROM ARM_ADJUSTMENT_DETAILS A
 JOIN ? B ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID --DYNAMIC
 JOIN PERIOD P ON P.PERIOD_SID = B.PERIOD_SID
 JOIN ARM_ADJ_RES_CCP AAC ON A.ARM_ADJUSTMENT_DETAILS_SID=AAC.ARM_ADJUSTMENT_DETAILS_SID
JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=AAC.ADJUSTMENT_LEVEL AND HT.DESCRIPTION='TOTAL'
 LEFT JOIN ARM_ADJUSTMENTS AA 
              ON AA.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
			  AND AA.PERIOD_SID=B.PERIOD_SID
              AND  AA.ACCOUNT=AAC.ACCOUNT
			  AND AA.ADJUSTMENT_TYPE=AAC.ADJUSTMENT_TYPE
 LEFT JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID
 JOIN ARM_ADJUSTMENT_MASTER AM ON AM.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID
 JOIN ARM_ADJUSTMENT_CONFIG AC ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID
 JOIN CCP_DETAILS C ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID
 JOIN ITEM_MASTER IM ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID
 JOIN BRAND_MASTER BM ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
 JOIN RS_CONTRACT R ON R.RS_MODEL_SID = A.RS_MODEL_SID
      AND R.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID
 JOIN dbo.ARM_DEDUCTION_SELECTION ADS ON ADS.RS_CONTRACT_SID = R.RS_CONTRACT_SID
      AND ADS.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID
 WHERE A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
      AND P.PERIOD_DATE = @FROM_PERIOD
 GROUP BY IM.BRAND_MASTER_SID
      ,BM.BRAND_ID
	  ,AA.ACCOUNT
      ,P.PERIOD_DATE
      ,RS_CATEGORY
      ,RS_TYPE
      ,REBATE_PROGRAM_TYPE
      ,WORKFLOW_MASTER_SID
      ,A.PROJECTION_MASTER_SID
      ,WORKFLOW_ID
      ,WM.WORKFLOW_DESCRPTION
      ,WM.WORKFLOW_STATUS_ID
      ,ARM_ADJUSTMENT_CONFIG_SID
      ,TRANSACTION_NAME;

IF OBJECT_ID ('TEMPDB..#CTE_BRAND') IS NOT NULL 
  DROP TABLE #CTE_BRAND 

SELECT * INTO #CTE_BRAND FROM (
      SELECT B.GL_IMPACT_DATE AS ACCOUNTING_DATE
              ,BU.COMPANY_ID AS BU_COMPANY_ID
              ,BU.COMPANY_NO AS BU_COMPANY_NO
              ,B.BU_COMPANY_MASTER_SID
              ,A.BRAND_ID
			  ,A.ACCOUNT
              ,A.PERIOD_DATE AS REDEMPTION_PERIOD
              ,GL.COMPANY_ID AS GL_COMPANY_ID
              ,GL.COMPANY_NO AS GL_COMPANY_NO
              ,ARM_ADJ_RES_CONFIG_MASTER_SID
			  ,A.DEBIT
			  ,A.CREDIT
              ,PM.PROJECTION_DESCRIPTION
              ,A.WORKFLOW_ID
              ,PERIOD_DATE AS REDEMPTION_DATE
              ,A.ARM_ADJUSTMENT_CONFIG_SID
              ,A.TRANSACTION_NAME
              ,A.WORKFLOW_NAME
              ,A.WORKFLOW_STATUS
              ,WM.CREATED_BY AS WORKFLOW_CREATED_BY
              ,WM.CREATED_DATE AS WORKFLOW_CREATED_DATE
              ,WM.APPROVED_BY AS WORKFLOW_APPROVED_BY
              ,WM.APPROVED_DATE AS WORKFLOW_APPROVED_DATE
              ,AAM.RS_CATEGORY
			  ,AAM.RS_TYPE
			  ,AAM.REBATE_PROGRAM_TYPE
      FROM #TEMP_PROJ_RES_BRAND A
      JOIN ARM_ADJUSTMENT_MASTER B ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
      JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
      JOIN PROJECTION_MASTER PM ON PM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
      JOIN COMPANY_MASTER BU ON BU.COMPANY_MASTER_SID = B.BU_COMPANY_MASTER_SID
      JOIN COMPANY_MASTER GL ON GL.COMPANY_MASTER_SID = PM.COMPANY_MASTER_SID
      JOIN ARM_ADJ_RES_CONFIG_MASTER AAM ON AAM.RS_CATEGORY = A.RS_CATEGORY
              AND AAM.RS_TYPE = A.RS_TYPE
              AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE
              AND PM.COMPANY_MASTER_SID = AAM.GL_COMPANY_MASTER_SID
              AND B.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID
              AND AAM.CONFIGURATION_TYPE = 0
              AND (
                      GL.COMPANY_MASTER_SID = @GL_COMP
                      OR @GL_COMP IS NULL
                      )
      ) A

IF OBJECT_ID ('TEMPDB..#CTE_TOTAL') IS NOT NULL 
  DROP TABLE #CTE_TOTAL 

SELECT * INTO #CTE_TOTAL FROM (
      SELECT B.GL_IMPACT_DATE AS ACCOUNTING_DATE
              ,BU.COMPANY_ID AS BU_COMPANY_ID
              ,BU.COMPANY_NO AS BU_COMPANY_NO
              ,B.BU_COMPANY_MASTER_SID
              ,A.BRAND_ID
			  ,A.ACCOUNT
              ,A.PERIOD_DATE AS REDEMPTION_PERIOD
              ,GL.COMPANY_ID AS GL_COMPANY_ID
              ,GL.COMPANY_NO AS GL_COMPANY_NO
              ,ARM_ADJ_RES_CONFIG_MASTER_SID
			  ,A.DEBIT
			  ,A.CREDIT
              ,PM.PROJECTION_DESCRIPTION
              ,A.WORKFLOW_ID
              ,PERIOD_DATE AS REDEMPTION_DATE
              ,A.ARM_ADJUSTMENT_CONFIG_SID
              ,A.TRANSACTION_NAME
              ,A.WORKFLOW_NAME
              ,A.WORKFLOW_STATUS
              ,WM.CREATED_BY AS WORKFLOW_CREATED_BY
              ,WM.CREATED_DATE AS WORKFLOW_CREATED_DATE
              ,WM.APPROVED_BY AS WORKFLOW_APPROVED_BY
              ,WM.APPROVED_DATE AS WORKFLOW_APPROVED_DATE
              ,AAM.RS_CATEGORY
			  ,AAM.RS_TYPE
			  ,AAM.REBATE_PROGRAM_TYPE
      FROM #TEMP_PROJ_RES_TOTAL A
      JOIN ARM_ADJUSTMENT_MASTER B ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
      JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
      JOIN PROJECTION_MASTER PM ON PM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
      JOIN COMPANY_MASTER BU ON BU.COMPANY_MASTER_SID = B.BU_COMPANY_MASTER_SID
      JOIN COMPANY_MASTER GL ON GL.COMPANY_MASTER_SID = PM.COMPANY_MASTER_SID
      JOIN ARM_ADJ_RES_CONFIG_MASTER AAM ON AAM.RS_CATEGORY = A.RS_CATEGORY
              AND AAM.RS_TYPE = A.RS_TYPE
              AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE
              AND PM.COMPANY_MASTER_SID = AAM.GL_COMPANY_MASTER_SID
              AND B.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID
              AND AAM.CONFIGURATION_TYPE = 0
              AND (
                      GL.COMPANY_MASTER_SID = @GL_COMP
                      OR @GL_COMP IS NULL
                      )
      ) A

 INSERT INTO ADJUSTMENT_RESERVE_DETAIL (
      WORKFLOW_ID
      ,WORKFLOW_NAME
      ,COMPANY
      ,DIVISION
      ,BUSINESS_UNIT
      ,JOURNAL_NAME
      ,JOURNAL_DESCRIPTION
      ,BRAND
      ,DEBIT
      ,CREDIT
      ,CURRENCY
      ,ACCOUNTING_DATE
      ,REDEMPTION_PERIOD
      ,CALCULATION_PERIOD
      ,CATEGORY
      ,BALANCE_TYPE
      ,ARD_DB
      ,DATA_ACCESS_SET
      ,CHART_OF_ACCOUNTS
      ,LEDGER 
      ,REVERSE_JOURNAL
      ,REVERSAL_PERIOD_DATE
      ,LINE_DESCRIPTION
      ,ACCOUNT_CATEGORY
      ,ACCOUNT_TYPE
      ,ADJUSTMENT_TYPE
      ,ADJUSTMENT_LEVEL
      ,ACCOUNT
      ,COST_CENTER
      ,PROJECT
      ,FUTURE_1
      ,FUTURE_2
      ,UDC_1
      ,UDC_2
      ,UDC_3
      ,UDC_4
      ,UDC_5
      ,UDC_6
      ,WORKFLOW_CREATED_BY
      ,WORKFLOW_CREATED_DATE
      ,WORKFLOW_APPROVED_BY
      ,WORKFLOW_APPROVED_DATE
      ,SOURCE
      ,BATCH_NAME
      ,RS_CATEGORY
	  ,RS_TYPE
	  ,REBATE_PROGRAM_TYPE
      ,ACCOUNT_INDICATOR
      ,ACCOUNT_DESCRIPTION
      )
 SELECT A.WORKFLOW_ID
      ,A.WORKFLOW_NAME
      ,A.GL_COMPANY_ID AS GL_COMPANY_ID
      ,ARC.DIVISION AS DIVISION
      ,A.BU_COMPANY_ID AS BU
      ,AAD.JOURNAL_NAME AS JOURNAL_NAME
      ,AAD.JOURNAL_DESCRIPTION AS JOURNAL_DESCRIPTION
      ,A.BRAND_ID AS BRAND_ID
      ,CASE WHEN A.DEBIT = 0 THEN NULL ELSE A.DEBIT END AS DEBIT
      ,CASE WHEN A.CREDIT = 0 THEN NULL ELSE A.CREDIT END AS CREDIT
      ,AAD.CURRENCY AS CURRENCY
      ,A.ACCOUNTING_DATE AS ACCOUNTING_DATE
      ,CASE
              WHEN AAC.REDEMPTION_PERIOD = 1
                      THEN @FROM_PERIOD
              ELSE NULL
              END
      ,@FROM_PERIOD AS CALCULATION_PERIOD
      ,AAD.CATEGORY AS CATEGORY
      ,AAD.BALANCE_TYPE AS BALANCE_TYPE
      ,AAD."DATABASE" AS DATABASE_DESC
      ,AAD.DATA_ACCESS_SET AS DATA_ACCESS_SET
      ,AAD.CHART_OF_ACCOUNTS AS CHART_OF_ACCOUNTS
      ,AAD.LEDGER AS LEDGER
      ,AAD.REVERSE_JOURNAL AS REVERSE_JOURNAL
      ,AAD.REVERSAL_PERIOD_DATE AS REVERSAL_PERIOD_DATE
      ,AAD.LINE_DESCRIPTION AS LINE_DESCRIPTION
      ,AAD.ACCOUNT_CATEGORY AS ACCOUNT_CATEGORY
      ,AAD.ACCOUNT_TYPE AS ACCOUNT_TYPE
      ,AAD.ADJUSTMENT_TYPE
      ,AAD.ADJUSTMENT_LEVEL
      ,AAD.ACCOUNT AS ACCOUNT
      ,AAD.COST_CENTER AS COST_CENTER
      ,AAD.PROJECT AS PROJECT
      ,AAD.FUTURE_1 AS FUTURE_1
      ,AAD.FUTURE_2 AS FUTURE_2
      ,AAD.UDC_1 AS UDC_1
      ,AAD.UDC_2 AS UDC_2
      ,AAD.UDC_3 AS UDC_3
      ,AAD.UDC_4 AS UDC_4
      ,AAD.UDC_5 AS UDC_5
      ,AAD.UDC_6 AS UDC_6
      ,A.WORKFLOW_CREATED_BY
      ,A.WORKFLOW_CREATED_DATE
      ,A.WORKFLOW_APPROVED_BY
      ,A.WORKFLOW_APPROVED_DATE
      ,AAD."SOURCE" AS SOURCE_DESC
      ,BATCH_NAME = CASE
              WHEN A.WORKFLOW_ID IS NULL
                      THEN ''
              ELSE CONVERT(VARCHAR(100), A.TRANSACTION_NAME) + ' - ' + Isnull(A.WORKFLOW_ID, ' ') + ' - ' + AAD.JOURNAL_DESCRIPTION
              END
               , A.RS_CATEGORY
			  ,A.RS_TYPE
			  ,A.REBATE_PROGRAM_TYPE
              ,AAD.ACCOUNT_INDICATOR AS ACCOUNT_INDICATOR
              ,AAD.ACCOUNT_DESC AS ACCOUNT_DESCRIPTION
 FROM #CTE_BRAND A
 JOIN ARM_ADJ_RES_CONFIG_DETAIL ARC ON ARC.ARM_ADJ_RES_CONFIG_MASTER_SID = A.ARM_ADJ_RES_CONFIG_MASTER_SID
 AND A.ARM_ADJUSTMENT_CONFIG_SID=ARC.ADJUSTMENT_TYPE AND A.ACCOUNT=ARC.ACCOUNT
 INNER JOIN #ARM_ADJ_RES_CCP AAD ON  ARC.ARM_ADJ_RES_CONFIG_MASTER_SID = AAD.ARM_ADJ_RES_CONFIG_MASTER_SID 
                  AND ARC.ADJUSTMENT_TYPE = AAD.ADJUSTMENT_TYPE 
                  
                  AND ARC.ACCOUNT = AAD.ACCOUNT 
                  AND ARC.ADJUSTMENT_LEVEL = AAD.ADJUSTMENT_LEVEL 
                  AND A.BRAND_ID = AAD.BRAND_ID 
                 
      AND A.ARM_ADJUSTMENT_CONFIG_SID = AAD.ADJUSTMENT_TYPE
 JOIN ARM_ADJUSTMENT_CONFIG AAC ON AAC.ARM_ADJUSTMENT_CONFIG_SID = AAD.ADJUSTMENT_TYPE
 JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID = AAD.ACCOUNT_TYPE
 JOIN HELPER_TABLE HT1 ON HT1.HELPER_TABLE_SID = AAD.ADJUSTMENT_LEVEL AND HT1.DESCRIPTION='BRAND'
WHERE AAD.ADJUSTMENT_TYPE = ?
AND (A.DEBIT<>0 OR A.CREDIT<>0)

 UNION ALL

 SELECT A.WORKFLOW_ID
      ,A.WORKFLOW_NAME
      ,A.GL_COMPANY_ID AS GL_COMPANY_ID
      ,ARC.DIVISION AS DIVISION
      ,A.BU_COMPANY_ID AS BU
      ,AAD.JOURNAL_NAME AS JOURNAL_NAME
      ,AAD.JOURNAL_DESCRIPTION AS JOURNAL_DESCRIPTION
      ,'000' AS BRAND_ID
      ,CASE WHEN A.DEBIT = 0 THEN NULL ELSE A.DEBIT END AS DEBIT
      ,CASE WHEN A.CREDIT = 0 THEN NULL ELSE A.CREDIT END AS CREDIT
      ,AAD.CURRENCY AS CURRENCY
      ,A.ACCOUNTING_DATE AS ACCOUNTING_DATE
      ,CASE
              WHEN AAC.REDEMPTION_PERIOD = 1
                      THEN @FROM_PERIOD
              ELSE NULL
              END
      ,@FROM_PERIOD AS CALCULATION_PERIOD
      ,AAD.CATEGORY AS CATEGORY
      ,AAD.BALANCE_TYPE AS BALANCE_TYPE
      ,AAD."DATABASE" AS DATABASE_DESC
      ,AAD.DATA_ACCESS_SET AS DATA_ACCESS_SET
      ,AAD.CHART_OF_ACCOUNTS AS CHART_OF_ACCOUNTS
      ,AAD.LEDGER AS LEDGER
      ,AAD.REVERSE_JOURNAL AS REVERSE_JOURNAL
      ,AAD.REVERSAL_PERIOD_DATE AS REVERSAL_PERIOD_DATE
      ,AAD.LINE_DESCRIPTION AS LINE_DESCRIPTION
      ,AAD.ACCOUNT_CATEGORY AS ACCOUNT_CATEGORY
      ,AAD.ACCOUNT_TYPE AS ACCOUNT_TYPE
      ,AAD.ADJUSTMENT_TYPE
      ,AAD.ADJUSTMENT_LEVEL
      ,AAD.ACCOUNT AS ACCOUNT
      ,AAD.COST_CENTER AS COST_CENTER
      ,AAD.PROJECT AS PROJECT
      ,AAD.FUTURE_1 AS FUTURE_1
      ,AAD.FUTURE_2 AS FUTURE_2
      ,AAD.UDC_1 AS UDC_1
      ,AAD.UDC_2 AS UDC_2
      ,AAD.UDC_3 AS UDC_3
      ,AAD.UDC_4 AS UDC_4
      ,AAD.UDC_5 AS UDC_5
      ,AAD.UDC_6 AS UDC_6
      ,A.WORKFLOW_CREATED_BY
      ,A.WORKFLOW_CREATED_DATE
      ,A.WORKFLOW_APPROVED_BY
      ,A.WORKFLOW_APPROVED_DATE
      ,AAD."SOURCE" AS SOURCE_DESC
      ,BATCH_NAME = CASE
              WHEN A.WORKFLOW_ID IS NULL
                      THEN ''
              ELSE CONVERT(VARCHAR(100), A.TRANSACTION_NAME) + ' - ' + Isnull(A.WORKFLOW_ID, ' ') + ' - ' + AAD.JOURNAL_DESCRIPTION
              END
               , A.RS_CATEGORY
			  ,A.RS_TYPE
			  ,A.REBATE_PROGRAM_TYPE
              ,AAD.ACCOUNT_INDICATOR AS ACCOUNT_INDICATOR
              ,AAD.ACCOUNT_DESC AS ACCOUNT_DESCRIPTION
 FROM (
      SELECT ARM_ADJ_RES_CONFIG_MASTER_SID
              ,GL_COMPANY_ID
              ,GL_COMPANY_NO
              ,BU_COMPANY_ID
              ,BU_COMPANY_NO
              ,BU_COMPANY_MASTER_SID
              ,ACCOUNTING_DATE
              ,PROJECTION_DESCRIPTION
			  ,SUM(DEBIT) AS DEBIT
			  ,SUM(CREDIT) AS CREDIT
              ,WORKFLOW_ID
              ,ARM_ADJUSTMENT_CONFIG_SID
              ,TRANSACTION_NAME
              ,REDEMPTION_DATE
              ,WORKFLOW_NAME
              ,WORKFLOW_STATUS
              ,WORKFLOW_CREATED_BY
              ,WORKFLOW_CREATED_DATE
              ,WORKFLOW_APPROVED_BY
              ,WORKFLOW_APPROVED_DATE
			  ,ACCOUNT
                          ,RS_CATEGORY
			  ,RS_TYPE
			  ,REBATE_PROGRAM_TYPE
      FROM #CTE_TOTAL
      GROUP BY ARM_ADJ_RES_CONFIG_MASTER_SID
              ,GL_COMPANY_ID
              ,GL_COMPANY_NO
              ,BU_COMPANY_ID
              ,BU_COMPANY_NO
              ,BU_COMPANY_MASTER_SID
              ,ACCOUNTING_DATE
              ,PROJECTION_DESCRIPTION
              ,WORKFLOW_ID
              ,ARM_ADJUSTMENT_CONFIG_SID
              ,TRANSACTION_NAME
              ,REDEMPTION_DATE
              ,WORKFLOW_NAME
              ,WORKFLOW_STATUS
              ,WORKFLOW_CREATED_BY
              ,WORKFLOW_CREATED_DATE
              ,WORKFLOW_APPROVED_BY
              ,WORKFLOW_APPROVED_DATE
			  ,ACCOUNT
                          ,RS_CATEGORY
			  ,RS_TYPE
			  ,REBATE_PROGRAM_TYPE
      ) A
 JOIN ARM_ADJ_RES_CONFIG_DETAIL ARC ON Arc.ARM_ADJ_RES_CONFIG_MASTER_SID = A.ARM_ADJ_RES_CONFIG_MASTER_SID
 INNER JOIN (SELECT *
    --,ROW_NUMBER() OVER(PARTITION BY ADJUSTMENT_TYPE,
     -- ACCOUNT ORDER BY ARM_ADJ_RES_CONFIG_MASTER_SID
     --     ) AS RN 
FROM #ARM_ADJ_RES_CCP AAD1 JOIN HELPER_TABLE HT1 ON HT1.HELPER_TABLE_SID = AAD1.ADJUSTMENT_LEVEL
                      AND HT1.DESCRIPTION='TOTAL' ) AAD ON ARC.ARM_ADJ_RES_CONFIG_MASTER_SID = A.ARM_ADJ_RES_CONFIG_MASTER_SID
                      AND ARC.ARM_ADJ_RES_CONFIG_MASTER_SID = AAD.ARM_ADJ_RES_CONFIG_MASTER_SID
      AND ARC.ADJUSTMENT_TYPE = AAD.ADJUSTMENT_TYPE
      
      AND ARC.ACCOUNT = AAD.ACCOUNT
      AND ARC.ACCOUNT=A.ACCOUNT
	  AND ARC.ADJUSTMENT_TYPE=A.ARM_ADJUSTMENT_CONFIG_SID
      AND ARC.ADJUSTMENT_LEVEL = AAD.ADJUSTMENT_LEVEL
      AND A.ARM_ADJUSTMENT_CONFIG_SID = AAD.ADJUSTMENT_TYPE
 JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID = AAD.ACCOUNT_TYPE
 JOIN ARM_ADJUSTMENT_CONFIG AAC ON AAC.ARM_ADJUSTMENT_CONFIG_SID = AAD.ADJUSTMENT_TYPE
WHERE AAD.ADJUSTMENT_TYPE = ?
AND (A.DEBIT<>0 OR A.CREDIT<>0)
 -- AND AAD.RN=1
 ORDER BY AAD.ACCOUNT
      ,BRAND_ID
         ]]>  
        </query>
             
    </entity>  
    
    <entity id="Demand_Adjustment_details_Insert_Reserve">      
        <query>  
       <![CDATA[   
     DECLARE @GL_COMP               INT, 
    @PROJECTION_MASTER_SID INT = ? 

SELECT @GL_COMP = COMPANY_MASTER_SID 
FROM   PROJECTION_MASTER 
WHERE  PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 

DECLARE @TEMP AS TABLE 
  ( 
     ARM_ADJUSTMENT_CONFIG_SID INT, 
     TRANSACTION_NAME          VARCHAR(100), 
     TRANSACTION_TYPE          INT, 
     PROJECTION_MASTER_SID     INT, 
     PRIMARY KEY ( PROJECTION_MASTER_SID, ARM_ADJUSTMENT_CONFIG_SID, TRANSACTION_TYPE ) 
  ) 

INSERT INTO @TEMP 
            (ARM_ADJUSTMENT_CONFIG_SID, 
             TRANSACTION_NAME, 
             TRANSACTION_TYPE, 
             PROJECTION_MASTER_SID) 
SELECT ARM_ADJUSTMENT_CONFIG_SID, 
       TRANSACTION_NAME, 
       TRANSACTION_TYPE, 
       PROJECTION_MASTER_SID 
FROM   ARM_ADJUSTMENT_MASTER AM 
       JOIN ARM_ADJUSTMENT_CONFIG AC 
         ON AM.TRANSACTION_TYPE = AC.ARM_ADJUSTMENT_CONFIG_SID 
WHERE  AM.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 

IF OBJECT_ID('TEMPDB..#ARM_ADJ_RES_CCP') IS NOT NULL 
  DROP TABLE #ARM_ADJ_RES_CCP 

SELECT DISTINCT BM.BRAND_ID, 
                ARCM.ARM_ADJ_RES_CONFIG_MASTER_SID, 
                A.ADJUSTMENT_TYPE, 
                A.ACCOUNT_CATEGORY, 
                A.ACCOUNT_TYPE, 
                A.ACCOUNT, 
                A.ADJUSTMENT_LEVEL, 
                A.CREDIT, 
                A.DEBIT, 
                ACCOUNT_DESC, 
                ACCOUNT_INDICATOR, 
                COST_CENTER, 
                PROJECT, 
                FUTURE_1, 
                FUTURE_2, 
                UDC_1, 
                UDC_2, 
                UDC_3, 
                UDC_4, 
                UDC_5, 
                UDC_6, 
                BALANCE_TYPE, 
                [DATABASE], 
                DATA_ACCESS_SET, 
                CHART_OF_ACCOUNTS, 
                LEDGER, 
                CATEGORY, 
                A.SOURCE, 
                CURRENCY, 
                JOURNAL_NAME, 
                JOURNAL_DESCRIPTION, 
                REVERSE_JOURNAL, 
                REVERSAL_PERIOD_DATE, 
                LINE_DESCRIPTION, 
                DIVISION 
INTO   #ARM_ADJ_RES_CCP 
FROM   ARM_ADJ_RES_CCP A 
       JOIN ARM_ADJUSTMENT_DETAILS B 
         ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID 
       INNER JOIN @TEMP T 
               ON T.TRANSACTION_TYPE = A.ADJUSTMENT_TYPE 
                  AND T.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID 
       INNER JOIN ARM_ADJ_RES_CONFIG_MASTER ARCM 
               ON ARCM.ARM_ADJ_RES_CONFIG_MASTER_SID = A.ARM_ADJ_RES_CONFIG_MASTER_SID 
                  AND ARCM.CONFIGURATION_TYPE = 0 
       JOIN CCP_DETAILS C 
         ON C.CCP_DETAILS_SID = B.CCP_DETAILS_SID 
       JOIN ITEM_MASTER IM 
         ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID 
       JOIN BRAND_MASTER BM 
         ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
       JOIN HELPER_TABLE HT1 
         ON HT1.HELPER_TABLE_SID = A.ADJUSTMENT_LEVEL 
            AND HT1.DESCRIPTION IN ( 'BRAND', 'TOTAL' ) 
WHERE  B.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 

IF OBJECT_ID('TEMPDB..#TEMP_PROJ_RES_BRAND') IS NOT NULL 
  DROP TABLE #TEMP_PROJ_RES_BRAND 

CREATE TABLE #TEMP_PROJ_RES_BRAND 
  ( 
     BRAND_MASTER_SID          INT, 
     BRAND_ID                  VARCHAR(50),
	 ACCOUNT               VARCHAR(50), 
     PERIOD_DATE               DATETIME, 
     RS_CATEGORY               INT, 
     RS_TYPE                   INT, 
     REBATE_PROGRAM_TYPE       INT, 
     DEBIT                 NUMERIC(22, 6), 
     CREDIT                NUMERIC(22,6),
     PROJECTION_MASTER_SID     INT, 
     WORKFLOW_MASTER_SID       INT NULL, 
     WORKFLOW_ID               VARCHAR(50), 
     WORKFLOW_NAME             VARCHAR(500), 
     WORKFLOW_STATUS           INT, 
     ARM_ADJUSTMENT_CONFIG_SID INT, 
     TRANSACTION_NAME          VARCHAR(50) 
  ) 

INSERT INTO #TEMP_PROJ_RES_BRAND  
            (BRAND_MASTER_SID, 
             BRAND_ID,
             ACCOUNT, 
             PERIOD_DATE, 
             RS_CATEGORY, 
             RS_TYPE, 
             REBATE_PROGRAM_TYPE, 
             DEBIT, 
             CREDIT,
             PROJECTION_MASTER_SID, 
             WORKFLOW_MASTER_SID, 
             WORKFLOW_ID,
             WORKFLOW_NAME,
             WORKFLOW_STATUS,
             ARM_ADJUSTMENT_CONFIG_SID,
             TRANSACTION_NAME) 

 SELECT IM.BRAND_MASTER_SID
      ,BM.BRAND_ID
	  ,AA.ACCOUNT
      ,P.PERIOD_DATE
      ,RS_CATEGORY
      ,RS_TYPE
      ,REBATE_PROGRAM_TYPE
	  ,CASE WHEN ISNULL(SUM(AA.DEBIT),0) -  ISNULL(SUM(AA.CREDIT),0) > 0 THEN ISNULL(SUM(AA.DEBIT),0) -  ISNULL(SUM(AA.CREDIT),0) 
	       			        ELSE 0 END AS DEBIT,
	   CASE WHEN ISNULL(SUM(AA.CREDIT),0) -  ISNULL(SUM(AA.DEBIT),0) > 0 THEN ISNULL(SUM(AA.CREDIT),0) -  ISNULL(SUM(AA.DEBIT),0)
				   ELSE 0 END  AS CREDIT
      ,A.PROJECTION_MASTER_SID
      ,WORKFLOW_MASTER_SID
      ,WORKFLOW_ID
      ,WM.WORKFLOW_DESCRPTION
      ,WM.WORKFLOW_STATUS_ID
      ,ARM_ADJUSTMENT_CONFIG_SID
      ,TRANSACTION_NAME
FROM   ARM_ADJUSTMENT_DETAILS A
  JOIN ? B ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID --DYNAMIC
  JOIN PERIOD P ON P.PERIOD_SID = B.PERIOD_SID
  JOIN ARM_ADJ_RES_CCP AAC ON A.ARM_ADJUSTMENT_DETAILS_SID=AAC.ARM_ADJUSTMENT_DETAILS_SID
  JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=AAC.ADJUSTMENT_LEVEL AND HT.DESCRIPTION='BRAND'
 LEFT JOIN ARM_ADJUSTMENTS AA 
              ON AA.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
			  AND AA.PERIOD_SID=B.PERIOD_SID
              AND  AA.ACCOUNT=AAC.ACCOUNT
			  AND AA.ADJUSTMENT_TYPE=AAC.ADJUSTMENT_TYPE
       LEFT JOIN WORKFLOW_MASTER WM 
              ON WM.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID 
       JOIN @TEMP T 
         ON T.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID 
       JOIN CCP_DETAILS C 
         ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID 
       JOIN ITEM_MASTER IM 
         ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID 
       JOIN BRAND_MASTER BM 
         ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
       JOIN RS_CONTRACT R 
         ON R.RS_MODEL_SID = A.RS_MODEL_SID 
            AND R.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID
            
	    JOIN dbo.ARM_DEDUCTION_SELECTION ADS ON ADS.RS_CONTRACT_SID = R.RS_CONTRACT_SID
      AND ADS.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID
WHERE  A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 
GROUP  BY IM.BRAND_MASTER_SID, 
          BM.BRAND_ID,
		  AA.ACCOUNT,
          P.PERIOD_DATE, 
          RS_CATEGORY, 
          RS_TYPE, 
          REBATE_PROGRAM_TYPE, 
          A.PROJECTION_MASTER_SID, 
          WORKFLOW_MASTER_SID, 
          WORKFLOW_ID, 
          WM.WORKFLOW_DESCRPTION, 
          WM.WORKFLOW_STATUS_ID, 
          ARM_ADJUSTMENT_CONFIG_SID, 
          TRANSACTION_NAME; 

IF OBJECT_ID('TEMPDB..#TEMP_PROJ_RES_TOTAL') IS NOT NULL 
  DROP TABLE #TEMP_PROJ_RES_TOTAL 

CREATE TABLE #TEMP_PROJ_RES_TOTAL 
  ( 
     BRAND_MASTER_SID          INT, 
     BRAND_ID                  VARCHAR(50),
	 ACCOUNT               VARCHAR(50), 
     PERIOD_DATE               DATETIME, 
     RS_CATEGORY               INT, 
     RS_TYPE                   INT, 
     REBATE_PROGRAM_TYPE       INT, 
     DEBIT                 NUMERIC(22, 6), 
     CREDIT                NUMERIC(22,6),
     PROJECTION_MASTER_SID     INT, 
     WORKFLOW_MASTER_SID       INT NULL, 
     WORKFLOW_ID               VARCHAR(50), 
     WORKFLOW_NAME             VARCHAR(500), 
     WORKFLOW_STATUS           INT, 
     ARM_ADJUSTMENT_CONFIG_SID INT, 
     TRANSACTION_NAME          VARCHAR(50) 
  ) 

INSERT INTO #TEMP_PROJ_RES_TOTAL  
            (BRAND_MASTER_SID, 
             BRAND_ID,
             ACCOUNT, 
             PERIOD_DATE, 
             RS_CATEGORY, 
             RS_TYPE, 
             REBATE_PROGRAM_TYPE, 
             DEBIT, 
             CREDIT,
             PROJECTION_MASTER_SID, 
             WORKFLOW_MASTER_SID, 
             WORKFLOW_ID,
             WORKFLOW_NAME,
             WORKFLOW_STATUS,
             ARM_ADJUSTMENT_CONFIG_SID,
             TRANSACTION_NAME) 

 SELECT IM.BRAND_MASTER_SID
      ,BM.BRAND_ID
	  ,AA.ACCOUNT
      ,P.PERIOD_DATE
      ,RS_CATEGORY
      ,RS_TYPE
      ,REBATE_PROGRAM_TYPE
	  ,CASE WHEN ISNULL(SUM(AA.DEBIT),0) -  ISNULL(SUM(AA.CREDIT),0) > 0 THEN ISNULL(SUM(AA.DEBIT),0) -  ISNULL(SUM(AA.CREDIT),0) 
	       			        ELSE 0 END AS DEBIT,
	   CASE WHEN ISNULL(SUM(AA.CREDIT),0) -  ISNULL(SUM(AA.DEBIT),0) > 0 THEN ISNULL(SUM(AA.CREDIT),0) -  ISNULL(SUM(AA.DEBIT),0)
				   ELSE 0 END  AS CREDIT
      ,A.PROJECTION_MASTER_SID
      ,WORKFLOW_MASTER_SID
      ,WORKFLOW_ID
      ,WM.WORKFLOW_DESCRPTION
      ,WM.WORKFLOW_STATUS_ID
      ,ARM_ADJUSTMENT_CONFIG_SID
      ,TRANSACTION_NAME
FROM   ARM_ADJUSTMENT_DETAILS A
  JOIN ? B ON A.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID --DYNAMIC
  JOIN PERIOD P ON P.PERIOD_SID = B.PERIOD_SID
  JOIN ARM_ADJ_RES_CCP AAC ON A.ARM_ADJUSTMENT_DETAILS_SID=AAC.ARM_ADJUSTMENT_DETAILS_SID
  JOIN HELPER_TABLE HT ON HT.HELPER_TABLE_SID=AAC.ADJUSTMENT_LEVEL AND HT.DESCRIPTION='TOTAL'
 LEFT JOIN ARM_ADJUSTMENTS AA 
              ON AA.ARM_ADJUSTMENT_DETAILS_SID = B.ARM_ADJUSTMENT_DETAILS_SID
			  AND AA.PERIOD_SID=B.PERIOD_SID
              AND  AA.ACCOUNT=AAC.ACCOUNT
			  AND AA.ADJUSTMENT_TYPE=AAC.ADJUSTMENT_TYPE
       LEFT JOIN WORKFLOW_MASTER WM 
              ON WM.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID 
       JOIN @TEMP T 
         ON T.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID 
       JOIN CCP_DETAILS C 
         ON C.CCP_DETAILS_SID = A.CCP_DETAILS_SID 
       JOIN ITEM_MASTER IM 
         ON IM.ITEM_MASTER_SID = C.ITEM_MASTER_SID 
       JOIN BRAND_MASTER BM 
         ON BM.BRAND_MASTER_SID = IM.BRAND_MASTER_SID 
       JOIN RS_CONTRACT R 
         ON R.RS_MODEL_SID = A.RS_MODEL_SID 
            AND R.CONTRACT_MASTER_SID = C.CONTRACT_MASTER_SID 
            
	    JOIN dbo.ARM_DEDUCTION_SELECTION ADS ON ADS.RS_CONTRACT_SID = R.RS_CONTRACT_SID
      AND ADS.PROJECTION_MASTER_SID = A.PROJECTION_MASTER_SID
WHERE  A.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID 
GROUP  BY IM.BRAND_MASTER_SID, 
          BM.BRAND_ID,
		  AA.ACCOUNT,
          P.PERIOD_DATE, 
          RS_CATEGORY, 
          RS_TYPE, 
          REBATE_PROGRAM_TYPE, 
          A.PROJECTION_MASTER_SID, 
          WORKFLOW_MASTER_SID, 
          WORKFLOW_ID, 
          WM.WORKFLOW_DESCRPTION, 
          WM.WORKFLOW_STATUS_ID, 
          ARM_ADJUSTMENT_CONFIG_SID, 
          TRANSACTION_NAME; 
IF OBJECT_ID ('TEMPDB..#CTE_BRAND') IS NOT NULL 
  DROP TABLE #CTE_BRAND 

SELECT * INTO #CTE_BRAND FROM (
      SELECT B.GL_IMPACT_DATE AS ACCOUNTING_DATE
              ,BU.COMPANY_ID AS BU_COMPANY_ID
              ,BU.COMPANY_NO AS BU_COMPANY_NO
              ,B.BU_COMPANY_MASTER_SID
              ,A.BRAND_ID
			  ,A.ACCOUNT
              ,A.PERIOD_DATE AS REDEMPTION_PERIOD
              ,GL.COMPANY_ID AS GL_COMPANY_ID
              ,GL.COMPANY_NO AS GL_COMPANY_NO
              ,ARM_ADJ_RES_CONFIG_MASTER_SID
			  ,A.DEBIT
			  ,A.CREDIT
              ,PM.PROJECTION_DESCRIPTION
              ,A.WORKFLOW_ID
              ,PERIOD_DATE AS REDEMPTION_DATE
              ,A.ARM_ADJUSTMENT_CONFIG_SID
              ,A.TRANSACTION_NAME
              ,A.WORKFLOW_NAME
              ,A.WORKFLOW_STATUS
              ,WM.CREATED_BY AS WORKFLOW_CREATED_BY
              ,WM.CREATED_DATE AS WORKFLOW_CREATED_DATE
              ,WM.APPROVED_BY AS WORKFLOW_APPROVED_BY
              ,WM.APPROVED_DATE AS WORKFLOW_APPROVED_DATE
			  ,AAM.RS_CATEGORY
			  ,AAM.RS_TYPE
			  ,AAM.REBATE_PROGRAM_TYPE
      FROM #TEMP_PROJ_RES_BRAND A
      JOIN ARM_ADJUSTMENT_MASTER B ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
      JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
      JOIN PROJECTION_MASTER PM ON PM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
      JOIN COMPANY_MASTER BU ON BU.COMPANY_MASTER_SID = B.BU_COMPANY_MASTER_SID
      JOIN COMPANY_MASTER GL ON GL.COMPANY_MASTER_SID = PM.COMPANY_MASTER_SID
      JOIN ARM_ADJ_RES_CONFIG_MASTER AAM ON AAM.RS_CATEGORY = A.RS_CATEGORY
              AND AAM.RS_TYPE = A.RS_TYPE
              AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE
              AND PM.COMPANY_MASTER_SID = AAM.GL_COMPANY_MASTER_SID
              AND B.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID
              AND AAM.CONFIGURATION_TYPE = 0
              AND (
                      GL.COMPANY_MASTER_SID = @GL_COMP
                      OR @GL_COMP IS NULL
                      )
      ) A

IF OBJECT_ID ('TEMPDB..#CTE_TOTAL') IS NOT NULL 
  DROP TABLE #CTE_TOTAL 

SELECT * INTO #CTE_TOTAL FROM (
      SELECT B.GL_IMPACT_DATE AS ACCOUNTING_DATE
              ,BU.COMPANY_ID AS BU_COMPANY_ID
              ,BU.COMPANY_NO AS BU_COMPANY_NO
              ,B.BU_COMPANY_MASTER_SID
              ,A.BRAND_ID
			  ,A.ACCOUNT
              ,A.PERIOD_DATE AS REDEMPTION_PERIOD
              ,GL.COMPANY_ID AS GL_COMPANY_ID
              ,GL.COMPANY_NO AS GL_COMPANY_NO
              ,ARM_ADJ_RES_CONFIG_MASTER_SID
			  ,A.DEBIT
			  ,A.CREDIT
              ,PM.PROJECTION_DESCRIPTION
              ,A.WORKFLOW_ID
              ,PERIOD_DATE AS REDEMPTION_DATE
              ,A.ARM_ADJUSTMENT_CONFIG_SID
              ,A.TRANSACTION_NAME
              ,A.WORKFLOW_NAME
              ,A.WORKFLOW_STATUS
              ,WM.CREATED_BY AS WORKFLOW_CREATED_BY
              ,WM.CREATED_DATE AS WORKFLOW_CREATED_DATE
              ,WM.APPROVED_BY AS WORKFLOW_APPROVED_BY
              ,WM.APPROVED_DATE AS WORKFLOW_APPROVED_DATE
			   ,AAM.RS_CATEGORY
			  ,AAM.RS_TYPE
			  ,AAM.REBATE_PROGRAM_TYPE
      FROM #TEMP_PROJ_RES_TOTAL A
      JOIN ARM_ADJUSTMENT_MASTER B ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
      JOIN WORKFLOW_MASTER WM ON WM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
      JOIN PROJECTION_MASTER PM ON PM.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
      JOIN COMPANY_MASTER BU ON BU.COMPANY_MASTER_SID = B.BU_COMPANY_MASTER_SID
      JOIN COMPANY_MASTER GL ON GL.COMPANY_MASTER_SID = PM.COMPANY_MASTER_SID
      JOIN ARM_ADJ_RES_CONFIG_MASTER AAM ON AAM.RS_CATEGORY = A.RS_CATEGORY
              AND AAM.RS_TYPE = A.RS_TYPE
              AND AAM.REBATE_PROGRAM_TYPE = A.REBATE_PROGRAM_TYPE
              AND PM.COMPANY_MASTER_SID = AAM.GL_COMPANY_MASTER_SID
              AND B.BU_COMPANY_MASTER_SID = AAM.BU_COMPANY_MASTER_SID
              AND AAM.CONFIGURATION_TYPE = 0
              AND (
                      GL.COMPANY_MASTER_SID = @GL_COMP
                      OR @GL_COMP IS NULL
                      )
      ) A

INSERT INTO ADJUSTMENT_RESERVE_DETAIL 
            (WORKFLOW_ID, 
             WORKFLOW_NAME, 
             COMPANY, 
             DIVISION, 
             BUSINESS_UNIT, 
             JOURNAL_NAME, 
             JOURNAL_DESCRIPTION, 
             BRAND, 
             DEBIT, 
             CREDIT, 
             CURRENCY, 
             ACCOUNTING_DATE, 
             REDEMPTION_PERIOD, 
             CALCULATION_PERIOD, 
             CATEGORY, 
             BALANCE_TYPE, 
             ARD_DB, 
             DATA_ACCESS_SET, 
             CHART_OF_ACCOUNTS, 
             LEDGER, 
             REVERSE_JOURNAL, 
             REVERSAL_PERIOD_DATE, 
             LINE_DESCRIPTION, 
             ACCOUNT_CATEGORY, 
             ACCOUNT_TYPE, 
             ADJUSTMENT_TYPE, 
             ADJUSTMENT_LEVEL, 
             ACCOUNT, 
             COST_CENTER, 
             PROJECT, 
             FUTURE_1, 
             FUTURE_2, 
             UDC_1, 
             UDC_2, 
             UDC_3, 
             UDC_4, 
             UDC_5, 
             UDC_6, 
             WORKFLOW_CREATED_BY, 
             WORKFLOW_CREATED_DATE, 
             WORKFLOW_APPROVED_BY, 
             WORKFLOW_APPROVED_DATE, 
             SOURCE, 
             BATCH_NAME
			   ,RS_CATEGORY
	  ,RS_TYPE
	  ,REBATE_PROGRAM_TYPE
	  ,ACCOUNT_INDICATOR
      ,ACCOUNT_DESCRIPTION) 
SELECT A.WORKFLOW_ID, 
       A.WORKFLOW_NAME, 
       A.GL_COMPANY_ID          AS GL_COMPANY_ID, 
       ARC.DIVISION             AS DIVISION, 
       A.BU_COMPANY_ID          AS BU, 
       AAD.JOURNAL_NAME         AS JOURNAL_NAME, 
       AAD.JOURNAL_DESCRIPTION  AS JOURNAL_DESCRIPTION, 
       A.BRAND_ID               AS BRAND_ID, 
       CASE WHEN A.DEBIT = 0 THEN NULL ELSE A.DEBIT END AS DEBIT,
       CASE WHEN A.CREDIT = 0 THEN NULL ELSE A.CREDIT END AS CREDIT,
       AAD.CURRENCY             AS CURRENCY, 
       A.ACCOUNTING_DATE        AS ACCOUNTING_DATE, 
       CASE 
         WHEN AAC.REDEMPTION_PERIOD = 1 THEN A.REDEMPTION_DATE 
         ELSE NULL 
       END, 
       A.REDEMPTION_DATE        AS CALCULATION_PERIOD, 
       AAD.CATEGORY             AS CATEGORY, 
       AAD.BALANCE_TYPE         AS BALANCE_TYPE, 
       AAD."DATABASE"           AS DATABASE_DESC, 
       AAD.DATA_ACCESS_SET      AS DATA_ACCESS_SET, 
       AAD.CHART_OF_ACCOUNTS    AS CHART_OF_ACCOUNTS, 
       AAD.LEDGER               AS LEDGER, 
       AAD.REVERSE_JOURNAL      AS REVERSE_JOURNAL, 
       AAD.REVERSAL_PERIOD_DATE AS REVERSAL_PERIOD_DATE, 
       AAD.LINE_DESCRIPTION     AS LINE_DESCRIPTION, 
       AAD.ACCOUNT_CATEGORY     AS ACCOUNT_CATEGORY, 
       AAD.ACCOUNT_TYPE         AS ACCOUNT_TYPE, 
       AAD.ADJUSTMENT_TYPE, 
       AAD.ADJUSTMENT_LEVEL, 
       AAD.ACCOUNT              AS ACCOUNT, 
       AAD.COST_CENTER          AS COST_CENTER, 
       AAD.PROJECT              AS PROJECT, 
       AAD.FUTURE_1             AS FUTURE_1, 
       AAD.FUTURE_2             AS FUTURE_2, 
       AAD.UDC_1                AS UDC_1, 
       AAD.UDC_2                AS UDC_2, 
       AAD.UDC_3                AS UDC_3, 
       AAD.UDC_4                AS UDC_4, 
       AAD.UDC_5                AS UDC_5, 
       AAD.UDC_6                AS UDC_6, 
       A.WORKFLOW_CREATED_BY, 
       A.WORKFLOW_CREATED_DATE, 
       A.WORKFLOW_APPROVED_BY, 
       A.WORKFLOW_APPROVED_DATE, 
       AAD."SOURCE"             AS SOURCE_DESC, 
       BATCH_NAME = CASE 
                      WHEN A.WORKFLOW_ID IS NULL THEN '' 
                      ELSE CONVERT(VARCHAR(100), A.TRANSACTION_NAME) 
                           + ' - ' + ISNULL(A.WORKFLOW_ID, ' ') + ' - ' 
                           + AAD.JOURNAL_DESCRIPTION 
                    END 
					 , A.RS_CATEGORY
			  ,A.RS_TYPE
			  ,A.REBATE_PROGRAM_TYPE
			  ,AAD.ACCOUNT_INDICATOR AS ACCOUNT_INDICATOR
              ,AAD.ACCOUNT_DESC AS ACCOUNT_DESCRIPTION
FROM   #CTE_BRAND A 
       JOIN ARM_ADJ_RES_CONFIG_DETAIL ARC 
         ON ARC.ARM_ADJ_RES_CONFIG_MASTER_SID = A.ARM_ADJ_RES_CONFIG_MASTER_SID
		 AND A.ARM_ADJUSTMENT_CONFIG_SID=ARC.ADJUSTMENT_TYPE AND A.ACCOUNT=ARC.ACCOUNT 
       INNER JOIN #ARM_ADJ_RES_CCP AAD 
               ON ARC.ARM_ADJ_RES_CONFIG_MASTER_SID = AAD.ARM_ADJ_RES_CONFIG_MASTER_SID 
                  AND ARC.ADJUSTMENT_TYPE = AAD.ADJUSTMENT_TYPE 
                  
                  AND ARC.ACCOUNT = AAD.ACCOUNT 
                  AND ARC.ADJUSTMENT_LEVEL = AAD.ADJUSTMENT_LEVEL 
                  AND A.BRAND_ID = AAD.BRAND_ID 
                  AND A.ARM_ADJUSTMENT_CONFIG_SID = AAD.ADJUSTMENT_TYPE 
       JOIN ARM_ADJUSTMENT_CONFIG AAC 
         ON AAC.ARM_ADJUSTMENT_CONFIG_SID = AAD.ADJUSTMENT_TYPE 
       JOIN HELPER_TABLE HT 
         ON HT.HELPER_TABLE_SID = AAD.ACCOUNT_TYPE 
       JOIN HELPER_TABLE HT1 
         ON HT1.HELPER_TABLE_SID = AAD.ADJUSTMENT_LEVEL 
            AND HT1.DESCRIPTION = 'BRAND' 
WHERE  AAD.ADJUSTMENT_TYPE = ?
AND (A.DEBIT<>0 OR A.CREDIT<>0)
UNION ALL 
SELECT A.WORKFLOW_ID, 
       A.WORKFLOW_NAME, 
       A.GL_COMPANY_ID          AS GL_COMPANY_ID, 
       ARC.DIVISION             AS DIVISION, 
       A.BU_COMPANY_ID          AS BU, 
       AAD.JOURNAL_NAME         AS JOURNAL_NAME, 
       AAD.JOURNAL_DESCRIPTION  AS JOURNAL_DESCRIPTION, 
       '000'                    AS BRAND_ID, 
       CASE WHEN A.DEBIT = 0 THEN NULL ELSE A.DEBIT END AS DEBIT,
       CASE WHEN A.CREDIT = 0 THEN NULL ELSE A.CREDIT END AS CREDIT,
       AAD.CURRENCY             AS CURRENCY, 
       A.ACCOUNTING_DATE        AS ACCOUNTING_DATE, 
       CASE 
         WHEN AAC.REDEMPTION_PERIOD = 1 THEN A.REDEMPTION_DATE 
         ELSE NULL 
       END, 
       A.REDEMPTION_DATE        AS CALCULATION_PERIOD, 
       AAD.CATEGORY             AS CATEGORY, 
       AAD.BALANCE_TYPE         AS BALANCE_TYPE, 
       AAD."DATABASE"           AS DATABASE_DESC, 
       AAD.DATA_ACCESS_SET      AS DATA_ACCESS_SET, 
       AAD.CHART_OF_ACCOUNTS    AS CHART_OF_ACCOUNTS, 
       AAD.LEDGER               AS LEDGER, 
       AAD.REVERSE_JOURNAL      AS REVERSE_JOURNAL, 
       AAD.REVERSAL_PERIOD_DATE AS REVERSAL_PERIOD_DATE, 
       AAD.LINE_DESCRIPTION     AS LINE_DESCRIPTION, 
       AAD.ACCOUNT_CATEGORY     AS ACCOUNT_CATEGORY, 
       AAD.ACCOUNT_TYPE         AS ACCOUNT_TYPE, 
       AAD.ADJUSTMENT_TYPE, 
       AAD.ADJUSTMENT_LEVEL, 
       AAD.ACCOUNT              AS ACCOUNT, 
       AAD.COST_CENTER          AS COST_CENTER, 
       AAD.PROJECT              AS PROJECT, 
       AAD.FUTURE_1             AS FUTURE_1, 
       AAD.FUTURE_2             AS FUTURE_2, 
       AAD.UDC_1                AS UDC_1, 
       AAD.UDC_2                AS UDC_2, 
       AAD.UDC_3                AS UDC_3, 
       AAD.UDC_4                AS UDC_4, 
       AAD.UDC_5                AS UDC_5, 
       AAD.UDC_6                AS UDC_6, 
       A.WORKFLOW_CREATED_BY, 
       A.WORKFLOW_CREATED_DATE, 
       A.WORKFLOW_APPROVED_BY, 
       A.WORKFLOW_APPROVED_DATE, 
       AAD."SOURCE"             AS SOURCE_DESC, 
       BATCH_NAME = CASE 
                      WHEN A.WORKFLOW_ID IS NULL THEN '' 
                      ELSE CONVERT(VARCHAR(100), A.TRANSACTION_NAME) 
                           + ' - ' + ISNULL(A.WORKFLOW_ID, ' ') + ' - ' 
                           + AAD.JOURNAL_DESCRIPTION 
                    END 
					 , A.RS_CATEGORY
			  ,A.RS_TYPE
			  ,A.REBATE_PROGRAM_TYPE
			  ,AAD.ACCOUNT_INDICATOR AS ACCOUNT_INDICATOR
              ,AAD.ACCOUNT_DESC AS ACCOUNT_DESCRIPTION
FROM   (SELECT ARM_ADJ_RES_CONFIG_MASTER_SID, 
               GL_COMPANY_ID, 
               GL_COMPANY_NO, 
               BU_COMPANY_ID, 
               BU_COMPANY_NO, 
               BU_COMPANY_MASTER_SID, 
               ACCOUNTING_DATE, 
               PROJECTION_DESCRIPTION, 
               SUM(DEBIT) AS DEBIT,
			   SUM(CREDIT) AS CREDIT,
               REDEMPTION_DATE, 
               ARM_ADJUSTMENT_CONFIG_SID, 
               TRANSACTION_NAME, 
               WORKFLOW_ID, 
               WORKFLOW_NAME, 
               WORKFLOW_STATUS, 
               WORKFLOW_CREATED_BY, 
               WORKFLOW_CREATED_DATE, 
               WORKFLOW_APPROVED_BY, 
               WORKFLOW_APPROVED_DATE 
                ,ACCOUNT
			   ,RS_CATEGORY
			  ,RS_TYPE
			  ,REBATE_PROGRAM_TYPE
        FROM   #CTE_TOTAL 
        GROUP  BY ARM_ADJ_RES_CONFIG_MASTER_SID, 
                  GL_COMPANY_ID, 
                  GL_COMPANY_NO, 
                  BU_COMPANY_ID, 
                  BU_COMPANY_NO, 
                  BU_COMPANY_MASTER_SID, 
                  ACCOUNTING_DATE, 
                  PROJECTION_DESCRIPTION, 
                  REDEMPTION_DATE, 
                  ARM_ADJUSTMENT_CONFIG_SID, 
                  TRANSACTION_NAME, 
                  WORKFLOW_ID, 
                  WORKFLOW_NAME, 
                  WORKFLOW_STATUS, 
                  WORKFLOW_CREATED_BY, 
                  WORKFLOW_CREATED_DATE, 
                  WORKFLOW_APPROVED_BY, 
                  WORKFLOW_APPROVED_DATE
                   ,ACCOUNT
				   ,RS_CATEGORY
			  ,RS_TYPE
			  ,REBATE_PROGRAM_TYPE) A 
       JOIN ARM_ADJ_RES_CONFIG_DETAIL ARC 
         ON ARC.ARM_ADJ_RES_CONFIG_MASTER_SID = A.ARM_ADJ_RES_CONFIG_MASTER_SID 
       INNER JOIN (SELECT *
                       --   ROW_NUMBER() 
                         --   OVER( 
                          --    PARTITION BY ADJUSTMENT_TYPE, ACCOUNT
                            --  ORDER BY ARM_ADJ_RES_CONFIG_MASTER_SID ) AS RN 
                   FROM   #ARM_ADJ_RES_CCP AAD1 
                          JOIN HELPER_TABLE HT1 
                            ON HT1.HELPER_TABLE_SID = AAD1.ADJUSTMENT_LEVEL 
                               AND HT1.DESCRIPTION = 'TOTAL') AAD 
               ON ARC.ARM_ADJ_RES_CONFIG_MASTER_SID = A.ARM_ADJ_RES_CONFIG_MASTER_SID 
               AND ARC.ARM_ADJ_RES_CONFIG_MASTER_SID = AAD.ARM_ADJ_RES_CONFIG_MASTER_SID
                  AND ARC.ADJUSTMENT_TYPE = AAD.ADJUSTMENT_TYPE 
                 
                  AND ARC.ACCOUNT = AAD.ACCOUNT
                    AND ARC.ACCOUNT=A.ACCOUNT
	  AND ARC.ADJUSTMENT_TYPE=A.ARM_ADJUSTMENT_CONFIG_SID
                  AND ARC.ADJUSTMENT_LEVEL = AAD.ADJUSTMENT_LEVEL 
                  AND A.ARM_ADJUSTMENT_CONFIG_SID = AAD.ADJUSTMENT_TYPE
       JOIN ARM_ADJUSTMENT_CONFIG AAC 
         ON AAC.ARM_ADJUSTMENT_CONFIG_SID = AAD.ADJUSTMENT_TYPE 
            AND AAD.ADJUSTMENT_TYPE = ?
       JOIN HELPER_TABLE HT 
         ON HT.HELPER_TABLE_SID = AAD.ACCOUNT_TYPE 
         AND (A.DEBIT<>0 OR A.CREDIT<>0)
--WHERE  AAD.RN = 1 
         ]]>  
        </query>
             
    </entity>  
</sql>