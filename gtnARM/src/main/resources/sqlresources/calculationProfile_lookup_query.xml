<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->


<sql>
   
    <entity id="getCProfileCalculationData">
        <query> 
            <![CDATA[
            SELECT
              'Actual Payments' AS TRANSACTION_NAME,
              -1 AS ARM_ADJUSTMENT_CONFIG_SID,
              'TRANSACTION 8' AS DESCRIPTION
               UNION
            SELECT
              ADJ.TRANSACTION_NAME,
              ADJ.ARM_ADJUSTMENT_CONFIG_SID,
              HT.DESCRIPTION
            FROM ARM_ADJUSTMENT_CONFIG ADJ
            JOIN HELPER_TABLE HT
              ON HT.HELPER_TABLE_SID = ADJ.METHODOLGY
            ORDER BY DESCRIPTION

                    ]]>    
        </query>
    </entity>
    
    
     <entity id="saveCProfileCalculationMaster">
        <query> 
            <![CDATA[
            DECLARE @id INT
           INSERT INTO CALCULATION_PROFILE_MASTER 
            (PROFILE_NAME, PROFILE_DESCRIPTION, SAVE_FLAG, CREATED_BY, CREATED_DATE, MODIFIED_BY, MODIFIED_DATE)
            VALUES 
            ( '@PROFILE_NAME','@PROFILE_DESCRIPTION',@SAVE_FLAG,@CREATED_BY,CURRENT_TIMESTAMP,@MODIFIED_BY,CURRENT_TIMESTAMP )
            
            SET @id = SCOPE_IDENTITY()
                        
            
                    ]]>    
        </query>
    </entity>
    <entity id="getCProfileCalculationDetailsInsert">
        <query> 
            <![CDATA[
                       
            INSERT INTO CALCULATION_PROFILE_DETAILS 
            (CALCULATION_PROFILE_MASTER_SID, ADJUSTMENT_TYPE, ACCOUNT_TYPE, INCLUDE, "INDICATOR", PRIORITY) 
	    VALUES @DETAILS_INPUT
            
            
                    ]]>    
        </query>
    </entity>
     <entity id="saveCProfileCalculationView">
        <query> 
            <![CDATA[
          INSERT INTO CALCULATION_PROFILE_VIEW_MASTER 
            (CALCULATION_PROFILE_MASTER_SID, VIEW_NAME, VIEW_TYPE, CREATED_BY, CREATED_DATE, MODIFIED_BY, MODIFIED_DATE) 
                VALUES (@id, '@VIEW_NAME', '@VIEW_TYPE', @CREATED_BY, CURRENT_TIMESTAMP, @MODIFIED_BY, CURRENT_TIMESTAMP)
            
                    ]]>    
        </query>
    </entity>
    <entity id="searchCalculationProfileCount">
        <query> 
            <![CDATA[
      
            SELECT COUNT(*) FROM CALCULATION_PROFILE_MASTER WHERE SAVE_FLAG = 1 
            
                    ]]>    
        </query>
    </entity>

    <entity id="searchCalculationProfileData">
        <query> 
            <![CDATA[
       
             SELECT CALCULATION_PROFILE_MASTER_SID,PROFILE_NAME,PROFILE_DESCRIPTION FROM CALCULATION_PROFILE_MASTER WHERE SAVE_FLAG = 1 

                    ]]>    
        </query>
    </entity>
    <entity id="retrievceCalculationProfileData">
        <query> 
            <![CDATA[
       
            SELECT
            ADJ.TRANSACTION_NAME AS PROFILE_ADJUSTMENT_TYPE, CPD.ACCOUNT_TYPE, CPD.INCLUDE, CPD."INDICATOR", CPD.PRIORITY , CPD.ADJUSTMENT_TYPE

            FROM CALCULATION_PROFILE_DETAILS CPD
                         JOIN ARM_ADJUSTMENT_CONFIG ADJ
                           ON ADJ.ARM_ADJUSTMENT_CONFIG_SID = CPD.ADJUSTMENT_TYPE

             WHERE CPD.CALCULATION_PROFILE_MASTER_SID = @CALCULATION_PROFILE_ID
             UNION  

              SELECT
                           TRANSACTION_NAME AS PROFILE_ADJUSTMENT_TYPE,
             0 AS ACCOUNT_TYPE,
             0 AS INCLUDE,
             0 AS "INDICATOR",
                          (SELECT COUNT (*) FROM ARM_ADJUSTMENT_CONFIG) AS PRIORITY,
                          ARM_ADJUSTMENT_CONFIG_SID AS ADJUSTMENT_TYPE

                         FROM ARM_ADJUSTMENT_CONFIG
                          WHERE ARM_ADJUSTMENT_CONFIG_SID NOT IN ( SELECT ADJUSTMENT_TYPE FROM CALCULATION_PROFILE_DETAILS WHERE CALCULATION_PROFILE_MASTER_SID = @CALCULATION_PROFILE_ID )

            UNION
              SELECT 
              'Actual Payments' AS PROFILE_ADJUSTMENT_TYPE, CPD.ACCOUNT_TYPE, CPD.INCLUDE, CPD."INDICATOR", CPD.PRIORITY , CPD.ADJUSTMENT_TYPE

             FROM CALCULATION_PROFILE_DETAILS CPD


             WHERE CPD.CALCULATION_PROFILE_MASTER_SID = @CALCULATION_PROFILE_ID AND CPD.ADJUSTMENT_TYPE = -1


             UNION
               SELECT distinct 
               'Actual Payments' AS PROFILE_ADJUSTMENT_TYPE, 0 AS ACCOUNT_TYPE,
              0 AS INCLUDE,
              0 AS "INDICATOR",
                           (SELECT COUNT (*) FROM ARM_ADJUSTMENT_CONFIG)+1 AS PRIORITY,
                           -1 AS ADJUSTMENT_TYPE

              FROM CALCULATION_PROFILE_DETAILS CPD

              WHERE  NOT EXISTS (select 1 from CALCULATION_PROFILE_DETAILS WHERE CALCULATION_PROFILE_MASTER_SID = @CALCULATION_PROFILE_ID AND ADJUSTMENT_TYPE = -1)  

            ORDER BY PRIORITY ASC
       
                    ]]>    
        </query>
    </entity>
    
    
      <entity id="calculationProfileDuplicateViewCheck">
        <query> 
            <![CDATA[
                SELECT
                    VIEW_NAME
                FROM
                    CALCULATION_PROFILE_VIEW_MASTER
                WHERE
                    VIEW_NAME = '$$$VN$$$'
            ]]>    
        </query>
    </entity>
      <entity id="calculationProfileDuplicateCheck">
        <query> 
            <![CDATA[
                SELECT
                    CALCULATION_PROFILE_MASTER_SID
                FROM
                    CALCULATION_PROFILE_MASTER
                WHERE
                    PROFILE_NAME = '$$$VN$$$' AND SAVE_FLAG = 1 
            ]]>    
        </query>
    </entity>
      <entity id="updateCalculationViewQuery">
        <query> 
            <![CDATA[
                UPDATE CALCULATION_PROFILE_VIEW_MASTER
                    SET  MODIFIED_BY=@MODIFIED_BY, MODIFIED_DATE =CURRENT_TIMESTAMP                
                WHERE CALCULATION_PROFILE_MASTER_SID = @id
            ]]>    
        </query>
    </entity>
      <entity id="deleteCalculationDetailsQuery">
        <query> 
            <![CDATA[
               DELETE FROM CALCULATION_PROFILE_DETAILS
                WHERE CALCULATION_PROFILE_MASTER_SID = @id
            ]]>    
        </query>
    </entity>
      <entity id="getProfileNameandDesc">
        <query> 
            <![CDATA[
                    SELECT
                         PROFILE_NAME,
                         PROFILE_DESCRIPTION
                     FROM
                         CALCULATION_PROFILE_MASTER
                     WHERE
                         CALCULATION_PROFILE_MASTER_SID = ?
            ]]>    
        </query>
    </entity>
    
    <entity id="getSummaryTableIdenticalRows">
        <query> 
            <![CDATA[
                    DECLARE @COUNTHASH INT,
                      @COUNTTEMP       INT,
                      @COUNTTABLE      INT,
                      @CALCULATION_PROFILE_MASTER_SID INT = $CALCULATION_PROFILE_MASTER_SID
                    IF OBJECT_ID('TEMPDB..#TEMP_CPD') IS NOT NULL
                            DROP TABLE #TEMP_CPD
                    CREATE TABLE #TEMP_CPD
                                 (
                                              PROFILE_ADJUSTMENT_TYPE VARCHAR(50),
                                              ACCOUNT_TYPE            INT,
                                              INCLUDE                 INT,
                                              INDICATOR               BIT,
                                              ADJUSTMENT_TYPE         INT
                                 )
                    INSERT INTO #TEMP_CPD
                                (
                                            PROFILE_ADJUSTMENT_TYPE,
                                            ACCOUNT_TYPE,
                                            INCLUDE,
                                            INDICATOR,
                                            ADJUSTMENT_TYPE
                                )
                                VALUES 
                                @PARAMETERS

                    SET @COUNTHASH =(SELECT COUNT(CPD.ACCOUNT_TYPE)
                           FROM   CALCULATION_PROFILE_DETAILS CPD
                           JOIN   ARM_ADJUSTMENT_CONFIG ADJ
                           ON     ADJ.ARM_ADJUSTMENT_CONFIG_SID = CPD.ADJUSTMENT_TYPE
                           WHERE  CPD.CALCULATION_PROFILE_MASTER_SID = @CALCULATION_PROFILE_MASTER_SID
                    )
                    SET @COUNTTEMP =(SELECT COUNT(*) FROM   #TEMP_CPD)
                    IF @COUNTHASH != @COUNTTEMP
                    SELECT 1
                    ;WITH CTE AS
                    (
                           SELECT *
                           FROM   #TEMP_CPD
                           EXCEPT
                           SELECT ADJ.TRANSACTION_NAME AS PROFILE_ADJUSTMENT_TYPE,
                                  CPD.ACCOUNT_TYPE,
                                  CPD.INCLUDE,
                                  CPD."INDICATOR",
                                  CPD.ADJUSTMENT_TYPE
                           FROM   CALCULATION_PROFILE_DETAILS CPD
                           JOIN   ARM_ADJUSTMENT_CONFIG ADJ
                           ON     ADJ.ARM_ADJUSTMENT_CONFIG_SID = CPD.ADJUSTMENT_TYPE
                           WHERE  CPD.CALCULATION_PROFILE_MASTER_SID = @CALCULATION_PROFILE_MASTER_SID )
                    SELECT COUNT(*)
                    FROM   CTE

            ]]>    
        </query>
    </entity>
     
</sql>
