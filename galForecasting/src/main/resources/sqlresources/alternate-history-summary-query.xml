<?xml version="1.0" encoding="UTF-8"?>

<sql>
        
    <entity id="alternate-histroy-sales-summary">
        <query> 
            <![CDATA[  
                SELECT MAINQ.account_growth,
                               MAINQ.product_growth,
                               MAINQ.projection_sales,
                               MAINQ.projection_units,
                               MAINQ.actualsales,
                               MAINQ.actualunits,
                               MAINQ.level_no,
                               MAINQ.rlv,
                               MAINQ.YEARS,
                               MAINQ.PERIODS,
                               MAINQ.calculation_periods,
                               MAINQ.methodology,
                               MAINQ.relationship_level_sid,
                               MAINQ.hierarchy_no,
                               MAINQ.rcount,
                               MAINQ.level_name,
                               MAINQ.actualproj,
                               MAINQ.historysales,
                               MAINQ.historyunits,
                               MAINQ.checkrec,
                               MAINQ.uncheck_count,
                               MAINQ.ccpcount,
                               MAINQ.hierarchy_indicator,
                               MAINQ.user_group
                FROM   (SELECT Q.account_growth,
                               Q.product_growth,
                               Q.projection_sales,
                               Q.projection_units,
                               Q.actualsales,
                               Q.actualunits,
                               Q.level_no,
                               Q.rlv,
                               Q.YEARS,
                               Q.PERIODS,
                               Q.calculation_periods,
                               Q.methodology,
                               Q.relationship_level_sid,
                               Q.hierarchy_no,
                               Q.rcount,
                               Q.level_name,
                               Q.actualproj,
                               Q.historysales,
                               Q.historyunits,
                               Q.checkrec,
                               Q.uncheck_count,
                               Q.ccpcount,
                               Q.hierarchy_indicator,
                               Q.user_group,
                               Dense_rank()
                                 OVER (
                                   ORDER BY Q.rlv ASC) AS TEMP_INDEX
                        FROM   (SELECT 
                                   0.0                                    AS ACCOUNT_GROWTH,
                                   0.0                                    AS PRODUCT_GROWTH,
                                   NULL                                   AS PROJECTION_SALES,
                                   NULL                                   AS PROJECTION_UNITS,
                                   NULL                                   AS actualSales,
                                   Sum(SAHL.ACTUAL_UNITS)                 AS actualUnits,
                                   Max(RLD.LEVEL_NO)                      AS level_no,
                                   RLD.RELATIONSHIP_LEVEL_VALUES          AS rlv,
                                   p."YEAR"                               AS YEARS,
                                  @FREQUENCY@                              AS PERIODS,
                                   '-'                                    AS CALCULATION_PERIODS,
                                   '-'                                    AS METHODOLOGY,
                                   RLD.RELATIONSHIP_LEVEL_SID,
                                   CCP.HIERARCHY_NO,
                                   Count(*)                               AS RCOUNT,
                                   HLD.LEVEL_NAME,
                                   1                                      AS actualProj,
                                   NULL                                   AS historySales,
                                   Sum(SAHL.PROJECTION_UNITS)             AS historyUnits,
                                   1                                      AS checkrec,
                                   1                                      AS UNCHECK_COUNT,
                                   1                                      AS CCPCOUNT,
                                   '@HIERARCHY_INDICATOR' AS HIERARCHY_INDICATOR,
                                   '0' AS USER_GROUP
                            FROM   
                                ST_ALTERNATE_HIST_ALLOCATION SAHL
                                JOIN PROJECTION_DETAILS PD
                                  ON SAHL.PROJECTION_DETAILS_SID = PD.PROJECTION_DETAILS_SID
                            JOIN @CCP CCP
                              ON PD.CCP_DETAILS_SID = CCP.CCP_DETAILS_SID
                            JOIN RELATIONSHIP_LEVEL_DEFINITION RLD
                              ON CCP.RELATIONSHIP_LEVEL_SID = RLD.RELATIONSHIP_LEVEL_SID                       
                            JOIN HIERARCHY_LEVEL_DEFINITION HLD
                              ON HLD.HIERARCHY_LEVEL_DEFINITION_SID = RLD.HIERARCHY_LEVEL_DEFINITION_SID					 
                            JOIN PERIOD P
                              ON P.PERIOD_SID = SAHL.PERIOD_SID 
                            WHERE
                                PD.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
                                AND SAHL.USER_ID = @USER_ID
                                AND SAHL.SESSION_ID = @SESSION_ID                            
                            GROUP BY
                                RLD.RELATIONSHIP_LEVEL_VALUES,
                                @FREQUENCY_GROUP@,
                                RLD.RELATIONSHIP_LEVEL_SID,
                                RLD.LEVEL_NO,
                                p."YEAR",
                                RLD.RELATIONSHIP_LEVEL_SID,
                                CCP.HIERARCHY_NO,
                                HLD.LEVEL_NAME                            
                           ) Q) MAINQ
                            WHERE  MAINQ.TEMP_INDEX > @START
                                   AND MAINQ.TEMP_INDEX <= ( @START+@END )
                            ORDER  BY MAINQ.RLV; 
            ]]>
        </query>
    </entity>    
    
</sql>