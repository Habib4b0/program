<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<sql>
    <entity id="getDeleteQuery">
        <query> 
            <![CDATA[
                DECLARE @PROJECTION AS TABLE 
  ( 
     ID                     INT IDENTITY (1, 1), 
     PROJECTION_MASTER_SID  INT, 
     PROJECTION_DETAILS_SID INT 
  ) 
INSERT INTO @PROJECTION  
            (PROJECTION_MASTER_SID, 
             PROJECTION_DETAILS_SID) 
SELECT A.PROJECTION_MASTER_SID, 
       B.PROJECTION_DETAILS_SID 
FROM   PROJECTION_MASTER A 
JOIN   PROJECTION_DETAILS B ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID 
WHERE  SAVE_FLAG = 'false' 
       AND FORECASTING_TYPE = '@FORCASTING_TYPE' 
       AND CREATED_DATE < Getdate() - 1; 
            ]]>
        </query>
    </entity>
    
    <entity id="getDeleteQueryReturns">
        <query> 
                    <![CDATA[
                        DECLARE @PROJECTION AS TABLE 
          ( 
             ID                     INT IDENTITY (1, 1), 
             PROJECTION_MASTER_SID  INT, 
             RETURNS_DETAILS_SID INT 
          ) 
            INSERT INTO @PROJECTION  
                        (PROJECTION_MASTER_SID, 
                         RETURNS_DETAILS_SID) 
            SELECT A.PROJECTION_MASTER_SID,
                   B.RETURNS_DETAILS_SID
            FROM   PROJECTION_MASTER A
            JOIN  RETURNS_DETAILS  B ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
            WHERE  SAVE_FLAG = 'false'
                   AND FORECASTING_TYPE = 'Returns'
                   AND CREATED_DATE < Getdate() - 1;
                        ]]>
        </query>
    </entity>
    
    <entity id="deleteReturnsDetail">
        <query> 
                    <![CDATA[
                        DELETE FROM dbo.RETURNS_DETAILS WHERE PROJECTION_MASTER_SID = @PROJECTIONSID;
                    ]]>
        </query>
    </entity>
    
    <entity id="deleteReturnsMap">
        <query> 
                    <![CDATA[
                        DELETE FROM dbo.RETURNS_MAP WHERE PROJECTION_MASTER_SID = @PROJECTIONSID;
                    ]]>
        </query>
    </entity>
    
    <entity id="getDeleteQueryAccural">
        <query> 
                    <![CDATA[
                        DECLARE @PROJECTION AS TABLE 
          ( 
             ID                     INT IDENTITY (1, 1), 
             PROJECTION_MASTER_SID  INT, 
             ACCRUAL_PROJ_DETAILS_SID INT 
          ) 
            INSERT INTO @PROJECTION  
                        (PROJECTION_MASTER_SID, 
                         ACCRUAL_PROJ_DETAILS_SID) 
            SELECT A.PROJECTION_MASTER_SID,
                   B.RETURNS_DETAILS_SID
            FROM   PROJECTION_MASTER A
            JOIN  RETURNS_DETAILS  B ON A.PROJECTION_MASTER_SID = B.PROJECTION_MASTER_SID
            WHERE  SAVE_FLAG = 'false'
                   AND FORECASTING_TYPE = 'AccrualRateProjection'
                   AND CREATED_DATE < Getdate() - 1;
                        ]]>
        </query>
    </entity>
   
    <entity id="getforecastDeleteProjectionQuery">
        <query> 
            <![CDATA[
        DELETE A FROM @TABLE_NAME A JOIN (SELECT DISTINCT PROJECTION_MASTER_SID FROM @PROJECTION)B ON A.PROJECTION_MASTER_SID=B.PROJECTION_MASTER_SID
         ]]>
        </query>
    </entity>
    
    <entity id="getforecastDeleteDetailsQuery">
        <query> 
            <![CDATA[
            DELETE T FROM @TABLE_NAME T JOIN @PROJECTION A ON A.PROJECTION_DETAILS_SID = T.PROJECTION_DETAILS_SID 
           ]]>
        </query> 
    </entity>
    
    <entity id="getforecastDeleteDetailsQueryAccural">
        <query> 
            <![CDATA[
            DELETE T FROM @TABLE_NAME T JOIN @PROJECTION A ON A.ACCRUAL_PROJ_DETAILS_SID = T.ACCRUAL_PROJ_DETAILS_SID 
           ]]>
        </query> 
    </entity>
    
    <entity id="getforecastDeleteDetailsQueryReturns">
        <query> 
            <![CDATA[
            DELETE T FROM @TABLE_NAME T JOIN @PROJECTION A ON A.RETURNS_DETAILS_SID = T.RETURNS_DETAILS_SID 
           ]]>
        </query> 
    </entity>
    
    <entity id="getProjectionDetailsQuery">
        <query>   
            <![CDATA[ 
            SELECT DISTINCT PD.projection_details_sid
FROM   projection_details PD,
       (SELECT CCPMAP.ccp_details_sid
        FROM   (SELECT RLD.hierarchy_no,
                       CCP.ccp_details_sid
                FROM   relationship_level_definition RLD
                       JOIN ccp_map CCP
                         ON RLD.relationship_level_sid =
                            CCP.relationship_level_sid
                       JOIN projection_details PD
                         ON PD.ccp_details_sid = CCP.ccp_details_sid
                            AND PD.projection_master_sid = @PROJECTION_SID
                       JOIN @HIERARCHY_TABLE PCH
                         ON PCH.relationship_level_sid =
                            RLD.relationship_level_sid
                            AND PCH.projection_master_sid = @PROJECTION_SID) CCPMAP
               JOIN (SELECT RLD1.hierarchy_no
                     FROM   relationship_level_definition RLD1
                            JOIN @HIERARCHY_TABLE PCH
                              ON PCH.relationship_level_sid =
                                 RLD1.relationship_level_sid
                                 AND PCH.projection_master_sid = @PROJECTION_SID
                                 AND RLD1.hierarchy_no LIKE '%') HLD
                 ON CCPMAP.hierarchy_no LIKE HLD.hierarchy_no + '%'
        WHERE  HLD.hierarchy_no IN( @HIERARCHYNO )) CCP
WHERE  PD.projection_master_sid =  @PROJECTION_SID
       AND PD.ccp_details_sid = CCP.ccp_details_sid  
               ]]>
        </query> 
    </entity>
    
    <entity id="deleteTemplate">
        <query>   
             <![CDATA[ 
                DELETE FROM @TABLE_NAME where PROJECTION_DETAILS_SID in (@PD_SID)
            ]]>
        </query> 
    </entity>  
            
   
    <entity id="getProdGroupSearch">
        <query>   
       <![CDATA[
                   ;WITH CTE_MAIN
     AS (SELECT IG.ITEM_GROUP_SID,
                IG.ITEM_GROUP_NO,
                IG.ITEM_GROUP_NAME,
                CM.COMPANY_NAME,
                IG.VERSION_NO,
                IG.ITEM_GROUP_DESCRIPTION,
                IGD.ITEM_MASTER_SID
         FROM   ITEM_GROUP IG,
                COMPANY_MASTER CM,
                ITEM_GROUP_DETAILS IGD
         WHERE  IG.COMPANY_MASTER_SID = CM.COMPANY_MASTER_SID
                AND IGD.ITEM_GROUP_SID = IG.ITEM_GROUP_SID
                AND IG.ITEM_GROUP_NO LIKE '?'
                AND IG.ITEM_GROUP_NAME LIKE '?'
                
                @FILTER@),
     COUNT_CTE
     AS (SELECT ITEM_GROUP_SID,
                CNT
         FROM   (SELECT ROW_NUMBER()
                          OVER (
                            PARTITION BY ITEM_GROUP_SID
                            ORDER BY ITEM_GROUP_SID)     RN,
                        COUNT(ITEM_MASTER_SID)
                          OVER (
                            PARTITION BY ITEM_GROUP_SID) CNT,
                        ITEM_GROUP_SID,
                        ITEM_MASTER_SID
                 FROM   CTE_MAIN
                 ?)A
         WHERE  RN = 1),
     ITM_GROUP
     AS (SELECT CNT,
                ITEM_GROUP_SID,
                ITEM_GROUP_NO,
                ITEM_GROUP_NAME,
                COMPANY_NAME,
                VERSION_NO,
                ITEM_GROUP_DESCRIPTION
         FROM   (SELECT ROW_NUMBER()
                          OVER (
                            PARTITION BY ITEM_GROUP_SID
                            ORDER BY ITEM_GROUP_SID)     RN,
                        COUNT(ITEM_MASTER_SID)
                          OVER (
                            PARTITION BY ITEM_GROUP_SID) CNT,
                        ITEM_GROUP_SID,
                        ITEM_GROUP_NO,
                        ITEM_GROUP_NAME,
                        COMPANY_NAME,
                        VERSION_NO,
                        ITEM_GROUP_DESCRIPTION
                 FROM   CTE_MAIN)A
         WHERE  RN = 1)
SELECT @SELECTION@
FROM   ITM_GROUP IG
       JOIN COUNT_CTE C
         ON IG.ITEM_GROUP_SID = C.ITEM_GROUP_SID
            AND C.CNT = IG.CNT
@ORDER_BY@  
		]]>
        </query> 
    </entity>  
    <entity id="getCustGroupSearch">
        <query>   
       <![CDATA[
           ;WITH CTE_MAIN
     AS (SELECT IG.COMPANY_GROUP_SID,
                IG.COMPANY_GROUP_NO,
                IG.COMPANY_GROUP_NAME,
                CM.COMPANY_NAME,
                IG.VERSION_NO,
                IG.COMPANY_GROUP_DESCRIPTION,
                IGD.COMPANY_MASTER_SID
         FROM   COMPANY_GROUP IG
                INNER JOIN COMPANY_GROUP_DETAILS IGD
                        ON IGD.COMPANY_GROUP_SID = IG.COMPANY_GROUP_SID
                INNER JOIN COMPANY_MASTER CM
                        ON IGD.COMPANY_MASTER_SID = CM.COMPANY_MASTER_SID
         WHERE  IG.COMPANY_GROUP_NO LIKE '?'
            AND IG.COMPANY_GROUP_NAME LIKE '?'
             
    @FILTER@),
     COUNT_CTE
     AS (SELECT COMPANY_GROUP_SID,
                CNT
         FROM   (SELECT Row_number()
                          OVER (
                            PARTITION BY COMPANY_GROUP_SID
                            ORDER BY COMPANY_GROUP_SID)     RN,
                        Count(COMPANY_MASTER_SID)
                          OVER (
                            PARTITION BY COMPANY_GROUP_SID) CNT,
                        COMPANY_GROUP_SID,
                        COMPANY_MASTER_SID
                 FROM   CTE_MAIN
                 ? )A
         WHERE  RN = 1),
     ITM_GROUP
     AS (SELECT CNT,
                COMPANY_GROUP_SID,
                COMPANY_GROUP_NO,
                COMPANY_GROUP_NAME,
                COMPANY_NAME,
                VERSION_NO,
                COMPANY_GROUP_DESCRIPTION
         FROM   (SELECT Row_number()
                          OVER (
                            PARTITION BY COMPANY_GROUP_SID
                            ORDER BY COMPANY_GROUP_SID)     RN,
                        Count(COMPANY_MASTER_SID)
                          OVER (
                            PARTITION BY COMPANY_GROUP_SID) CNT,
                        COMPANY_GROUP_SID,
                        COMPANY_GROUP_NO,
                        COMPANY_GROUP_NAME,
                        COMPANY_NAME,
                        VERSION_NO,
                        COMPANY_GROUP_DESCRIPTION
                 FROM   CTE_MAIN)A
         WHERE  RN = 1)
SELECT @SELECTION@
FROM   ITM_GROUP IG
       JOIN COUNT_CTE C
         ON IG.COMPANY_GROUP_SID = C.COMPANY_GROUP_SID
            AND C.CNT = IG.CNT
@ORDER_BY@ 
		]]>
        </query> 
    </entity>  

    <entity id="getDeleteCvd">
        <query>   
       <![CDATA[
           delete CCM from dbo.CUSTOM_CCP_MAP CCM

            Join CUSTOM_VIEW_DETAILS CVD ON CVD.CUSTOM_VIEW_DETAILS_SID=CCM.CUSTOM_VIEW_DETAILS_SID

                AND CVD.CUSTOM_VIEW_MASTER_SID IN(SELECT CUSTOM_VIEW_MASTER_SID

                                              FROM   CUSTOM_VIEW_MASTER cvm

                                                     JOIN @PROJECTION B

                                                       ON B.PROJECTION_MASTER_SID = cvm.PROJECTION_MASTER_SID);

 DELETE CRM
FROM   dbo.CUSTOM_RELATIONSHIP_BUILDER CRM
       JOIN CUSTOM_VIEW_DETAILS CVD
         ON CVD.CUSTOM_VIEW_DETAILS_SID = CRM.CUSTOM_VIEW_DETAILS_SID
            AND CVD.CUSTOM_VIEW_MASTER_SID IN(SELECT CUSTOM_VIEW_MASTER_SID
                                              FROM   CUSTOM_VIEW_MASTER cvm
                                                     JOIN @PROJECTION B
                                                       ON B.PROJECTION_MASTER_SID = cvm.PROJECTION_MASTER_SID); 

                delete CVD from dbo.CUSTOM_VIEW_DETAILS CVD where

                CVD.CUSTOM_VIEW_MASTER_SID IN(SELECT CUSTOM_VIEW_MASTER_SID

                                                              FROM   CUSTOM_VIEW_MASTER cvm

                                                     JOIN @PROJECTION B

                                                       ON B.PROJECTION_MASTER_SID = cvm.PROJECTION_MASTER_SID);
                                                       
		]]>
        </query> 
    </entity>  

    <entity id="getDeleteCvdMandated">
        <query>   
       <![CDATA[
           DELETE CCM 
FROM   dbo.custom_ccp_map CCM 
       JOIN custom_view_details CVD 
         ON CVD.custom_view_details_sid = CCM.custom_view_details_sid 
            AND CVD.custom_view_master_sid IN(SELECT custom_view_master_sid 
                                              FROM   custom_view_master cvm 
                                                     JOIN @PROJECTION B 
                                                       ON 
                    B.projection_master_sid = cvm.projection_master_sid); 

DELETE CRM 
FROM   dbo.custom_relationship_builder CRM 
       JOIN custom_view_details CVD 
         ON CVD.custom_view_details_sid = CRM.custom_view_details_sid 
            AND CVD.custom_view_master_sid IN(SELECT custom_view_master_sid 
                                              FROM   custom_view_master cvm 
                                                     JOIN @PROJECTION B 
                                                       ON 
                    B.projection_master_sid = cvm.projection_master_sid); 
           
                delete CVD from dbo.CUSTOM_VIEW_DETAILS CVD where

                CVD.CUSTOM_VIEW_MASTER_SID IN(SELECT CUSTOM_VIEW_MASTER_SID

                                                              FROM   CUSTOM_VIEW_MASTER cvm

                                                     JOIN @PROJECTION B

                                                       ON B.PROJECTION_MASTER_SID = cvm.PROJECTION_MASTER_SID);

		]]>
        </query> 
    </entity>  
    
    <entity id="getAlternateHistoryProjectionTotal">
        <query> 
            <![CDATA[
            
      DECLARE
        @PROJECTION_DETAILS_SID VARCHAR(MAX)='[@PROJECTION_DETAILS_SID]',
        @FREQUENCY              VARCHAR(20) ='[@Frequency]',
        @VIEW                   VARCHAR(50) ='[@@VIEW]',
        @USER_ID                INT=[@USER_ID],
        @SESSION_ID             INT=[@@SESSION_ID],
		@START            INT=[@START_MONTH],
		@START_YEAR             INT=[@START_YEAR],
		@END                INT=[@END_MONTH],
		@END_YEAR               INT=[@END_YEAR],
		@START_DATE             DATETIME,
		@END_DATE               DATETIME
		

 DECLARE 

 @ITEM_DETAILS     UDT_ITEM
,@START_PERIOD_SID INT 
,@END_PERIOD_SID   INT 
,@FORECAST_NAME    VARCHAR(50)
,@FORECAST_VERSION VARCHAR(15)



BEGIN



SET @FREQUENCY = LEFT(@FREQUENCY,1)


SET @START  = CASE WHEN @FREQUENCY='M' THEN @START
                   WHEN @FREQUENCY='Q' THEN CASE WHEN  @START =1         THEN 1        
                                                 WHEN  @START =2         THEN 4
						                         WHEN  @START =3         THEN 7
						                         ELSE  10
						                         END
                   WHEN @FREQUENCY='S' THEN CASE WHEN  @START =1         THEN 1        
                                                 ELSE  7
						                         END
                   ELSE 1 END
						                        
    


SET @START_DATE = CONVERT (DATETIME, CONVERT(VARCHAR, @START )+'-01-'+CONVERT(VARCHAR , @START_YEAR))
SET @END_DATE   = CONVERT (DATETIME, CONVERT(VARCHAR, @END   )+'-01-'+CONVERT(VARCHAR,  @END_YEAR  ))



SET @START_PERIOD_SID =  (SELECT PERIOD_SID FROM PERIOD P WHERE P.PERIOD_DATE = DATEADD(MM, DATEDIFF(MM, 0, @START_DATE), 0))
SET @END_PERIOD_SID   =  (SELECT PERIOD_SID FROM PERIOD P WHERE P.PERIOD_DATE = DATEADD(MM, DATEDIFF(MM, 0, @END_DATE)  , 0))


------------------------------------------------------AGGREGATION STARTS -------------------------------------------------------------


IF OBJECT_ID('TEMPDB.DBO.#ULTIMATE', 'U') IS NOT NULL
	DROP TABLE #ULTIMATE;

 SELECT 
	     SDAHA.PROJECTION_DETAILS_SID
		,SDAHA.RS_CONTRACT_SID
		,(SDAHA.PERIOD_SID) AS PERIOD_SID
		,P.YEAR
		, SUM(SDAHA.ACTUAL_AMOUNT) AS  SUM_ACTUAL_AMOUNT
	    , SUM(SDAHA.PROJECTION_AMOUNT) AS SUM_PROJECTION_AMOUNT 
		
		INTO #ULTIMATE 
	FROM ST_DISC_ALTERNATE_HIST_ALLOCATION SDAHA
	JOIN PROJECTION_DETAILS PD ON SDAHA.PROJECTION_DETAILS_SID = PD.PROJECTION_DETAILS_SID
	JOIN CCP_DETAILS CD ON CD.CCP_DETAILS_SID = PD.CCP_DETAILS_SID
	JOIN PERIOD P ON P.PERIOD_SID = SDAHA.PERIOD_SID
        AND SDAHA.PERIOD_SID = SDAHA.PERIOD_SID
		AND PD.PROJECTION_DETAILS_SID IN (SELECT U.TOKEN FROM  UDF_SPLITSTRING(@PROJECTION_DETAILS_SID, ',') U)
		AND SDAHA.USER_ID = @USER_ID
		AND SDAHA.SESSION_ID = @SESSION_ID
		AND P.PERIOD_SID BETWEEN @START_PERIOD_SID AND @END_PERIOD_SID


    GROUP BY SDAHA.PROJECTION_DETAILS_SID
	        ,SDAHA.RS_CONTRACT_SID
			,SDAHA.PERIOD_SID
			,P.YEAR
			,CASE
             WHEN @FREQUENCY = 'M' THEN P.MONTH
             WHEN @FREQUENCY = 'Q' THEN P.QUARTER
             WHEN @FREQUENCY = 'S' THEN P.SEMI_ANNUAL
             ELSE P.YEAR
             END
			,SDAHA.ACTUAL_AMOUNT
			,SDAHA.PROJECTION_AMOUNT
------------------------------------------------------------VIEWS-------------------------------------------------------------------
IF OBJECT_ID('TEMPDB.DBO.#FINAL', 'U') IS NOT NULL
  DROP TABLE #FINAL;

SELECT CASE WHEN @VIEW = 'PIVOT' THEN NULL
            ELSE P.YEAR
                        END AS YEAR,
           CASE WHEN  @VIEW = 'PIVOT' THEN NULL
           ELSE
                CASE
         WHEN @FREQUENCY = 'M' THEN P.MONTH
         WHEN @FREQUENCY = 'Q' THEN P.QUARTER
         WHEN @FREQUENCY = 'S' THEN P.SEMI_ANNUAL
         ELSE P.YEAR
       END
       END AS PERIOD,

	   CASE WHEN @VIEW = 'PIVOT' THEN NULL  ELSE (SELECT RS_NAME FROM RS_CONTRACT WHERE RS_CONTRACT_SID = U.RS_CONTRACT_SID ) END AS REBATE_NAME , 

       SUM(U.SUM_ACTUAL_AMOUNT )       AS ACTUAL_AMOUNT,
       SUM(U.SUM_PROJECTION_AMOUNT )   AS PROJECTION_AMOUNT

           INTO #FINAL

FROM   #ULTIMATE U
JOIN PERIOD P ON U.PERIOD_SID = P.PERIOD_SID 
WHERE  U.PROJECTION_DETAILS_SID IN (SELECT U.TOKEN FROM   UDF_SPLITSTRING(@PROJECTION_DETAILS_SID, ',') U)


GROUP  BY   P.YEAR, CASE
            WHEN @FREQUENCY = 'M' THEN P.MONTH
            WHEN @FREQUENCY = 'Q' THEN P.QUARTER
            WHEN @FREQUENCY = 'S' THEN P.SEMI_ANNUAL
            ELSE P.YEAR
          END, RS_CONTRACT_SID

ORDER BY CASE WHEN @VIEW = 'PIVOT' THEN NULL  ELSE P.YEAR END ,
         CASE WHEN @VIEW = 'PIVOT' THEN NULL  ELSE
         CASE
            WHEN @FREQUENCY = 'M' THEN P.MONTH
            WHEN @FREQUENCY = 'Q' THEN P.QUARTER
            WHEN @FREQUENCY = 'S' THEN P.SEMI_ANNUAL
            ELSE P.YEAR
          END
                  END

IF @VIEW = 'PIVOT'
SELECT  SUM(ACTUAL_AMOUNT) AS ACTUAL_AMOUNT, SUM(PROJECTION_AMOUNT) AS PROJECTION_AMOUNT FROM #FINAL GROUP BY YEAR, PERIOD
ELSE
SELECT * FROM #FINAL ORDER BY YEAR,PERIOD
------------------------------------------------------------------------------------------------------------------------------------
END
 ]]>
        </query>
    </entity>
    
    
    <entity id="deleteMandatedCVD">
        <query>   
       <![CDATA[
           
                delete CVD from dbo.CUSTOM_VIEW_DETAILS CVD where

                CVD.CUSTOM_VIEW_MASTER_SID IN( Select PROJECTION_MASTER_SID from CUSTOM_VIEW_MASTER where PROJECTION_MASTER_SID = @PROJECTIONSID);
                
                DELETE FROM dbo.CUSTOM_VIEW_MASTER WHERE PROJECTION_MASTER_SID = @PROJECTIONSID;

		]]>
        </query> 
    </entity>  
    
    
    <entity id="deleteNonMandatedCVD">
        <query>   
       <![CDATA[
           
                DELETE
                FROM   custom_relationship_builder
                WHERE  custom_view_details_sid IN (SELECT custom_view_details_sid
                                                   FROM   custom_view_details
                                                   WHERE  custom_view_master_sid IN (SELECT custom_view_master_sid
                                                                                     FROM   custom_view_master
                                                                                     WHERE  projection_master_sid = @PROJECTIONSID)) ;
                DELETE
                FROM   custom_ccp_map
                WHERE  custom_view_details_sid IN (SELECT custom_view_details_sid
                                                   FROM   custom_view_details
                                                   WHERE  custom_view_master_sid IN (SELECT custom_view_master_sid
                                                                                     FROM   custom_view_master
                                                                                     WHERE  projection_master_sid = @PROJECTIONSID));
                DELETE
                FROM   custom_view_details
                WHERE  custom_view_master_sid IN (SELECT custom_view_master_sid
                                                  FROM   custom_view_master
                                                  WHERE  projection_master_sid = @PROJECTIONSID);

                DELETE
                FROM   custom_view_master
                WHERE  projection_master_sid = @PROJECTIONSID;


		]]>
        </query> 
    </entity> 
    <entity id="ppa-details-generate">
        <query> 
            <![CDATA[
SELECT p.year
       ,p.MONTH
       ,ipq.PRICING_QUALIFIER price_protection_price_type
       ,snpp.Price Price
       ,snpp.PriceChange PriceChange
       ,snpp.PROJECTION_MAP map
       ,snpp.TotalDeductions TotalDeductions
       ,snpp.PROJECTION_DISCOUNT_UNITS units
       ,snpp.deduction_per_unit projection_deduction_per_unit
       ,snpp.NetPrice NetPrice
       ,snpp.NetMap NetMap
       ,snpp.PriceProtectionAmountPerUnit PriceProtectionAmountPerUnit
       ,snpp.PriceProtectionPercentage PriceProtectionPercent
       ,snpp.TotalPriceProtectionDeduction TotalPriceProtectionDeduction
       ,snpp.NEP
       ,snpp.NEP_Formula
       ,HT1.DESCRIPTION Price_Tolerance_Type
       ,snpp.Price_Tolerance
       ,HT2.DESCRIPTION Price_Tolerance_Interval
       ,HT3.DESCRIPTION Price_Tolerance_Frequency
       ,snpp.Max_Incremental_Change
       ,HT4.DESCRIPTION Reset_Eligible
       ,HT5.DESCRIPTION Reset_Type
       ,snpp.Reset_Date
       ,HT6.DESCRIPTION Reset_Interval
       ,HT7.DESCRIPTION Reset_Frequency
       ,HT8.DESCRIPTION Net_Price_Type
       ,nsfm.NET_SALES_FORMULA_NAME Net_Price_Type_Formula
       ,rs.rs_name
       ,snpp.period_sid
       ,p.quarter
       ,snpp.ccp_details_sid
       ,rs.RS_CONTRACT_SID
       ,p.semi_annual
       
FROM RS_CONTRACT RS
JOIN
ST_NM_PPA_PROJECTION snpp
ON snpp.RS_CONTRACT_SID = rs.RS_CONTRACT_SID
LEFT JOIN ITEM_PRICING_QUALIFIER ipq ON ipq.ITEM_PRICING_QUALIFIER_SID = snpp.ITEM_PRICING_QUALIFIER_SID
LEFT JOIN HELPER_TABLE HT1 ON HT1.HELPER_TABLE_SID = SNPP.PRICE_TOLERANCE_TYPE
       AND SNPP.PRICE_TOLERANCE_TYPE <> 0
LEFT JOIN HELPER_TABLE HT2 ON HT2.HELPER_TABLE_SID = SNPP.PRICE_TOLERANCE_INTERVAL
       AND SNPP.PRICE_TOLERANCE_INTERVAL <> 0
LEFT JOIN HELPER_TABLE HT3 ON HT3.HELPER_TABLE_SID = SNPP.PRICE_TOLERANCE_FREQUENCY
       AND SNPP.PRICE_TOLERANCE_FREQUENCY <> 0
LEFT JOIN HELPER_TABLE HT4 ON HT4.HELPER_TABLE_SID = SNPP.RESET_ELIGIBLE
       AND SNPP.RESET_ELIGIBLE <> 0
LEFT JOIN HELPER_TABLE HT5 ON HT5.HELPER_TABLE_SID = SNPP.RESET_TYPE
       AND SNPP.RESET_TYPE <> 0
LEFT JOIN HELPER_TABLE HT6 ON HT6.HELPER_TABLE_SID = SNPP.RESET_INTERVAL
       AND SNPP.RESET_INTERVAL <> 0
LEFT JOIN HELPER_TABLE HT7 ON HT7.HELPER_TABLE_SID = SNPP.RESET_FREQUENCY
       AND SNPP.RESET_FREQUENCY <> 0
LEFT JOIN HELPER_TABLE HT8 ON HT8.HELPER_TABLE_SID = SNPP.NET_PRICE_TYPE
       AND SNPP.NET_PRICE_TYPE <> 0
LEFT JOIN NET_SALES_FORMULA_MASTER NSFM ON NSFM.NET_SALES_FORMULA_MASTER_SID=SNPP.NET_PRICE_TYPE_FORMULA
JOIN ccp_details cd ON cd.ccp_details_sid = snpp.ccp_details_sid
JOIN period p ON p.period_sid = snpp.period_sid
WHERE cd.contract_master_sid = @contractsid
      AND cd.COMPANY_MASTER_SID = @compsid
      AND cd.ITEM_MASTER_SID = @itemsid 
      AND p.PERIOD_SID between @from and @to ORDER BY rs.RS_CONTRACT_SID,p.year @order ,p.MONTH @order OFFSET @start ROWS FETCH NEXT @end ROWS ONLY
           ]]>
        </query> 
    </entity> 
    <entity id="ppa-details-count">
        <query> 
            <![CDATA[
SELECT count(1)
                FROM ST_NM_PPA_PROJECTION SNPP
                LEFT JOIN ITEM_PRICING_QUALIFIER IPQ ON IPQ.ITEM_PRICING_QUALIFIER_SID = SNPP.ITEM_PRICING_QUALIFIER_SID
                JOIN CCP_DETAILS CD ON CD.CCP_DETAILS_SID = SNPP.CCP_DETAILS_SID
                JOIN PERIOD P ON P.PERIOD_SID = SNPP.PERIOD_SID
                WHERE CD.CONTRACT_MASTER_SID = @contractsid
                  AND CD.COMPANY_MASTER_SID = @compsid
                  AND CD.ITEM_MASTER_SID = @itemsid
                  AND P.PERIOD_SID BETWEEN @from AND @to
           ]]>
        </query> 
    </entity> 
    
    <entity id="get-business-units">
        <query>
    		<![CDATA[
                    SELECT
                            CM.COMPANY_MASTER_SID,
                            CM.COMPANY_ID,
                            CM.COMPANY_NO,
                            CM.COMPANY_NAME
                    FROM
                            COMPANY_MASTER CM
                    JOIN HELPER_TABLE HT ON
                            HT.HELPER_TABLE_SID = CM.COMPANY_TYPE
                    WHERE
                            HT.LIST_NAME LIKE 'COMPANY_TYPE'
                            AND HT.DESCRIPTION LIKE 'BUSINESS UNIT'
                            AND CM.INBOUND_STATUS <> 'D'
                            AND CM.COMPANY_MASTER_SID = @ORGANIZATION_KEY
                    ORDER BY COMPANY_NO;
		]]>
        </query>
    </entity>
    
    <entity id="get-companies">
        <query>
            <![CDATA[
                SELECT
                        CM.COMPANY_MASTER_SID,
                        CM.COMPANY_ID,
                        CM.COMPANY_NO,
                        CM.COMPANY_NAME
                FROM
                        COMPANY_MASTER CM
                JOIN HELPER_TABLE HT ON
                        HT.HELPER_TABLE_SID = CM.COMPANY_TYPE
                WHERE
                        HT.LIST_NAME LIKE 'COMPANY_TYPE'
                        AND HT.DESCRIPTION LIKE 'GLCOMP'
                        AND CM.INBOUND_STATUS <> 'D'
                        AND CM.COMPANY_MASTER_SID = @GLCOMP
                ORDER BY COMPANY_NO;
            ]]>
        </query>
    </entity>
    
    
    <entity id="getFileEndDate">
        <query>
            <![CDATA[
            WITH CTE
             AS (SELECT FORECAST_NAME,
                        [VERSION],
                        DESCRIPTION AS FILE_TYPE
                 FROM   (SELECT FT.FORECAST_NAME,
                                FT.[VERSION],
                                HT.DESCRIPTION,
                                FT.FROM_PERIOD,
                                Row_number()
                                  OVER (
                                    PARTITION BY FT.FILE_TYPE
                                    ORDER BY FT.FROM_PERIOD DESC) RN
                         FROM   FILE_MANAGEMENT FT
                                INNER JOIN HELPER_TABLE HT
                                        ON HT.HELPER_TABLE_SID = FT.FILE_TYPE
                         WHERE  ( CONVERT(DATE, FT.FROM_PERIOD) <= CONVERT(DATE, Getdate())
                                  AND FT.FROM_PERIOD IS NOT NULL )
                                AND ( CONVERT(DATE, FT.TO_PERIOD) >= CONVERT(DATE, Getdate())
                                       OR FT.TO_PERIOD IS NULL )
                                AND HT.LIST_NAME = 'FILE_TYPE'
                                AND HT.DESCRIPTION IN ( 'EX-FACTORY SALES', 'DEMAND', 'INVENTORY WITHDRAWAL - FORECAST SUMMARY' )
                                AND FT.BUSINESS_UNIT = [?BUSINESS_UNIT] )A
                 WHERE  RN = 1)
            SELECT TOP 1 FORECAST_YEAR,
                         FORECAST_MONTH
            FROM   (SELECT Cast(FORECAST_YEAR AS INT)  FORECAST_YEAR,
                           Cast(FORECAST_MONTH AS INT) FORECAST_MONTH
                    FROM   FORECASTING_MASTER f
                           INNER JOIN CTE c
                                   ON c.FORECAST_NAME = f.FORECAST_NAME
                                      AND FORECAST_VER IN ( c.[VERSION], Floor(c.VERSION) )
                    UNION ALL
                    SELECT FORECAST_YEAR,
                           FORECAST_MONTH
                    FROM   DEMAND_FORECAST f
                           INNER JOIN CTE c
                                   ON c.FORECAST_NAME = f.FORECAST_NAME
                                      AND FORECAST_VER IN ( c.[VERSION], Floor(c.VERSION) )
                    UNION ALL
                    SELECT YEAR,
                           MONTH
                    FROM   INVENTORY_WD_PROJ_MAS f
                           INNER JOIN CTE c
                                   ON c.FORECAST_NAME = f.FORECAST_NAME
                                      AND FORECAST_VER IN ( c.[VERSION], Floor(c.VERSION) )) A
            ORDER  BY FORECAST_YEAR DESC,
                      FORECAST_MONTH DESC;
         ]]>
        </query>
    </entity>
    
        
    <entity id="check-for-active-file">
        <query>
            <![CDATA[
            IF EXISTS((SELECT TOP 1 FORECAST_NAME
                FROM   FILE_MANAGEMENT FT 
                    INNER JOIN HELPER_TABLE HT 
                            ON HT.HELPER_TABLE_SID = FT.FILE_TYPE 
                            WHERE  ( CONVERT(DATE, FT.FROM_PERIOD) <= CONVERT(DATE, GETDATE()) 
                            AND FT.FROM_PERIOD IS NOT NULL ) 
                    AND ( CONVERT(DATE, FT.TO_PERIOD) >= CONVERT(DATE, GETDATE()) 
                            OR FT.TO_PERIOD IS NULL ) 
                    AND HT.LIST_NAME = 'FILE_TYPE' 
                    AND HT.[DESCRIPTION] IN ( 'DEMAND', 'CUSTOMER SALES', 'ADJUSTED DEMAND', 'EX-FACTORY SALES', 'INVENTORY WITHDRAWAL - FORECAST SUMMARY','Inventory Withdrawal - Forecast Detail' )
                    AND FT.BUSINESS_UNIT = [?BUISNESS_UNIT]
                    AND FT.COMPANY = [?COMPANY]  ))
            SELECT 1
            ELSE 
            SELECT 0
     ]]>
        </query>
    </entity>
    
    
    <entity id="getCCPTempTableQuery">
        <query> 
                                      <![CDATA[
                                         IF Object_id('TEMPDB..#CCP') IS NOT NULL
                    DROP TABLE #CCP

                  CREATE TABLE #CCP
                    (
                       RELATIONSHIP_LEVEL_SID INT,
                       PROJECTION_DETAILS_SID INT,
                       CCP_DETAILS_SID        INT,
                       HIERARCHY_NO           VARCHAR(50)
                    )

                  INSERT INTO #CCP
                              (RELATIONSHIP_LEVEL_SID,
                               PROJECTION_DETAILS_SID,
                               CCP_DETAILS_SID,
                               HIERARCHY_NO)
                                      ]]>
        </query>
    </entity>
    <entity id="mandated-sales-query">
        <query> 
                            <![CDATA[                                                                
                              IF Object_id('TEMPDB..#ST_M_SALES_PROJECTION') IS NOT NULL DROP
                                TABLE
                                    #ST_M_SALES_PROJECTION 
                                    SELECT
                                        HIERARCHY_NO,
                                        @FREQUENCY@,
                                        P.YEAR,
                                        PROJECTION_SALES = SUM(PROJECTION_SALES),
                                        PROJECTION_UNITS = SUM(PROJECTION_UNITS),
                                        ACCOUNT_GROWTH = AVG(ACCOUNT_GROWTH),
                                        PRODUCT_GROWTH = AVG(PRODUCT_GROWTH) INTO
                                            #ST_M_SALES_PROJECTION
                                        FROM
                                              [$TABLE_NAME] S JOIN #SELECTED_HIERARCHY_NO  C
                                                ON C.CCP_DETAILS_SID = S.CCP_DETAILS_SID JOIN PERIOD P
                                                ON P.PERIOD_SID = S.PERIOD_SID
                                        GROUP BY
                                            HIERARCHY_NO
                                           @FREQUENCY_GROUP@,
                                            P.YEAR
                                            
                                    IF Object_id('TEMPDB..#ST_M_ACTUAL_SALES') IS NOT NULL DROP
                                        TABLE
                                            #ST_M_ACTUAL_SALES 
                                            SELECT
                                                HIERARCHY_NO,
                                                @FREQUENCY@,
                                                P.YEAR,
                                                ACTUAL_SALES = SUM(ACTUAL_SALES),
                                                ACTUAL_UNITS = SUM(ACTUAL_UNITS),
                                                SUM(S.ACTUAL_PROJECTION_SALES) AS HISTORY_PROJECTION_SALES,
                                                SUM(S.ACTUAL_PROJECTION_UNITS) AS HISTORY_PROJECTION_UNITS INTO
                                                    #ST_M_ACTUAL_SALES
                                                FROM
                                                   [$ACTUAL_TABLE_NAME] S JOIN #SELECTED_HIERARCHY_NO C
                                                        ON C.CCP_DETAILS_SID = S.CCP_DETAILS_SID JOIN PERIOD P
                                                        ON P.PERIOD_SID = S.PERIOD_SID
                                                
                                                GROUP BY
                                                    HIERARCHY_NO
                                                   @FREQUENCY_GROUP@,
                                                    P.YEAR IF Object_id('TEMPDB..#ST_M_SALES_PROJECTION_MASTER') IS NOT NULL DROP
                                                        TABLE
                                                            #ST_M_SALES_PROJECTION_MASTER SELECT
                                                                CASE
                                                                    WHEN COUNT(
                                                                        DISTINCT MSPM.CALCULATION_PERIODS
                                                                    ) > 1
                                                                    THEN '-'
                                                                    ELSE MAX(MSPM.CALCULATION_PERIODS)
                                                                END CALCULATION_PERIODS,
                                                                CASE
                                                                    WHEN COUNT(
                                                                        DISTINCT MSPM.METHODOLOGY
                                                                    ) > 1
                                                                    THEN '-'
                                                                    ELSE MAX(MSPM.METHODOLOGY)
                                                                END AS METHODOLOGY,
                                                                CCP.HIERARCHY_NO,
                                                                COUNT(*) AS RCOUNT,
                                                                MIN(
                                                                    CASE
                                                                        (CHECK_RECORD) WHEN 1
                                                                        THEN 1
                                                                        ELSE 0
                                                                    END
                                                                ) AS checkrec,
                                                                SUM(
                                                                    CASE
                                                                        (MSPM.CHECK_RECORD) WHEN 1
                                                                        THEN 0
                                                                        ELSE 1
                                                                    END
                                                                ) / @FREQDIVISION AS UNCHECK_COUNT,
                                                                COUNT(MSPM.CCP_DETAILS_SID) / @FREQDIVISION AS CCPCOUNT
                                                                INTO
                                                                    #ST_M_SALES_PROJECTION_MASTER
                                                                FROM
                                                                    #SELECTED_HIERARCHY_NO CCP  JOIN [$MASTER_TABLE_NAME] MSPM
                                                                        ON CCP.CCP_DETAILS_SID = MSPM.CCP_DETAILS_SID                                                                                                                                  
                                                              
                                                                GROUP BY
                                                                    CCP.HIERARCHY_NO

                                                                    SELECT
                                                                        MAINQ.account_growth,
                                                                        MAINQ.product_growth,
                                                                        MAINQ.projection_sales,
                                                                        MAINQ.projection_units,
                                                                        MAINQ.actualsales,
                                                                        MAINQ.actualunits,
                                                                        MAINQ.YEARS,
                                                                        MAINQ.PERIODS,
                                                                        MAINQ.calculation_periods,
                                                                        MAINQ.methodology,
                                                                        MAINQ.hierarchy_no,
                                                                        MAINQ.rcount,
                                                                        MAINQ.actualproj,
                                                                        MAINQ.checkrec,
                                                                        MAINQ.uncheck_count,
                                                                        MAINQ.ccpcount,
                                                                        MAINQ.hierarchy_indicator                                                                               
                                                                    FROM
                                                                        (
                                                                            SELECT
                                                                                Q.account_growth,
                                                                                Q.product_growth,
                                                                                Q.projection_sales,
                                                                                Q.projection_units,
                                                                                Q.actualsales,
                                                                                Q.actualunits,
                                                                                Q.YEARS,
                                                                                Q.PERIODS,
                                                                                Q.calculation_periods,
                                                                                Q.methodology,
                                                                                Q.hierarchy_no,
                                                                                Q.rcount,
                                                                                Q.actualproj,
                                                                                Q.checkrec,
                                                                                Q.uncheck_count,
                                                                                Q.ccpcount,
                                                                                Q.hierarchy_indicator,

                                                                                DENSE_RANK() OVER(
                                                                                ORDER BY
                                                                                    Q.hierarchy_no ASC
                                                                                ) AS TEMP_INDEX
                                                                            FROM
                                                                                (
                                                                                    SELECT
                                                                                        0.0 AS ACCOUNT_GROWTH,
                                                                                        0.0 AS PRODUCT_GROWTH,
                                                                                        NULL AS PROJECTION_SALES,
                                                                                        NULL AS PROJECTION_UNITS,
                                                                                        MAS.ACTUAL_SALES AS actualSales,
                                                                                        MAS.ACTUAL_UNITS AS actualUnits,
                                                                                        "YEAR" AS YEARS,
                                                                                        @FRE@ AS PERIODS,
                                                                                        CALCULATION_PERIODS,
                                                                                        METHODOLOGY,
                                                                                        MSPM.HIERARCHY_NO,
                                                                                        RCOUNT,
                                                                                        1 AS actualProj,
                                                                                        checkrec,
                                                                                        UNCHECK_COUNT,
                                                                                        CCPCOUNT,
                                                                                        '@HIERARCHY_INDICATOR' AS HIERARCHY_INDICATOR                                                                                               
                                                                                    FROM
                                                                                        #ST_M_SALES_PROJECTION_MASTER MSPM JOIN #ST_M_ACTUAL_SALES MAS
                                                                                            ON MSPM.HIERARCHY_NO = MAS.HIERARCHY_NO
                                                                                UNION ALL SELECT
                                                                                        MSP.ACCOUNT_GROWTH,
                                                                                        MSP.PRODUCT_GROWTH,
                                                                                        MSP.PROJECTION_SALES,
                                                                                        MSP.PROJECTION_UNITS,
                                                                                        NULL AS ACTUAL_SALES,
                                                                                        NULL AS ACTUAL_UNITS,
                                                                                        "YEAR" AS YEARS,
                                                                                        @FRE@ AS PERIODS,
                                                                                        CALCULATION_PERIODS,
                                                                                        METHODOLOGY,
                                                                                        MSPM.HIERARCHY_NO,
                                                                                        RCOUNT,
                                                                                        0 AS actualProj,
                                                                                        checkrec,
                                                                                        UNCHECK_COUNT,
                                                                                        CCPCOUNT,
                                                                                        '@HIERARCHY_INDICATOR' AS HIERARCHY_INDICATOR                                                                                                
                                                                                    FROM
                                                                                        #ST_M_SALES_PROJECTION_MASTER MSPM JOIN #ST_M_SALES_PROJECTION MSP
                                                                                            ON MSPM.HIERARCHY_NO = MSP.HIERARCHY_NO
                                                                                ) Q
                                                                        ) MAINQ
                                                                   WHERE  MAINQ.TEMP_INDEX > @START
                                                                        AND MAINQ.TEMP_INDEX <= ( @START+@END )
                                                                    ORDER BY
                                                                        MAINQ.hierarchy_no,
                                                                        MAINQ.YEARS,
                                                                        MAINQ.PERIODS;
   
                                          ]]>
        </query>
    </entity>
    
    <entity id="check-mandated-actual-discount">
        <query> 
            <![CDATA[

                IF EXISTS(SELECT 1
                            FROM   ST_M_ACTUAL_DISCOUNT D
                            JOIN   ST_CCP_HIERARCHY B ON D.CCP_DETAILS_SID = B.CCP_DETAILS_SID
                                )
                SELECT 1 
                ELSE 
                SELECT 0;
                
            ]]>
        </query>
    </entity>

    <entity id="check-mandated-discount-projection">
        <query> 
            <![CDATA[

            IF EXISTS(SELECT 1
                           FROM   ST_M_DISCOUNT_PROJECTION D
                            JOIN   ST_CCP_HIERARCHY B ON D.CCP_DETAILS_SID = B.CCP_DETAILS_SID
                           )
            SELECT 1 
            ELSE 
            SELECT 0;


            ]]>
        </query>
    </entity>
    <entity id="get-companyName">
        <query>
            <![CDATA[
                SELECT
                        CM.COMPANY_MASTER_SID,CM.COMPANY_ID,CM.COMPANY_NAME
                FROM COMPANY_MASTER CM WHERE CM.COMPANY_MASTER_SID = @GLCOMP
            ]]>
        </query>
    </entity>
    
    <entity id="getProgramCode">
        <query>
            <![CDATA[
                     SELECT
	             DISTINCT CM.CONTRACT_NAME
                         FROM
	                dbo.CONTRACT_MASTER CM
                     JOIN dbo.CCP_DETAILS CCP ON
	              CCP.CONTRACT_MASTER_SID = CM.CONTRACT_MASTER_SID
                     JOIN dbo.PROJECTION_DETAILS PD ON
	              PD.CCP_DETAILS_SID = CCP.CCP_DETAILS_SID
	            AND PD.PROJECTION_MASTER_SID = @ProjectSID
            ]]>
        </query>
    </entity>
    
    <entity id="relation-ship-level-details">
        <query>
            <![CDATA[
                SELECT
                    DISTINCT RLD.LEVEL_NO,
                    convert(int,RLD.LEVEL_NO) as TREE_LEVEL_NO,
                    '?' as HIERARCHY_INDICATOR,
                    RLD.LEVEL_NAME,
                    RLD.HIERARCHY_LEVEL_DEFINITION_SID
                FROM
                    PROJECTION_MASTER PM
                JOIN RELATIONSHIP_LEVEL_DEFINITION RLD ON
                    RLD.RELATIONSHIP_BUILDER_SID = PM.?
                    AND RLD.VERSION_NO = ?
                WHERE
                    PM.PROJECTION_MASTER_SID = ?
                    AND RLD.LEVEL_NO >= ?
                    order by convert(int, RLD.level_no) ;
            ]]>
        </query>
    </entity>
    
    <entity id="sales-join-nonmandated">
        <query>
            <![CDATA[
                JOIN ST_NM_SALES_PROJECTION_MASTER SPM ON SPM.CCP_DETAILS_SID = CH.CCP_DETAILS_SID
            ]]>
        </query>
    </entity>
    
    <entity id="sales-join-mandated">
        <query>
            <![CDATA[
                JOIN ST_M_SALES_PROJECTION_MASTER SPM ON SPM.CCP_DETAILS_SID = CH.CCP_DETAILS_SID
            ]]>
        </query>
    </entity>
    
    <entity id="discount-join">
        <query>
            <![CDATA[
                JOIN ST_NM_DISCOUNT_PROJ_MASTER SPM ON SPM.CCP_DETAILS_SID = CH.CCP_DETAILS_SID ?DEDJOIN
            ]]>
        </query>
    </entity>
    <entity id="variance-join">
        <query>
            <![CDATA[
                JOIN ST_CCP_PV_FILTERS SPM ON SPM.CCP_DETAILS_SID = CH.CCP_DETAILS_SID ?DEDJOIN
            ]]>
        </query>
    </entity>
     <entity id="discount-join-mandated">
        <query>
            <![CDATA[
                JOIN ST_M_SUPPLEMENTAL_DISC_MASTER SPM ON SPM.CCP_DETAILS_SID = CH.CCP_DETAILS_SID
            ]]>
        </query>
    </entity>
    
    <entity id="ppa-join">
        <query>
            <![CDATA[
                JOIN ST_NM_PPA_PROJECTION_MASTER SPM ON SPM.CCP_DETAILS_SID = CH.CCP_DETAILS_SID
            ]]>
        </query>
    </entity>
    
    <entity id="user-group-condition">
        <query>
            <![CDATA[
                WHERE SPM.USER_GROUP LIKE '[?USER_GROUP]'
            ]]>
        </query>
    </entity>
    
    <entity id="alternate-join-count">
        <query>
            <![CDATA[
                JOIN ST_ALTERNATE_HIST_ALLOCATION SPM ON SPM.CCP_DETAILS_SID = CH.CCP_DETAILS_SID
            ]]>
        </query>
    </entity>
    
    <entity id="alternate-join-loaddata">
        <query>
            <![CDATA[
    JOIN (SELECT DISTINCT ccp_details_sid   FROM   ST_ALTERNATE_HIST_ALLOCATION)ch1
         ON CH1.CCP_DETAILS_SID = CH.CCP_DETAILS_SID
     ]]>
        </query>
    </entity>
    
    <entity id="get-discount-name-with-program-category">
        <query>
            <![CDATA[
                SELECT DISTINCT RS.RS_CONTRACT_SID AS DISCOUNT_ID,
                                RS.RS_NAME AS DISCOUNT_NAME
                FROM ST_NM_DISCOUNT_PROJ_MASTER DM
                JOIN CCP_DETAILS CCP ON DM.CCP_DETAILS_SID = CCP.CCP_DETAILS_SID  
                JOIN RS_CONTRACT RS ON RS.CONTRACT_MASTER_SID = CCP.CONTRACT_MASTER_SID AND DM.RS_CONTRACT_SID = RS.RS_CONTRACT_SID
                WHERE DM.PRICE_GROUP_TYPE IN (?)  
                AND INBOUND_STATUS <> 'D'
                ORDER BY DISCOUNT_NAME;
            ]]>
        </query>
    </entity>
    
    <entity id="get-discount-name-with-program">
        <query>
            <![CDATA[
                SELECT DISTINCT RS.RS_CONTRACT_SID AS DISCOUNT_ID,
                                RS.RS_NAME AS DISCOUNT_NAME
                FROM ST_NM_DISCOUNT_PROJ_MASTER DM
                JOIN CCP_DETAILS CCP ON DM.CCP_DETAILS_SID = CCP.CCP_DETAILS_SID  
                JOIN RS_CONTRACT RS ON RS.CONTRACT_MASTER_SID = CCP.CONTRACT_MASTER_SID AND DM.RS_CONTRACT_SID = RS.RS_CONTRACT_SID
                WHERE RS.RS_NAME IN (?)  
                AND INBOUND_STATUS <> 'D'
                ORDER BY DISCOUNT_NAME;
            ]]>
        </query>
    </entity>
     <entity id="levelNo-Query">
        <query>
            <![CDATA[
               SELECT DISTINCT  RLD.LEVEL_NO FROM dbo.RELATIONSHIP_LEVEL_DEFINITION RLD
                             JOIN @TABLE_NAME PCH ON RLD.RELATIONSHIP_LEVEL_SID = PCH.RELATIONSHIP_LEVEL_SID 
                                 AND PCH.PROJECTION_MASTER_SID = @PROJECTION_MASTER_SID
                                 ORDER BY  RLD.LEVEL_NO DESC
            ]]>
        </query>
    </entity>
    
    <entity id="get-helper-table-query">
        <query>
            <![CDATA[
               select HELPER_TABLE_SID from dbo.HELPER_TABLE where DESCRIPTION = '?';
            ]]>
        </query>
    </entity>
    
    <entity id="get-file-type-query">
        <query>
            <![CDATA[
        select
	HT.DESCRIPTION
        from
	dbo.FILE_MANAGEMENT FT
        JOIN dbo.HELPER_TABLE HT on
	FT.FILE_TYPE = HT.HELPER_TABLE_SID
        where
	TO_PERIOD is null
            ]]>
        </query>
    </entity>
    
     <entity id="PARENT-VALIDATE">
        <query>
            <![CDATA[
            
                  IF Object_id('TEMPDB..#PARENT_VALIDATE') IS NOT NULL DROP
	TABLE
		#PARENT_VALIDATE CREATE
			TABLE
				#PARENT_VALIDATE(
					RS_CONTRACT_SID INT,
					PARENT_HIERARCHY VARCHAR(MAX)
				) INSERT
					into
						#PARENT_VALIDATE(
							RS_CONTRACT_SID,
							PARENT_HIERARCHY
						) SELECT
							DISTINCT mas.RS_CONTRACT_SID,
							RLD.PARENT_HIERARCHY_NO
						FROM
							ST_CCP_PV_FILTERS MAS
						JOIN RELATIONSHIP_LEVEL_DEFINITION RLD ON
							LEVEL_NO = 10
							AND relationship_builder_sid = @RELVALUE
							AND VERSION_NO = @RELVERSION
							AND RLD.RELATIONSHIP_LEVEL_VALUES = MAS.RS_CONTRACT_SID
 
 
            ]]>
        </query>
     </entity>
     <entity id="buttonSecurity">
         <query>
    		<![CDATA[
                        select DISTINCT
				MP.PROPERTY_NAME,
				BMM.?,
                                MP.DISPLAY_NAME
	
			from
				USERGROUP_BUSINESSROLE UBM
			JOIN BUSINESSROLE_MODULE BMM ON
				UBM.BUSINESSROLE_MASTER_SID = BMM.BUSINESSROLE_MASTER_SID
			JOIN MODULE_PROPERTIES MP ON
				BMM.SUBMODULE_PROPERTY_ID = MP.MODULE_PROPERTY_SID
			JOIN MODULE_SUBMODULE_MASTER SMM ON
				SMM.MODULE_SUBMODULE_SID = MP.MODULE_SUBMODULE_SID
			AND MP.CATEGORY_NAME = '?'
			AND SMM.MODULE_NAME = '?'
			AND SMM.SUBMODULE_NAME = '?'
			AND MP.TAB_NAME = '?'
                        ?
		]]>
         </query>
     </entity> 
     
      <entity id="insertAttachQuery">
        <query>
    	<![CDATA[
    	
Declare @ATTACHMENT_TABLE_SID int = ?ATTACHMENT_TABLE_SID
DECLARE @MASTER_TABLE_NAME varchar(50) = ?MASTER_TABLE_NAME
DECLARE @FILE_DATA varbinary(MAX) = CONVERT(varbinary, ?FILE_DATA)
DECLARE @FILE_NAME varchar(50) = ?FILE_NAME
DECLARE @CREATED_DATE DATE = GETDATE()
DECLARE @CREATED_BY int = ?CREATED_BY

                    INSERT INTO ATTACHMENT
                    (
                    ATTACHMENT_TABLE_SID,
                    MASTER_TABLE_NAME,
                    FILE_DATA,
                    FILE_NAME,
                    CREATED_DATE,
                    CREATED_BY
                    )
                    VALUES(@ATTACHMENT_TABLE_SID,@MASTER_TABLE_NAME,@FILE_DATA,@FILE_NAME,@CREATED_DATE,@CREATED_BY)
          
                     
             ]]>
        </query>
    </entity>
    <entity id="selectAttachQuery">
        <query>
    		<![CDATA[
   select FILE_DATA from Attachment where ATTACHMENT_TABLE_SID = ?attachmentSid 
		]]>
        </query>
    </entity>   
  
    <entity id="getProcedureStatus">
        <query>
    		<![CDATA[
   SELECT
	SCREEN_NAME,
	VIEW_NAME,
	FLAG
FROM
	ST_STATUS_TABLE
WHERE
	SCREEN_NAME = '?'
	AND VIEW_NAME = '?'
		]]>
        </query>
    </entity>   
    
    <entity id = "customViewDeclaration">
        <query>
            <![CDATA[
            DECLARE @LEVEL_NO INT

            SELECT @LEVEL_NO = Max(LEVEL_NO)
            FROM   CUST_VIEW_DETAILS
            WHERE  CUSTOM_VIEW_MASTER_SID = [$CUSTOM_VIEW_MASTER_SID] 

            ]]>
        </query>
    </entity>
    
    <entity id="loadCustomRelationValues">
        <query>
    		<![CDATA[
                
   SELECT DISTINCT CVM.CUST_VIEW_MASTER_SID,CVM.CUST_VIEW_NAME,CVM.MODIFIED_DATE  FROM CUST_VIEW_MASTER  CVM 
        JOIN CUSTOM_CCP_DETAILS CVD ON CVD.CUST_VIEW_MASTER_SID=CVM.CUST_VIEW_MASTER_SID 
         WHERE CVM.CUSTOMER_RELATIONSHIP_SID=@CUSTSID AND CVM.PRODUCT_RELATIONSHIP_SID=@PRODSID AND CVD.CUSTOMER_VERSION=@CUSTVER AND CVD.PRODUCT_VERSION=@PRODVER
          AND CUST_VIEW_TYPE='SALES' ORDER BY CVM.MODIFIED_DATE DESC
		]]>
        </query>
    </entity>   
    <entity id="loadCustomDeductionRelationValues">
        <query>
    		<![CDATA[
                
   SELECT DISTINCT CVM.CUST_VIEW_MASTER_SID,CVM.CUST_VIEW_NAME,CVM.MODIFIED_DATE  FROM CUST_VIEW_MASTER  CVM 
        JOIN CUSTOM_CCP_DETAILS CVD ON CVD.CUST_VIEW_MASTER_SID=CVM.CUST_VIEW_MASTER_SID 
         WHERE CVM.CUSTOMER_RELATIONSHIP_SID=@CUSTSID AND CVM.PRODUCT_RELATIONSHIP_SID=@PRODSID AND CVD.CUSTOMER_VERSION=@CUSTVER AND CVD.PRODUCT_VERSION=@PRODVER
         AND (CUST_VIEW_TYPE='SALES' OR  CUST_VIEW_TYPE='DISCOUNT') ORDER BY CVM.MODIFIED_DATE DESC
         	]]>
        </query>
    </entity>   
         
    
    <entity id="ViewTableTruncationSales">
        <query>
    		<![CDATA[
                
  TRUNCATE TABLE ST_CUSTOMER_SALES;
  TRUNCATE TABLE ST_PRODUCT_SALES;
  TRUNCATE TABLE ST_CUSTOM_SALES;
         
		]]>
        </query>
    </entity> 
    <entity id="ViewTableTruncationSalesCustom">
        <query>
    		<![CDATA[
                
  TRUNCATE TABLE ST_CUSTOM_SALES;
         
		]]>
        </query>
    </entity> 
    <entity id="ViewTableTruncationDiscountCustom">
        <query>
    		<![CDATA[
                
  TRUNCATE TABLE ST_CUSTOM_DISCOUNT;
         
		]]>
        </query>
    </entity> 
    <entity id="ViewTableTruncationDiscount">
        <query>
    		<![CDATA[
                
  TRUNCATE TABLE ST_CUSTOMER_DISCOUNT;
  TRUNCATE TABLE ST_PRODUCT_DISCOUNT;
  TRUNCATE TABLE ST_CUSTOM_DISCOUNT;
         
		]]>
        </query>
    </entity> 
    <entity id="ViewTableTruncationVariance">
        <query>
    		<![CDATA[
                
  TRUNCATE TABLE ST_CUSTOMER_PV;
  TRUNCATE TABLE ST_PRODUCT_PV;
  TRUNCATE TABLE ST_CUSTOM_PV;
         
		]]>
        </query>
    </entity> 
    
     <entity id="projectionMasterInsert">
        <query>
    		<![CDATA[    
    INSERT INTO PROJECTION_MASTER (PROJECTION_NAME,PROJECTION_DESCRIPTION, FORECASTING_TYPE, CREATED_BY, CREATED_DATE, BRAND_TYPE, CUSTOMER_HIERARCHY_SID,
PRODUCT_HIERARCHY_SID, CUSTOMER_HIERARCHY_LEVEL, PRODUCT_HIERARCHY_LEVEL, CUSTOMER_HIERARCHY_INNER_LEVEL, PRODUCT_HIERARCHY_INNER_LEVEL, CUSTOMER_HIER_VERSION_NO,
PRODUCT_HIER_VERSION_NO,COMPANY_GROUP_SID,ITEM_GROUP_SID, COMPANY_MASTER_SID, FROM_DATE, TO_DATE, SAVE_FLAG,CUST_RELATIONSHIP_BUILDER_SID, PROD_RELATIONSHIP_BUILDER_SID,
DISCOUNT_TYPE,BUSINESS_UNIT, PROJECTION_CUST_VERSION, PROJECTION_PROD_VERSION ,CUSTOM_VIEW_MASTER_SID ,CUSTOM_VIEW_MASTER_DEDUCTION_SID @DEDUCTION_ADDITION) 
VALUES ('@PROJECTION_NAME','@PROJECTION_DESCRIPTION','@FORECASTING_TYPE',@CREATED_BY, '@CREATED_DATE', 1,'@CUSTOMER_HIERARCHY_SID', '@PRODUCT_HIERARCHY_SID',
'@CUSTOMER_HIERARCHY_LEVEL', @PRODUCT_HIERARCHY_LEVEL,'@CUSTOMER_HIERARCHY_INNER_LEVEL', '@PRODUCT_HIERARCHY_INNER_LEVEL', '@CUSTOMER_HIER_VERSION_NO', '@PRODUCT_HIER_VERSION_NO',
@COMPANY_GROUP_SID, @ITEM_GROUP_SID, @COMPANY_MASTER_SID, '@FROM_DATE','@TO_DATE', 0, '@CUST_RELATIONSHIP_BUILDER_SID', '@PROD_RELATIONSHIP_BUILDER_SID', '@DISCOUNT_TYPE', '@BUSINESS_UNIT',
'@PROJECTION_CUST_VERSION',@PROJECTION_PROD_VERSION ,@CUSTSID , @CUSTDEDSID @DED_ADD_VALUES) ;
]]> 
        </query>
    </entity> 
    
     <entity id="updateStatusTable">
        <query>
    		<![CDATA[
      UPDATE
	ST_STATUS_TABLE
SET
	FLAG = 'R'
WHERE
	SCREEN_NAME = '?'
        AND VIEW_NAME = '?'
		]]>
        </query>
    </entity> 
    
    <entity id="projectionMasterUpdate">
        <query>
    		<![CDATA[    
UPDATE
    PROJECTION_MASTER
SET
   PROJECTION_NAME = '@PROJECTION_NAME',
   PROJECTION_DESCRIPTION = '@PROJECTION_DESCRIPTION',
   FORECASTING_TYPE = '@FORECASTING_TYPE',
   MODIFIED_BY = @MODIFIED_BY,
   MODIFIED_DATE = GETDATE(),
   BRAND_TYPE = 1,
   CUSTOMER_HIERARCHY_SID = '@CUSTOMER_HIERARCHY_SID',
   PRODUCT_HIERARCHY_SID = '@PRODUCT_HIERARCHY_SID',
   CUSTOMER_HIERARCHY_LEVEL = @CUSTOMER_HIERARCHY_LEVEL,
   PRODUCT_HIERARCHY_LEVEL = @PRODUCT_HIERARCHY_LEVEL,
   CUSTOMER_HIERARCHY_INNER_LEVEL = '@CUSTOMER_HIERARCHY_INNER_LEVEL',
   PRODUCT_HIERARCHY_INNER_LEVEL = '@PRODUCT_HIERARCHY_INNER_LEVEL',
   CUSTOMER_HIER_VERSION_NO = '@CUSTOMER_HIER_VERSION_NO',
   PRODUCT_HIER_VERSION_NO = '@PRODUCT_HIER_VERSION_NO',
   COMPANY_GROUP_SID = @COMPANY_GROUP_SID,
   ITEM_GROUP_SID = @ITEM_GROUP_SID,
   COMPANY_MASTER_SID = @COMPANY_MASTER_SID,
   FROM_DATE = '@FROM_DATE',
   CUST_RELATIONSHIP_BUILDER_SID = '@CUST_RELATIONSHIP_BUILDER_SID',
   PROD_RELATIONSHIP_BUILDER_SID = '@PROD_RELATIONSHIP_BUILDER_SID',
   FORECAST_ELIGIBLE_DATE = @FORECAST_ELIGIBLE_DATE,
   CUSTOM_VIEW_MASTER_SID = @CUSTSID,
   CUSTOM_VIEW_MASTER_DEDUCTION_SID = @CUSTDEDSID
 WHERE
    PROJECTION_MASTER_SID = '?' 
]]> 
        </query>
    </entity> 
   
</sql>
