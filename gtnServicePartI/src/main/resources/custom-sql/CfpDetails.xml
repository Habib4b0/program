<?xml version="1.0"?>

<custom-sql>
	<sql id="findCompanyDetails">
		<![CDATA[
			
select com_CompanyFamilyPlanDetails.TpId,
com_CompanyMaster.CompanyNo, 
com_CompanyMaster.CompanyName, 
com_CompanyFamilyPlanDetails.AttachedStatus,
com_CompanyFamilyPlanDetails.StartDate, 
com_CompanyFamilyPlanDetails.EndDate,
com_CompanyFamilyPlanDetails.TradeClass,
com_CompanyFamilyPlanDetails.TradeClassStartDate,
com_CompanyFamilyPlanDetails.TradeClassEndDate,
com_CompanyFamilyPlanDetails.CompanyFamilyPlanSystemId
 from com_CompanyFamilyPlanDetails, com_CompanyMaster 
    where com_CompanyMaster.CompanySystemId = com_CompanyFamilyPlanDetails.TpId
		]]>
	</sql>
	
	<sql id="deleteCompanyDetails">
		<![CDATA[			
		delete from com_CompanyFamilyPlanDetails
		]]>
	</sql>
	<sql id="findCompanies">
		<![CDATA[			
		select com_CompanyMaster.CompanySystemId, 
			   com_CompanyMaster.CompanyNo, 
               com_CompanyMaster.CompanyName 
    	from com_CompanyMaster
    	]]>
	</sql>
	<sql id="findCrtCompanies">
	<![CDATA[	
			select com_CompanyMaster.CompanySystemId, 
				   com_CompanyMaster.CompanyNo, 
                    com_CompanyMaster.CompanyName, 
                    com_CompanyCrtIdentifier.CompanyIdentifier
				from com_CompanyMaster,com_CompanyCrtIdentifier
				   where com_CompanyMaster.CompanySystemId = com_CompanyCrtIdentifier.CompanySystemId				  
	 	 ]]>	
	
	
	</sql>
        <sql id="insertTempCfpDetailsEdit">
		<![CDATA[			
		INSERT INTO dbo.IMTD_CFP_DETAILS (COMPANY_MASTER_SID,CFP_DETAILS_SID,COMPANY_ID,
COMPANY_NO,COMPANY_NAME,COMPANY_TYPE,COMPANY_START_DATE,COMPANY_END_DATE,COMPANY_STATUS,TRADING_PARTNER_CONTRACT_NO,CFP_DETAILS_ATTACHED_DATE,CFP_DETAILS_START_DATE,
CFP_DETAILS_END_DATE,CFP_DETAILS_ATTACHED_STATUS,CFP_DETAILS_CREATED_BY,CFP_DETAILS_CREATED_DATE,CFP_DETAILS_TRADE_CLASS,"OPERATION",CFP_DETAILS_MODIFIED_DATE,CFP_DETAILS_MODIFIED_BY,
USERS_SID,SESSION_ID,IMTD_CREATED_DATE,CHECK_RECORD,CFP_MODEL_SID)
select cm.COMPANY_MASTER_SID,cfp.CFP_DETAILS_SID,cm.COMPANY_ID,cm.COMPANY_NO,cm.COMPANY_NAME,cm.COMPANY_TYPE,
cm.COMPANY_START_DATE,cm.COMPANY_END_DATE,cm.COMPANY_STATUS,
cfp.TRADING_PARTNER_CONTRACT_NO,
cfp.COMPANY_CFP_ATTACHED_DATE,cfp.COMPANY_START_DATE,
cfp.COMPANY_END_DATE,cfp.COMPANY_CFP_ATTACHED_STATUS,cfp.CREATED_BY,cfp.CREATED_DATE,HT.DESCRIPTION as CFP_DETAILS_TRADE_CLASS,CASE WHEN cfp.INBOUND_STATUS <>'D' Then 'A' Else 'F' End,
		]]>
        </sql>
        <sql id="insertTempCfpDetailsAdd">
		<![CDATA[			
		          INSERT INTO dbo.TEMP_CFP_DETAILS (TradingPartnerSystemId,CompanyId,CompanyNo,CompanyName,CompanyType,CompanyStatus,CompanyStartDate,CompanyEndDate,
CFPDetailsAttachedDate,UserId,SessionId,TempCreatedDate,CheckRecord,"Operation",CFPDetailsCreatedBy,CFPDetailsCreatedDate)
select COMPANY_SYSTEM_ID,COMPANY_ID,COMPANY_NO,COMPANY_NAME,COMPANY_TYPE,COMPANY_STATUS,COMPANY_START_DATE,COMPANY_END_DATE,
]]>
        </sql>
        <sql id="insertTempCfpDetailsAddSelect">
		<![CDATA[			
		       
 Union SELECT COMPANY_SYSTEM_ID,COMPANY_ID,COMPANY_NO,COMPANY_NAME,COMPANY_TYPE,COMPANY_STATUS,COMPANY_START_DATE,COMPANY_END_DATE 
FROM dbo.company_master cm left outer join dbo.TEMP_CFP_DETAILS TCD ON cm.COMPANY_SYSTEM_ID=TCD.TradingPartnerSystemId and 
		]]>
        </sql>
        <sql id="updateCfpDetailsAttched">
		<![CDATA[			
		       
 INSERT INTO dbo.CFP_DETAILS (COMPANY_MASTER_SID,COMPANY_START_DATE,COMPANY_END_DATE,TRADING_PARTNER_CONTRACT_NO,COMPANY_CFP_ATTACHED_STATUS,COMPANY_CFP_ATTACHED_DATE,CREATED_BY,CREATED_DATE,CFP_MODEL_SID,INBOUND_STATUS,RECORD_LOCK_STATUS,MODIFIED_BY)
select COMPANY_MASTER_SID,CFP_DETAILS_START_DATE,CFP_DETAILS_END_DATE,TRADING_PARTNER_CONTRACT_NO,CFP_DETAILS_ATTACHED_STATUS,CFP_DETAILS_ATTACHED_DATE,CFP_DETAILS_CREATED_BY,CFP_DETAILS_CREATED_DATE, 
		]]>
        </sql>
	
        <sql id="cfpupdate1">
		<![CDATA[			
		
             CFP.CFP_MODEL_SID = tmp.CFP_MODEL_SID,
             CFP.COMPANY_MASTER_SID = tmp.COMPANY_MASTER_SID,
             CFP.COMPANY_START_DATE = tmp.CFP_DETAILS_START_DATE,
             CFP.COMPANY_END_DATE = tmp.CFP_DETAILS_END_DATE,
             CFP.COMPANY_CFP_ATTACHED_STATUS = tmp.CFP_DETAILS_ATTACHED_STATUS,
             CFP.COMPANY_CFP_ATTACHED_DATE = tmp.CFP_DETAILS_ATTACHED_DATE,
             CFP.TRADE_CLASS = HT.HELPER_TABLE_SID,
             CFP.TRADE_CLASS_START_DATE = tmp.CFP_DETAILS_TC_START_DATE,
             CFP.TRADE_CLASS_END_DATE = tmp.CFP_DETAILS_TC_END_DATE,
             CFP.CREATED_BY = tmp.CFP_DETAILS_CREATED_BY,
             CFP.CREATED_DATE = tmp.CFP_DETAILS_CREATED_DATE,
             CFP.MODIFIED_BY = tmp.CFP_DETAILS_MODIFIED_BY,
             CFP.INBOUND_STATUS = 'D',
             CFP.TRADING_PARTNER_CONTRACT_NO = tmp.TRADING_PARTNER_CONTRACT_NO
      FROM   IMTD_CFP_DETAILS tmp
             JOIN CFP_DETAILS cfp
               ON tmp.CFP_MODEL_SID = cfp.CFP_MODEL_SID
              AND tmp.COMPANY_MASTER_SID = cfp.COMPANY_MASTER_SID
              LEFT JOIN dbo.HELPER_TABLE HT ON tmp.CFP_DETAILS_TRADE_CLASS = HT.DESCRIPTION
              AND HT.LIST_NAME = 'COMPANY_TRADE_CLASS'
      WHERE  tmp.OPERATION <> 'F'
             AND tmp.CHECK_RECORD = 0
		]]>
	</sql>
        
        <sql id="cfpupdate2">
		<![CDATA[			
		
             CFP.CFP_MODEL_SID = tmp.CFP_MODEL_SID,
             CFP.COMPANY_MASTER_SID = tmp.COMPANY_MASTER_SID,
             CFP.COMPANY_START_DATE = tmp.CFP_DETAILS_START_DATE,
             CFP.COMPANY_END_DATE = tmp.CFP_DETAILS_END_DATE,
             CFP.COMPANY_CFP_ATTACHED_STATUS = tmp.CFP_DETAILS_ATTACHED_STATUS,
             CFP.COMPANY_CFP_ATTACHED_DATE = tmp.CFP_DETAILS_ATTACHED_DATE,
             CFP.TRADE_CLASS = HT.HELPER_TABLE_SID,
             CFP.TRADE_CLASS_START_DATE = tmp.CFP_DETAILS_TC_START_DATE,
             CFP.TRADE_CLASS_END_DATE = tmp.CFP_DETAILS_TC_END_DATE,
             CFP.CREATED_BY = tmp.CFP_DETAILS_CREATED_BY,
             CFP.CREATED_DATE = tmp.CFP_DETAILS_CREATED_DATE,
             CFP.MODIFIED_BY = tmp.CFP_DETAILS_MODIFIED_BY,
             CFP.INBOUND_STATUS = tmp.OPERATION,
             CFP.TRADING_PARTNER_CONTRACT_NO = tmp.TRADING_PARTNER_CONTRACT_NO
      FROM   IMTD_CFP_DETAILS tmp
             JOIN CFP_DETAILS cfp
             ON tmp.CFP_DETAILS_SID = cfp.CFP_DETAILS_SID
             LEFT JOIN dbo.HELPER_TABLE HT ON tmp.CFP_DETAILS_TRADE_CLASS = HT.DESCRIPTION
             AND HT.LIST_NAME = 'COMPANY_TRADE_CLASS'
      WHERE  tmp.OPERATION IN( 'U', 'D' )
             AND tmp.CHECK_RECORD = 1
		]]>
	</sql>
        
        <sql id="cfpupdate3">
		<![CDATA[			
		MERGE CFP_DETAILS AS T
      USING (SELECT B.HELPER_TABLE_SID
	,B.DESCRIPTION
	,B.LIST_NAME
	,A.*
    FROM IMTD_CFP_DETAILS A
    JOIN HELPER_TABLE B ON A.CFP_DETAILS_TRADE_CLASS = B.DESCRIPTION )  AS S
      ON ( S.CFP_MODEL_SID = T.CFP_MODEL_SID
           AND S.COMPANY_MASTER_SID = T.COMPANY_MASTER_SID )
      WHEN NOT MATCHED BY TARGET AND S.CFP_DETAILS_SID=0 AND S.OPERATION='A' AND S.CHECK_RECORD = 1 
      ]]>
	</sql>
 
         <sql id="cfpupdate4">
		<![CDATA[
        THEN
        INSERT( CFP_MODEL_SID,
                COMPANY_MASTER_SID,
                COMPANY_START_DATE,
                COMPANY_END_DATE,
                COMPANY_CFP_ATTACHED_STATUS,
                COMPANY_CFP_ATTACHED_DATE,
                TRADE_CLASS,
                TRADE_CLASS_START_DATE,
                TRADE_CLASS_END_DATE,
                CREATED_BY,
                CREATED_DATE,
                MODIFIED_BY,
                INBOUND_STATUS,
                TRADING_PARTNER_CONTRACT_NO,
                MODIFIED_DATE

      )
        VALUES(S.CFP_MODEL_SID,
               S.COMPANY_MASTER_SID,
               S.CFP_DETAILS_START_DATE,
               S.CFP_DETAILS_END_DATE,
               S.CFP_DETAILS_ATTACHED_STATUS,
               S.CFP_DETAILS_ATTACHED_DATE,
               S.HELPER_TABLE_SID,
               S.CFP_DETAILS_TC_START_DATE,
               S.CFP_DETAILS_TC_END_DATE,
               S.CFP_DETAILS_CREATED_BY,
               S.CFP_DETAILS_CREATED_DATE,
               S.CFP_DETAILS_MODIFIED_BY,
               S.OPERATION,
               S.TRADING_PARTNER_CONTRACT_NO,
      
     
      ]]>
	</sql>
 
        <sql id="cfpupdate5">
        <![CDATA[   
                   T.CFP_MODEL_SID = S.CFP_MODEL_SID,
                   T.COMPANY_MASTER_SID = S.COMPANY_MASTER_SID,
                   T.COMPANY_START_DATE = S.CFP_DETAILS_START_DATE,
                   T.COMPANY_END_DATE = S.CFP_DETAILS_END_DATE,
                   T.COMPANY_CFP_ATTACHED_STATUS = S.CFP_DETAILS_ATTACHED_STATUS,
                   T.COMPANY_CFP_ATTACHED_DATE = S.CFP_DETAILS_ATTACHED_DATE,
                   T.TRADE_CLASS = S.HELPER_TABLE_SID,
                   T.TRADE_CLASS_START_DATE = S.CFP_DETAILS_TC_START_DATE,
                   T.TRADE_CLASS_END_DATE = S.CFP_DETAILS_TC_END_DATE,
                   T.CREATED_BY = S.CFP_DETAILS_CREATED_BY,
                   T.CREATED_DATE = S.CFP_DETAILS_CREATED_DATE,
                   T.MODIFIED_BY = S.CFP_DETAILS_MODIFIED_BY,
                   T.INBOUND_STATUS = S.OPERATION,
                   T.TRADING_PARTNER_CONTRACT_NO = S.TRADING_PARTNER_CONTRACT_NO;
		]]>
	</sql>
        <sql id="cfpupdate6">
            <![CDATA[  
           UPDATE IMTD_CFP_DETAILS SET CFP_MODEL_SID=? WHERE USERS_SID='?' AND SESSION_ID='?' AND CAST(CREATED_DATE As DATE)='?' AND
CHECK_RECORD=1;
 
        MERGE CFP_DETAILS AS Target USING 
         (SELECT CFP_MODEL_SID, COMPANY_MASTER_SID, COMPANY_TYPE, 
         COMPANY_START_DATE,COMPANY_END_DATE,COMPANY_STATUS,
         TRADING_PARTNER_CONTRACT_NO,CFP_DETAILS_ATTACHED_DATE,CFP_DETAILS_START_DATE,
         CFP_DETAILS_END_DATE,CFP_DETAILS_ATTACHED_STATUS,CFP_DETAILS_TRADE_CLASS,
         CFP_DETAILS_TC_START_DATE,CFP_DETAILS_TC_END_DATE,OPERATION, 
         CHECK_RECORD,CREATED_BY, CREATED_DATE, MODIFIED_BY, MODIFIED_DATE 
         
         FROM dbo.IMTD_CFP_DETAILS
        WHERE USERS_SID='?' AND SESSION_ID='?' AND CAST(CREATED_DATE As DATE)='?' AND CHECK_RECORD=1) AS Source
        
        ON (Target.CFP_MODEL_SID = Source.CFP_MODEL_SID AND Target.COMPANY_MASTER_SID=Source.COMPANY_MASTER_SID  AND 
        	Target.INBOUND_STATUS = 'D')
        WHEN MATCHED THEN
        
        UPDATE SET 
      
      	        Target.COMPANY_START_DATE = Source.CFP_DETAILS_START_DATE,
                Target.COMPANY_END_DATE = Source.CFP_DETAILS_END_DATE,
  		Target.COMPANY_CFP_ATTACHED_STATUS=Source.CFP_DETAILS_ATTACHED_STATUS,
  		Target.COMPANY_CFP_ATTACHED_DATE=Source.CFP_DETAILS_ATTACHED_DATE,
  		Target.TRADE_CLASS=Source.CFP_DETAILS_TRADE_CLASS, 
  		Target.TRADING_PARTNER_CONTRACT_NO=source.TRADING_PARTNER_CONTRACT_NO,
  		Target.TRADE_CLASS_START_DATE=Source.CFP_DETAILS_TC_START_DATE, 
  		Target.TRADE_CLASS_END_DATE=Source.CFP_DETAILS_TC_END_DATE,
  		Target.INBOUND_STATUS='A',
  		Target.RECORD_LOCK_STATUS=0,
  		Target.CREATED_BY=Source.CREATED_BY,
  		Target.CREATED_DATE=Source.CREATED_DATE,
  		Target.MODIFIED_BY=Source.MODIFIED_BY,
  		Target.MODIFIED_DATE=Source.MODIFIED_DATE      
       
        WHEN NOT matched THEN
        
  		INSERT(CFP_MODEL_SID, COMPANY_MASTER_SID, COMPANY_START_DATE, COMPANY_END_DATE,
                COMPANY_CFP_ATTACHED_STATUS, COMPANY_CFP_ATTACHED_DATE, TRADE_CLASS,
                TRADING_PARTNER_CONTRACT_NO, TRADE_CLASS_START_DATE, TRADE_CLASS_END_DATE, INBOUND_STATUS,
                RECORD_LOCK_STATUS, CREATED_BY, CREATED_DATE, MODIFIED_BY, MODIFIED_DATE)
  		VALUES(Source.CFP_MODEL_SID, Source.COMPANY_MASTER_SID,Source.CFP_DETAILS_START_DATE,
      Source.CFP_DETAILS_END_DATE, Source.CFP_DETAILS_ATTACHED_STATUS, Source.CFP_DETAILS_ATTACHED_DATE,Source.CFP_DETAILS_TRADE_CLASS,
      source.TRADING_PARTNER_CONTRACT_NO,Source.CFP_DETAILS_TC_START_DATE,Source.CFP_DETAILS_TC_END_DATE,'A', 0, 
      Source.CREATED_BY,Source.CREATED_DATE,Source.MODIFIED_BY,Source.MODIFIED_DATE);

DELETE FROM IMTD_CFP_DETAILS WHERE USERS_SID='?' AND SESSION_ID='?';​
          ]]>
        </sql>
        
 <sql id="cfpsearch">
     <![CDATA[  
select DISTINCT cfp.CFP_ID, cfp.CFP_NO, cfp.CFP_NAME, cfp.CFP_TYPE, cfp.CFP_STATUS, cfp.CFP_START_DATE, cfp.CFP_END_DATE, cfp.CFP_TRADE_CLASS, cfp.CFP_CATEGORY,
cfp.CFP_DESIGNATION, parenCfp.CFP_NO as PARENT_NO,parenCfp.CFP_ID as PARENT_ID,htype.DESCRIPTION as ctype,hstatus.DESCRIPTION as cstatus,htrade.DESCRIPTION as trade,
hcategory.DESCRIPTION as category,cfp.CFP_MODEL_SID,cfp.MODIFIED_DATE,cfp.MODIFIED_BY,cfp.CREATED_DATE,cfp.CREATED_BY, cfp.RECORD_LOCK_STATUS from CFP_MODEL cfp 
LEFT JOIN CFP_MODEL parenCfp on parenCfp.CFP_MODEL_SID = cfp.PARENT_CFP_ID
LEFT JOIN HELPER_TABLE htrade on htrade.HELPER_TABLE_SID =  cfp.CFP_TRADE_CLASS 
LEFT JOIN HELPER_TABLE hcategory on hcategory.HELPER_TABLE_SID =  cfp.CFP_CATEGORY 
LEFT JOIN HELPER_TABLE htype on htype.HELPER_TABLE_SID =  cfp.CFP_TYPE 
LEFT JOIN HELPER_TABLE hstatus on hstatus.HELPER_TABLE_SID =  cfp.CFP_STATUS 
JOIN CFP_DETAILS cfd on cfp.CFP_MODEL_SID=cfd.CFP_MODEL_SID 
JOIN COMPANY_MASTER cm on cfd.COMPANY_MASTER_SID=cm.COMPANY_MASTER_SID  
      ]]>
            
 </sql>
  <sql id="cfpCount">
     <![CDATA[  
     
select count(DISTINCT cfp.CFP_ID)  from CFP_MODEL cfp 
LEFT JOIN CFP_MODEL parenCfp on parenCfp.CFP_MODEL_SID = cfp.PARENT_CFP_ID
JOIN CFP_DETAILS cfd on cfp.CFP_MODEL_SID=cfd.CFP_MODEL_SID 
JOIN COMPANY_MASTER cm on cfd.COMPANY_MASTER_SID=cm.COMPANY_MASTER_SID 
     
      ]]>
            
 </sql>
	
</custom-sql>